ESTRUCTURA DEL PROJECTE (./src)

â”œâ”€â”€ actions
â”‚   â”œâ”€â”€ admin
â”‚   â”‚   â”œâ”€â”€ audits.ts
â”‚   â”‚   â””â”€â”€ leads.ts
â”‚   â”œâ”€â”€ audit.ts
â”‚   â”œâ”€â”€ contact.ts
â”‚   â””â”€â”€ social-media.ts
â”œâ”€â”€ adapters
â”‚   â”œâ”€â”€ google
â”‚   â”‚   â”œâ”€â”€ PageSpeedAdapter.ts
â”‚   â”‚   â””â”€â”€ schemas.ts
â”‚   â”œâ”€â”€ GooglePageSpeedAdapter.ts
â”‚   â”œâ”€â”€ interfaces
â”‚   â”‚   â””â”€â”€ IMailer.ts
â”‚   â”œâ”€â”€ IWebScanner.ts
â”‚   â””â”€â”€ nodemailer
â”‚       â””â”€â”€ NodemailerAdapter.ts
â”œâ”€â”€ app
â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â”œâ”€â”€ delete-user.ts
â”‚   â”‚   â””â”€â”€ get-users.ts
â”‚   â”œâ”€â”€ api
â”‚   â”‚   â””â”€â”€ oauth
â”‚   â”‚       â”œâ”€â”€ callback
â”‚   â”‚       â”‚   â””â”€â”€ route.ts
â”‚   â”‚       â””â”€â”€ init
â”‚   â”‚           â””â”€â”€ route.ts
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â”œâ”€â”€ globals.css
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ manifest.ts
â”‚   â”œâ”€â”€ not-found.tsx
â”‚   â”œâ”€â”€ robots.ts
â”‚   â”œâ”€â”€ sitemap.ts
â”‚   â””â”€â”€ [locale]
â”‚       â”œâ”€â”€ (marketing)
â”‚       â”‚   â”œâ”€â”€ blog
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [slug]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ legal
â”‚       â”‚   â”‚   â”œâ”€â”€ avis-legal
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ cookies
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ privacitat
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ projectes
â”‚       â”‚       â””â”€â”€ page.tsx
â”‚       â”œâ”€â”€ admin
â”‚       â”‚   â”œâ”€â”€ analytics
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ blog
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [slug]
â”‚       â”‚   â”‚       â”œâ”€â”€ edit
â”‚       â”‚   â”‚       â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ debug
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ missatges
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ projects
â”‚       â”‚   â”‚   â”œâ”€â”€ new
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ settings
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ tests
â”‚       â”‚   â”‚   â”œâ”€â”€ new
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ users
â”‚       â”‚       â””â”€â”€ page.tsx
â”‚       â”œâ”€â”€ auth
â”‚       â”‚   â”œâ”€â”€ callback
â”‚       â”‚   â”‚   â””â”€â”€ route.ts
â”‚       â”‚   â”œâ”€â”€ forgot-password
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ login
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ register
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ reset-password
â”‚       â”‚       â””â”€â”€ page.tsx
â”‚       â”œâ”€â”€ dashboard
â”‚       â”‚   â”œâ”€â”€ audits
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ MobilBottomBar.tsx
â”‚       â”‚   â”œâ”€â”€ new-audit
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ projects
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚       â””â”€â”€ [testId]
â”‚       â”‚   â”‚           â””â”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ tests
â”‚       â”‚       â””â”€â”€ page.tsx
â”‚       â””â”€â”€ layout.tsx
â”œâ”€â”€ assets
â”‚   â””â”€â”€ images
â”‚       â”œâ”€â”€ cap-dataflow.jpg
â”‚       â”œâ”€â”€ digitai-logo.png
â”‚       â”œâ”€â”€ getsalutflowDarkCA.jpg
â”‚       â”œâ”€â”€ getsalutflowIntroDark.jpg
â”‚       â”œâ”€â”€ getsalutflowIntroLight.jpg
â”‚       â”œâ”€â”€ getsalutflowLightCA.jpg
â”‚       â”œâ”€â”€ hero.webp
â”‚       â”œâ”€â”€ jardinariapontsweb.jpg
â”‚       â”œâ”€â”€ og-image.jpg
â”‚       â”œâ”€â”€ pantalla-ribotflow.jpg
â”‚       â”œâ”€â”€ pantalla-salutflow.jpg
â”‚       â”œâ”€â”€ ribotflow.png
â”‚       â”œâ”€â”€ ribotflowPresentacio.jpg
â”‚       â”œâ”€â”€ salutflow.png
â”‚       â”œâ”€â”€ testimoni-garatgeestacio.jpg
â”‚       â”œâ”€â”€ triatu_ca.jpg
â”‚       â”œâ”€â”€ triatu_en.jpg
â”‚       â””â”€â”€ triatu_es.jpg
â”œâ”€â”€ components
â”‚   â”œâ”€â”€ admin
â”‚   â”‚   â”œâ”€â”€ AdminSidebar.tsx
â”‚   â”‚   â”œâ”€â”€ AminMobileMenu.tsx
â”‚   â”‚   â”œâ”€â”€ AuditsTable.tsx
â”‚   â”‚   â”œâ”€â”€ LeadsTable.tsx
â”‚   â”‚   â”œâ”€â”€ posts
â”‚   â”‚   â”‚   â”œâ”€â”€ PostEditorLayout.tsx
â”‚   â”‚   â”‚   â””â”€â”€ PostViewTabs.tsx
â”‚   â”‚   â”œâ”€â”€ socials
â”‚   â”‚   â”‚   â”œâ”€â”€ ConnectSocials.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ SocialManager.tsx
â”‚   â”‚   â”‚   â””â”€â”€ SocialPostCard.tsx
â”‚   â”‚   â””â”€â”€ UserDeleteButton.tsx
â”‚   â”œâ”€â”€ animations
â”‚   â”‚   â””â”€â”€ Reveal.tsx
â”‚   â”œâ”€â”€ charts
â”‚   â”‚   â””â”€â”€ ScoreRing.tsx
â”‚   â”œâ”€â”€ dashboard
â”‚   â”‚   â”œâ”€â”€ AuditCard.tsx
â”‚   â”‚   â”œâ”€â”€ DashboardHeader.tsx
â”‚   â”‚   â”œâ”€â”€ LogoutButton.tsx
â”‚   â”‚   â””â”€â”€ Sidebar.tsx
â”‚   â”œâ”€â”€ icons
â”‚   â”‚   â”œâ”€â”€ GoogleIcon.tsx
â”‚   â”‚   â””â”€â”€ TechIcons.tsx
â”‚   â”œâ”€â”€ landing
â”‚   â”‚   â”œâ”€â”€ AuditSection.tsx
â”‚   â”‚   â”œâ”€â”€ BenefitsSection.tsx
â”‚   â”‚   â”œâ”€â”€ contact
â”‚   â”‚   â”‚   â”œâ”€â”€ contact-form.tsx
â”‚   â”‚   â”‚   â””â”€â”€ contact-info.tsx
â”‚   â”‚   â”œâ”€â”€ ContactSection.tsx
â”‚   â”‚   â”œâ”€â”€ diary
â”‚   â”‚   â”‚   â”œâ”€â”€ DiaryCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ DiaryEmptyState.tsx
â”‚   â”‚   â”‚   â””â”€â”€ DiaryStack.tsx
â”‚   â”‚   â”œâ”€â”€ HeroSection.tsx
â”‚   â”‚   â”œâ”€â”€ LatestPostsSection.tsx
â”‚   â”‚   â”œâ”€â”€ ProblemSolutionsSection.tsx
â”‚   â”‚   â”œâ”€â”€ ProductTeaser.tsx
â”‚   â”‚   â”œâ”€â”€ services
â”‚   â”‚   â”‚   â”œâ”€â”€ mockups
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AppMockup.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AutomationFlow.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TerminalMockup.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ WebMockup.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ServiceCard.tsx
â”‚   â”‚   â”œâ”€â”€ ServicesGrid.tsx
â”‚   â”‚   â”œâ”€â”€ SocialSection.tsx
â”‚   â”‚   â”œâ”€â”€ solutions
â”‚   â”‚   â”‚   â”œâ”€â”€ data.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ MobileSolutionsDock.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ mockups
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MockupBooking.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MockupFinance.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MockupGrowth.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MockupIoT.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ SolutionsDisplay.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ SolutionsNavigation.tsx
â”‚   â”‚   â”‚   â””â”€â”€ SolutionsShowcase.tsx
â”‚   â”‚   â”œâ”€â”€ TechStackSection.tsx
â”‚   â”‚   â””â”€â”€ TestimonialsSection.tsx
â”‚   â”œâ”€â”€ layout
â”‚   â”‚   â”œâ”€â”€ Footer.tsx
â”‚   â”‚   â”œâ”€â”€ LanguageSwitcher.tsx
â”‚   â”‚   â”œâ”€â”€ LegalLayout.tsx
â”‚   â”‚   â”œâ”€â”€ Navbar.tsx
â”‚   â”‚   â”œâ”€â”€ PublicMobilNav.tsx
â”‚   â”‚   â”œâ”€â”€ ScrollManager.tsx
â”‚   â”‚   â””â”€â”€ UserNav.tsx
â”‚   â”œâ”€â”€ project-card-image.tsx
â”‚   â”œâ”€â”€ theme-provider.tsx
â”‚   â””â”€â”€ ui
â”‚       â”œâ”€â”€ alert-dialog.tsx
â”‚       â”œâ”€â”€ avatar.tsx
â”‚       â”œâ”€â”€ back-button.tsx
â”‚       â”œâ”€â”€ badge.tsx
â”‚       â”œâ”€â”€ button.tsx
â”‚       â”œâ”€â”€ card.tsx
â”‚       â”œâ”€â”€ checkbox.tsx
â”‚       â”œâ”€â”€ dropdown-menu.tsx
â”‚       â”œâ”€â”€ input.tsx
â”‚       â”œâ”€â”€ pagination-controls.tsx
â”‚       â”œâ”€â”€ progress.tsx
â”‚       â”œâ”€â”€ select.tsx
â”‚       â”œâ”€â”€ tabs.tsx
â”‚       â”œâ”€â”€ textarea.tsx
â”‚       â””â”€â”€ theme-toggle.tsx
â”œâ”€â”€ config
â”‚   â””â”€â”€ site-config.json
â”œâ”€â”€ features
â”‚   â”œâ”€â”€ analytics
â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ AnalyticsTracker.tsx
â”‚   â”‚       â”œâ”€â”€ BarListChart.tsx
â”‚   â”‚       â”œâ”€â”€ DeviceChart.tsx
â”‚   â”‚       â”œâ”€â”€ TopPagesCard.tsx
â”‚   â”‚       â”œâ”€â”€ TrafficChart.tsx
â”‚   â”‚       â”œâ”€â”€ UnifiedStatBar.tsx
â”‚   â”‚       â””â”€â”€ VerticalBarChart.tsx
â”‚   â”œâ”€â”€ audit
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ AuditForm.tsx
â”‚   â”‚       â”œâ”€â”€ components
â”‚   â”‚       â”‚   â”œâ”€â”€ AuditHeader.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ BusinessOpportunities.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ CoreVitalsGrid.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ CreateAuditForm.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadAuditButton.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ IssuesList.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ MobilePreviw.tsx
â”‚   â”‚       â”‚   â””â”€â”€ ScoreGrid.tsx
â”‚   â”‚       â””â”€â”€ pdf
â”‚   â”‚           â””â”€â”€ AuditPdfDocument.tsx
â”‚   â”œâ”€â”€ auth
â”‚   â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚   â”‚   â”‚   â””â”€â”€ reset-password.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ ForgotPasswordForm.tsx
â”‚   â”‚       â”œâ”€â”€ LoginForm.tsx
â”‚   â”‚       â”œâ”€â”€ RegisterForm.tsx
â”‚   â”‚       â””â”€â”€ ResetPasswordForm.tsx
â”‚   â”œâ”€â”€ blog
â”‚   â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â”‚   â””â”€â”€ admin-actions.ts
â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ AdminPostList.tsx
â”‚   â”‚       â”œâ”€â”€ EditPostForm.tsx
â”‚   â”‚       â”œâ”€â”€ MDXContent.tsx
â”‚   â”‚       â”œâ”€â”€ PostStatusToggle.tsx
â”‚   â”‚       â””â”€â”€ ReactionDock.tsx
â”‚   â”œâ”€â”€ email
â”‚   â”‚   â””â”€â”€ templates
â”‚   â”‚       â””â”€â”€ AuditReadyEmail.tsx
â”‚   â”œâ”€â”€ projects
â”‚   â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â”‚   â”œâ”€â”€ destroy-actions.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ invite-actions.ts
â”‚   â”‚   â”‚   â””â”€â”€ project-actions.ts
â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚   â”‚   â”œâ”€â”€ data
â”‚   â”‚   â”‚   â””â”€â”€ projects-data.ts
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ DeleteProjectButton.tsx
â”‚   â”‚       â”œâ”€â”€ form
â”‚   â”‚       â”‚   â”œâ”€â”€ AISection.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ ContactSection.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ DesignSection.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ FormSection.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ IdentitySection.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ NewProjectForm.tsx
â”‚   â”‚       â”‚   â””â”€â”€ SubmitButton.tsx
â”‚   â”‚       â”œâ”€â”€ InviteClientForm.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectCampaignsList.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectCard.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectList.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectsCTA.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectsHero.tsx
â”‚   â”‚       â””â”€â”€ ProjectTeamManeger.tsx
â”‚   â””â”€â”€ tests
â”‚       â”œâ”€â”€ actions
â”‚       â”‚   â”œâ”€â”€ admin-actions.ts
â”‚       â”‚   â””â”€â”€ task-actions.ts
â”‚       â”œâ”€â”€ actions.ts
â”‚       â””â”€â”€ ui
â”‚           â”œâ”€â”€ CampaignAnalytics.tsx
â”‚           â”œâ”€â”€ CampaignDetailsForm.tsx
â”‚           â”œâ”€â”€ CreateCampaignForm.tsx
â”‚           â”œâ”€â”€ DeleteCampaignButton.tsx
â”‚           â”œâ”€â”€ MissionCard.tsx
â”‚           â”œâ”€â”€ TaskManager.tsx
â”‚           â”œâ”€â”€ TaskRunner.tsx
â”‚           â”œâ”€â”€ TesterManager.tsx
â”‚           â””â”€â”€ VisualFlowBuilder.tsx
â”œâ”€â”€ hooks
â”‚   â””â”€â”€ use-scroll-to-anchor.ts
â”œâ”€â”€ i18n
â”‚   â””â”€â”€ request.ts
â”œâ”€â”€ lib
â”‚   â”œâ”€â”€ audit-dictionary.ts
â”‚   â”œâ”€â”€ auth
â”‚   â”‚   â”œâ”€â”€ admin-guard.ts
â”‚   â”‚   â””â”€â”€ errors.ts
â”‚   â”œâ”€â”€ data.ts
â”‚   â”œâ”€â”€ factory
â”‚   â”‚   â”œâ”€â”€ config-generator.ts
â”‚   â”‚   â””â”€â”€ config-mapper.ts
â”‚   â”œâ”€â”€ mock-audit.ts
â”‚   â”œâ”€â”€ schemas
â”‚   â”‚   â””â”€â”€ social-ai.ts
â”‚   â”œâ”€â”€ supabase
â”‚   â”‚   â”œâ”€â”€ client.ts
â”‚   â”‚   â”œâ”€â”€ middleware.ts
â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”œâ”€â”€ utils
â”‚   â”‚   â””â”€â”€ media.ts
â”‚   â”œâ”€â”€ utils.ts
â”‚   â””â”€â”€ validations
â”‚       â”œâ”€â”€ audit.ts
â”‚       â””â”€â”€ contact.ts
â”œâ”€â”€ proxy.ts
â”œâ”€â”€ repositories
â”‚   â”œâ”€â”€ interfaces
â”‚   â”‚   â”œâ”€â”€ IAnalyticsRepository.ts
â”‚   â”‚   â”œâ”€â”€ IAuditRepository.ts
â”‚   â”‚   â”œâ”€â”€ IContactRepository.ts
â”‚   â”‚   â””â”€â”€ IPostRepository.ts
â”‚   â””â”€â”€ supabase
â”‚       â”œâ”€â”€ SupabaseAnalyticsRepository.ts
â”‚       â”œâ”€â”€ SupabaseAuditRepository.ts
â”‚       â”œâ”€â”€ SupabaseContactRepository.ts
â”‚       â”œâ”€â”€ SupabasePostRepository.ts
â”‚       â”œâ”€â”€ SupabaseProfileRepository.ts
â”‚       â”œâ”€â”€ SupabaseProjectRepository.ts
â”‚       â””â”€â”€ SupabaseTestRepository.ts
â”œâ”€â”€ routing.ts
â”œâ”€â”€ services
â”‚   â”œâ”€â”€ ai
â”‚   â”‚   â”œâ”€â”€ AIService.ts
â”‚   â”‚   â”œâ”€â”€ interfaces
â”‚   â”‚   â”‚   â””â”€â”€ IAIProvider.ts
â”‚   â”‚   â”œâ”€â”€ prompts
â”‚   â”‚   â”‚   â””â”€â”€ WebsitePrompt.ts
â”‚   â”‚   â””â”€â”€ providers
â”‚   â”‚       â”œâ”€â”€ GeminiProvider.ts
â”‚   â”‚       â””â”€â”€ OpenAIProvider.ts
â”‚   â”œâ”€â”€ AuditService.ts
â”‚   â”œâ”€â”€ AuthService.ts
â”‚   â”œâ”€â”€ ContactService.ts
â”‚   â”œâ”€â”€ container.ts
â”‚   â”œâ”€â”€ email
â”‚   â”‚   â””â”€â”€ ResendEmailService.ts
â”‚   â”œâ”€â”€ factory
â”‚   â”‚   â”œâ”€â”€ DestructionService.ts
â”‚   â”‚   â””â”€â”€ InfrastrocutreService.ts
â”‚   â”œâ”€â”€ GamificationService.ts
â”‚   â”œâ”€â”€ ImageService.ts
â”‚   â”œâ”€â”€ PostService.ts
â”‚   â”œâ”€â”€ publishers
â”‚   â”‚   â”œâ”€â”€ facebook.ts
â”‚   â”‚   â”œâ”€â”€ instagram.ts
â”‚   â”‚   â””â”€â”€ linkedin.ts
â”‚   â”œâ”€â”€ social-generator.ts
â”‚   â”œâ”€â”€ social-publisher.ts
â”‚   â””â”€â”€ TenantService.ts
â””â”€â”€ types
    â”œâ”€â”€ actions.ts
    â”œâ”€â”€ ai-response.ts
    â”œâ”€â”€ ai.ts
    â”œâ”€â”€ config.ts
    â”œâ”€â”€ database.types.ts
    â”œâ”€â”€ i18n.ts
    â”œâ”€â”€ index.ts
    â”œâ”€â”€ joins.ts
    â”œâ”€â”€ models
    â”‚   â”œâ”€â”€ factory.ts
    â”‚   â”œâ”€â”€ index.ts
    â”‚   â””â”€â”€ template.ts
    â””â”€â”€ sectors.ts


CONTINGUT DELS FITXERS


// =================== FILE: src/actions/admin/audits.ts ===================

'use server';

import { createClient } from '@/lib/supabase/server';
// ğŸ‘‡ AQUESTA Ã‰S LA CLAU: Importem del container, no la classe directament
import { auditService } from '@/services/container'; 
import { redirect } from 'next/navigation';

export async function getAdminAudits() {
  const supabase = await createClient();

  const { data: { user }, error } = await supabase.auth.getUser();
  if (error || !user) redirect('/auth/login');

  try {
    // Ara 'auditService' ja tÃ© els 3 arguments injectats des del container
    const audits = await auditService.getDashboardAudits();
    return { success: true, data: audits };
  } catch (error) {
    console.error('Error fetching audits:', error);
    return { success: false, error: "Error carregant auditories" };
  }
}

// =================== FILE: src/actions/admin/leads.ts ===================

'use server';

import { createClient } from '@/lib/supabase/server';
import { ContactService } from '@/services/ContactService';
import { SupabaseContactRepository } from '@/repositories/supabase/SupabaseContactRepository'; // Assegura't del path
import { NodemailerAdapter } from '@/adapters/nodemailer/NodemailerAdapter';
import { redirect } from 'next/navigation';
import { revalidatePath } from 'next/cache'; // ğŸ‘ˆ IMPORTANT
// Definim el tipus de resposta especÃ­fica per al detall
type GetLeadDetailResponse =
  | { success: true; lead: Lead }
  | { success: false; error: string };
// --- DEFINICIÃ“ DE TIPUS (Clean Architecture) ---
type Lead = {
  id: string;
  created_at: string;
  full_name: string | null;
  email: string;
  service: string | null;
  message: string | null;
  source: string | null;
};

type Metadata = {
  total: number;
  page: number;
  pageSize: number;
  totalPages: number;
};

// Aquest Ã©s el tipus "discriminat". Si success Ã©s true, tenim dades. Si Ã©s false, tenim error.
export type GetLeadsResponse =
  | { success: true; leads: Lead[]; metadata: Metadata }
  | { success: false; error: string };

// --- IMPLEMENTACIÃ“ ---

const repository = new SupabaseContactRepository();
const mailer = new NodemailerAdapter();
const contactService = new ContactService(repository, mailer);

export async function getAdminLeads(page: number = 1): Promise<GetLeadsResponse> {
  const supabase = await createClient();

  // 1. SEGURETAT
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error || !user) redirect('/auth/login');

  // 2. RECUPERAR DADES
  try {
    const result = await contactService.getDashboardLeads(page);

    // Retornem l'objecte complet marcat com a Ã¨xit
    return {
      success: true,
      leads: result.leads,
      metadata: result.metadata
    };

  } catch (error) {
    console.error('ğŸ’¥ [ACTION] Error:', error);
    return { success: false, error: "Error carregant els missatges" };
  }
}

// ğŸ‘‡ NOVA ACCIÃ“
export async function getAdminLeadById(id: string): Promise<GetLeadDetailResponse> {
  const supabase = await createClient();

  // 1. Seguretat
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error || !user) redirect('/auth/login');

  // 2. Recuperar dades
  try {
    const lead = await contactService.getLeadDetails(id);

    if (!lead) {
      return { success: false, error: "No s'ha trobat el missatge." };
    }

    return { success: true, lead };
  } catch (error) {
    console.error('ğŸ’¥ [ACTION] Error:', error);
    return { success: false, error: "Error de servidor recuperant el missatge." };
  }
}

export async function deleteAdminLead(id: string) {
  const supabase = await createClient();

  // 1. Seguretat
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error || !user) redirect('/auth/login');

  try {
    // 2. Esborrar
    await contactService.deleteLead(id);
    console.log(`âœ… [ACTION] Eliminat a Supabase. Ara revalidant paths...`);
    // 3. Revalidar (Refrescar la UI del servidor)
    // AixÃ² fa que la llista s'actualitzi sola a '/admin/missatges'
    revalidatePath('/[locale]/admin/missatges', 'page');

    return { success: true };
  } catch (error) {
    console.error('ğŸ’¥ [ACTION] Error eliminant:', error);
    return { success: false, error: "No s'ha pogut eliminar el missatge." };
  }
}

// =================== FILE: src/actions/audit.ts ===================

'use server';

import { auditService } from '@/services/container'; 
import { auditSchema } from '@/lib/validations/audit'; 
import { redirect } from 'next/navigation';
import { getLocale } from 'next-intl/server';
import { createClient, createAdminClient } from '@/lib/supabase/server'; 

export type FormState = {
  success?: boolean;
  message?: string;
  errors?: {
    url?: string[];
    email?: string[];
  };
};

const MAIN_ORG_ID = process.env.NEXT_PUBLIC_MAIN_ORG_ID;

// ==========================================
// 1ï¸âƒ£ ACTION PÃšBLICA (Landing Page)
// ==========================================
export async function processWebAudit(
  prevState: FormState, 
  formData: FormData
): Promise<FormState> {
  const locale = await getLocale();

  const rawData = {
    url: formData.get('url'),
    email: formData.get('email'),
  };

  const validation = auditSchema.safeParse(rawData);

  if (!validation.success) {
    return {
      success: false,
      errors: validation.error.flatten().fieldErrors,
      message: "Revisa les dades del formulari.",
    };
  }

  const email = validation.data.email || '';
  const { url } = validation.data; 

  try {
    await auditService.performPublicAudit(url, email, locale);
    
    if (email) {
        const supabaseAdmin = createAdminClient();
        
        const { data: existingProfile } = await supabaseAdmin
          .from('profiles')
          .select('id')
          .ilike('email', email)
          .eq('organization_id', MAIN_ORG_ID!)
          .maybeSingle();

        const encodedEmail = encodeURIComponent(email);

        if (existingProfile) {
          redirect(`/${locale}/auth/login?email=${encodedEmail}&next=/dashboard`);
        } else {
          redirect(`/${locale}/auth/register?email=${encodedEmail}`);
        }
    }

  } catch (err) {
    if ((err as Error).message === 'NEXT_REDIRECT') {
        throw err;
    }
    console.error("Error processWebAudit:", err);
    return { success: false, message: "Error tÃ¨cnic durant l'anÃ lisi." };
  }
  
  return { success: true }; 
}

// ==========================================
// 2ï¸âƒ£ ACTION PRIVADA (Dashboard)
// ==========================================

export async function createAuditAction(url: string) {
  const locale = await getLocale();
  let auditId = null;

  // ğŸ‘‡ AQUÃ ESTAVA L'ERROR
  // Utilitzem shape.url per validar nomÃ©s l'string
  const validation = auditSchema.shape.url.safeParse(url);
  
  if (!validation.success) {
    // âœ… CORRECCIÃ“: En primitives, els errors estan a 'formErrors' desprÃ©s de fer flatten()
    // AixÃ² retorna un array de strings directament, aixÃ­ que agafem el primer [0].
    const errorMessage = validation.error.flatten().formErrors[0];
    
    return { 
        success: false, 
        message: errorMessage || 'URL invÃ lida.' 
    };
  }
  
  const cleanUrl = validation.data; // AquÃ­ ja tenim la URL neta (https://...)

  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user || !user.email) {
    return { success: false, message: 'SessiÃ³ caducada. Torna a iniciar sessiÃ³.' };
  }

  try {
    auditId = await auditService.performUserAudit(cleanUrl, user.id, user.email, locale);
  } catch (e) {
    console.error("Error createAuditAction:", e);
    return { success: false, message: 'Error al processar l\'auditoria. Intenta-ho mÃ©s tard.' };
  }

  if (auditId) {
    redirect(`/${locale}/dashboard/audits/${auditId}`);
  }
  
  return { success: false, message: 'No s\'ha pogut crear l\'auditoria.' };
}

// =================== FILE: src/actions/contact.ts ===================

'use server';

// Importem els tipus del fitxer que acabem d'arreglar
import { ContactFormSchema, type FormState } from '@/lib/validations/contact';

// Si tens els serveis configurats, els mantenim. 
// Si et donen error els imports de serveis, comenta'ls temporalment per provar.
import { ContactService } from '@/services/ContactService';
import { SupabaseContactRepository } from '@/repositories/supabase/SupabaseContactRepository';
import { NodemailerAdapter } from '@/adapters/nodemailer/NodemailerAdapter';

// Instanciem dependÃ¨ncies (Comenta-ho si no tens aquests fitxers encara)
const repository = new SupabaseContactRepository();
const mailer = new NodemailerAdapter();
const contactService = new ContactService(repository, mailer);

export async function submitContactForm(
  prevState: FormState,
  formData: FormData
): Promise<FormState> {
  
  // Convertim FormData a Objecte
  const rawData = {
    fullName: formData.get('fullName'),
    email: formData.get('email'),
    service: formData.get('service'),
    message: formData.get('message'),
    privacy: formData.get('privacy'),
  };

  // 1. ValidaciÃ³ Zod
  const validated = ContactFormSchema.safeParse(rawData);

  if (!validated.success) {
    return {
      success: false,
      message: "Revisa els camps marcats en vermell.",
      errors: validated.error.flatten().fieldErrors,
    };
  }

  try {
    // 2. LÃ²gica de negoci
    // Si 'contactService' espera 'name' en comptes de 'fullName', 
    // potser has de fer: { ...validated.data, name: validated.data.fullName }
    await contactService.processContactForm(validated.data);

    return {
      success: true,
      message: "Missatge enviat correctament! Et respondrem aviat.",
      errors: {} // Important passar objecte buit, no undefined, per evitar problemes al client
    };

  } catch (error) {
    console.error("Error en submitContactForm:", error);
    return {
      success: false,
      message: "Hi ha hagut un error tÃ¨cnic. Torna-ho a provar mÃ©s tard.",
      errors: {}
    };
  }
}

// =================== FILE: src/actions/social-media.ts ===================

'use server'

import { createClient } from '@/lib/supabase/server';
import { SocialGeneratorService } from '@/services/social-generator';
import { SocialPublisherService } from '@/services/social-publisher';
import { revalidatePath } from 'next/cache';
import { type Database } from '@/types/database.types'; // Assegura't que aquesta ruta Ã©s correcta

type SocialPostUpdate = Database['public']['Tables']['social_posts']['Update'];

/**
 * Genera (o regenera) els textos per a xarxes socials fent servir IA (Gemini).
 * Si ja existeixen esborranys, els actualitza. Si no, els crea.
 */
export async function generateSocialsForPost(postId: string) {
  const supabase = await createClient();

  try {
    // 1. VerificaciÃ³
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error("Usuari no autenticat");

    // 2. Recuperar el Post original
    const { data: post } = await supabase
      .from('posts')
      .select('title, content_mdx, slug')
      .eq('id', postId)
      .single();

    if (!post) throw new Error("No s'ha trobat el post original.");

    // 3. Generar contingut amb Gemini
    console.log(`ğŸ¤– Generant socials per al post: ${post.title}...`);
    const generated = await SocialGeneratorService.generateFromPost(post.title, post.content_mdx || post.title);

    // 4. Definim les plataformes a gestionar
    const platforms = [
        { name: 'linkedin', content: generated.linkedin.content },
        { name: 'facebook', content: generated.facebook.content },
        { name: 'instagram', content: generated.instagram.content }
    ] as const;

    // 5. Bucle "Upsert" (Actualitzar o Inserir)
    for (const p of platforms) {
        // Busquem si ja existeix un esborrany per aquest post i plataforma
        const { data: existingPost } = await supabase
            .from('social_posts')
            .select('id')
            .eq('post_id', postId)
            .eq('platform', p.name)
            .maybeSingle();

        if (existingPost) {
            // âœ… EXISTEIX -> ACTUALITZEM (Sobreescriure text vell)
            await supabase.from('social_posts')
                .update({ 
                    content: p.content,
                    status: 'draft', // Tornem a draft per si estava 'failed' o 'published'
                    updated_at: new Date().toISOString()
                })
                .eq('id', existingPost.id);
        } else {
            // âœ… NO EXISTEIX -> CREEM NOU
            await supabase.from('social_posts').insert({
                post_id: postId,
                platform: p.name,
                content: p.content,
                status: 'draft'
            });
        }
    }

    // 6. Refrescar la UI
    revalidatePath(`/admin/posts/${postId}`);
    revalidatePath('/admin/blog');
    
    return { success: true, message: "Esborranys generats correctament!" };

  } catch (error: unknown) {
    console.error("âŒ Error a generateSocialsForPost:", error);
    const message = error instanceof Error ? error.message : "Error desconegut";
    return { success: false, message };
  }
}

/**
 * Actualitza manualment el contingut o la imatge d'un post social des de la targeta.
 */
export async function updateSocialPostContent(
  socialId: string,
  newContent: string,
  mediaUrl?: string
) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthorized");

  const updateData: SocialPostUpdate = {
    content: newContent,
    status: 'approved', // Si l'usuari el toca, assumim que l'aprova
    updated_at: new Date().toISOString()
  };

  if (mediaUrl !== undefined) {
    updateData.media_url = mediaUrl === '' ? null : mediaUrl;
  }

  const { error } = await supabase
    .from('social_posts')
    .update(updateData)
    .eq('id', socialId);

  if (error) throw new Error("Error actualitzant el post");

  revalidatePath('/admin/blog');
  return { success: true };
}

/**
 * Canvia l'estat manualment (Draft <-> Approved <-> Published)
 */
export async function changeSocialStatus(socialId: string, newStatus: 'draft' | 'approved' | 'published' | 'failed') {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthorized");

  const { error } = await supabase
    .from('social_posts')
    .update({ status: newStatus })
    .eq('id', socialId);

  if (error) throw new Error("Error canviant l'estat");

  revalidatePath('/admin/blog');
  return { success: true };
}

/**
 * Publica el post a la xarxa social real.
 * Accepta 'mediaUrlOverride' per rebre la imatge directament des del client i evitar errors de latÃ¨ncia.
 */
export async function publishSocialPost(socialId: string, mediaUrlOverride?: string) {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthorized");

  // Recuperem el post social I el slug del post original
  const { data: socialPost, error } = await supabase
    .from('social_posts')
    .select(`*, posts ( slug )`)
    .eq('id', socialId)
    .single();

  if (error || !socialPost) throw new Error("No s'ha trobat el post social.");
  if (socialPost.status === 'published') throw new Error("Ja estÃ  publicat!");

  try {
    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';
    
  
    const postSlug = socialPost.posts?.slug;
    const publicUrl = postSlug ? `${baseUrl}/blog/${postSlug}` : baseUrl;

    // ğŸ”¥ DECISIÃ“ CRÃTICA: Prioritzem la URL que ens arriba "en mÃ " (override)
    // perquÃ¨ la DB potser encara no s'ha actualitzat.
    const finalMediaUrl = mediaUrlOverride || socialPost.media_url;

    console.log(`ğŸ“¢ PUBLICANT a ${socialPost.platform.toUpperCase()}`);
    console.log(`ğŸ”— Link: ${publicUrl}`);
    console.log(`ğŸ“¸ Media: ${finalMediaUrl ? finalMediaUrl : "CAP"}`);

    // Cridem al servei de publicaciÃ³
    const result = await SocialPublisherService.publish({
      platform: socialPost.platform,
      content: socialPost.content,
      mediaUrl: finalMediaUrl, // Passem la URL decidida
      link: publicUrl
    });

    // Actualitzar DB desprÃ©s de l'Ã¨xit
    await supabase.from('social_posts')
      .update({
        status: 'published',
        published_at: new Date().toISOString(),
        external_id: result.externalId,
        media_url: null // Netejem la referÃ¨ncia perquÃ¨ l'arxiu s'esborrarÃ 
      })
      .eq('id', socialId);

    // Neteja del Storage (Opcional perÃ² recomanat per estalviar espai)
    if (finalMediaUrl) {
      try {
        const urlParts = finalMediaUrl.split('/social-media/');
        if (urlParts.length > 1) {
          await supabase.storage.from('social-media').remove([urlParts[1]]);
        }
      } catch (e) { console.error("Error netejant storage:", e); }
    }

    revalidatePath('/admin/blog');
    return { success: true, message: "Publicat correctament!" };

  } catch (error: unknown) {
    const msg = error instanceof Error ? error.message : "Error publicant";
    
    // Si falla, guardem l'error a la DB
    await supabase
      .from('social_posts')
      .update({ error_message: msg, status: 'failed' })
      .eq('id', socialId);

    return { success: false, message: msg };
  }
}

// =================== FILE: src/adapters/google/PageSpeedAdapter.ts ===================

import { IWebScanner, ScanResult, AuditIssue } from '@/adapters/IWebScanner';

export class PageSpeedAdapter implements IWebScanner {
  private apiKey: string;
  private apiUrl = 'https://www.googleapis.com/pagespeedonline/v5/runPagespeed';

  constructor(apiKey: string) {
    this.apiKey = apiKey;
  }

  async scanUrl(url: string): Promise<ScanResult> {
    // Demanem categories: PERFORMANCE, SEO, BEST_PRACTICES, ACCESSIBILITY
    const endpoint = `${this.apiUrl}?url=${encodeURIComponent(url)}&key=${this.apiKey}&category=PERFORMANCE&category=SEO&category=ACCESSIBILITY&strategy=mobile`;

    const response = await fetch(endpoint);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Google API Error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    const lighthouse = data.lighthouseResult;

    // 1. Extraure Puntuacions
    const performanceScore = Math.round((lighthouse.categories.performance?.score || 0) * 100);
    const seoScore = Math.round((lighthouse.categories.seo?.score || 0) * 100);

    // 2. Extraure la Captura de Pantalla (Base64)
    // Google la torna a 'lighthouse.audits["final-screenshot"].details.data'
    const screenshot = lighthouse.audits['final-screenshot']?.details?.data;

    // 3. Extraure Problemes (Issues)
    // Busquem audits que tinguin un score baix (< 0.9) i que siguin rellevants
    const issues: AuditIssue[] = [];
    const auditsObj = lighthouse.audits;

    // Llista d'IDs d'auditoria que ens interessen (Google en tÃ© molts)
    const criticalAudits = [
        'first-contentful-paint',
        'largest-contentful-paint',
        'cumulative-layout-shift',
        'server-response-time',
        'render-blocking-resources',
        'uses-optimized-images',
        'meta-description',
        'document-title',
        'link-text'
    ];

    criticalAudits.forEach((key) => {
        const audit = auditsObj[key];
        // Si existeix i la puntuaciÃ³ no Ã©s perfecta (< 0.9) o Ã©s informativa
        if (audit && typeof audit.score === 'number' && audit.score < 0.9) {
            issues.push({
                id: key,
                title: audit.title,
                description: audit.description,
                score: audit.score,
                displayValue: audit.displayValue
            });
        }
    });

    return {
      seoScore,
      performanceScore,
      screenshot, // Ara tenim la foto!
      issues,     // Ara tenim la llista de problemes!
      reportData: data // Guardem l'original per si de cas
    };
  }
}

// =================== FILE: src/adapters/google/schemas.ts ===================

import { z } from 'zod';

// 1. Esquema per a una mÃ¨trica individual (Audit)
export const LighthouseAuditSchema = z.object({
  id: z.string(),
  title: z.string().optional(),
  description: z.string().optional(),
  score: z.number().nullable().optional(),
  displayValue: z.string().optional(),
  numericValue: z.number().optional(),
  // Utilitzem .catch() o .optional() per evitar trencaments si ve alguna cosa rara
  details: z.record(z.string(), z.unknown()).optional(), 
});

// 2. Esquema per a les Categories
const CategorySchema = z.object({
  score: z.number().nullable().optional(),
});

// 3. Esquema Principal de la Resposta de Google
export const PageSpeedResponseSchema = z.object({
  lighthouseResult: z.object({
    categories: z.object({
      performance: CategorySchema.optional(),
      seo: CategorySchema.optional(),
      accessibility: CategorySchema.optional(),
      'best-practices': CategorySchema.optional(),
    }),
    // âš ï¸ CORRECCIÃ“ CRÃTICA AQUÃ ğŸ‘‡
    // Definim explÃ­citament que la CLAU Ã©s un string
    audits: z.record(z.string(), LighthouseAuditSchema),
  }),
});

// Exportem el tipus inferit
export type PageSpeedResponse = z.infer<typeof PageSpeedResponseSchema>;

// =================== FILE: src/adapters/GooglePageSpeedAdapter.ts ===================

import { IWebScanner, ScanResult, AuditIssue } from './IWebScanner'; // Ajusta la ruta si cal
import { translateIssue } from '@/lib/audit-dictionary';
import { PageSpeedResponseSchema } from './google/schemas';

export class GooglePageSpeedAdapter implements IWebScanner {
    private apiKey?: string;
    private apiUrl = 'https://www.googleapis.com/pagespeedonline/v5/runPagespeed';

    constructor(apiKey?: string) {
        this.apiKey = apiKey;
    }

    async scanUrl(url: string, locale: string = 'ca'): Promise<ScanResult> {
        // 1. URLSearchParams: MÃ©s net que concatenar strings
        const params = new URLSearchParams({
            url,
            strategy: 'mobile',
            locale,
        });

        // Demanem nomÃ©s les categories necessÃ ries
        ['PERFORMANCE', 'SEO', 'ACCESSIBILITY', 'BEST_PRACTICES'].forEach(cat => {
            params.append('category', cat);
        });
        
        if (this.apiKey) {
            params.append('key', this.apiKey);
        }

        console.log(`ğŸš€ [AUDIT] Connectant a Google PageSpeed per: ${url}`);

        try {
            // 2. TIMEOUT CONTROLLER: Si Google triga > 60s, tallem per no penjar el servidor
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 segons mÃ xim

            const response = await fetch(`${this.apiUrl}?${params.toString()}`, {
                signal: controller.signal,
                next: { revalidate: 0 } // Important: No cachejar resultats d'auditoria, volem dades fresques
            });

            clearTimeout(timeoutId);

            // 3. GESTIÃ“ D'ERRORS DE GOOGLE
            if (!response.ok) {
                const errText = await response.text();
                console.error(`âŒ [AUDIT] Google Error (${response.status}):`, errText.slice(0, 200));
                
                // Si falla (502, 429, etc), activem el pla B (Mock)
                return this.getMockResult(url, locale, true);
            }

            const rawJson = await response.json();

            // 4. VALIDACIÃ“ ZOD (Seguretat de tipus)
            const validation = PageSpeedResponseSchema.safeParse(rawJson);

            if (!validation.success) {
                console.error("âŒ Dades invÃ lides de Google API:", validation.error);
                throw new Error("Estructura de dades incorrecta rebuda de Google.");
            }

            const data = validation.data;
            const lh = data.lighthouseResult;

            // 5. MAPATGE DE RESULTATS
            // Use '?? 0' per assegurar que mai sigui null
            const scores = {
                performance: Math.round((lh.categories.performance?.score ?? 0) * 100),
                seo: Math.round((lh.categories.seo?.score ?? 0) * 100),
            };

            const audits = lh.audits;

            // Helper per extreure mÃ¨triques
            const getMetric = (key: string, desc: string) => {
                const audit = audits[key];
                return {
                    value: audit?.displayValue,
                    score: audit?.score ?? 0,
                    description: desc
                };
            };

            const metrics = {
                fcp: getMetric('first-contentful-paint', "Temps fins al primer contingut visible."),
                lcp: getMetric('largest-contentful-paint', "Temps de cÃ rrega de l'element mÃ©s gran."),
                cls: getMetric('cumulative-layout-shift', "Estabilitat visual."),
                tbt: getMetric('total-blocking-time', "Temps de bloqueig del navegador."),
                si: getMetric('speed-index', "Ãndex de velocitat visual.")
            };

            // 6. PROCESSAMENT D'ISSUES (Optimitzat)
            const issues: AuditIssue[] = Object.values(audits)
                .filter(a => (a.score !== null && a.score !== undefined) && a.score < 0.9)
                .map(a => {
                    const cleanDescription = a.description?.split('[')[0].replace(/\.$/, '') || '';
                    
                    // Intentem traduir, si no, usem l'original
                    const translated = translateIssue(
                        a.id,
                        a.title || 'Unknown Issue',
                        a.description || '',
                        locale
                    );

                    return {
                        id: a.id,
                        title: translated.title || a.title || 'Unknown Issue',
                        description: translated.description || cleanDescription,
                        score: a.score || 0,
                        displayValue: a.displayValue
                    };
                })
                .sort((a, b) => a.score - b.score) // Els mÃ©s greus primer
                .slice(0, 8); // NomÃ©s els top 8 per no saturar la UI

            // 7. EXTRACCIÃ“ SEGURA DE SCREENSHOT
            const screenshotAudit = audits['final-screenshot'];
            let screenshotData: string | undefined;

            if (screenshotAudit?.details && typeof screenshotAudit.details === 'object') {
                const details = screenshotAudit.details as { data?: string };
                if (details.data) screenshotData = details.data;
            }

            return {
                seoScore: scores.seo,
                performanceScore: scores.performance,
                screenshot: screenshotData,
                issues,
                metrics,
                reportData: data
            };

        } catch (error) {
            console.error('âš ï¸ [AUDIT] Error fatal o Timeout:', error);
            // Si hi ha error de xarxa o timeout, retornem Mock
            return this.getMockResult(url, locale, true);
        }
    }

    /**
     * Genera un resultat "fake" realista quan l'API falla o va lenta.
     * AixÃ² permet que la UI mai es trenqui.
     */
    private getMockResult(url: string, locale: string, isError: boolean): ScanResult {
        console.warn(`âš ï¸ [AUDIT] Usant MOCK DATA per a: ${url}`);
        return {
            seoScore: 85,
            performanceScore: isError ? 45 : 72,
            screenshot: undefined, // O posa una imatge per defecte en base64
            issues: [
                {
                    id: 'mock-issue-1',
                    title: locale === 'es' ? 'Tiempo de respuesta del servidor' : 'Server response time',
                    description: 'El servidor ha trigat massa a respondre (SimulaciÃ³).',
                    score: 0.2,
                    displayValue: '2.4s'
                },
                {
                    id: 'mock-issue-2',
                    title: 'Render-blocking resources',
                    description: 'Elimina recursos que bloquegen el renderitzat.',
                    score: 0.4
                }
            ],
            metrics: {
                fcp: { score: 0.5, value: '1.2s', description: 'FCP Mock' },
                lcp: { score: 0.6, value: '2.5s', description: 'LCP Mock' },
                cls: { score: 0.9, value: '0.01', description: 'CLS Mock' },
                tbt: { score: 0.4, value: '300ms', description: 'TBT Mock' },
                si: { score: 0.7, value: '1.5s', description: 'SI Mock' }
            },
            reportData: {}
        };
    }
}

// =================== FILE: src/adapters/interfaces/IMailer.ts ===================

export interface MailOptions {
  to: string;
  subject: string;
  html: string;
}

export interface IMailer {
  sendMail(options: MailOptions): Promise<void>;
}

// =================== FILE: src/adapters/IWebScanner.ts ===================

import { AuditMetric } from '@/features/audit/ui/components/CoreVitalsGrid';

export type AuditIssue = {
  id: string;          // ğŸ‘ˆ AFEGIT: Necessari per traduir a la UI
  title: string;
  description: string;
  score: number;       
  displayValue?: string;
  impact?: string;     
  type?: 'error' | 'warning' | 'success';
};

export type ScanResult = {
  seoScore: number;
  performanceScore: number;
  screenshot?: string; 
  issues: AuditIssue[]; 
  reportData: unknown; 
  metrics?: {
    fcp?: AuditMetric;
    lcp?: AuditMetric;
    cls?: AuditMetric;
    tbt?: AuditMetric;
    si?: AuditMetric;
  };
};

export interface IWebScanner {
  scanUrl(url: string): Promise<ScanResult>;
}

// =================== FILE: src/adapters/nodemailer/NodemailerAdapter.ts ===================

import nodemailer from 'nodemailer';
import { IMailer, MailOptions } from '@/adapters/interfaces/IMailer';

export class NodemailerAdapter implements IMailer {
  private transporter;

  constructor() {
    this.transporter = nodemailer.createTransport({
      host: process.env.SMTP_HOST, // smtp.hostinger.com
      port: Number(process.env.SMTP_PORT), // 465
      secure: true, // true per port 465
      auth: {
        user: process.env.SMTP_USER,
        pass: process.env.SMTP_PASS,
      },
      // ğŸ‘‡ AFEGEIX AQUEST BLOC MÃ€GIC ğŸ‘‡
      tls: {
        rejectUnauthorized: false
      }
    });
  }

  async sendMail({ to, subject, html }: MailOptions): Promise<void> {
    try {
      console.log(`ğŸ“§ [MAILER] Intentant enviar correu a: ${to}`); // Log per debug
      
      const info = await this.transporter.sendMail({
        from: `"DigitAI Studios Web" <${process.env.SMTP_USER}>`,
        to,
        subject,
        html,
      });
      
      console.log(`âœ… [MAILER] Correu enviat! ID: ${info.messageId}`);
    } catch (error) {
      console.error('âŒ [MAILER] Error enviant email SMTP:', error);
      // Opcional: PodrÃ­em guardar l'error a DB si fos crÃ­tic
    }
  }
}

// =================== FILE: src/app/actions/delete-user.ts ===================

'use server';

import { createAdminClient, createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';
import { redirect } from 'next/navigation';

const MAIN_ORG_ID = process.env.NEXT_PUBLIC_MAIN_ORG_ID;

export async function deleteUserFromOrg(userId: string) {
  // 1. Seguretat: Verifiquem que qui crida Ã©s Admin
  const supabaseAuth = await createClient();
  const { data: { user }, error: authError } = await supabaseAuth.auth.getUser();

  if (authError || !user) redirect('/auth/login');

  const supabaseAdmin = createAdminClient();
  
  // Verifiquem si l'usuari actual Ã©s admin de l'organitzaciÃ³
  // (O si Ã©s el super-admin del .env)
  const isSuperAdmin = user.email === process.env.ADMIN_EMAIL;
  
  if (!isSuperAdmin) {
    const { data: currentUserProfile } = await supabaseAdmin
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .eq('organization_id', MAIN_ORG_ID!)
      .single();

    if (currentUserProfile?.role !== 'admin') {
      return { success: false, message: 'No tens permisos.' };
    }
  }

  if (!MAIN_ORG_ID) return { success: false, message: 'Falta configuraciÃ³ d\'organitzaciÃ³.' };

  // 2. EXECUTEM L'ELIMINACIÃ“
  // Eliminem NOMÃ‰S de la taula profiles i NOMÃ‰S d'aquesta organitzaciÃ³
  const { error } = await supabaseAdmin
    .from('profiles')
    .delete()
    .eq('id', userId)
    .eq('organization_id', MAIN_ORG_ID);

  if (error) {
    console.error('Error eliminant perfil:', error);
    return { success: false, message: 'Error a la base de dades.' };
  }

  // 3. Refresquem la UI
  revalidatePath('/admin/users');
  return { success: true, message: 'Usuari eliminat de l\'organitzaciÃ³ correctament.' };
}

// =================== FILE: src/app/actions/get-users.ts ===================

// FITXER: src/app/actions/get-users.ts

'use server'

// ğŸ‘‡ 1. Importem createAdminClient (el que tÃ© la clau de servei)
import { createClient, createAdminClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';

export type UserProfile = {
  id: string;
  email: string;
  role: 'admin' | 'client' | 'lead';
  created_at: string;
  full_name: string | null;
  organization_id: string;
};

const MAIN_ORG_ID = process.env.NEXT_PUBLIC_MAIN_ORG_ID;

export async function getAdminUsersList(): Promise<UserProfile[]> {
  // Client normal per verificar qui fa la peticiÃ³ (AUTH)
  const supabaseAuth = await createClient();
  
  // ğŸ‘‡ 2. Client ADMIN per fer les consultes a la DB (DADES)
  // Aquest client se salta les Policies RLS, evitant la recursiÃ³ infinita.
  const supabaseAdmin = createAdminClient();

  // A. Verificar sessiÃ³ actual
  const { data: { user }, error: authError } = await supabaseAuth.auth.getUser();
  if (authError || !user) redirect('/auth/login');

  if (!MAIN_ORG_ID) {
      console.error("âŒ ERROR CRÃTIC: Manca NEXT_PUBLIC_MAIN_ORG_ID al .env");
      return [];
  }

  // B. ğŸ›¡ï¸ SUPER ADMIN CHECK MANUAL
  // Fem servir el client Admin per llegir el perfil sense activar polÃ­tiques recursives
  const isSuperAdmin = user.email === process.env.ADMIN_EMAIL;

  if (!isSuperAdmin) {
    const { data: currentUserProfile } = await supabaseAdmin
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .eq('organization_id', MAIN_ORG_ID)
      .single();

    if (currentUserProfile?.role !== 'admin') {
      redirect('/'); 
    }
  }

  // C. Obtenir dades (Amb client Admin)
  const { data: profiles, error } = await supabaseAdmin
    .from('profiles')
    .select('*')
    .eq('organization_id', MAIN_ORG_ID)
    .order('created_at', { ascending: false });

  if (error) {
    console.error('Error fetching users:', error);
    return [];
  }

  return profiles as UserProfile[];
}

// =================== FILE: src/app/api/oauth/callback/route.ts ===================

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server'; // Ruta corregida

// Definim el tipus de dades que passarem a la funciÃ³ de guardar
interface ConnectionData {
    provider: 'linkedin' | 'facebook';
    accessToken: string;
    providerAccountId: string;
    providerPageId: string;
    providerPageName: string;
    providerAvatar?: string;
    expiresIn?: number;
}

export async function GET(request: NextRequest) {
    const { searchParams } = new URL(request.url);
    const code = searchParams.get('code');
    const state = searchParams.get('state');
    const error = searchParams.get('error');

    const supabase = await createClient();
    const origin = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';
    const redirectOnSuccess = `${origin}/admin/blog?connected=true`;

    // 1. GestiÃ³ d'errors inicials
    if (error || !code) {
        return NextResponse.redirect(`${origin}/admin/blog?error=auth_failed`);
    }

    try {
        // ------------------------------------------------------------------
        // A) GESTIÃ“ DE LINKEDIN
        // ------------------------------------------------------------------
        if (state?.includes('linkedin')) {

            const tokenRes = await fetch('https://www.linkedin.com/oauth/v2/accessToken', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: `${origin}/api/oauth/callback`,
                    client_id: process.env.LINKEDIN_CLIENT_ID!,
                    client_secret: process.env.LINKEDIN_CLIENT_SECRET!,
                }),
            });

            const tokenData = await tokenRes.json();
            if (!tokenRes.ok) throw new Error(tokenData.error_description || 'Error obtenint token LinkedIn');

            const accessToken = tokenData.access_token;

            // Obtenir dades de l'usuari
            const userRes = await fetch('https://api.linkedin.com/v2/userinfo', {
                headers: { Authorization: `Bearer ${accessToken}` },
            });

            if (!userRes.ok) throw new Error('Error obtenint perfil LinkedIn');
            const userData = await userRes.json();

            await saveConnection({
                provider: 'linkedin',
                accessToken,
                providerAccountId: userData.sub,
                providerPageId: userData.sub,
                providerPageName: userData.name || 'LinkedIn User',
                providerAvatar: userData.picture,
                expiresIn: tokenData.expires_in
            });
        }

        // ------------------------------------------------------------------
        // B) GESTIÃ“ DE FACEBOOK
        // ------------------------------------------------------------------
        else if (state?.includes('facebook')) {

            const tokenUrl = `https://graph.facebook.com/v19.0/oauth/access_token?client_id=${process.env.FACEBOOK_CLIENT_ID}&redirect_uri=${origin}/api/oauth/callback&client_secret=${process.env.FACEBOOK_CLIENT_SECRET}&code=${code}`;
            const tokenRes = await fetch(tokenUrl);
            const tokenData = await tokenRes.json();

            if (tokenData.error) throw new Error(tokenData.error.message);
            const userAccessToken = tokenData.access_token;

            // Obtenir les PÃ€GINES
            const pagesRes = await fetch(`https://graph.facebook.com/v19.0/me/accounts?access_token=${userAccessToken}`);
            const pagesData = await pagesRes.json();

            if (!pagesData.data || pagesData.data.length === 0) {
                return NextResponse.redirect(`${origin}/admin/blog?error=no_pages_found`);
            }

            // Guardem la primera pÃ gina trobada
            const page = pagesData.data[0];

            await saveConnection({
                provider: 'facebook',
                accessToken: page.access_token,
                providerAccountId: page.id,
                providerPageId: page.id,
                providerPageName: page.name,
                providerAvatar: `https://graph.facebook.com/${page.id}/picture`,
                expiresIn: tokenData.expires_in
            });
        }

        return NextResponse.redirect(redirectOnSuccess);

    } catch (err: unknown) { // âœ… Ãšs correcte: 'unknown' en lloc de 'any'
        console.error("OAuth Error:", err);
        const errorMessage = err instanceof Error ? err.message : 'Unknown Auth Error';
        return NextResponse.redirect(`${origin}/admin/blog?error=${encodeURIComponent(errorMessage)}`);
    }

    // Helper intern amb millor debugging
    async function saveConnection(data: ConnectionData) {
        const { data: { user } } = await supabase.auth.getUser();

        if (!user) {
            console.error("âŒ Error Auth: No hi ha usuari loguejat a la sessiÃ³.");
            throw new Error("No user found in session");
        }

        console.log("ğŸ” Buscant perfil per user_id:", user.id);

        // Intentem recuperar el perfil
        const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('organization_id')
            .eq('id', user.id)
            .maybeSingle(); // Usem maybeSingle per no llanÃ§ar excepciÃ³ si no n'hi ha

        // DIAGNÃ’STIC D'ERRORS
        if (profileError) {
            console.error("âŒ Error RLS o DB:", profileError);
            throw new Error(`Error DB accedint al perfil: ${profileError.message}`);
        }

        if (!profile) {
            console.error("âŒ Dades no trobades: L'usuari existeix a Auth perÃ² no a la taula Profiles.");
            throw new Error(`Perfil incomplet. Falta el registre a la taula 'profiles' per l'ID ${user.id}`);
        }

        console.log("âœ… Perfil trobat. Org ID:", profile.organization_id);

        // Fem l'UPSERT
        const { error } = await supabase.from('social_connections').upsert({
            organization_id: profile.organization_id,
            user_id: user.id,
            provider: data.provider,
            access_token: data.accessToken,
            provider_account_id: data.providerAccountId,
            provider_page_id: data.providerPageId,
            provider_page_name: data.providerPageName,
            provider_avatar_url: data.providerAvatar,
            expires_at: data.expiresIn ? Date.now() + (data.expiresIn * 1000) : null,
            updated_at: new Date().toISOString()
        }, {
            onConflict: 'organization_id, provider, provider_page_id'
        });

        if (error) {
            console.error("âŒ Error guardant connexiÃ³:", error);
            throw error;
        }
    }
}

// =================== FILE: src/app/api/oauth/init/route.ts ===================

import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const provider = searchParams.get('provider'); // 'linkedin' o 'facebook'
  
  // URL on tornarem desprÃ©s que l'usuari accepti
  const REDIRECT_URI = `${process.env.NEXT_PUBLIC_APP_URL}/api/oauth/callback`;

  // ---------------------------------------------------------
  // 1. LINKEDIN
  // ---------------------------------------------------------
  if (provider === 'linkedin') {
    const scope = encodeURIComponent('openid profile email w_member_social'); // Permisos necessaris
    const state = 'linkedin_state_proteccio'; // Idealment un string random per seguretat

    const url = `https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=${process.env.LINKEDIN_CLIENT_ID}&redirect_uri=${REDIRECT_URI}&state=${state}&scope=${scope}`;
    
    return NextResponse.redirect(url);
  }

  // ---------------------------------------------------------
  // 2. FACEBOOK (Meta)
  // ---------------------------------------------------------
  if (provider === 'facebook') {
    // Permisos: 'pages_manage_posts' i 'pages_read_engagement' sÃ³n claus per publicar com a pÃ gina
    const scope = encodeURIComponent('public_profile,email,pages_manage_posts,pages_read_engagement,pages_show_list');
    const state = 'facebook_state_proteccio';

    const url = `https://www.facebook.com/v19.0/dialog/oauth?client_id=${process.env.FACEBOOK_CLIENT_ID}&redirect_uri=${REDIRECT_URI}&state=${state}&scope=${scope}`;

    return NextResponse.redirect(url);
  }

  return NextResponse.json({ error: 'ProveÃ¯dor no suportat' }, { status: 400 });
}

// =================== FILE: src/app/globals.css ===================

@import "tailwindcss";
@plugin "tailwindcss-animate";

/* ğŸ‘‡ AQUESTA CONFIGURACIÃ“ ACTIVA EL MODE FOSC BASAT EN LA CLASSE .dark ğŸ‘‡ */
@custom-variant dark (&:is(.dark *));

/* =========================================
   1. VARIABLES DE COLOR (THEMING)
   ========================================= */
:root {
  /* --- MODE CLAR (LIGHT) --- */
  --background: 0 0% 100%;
  --foreground: 260 10% 3.9%; /* Text fosc sobre fons clar */
  
  --card: 0 0% 100%;
  --card-foreground: 260 10% 3.9%;
  
  --popover: 0 0% 100%;
  --popover-foreground: 260 10% 3.9%;
  
  --primary: 262 83% 58%; /* El lila principal */
  --primary-foreground: 0 0% 98%;
  
  --secondary: 260 4.8% 95.9%;
  --secondary-foreground: 260 5.9% 10%;
  
  --muted: 260 4.8% 95.9%;
  --muted-foreground: 260 3.8% 46.1%;
  
  --accent: 260 4.8% 95.9%;
  --accent-foreground: 260 5.9% 10%;
  
  --destructive: 0 84.2% 60.2%;
  --destructive-foreground: 0 0% 98%;
  
  --border: 260 5.9% 90%;
  --input: 260 5.9% 90%;
  --ring: 262 83% 58%;
  
  --radius: 0.75rem;
  --p: 222 47% 11%;
}

.dark {
  /* --- MODE FOSC (DARK) --- */
  /* AquÃ­ Ã©s on abans fallava: Ara assegurem fons fosc i text clar */
  --background: 260 8% 4%;      /* Fons gairebÃ© negre/lila */
  --foreground: 260 10% 98%;    /* Text blanc */

  --card: 260 14% 7%;
  --card-foreground: 260 10% 98%;

  --popover: 260 14% 4%;
  --popover-foreground: 260 10% 98%;

  --primary: 263 70% 50%;
  --primary-foreground: 0 0% 98%;

  --secondary: 260 15% 12%;
  --secondary-foreground: 0 0% 98%;

  --muted: 260 15% 12%;
  --muted-foreground: 260 10% 65%;

  --accent: 260 15% 12%;
  --accent-foreground: 0 0% 98%;

  --destructive: 0 62.8% 30.6%;
  --destructive-foreground: 0 0% 98%;

  --border: 260 15% 12%;
  --input: 260 15% 12%;
  --ring: 263 70% 50%;
  
  --p: 216 12% 84%;
}

/* =========================================
   2. CONFIGURACIÃ“ DEL TEMA (Tailwind v4)
   ========================================= */
@theme inline {
  --color-background: hsl(var(--background));
  --color-foreground: hsl(var(--foreground));
  --color-card: hsl(var(--card));
  --color-card-foreground: hsl(var(--card-foreground));
  --color-popover: hsl(var(--popover));
  --color-popover-foreground: hsl(var(--popover-foreground));
  --color-primary: hsl(var(--primary));
  --color-primary-foreground: hsl(var(--primary-foreground));
  --color-secondary: hsl(var(--secondary));
  --color-secondary-foreground: hsl(var(--secondary-foreground));
  --color-muted: hsl(var(--muted));
  --color-muted-foreground: hsl(var(--muted-foreground));
  --color-accent: hsl(var(--accent));
  --color-accent-foreground: hsl(var(--accent-foreground));
  --color-destructive: hsl(var(--destructive));
  --color-destructive-foreground: hsl(var(--destructive-foreground));
  --color-border: hsl(var(--border));
  --color-input: hsl(var(--input));
  --color-ring: hsl(var(--ring));

  --radius-xl: calc(var(--radius) + 4px);
  --radius-lg: var(--radius);
  --radius-md: calc(var(--radius) - 2px);
  --radius-sm: calc(var(--radius) - 4px);

  --animate-floating: floating 6s ease-in-out infinite;
  --animate-pulse-glow: pulse-glow 2s ease-in-out infinite alternate;

  @keyframes floating {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
  }

  @keyframes pulse-glow {
    from { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
    to { box-shadow: 0 0 40px rgba(168, 85, 247, 0.8); }
  }
}

/* =========================================
   3. BASE & COMPONENTS
   ========================================= */
@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground antialiased;
    font-feature-settings: "rlig" 1, "calt" 1;
  }
}

html {
  scroll-behavior: smooth;
  -webkit-tap-highlight-color: transparent;
}

img {
  transform: translateZ(0);
  backface-visibility: hidden;
}

@layer components {
  /* ICONES */
  .benefit-icon {
    @apply w-14 h-14 rounded-2xl flex items-center justify-center mb-6 transition-all duration-300;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(99, 102, 241, 0.15) 100%);
    border: 1px solid rgba(168, 85, 247, 0.2);
    box-shadow: 0 0 0 1px rgba(168, 85, 247, 0.05);
  }

  .landing-container {
    @apply container mx-auto px-6 md:px-12 lg:px-20;
  }

  .group:hover .benefit-icon {
    @apply scale-110 border-primary/50;
    box-shadow: 0 0 25px rgba(168, 85, 247, 0.3);
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.25) 0%, rgba(99, 102, 241, 0.25) 100%);
  }

  /* Targetes Futuristes */
  .solution-card-futuristic {
    @apply bg-white/[0.03] border border-white/[0.08] backdrop-blur-sm rounded-2xl p-8 transition-all duration-300;
  }
  .solution-card-futuristic:hover {
    @apply border-primary/40 bg-white/[0.06] -translate-y-1;
  }

  .input-dark {
    @apply bg-white/[0.03] border border-white/10 text-white placeholder:text-muted-foreground focus:border-primary focus:ring-1 focus:ring-primary rounded-lg;
  }

  .testimonial-card {
    @apply bg-white/[0.03] border border-white/10 backdrop-blur-md rounded-2xl p-8 transition-all duration-300;
  }
}

@layer utilities {
  .gradient-text {
    @apply bg-gradient-to-r from-[#a855f7] to-[#6366f1] bg-clip-text text-transparent;
  }
  .gradient-bg {
    @apply bg-gradient-to-r from-[#a855f7] to-[#6366f1];
  }
  .section-divider {
    @apply h-[1px] w-full bg-gradient-to-r from-transparent via-white/10 to-transparent my-12;
  }
}

// =================== FILE: src/app/layout.tsx ===================

// src/app/layout.tsx
import { ReactNode } from 'react';

type Props = {
  children: ReactNode;
};

// Aquest component nomÃ©s existeix perquÃ¨ Next.js no es queixi.
// El middleware s'encarrega d'enviar l'usuari a /[locale]/..., 
// per tant, l'usuari mai veurÃ  aquest HTML "buit".
export default function RootLayout({ children }: Props) {
  return children;
}

// =================== FILE: src/app/manifest.ts ===================

import { MetadataRoute } from 'next';

export default function manifest(): MetadataRoute.Manifest {
  return {
    name: 'DigitAI Studios',
    short_name: 'DigitAI',
    description: 'AgÃ¨ncia de desenvolupament web, apps i automatitzaciÃ³ IA.',
    start_url: '/',
    display: 'standalone',
    background_color: '#020817',
    theme_color: '#020817',
    orientation: 'portrait',
    icons: [
      {
        "src": "/web-app-manifest-192x192.png",
        "sizes": "192x192",
        "type": "image/png",
        "purpose": "any" // ğŸ‘ˆ CANVIAT: Abans era 'maskable'
      },
      {
        "src": "/maskable_icon.png",
        "sizes": "512x512",
        "type": "image/png",
        "purpose": "any" // ğŸ‘ˆ CANVIAT: Abans era 'maskable'
      },
      // Pots mantenir una entrada extra per a maskable SI tens una imatge amb marges
      {
         "src": "/maskable_icon.png",
         "sizes": "512x512",
         "type": "image/png",
         "purpose": "maskable" // NomÃ©s deixa aixÃ² si la imatge tÃ© molt marge al voltant
      }
    ],
  };
}

// =================== FILE: src/app/not-found.tsx ===================

'use client';
import Link from 'next/link';

// This handles 404s that happen outside of the [locale] structure
export default function GlobalNotFound() {
  return (
    <html lang="en">
      <body className="bg-white text-black dark:bg-black dark:text-white">
        <div className="flex min-h-screen flex-col items-center justify-center p-4 text-center font-sans">
          <h1 className="text-4xl font-bold mb-4">404</h1>
          <p className="mb-8">Page not found.</p>
          {/* Hard navigation to root to attempt recovery */}
          <Link href="/" className="underline hover:text-purple-500">
            Return Home
          </Link>
        </div>
      </body>
    </html>
  );
}

// =================== FILE: src/app/robots.ts ===================

import { MetadataRoute } from 'next';

export default function robots(): MetadataRoute.Robots {
  return {
    rules: {
      userAgent: '*',
      allow: '/',
      disallow: ['/admin/', '/dashboard/'], // ğŸ›¡ï¸ Protegim les zones privades
    },
    sitemap: 'https://digitaistudios.com/sitemap.xml', // URL final
  };
}

// =================== FILE: src/app/sitemap.ts ===================

import { MetadataRoute } from 'next';
import { postService } from '@/services/container';

// âš ï¸ IMPORTNAT: Canvia aixÃ² pel teu domini real quan despleguis
const BASE_URL = process.env.NEXT_PUBLIC_BASE_URL || 'https://digitaistudios.com';

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const posts = await postService.getLatestPosts();
  const locales = ['es', 'ca', 'en']; // Els teus idiomes

  // 1. PÃ gines estÃ tiques (Home, Blog) per a cada idioma
  const staticPages = locales.flatMap((locale) => [
    {
      url: `${BASE_URL}/${locale}`,
      lastModified: new Date(),
      changeFrequency: 'weekly' as const,
      priority: 1,
    },
    {
      url: `${BASE_URL}/${locale}/blog`,
      lastModified: new Date(),
      changeFrequency: 'daily' as const,
      priority: 0.8,
    },
  ]);

  // 2. Entrades del Blog per a cada idioma
  const postEntries = posts.flatMap((post) => 
    locales.map((locale) => ({
      url: `${BASE_URL}/${locale}/blog/${post.slug}`,
      lastModified: post.date ? new Date(post.date) : new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.7,
    }))
  );

  return [...staticPages, ...postEntries];
}

// =================== FILE: src/app/[locale]/(marketing)/blog/page.tsx ===================

import { Link } from '@/routing';
import { postService } from '@/services/container';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { getTranslations, getLocale } from 'next-intl/server';
import { Calendar, Tag, ImageIcon, Cpu } from 'lucide-react';
import Image from 'next/image';
// ğŸ‘‡ 1. IMPORT IMPORTANT
import { PaginationControls } from '@/components/ui/pagination-controls';

export const revalidate = 3600;

// ğŸ‘‡ 2. DEFINICIÃ“ DE PROPS (Next.js 16)
interface PageProps {
  searchParams: Promise<{ page?: string }>;
}

export default async function BlogIndexPage({ searchParams }: PageProps) {
  const t = await getTranslations('BlogIndex');
  const locale = await getLocale();

  // ğŸ‘‡ 3. GESTIÃ“ DE PÃ€GINA
  const resolvedParams = await searchParams;
  const currentPage = Number(resolvedParams.page) || 1;

  // ğŸ‘‡ 4. CRIDA AL SERVEI PAGINAT
  const { posts, metadata } = await postService.getPublicBlogPosts(currentPage);

  return (
    <div className="container mx-auto py-18 px-6 md:px-10 lg:px-14">
      {/* CAPÃ‡ALERA (Igual) */}
      <div className="text-center mb-16 space-y-4">
        <h1 className="text-4xl md:text-5xl font-extrabold tracking-tight text-foreground">
          {t('title')}
        </h1>
        <p className="text-muted-foreground text-lg md:text-xl max-w-2xl mx-auto leading-relaxed">
          {t('subtitle')}
        </p>
      </div>

      {/* GRID DE POSTS */}
      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {posts.map((post) => (
          <Link key={post.slug} href={`/blog/${post.slug}`} className="block group h-full">
         
             <Card className="h-full flex flex-col overflow-hidden border border-border bg-card dark:bg-[#0f111a] hover:border-primary/50 transition-all duration-300 shadow-sm hover:shadow-2xl hover:-translate-y-1">
               
                <div className="relative h-56 w-full bg-muted dark:bg-slate-800 overflow-hidden">
                    {(post.totalReactions || 0) > 0 && (
                      <div className="absolute top-3 right-3 z-20 flex items-center gap-1.5 bg-slate-900/80 backdrop-blur-md px-3 py-1 rounded-full text-cyan-400 text-xs font-bold font-mono border border-cyan-500/30">
                        <Cpu className="w-3.5 h-3.5" />
                        <span className="h-3 w-px bg-cyan-500/30 mx-0.5"></span>
                        {post.totalReactions}
                      </div>
                    )}
                    {post.coverImage ? (
                      <Image src={post.coverImage} alt={post.title} fill className="object-cover transition-transform duration-700 group-hover:scale-105" sizes="(max-width: 768px) 100vw, 33vw" />
                    ) : (
                      <div className="flex flex-col items-center justify-center h-full text-muted-foreground/50"><ImageIcon className="w-10 h-10 mb-2 opacity-50" /><span className="text-xs tracking-widest">{t('fallback_image')}</span></div>
                    )}
                </div>
                <CardHeader className="pb-2 pt-6">
                    <div className="flex justify-between items-center mb-3">
                        <div className="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full bg-primary/10 text-primary text-[10px] font-bold uppercase tracking-wider"><Tag className="w-3 h-3" />{post.tags[0] ?? 'TECH'}</div>
                        {post.date && <div className="flex items-center gap-1.5 text-xs text-muted-foreground font-medium"><Calendar className="w-3 h-3" />{new Intl.DateTimeFormat(locale, { dateStyle: 'medium' }).format(new Date(post.date))}</div>}
                    </div>
                    <CardTitle className="text-xl font-bold text-foreground group-hover:text-primary transition-colors line-clamp-2 leading-tight">{post.title}</CardTitle>
                </CardHeader>
                <CardContent className="flex-1 flex flex-col justify-between">
                    <p className="text-muted-foreground text-sm leading-relaxed line-clamp-3 mb-6">{post.description}</p>
                    <div className="text-sm font-bold text-primary flex items-center gap-2 opacity-80 group-hover:opacity-100 transition-all group-hover:gap-3">Llegir article <span className="text-lg leading-none">&rarr;</span></div>
                </CardContent>
             </Card>
          </Link>
        ))}

        {/* Empty State */}
        {posts.length === 0 && (
          <div className="col-span-full py-24 text-center bg-muted/20 rounded-3xl border border-dashed border-border flex flex-col items-center justify-center">
            <div className="w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4">
              <Tag className="w-8 h-8 text-muted-foreground" />
            </div>
            <h3 className="text-lg font-bold text-foreground mb-1">{t('no_posts')}</h3>
            <p className="text-muted-foreground text-sm">No s'han trobat publicacions disponibles.</p>
          </div>
        )}
      </div>

      {/* ğŸ‘‡ 5. CONTROLS DE PAGINACIÃ“ (Nou) */}
      {metadata && metadata.totalPages > 1 && (
        <div className="mt-16 max-w-md mx-auto">
          <PaginationControls metadata={metadata} />
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/blog/[slug]/page.tsx ===================

import { notFound } from 'next/navigation';
import { postService } from '@/services/container';
import { MDXContent } from '@/features/blog/ui/MDXContent';
import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Calendar, User } from 'lucide-react';
import { Metadata } from 'next';
import { getTranslations } from 'next-intl/server'; // ğŸ‘ˆ
import { ReactionDock } from '@/features/blog/ui/ReactionDock';
import { postRepository } from '@/services/container'; // Importem el repo directament per carregar dades inicials
import { cn } from '@/lib/utils';

type Props = {
  params: Promise<{ slug: string; locale: string }>;
};

export const revalidate = 3600;

// Afegeix aquesta constant a dalt de tot o importa-la des del teu config
const SITE_URL = 'https://digitaistudios.com';

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { slug, locale } = await params;
  const post = await postService.getPost(slug);

  if (!post) {
    return { title: '404 - Article no trobat' };
  }

  // ğŸ‘‡ AQUESTA Ã‰S LA MÃ€GIA QUE ET FALTA
  // ConstruÃ¯m les URLs per als diferents idiomes
  const urlEs = `${SITE_URL}/es/blog/${slug}`;
  const urlEn = `${SITE_URL}/en/blog/${slug}`;
  // Si el catalÃ  Ã©s l'idioma per defecte (sense prefix), seria aixÃ­:
  // const urlCa = `${SITE_URL}/blog/${slug}`; 
  // O si tambÃ© tÃ© prefix:
  const urlCa = `${SITE_URL}/ca/blog/${slug}`; // Ajusta aixÃ² segons la teva configuraciÃ³ de next-intl

  return {
    title: post.title,
    description: post.description,

    // 1. CANONICAL I HREFLANG (SOLUCIÃ“ AL PROBLEMA DE GSC)
    alternates: {
      // Canonical: "Jo soc la versiÃ³ original d'aquest idioma"
      canonical: `${SITE_URL}/${locale}/blog/${slug}`,

      // Languages: "AquÃ­ tens les meves germanes en altres idiomes"
      languages: {
        'es': urlEs,
        'en': urlEn,
        'ca': urlCa, // Assegura't que coincideix amb com tens les rutes
      },
    },

    openGraph: {
      title: post.title,
      description: post.description || '',
      type: 'article',
      url: `${SITE_URL}/${locale}/blog/${slug}`, // Important afegir la URL tambÃ© aquÃ­
      publishedTime: post.date || undefined,
      tags: post.tags,
      images: post.coverImage ? [{ url: post.coverImage }] : undefined,
      locale: locale, // Important per a xarxes socials
    },
    twitter: {
      card: 'summary_large_image',
      title: post.title,
      description: post.description || '',
      images: post.coverImage ? [post.coverImage] : [],
    },
  };
}

export default async function BlogPostPage({ params }: Props) {
  const { slug, locale } = await params;
  const post = await postService.getPost(slug);

  // Hooks de traducciÃ³
  const t = await getTranslations('BlogPost');


  if (!post) notFound();
  // 1. Carreguem les reaccions inicials des del servidor (Server Side Rendering)
  // AixÃ² fa que els nÃºmeros siguin correctes abans que el JS del client carregui
  const reactions = await postRepository.getPostReactions(slug);


  // ğŸ‘‡ CREEM L'OBJECTE JSON-LD
  const jsonLd = {
    '@context': 'https://schema.org',
    '@type': 'BlogPosting',
    mainEntityOfPage: {  // AFEGEIX AIXÃ’
      "@type": "WebPage",
      "@id": `https://digitaistudios.com/${locale}/blog/${slug}`
    },
    headline: post.title,
    description: post.description,
    image: post.coverImage ? [post.coverImage] : [],
    datePublished: post.date,
    dateModified: post.date, // O updated_at si en tens
    author: {
      '@type': 'Organization', // O 'Person' si tens autor
      name: 'DigitAI Studios',
      url: 'https://digitaistudios.com'
    },
    publisher: {
      '@type': 'Organization',
      name: 'DigitAI Studios',
      logo: {
        '@type': 'ImageObject',
        url: 'https://digitaistudios.com/branding/logo.png'
      }
    },
    inLanguage: locale
  };
  return (
    <div className="min-h-screen bg-background pb-20">
      {/* ğŸ‘‡ INJECTEM L'SCRIPT AQUÃ, DINS DEL DIV PRINCIPAL */}
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
      />
      {/* 1. HERO SECTION */}
      <div className="relative w-full flex items-end justify-center overflow-hidden min-h-[60vh] lg:min-h-[70vh] bg-slate-950">

        {/* Fons */}
        <div className="absolute inset-0 bg-slate-900">
          {post.coverImage ? (
            <div
              className="absolute inset-0 bg-cover bg-center opacity-50"
              style={{ backgroundImage: `url(${post.coverImage})` }}
            />
          ) : (
            <div className="absolute inset-0 bg-linear-to-br from-blue-900 via-indigo-900 to-slate-900 opacity-80" />
          )}
          <div className="absolute inset-0 bg-linear-to-t from-background via-background/60 to-transparent" />
        </div>

        {/* Contingut Hero */}
        <div className="relative z-10 container px-4 text-center max-w-4xl mx-auto pb-24 pt-32">

          <h1 className="text-3xl md:text-5xl lg:text-7xl font-extrabold tracking-tight text-foreground mb-6 leading-tight drop-shadow-xl animate-in fade-in slide-in-from-bottom-6 duration-1000">
            {post.title}
          </h1>

          <div className="flex flex-wrap justify-center items-center gap-4 md:gap-8 text-muted-foreground font-medium text-sm md:text-base animate-in fade-in slide-in-from-bottom-8 duration-1000 delay-100">
            {/* Tags */}
            {/* Tags */}
            <div className="flex flex-wrap justify-center gap-2 mb-6 w-full animate-in fade-in slide-in-from-bottom-4 duration-700">
              {post.tags.map(tag => (
                <span key={tag} className={cn(
                  "px-3 py-1 rounded-full text-[10px] md:text-xs font-bold uppercase tracking-wider",

                  // ğŸ”¥ FIX IPHONE VELL:
                  // 1. Eliminem 'backdrop-blur-md' (el culpable de la pantalla negra/blanca).
                  // 2. Eliminem 'bg-foreground/10' (transparÃ¨ncia).
                  // 3. Posem colors SÃ’LIDS que contrasten bÃ©:

                  // Light Mode: Fons gris molt claret, text fosc, vora subtil
                  "bg-slate-100 text-slate-700 border border-slate-200",

                  // Dark Mode: Fons gris fosc (perÃ² no negre pur), text clar, vora fosca
                  "dark:bg-zinc-800 dark:text-slate-300 dark:border-zinc-700"
                )}>
                  {tag}
                </span>
              ))}
            </div>

            <div className="flex items-center gap-2">
              <div className="w-8 h-8 rounded-full bg-muted flex items-center justify-center border border-border">
                <User className="w-4 h-4" />
              </div>
              <span>{t('by_author')}</span>
            </div>

            <div className="flex items-center gap-2">
              <Calendar className="w-4 h-4 opacity-70" />
              <span>
                {post.date
                  ? new Intl.DateTimeFormat(locale, { dateStyle: 'long' }).format(new Date(post.date))
                  : 'Avui'
                }
              </span>
            </div>
          </div>
        </div>
      </div>

      {/* 2. CONTINGUT */}
      <div className="container px-4 -mt-12 relative z-20 max-w-4xl mx-auto">
        <div className="bg-card text-card-foreground rounded-3xl p-6 md:p-12 lg:p-16 shadow-2xl ring-1 ring-border/50">

          <p className="text-xl md:text-2xl lg:text-3xl font-serif text-muted-foreground leading-relaxed mb-8 md:mb-12 border-b border-border pb-8">
            {post.description}
          </p>

          <div className="prose prose-lg dark:prose-invert max-w-none prose-headings:font-bold prose-headings:tracking-tight prose-a:text-primary prose-img:rounded-xl prose-img:shadow-lg">
            <MDXContent source={post.content || ''} />
          </div>
          <ReactionDock slug={slug} initialCounts={reactions} />
          {/* Footer Card */}
          <div className="mt-16 p-6 md:p-10 rounded-2xl bg-muted/30 border border-border text-center">
            <h3 className="text-xl md:text-2xl font-bold mb-4">{t('share_title')}</h3>
            <p className="text-muted-foreground mb-6 max-w-md mx-auto text-sm md:text-base">
              {t('share_subtitle')}
            </p>

            <div className="flex flex-col sm:flex-row justify-center gap-4">
              <Link href="/blog">
                <Button variant="outline" className="w-full sm:w-auto">
                  <ArrowLeft className="mr-2 h-4 w-4" /> {t('back_button')}
                </Button>
              </Link>
              <Link href="/">
                <Button className="w-full sm:w-auto gradient-bg text-white border-0 shadow-lg hover:opacity-90">
                  {t('cta_audit')}
                </Button>
              </Link>
            </div>
          </div>

        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/layout.tsx ===================

import { Navbar } from '@/components/layout/Navbar';
import { Footer } from '@/components/layout/Footer';
import { createClient } from '@/lib/supabase/server';
import { ScrollManager } from '@/components/layout/ScrollManager'; // ğŸ‘ˆ Importem el component, NO el hook

export default async function MarketingLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // 1. Obtenim la sessiÃ³ al servidor (correcte)
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  return (
    <div className="flex min-h-screen flex-col bg-background selection:bg-primary/30">
      {/* 2. Inserim el gestor d'scroll aquÃ­ */}
      <ScrollManager />

      <Navbar user={user} />

      <main className="flex-1">
        {children}
      </main>

      <Footer />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/legal/avis-legal/page.tsx ===================

import LegalLayout from '@/components/layout/LegalLayout';
import { Building2, Mail, MapPin, Fingerprint, AlertTriangle, Gavel } from 'lucide-react';
import { getTranslations } from 'next-intl/server';
import { getLocale } from 'next-intl/server'; // Per la data

export const metadata = {
  title: 'AvÃ­s Legal | DigitAI Studios',
  description: 'InformaciÃ³ legal i condicions d\'Ãºs de DigitAI Studios.',
};

export default async function AvisLegalPage() {
  const t = await getTranslations('Legal.avis_legal');
  const tCommon = await getTranslations('Legal.common');
  const locale = await getLocale();

  return (
    <LegalLayout>
      <div className="border-b border-border pb-8 mb-8">
        <h1 className="text-3xl md:text-4xl font-extrabold mb-4">{t('title')}</h1>
        <p className="text-xl text-muted-foreground leading-relaxed">
          {tCommon('transparency_desc')}
        </p>
        <p className="text-sm text-muted-foreground mt-4">{t('last_update_prefix')} {new Date().toLocaleDateString(locale)}</p>
      </div>

      {/* SECCIÃ“ 1: DADES IDENTIFICATIVES (GRID VISUAL) */}
      <section className="mb-12">
        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
            {t('section1_title')}
        </h2>
        <p className="mb-6">
           {t('section1_desc')}
        </p>
        
        <div className="grid sm:grid-cols-2 gap-4 not-prose">
           <InfoCard 
              icon={Building2} 
              label={t('data_card_company_label')} 
              value="DigitAI Studios" 
           />
           <InfoCard 
              icon={Fingerprint} 
              label={t('data_card_nif_label')} 
              value="444555666Y" 
           />
           <InfoCard 
              icon={MapPin} 
              label={t('data_card_address_label')} 
              value={"El Morro 54"} 
           />
           <InfoCard 
              icon={Mail} 
              label={t('data_card_contact_label')} 
              value="info@digitaistudios.com" 
           />
        </div>
      </section>

      {/* SECCIÃ“ 2: OBJECTE */}
      <section className="mb-12">
        <h2>{t('section2_title')}</h2>
        <p>
          {t.rich('section2_p1', {
            strong: (chunks) => <strong>{chunks}</strong>
          })}
        </p>
        <p>
          {t('section2_p2')}
        </p>
      </section>

      {/* SECCIÃ“ 3: PROPIETAT INTELÂ·LECTUAL */}
      <section className="mb-12">
        <h2>{t('section3_title')}</h2>
        <div className="bg-muted/30 p-6 rounded-xl border-l-4 border-primary not-prose">
            <p className="text-sm text-muted-foreground">
                {t.rich('section3_quote', {
                  strong: (chunks) => <strong>{chunks}</strong>
                })}
            </p>
        </div>
      </section>

      {/* SECCIÃ“ 4: RESPONSABILITAT */}
      <section className="mb-12">
         <h2 className="flex items-center gap-2">
            <AlertTriangle className="w-6 h-6 text-yellow-500" /> {t('section4_title')}
         </h2>
         <p>{t('section4_p1')}</p>
         <ul>
            <li>{t('section4_list_1')}</li>
            <li>{t('section4_list_2')}</li>
            <li>{t('section4_list_3')}</li>
         </ul>
      </section>

      {/* SECCIÃ“ 5: LLEI */}
      <section>
         <h2 className="flex items-center gap-2">
            <Gavel className="w-6 h-6 text-primary" /> {t('section5_title')}
         </h2>
         <p>
            {t('section5_p1')}
         </p>
      </section>

    </LegalLayout>
  );
}

// Nota: El component InfoCard es mantÃ© igual, ja que les dades que rep (label, value) ja venen traduÃ¯des d'aquÃ­.

// Component petit per a les targetes de dades
import { LucideIcon } from 'lucide-react';

interface InfoCardProps {
    icon: LucideIcon;
    label: string;
    value: string;
}

function InfoCard({ icon: Icon, label, value }: InfoCardProps) {
    return (
        <div className="bg-background border border-border p-4 rounded-lg flex items-start gap-4 shadow-sm hover:border-primary/30 transition-colors">
            <div className="p-2 bg-primary/10 rounded-md shrink-0">
                <Icon className="w-5 h-5 text-primary" />
            </div>
            <div>
                <p className="text-xs text-muted-foreground font-medium uppercase tracking-wider">{label}</p>
                <p className="text-sm font-bold text-foreground mt-1">{value}</p>
            </div>
        </div>
    )
}

// =================== FILE: src/app/[locale]/(marketing)/legal/cookies/page.tsx ===================

import LegalLayout from '@/components/layout/LegalLayout';
import { Cookie, Settings, BarChart3, XCircle } from 'lucide-react';
import { getTranslations } from 'next-intl/server';

export const metadata = {
  title: 'PolÃ­tica de Cookies | DigitAI Studios',
  description: 'InformaciÃ³ sobre l\'Ãºs de cookies a DigitAI Studios.',
};

export default async function CookiesPage() {
  const t = await getTranslations('Legal.cookies');

  return (
    <LegalLayout>
      <div className="border-b border-border pb-8 mb-8">
        <h1 className="text-3xl md:text-4xl font-extrabold mb-4">{t('title')}</h1>
        <p className="text-xl text-muted-foreground leading-relaxed">
          {t('subtitle')}
        </p>
      </div>

      <div className="space-y-12">

        {/* BLOC 1: DEFINICIÃ“ */}
        <section>
          <h2 className="text-2xl font-bold flex items-center gap-2 mb-4">
            <Cookie className="text-orange-500" /> {t('section1_title')}
          </h2>
          <div className="bg-muted/30 p-6 rounded-xl border border-border">
            <p className="m-0">
              {t('section1_quote')}
            </p>
          </div>
        </section>

        {/* BLOC 2: TIPUS DE COOKIES (GRID) */}
        <section>
          <h2>{t('section2_title')}</h2>
          <p>{t('section2_p1')}</p>
          
          <div className="grid md:grid-cols-2 gap-6 not-prose my-6">
             {/* Cookies TÃ¨cniques */}
             <div className="p-5 rounded-xl border border-border bg-card shadow-sm">
                <div className="flex items-center gap-3 mb-3">
                   <div className="p-2 bg-primary/10 rounded-lg text-primary">
                      <Settings className="w-5 h-5" />
                   </div>
                   <h4 className="font-bold text-lg">{t('tech_title')}</h4>
                </div>
                <p className="text-sm text-muted-foreground mb-4">
                   {t('tech_desc')}
                </p>
                <ul className="space-y-2 text-sm">
                   <li className="flex items-center gap-2">
                      <span className="w-1.5 h-1.5 bg-primary rounded-full"></span>
                      <strong>{t.rich('tech_1', { strong: (chunks) => <strong>{chunks}</strong> })}</strong>
                   </li>
                   <li className="flex items-center gap-2">
                      <span className="w-1.5 h-1.5 bg-primary rounded-full"></span>
                      <strong>{t.rich('tech_2', { strong: (chunks) => <strong>{chunks}</strong> })}</strong>
                   </li>
                </ul>
             </div>

             {/* Cookies AnalÃ­tiques */}
             <div className="p-5 rounded-xl border border-border bg-card shadow-sm">
                <div className="flex items-center gap-3 mb-3">
                   <div className="p-2 bg-blue-500/10 rounded-lg text-blue-500">
                      <BarChart3 className="w-5 h-5" />
                   </div>
                   <h4 className="font-bold text-lg">{t('analytics_title')}</h4>
                </div>
                <p className="text-sm text-muted-foreground mb-4">
                   {t('analytics_desc')}
                </p>
                <ul className="space-y-2 text-sm">
                   <li className="flex items-center gap-2">
                      <span className="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>
                      <strong>{t.rich('analytics_1', { strong: (chunks) => <strong>{chunks}</strong> })}</strong>
                   </li>
                </ul>
             </div>
          </div>
        </section>

        {/* BLOC 3: DESACTIVACIÃ“ */}
        <section>
           <h2 className="flex items-center gap-2">
              <XCircle className="text-red-500" /> {t('section3_title')}
           </h2>
           <p>
             {t('section3_p1')}
           </p>
           
           <div className="flex flex-wrap gap-4 not-prose mt-4">
              <a href="https://support.google.com/chrome/answer/95647" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Google Chrome
              </a>
              <a href="https://support.apple.com/es-es/guide/safari/sfri11471/mac" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Safari
              </a>
              <a href="https://support.mozilla.org/es/kb/habilitar-y-deshabilitar-cookies-sitios-web-rastrear-preferencias" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Firefox
              </a>
              <a href="https://support.microsoft.com/es-es/microsoft-edge/eliminar-las-cookies-en-microsoft-edge-63947406-40ac-c23d-37fd-6b7ac978ce4a" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Microsoft Edge
              </a>
           </div>
        </section>

      </div>
    </LegalLayout>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/legal/privacitat/page.tsx ===================

import LegalLayout from '@/components/layout/LegalLayout';
import { ShieldCheck, Server, Lock } from 'lucide-react';
import { getTranslations } from 'next-intl/server';

export const metadata = {
  title: 'PolÃ­tica de Privacitat | DigitAI Studios',
};

export default async function PrivacitatPage() {
  const t = await getTranslations('Legal.privacitat');
  return (
    <LegalLayout>
      <div className="border-b border-border pb-8 mb-8">
        <h1 className="text-3xl md:text-4xl font-extrabold mb-4">{t('title')}</h1>
        <p className="text-xl text-muted-foreground leading-relaxed">
          {t('subtitle')}
        </p>
      </div>

      <div className="space-y-12">
          
          {/* BLOC 1: RESPONSABLE */}
          <section>
              <h2 className="text-2xl font-bold flex items-center gap-2 mb-4">
                  <ShieldCheck className="text-green-500" /> {t('section1_title')}
              </h2>
              <div className="bg-muted/30 p-6 rounded-xl border border-border">
                  <p className="m-0">
                      {t.rich('section1_text', {
                          strong: (chunks) => <strong>{chunks}</strong>,
                          link: (chunks) => <a href="mailto:dpd@digitaistudios.com">{chunks}</a>
                      })}
                  </p>
              </div>
          </section>

          {/* BLOC 2: QUINES DADES */}
          <section>
              <h2>{t('section2_title')}</h2>
              <p>{t('section2_desc')}</p>
              <div className="grid md:grid-cols-2 gap-6 not-prose my-6">
                  <div className="p-4 rounded-lg border border-border bg-card">
                      <h4 className="font-bold text-lg mb-2 flex items-center gap-2">ğŸ” {t('data_audit_title')}</h4>
                      <p className="text-sm text-muted-foreground">{t('data_audit_desc')}</p>
                  </div>
                  <div className="p-4 rounded-lg border border-border bg-card">
                      <h4 className="font-bold text-lg mb-2 flex items-center gap-2">ğŸ‘¤ {t('data_account_title')}</h4>
                      <p className="text-sm text-muted-foreground">{t('data_account_desc')}</p>
                  </div>
              </div>
          </section>

          {/* BLOC 3: TERCERS */}
          <section>
              <h2 className="flex items-center gap-2"><Server className="text-blue-500" /> {t('section3_title')}</h2>
              <p>{t('section3_desc')}</p>
              <ul className="not-prose space-y-2 mt-4">
                  <li className="flex items-center gap-3 p-2 rounded hover:bg-muted/50">
                      <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                      <span><strong>{t('provider_supabase')}</strong></span>
                  </li>
                  <li className="flex items-center gap-3 p-2 rounded hover:bg-muted/50">
                      <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                      <span><strong>{t('provider_resend')}</strong></span>
                  </li>
                  <li className="flex items-center gap-3 p-2 rounded hover:bg-muted/50">
                      <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                      <span><strong>{t('provider_google')}</strong></span>
                  </li>
              </ul>
          </section>

          {/* BLOC 4: DRETS */}
          <section>
              <h2 className="flex items-center gap-2"><Lock className="text-primary" /> {t('section4_title')}</h2>
              <p>{t('section4_p1')}</p>
              <ul>
                  <li>{t('rights_list_1')}</li>
                  <li>{t('rights_list_2')}</li>
                  <li>{t('rights_list_3')}</li>
                  <li>{t('rights_list_4')}</li>
              </ul>
              <p>{t.rich('rights_contact', { strong: (chunks) => <strong>{chunks}</strong> })}</p>
          </section>

      </div>
    </LegalLayout>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/page.tsx ===================

import { HeroSection } from '@/components/landing/HeroSection';
import { TechStackSection } from '@/components/landing/TechStackSection';
import { ServicesGrid } from '@/components/landing/ServicesGrid';
import { ProductTeaser } from '@/components/landing/ProductTeaser';
import { AuditSection } from '@/components/landing/AuditSection'; 
import { TestimonialsSection } from '@/components/landing/TestimonialsSection';
import { ContactSection } from '@/components/landing/ContactSection';
import { LatestPostsSection } from '@/components/landing/LatestPostsSection';
import { SolutionsShowcase } from '@/components/landing/solutions/SolutionsShowcase';
import { TESTIMONIALS } from '@/lib/data';
import { createClient } from '@/lib/supabase/server';

export default async function MarketingPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  return (
    <>
      {/* 1. HERO (Ja tÃ© id="inici" internament, perÃ² assegurem) */}
      <section id="hero">
        <HeroSection />
      </section>

      <TechStackSection />

      {/* 2. SOLUCIONS */}
      <section id="solutions">
        <SolutionsShowcase />
      </section>

      {/* 3. SERVEIS */}
      <section id="services">
        <ServicesGrid />
      </section>

      <ProductTeaser />
      
      {/* 4. AUDITORIA (CTA) */}
      <section id="audit">
        <AuditSection currentUser={user} />
      </section>
      
      {/* 5. BLOG / RECURSOS */}
      <section id="blog-feed">
        <LatestPostsSection />
      </section>

      {/* 6. TESTIMONIS */}
      <section id="testimonials">
        <TestimonialsSection testimonials={TESTIMONIALS} />
      </section>

      {/* 7. CONTACTE */}
      <section id="contact">
        <ContactSection />
      </section>
    </>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/projectes/page.tsx ===================

import { ProjectsHero, ProjectsList, ProjectsCTA } from '@/features/projects';

export default function ProjectsPage() {
  return (
    // âœ… CORRECCIÃ“: Tret 'px-14' del main per permetre fons full-width als components fills
    <main className="min-h-screen flex flex-col bg-background selection:bg-primary/30 transition-colors duration-300">
      <ProjectsHero />
      <ProjectsList />
      <ProjectsCTA />
    </main>
  );
}

// =================== FILE: src/app/[locale]/admin/analytics/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { analyticsRepository } from '@/services/container';
import { TrafficChart } from '@/features/analytics/ui/TrafficChart';
import { TopPagesCard } from '@/features/analytics/ui/TopPagesCard';
import { DeviceChart } from '@/features/analytics/ui/DeviceChart';
import { BarListChart } from '@/features/analytics/ui/BarListChart';
import { VerticalBarChart } from '@/features/analytics/ui/VerticalBarChart';
import { UnifiedStatBar } from '@/features/analytics/ui/UnifiedStatBar';
// AixÃ² fa que la pÃ gina no es guardi a la cachÃ© estÃ tica per sempre (per veure dades noves)
export const dynamic = 'force-dynamic';
export const revalidate = 60;

function formatDuration(seconds: number): string {
  if (!seconds || seconds === 0) return '0s';
  if (seconds < 60) return `${Math.round(seconds)}s`;
  const m = Math.floor(seconds / 60);
  const s = Math.round(seconds % 60);
  return `${m}m ${s}s`;
}

export default async function AdminAnalyticsPage() {
  await requireAdmin();

  const [dailyStats, adv] = await Promise.all([
    analyticsRepository.getLast7DaysStats(),
    analyticsRepository.getAdvancedStats()
  ]);

  const totalViews = dailyStats.reduce((acc, day) => acc + day.views, 0);
  const totalVisitors = dailyStats.reduce((acc, day) => acc + day.visitors, 0);
  const grandTotalDuration = dailyStats.reduce((acc, day) => acc + (day.totalDuration || 0), 0);
  const averageTimeSeconds = totalVisitors > 0 ? grandTotalDuration / totalVisitors : 0;

  return (
    // FIX 1: Canviem h-screen per h-auto en mÃ²bil (scroll) i fix en LG
    <div className="flex flex-col gap-4 h-auto lg:h-[calc(100vh-2rem)] p-4 overflow-y-auto lg:overflow-hidden bg-background text-foreground">
      
      {/* 1. KPI HEADER */}
      <div className="shrink-0">
         <UnifiedStatBar 
            views={totalViews} 
            visitors={totalVisitors} 
            events={totalViews} 
            avgTime={formatDuration(averageTimeSeconds)} 
         />
      </div>

      {/* 2. DASHBOARD GRID */}
      {/* FIX 2: En mÃ²bil es veurÃ  tot en columna (block). En LG serÃ  grid. */}
      <div className="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-4 min-h-0">
         
         {/* --- ZONA PRINCIPAL (Esquerra) --- */}
         <div className="lg:col-span-2 flex flex-col gap-4 h-auto lg:h-full min-h-0">
            
            {/* A. GRÃ€FIC TRÃ€NSIT */}
            {/* FIX 3: AlÃ§ada fixa en mÃ²bil (h-80), flexible en desktop (flex-[2]) */}
            <div className="h-80 lg:h-auto lg:flex-2 min-h-0 bg-card border border-border rounded-xl shadow-sm overflow-hidden">
                <TrafficChart data={dailyStats} />
            </div>

            {/* B. DETALLS (Top Pages & Referrers) */}
            {/* FIX 4: AlÃ§ada automÃ tica en mÃ²bil, flexible en desktop */}
            <div className="h-auto lg:flex-3 grid grid-cols-1 md:grid-cols-2 gap-4 min-h-0">
                {/* FIX 5: AlÃ§ada fixa per als cards en mÃ²bil */}
                <div className="h-80 lg:h-auto min-h-0 overflow-hidden">
                    <TopPagesCard data={adv.topPages} />
                </div>
                <div className="h-80 lg:h-auto min-h-0 overflow-hidden">
                    <BarListChart title="Fonts de TrÃ nsit" data={adv.referrers} />
                </div>
            </div>
         </div>

         {/* --- SIDEBAR DRET --- */}
         <div className="lg:col-span-1 flex flex-col gap-4 h-auto lg:h-full min-h-0 lg:overflow-y-auto custom-scrollbar pr-1">
            
            <div className="h-64 lg:flex-1 lg:min-h-50">
               <DeviceChart data={adv.devices} />
            </div>

            <div className="h-64 lg:flex-1 lg:min-h-50">
               <VerticalBarChart title="Top PaÃ¯sos" data={adv.countries} />
            </div>

            <div className="h-64 lg:flex-1 lg:min-h-50">
               <BarListChart title="Navegadors" data={adv.browsers} />
            </div>
         </div>

      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/blog/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { postRepository } from '@/services/container';
import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { Plus } from 'lucide-react';
import { AdminPostList } from '@/features/blog/ui/AdminPostList';

// âœ… 1. Definim el tipus com a Promise
interface PageProps {
  params: Promise<{ locale: string }>;
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
}

export default async function AdminBlogPage(props: PageProps) {
  await requireAdmin();

  // âœ… 2. Fem 'await' per desenpaquetar els parÃ metres
  const searchParams = await props.searchParams;

  // âœ… 3. Ara ja podem accedir a les propietats de forma segura
  const page = Number(searchParams.page) || 1;
  const pageSize = 10;

  // 4. La resta continua igual...
  const { posts, total } = await postRepository.getPaginatedPosts(page, pageSize);
  const totalPages = Math.ceil(total / pageSize);

  return (
    <div className="space-y-6">
      
      {/* CAPÃ‡ALERA */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-foreground tracking-tight">GestiÃ³ del Blog</h1>
          <p className="text-muted-foreground text-sm mt-1">
            Mostrant {posts.length} de {total} articles totals.
          </p>
        </div>
        
        <Link href="/admin/blog/new">
            <Button className="gradient-bg text-white shadow-lg border-0">
               <Plus className="w-4 h-4 mr-2" /> Nou Article
            </Button>
        </Link>
      </div>

      {/* LLISTAT I PAGINACIÃ“ */}
      <div className="border border-border rounded-xl overflow-hidden bg-card shadow-sm flex flex-col">
         <AdminPostList 
            posts={posts} 
            currentPage={page} 
            totalPages={totalPages} 
         />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/blog/[slug]/edit/page.tsx ===================

// src/app/[locale]/admin/blog/[slug]/edit/page.tsx

import { requireAdmin } from '@/lib/auth/admin-guard';
import { postRepository } from '@/services/container';
import { notFound } from 'next/navigation';
import { EditPostForm } from '@/features/blog/ui/EditPostForm'; // ğŸ‘ˆ El component que acabem de fer

type Props = {
    params: Promise<{ slug: string }>;
};

export default async function EditPostPage({ params }: Props) {
    await requireAdmin();
    const { slug } = await params;

    // Busquem el post (incloent esborranys)
    const post = await postRepository.getAdminPostBySlug(slug);

    if (!post) {
        return notFound();
    }

    return (
        <div className="min-h-screen bg-background p-4 md:p-8">
            <EditPostForm post={post} />
        </div>
    );
}

// =================== FILE: src/app/[locale]/admin/blog/[slug]/page.tsx ===================

// src/app/[locale]/admin/blog/[slug]/page.tsx

import { requireAdmin } from '@/lib/auth/admin-guard';
import { postRepository } from '@/services/container';
import { notFound } from 'next/navigation';
import { MDXContent } from '@/features/blog/ui/MDXContent';
import { Link } from '@/routing';
import { ArrowLeft, Save, Trash2, ExternalLink, CheckCircle2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import Image from 'next/image';
import { PostStatusToggle } from '@/features/blog/ui/PostStatusToggle';
import { createClient } from '@/lib/supabase/server';
import { PostViewTabs } from '@/components/admin/posts/PostViewTabs';

type Props = {
    params: Promise<{ slug: string }>;
};

export default async function AdminPostDetailPage({ params }: Props) {
    await requireAdmin();
    const { slug } = await params;

    const post = await postRepository.getAdminPostBySlug(slug);
    if (!post) return notFound();

    const supabase = await createClient();
    const { data: socialPosts } = await supabase
        .from('social_posts')
        .select('*')
        .eq('post_id', post.id);

    return (
        <div className="w-full max-w-7xl mx-auto p-4 md:p-8 space-y-8 pb-20">
            
            {/* --- CAPÃ‡ALERA RESPONSIVE UNIFICADA --- */}
            {/* flex-col en mÃ²bil (un sota l'altre), flex-row en PC (al costat) */}
            <div className="flex flex-col md:flex-row justify-between items-start gap-6 border-b border-border pb-6">
                
                {/* 1. BLOC TÃTOL I INFO */}
                <div className="flex items-start gap-3 w-full md:w-auto">
                    <Link href="/admin/blog" className="shrink-0 mt-1">
                        <Button variant="outline" size="icon" className="h-9 w-9 rounded-full">
                            <ArrowLeft className="w-4 h-4" />
                        </Button>
                    </Link>
                    
                    <div className="space-y-2 min-w-0 flex-1">
                        <h1 className="text-2xl md:text-3xl font-bold leading-tight break-words">
                            {post.title}
                        </h1>
                        
                        {/* Metadades petites */}
                        <div className="flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
                            <span className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold border ${
                                post.published 
                                    ? 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-400' 
                                    : 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400'
                            }`}>
                                <span className={`w-1.5 h-1.5 rounded-full ${post.published ? 'bg-green-600' : 'bg-yellow-600'}`} />
                                {post.published ? 'PUBLICAT' : 'ESBORRANY'}
                            </span>
                            <span className="font-mono text-xs opacity-50 truncate max-w-[200px]">
                                / {post.slug}
                            </span>
                        </div>
                    </div>
                </div>

                {/* 2. BLOC BOTONS (La part que es tallava) */}
                {/* flex-wrap: Si no hi caben, baixen de lÃ­nia. NO es tallen. */}
                <div className="flex flex-wrap items-center gap-2 w-full md:w-auto justify-start md:justify-end">
                    
                    <Button variant="ghost" size="icon" className="text-destructive shrink-0">
                        <Trash2 className="w-5 h-5"/>
                    </Button>
                    
                    {post.published && (
                        <Link href={`/blog/${post.slug}`} target="_blank">
                            <Button variant="outline" size="icon" className="shrink-0">
                                <ExternalLink className="w-5 h-5"/>
                            </Button>
                        </Link>
                    )}
                    
                    {/* Separador vertical (nomÃ©s estÃ¨tic) */}
                    <div className="h-6 w-px bg-border mx-1 hidden sm:block" />
                    
                    {/* Toggle d'estat */}
                    <div className="shrink-0">
                        <PostStatusToggle postId={post.id || ''} isPublished={post.published} />
                    </div>
                    
                    {/* BotÃ³ Editar */}
                    <Link href={`/admin/blog/${post.slug}/edit`}>
                        <Button className="font-semibold shadow-sm shrink-0">
                            <Save className="w-4 h-4 mr-2"/> 
                            Editar
                        </Button>
                    </Link>
                </div>
            </div>

            {/* --- CONTINGUT (TABS & GRID) --- */}
            <PostViewTabs postId={post.id} socialPosts={socialPosts || []}>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8 mt-6">
                    
                    {/* COLUMNA ESQUERRA (Contingut) */}
                    <div className="lg:col-span-2 space-y-6">
                        <div className="relative aspect-video rounded-xl overflow-hidden bg-muted border border-border">
                            {post.coverImage ? (
                                <Image src={post.coverImage} alt="Cover" fill className="object-cover" />
                            ) : (
                                <div className="flex items-center justify-center h-full text-muted-foreground/50 text-sm">Sense Imatge</div>
                            )}
                        </div>

                        <Card>
                            <CardHeader className="py-3 bg-muted/10 border-b"><CardTitle className="text-sm">Contingut del Post</CardTitle></CardHeader>
                            <CardContent className="p-4 md:p-6 prose dark:prose-invert max-w-none prose-sm md:prose-base">
                                <MDXContent source={post.content || ''} />
                            </CardContent>
                        </Card>
                    </div>

                    {/* COLUMNA DRETA (Info) */}
                    <div className="space-y-6">
                        <Card>
                            <CardHeader className="py-3 bg-muted/10 border-b"><CardTitle className="text-xs font-bold uppercase text-muted-foreground">Detalls SEO</CardTitle></CardHeader>
                            <CardContent className="p-4 space-y-4 text-sm">
                                <div>
                                    <label className="font-bold text-muted-foreground text-xs block mb-1">URL Slug</label>
                                    <code className="bg-muted p-1.5 rounded text-xs block truncate">{post.slug}</code>
                                </div>
                                <div>
                                    <label className="font-bold text-muted-foreground text-xs block mb-1">DescripciÃ³</label>
                                    <p className="text-muted-foreground italic text-xs leading-relaxed">{post.description || 'Sense descripciÃ³'}</p>
                                </div>
                                <div>
                                    <label className="font-bold text-muted-foreground text-xs block mb-2">Tags</label>
                                    <div className="flex flex-wrap gap-2">
                                        {post.tags.map(t => (
                                            <span key={t} className="bg-muted border px-2 py-1 rounded text-[10px] font-medium">#{t}</span>
                                        ))}
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            </PostViewTabs>
        </div>
    );
}

// =================== FILE: src/app/[locale]/admin/debug/page.tsx ===================

'use client';

import { useState, useEffect } from 'react';
import { createClient } from '@/lib/supabase/client';

// Definim una interfÃ­cie simple per al resultat que esperem de Supabase
interface SupabaseCountResult {
  count: number | null;
  error: {
    message: string;
    code?: string;
  } | null;
}

export default function DebugAnalyticsPage() {
  const [logs, setLogs] = useState<string[]>([]);
  const [envStatus] = useState({
    url: !!process.env.NEXT_PUBLIC_SUPABASE_URL,
    key: !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
  });

  // 1. Comprovem variables nomÃ©s carregar
  // Eliminat useEffect perquÃ¨ la inicialitzaciÃ³ es fa directament a useState

  const addLog = (msg: string) => setLogs(prev => [...prev, `${new Date().toLocaleTimeString()} > ${msg}`]);

  const testConnection = async () => {
    addLog('ğŸš€ INICIANT TEST...');
    
    // ValidaciÃ³ prÃ¨via
    if (!process.env.NEXT_PUBLIC_SUPABASE_URL) {
      addLog('âŒ ERROR FATAL: Falta NEXT_PUBLIC_SUPABASE_URL');
      return;
    }

    try {
      addLog('1. Creant client Supabase...');
      const supabase = createClient();
      
      addLog('2. Enviant peticiÃ³ (SELECT)...');
      
      // Fem un timeout manual per si es queda penjat
      const timeoutPromise = new Promise<never>((_, reject) => 
        setTimeout(() => reject(new Error("Timeout: La xarxa estÃ  bloquejada (AdBlock?)")), 5000)
      );

      const dbPromise = supabase
        .from('analytics_events')
        .select('count', { count: 'exact', head: true });

      // Cursa entre la DB i el Timeout. Forcem el tipus a 'unknown' primer i desprÃ©s al nostre tipus.
      const result = await Promise.race([dbPromise, timeoutPromise]) as unknown as SupabaseCountResult;

      if (result.error) {
        addLog(`âŒ ERROR DB: ${result.error.message}`);
        console.error(result.error);
      } else {
        addLog(`âœ… CONNEXIÃ“ CORRECTA! Files a la taula: ${result.count}`);
      }

    } catch (err: unknown) { 
      // CANVI CLAU: Usem 'unknown' en lloc de 'any'
      let errorMessage = 'Error desconegut';
      
      if (err instanceof Error) {
        errorMessage = err.message;
      } else if (typeof err === 'string') {
        errorMessage = err;
      }

      addLog(`ğŸ’¥ EXCEPCIÃ“: ${errorMessage}`);
      console.error(err);
    }
  };

  return (
    <div className="p-8 text-white bg-slate-950 min-h-screen">
      <h1 className="text-3xl font-bold mb-6 text-red-500">ğŸš‘ DIAGNÃ’STIC D'URGÃˆNCIA</h1>
      
      {/* Estat Variables */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        <div className={`p-4 rounded border ${envStatus.url ? 'border-green-500 bg-green-900/20' : 'border-red-500 bg-red-900/20'}`}>
          <div className="font-bold">SUPABASE_URL</div>
          <div className="text-2xl">{envStatus.url ? 'âœ… OK' : 'âŒ MISSING'}</div>
        </div>
        <div className={`p-4 rounded border ${envStatus.key ? 'border-green-500 bg-green-900/20' : 'border-red-500 bg-red-900/20'}`}>
          <div className="font-bold">ANON_KEY</div>
          <div className="text-2xl">{envStatus.key ? 'âœ… OK' : 'âŒ MISSING'}</div>
        </div>
      </div>

      <button 
        onClick={testConnection}
        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg mb-6 transition-colors"
      >
        FORÃ‡AR PROVA DE CONNEXIÃ“
      </button>

      <div className="bg-black rounded-lg p-4 font-mono text-sm border border-slate-800 h-64 overflow-y-auto">
        {logs.length === 0 ? <span className="text-slate-500">Els logs apareixeran aquÃ­...</span> : logs.map((log, i) => (
          <div key={i} className="mb-1 border-b border-slate-900 pb-1">{log}</div>
        ))}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/layout.tsx ===================

// src/app/[locale]/admin/layout.tsx
import { requireAdmin } from '@/lib/auth/admin-guard';
import { AdminBottomNav } from '@/components/admin/AminMobileMenu'; // Assegura't del nom correcte (AminMobileMenu o AdminMobileMenu)
import { AdminSidebar } from '@/components/admin/AdminSidebar'; // ğŸ‘ˆ El nou component
import { ShieldAlert } from 'lucide-react';

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // 1. Bloqueig de seguretat (Server Side)
  await requireAdmin();

  return (
    // Usem classes semÃ ntiques (bg-background) per preparar el Pas 2 (Themes)
    <div className="flex h-screen overflow-hidden bg-background text-foreground">

      {/* SIDEBAR (Desktop) - Ara modularitzat */}
      <AdminSidebar />

      {/* CONTINGUT PRINCIPAL */}
      <div className="flex-1 flex flex-col min-w-0 relative">
        
        {/* Header MÃ²bil (NomÃ©s visible en pantalles petites) */}
        <header className="md:hidden h-14 border-b border-border flex items-center justify-center bg-card/80 backdrop-blur-sm shrink-0 sticky top-0 z-30">
          <span className="flex items-center gap-2 font-bold text-foreground text-sm">
            <ShieldAlert className="w-4 h-4 text-red-500" /> ADMIN PANEL
          </span>
        </header>

        {/* Zona de Contingut amb Scroll */}
        <main className="flex-1 overflow-y-auto p-4 md:p-8 mb-16 md:mb-0 scroll-smooth">
          {children}
        </main>

        {/* NavegaciÃ³ MÃ²bil (Bottom Bar) */}
        <AdminBottomNav />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/missatges/page.tsx ===================

import { getAdminLeads } from '@/actions/admin/leads';
import { getAdminAudits } from '@/actions/admin/audits'; // ğŸ‘ˆ Importem la nova acciÃ³
import { LeadsTable } from '@/components/admin/LeadsTable';
import { AuditsTable } from '@/components/admin/AuditsTable'; // ğŸ‘ˆ Importem la nova taula
import { PaginationControls } from '@/components/ui/pagination-controls';
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"; // Shadcn Tabs

export const dynamic = 'force-dynamic';

interface PageProps {
  searchParams: Promise<{ page?: string }>;
}

export default async function AdminInboxPage({ searchParams }: PageProps) {
  const resolvedParams = await searchParams;
  const page = Number(resolvedParams.page) || 1;

  console.log(`ğŸ‘€ [PAGE] Renderitzant pÃ gina ${page}...`);

  const [leadsResult, auditsResult] = await Promise.all([
    getAdminLeads(page),
    getAdminAudits()
  ]);

  // AFEGEIX AQUEST LOG:
  if (leadsResult.success) {
    const ids = leadsResult.leads.map(l => l.id.substring(0, 5) + '...');
    console.log(`ğŸ“¦ [PAGE] Leads rebuts del servidor:`, ids);
    console.log(`ğŸ”¢ [PAGE] Total leads:`, leadsResult.metadata.total);
  } else {
    console.error(`âŒ [PAGE] Error rebent leads:`, leadsResult.error);
  }

  const totalLeads = leadsResult.success ? leadsResult.metadata.total : 0;
  // âœ… CORRECCIÃ“: Fem servir l'operador '?' o un fallback '|| []'
  // Si auditsResult.data Ã©s undefined, el total serÃ  0.
  const totalAudits = auditsResult.success && auditsResult.data ? auditsResult.data.length : 0;

  return (
    <div className="space-y-6 p-8">
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold tracking-tight text-foreground">BÃºstia d'Entrada</h1>
          <p className="text-muted-foreground mt-1">
            Gestiona totes les interaccions dels usuaris.
          </p>
        </div>
      </div>

      {/* SISTEMA DE PESTANYES */}
      <Tabs defaultValue="messages" className="w-full">
        <TabsList className="grid w-full max-w-100 grid-cols-2 mb-6">
          <TabsTrigger value="messages">
            Missatges ({totalLeads})
          </TabsTrigger>
          <TabsTrigger value="audits">
            Auditories ({totalAudits})
          </TabsTrigger>
        </TabsList>

        {/* --- PESTANYA 1: MISSATGES --- */}
        <TabsContent value="messages" className="space-y-4">
          {leadsResult.success ? (
            <>
              <LeadsTable leads={leadsResult.leads} />
              {leadsResult.metadata.totalPages > 1 && (
                <PaginationControls metadata={leadsResult.metadata} />
              )}
            </>
          ) : (
            <div className="text-red-500">Error: {leadsResult.error}</div>
          )}
        </TabsContent>

        {/* --- PESTANYA 2: AUDITORIEs --- */}
        <TabsContent value="audits" className="space-y-4">
          {auditsResult.success && auditsResult.data ? (
            <AuditsTable audits={auditsResult.data} />
          ) : (
            <div className="text-red-500">Error carregant auditories</div>
          )}
        </TabsContent>
      </Tabs>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/missatges/[id]/page.tsx ===================

import { getAdminLeadById } from '@/actions/admin/leads';
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { ArrowLeft, Calendar, Mail,  Tag, MessageSquare, Reply } from 'lucide-react';
import { notFound } from 'next/navigation';

export const dynamic = 'force-dynamic';

interface PageProps {
  params: Promise<{ id: string; locale: string }>;
}

export default async function LeadDetailPage({ params }: PageProps) {
  // 1. AWAIT els params (Obligatori a Next.js 16)
  const { id, locale } = await params;

  // 2. Carregar dades
  const result = await getAdminLeadById(id);

  // 3. GestiÃ³ d'errors (si no existeix, 404)
  if (!result.success || !result.lead) {
    return notFound();
  }

  const { lead } = result;

  return (
    <div className="max-w-5xl mx-auto p-4 md:p-10 space-y-6 md:space-y-8">
      {/* --- BOTÃ“ ENRERE --- */}
      <div>
        <Link 
          href={`/${locale}/admin/missatges`} 
          className="inline-flex items-center text-sm font-medium text-muted-foreground hover:text-primary transition-colors py-2"
        >
          <ArrowLeft className="w-4 h-4 mr-2" />
          Tornar a la bÃºstia
        </Link>
      </div>

      {/* --- CAPÃ‡ALERA DEL LEAD --- */}
      <div className="bg-card border border-border rounded-xl p-6 shadow-sm">
        <div className="flex flex-col md:flex-row md:items-start justify-between gap-6">
          
          {/* Dades Principals */}
          <div className="space-y-4 w-full">
            <div className="flex flex-col md:flex-row md:items-center gap-3 md:gap-4">
              <h1 className="text-2xl md:text-3xl font-bold text-foreground">
                {lead.full_name || 'Usuari AnÃ²nim'}
              </h1>
              <span className="inline-flex w-fit px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 border border-blue-200 dark:border-blue-800">
                {lead.service || 'Consulta General'}
              </span>
            </div>

            {/* Graella de Metadades */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:flex lg:flex-wrap gap-4 text-sm text-muted-foreground pt-2">
              
              <div className="flex items-center gap-2 min-w-0">
                <div className="p-2 bg-muted rounded-md shrink-0">
                    <Mail className="w-4 h-4 text-foreground" />
                </div>
                <a href={`mailto:${lead.email}`} className="hover:text-primary hover:underline truncate">
                  {lead.email}
                </a>
              </div>

              <div className="flex items-center gap-2">
                <div className="p-2 bg-muted rounded-md shrink-0">
                    <Calendar className="w-4 h-4 text-foreground" />
                </div>
                <span>
                  {/* âœ… CORRECCIÃ“: Fem servir toLocaleString en lloc de toLocaleDateString */}
                  {new Date(lead.created_at).toLocaleString('ca-ES', {
                    dateStyle: 'long', 
                    timeStyle: 'short'
                  })}
                </span>
              </div>

              <div className="flex items-center gap-2">
                <div className="p-2 bg-muted rounded-md shrink-0">
                    <Tag className="w-4 h-4 text-foreground" />
                </div>
                <span className="capitalize">{lead.source?.replace('_', ' ') || 'Web'}</span>
              </div>
            </div>
          </div>

          {/* BotÃ³ d'acciÃ³ rÃ pida (Respondre) */}
          <div className="shrink-0 flex gap-2">
             <a href={`mailto:${lead.email}?subject=Resposta a la teva consulta sobre ${lead.service}`}>
                <Button className="w-full md:w-auto gap-2">
                    <Reply className="w-4 h-4" />
                    Respondre
                </Button>
             </a>
          </div>
        </div>
      </div>

      {/* --- COS DEL MISSATGE --- */}
      <div className="space-y-3">
        <h3 className="flex items-center gap-2 text-sm font-semibold uppercase tracking-wider text-muted-foreground ml-1">
          <MessageSquare className="w-4 h-4" />
          Contingut del missatge
        </h3>
        
        <div className="bg-card border border-border rounded-xl p-6 md:p-8 shadow-sm min-h-50">
          {lead.message ? (
            <div className="prose dark:prose-invert max-w-none whitespace-pre-wrap text-foreground/90 leading-relaxed wrap-break-word">
              {lead.message}
            </div>
          ) : (
            <p className="text-muted-foreground italic">
              L'usuari no ha escrit cap missatge addicional.
            </p>
          )}
        </div>
      </div>

      {/* --- PEU DE PÃ€GINA (Lloc per al Delete a la Fase 3) --- */}
      <div className="flex justify-end pt-6 border-t border-border mt-8">
        {/* AquÃ­ posarem el botÃ³ d'eliminar en vermell */}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/page.tsx ===================

import { redirect } from 'next/navigation'; // Use native Next.js redirect

type Props = {
  params: Promise<{ locale: string }>;
};

export default async function AdminDashboard({ params }: Props) {
  const { locale } = await params;
  
  // Explicitly construct the URL with the current locale
  redirect(`/${locale}/admin/analytics`);
}

// =================== FILE: src/app/[locale]/admin/projects/new/page.tsx ===================

import { NewProjectForm } from '@/features/projects/ui/form/NewProjectForm';
import { requireAdmin } from '@/lib/auth/admin-guard'; // La teva protecciÃ³ d'admin

export default async function CreateProjectPage() {
  // ğŸ›¡ï¸ Seguretat: NomÃ©s tu pots entrar aquÃ­
  await requireAdmin();

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-black py-12 px-4">
      <div className="container mx-auto">
        <h1 className="text-3xl font-bold text-center mb-8">Nou Client</h1>
        <NewProjectForm />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/projects/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { createClient } from '@/lib/supabase/server';
import { Link } from '@/routing';
import { Plus, Github, ExternalLink, Clock, CheckCircle, AlertCircle, LayoutGrid } from 'lucide-react';
import { Button } from '@/components/ui/button';

export default async function AdminProjectsPage() {
  await requireAdmin();
  const supabase = await createClient();

  // Obtenim projectes i la seva organitzaciÃ³ vinculada
  const { data: projects } = await supabase
    .from('projects')
    .select('*, organizations(plan)')
    .order('created_at', { ascending: false });

  return (
    <div className="min-h-screen bg-background p-8">
      <div className="max-w-6xl mx-auto">
        
        {/* Header */}
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
          <div>
            <h1 className="text-3xl font-bold text-foreground tracking-tight">Projectes Clients</h1>
            <p className="text-muted-foreground">GestiÃ³ de les PWA generades ({projects?.length || 0})</p>
          </div>
          <Link href="/admin/projects/new">
            <Button className="bg-primary text-primary-foreground hover:bg-primary/90 shadow-lg border-0 gap-2">
              <Plus className="w-5 h-5" /> Generar Nova Web
            </Button>
          </Link>
        </div>

        {/* Grid de Projectes */}
        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {projects?.map((project) => (
            <div key={project.id} className="bg-card border border-border rounded-xl p-6 shadow-sm hover:shadow-md hover:border-primary/30 transition-all flex flex-col h-full">
              
              {/* CapÃ§alera Card */}
              <div className="flex justify-between items-start mb-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-lg bg-linear-to-br from-primary/20 to-purple-500/20 border border-primary/10 flex items-center justify-center text-primary font-bold text-lg">
                    {project.name.charAt(0)}
                  </div>
                  <div className="overflow-hidden">
                    <h3 className="font-bold text-foreground truncate" title={project.name}>{project.name}</h3>
                    <p className="text-xs text-muted-foreground font-mono truncate">{project.domain}</p>
                  </div>
                </div>
                <StatusBadge status={project.status ?? 'pending'} />
              </div>

              {/* Detalls */}
              <div className="space-y-3 mb-6 flex-1">
                <div className="flex items-center justify-between text-sm py-1 border-b border-border/50">
                  <span className="text-muted-foreground">Pla:</span>
                  <span className="font-medium capitalize text-foreground">
                    {project.organizations?.plan || 'BÃ sic'}
                  </span>
                </div>
                <div className="flex items-center justify-between text-sm py-1">
                  <span className="text-muted-foreground">Creat:</span>
                  <span className="text-foreground">
                    {project.created_at ? new Date(project.created_at).toLocaleDateString() : 'Desconegut'}
                  </span>
                </div>
              </div>

              {/* Accions */}
              <div className="flex gap-2 pt-4 border-t border-border mt-auto">
                <a 
                  href={project.repository_url ?? '#'} 
                  target="_blank" 
                  className="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg border border-border text-muted-foreground hover:bg-muted hover:text-foreground text-sm font-medium transition-colors"
                >
                  <Github className="w-4 h-4" /> Codi
                </a>
                
                <Link 
                  href={`/admin/projects/${project.id}`}
                  className="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg bg-primary text-primary-foreground hover:opacity-90 text-sm font-bold transition-colors"
                >
                  <ExternalLink className="w-4 h-4" /> Gestionar
                </Link>
              </div>

            </div>
          ))}

          {projects?.length === 0 && (
            <div className="col-span-full py-24 text-center bg-muted/20 rounded-xl border-2 border-dashed border-border flex flex-col items-center justify-center">
              <div className="p-4 bg-muted rounded-full mb-4">
                 <LayoutGrid className="w-8 h-8 text-muted-foreground opacity-50" />
              </div>
              <h3 className="text-lg font-medium text-foreground">Sense projectes</h3>
              <p className="text-muted-foreground mt-1 mb-6">Encara no has creat cap projecte per a clients.</p>
              <Link href="/admin/projects/new">
                <Button variant="outline">Crear el primer</Button>
              </Link>
            </div>
          )}
        </div>

      </div>
    </div>
  );
}

// Component Status Badge - Adaptable al tema
function StatusBadge({ status }: { status: string }) {
  // Mapeig de colors semÃ ntics (amb opacitat per suportar dark mode)
  const styles = {
    active: "bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20",
    pending: "bg-yellow-500/10 text-yellow-600 dark:text-yellow-400 border-yellow-500/20",
    maintenance: "bg-orange-500/10 text-orange-600 dark:text-orange-400 border-orange-500/20",
    archived: "bg-slate-500/10 text-slate-600 dark:text-slate-400 border-slate-500/20"
  };
  
  const icons = {
    active: CheckCircle,
    pending: Clock,
    maintenance: AlertCircle,
    archived: AlertCircle
  };

  // Type-safe key access
  const normalizedStatus = status.toLowerCase() as keyof typeof styles;
  const Icon = icons[normalizedStatus] || Clock;
  const style = styles[normalizedStatus] || styles.pending;

  return (
    <span className={`flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold border uppercase tracking-wider ${style}`}>
      <Icon className="w-3 h-3" />
      {status}
    </span>
  );
}

// =================== FILE: src/app/[locale]/admin/projects/[id]/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { createClient } from '@/lib/supabase/server';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { notFound } from 'next/navigation';
import { Link } from '@/routing';
import { Github, Globe, Server, LayoutDashboard, FlaskConical, ArrowLeft } from 'lucide-react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ProjectCampaignsList } from '@/features/projects/ui/ProjectCampaignsList';
import { ProjectTeamManager } from '@/features/projects/ui/ProjectTeamManeger';
// ğŸ‘‡ 1. IMPORTEM EL TIPUS DEL REPOSITORI
import { SupabaseProjectRepository, ProjectMember } from '@/repositories/supabase/SupabaseProjectRepository';
import { DestructionButton } from '@/features/projects/ui/DeleteProjectButton';

// ğŸ‘‡ 2. DEFINIM EL TIPUS PER ALS CANDIDATS (CÃ²pia de l'estructura de 'profiles')
type Candidate = {
    id: string;
    email: string;
    full_name: string | null;
    avatar_url: string | null;
};

type Props = {
    params: Promise<{ id: string }>;
};

export default async function ProjectDetailPage({ params }: Props) {
    await requireAdmin();
    const { id } = await params;
    const supabase = await createClient();

    // Instanciem repositoris
    const testRepo = new SupabaseTestRepository();
    const projectRepo = new SupabaseProjectRepository();

    // 1. Dades del Projecte + Campanyes en paralÂ·lel
    const [projectRes, campaigns] = await Promise.all([
        supabase.from('projects').select('*, organizations(*)').eq('id', id).single(),
        testRepo.getCampaignsByProject(id)
    ]);

    const project = projectRes.data;
    if (!project) notFound();

    // 2. ğŸ”¥ CÃ€RREGA DE DADES D'EQUIP (CORREGIT SENSE 'any')
    // Inicialitzem amb arrays buits perÃ² TIPATS
    let members: ProjectMember[] = [];
    let candidates: Candidate[] = [];

    if (project.organization_id) {
        // Fem la crida
        const [fetchedMembers, fetchedCandidates] = await Promise.all([
            projectRepo.getMembers(id),
            projectRepo.getAvailableCandidates(id, project.organization_id)
        ]);

        // Assignem els resultats
        members = fetchedMembers;
        // Fem un cast segur perquÃ¨ sabem que la DB retorna aquesta estructura
        candidates = fetchedCandidates as Candidate[];
    }
    // âœ… CORRECCIÃ“ 3: Extreure el nom del repo de la URL
    // Si la URL Ã©s: https://github.com/ORG/NOM-DEL-REPO
    // Volem: NOM-DEL-REPO
    let cleanRepoName = '';

    if (project.repository_url) {
        const parts = project.repository_url.split('/');
        // Agafem l'Ãºltima part que no sigui buida
        cleanRepoName = parts.filter(Boolean).pop() || '';
    }

    // Fallback de seguretat: Si no trobem URL, potser el slug del projecte serveix?
    if (!cleanRepoName) {
        // Assumeixo que potser tens un camp 'slug' o el pots treure del nom
        cleanRepoName = project.name || '';
    }
    return (
        <div className="min-h-screen bg-slate-50 dark:bg-slate-950 p-6 md:p-10">
            <div className="max-w-6xl mx-auto">

                {/* Header de NavegaciÃ³ */}
                <Link href="/admin/projects" className="text-sm text-slate-500 hover:text-white mb-6 flex items-center gap-2 transition-colors">
                    <ArrowLeft className="w-4 h-4" /> Tornar al llistat
                </Link>

                {/* Header Principal */}
                <div className="flex flex-col md:flex-row justify-between items-start mb-8 gap-4">
                    <div>
                        <h1 className="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
                            {project.name}
                            <span className="text-sm px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-mono border border-blue-200 dark:border-blue-800">
                                {project.status}
                            </span>
                        </h1>
                        <p className="text-slate-500 mt-2 font-mono text-sm">{project.domain || 'Sense domini assignat'}</p>
                    </div>

                    <div className="flex gap-2">
                        <a
                            href={project.repository_url || '#'}
                            target="_blank"
                            className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
                        >
                            <Github className="w-4 h-4" /> Repo
                        </a>
                        {project.hosting_url && (
                            <a
                                href={`https://${project.hosting_url}`}
                                target="_blank"
                                className="flex items-center gap-2 px-4 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-lg text-sm font-bold hover:opacity-90 transition-colors"
                            >
                                <Globe className="w-4 h-4" /> Web
                            </a>
                        )}
                        {/* ğŸ‘‡ PASSEM EL NOM NETEJAT AL BOTÃ“ */}
                        <div className="ml-2 pl-2 border-l border-slate-300 dark:border-slate-700">
                            {cleanRepoName ? (
                                <DestructionButton repoName={cleanRepoName} />
                            ) : (
                                <span className="text-xs text-red-400 px-2">
                                    âš ï¸ No puc destruir (falta Repo Name)
                                </span>
                            )}
                        </div>
                    </div>
                </div>

                {/* ESTRUCTURA DE PESTANYES */}
                <Tabs defaultValue="overview" className="w-full">
                    <TabsList className="bg-slate-200 dark:bg-slate-900 border border-slate-300 dark:border-slate-800 mb-8 w-full justify-start h-auto p-1">
                        <TabsTrigger value="overview" className="px-6 py-2.5 data-[state=active]:bg-white dark:data-[state=active]:bg-slate-800">
                            <LayoutDashboard className="w-4 h-4 mr-2" /> Equip & ConfiguraciÃ³
                        </TabsTrigger>
                        <TabsTrigger value="qa" className="px-6 py-2.5 data-[state=active]:bg-white dark:data-[state=active]:bg-slate-800">
                            <FlaskConical className="w-4 h-4 mr-2" /> QA & Tests
                            <span className="ml-2 bg-slate-200 dark:bg-slate-700 px-1.5 py-0.5 rounded-full text-xs">{campaigns.length}</span>
                        </TabsTrigger>
                    </TabsList>

                    {/* TAB 1: VISIÃ“ GENERAL */}
                    <TabsContent value="overview">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">

                            {/* âœ… Component de GestiÃ³ d'Equip (TIPAT CORRECTAMENT) */}
                            <div className="h-full min-h-100">
                                <ProjectTeamManager
                                    projectId={id}
                                    members={members}
                                    candidates={candidates}
                                />
                            </div>

                            {/* Targeta TÃ¨cnica */}
                            <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 shadow-sm h-fit">
                                <h3 className="text-lg font-bold mb-6 flex items-center gap-2 text-slate-900 dark:text-white">
                                    <Server className="w-5 h-5 text-blue-500" /> Infraestructura
                                </h3>
                                <div className="space-y-4">
                                    <div className="flex justify-between py-3 border-b border-slate-100 dark:border-slate-800">
                                        <span className="text-slate-500">Base de Dades ID</span>
                                        <span className="font-mono text-sm">{project.organization_id}</span>
                                    </div>
                                    <div className="bg-slate-50 dark:bg-slate-800 p-4 rounded-lg mt-4">
                                        <h4 className="font-bold text-xs uppercase text-slate-500 mb-2">ConfiguraciÃ³ Visual</h4>
                                        <pre className="text-xs text-slate-700 dark:text-slate-300 overflow-x-auto">
                                            {JSON.stringify(project.branding_config, null, 2)}
                                        </pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </TabsContent>

                    {/* TAB 2: QA & TESTS */}
                    <TabsContent value="qa">
                        <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 shadow-sm min-h-100">
                            <ProjectCampaignsList campaigns={campaigns} projectId={id} />
                        </div>
                    </TabsContent>

                </Tabs>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/admin/settings/page.tsx ===================

import { createClient } from '@/lib/supabase/server'; // Revisa ruta
import { ConnectSocials } from '@/components/admin/socials/ConnectSocials';

export default async function SettingsPage() {
  const supabase = await createClient();

  // 1. Obtenim l'usuari actual
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return <div>No autoritzat</div>;

  // 2. Busquem la seva organitzaciÃ³
  const { data: profile } = await supabase
    .from('profiles')
    .select('organization_id')
    .eq('id', user.id)
    .single();

  // 3. RECUPEREM LES CONNEXIONS ACTIVES ğŸŸ¢
  const { data: connections } = await supabase
    .from('social_connections')
    .select('*')
    .eq('organization_id', profile!.organization_id);

  return (
    <div className="p-8 max-w-4xl mx-auto">
      <h1 className="text-2xl font-bold mb-6">ConfiguraciÃ³ i Integracions</h1>
      
      {/* Passem les connexions reals al component */}
      <ConnectSocials connections={connections || []} />
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/tests/new/page.tsx ===================

// src/app/[locale]/admin/tests/new/page.tsx
import { requireAdmin } from '@/lib/auth/admin-guard';
import { createClient } from '@/lib/supabase/server';
import { Link } from '@/routing';
import { ArrowLeft } from 'lucide-react';

// ğŸ‘‡ IMPORT CRÃTIC: Ha de ser entre claus { }
import { CreateCampaignForm } from '@/features/tests/ui/CreateCampaignForm';

export default async function NewCampaignPage() {
  await requireAdmin();
  const supabase = await createClient();

  const { data: projects } = await supabase
    .from('projects')
    .select('id, name')
    .order('created_at', { ascending: false });

  return (
    <div className="max-w-2xl mx-auto p-8">
        <Link href="/admin/tests" className="text-slate-500 hover:text-white flex items-center gap-2 mb-6 transition-colors">
            <ArrowLeft className="w-4 h-4" /> CancelÂ·lar
        </Link>

        <h1 className="text-3xl font-bold text-white mb-8">Nova Campanya de Test</h1>

        <CreateCampaignForm projects={projects || []} />
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/tests/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { Plus, FlaskConical, ExternalLink } from 'lucide-react';

// Tipus local per a la vista (amb les dades ja processades pel repo)
type AdminCampaignView = {
  id: string;
  title: string;
  description: string | null;
  status: string;
  created_at: string;
  projects: { name: string } | null;
  stats: {
    total_tasks: number;
    total_results: number;
  };
};

export default async function AdminTestsPage() {
  await requireAdmin();
  const repo = new SupabaseTestRepository();
  
  // Fem servir el tipus nou
  const campaigns = (await repo.getAllCampaignsForAdmin()) as unknown as AdminCampaignView[];

  return (
    <div className="p-8">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-3xl font-bold text-white flex items-center gap-3">
            <FlaskConical className="w-8 h-8 text-purple-500" /> GestiÃ³ de QA
          </h1>
          <p className="text-slate-400 mt-1">Administra les campanyes de proves beta.</p>
        </div>
        <Link href="/admin/tests/new">
          <Button className="bg-purple-600 hover:bg-purple-700 text-white">
            <Plus className="w-4 h-4 mr-2" /> Nova Campanya
          </Button>
        </Link>
      </div>

      <div className="grid gap-4">
        {campaigns.map((camp) => (
          <div key={camp.id} className="bg-slate-900 border border-slate-800 rounded-xl p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:border-purple-500/30 transition-colors">
            
            {/* Info Principal */}
            <div>
              <div className="flex items-center gap-3 mb-1">
                <h3 className="text-lg font-bold text-white">{camp.title}</h3>
                <span className={`text-[10px] px-2 py-0.5 rounded font-bold uppercase ${camp.status === 'active' ? 'bg-green-900 text-green-300' : 'bg-slate-700 text-slate-300'}`}>
                    {camp.status}
                </span>
              </div>
              <p className="text-sm text-slate-400 mb-2">{camp.description || "Sense descripciÃ³"}</p>
              <div className="flex items-center gap-4 text-xs text-slate-500 font-mono">
                <span>ğŸ“‚ {camp.projects?.name || 'Projecte esborrat'}</span>
                <span>ğŸ“… {new Date(camp.created_at).toLocaleDateString()}</span>
              </div>
            </div>

            {/* EstadÃ­stiques (ARA MOLT MÃ‰S NET) */}
            <div className="flex items-center gap-6 md:pr-8 md:border-r border-slate-800">
                <div className="text-center">
                    <div className="text-2xl font-bold text-white">{camp.stats.total_tasks}</div>
                    <div className="text-[10px] text-slate-500 uppercase tracking-wider">Tasques</div>
                </div>
                <div className="text-center">
                    <div className="text-2xl font-bold text-blue-400">{camp.stats.total_results}</div>
                    <div className="text-[10px] text-slate-500 uppercase tracking-wider">Reports</div>
                </div>
            </div>

            {/* Accions */}
            <div className="flex gap-2 w-full md:w-auto">
                <Link href={`/admin/tests/${camp.id}`} className="w-full md:w-auto">
                    <Button variant="outline" className="w-full border-slate-700 text-slate-300 hover:text-white hover:bg-slate-800">
                        Gestionar <ExternalLink className="w-4 h-4 ml-2" />
                    </Button>
                </Link>
            </div>

          </div>
        ))}

        {campaigns.length === 0 && (
            <div className="text-center py-20 text-slate-600 bg-slate-900/50 rounded-xl border border-dashed border-slate-800">
                No hi ha campanyes actives. Crea la primera!
            </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/tests/[id]/page.tsx ===================

import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { requireAdmin } from '@/lib/auth/admin-guard';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { TesterManager } from '@/features/tests/ui/TesterManager';
import { VisualFlowBuilder } from '@/features/tests/ui/VisualFlowBuilder';
import { CampaignDetailsForm } from '@/features/tests/ui/CampaignDetailsForm';
import { createClient } from '@/lib/supabase/server';
import { BackButton } from '@/components/ui/back-button';
import { DeleteCampaignButton } from '@/features/tests/ui/DeleteCampaignButton';
import { CampaignAnalytics } from '@/features/tests/ui/CampaignAnalytics';

export default async function AdminTestDetailPage({ params }: { params: Promise<{ id: string }> }) {
  await requireAdmin();
  const { id } = await params;
  const repo = new SupabaseTestRepository();
  const supabase = await createClient();

  const ctx = await repo.getCampaignWithContext(id, 'admin');
  if (!ctx.campaign) return <div className="p-8 text-center text-muted-foreground">Campanya no trobada</div>;

  const { data: project } = await supabase
    .from('projects')
    .select('organization_id')
    .eq('id', ctx.campaign.projectId)
    .single();

  if (!project || !project.organization_id) return <div>Error d'integritat: Projecte sense organitzaciÃ³</div>;

  const [assigned, available] = await Promise.all([
    repo.getAssignedTesters(id),
    repo.getProjectMembersForTest(id, ctx.campaign.projectId, project.organization_id)
  ]);
  const analyticsData = await repo.getCampaignResults(id);

  return (
    <div className="p-6 max-w-6xl mx-auto space-y-8 animate-in fade-in duration-500">

      {/* --- HEADER --- */}
      <div className="flex flex-col gap-6">
        <div className="flex justify-between items-start">
          <BackButton projectId={ctx.campaign.projectId} />
          <DeleteCampaignButton
            campaignId={ctx.campaign.id}
            projectId={ctx.campaign.projectId}
          />
        </div>

        <div className="flex flex-col md:flex-row justify-between items-end gap-4 border-b border-border pb-6">
          <div>
            <div className="flex items-center gap-3 mb-2">
               <h1 className="text-3xl md:text-4xl font-bold text-foreground tracking-tight">
                 {ctx.campaign.title}
               </h1>
               <span className="px-2 py-0.5 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-300 text-xs font-mono font-bold border border-purple-200 dark:border-purple-800">
                 {ctx.campaign.status}
               </span>
            </div>
            <p className="text-muted-foreground text-lg">GestiÃ³ integral i resultats de la prova</p>
          </div>
          
          <div className="flex items-center gap-2 text-xs font-mono text-muted-foreground bg-muted/50 px-3 py-1.5 rounded-md border border-border">
            <span>ID:</span>
            <span className="font-bold text-foreground">{ctx.campaign.id.split('-')[0]}...</span>
          </div>
        </div>
      </div>

      {/* --- TABS --- */}
      <Tabs defaultValue="results" className="w-full space-y-6">
        <TabsList className="grid w-full grid-cols-4 bg-muted/50 p-1 rounded-xl border border-border">
          <TabsTrigger value="results" className="rounded-lg data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm transition-all">ğŸ“Š Resultats</TabsTrigger>
          <TabsTrigger value="details" className="rounded-lg data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm transition-all">ğŸ“ Detalls</TabsTrigger>
          <TabsTrigger value="tasks" className="rounded-lg data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm transition-all">âœ… Checklist</TabsTrigger>
          <TabsTrigger value="team" className="rounded-lg data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm transition-all">ğŸ‘¥ Equip</TabsTrigger>
        </TabsList>

        <TabsContent value="results" className="focus-visible:outline-none">
          <CampaignAnalytics data={analyticsData} />
        </TabsContent>

        <TabsContent value="details" className="focus-visible:outline-none">
          <CampaignDetailsForm campaign={ctx.campaign} />
        </TabsContent>

        <TabsContent value="tasks" className="focus-visible:outline-none">
          <VisualFlowBuilder campaignId={id} tasks={ctx.tasks} />
        </TabsContent>

        <TabsContent value="team" className="focus-visible:outline-none">
          <Card className="bg-card border-border shadow-sm">
            <CardHeader className="border-b border-border bg-muted/30">
                <CardTitle className="text-foreground">Assignar Usuaris</CardTitle>
            </CardHeader>
            <CardContent className="p-6">
              <TesterManager
                campaignId={id}
                assignedTesters={assigned}
                availableTesters={available}
              />
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/users/page.tsx ===================

import { getAdminUsersList } from '@/app/actions/get-users';
import { Mail, Download, User, Calendar, ShieldCheck, UserCheck, UserPlus } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { UserDeleteButton } from '@/components/admin/UserDeleteButton';


export default async function AdminUsersPage() {
  const users = await getAdminUsersList();

  return (
    <div className="p-6 max-w-7xl mx-auto">
      {/* CAPÃ‡ALERA */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-bold text-foreground tracking-tight">Usuaris</h1>
          <p className="text-muted-foreground text-sm">
            Base de dades de la teva organitzaciÃ³ ({users.length} perfils)
          </p>
        </div>
        <Button variant="outline" className="border-border bg-card hover:bg-muted text-foreground gap-2">
          <Download className="w-4 h-4" />
          Exportar CSV
        </Button>
      </div>



      {/* TAULA CARD */}
      <div className="border border-border rounded-xl overflow-hidden bg-card shadow-sm">
        <div className="overflow-x-auto">
          <table className="w-full text-sm text-left">
            {/* HEAD */}
            <thead className="bg-muted/50 text-muted-foreground border-b border-border text-xs uppercase tracking-wider font-semibold">
              <tr>
                <th className="px-4 py-3 pl-6">Usuari</th>
                <th className="px-4 py-3">Rol & Estat</th>
                <th className="px-4 py-3">Registre</th>
                <th className="px-4 py-3 text-right pr-6">Accions</th>
              </tr>
            </thead>

            {/* BODY */}
            <tbody className="divide-y divide-border">
              {users.map((user) => (
                <tr
                  // âœ… FIX CLAU: Combinem ID i Org ID per fer-la Ãºnica
                  // Si un usuari estÃ  a 2 organitzacions teves, sortirÃ  2 cops, perÃ² la clau serÃ  diferent.
                  key={`${user.id}_${user.organization_id}`}
                  className="hover:bg-muted/30 transition-colors group"
                >

                  {/* COLUMNA 1: IDENTITAT */}
                  <td className="px-4 py-3 pl-6">
                    <div className="flex items-center gap-3">
                      <div className="w-9 h-9 rounded-full bg-primary/10 border border-primary/20 flex items-center justify-center text-primary font-bold text-sm shrink-0">
                        {user.full_name ? user.full_name.charAt(0).toUpperCase() : <User className="w-4 h-4" />}
                      </div>
                      <div className="flex flex-col">
                        <span className="font-semibold text-foreground leading-none mb-1">
                          {user.full_name || 'Sense nom'}
                        </span>
                        <span className="text-xs text-muted-foreground font-mono">
                          {user.email}
                        </span>
                        {/* Opcional: Mostrar ID de l'organitzaciÃ³ petita si en tens moltes */}
                        {/* <span className="text-[10px] text-muted-foreground/50 font-mono">{user.organization_id.slice(0,8)}...</span> */}
                      </div>
                    </div>
                  </td>

                  {/* COLUMNA 2: ROL */}
                  <td className="px-4 py-3">
                    <RoleBadge role={user.role} />
                  </td>

                  {/* COLUMNA 3: DATA */}
                  <td className="px-4 py-3 text-muted-foreground">
                    {user.created_at ? (
                      <div className="flex items-center gap-2 text-xs">
                        <Calendar className="w-3.5 h-3.5 opacity-70" />
                        <div className="flex flex-col">
                          <span className="font-medium text-foreground">
                            {new Date(user.created_at).toLocaleDateString('ca-ES', { day: '2-digit', month: 'short', year: '2-digit' })}
                          </span>
                          <span className="text-[10px] opacity-70">
                            {new Date(user.created_at).toLocaleTimeString('ca-ES', { hour: '2-digit', minute: '2-digit' })}
                          </span>
                        </div>
                      </div>
                    ) : (
                      <span className="text-muted-foreground">-</span>
                    )}
                  </td>
                  {/* COLUMNA 4: ACCIONS */}
                  <td className="px-4 py-3 text-right pr-6">
                    <div className="flex items-center justify-end gap-2">
                      {/* BotÃ³ Email existent */}
                      <a
                        href={`mailto:${user.email}`}
                        className="inline-flex items-center justify-center w-8 h-8 rounded-lg text-muted-foreground hover:text-primary hover:bg-primary/10 transition-all"
                        title="Enviar correu"
                      >
                        <Mail className="w-4 h-4" />
                      </a>

                      {/* NOU BotÃ³ Eliminar */}
                      {/* Passem l'ID per eliminar */}
                      <UserDeleteButton userId={user.id} />
                    </div>
                  </td>
                </tr>
              ))}

              {users.length === 0 && (
                <tr>
                  <td colSpan={4} className="px-6 py-12 text-center text-muted-foreground">
                    <div className="flex flex-col items-center gap-2">
                      <User className="w-8 h-8 opacity-20" />
                      <span>No s'han trobat usuaris per a les teves organitzacions.</span>
                    </div>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// Helper component per als Badges de Rol
function RoleBadge({ role }: { role: string }) {
  const styles = {
    admin: "bg-purple-500/10 text-purple-600 dark:text-purple-400 border-purple-500/20",
    client: "bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20",
    lead: "bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-500/20",
    staff: "bg-orange-500/10 text-orange-600 dark:text-orange-400 border-orange-500/20",
    unknown: "bg-slate-500/10 text-slate-600 dark:text-slate-400 border-slate-500/20"
  };

  const icons = {
    admin: ShieldCheck,
    client: UserCheck,
    lead: UserPlus,
    staff: User,
    unknown: User
  };

  const normalizedRole = (role || 'unknown').toLowerCase() as keyof typeof styles;
  const styleClass = styles[normalizedRole] || styles.unknown;
  const Icon = icons[normalizedRole] || icons.unknown;

  return (
    <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-bold border ${styleClass}`}>
      <Icon className="w-3 h-3" />
      {normalizedRole.toUpperCase()}
    </span>
  );
}

// =================== FILE: src/app/[locale]/auth/callback/route.ts ===================

import { NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { SupabaseProfileRepository } from '@/repositories/supabase/SupabaseProfileRepository';

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url);
  const code = searchParams.get('code');
  const next = searchParams.get('next') ?? '/dashboard';
  
  // Assegura't de tenir l'ID de l'organitzaciÃ³ disponible
  const MAIN_ORG_ID = process.env.NEXT_PUBLIC_MAIN_ORG_ID;

  if (code) {
    const supabase = await createClient();
    
    // 1. Intercanviem el codi per la sessiÃ³ (Auth Global)
    const { error } = await supabase.auth.exchangeCodeForSession(code);
    
    if (!error) {
      // âœ… NOVA LÃ’GICA: AUTO-JOIN PER A OAUTH (GOOGLE)
      if (MAIN_ORG_ID) {
        try {
          // A. Recuperem l'usuari que acaba d'entrar
          const { data: { user } } = await supabase.auth.getUser();

          if (user && user.email) {
            const profileRepo = new SupabaseProfileRepository();
            
            // B. Comprovem si tÃ© perfil en aquesta Org
            const existingProfile = await profileRepo.findByEmailAndOrg(user.email, MAIN_ORG_ID);

            if (!existingProfile) {
              console.log(`âš ï¸ OAuth Login: Usuari ${user.email} sense perfil. Creant vincle automÃ tic...`);
              
              // C. Creem el perfil automÃ ticament
              // Google sol tenir el nom a user_metadata.full_name o .name
              const fullName = user.user_metadata.full_name || user.user_metadata.name || user.email.split('@')[0];
              
              await profileRepo.createProfile(user.id, user.email, MAIN_ORG_ID, fullName);
            }
          }
        } catch (profileError) {
          console.error("âŒ Error en Auto-Join OAuth:", profileError);
          // Opcional: PodrÃ­em redirigir a error, perÃ² millor deixar que entri i que el middleware o dashboard gestionin l'error si falta el perfil.
        }
      }

      // RedirecciÃ³ final
      return NextResponse.redirect(`${origin}/ca${next}`);
    }
  }

  // Error en l'intercanvi de codi
  return NextResponse.redirect(`${origin}/ca/auth/login?error=auth-code-error`);
}

// =================== FILE: src/app/[locale]/auth/forgot-password/page.tsx ===================

import { getTranslations } from 'next-intl/server';
import { Link } from '@/routing';
import { ForgotPasswordForm } from '@/features/auth/ui/ForgotPasswordForm';

export default async function ForgotPasswordPage() {
  const t = await getTranslations('AuthPages.forgot_password');

  return (
    <div className="flex min-h-screen items-center justify-center bg-muted/20 px-4 py-12">
      <div className="w-full max-w-md space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-bold tracking-tight">{t('title')}</h1>
          <p className="mt-2 text-sm text-muted-foreground">
            {t('subtitle')}
          </p>
        </div>

        <ForgotPasswordForm />

        <div className="text-center text-sm">
          <Link href="/auth/login" className="font-medium text-primary hover:underline">
            â† {t('back_login')}
          </Link>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/auth/login/page.tsx ===================

import { LoginForm } from '@/features/auth/ui/LoginForm';
import { Sparkles } from 'lucide-react';
import Link from 'next/link';
// ğŸ‘‡ CANVI IMPORTANT: Importem des de 'next-intl/server'
import { getTranslations } from 'next-intl/server'; 

type Props = {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
  params: Promise<{ locale: string }>; // Afegim params per consistÃ¨ncia
};

export default async function LoginPage({ searchParams }: Props) {
  // ğŸ‘‡ CORRECCIÃ“: Usem await getTranslations() en lloc de useTranslations()
  const t = await getTranslations('AuthPages.login');
  
  // Resolem la promesa dels parÃ metres
  const params = await searchParams;
  
  // Extraiem l'email de forma segura
  const emailParam = typeof params.email === 'string' ? params.email : undefined;

  return (
    <div className="min-h-screen w-full grid lg:grid-cols-2 bg-background overflow-hidden">
      
      {/* COLUMNA ESQUERRA (Visual / Marketing) */}
      <div className="hidden lg:flex relative flex-col justify-between p-12 bg-[#0f111a] border-r border-white/5">
         {/* Fons animat */}
         <div className="absolute inset-0 bg-[radial-gradient(circle_at_top_left,var(--tw-gradient-stops))] from-primary/20 via-background to-background opacity-50"></div>
         <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-10"></div> 
         
         {/* Logo */}
         <div className="relative z-10">
           <Link href="/" className="flex items-center gap-2 text-2xl font-bold text-white">
               DigitAI <span className="gradient-text">Studios</span>
            </Link>
         </div>

         {/* Text inspirador */}
         <div className="relative z-10 max-w-lg">
            <div className="mb-6 inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold">
               <Sparkles className="w-3 h-3" />
               DIGITAL INTELLIGENCE
            </div>
            <h2 className="text-4xl font-bold text-white mb-4 leading-tight">
               {t('marketing_title')}
            </h2>
            <p className="text-slate-400 text-lg">
               {t('marketing_subtitle')}
            </p>
         </div>

         {/* Footer petit */}
         <div className="relative z-10 text-sm text-slate-600">
            {t('footer')}
         </div>
      </div>

      {/* COLUMNA DRETA (Formulari) */}
      <div className="flex items-center justify-center p-8 relative">
         <Link href="/" className="absolute top-8 right-8 text-sm text-muted-foreground hover:text-foreground lg:hidden">
            {t('back_home')}
         </Link>

         {/* Passem l'email extret al component Client */}
         <LoginForm prefilledEmail={emailParam} />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/auth/register/page.tsx ===================

import { RegisterForm } from '@/features/auth/ui/RegisterForm';
import { Link } from '@/routing'; 
import { Sparkles, ArrowLeft } from 'lucide-react';
import { getTranslations } from 'next-intl/server';

type Props = {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
};

export default async function RegisterPage({ searchParams }: Props) {
  // 1. Obtenim les dades
  const params = await searchParams;
  const emailParam = typeof params.email === 'string' ? params.email : '';

  // 2. Traduccions
  const t = await getTranslations('AuthPages.register');

  return (
    <div className="min-h-screen w-full grid lg:grid-cols-2 bg-background overflow-hidden">
      
      {/* COLUMNA ESQUERRA */}
      <div className="hidden lg:flex relative flex-col justify-between p-12 bg-[#0f111a] border-r border-white/5">
         <div className="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,var(--tw-gradient-stops))] from-primary/20 via-background to-background opacity-50"></div>
         <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-10"></div>
         
         {/* Logo */}
         <div className="relative z-10">
            <Link href="/" className="flex items-center gap-2 text-2xl font-bold text-white no-underline">
               DigitAI <span className="gradient-text">Studios</span>
            </Link>
         </div>

         {/* Missatge de valor */}
         <div className="relative z-10 max-w-lg">
            <div className="mb-6 inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold">
               <Sparkles className="w-3 h-3" />
               {t('marketing_badge')}
            </div>
            <h2 className="text-4xl font-bold text-white mb-4 leading-tight">
               {t('marketing_title')}
            </h2>
            <div className="space-y-4 mt-8">
                <div className="flex items-center gap-4 text-slate-400">
                    <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white font-bold">1</div>
                    <p>{t('feature_1')}</p>
                </div>
                <div className="flex items-center gap-4 text-slate-400">
                    <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white font-bold">2</div>
                    <p>{t('feature_2')}</p>
                </div>
                <div className="flex items-center gap-4 text-slate-400">
                    <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white font-bold">3</div>
                    <p>{t('feature_3')}</p>
                </div>
            </div>
         </div>

         {/* Footer petit */}
         <div className="relative z-10 text-sm text-slate-600">
            Â© {new Date().getFullYear()} DigitAI Studios.
         </div>
      </div>

      {/* COLUMNA DRETA */}
      <div className="flex items-center justify-center p-8 relative">
         <Link href="/" className="absolute top-8 left-8 text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 lg:hidden">
            <ArrowLeft className="w-4 h-4" /> {t('back_home')}
         </Link>

         <RegisterForm prefilledEmail={emailParam} />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/auth/reset-password/page.tsx ===================

import { redirect } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';
import { getTranslations, getLocale } from 'next-intl/server';
import { ResetPasswordForm } from '@/features/auth/ui/ResetPasswordForm';

export default async function ResetPasswordPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  const t = await getTranslations('AuthPages.reset_password');
  const locale = await getLocale();

  // Si l'usuari no tÃ© sessiÃ³, vol dir que l'enllaÃ§ ha caducat o Ã©s invÃ lid.
  if (!user) {
    redirect(`/${locale}/auth/forgot-password`); 
  }

  return (
    <div className="flex min-h-screen items-center justify-center bg-muted/20 px-4 py-12">
      <div className="w-full max-w-md space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-bold tracking-tight">{t('title')}</h1>
          <p className="mt-2 text-sm text-muted-foreground">
            {t('subtitle')}
          </p>
        </div>

        <ResetPasswordForm />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/audits/page.tsx ===================

import { getTranslations, getLocale } from 'next-intl/server';
import { Link } from '@/routing';
import { redirect } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Plus, Globe, Calendar, ArrowRight, Activity } from 'lucide-react';
import { createClient } from '@/lib/supabase/server'; 
import { auditRepository } from '@/services/container';

export default async function AuditsListPage() {
  const t = await getTranslations('AuditList'); // Namespace AuditList
  const locale = await getLocale();
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();

  if (!user || !user.email) {
    redirect(`/${locale}/auth/login`); 
  }

  const audits = await auditRepository.getAuditsByUserEmail(user.email);

  // Helper per traduir estats dins del component server
  const getStatusLabel = (status: string) => {
      if (status === 'completed') return t('status.completed');
      if (status === 'failed') return t('status.failed');
      return t('status.processing');
  };

  return (
    <div className="space-y-8">
      
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-6 border-b border-border">
        <div>
          <h1 className="text-3xl font-bold text-foreground">{t('title')}</h1>
          <p className="text-muted-foreground mt-1">
            {t('subtitle')}
          </p>
        </div>
        <Link href="/dashboard/new-audit">
          <Button className="gradient-bg text-white border-0 shadow-lg shadow-primary/20 hover:opacity-90 transition-opacity">
            <Plus className="w-4 h-4 mr-2" /> {t('new_audit_button')}
          </Button>
        </Link>
      </div>

      {/* Grid */}
      <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {audits.map((audit) => (
          <Link key={audit.id} href={`/dashboard/audits/${audit.id}`} className="block group h-full">
            <div className="bg-card border border-border rounded-xl p-6 h-full hover:border-primary/50 transition-all duration-300 shadow-sm hover:shadow-md hover:-translate-y-1 relative overflow-hidden flex flex-col">
              
              {/* CapÃ§alera Targeta */}
              <div className="flex justify-between items-start mb-6">
                 <div className="p-3 bg-primary/10 rounded-lg text-primary border border-primary/20 group-hover:bg-primary/20 transition-colors">
                    <Globe className="w-6 h-6" />
                 </div>
                 <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide border ${
                   audit.status === 'completed' 
                     ? 'bg-green-500/10 text-green-500 border-green-500/20' 
                     : audit.status === 'failed'
                     ? 'bg-red-500/10 text-red-500 border-red-500/20'
                     : 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20'
                 }`}>
                    {getStatusLabel(audit.status)}
                 </span>
              </div>

              {/* Cos Targeta */}
              <div className="mb-6 grow">
                 <h3 className="text-lg font-bold text-foreground truncate mb-2" title={audit.url}>
                    {audit.url.replace(/^https?:\/\//, '').replace(/\/$/, '')}
                 </h3>
                 <div className="flex items-center gap-2 text-xs text-muted-foreground">
                    <Calendar className="w-3 h-3" />
                    {new Intl.DateTimeFormat(locale, { dateStyle: 'medium' }).format(audit.createdAt)}
                 </div>
              </div>

              {/* Peu Targeta */}
              {audit.status === 'completed' && (
                 <div className="grid grid-cols-2 gap-3 mt-auto pt-4 border-t border-border">
                    <div className="flex flex-col">
                       <span className="text-[10px] text-muted-foreground uppercase font-bold mb-1">SEO</span>
                       <div className="flex items-center gap-1.5">
                          <Activity className="w-3 h-3 text-muted-foreground" />
                          <span className={`text-lg font-bold ${getScoreColor(audit.seoScore || 0)}`}>
                             {audit.seoScore || '-'}
                          </span>
                       </div>
                    </div>
                    <div className="flex flex-col border-l border-border pl-3">
                       <span className="text-[10px] text-muted-foreground uppercase font-bold mb-1">{t('performance')}</span>
                       <div className="flex items-center gap-1.5">
                          <Activity className="w-3 h-3 text-muted-foreground" />
                          <span className={`text-lg font-bold ${getScoreColor(audit.performanceScore || 0)}`}>
                             {audit.performanceScore || '-'}
                          </span>
                       </div>
                    </div>
                 </div>
              )}

              {/* Fletxa Hover */}
              <div className="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
                 <ArrowRight className="w-5 h-5 text-primary" />
              </div>
            </div>
          </Link>
        ))}

        {/* Estat Buit */}
        {audits.length === 0 && (
          <div className="col-span-full py-16 flex flex-col items-center justify-center text-center border-2 border-dashed border-border rounded-2xl bg-card/30">
            <div className="w-16 h-16 bg-muted/50 rounded-full flex items-center justify-center mb-4">
               <Globe className="w-8 h-8 text-muted-foreground" />
            </div>
            <h3 className="text-lg font-medium text-foreground mb-2">{t('empty_title')}</h3>
            <p className="text-muted-foreground mb-6 max-w-sm">
              {t('empty_description')}
            </p>
            <Link href="/dashboard/new-audit">
               <Button variant="outline" className="border-border hover:bg-muted text-foreground">
                  {t('create_first_audit')}
               </Button>
            </Link>
          </div>
        )}
      </div>
    </div>
  );
}

function getScoreColor(score: number) {
   if (score >= 90) return 'text-green-500';
   if (score >= 50) return 'text-yellow-500';
   return 'text-red-500';
}

// =================== FILE: src/app/[locale]/dashboard/audits/[id]/page.tsx ===================

import { notFound } from 'next/navigation';
import { auditRepository } from '@/services/container';
import { AuditHeader } from '@/features/audit/ui/components/AuditHeader';
import { ScoreGrid } from '@/features/audit/ui/components/ScoreGrid';
import { CoreVitalsGrid, AuditMetric } from '@/features/audit/ui/components/CoreVitalsGrid';
import { IssuesList } from '@/features/audit/ui/components/IssuesList';
import { MobilePreview } from '@/features/audit/ui/components/MobilePreviw';
import { AuditIssue } from '@/adapters/IWebScanner';
import { getTranslations } from 'next-intl/server'; // Importem el hook de servidor
import { BusinessOpportunities } from '@/features/audit/ui/components/BusinessOpportunities'; // ğŸ‘ˆ IMPORT NOU
import { BusinessSuggestion } from '@/types/ai'; // ğŸ‘ˆ IMPORT NOU
type LighthouseAudit = {
  id: string;
  title: string;
  description: string;
  score: number | null;
  displayValue?: string;
  numericValue?: number;
  details?: unknown;
};

interface GoogleRawData {
  lighthouseResult?: { audits: Record<string, LighthouseAudit> };
  audits?: Record<string, LighthouseAudit>;
  issues?: AuditIssue[];
  screenshot?: string;
  suggestions?: BusinessSuggestion[]; // ğŸ‘ˆ AFEGIT (Pot venir dins reportData segons com ho guardis)
}

type Props = {
  params: Promise<{ id: string; locale: string }>;
};

export default async function AuditDetailsPage({ params }: Props) {
  const { id } = await params;
  const t = await getTranslations('AuditDetails'); // Namespace AuditDetails
  const audit = await auditRepository.getAuditById(id);

  if (!audit) notFound();

  if (audit.status === 'processing') {
    return <div className="p-12 text-center text-foreground">{t('processing_message')}</div>;
  }

  // 1. Recuperar dades
  const rawData = audit.reportData as unknown as GoogleRawData;
  const googleAudits = rawData?.lighthouseResult?.audits || rawData?.audits || {};
  // ğŸ‘‡ RECUPEREM ELS SUGGERIMENTS (assegurem array buit si no n'hi ha)
  // Nota: Si a l'AuditService vas guardar 'suggestions' al nivell arrel de JSON, ajusta-ho aquÃ­.
  // Assumim que estÃ  dins reportData per simplicitat del tipus rawData.
  const suggestions: BusinessSuggestion[] = rawData?.suggestions || [];
  // 2. Helper
  const extract = (key: string): AuditMetric => {
    const a = googleAudits[key];
    if (!a) return { score: null, value: 'N/A', description: '' };
    return {
      score: a.score,
      value: a.displayValue || (a.numericValue ? a.numericValue.toFixed(2) : 'N/A'),
      description: a.title
    };
  };

  // 3. MÃ¨triques
  const metrics = {
    fcp: extract('first-contentful-paint'),
    lcp: extract('largest-contentful-paint'),
    cls: extract('cumulative-layout-shift'),
    tbt: extract('total-blocking-time'),
    si: extract('speed-index')
  };

  // 4. Issues
  let displayIssues: AuditIssue[] = rawData?.issues || [];

  if (displayIssues.length === 0 && Object.keys(googleAudits).length > 0) {
    displayIssues = Object.entries(googleAudits)
      .filter(([, a]) => {
        const score = a.score ?? 1;
        return score < 0.9 && a.score !== null;
      })
      .map(([key, a]) => ({
        id: key, // IMPORTANT: Passem l'ID per traduir
        title: a.title || 'Problema detectat',
        description: a.description || '',
        score: a.score ?? 0,
        displayValue: a.displayValue,
        impact: (a.score === 0 ? 'high' : 'medium'),
        type: (a.score === 0 ? "error" : "warning") as "error" | "warning"
      }))
      .sort((a, b) => (a.score || 0) - (b.score || 0))
      .slice(0, 8);
  }

  // 5. Captura
  type ScreenshotDetails = { data?: string };
  const screenshotData =
    rawData?.screenshot ||
    (googleAudits['final-screenshot']?.details as ScreenshotDetails)?.data ||
    '';

  const seoScore = audit.seoScore ?? 0;
  const perfScore = audit.performanceScore ?? 0;

  return (
    <div className="space-y-10 pb-20 max-w-7xl mx-auto">

      <AuditHeader
        url={audit.url}
        date={new Date(audit.createdAt)}
        pdfData={{
          url: audit.url,
          date: new Date(audit.createdAt).toLocaleDateString(),
          scores: { seo: seoScore, perf: perfScore, a11y: 85, best: 92 },
          screenshot: screenshotData,
          issues: displayIssues
        }}
      />

      <ScoreGrid seo={seoScore} perf={perfScore} />
      {/* ğŸ‘‡ AFEGIM EL COMPONENT D'OPORTUNITATS AQUÃ (DESTACAT) */}
      <div className="animate-in fade-in slide-in-from-bottom-4 duration-700 delay-300">
        <BusinessOpportunities suggestions={suggestions} />
      </div>
      <div className="grid lg:grid-cols-3 gap-8 lg:gap-12">
        <div className="lg:col-span-2 space-y-10">
          <CoreVitalsGrid metrics={metrics} />
          <IssuesList issues={displayIssues} />
        </div>

        <div className="lg:col-span-1">
          <div className="sticky top-8">
            <MobilePreview screenshot={screenshotData} />
          </div>
        </div>
      </div>

    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/layout.tsx ===================

import { Sidebar } from '@/components/dashboard/Sidebar';
import { MobileBottomBar } from './MobilBottomBar';
import { DashboardHeader } from '@/components/dashboard/DashboardHeader';
import { createClient } from '@/lib/supabase/server';
import { redirect } from '@/routing';

type Props = {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
};

export default async function DashboardLayout({ children, params }: Props) {
  const supabase = await createClient();
  const { data: { user }, error } = await supabase.auth.getUser();
  const { locale } = await params;

  if (error || !user) {
    redirect({ href: '/auth/login', locale });
  }

  // ğŸ‘‡ CORRECCIÃ“: NO usem .single() perquÃ¨ pot tenir mÃºltiples perfils
  const { data: profiles } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user!.id);

  // Busquem si en ALGUN dels seus perfils Ã©s admin
  // TambÃ© pots afegir el "Super Admin Override" per email per seguretat extra
  const isAdmin = profiles?.some(p => p.role === 'admin') || user!.email === process.env.ADMIN_EMAIL;
  
  const userRole = isAdmin ? 'admin' : 'client';

  // (Opcional) Deixem un log net per confirmar que ara funciona
  console.log(`âœ… Rol calculat per ${user!.email}: ${userRole} (Perfils trobats: ${profiles?.length})`);

  return (
    <div className="min-h-screen bg-muted/10 flex font-sans text-foreground">
      
      {/* SIDEBAR */}
      <div className="hidden md:block w-64 shrink-0 z-40">
         <Sidebar userRole={userRole} />
      </div>

      {/* AREA PRINCIPAL */}
      <div className="flex-1 flex flex-col min-h-screen relative overflow-hidden">
         <div className="absolute top-0 left-0 w-full h-[500px] bg-primary/5 blur-[150px] pointer-events-none"></div>

         <DashboardHeader userEmail={user?.email ?? ''} />
         
         <main className="flex-1 p-4 md:p-8 overflow-y-auto relative z-10 pb-24 md:pb-8">
            {children}
         </main>

         <div className="md:hidden">
            <MobileBottomBar userRole={userRole} />
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/MobilBottomBar.tsx ===================

'use client';

import { usePathname } from 'next/navigation';
import { Link } from '@/routing'; 
import { 
  LayoutDashboard, 
  FileText, 
  FolderKanban, 
  ShieldAlert, 
  Home
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { useTranslations } from 'next-intl';
import { LogoutButton } from '@/components/dashboard/LogoutButton'; // âœ… IMPORTAT

interface MobileBottomBarProps {
  userRole: 'admin' | 'client' | 'lead';
}

export function MobileBottomBar({ userRole }: MobileBottomBarProps) {
  const t = useTranslations('Dashboard.mobile_nav');
  const pathname = usePathname();
  // router no cal si utilitzem Link i el LogoutButton intern
  
  // Neteja del path per saber on som
  const cleanPath = pathname.replace(/^\/[a-z]{2}/, '') || '/';

  const MENU_ITEMS = [
    { icon: LayoutDashboard, label: t('summary'), href: '/dashboard' },
    { icon: FileText, label: t('audits'), href: '/dashboard/audits' }, 
    { icon: FolderKanban, label: t('projects'), href: '/dashboard/projects' },
  ];

  const handleClick = (e: React.MouseEvent, href: string, label: string) => {
    if (href.startsWith('#')) {
      e.preventDefault();
      alert(`${label} ${t('coming_soon')}`); 
    }
  };

  return (
    <>
      {/* --- BARRA INFERIOR --- */}
      <div className="fixed bottom-0 left-0 w-full z-40 bg-background/95 backdrop-blur-xl border-t border-border pb-safe transition-colors duration-300 md:hidden">
          <div className="flex justify-around items-center h-16 px-2">
              
              {/* 1. ELEMENTS DEL DASHBOARD */}
              {MENU_ITEMS.map((item) => {
                  const Icon = item.icon;
                  let isActive = false;
                  
                  if (!item.href.startsWith('#')) {
                     if (item.href === '/dashboard') {
                        isActive = cleanPath === '/dashboard';
                     } else {
                        isActive = cleanPath.startsWith(item.href);
                     }
                  }

                  return (
                      <Link 
                          key={item.label} 
                          href={item.href}
                          onClick={(e) => handleClick(e, item.href, item.label)}
                          className={cn(
                              "flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform",
                              isActive 
                                  ? "text-primary" 
                                  : "text-muted-foreground hover:text-foreground"
                          )}
                      >
                          <Icon 
                              className={cn("w-5 h-5 transition-all", isActive && "fill-current/20 scale-110")} 
                              strokeWidth={isActive ? 2.5 : 2} 
                          />
                          <span className={cn("text-[10px] font-medium truncate max-w-15", isActive ? "font-bold" : "")}>
                              {item.label}
                          </span>
                      </Link>
                  );
              })}

              {/* 2. ADMIN (Condicional) */}
              {userRole === 'admin' && (
                  <Link 
                      href="/admin"
                      className={cn(
                          "flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform",
                          cleanPath.startsWith('/admin') ? "text-purple-500" : "text-muted-foreground hover:text-purple-500"
                      )}
                  >
                      <ShieldAlert className="w-5 h-5" strokeWidth={2} />
                      <span className="text-[10px] font-medium font-mono text-purple-500/80">ADMIN</span>
                  </Link>
              )}

              {/* SEPARADOR VERTICAL PETIT */}
              <div className="h-8 w-px bg-border/50 mx-1"></div>

              {/* 3. HOME (WEB PÃšBLICA)  */}
              <Link
                  href="/"
                  className="flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform text-muted-foreground hover:text-foreground"
              >
                  <Home className="w-5 h-5" strokeWidth={2} />
                  <span className="text-[10px] font-medium">{t('web')}</span>
              </Link>

              {/* 4. BOTÃ“ LOGOUT (REUTILITZAT) */}
              {/* Passem minimal={true} i les classes per alinear-ho com els altres items */}
              <LogoutButton 
                minimal={true} 
                className="flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform text-red-400 hover:text-red-500"
              />

          </div>
      </div>
    </>
  );
}

// =================== FILE: src/app/[locale]/dashboard/new-audit/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { getLocale, getTranslations } from 'next-intl/server'; // Importem getTranslations
import { CreateAuditForm } from '@/features/audit/ui/components/CreateAuditForm';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

export default async function NewAuditPage() {
  const supabase = await createClient();
  const locale = await getLocale();
  const t = await getTranslations('NewAudit'); // Namespace NewAudit
  
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect(`/${locale}/auth/login`);
  }

  return (
    <div className="max-w-2xl mx-auto py-8 px-4">
      
      <Link 
        href="/dashboard/audits" 
        className="flex items-center text-sm text-muted-foreground hover:text-foreground mb-8 transition-colors w-fit"
      >
         <ArrowLeft className="w-4 h-4 mr-2" /> {t('back_to_list')}
      </Link>

      <div className="bg-card border border-border rounded-2xl p-8 md:p-12 shadow-2xl relative overflow-hidden">
         
         <div className="absolute top-0 right-0 w-64 h-64 bg-primary/10 blur-[80px] rounded-full pointer-events-none"></div>

         <div className="relative z-10">
            <h1 className="text-3xl font-bold text-foreground mb-4">{t('title')}</h1>
            <p className="text-muted-foreground mb-8 leading-relaxed">
               {t('description')}
            </p>

            <CreateAuditForm  />
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/page.tsx ===================

import { getTranslations } from 'next-intl/server';
import { redirect } from 'next/navigation';
import { Link } from '@/routing';
import { createClient } from '@/lib/supabase/server';
import { auditRepository } from '@/services/container';
import { Activity, BarChart3, Clock, Plus } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { AuditCard } from '@/components/dashboard/AuditCard';

export default async function DashboardPage() {
    const supabase = await createClient();
    // Use the namespace we created
    const t = await getTranslations('DashboardHome'); 
    
    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) {
        redirect('/');
    }

    const audits = await auditRepository.getAuditsByUserEmail(user.email);
    const totalAudits = audits.length;
    const validSeoScores = audits
        .filter(a => a.seoScore !== null && a.seoScore !== undefined)
        .map(a => a.seoScore as number);
    const avgSeo = validSeoScores.length > 0
        ? Math.round(validSeoScores.reduce((a, b) => a + b, 0) / validSeoScores.length)
        : 0;

    return (
        <div className="space-y-8 pb-24 md:pb-8"> 

            {/* HEADER */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 pb-6 border-b border-border">
                <div>
                    <h1 className="text-2xl md:text-3xl font-bold text-foreground">
                        {t('welcome', { name: user.email.split('@')[0] })}
                    </h1>
                    <p className="text-muted-foreground mt-1 text-sm md:text-base">{t('subtitle')}</p>
                </div>
                <Link href="/dashboard/new-audit" className="w-full md:w-auto">
                    <Button className="w-full md:w-auto gradient-bg text-white border-0 shadow-lg shadow-primary/20 hover:opacity-90">
                         <Plus className="w-4 h-4 mr-2" /> {t('new_audit')}
                    </Button>
                </Link>
            </div>

            {/* KPI CARDS */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                <KpiCard
                    label={t('kpi_audits')}
                    value={totalAudits.toString()}
                    icon={Activity}
                    color="text-blue-600 dark:text-blue-400"
                    bg="bg-blue-100 dark:bg-blue-500/10"
                />
                <KpiCard
                    label={t('kpi_seo')}
                    value={avgSeo > 0 ? `${avgSeo}/100` : '-'}
                    icon={BarChart3}
                    color="text-green-600 dark:text-green-400"
                    bg="bg-green-100 dark:bg-green-500/10"
                />
                <KpiCard
                    label={t('kpi_system')}
                    value={t('system_status')}
                    icon={Clock}
                    color="text-purple-600 dark:text-purple-400"
                    bg="bg-purple-100 dark:bg-purple-500/10"
                />
            </div>

            {/* LLISTAT AUDITORIA */}
            {audits.length > 0 ? (
                <div>
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold text-foreground">{t('recent_projects')}</h2>
                        <Link href="/dashboard/audits" className="text-sm text-primary hover:underline font-medium">
                           {t('view_all')}
                        </Link>
                    </div>

                    <div className="grid gap-4 md:gap-6 md:grid-cols-2 lg:grid-cols-3">
                        {audits.slice(0, 6).map((audit) => (
                            <AuditCard key={audit.id} audit={audit} />
                        ))}
                    </div>
                </div>
            ) : (
                /* EMPTY STATE */
                <div className="py-12 flex flex-col items-center justify-center text-center border-2 border-dashed border-border rounded-2xl bg-card/50">
                    <div className="w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4">
                        <Activity className="w-8 h-8 text-muted-foreground" />
                    </div>
                    <h3 className="text-lg font-bold text-foreground mb-2">{t('empty_title')}</h3>
                    <p className="text-muted-foreground mb-6 max-w-sm text-sm">
                        {t('empty_desc')}
                    </p>
                    <Link href="/dashboard/new-audit">
                        <Button variant="outline">{t('empty_button')}</Button>
                    </Link>
                </div>
            )}
        </div>
    );
}

// Helpers es mantenen igual...
type KpiCardProps = {
    label: string;
    value: string;
    icon: React.ComponentType<{ className?: string }>;
    color: string;
    bg: string;
};

function KpiCard({ label, value, icon: Icon, color, bg }: KpiCardProps) {
    return (
        <div className="bg-card dark:bg-[#0f111a]/50 border border-border dark:border-white/5 p-4 md:p-6 rounded-xl md:rounded-2xl shadow-sm flex flex-row md:flex-col items-center md:items-start gap-4 md:gap-0 justify-between md:justify-start transition-colors">
            <div className="flex md:block items-center gap-3 md:gap-0 md:w-full md:mb-4">
                <div className={`p-2.5 md:p-3 rounded-lg md:rounded-xl ${bg} shrink-0`}>
                    <Icon className={`w-5 h-5 md:w-6 md:h-6 ${color}`} />
                </div>
                <span className="text-sm text-muted-foreground md:hidden font-medium">{label}</span>
            </div>
            <div className="text-right md:text-left">
                <div className="text-2xl md:text-3xl font-bold text-foreground">{value}</div>
                <div className="text-sm text-muted-foreground hidden md:block font-medium">{label}</div>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/dashboard/projects/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { Link } from '@/routing';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { FolderGit2, FlaskConical, Globe, Clock } from 'lucide-react';
import { redirect } from 'next/navigation';
import { getTranslations, getFormatter } from 'next-intl/server';

export async function generateMetadata({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params;
  const t = await getTranslations({ locale, namespace: 'Dashboard.projects' });
  return { title: `${t('meta_title')} | DigitAI Studios` };
}

export default async function ProjectsListPage() {
  const supabase = await createClient();
  const t = await getTranslations('Dashboard.projects');
  const format = await getFormatter();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/auth/login');

  // 1. Busquem IDs on Ã©s membre
  const { data: memberships } = await supabase
    .from('project_members')
    .select('project_id')
    .eq('user_id', user.id);

  const memberProjectIds = memberships?.map(m => m.project_id) || [];

  // 2. Busquem projectes
  const { data: projects } = await supabase
    .from('projects')
    .select(`*, test_campaigns(count)`)
    .or(`client_id.eq.${user.id},id.in.(${memberProjectIds.join(',') || '00000000-0000-0000-0000-000000000000'})`)
    .order('created_at', { ascending: false });

  return (
    <div className="space-y-8 p-6 md:p-8">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-foreground flex items-center gap-3">
            <FolderGit2 className="w-8 h-8 text-primary" /> {t('title')}
          </h1>
          <p className="text-muted-foreground mt-1">
            {t('subtitle')}
          </p>
        </div>
      </div>

      {!projects || projects.length === 0 ? (
        <div className="py-20 text-center border-2 border-dashed border-border rounded-2xl bg-muted/10">
          <FolderGit2 className="w-16 h-16 mx-auto text-muted-foreground mb-4 opacity-50" />
          <h3 className="text-xl font-medium text-foreground">{t('empty_title')}</h3>
          <p className="text-muted-foreground mt-2 mb-6">{t('empty_desc')}</p>
          <Link href="/#contacte">
            <Button>{t('btn_request')}</Button>
          </Link>
        </div>
      ) : (
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {projects.map((project) => {
            const hasActiveTests = project.test_campaigns?.[0]?.count > 0;

            return (
              <Link key={project.id} href={`/dashboard/projects/${project.id}`} className="group block h-full">
                <Card className="h-full border-border hover:border-primary/50 transition-all duration-300 hover:shadow-lg hover:-translate-y-1 relative overflow-hidden">

                  {hasActiveTests && (
                    <div className="absolute top-0 right-0 bg-purple-600 text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl shadow-sm z-10 flex items-center gap-1">
                      <FlaskConical className="w-3 h-3" /> {t('badge_beta')}
                    </div>
                  )}

                  <CardHeader className="pb-4">
                    <div className="flex justify-between items-start mb-2">
                      <div className={`p-2.5 rounded-lg ${hasActiveTests ? 'bg-purple-100 dark:bg-purple-900/20 text-purple-600' : 'bg-blue-100 dark:bg-blue-900/20 text-blue-600'}`}>
                        <FolderGit2 className="w-6 h-6" />
                      </div>
                    </div>
                    <CardTitle className="text-xl font-bold group-hover:text-primary transition-colors">
                      {project.name}
                    </CardTitle>
                    <div className="flex items-center gap-2 text-xs text-muted-foreground font-mono mt-1">
                      <Globe className="w-3 h-3" /> {project.domain || t('status_configuring')}
                    </div>
                  </CardHeader>

                  <CardContent>
                    <div className="flex items-center justify-between mt-4 pt-4 border-t border-border">
                      <span className={`px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider 
                            ${project.status === 'active' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' :
                          project.status === 'maintenance' ? 'bg-orange-100 text-orange-700' :
                            'bg-slate-100 text-slate-600'}
                        `}>
                        {project.status || t('status_pending')}
                      </span>

                      <span className="text-xs text-muted-foreground flex items-center gap-1">
                        <Clock className="w-3 h-3" />
                        {/* Format de data segur per a SSR/CSR */}
                        {format.dateTime(new Date(project.created_at ?? new Date().toISOString()), { year: 'numeric', month: 'short', day: 'numeric' })}                      </span>
                    </div>
                  </CardContent>
                </Card>
              </Link>
            );
          })}
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/projects/[id]/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { notFound, redirect } from 'next/navigation';
import { Layout, ArrowRight, Target, FlaskConical, Trophy } from 'lucide-react';
import { GamificationService } from '@/services/GamificationService';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { MissionCard } from '@/features/tests/ui/MissionCard';
import { Progress } from '@/components/ui/progress';
import { getTranslations } from 'next-intl/server';

type Props = {
    params: Promise<{ id: string }>
}

// Map d'emojis (podries moure aixÃ² a configuraciÃ³ o DB en el futur)
const RANK_EMOJIS: Record<string, string> = {
    'Novell': 'ğŸ£',
    'Bug Hunter': 'ğŸ›',
    'Expert': 'ğŸ•µï¸',
    'Mestre': 'ğŸ‘‘',
};

export default async function ProjectDetailPage({ params }: Props) {
    const { id } = await params;
    const t = await getTranslations('Dashboard.project_detail');
    const supabase = await createClient();

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) redirect('/auth/login');

    const gameService = new GamificationService();
    const testRepo = new SupabaseTestRepository();

    const [projectRes, stats, missions] = await Promise.all([
        supabase.from('projects').select('name, domain, repository_url').eq('id', id).single(),
        gameService.getUserStats(user.id),
        testRepo.getActiveMissionsForUser(user.id, id)
    ]);

    const project = projectRes.data;
    if (!project) return notFound();

    const currentEmoji = RANK_EMOJIS[stats.rankName] || 'ğŸŒ±';

    return (
        <div className="min-h-screen bg-slate-50/50 dark:bg-slate-950/50 pb-20 p-6 md:p-10">
            <div className="max-w-6xl mx-auto space-y-8">

                {/* 1. HEADER GAMIFICAT */}
                <div className="bg-linear-to-r from-indigo-900 to-purple-900 rounded-2xl p-8 text-white shadow-2xl relative overflow-hidden">
                    <div className="absolute top-0 right-0 opacity-10">
                        <Trophy className="w-64 h-64 -rotate-12 transform translate-x-10 -translate-y-10" />
                    </div>

                    <div className="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                        <div>
                            <div className="flex items-center gap-4 mb-2">
                                <div className="">
                                    <span className="text-6xl filter drop-shadow-md">
                                        {currentEmoji}
                                    </span>
                                </div>
                                
                                <div>
                                    <h1 className="text-2xl font-bold">{stats.rankName}</h1>
                                    <p className="text-purple-200 text-sm">{t('level_label')} {stats.level}</p>
                                </div>
                            </div>
                            
                            <div className="max-w-md mt-4">
                                <div className="flex justify-between text-xs mb-1 uppercase font-bold tracking-wider opacity-70">
                                    <span>{t('xp_label')}: {stats.xp}</span>
                                    <span>{t('next_label')}: {stats.nextLevelXp}</span>
                                </div>
                                <Progress value={stats.progressToNext} className="h-3 bg-black/30" />
                            </div>
                        </div>

                        <div className="bg-white/10 backdrop-blur-md p-4 rounded-xl border border-white/20 min-w-50">
                            <div className="flex items-center gap-2 text-purple-200 text-xs mb-1 uppercase tracking-wider font-bold">
                                <Layout className="w-3 h-3" /> {t('current_project_label')}
                            </div>
                            <div className="text-xl font-bold text-white mb-1">{project.name}</div>
                            {project.domain && (
                                <a href={`https://${project.domain}`} target="_blank" className="text-xs text-purple-300 hover:text-white hover:underline flex items-center gap-1">
                                    {project.domain} <ArrowRight className="w-3 h-3" />
                                </a>
                            )}
                        </div>
                    </div>
                </div>

                {/* 2. LLISTA DE MISSIONS */}
                <div>
                    <h2 className="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800 dark:text-white">
                        <Target className="w-5 h-5 text-red-500" /> {t('missions_title')}
                    </h2>

                    {missions.length === 0 ? (
                        <div className="text-center py-24 bg-white dark:bg-slate-900 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700">
                            <FlaskConical className="w-16 h-16 mx-auto text-slate-300 mb-4" />
                            <h3 className="text-xl font-bold text-slate-700 dark:text-slate-200">{t('empty_missions_title')}</h3>
                            <p className="text-slate-500 max-w-md mx-auto mt-2">
                                {t('empty_missions_desc')}
                            </p>
                        </div>
                    ) : (
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {missions.map((mission) => (
                                <MissionCard
                                    key={mission.id}
                                    id={mission.id}
                                    projectId={id}
                                    title={mission.title}
                                    description={mission.description}
                                    stats={mission.stats}
                                />
                            ))}
                        </div>
                    )}
                </div>

            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/dashboard/projects/[id]/[testId]/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { notFound, redirect } from 'next/navigation';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { TaskRunner } from '@/features/tests/ui/TaskRunner';
import { BackButton } from '@/components/ui/back-button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { BookOpen, CheckCircle2, Trophy } from 'lucide-react';
import { getTranslations } from 'next-intl/server';

type Props = {
  params: Promise<{ id: string; testId: string }>;
};

export default async function TestRunnerPage({ params }: Props) {
  const { id: projectId, testId } = await params;
  const t = await getTranslations('Dashboard.test_runner');
  
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/auth/login');

  const repo = new SupabaseTestRepository();
  const ctx = await repo.getCampaignWithContext(testId, user.id);

  if (!ctx.campaign) return notFound();
  if (ctx.campaign.projectId !== projectId) return notFound();

  const totalTasks = ctx.tasks.length;
  const completedTasks = ctx.results.filter(r => r.status === 'pass').length;
  const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

  // LÃ²gica de selecciÃ³ de clau de traducciÃ³
  let motivationKey = 'motivation_start';
  if (progress > 0) motivationKey = 'motivation_early';
  if (progress > 50) motivationKey = 'motivation_late';
  if (progress === 100) motivationKey = 'motivation_done';

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 pb-20">
      
      {/* HEADER IMMERSIU */}
      <div className="bg-slate-900 border-b border-slate-800 sticky top-0 z-10 shadow-lg">
        <div className="max-w-6xl mx-auto px-4 py-4">
            
            <div className="flex items-center justify-between mb-4">
                <BackButton projectId={projectId} />
                <Badge variant="outline" className="text-purple-400 border-purple-500/50">
                    {t('badge_mode')}
                </Badge>
            </div>

            <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                <div>
                    <h1 className="text-2xl font-bold text-white mb-1 flex items-center gap-2">
                        {ctx.campaign.title}
                    </h1>
                    <p className="text-slate-400 text-sm flex items-center gap-2">
                        {t(motivationKey)}
                    </p>
                </div>

                {/* BARRA DE PROGRÃ‰S */}
                <div className="w-full md:w-1/3">
                    <div className="flex justify-between text-xs text-slate-400 mb-1 font-bold uppercase">
                        <span>{t('label_progress')}</span>
                        <span className={progress === 100 ? "text-green-400" : "text-white"}>{progress}%</span>
                    </div>
                    <div className="h-3 w-full bg-slate-800 rounded-full overflow-hidden border border-slate-700">
                        <div 
                            className={`h-full transition-all duration-1000 ease-out ${progress === 100 ? 'bg-green-500' : 'bg-purple-600'}`}
                            style={{ width: `${progress}%` }} 
                        />
                    </div>
                </div>
            </div>
        </div>
      </div>

      {/* CONTINGUT PRINCIPAL */}
      <div className="max-w-6xl mx-auto px-4 py-8 grid lg:grid-cols-12 gap-8">
        
        {/* COLUMNA ESQUERRA: Guia */}
        <div className="lg:col-span-5 space-y-6">
            <div className="lg:sticky lg:top-36 space-y-6">
                <Card className="border-l-4 border-l-blue-500 shadow-sm">
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2 text-lg">
                            <BookOpen className="w-5 h-5 text-blue-500" /> {t('card_instructions')}
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="prose prose-sm dark:prose-invert max-w-none">
                        {ctx.campaign.instructions ? (
                            <div className="whitespace-pre-wrap font-sans text-slate-600 dark:text-slate-300">
                                {ctx.campaign.instructions}
                            </div>
                        ) : (
                            <p className="italic text-slate-400">{t('no_instructions')}</p>
                        )}
                    </CardContent>
                </Card>

                {progress === 100 && (
                    <div className="bg-green-500/10 border border-green-500/20 p-6 rounded-xl text-center animate-in zoom-in">
                        <Trophy className="w-12 h-12 text-green-500 mx-auto mb-2" />
                        <h3 className="text-lg font-bold text-green-600 dark:text-green-400">{t('success_title')}</h3>
                        <p className="text-sm text-green-700 dark:text-green-300">{t('success_msg')}</p>
                    </div>
                )}
            </div>
        </div>

        {/* COLUMNA DRETA: Tasques */}
        <div className="lg:col-span-7 space-y-4">
            <h2 className="text-lg font-bold flex items-center gap-2 mb-4">
                <CheckCircle2 className="w-5 h-5 text-slate-400" />
                {t('checklist_title')} ({completedTasks}/{totalTasks})
            </h2>

            {ctx.tasks.map((task) => {
                const result = ctx.results.find(r => r.taskId === task.id);
                return (
                    <TaskRunner 
                        key={task.id}
                        task={task}
                        existingResult={result}
                    />
                );
            })}
        </div>

      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/tests/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { GamificationService } from '@/services/GamificationService';
import { Link } from '@/routing';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Trophy, Target, Zap } from 'lucide-react';
import { getTranslations } from 'next-intl/server';

export default async function TesterDashboard() {
    const t = await getTranslations('Dashboard.tester_dashboard');
    const supabase = await createClient();
    
    const { data: { user } } = await supabase.auth.getUser();
    if(!user) return <div>{t('error_no_user')}</div>;

    const repo = new SupabaseTestRepository();
    const gameService = new GamificationService();

    // ParalÂ·lelitzem les dades
    const [assignments, stats] = await Promise.all([
        repo.getMyAssignments(user.id),
        gameService.getUserStats(user.id)
    ]);

    // LÃ²gica segura per separar emoji i nom (si el format Ã©s "Nom Emoji" o "Nom")
    const rankParts = stats.rankName.split(' ');
    const rankEmoji = rankParts.length > 1 ? rankParts[rankParts.length - 1] : 'ğŸŒŸ';
    const rankTitle = rankParts.length > 1 ? rankParts.slice(0, -1).join(' ') : stats.rankName;

    return (
        <div className="p-6 space-y-8">
            
            {/* 1. HEADER GAMIFICAT */}
            <div className="bg-linear-to-r from-indigo-900 to-purple-900 rounded-2xl p-8 text-white shadow-2xl relative overflow-hidden">
                <div className="absolute top-0 right-0 opacity-10">
                    <Trophy className="w-64 h-64 -rotate-12 transform translate-x-10 -translate-y-10" />
                </div>
                
                <div className="relative z-10">
                    <div className="flex items-center gap-4 mb-2">
                        <span className="text-4xl">{rankEmoji}</span>
                        <div>
                            <h1 className="text-2xl font-bold">{rankTitle}</h1>
                            <p className="text-purple-200 text-sm">
                                {t('level_label', { level: stats.level })}
                            </p>
                        </div>
                    </div>

                    <div className="max-w-md mt-4">
                        <div className="flex justify-between text-xs mb-1 uppercase font-bold tracking-wider opacity-70">
                            <span>{t('xp_label')}: {stats.xp}</span>
                            <span>{t('next_level_label')}: {stats.nextLevelXp}</span>
                        </div>
                        <Progress value={stats.progressToNext} className="h-3 bg-black/30" />
                        <p className="text-xs mt-2 text-purple-300">
                            {t('motivation_text')}
                        </p>
                    </div>
                </div>
            </div>

            {/* 2. GRID DE MISSIONS */}
            <div>
                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                    <Target className="w-5 h-5 text-red-500" /> {t('active_missions_title')}
                </h2>

                {assignments.length === 0 ? (
                    <div className="text-center py-12 border-2 border-dashed rounded-xl">
                        <p className="text-slate-500">{t('empty_state_title')}</p>
                        <p className="text-xs text-slate-400">{t('empty_state_desc')}</p>
                    </div>
                ) : (
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {assignments.map(mission => (
                            <Link key={mission.assignmentId} href={`/dashboard/projects/${mission.campaignId}`} className="group block">
                                <Card className="h-full hover:border-purple-500 transition-all hover:shadow-lg hover:-translate-y-1 bg-white dark:bg-slate-900">
                                    <CardHeader>
                                        <div className="flex justify-between items-start">
                                            <span className="text-xs font-mono text-purple-500 bg-purple-500/10 px-2 py-1 rounded">
                                                {mission.projectName}
                                            </span>
                                        </div>
                                        <CardTitle className="mt-2 group-hover:text-purple-600 transition-colors">
                                            {mission.title}
                                        </CardTitle>
                                    </CardHeader>
                                    <CardContent>
                                        <p className="text-sm text-slate-500 line-clamp-2 mb-4">
                                            {mission.description || t('no_description')}
                                        </p>
                                        <div className="flex items-center gap-2 text-xs font-bold text-slate-400">
                                            <Zap className="w-3 h-3 text-yellow-500" />
                                            {t('tasks_count', { count: mission.totalTasks })}
                                        </div>
                                    </CardContent>
                                </Card>
                            </Link>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/layout.tsx ===================

import { NextIntlClientProvider } from 'next-intl';
import { getMessages } from 'next-intl/server';
import { notFound } from 'next/navigation';
import { routing, type Locale } from '@/routing';
import { Inter } from 'next/font/google';
import { ThemeProvider } from "@/components/theme-provider";
import "@/app/globals.css";
import type { Metadata, Viewport } from 'next';
import { Toaster } from 'sonner';
import { Suspense } from 'react';
import { AnalyticsTracker } from '@/features/analytics/ui/AnalyticsTracker';

const inter = Inter({
  subsets: ['latin'],
  variable: '--font-inter',
  display: 'swap',
});

// 1. CONFIGURACIÃ“ DEL VIEWPORT (EstÃ tica)
export const viewport: Viewport = {
  themeColor: [
    { media: '(prefers-color-scheme: light)', color: 'white' },
    { media: '(prefers-color-scheme: dark)', color: '#020817' },
  ],
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
};

// 2. METADADES DINÃ€MIQUES (SEO + Hreflang + Canonical)
export async function generateMetadata({
  params
}: {
  params: Promise<{ locale: string }>;
}): Promise<Metadata> {
  const { locale } = await params;
  
  // Defineix la URL base (Hardcoded com a fallback segur per evitar localhost en producciÃ³)
  const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://digitaistudios.com';

  return {
    metadataBase: new URL(baseUrl),
    title: {
      default: 'DigitAI Studios | Desenvolupament Web & IA',
      template: '%s | DigitAI Studios'
    },
    description: 'Transformem negocis amb AppWebs, Apps Natives i AutomatitzaciÃ³ IA. Solucions digitals 360Â°.',
    keywords: ['Desenvolupament Web', 'App', 'React Native', 'Next.js', 'IA', 'AutomatitzaciÃ³', 'Girona'],
    authors: [{ name: 'DigitAI Studios' }],
    creator: 'DigitAI Studios',
    manifest: '/manifest.webmanifest',
    icons: {
      icon: '/icons/icon-192.png',
      shortcut: '/icons/icon-192.png',
      apple: '/icons/apple-icon.png',
      other: {
        rel: 'apple-touch-icon-precomposed',
        url: '/icons/apple-icon.png',
      },
    },
    openGraph: {
      type: 'website',
      locale: locale === 'ca' ? 'ca_ES' : locale === 'es' ? 'es_ES' : 'en_US',
      url: `${baseUrl}/${locale}`,
      title: 'DigitAI Studios | InnovaciÃ³ Digital',
      description: 'Apps, Webs i AutomatitzaciÃ³ IA per a empreses modernes.',
      siteName: 'DigitAI Studios',
      images: [
        {
          url: '/images/og-image.jpg',
          width: 1200,
          height: 630,
          alt: 'DigitAI Studios Cover',
        },
      ],
    },
    // ğŸ‘‡ AQUESTA Ã‰S LA CLAU PER ARREGLAR GSC i IDIOMES:
    alternates: {
      canonical: `${baseUrl}/${locale}`,
      languages: {
        'ca': `${baseUrl}/ca`,
        'es': `${baseUrl}/es`,
        'en': `${baseUrl}/en`,
        // 'x-default': `${baseUrl}/ca` // Opcional: Si vols forÃ§ar el catalÃ  com a default
      },
    },
  };
}

// 3. LAYOUT PRINCIPAL
export default async function LocaleLayout({
  children,
  params
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;

  // ValidaciÃ³ de seguretat de l'idioma
  if (!routing.locales.includes(locale as Locale)) {
    notFound();
  }

  const messages = await getMessages();

  return (
    <html lang={locale} className={inter.variable} suppressHydrationWarning>
      <body className="antialiased bg-background text-foreground overflow-x-hidden transition-colors duration-300">
        <NextIntlClientProvider messages={messages}>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            {/* AnalÃ­tica sense bloquejar la cÃ rrega */}
            <Suspense fallback={null}>
              <AnalyticsTracker />
            </Suspense>

            {/* Notificacions Toast */}
            <Toaster richColors closeButton />

            {children}
          </ThemeProvider>
        </NextIntlClientProvider>
      </body>
    </html>
  );
}

// =================== FILE: src/components/admin/AdminSidebar.tsx ===================

// src/components/admin/AdminSidebar.tsx
'use client';

import { Link, usePathname } from '@/routing';
import { cn } from '@/lib/utils';
import { ThemeToggle } from '@/components/ui/theme-toggle'; // ğŸ‘ˆ Importem el Toggle
import {
  ShieldAlert,
  BarChart3,
  Users,
  BookOpenCheck,
  FlaskConical,
  Home,
  Briefcase,
  Settings,
  Inbox
} from 'lucide-react';

export function AdminSidebar() {
  const pathname = usePathname();

  const NAV_ITEMS = [
    { label: 'AnalÃ­tiques', href: '/admin/analytics', icon: BarChart3 },
    { label: 'Usuaris', href: '/admin/users', icon: Users },
    { label: 'Projectes', href: '/admin/projects', icon: Briefcase },
    { label: 'QA / Tests', href: '/admin/tests', icon: FlaskConical },
    { label: 'Blog', href: '/admin/blog', icon: BookOpenCheck },
    { label: 'ConfiguraciÃ³', href: '/admin/settings', icon: Settings },
    { label: 'Missatges', href: '/admin/missatges', icon: Inbox},
  ];

  return (
    <aside className="hidden md:flex w-64 border-r border-border p-6 flex-col bg-card/50 backdrop-blur-xl h-full sticky top-0">

      {/* CAPÃ‡ALERA */}
      <div className="flex items-center gap-2 font-bold text-foreground mb-10 text-xl px-2">
        <ShieldAlert className="text-primary w-6 h-6" /> {/* Usem primary en lloc de red-500 fix */}
        <span>ADMIN</span>
      </div>

      {/* NAVEGACIÃ“ */}
      <nav className="flex flex-col gap-2 flex-1">
        {NAV_ITEMS.map((item) => {
          const isActive = pathname.startsWith(item.href);

          return (
            <Link
              key={item.href}
              href={item.href}
              className={cn(
                "flex items-center gap-3 px-4 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium",
                isActive
                  ? "bg-primary/10 text-primary border border-primary/10 shadow-sm"
                  : "text-muted-foreground hover:bg-muted hover:text-foreground"
              )}
            >
              <item.icon className={cn("w-5 h-5", isActive ? "text-primary" : "opacity-70")} />
              <span>{item.label}</span>
            </Link>
          );
        })}
      </nav>

      {/* FOOTER AMB TOGGLE I RETORN */}
      <div className="mt-auto pt-6 border-t border-border space-y-4">

        {/* Selector de Tema */}
        <div className="flex items-center justify-between px-2">
          <span className="text-xs font-medium text-muted-foreground">Tema</span>
          <ThemeToggle />
        </div>

        <Link
          href="/"
          className="flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors text-muted-foreground hover:bg-muted hover:text-foreground text-sm"
        >
          <Home className="w-4 h-4 opacity-70" />
          <span>Tornar a la Web</span>
        </Link>
      </div>
    </aside>
  );
}

// =================== FILE: src/components/admin/AminMobileMenu.tsx ===================

'use client';

import { useState, useRef, useEffect } from 'react';
import { Link, usePathname } from '@/routing';
import { 
 
  BarChart3, 
  Users, 
  Home, 
  BookOpenCheck, 
  FlaskConical, 
  Inbox, 
  MoreHorizontal, // Icona per al menÃº "MÃ©s"
  Briefcase // Icona per a Projectes
} from 'lucide-react';
import { cn } from '@/lib/utils';

export function AdminBottomNav() {
  const pathname = usePathname();
  const [isMoreOpen, setIsMoreOpen] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);

  // Tancar el menÃº si cliquem a fora
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
        setIsMoreOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // 1. ITEMS PRINCIPALS (Es veuran sempre a la barra)
  // MÃ xim 4 items + el botÃ³ "MÃ©s"
  const mainLinks = [
    {
      href: '/admin/analytics',
      label: 'MÃ¨triques',
      icon: BarChart3
    },
    {
      href: '/admin/projects', // NOVA SECCIÃ“
      label: 'Projectes',
      icon: Briefcase 
    },
    {
      href: '/admin/users',
      label: 'Usuaris',
      icon: Users
    },
    {
      href: '/admin/tests',
      label: 'Tests',
      icon: FlaskConical
    },
  ];

  // 2. ITEMS SECUNDARIS (Dins del desplegable "MÃ©s")
  const secondaryLinks = [
    {
      href: '/admin/blog',
      label: 'Blog',
      icon: BookOpenCheck
    },
    {
      href: '/admin/missatges',
      label: 'Missatges',
      icon: Inbox
    },
    {
      href: '/', // Tornar a la web pÃºblica
      label: 'Web PÃºblica',
      icon: Home,
      separate: true // Per posar-li un estil diferent si cal
    }
  ];

  // Comprovar si algun item del menÃº "MÃ©s" estÃ  actiu per ilÂ·luminar el botÃ³ "..."
  const isMoreActive = secondaryLinks.some(link => pathname === link.href);

  return (
    <>
      {/* MENU DESPLEGABLE (Tipus Popover) */}
      {isMoreOpen && (
        <div className="md:hidden fixed bottom-20 right-2 z-50 w-48 animate-in slide-in-from-bottom-5 fade-in duration-200">
          <div 
            ref={menuRef}
            className="bg-slate-900/95 backdrop-blur-md border border-slate-800 rounded-xl shadow-2xl overflow-hidden"
          >
            <div className="flex flex-col p-1">
              {secondaryLinks.map((link) => {
                const Icon = link.icon;
                const isActive = pathname === link.href;
                
                return (
                  <Link
                    key={link.href}
                    href={link.href}
                    onClick={() => setIsMoreOpen(false)} // Tanquem en clicar
                    className={cn(
                      "flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors",
                      isActive 
                        ? "bg-blue-500/10 text-blue-400" 
                        : "text-slate-400 hover:bg-slate-800 hover:text-slate-200",
                      link.separate && "border-t border-slate-800 mt-1 pt-3 text-slate-300"
                    )}
                  >
                    <Icon className="w-5 h-5" />
                    {link.label}
                  </Link>
                );
              })}
            </div>
          </div>
        </div>
      )}

      {/* BARRA INFERIOR */}
      <div className="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-slate-950 border-t border-slate-800 pb-safe">
        <nav className="flex items-center justify-around h-16 px-2">
          
          {/* Renderitzem els links principals */}
          {mainLinks.map((link) => {
            const Icon = link.icon;
            const isActive = pathname === link.href;

            return (
              <Link
                key={link.href}
                href={link.href}
                onClick={() => setIsMoreOpen(false)}
                className={cn(
                  "flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors duration-200",
                  isActive
                    ? "text-blue-400"
                    : "text-slate-500 hover:text-slate-300"
                )}
              >
                <Icon className={cn("w-6 h-6", isActive && "fill-current/20")} />
                <span className="text-[10px] font-medium">{link.label}</span>
              </Link>
            );
          })}

          {/* BotÃ³ "MÃ©s" (...) */}
          <button
            onClick={() => setIsMoreOpen(!isMoreOpen)}
            className={cn(
              "flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors duration-200 focus:outline-none",
              (isMoreOpen || isMoreActive)
                ? "text-blue-400"
                : "text-slate-500 hover:text-slate-300"
            )}
          >
            <MoreHorizontal className={cn("w-6 h-6", (isMoreOpen || isMoreActive) && "bg-slate-800 rounded-md")} />
            <span className="text-[10px] font-medium">MÃ©s</span>
          </button>

        </nav>
      </div>
    </>
  );
}

// =================== FILE: src/components/admin/AuditsTable.tsx ===================

'use client';

import { ExternalLink, Calendar, Search, Gauge, User, Activity } from 'lucide-react';
import { AuditSummary } from '@/repositories/interfaces/IAuditRepository';
import { Badge } from '@/components/ui/badge'; // Si tens el component Badge, sinÃ³ fes servir el span d'abans

export function AuditsTable({ audits }: { audits: AuditSummary[] }) {
  
  // 1. FunciÃ³ segura per formatar dates (evita "Invalid Date")
  const formatDate = (dateInput: Date | string) => {
    try {
      const date = new Date(dateInput);
      // Si la data no Ã©s vÃ lida, retornem avui o un text
      if (isNaN(date.getTime())) return 'Data desconeguda';
      
      return date.toLocaleDateString('ca-ES', {
        day: '2-digit', month: 'short', hour: '2-digit', minute:'2-digit'
      });
    } catch (e) {
      return '-';
    }
  };

  // 2. FunciÃ³ per determinar el color (Google Lighthouse colors)
  const getScoreColor = (score: number | null | undefined) => {
    if (score === null || score === undefined) return 'bg-gray-100 text-gray-600 border-gray-200';
    if (score >= 90) return 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-400';
    if (score >= 50) return 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-400';
    return 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-400';
  };

  // 3. Helper per netejar la URL visualment
  const cleanUrl = (url: string) => url.replace(/^https?:\/\//, '').replace(/\/$/, '');

  if (audits.length === 0) {
    return (
      <div className="text-center py-12 bg-muted/20 rounded-xl border border-dashed border-border mt-4">
        <p className="text-muted-foreground">No hi ha auditories realitzades encara.</p>
      </div>
    );
  }

  return (
    <>
      {/* ğŸ“± VERSIÃ“ MÃ’BIL (Cards) - Visible < md */}
      <div className="grid grid-cols-1 gap-4 md:hidden mt-4">
        {audits.map((audit) => (
          <div 
            key={audit.id} 
            className="bg-card border border-border rounded-xl p-5 shadow-sm space-y-4"
          >
            {/* CapÃ§alera Card: URL i Data */}
            <div className="flex justify-between items-start">
              <a 
                href={audit.url} 
                target="_blank" 
                rel="noopener noreferrer" 
                className="font-semibold text-primary truncate pr-2 flex items-center gap-2"
              >
                {cleanUrl(audit.url)}
                <ExternalLink className="w-3 h-3 shrink-0" />
              </a>
              <span className="text-xs text-muted-foreground bg-muted px-2 py-1 rounded-md whitespace-nowrap">
                {formatDate(audit.createdAt)}
              </span>
            </div>

            {/* Usuari */}
            <div className="flex items-center gap-2 text-sm text-muted-foreground">
              <User className="w-4 h-4" />
              <span className="truncate">{audit.email || 'AnÃ²nim'}</span>
            </div>

            {/* Puntuacions (Grid de 2) */}
            <div className="grid grid-cols-2 gap-3 pt-2 border-t border-border/50">
              {/* SEO */}
              <div className="flex flex-col items-center gap-1 p-2 rounded-lg bg-muted/30">
                <span className="text-[10px] font-bold uppercase text-muted-foreground flex items-center gap-1">
                  <Search className="w-3 h-3" /> SEO
                </span>
                <span className={`px-2 py-0.5 rounded-full text-xs font-bold border ${getScoreColor(audit.seoScore)}`}>
                  {audit.seoScore ?? '-'}
                </span>
              </div>

              {/* Performance */}
              <div className="flex flex-col items-center gap-1 p-2 rounded-lg bg-muted/30">
                <span className="text-[10px] font-bold uppercase text-muted-foreground flex items-center gap-1">
                  <Gauge className="w-3 h-3" /> Rendiment
                </span>
                <span className={`px-2 py-0.5 rounded-full text-xs font-bold border ${getScoreColor(audit.performanceScore)}`}>
                  {audit.performanceScore ?? '-'}
                </span>
              </div>
            </div>
            
            {/* Estat (Opcional, si vols mostrar processing/completed) */}
            {audit.status === 'processing' && (
               <div className="text-xs text-center text-blue-500 animate-pulse font-medium">
                  ğŸ”„ Analitzant...
               </div>
            )}
          </div>
        ))}
      </div>

      {/* ğŸ’» VERSIÃ“ ESCRIPTORI (Taula) - Visible >= md */}
      <div className="hidden md:block overflow-x-auto rounded-xl border border-border shadow-sm bg-card mt-4">
        <table className="w-full text-sm text-left">
          <thead className="bg-muted/50 text-muted-foreground uppercase text-xs font-semibold">
            <tr>
              <th className="px-6 py-4">Data</th>
              <th className="px-6 py-4">Web Analitzada</th>
              <th className="px-6 py-4">Usuari</th>
              <th className="px-6 py-4 text-center">SEO</th>
              <th className="px-6 py-4 text-center">Rendiment</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-border">
            {audits.map((audit) => (
              <tr key={audit.id} className="hover:bg-muted/20 transition-colors">
                <td className="px-6 py-4 whitespace-nowrap text-muted-foreground">
                  <div className="flex items-center gap-2">
                     <Calendar className="w-3 h-3" />
                     {formatDate(audit.createdAt)}
                  </div>
                </td>
                
                <td className="px-6 py-4 font-medium">
                  <a href={audit.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-foreground hover:text-primary hover:underline transition-colors">
                    {cleanUrl(audit.url)}
                    <ExternalLink className="w-3 h-3 text-muted-foreground" />
                  </a>
                </td>
                
                <td className="px-6 py-4 text-muted-foreground">
                  {audit.email || 'AnÃ²nim'}
                </td>

                <td className="px-6 py-4 text-center">
                  <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold border ${getScoreColor(audit.seoScore)}`}>
                    <Search className="w-3 h-3 mr-1" />
                    {audit.seoScore ?? '-'}
                  </span>
                </td>

                <td className="px-6 py-4 text-center">
                   <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold border ${getScoreColor(audit.performanceScore)}`}>
                    <Gauge className="w-3 h-3 mr-1" />
                    {audit.performanceScore ?? '-'}
                  </span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </>
  );
}

// =================== FILE: src/components/admin/LeadsTable.tsx ===================

'use client';

import Link from 'next/link';
import { Eye, Calendar, User, Mail, Trash2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { deleteAdminLead } from '@/actions/admin/leads';
import { useTransition, useState } from 'react';
import { useRouter } from 'next/navigation';

// Imports de Shadcn Alert Dialog
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
 
} from "@/components/ui/alert-dialog";

type Lead = {
  id: string;
  created_at: string;
  full_name: string | null;
  email: string;
  service: string | null;
  message: string | null;
  source: string | null;
};

export function LeadsTable({ leads }: { leads: Lead[] }) {
  const [isPending, startTransition] = useTransition();
  const router = useRouter();
  
  // Estat per controlar quin ID estem a punt d'esborrar
  const [leadToDelete, setLeadToDelete] = useState<string | null>(null);

  const handleDeleteConfirm = async () => {
    if (!leadToDelete) return;

    // Tanquem el diÃ leg immediatament per millor UX
    const id = leadToDelete;
    setLeadToDelete(null); 

    startTransition(async () => {
      console.log(`ğŸ—‘ï¸ [CLIENT] Confirmada eliminaciÃ³ ID: ${id}`);
      const res = await deleteAdminLead(id);

      if (res.success) {
        console.log("âœ… [CLIENT] Eliminat amb Ã¨xit. Refrescant...");
        router.refresh(); 
      } else {
        console.error("âŒ [CLIENT] Error:", res.error);
        alert(`Error: ${res.error}`);
      }
    });
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('ca-ES', {
      day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
    });
  };

  if (leads.length === 0) {
    return (
      <div className="text-center py-12 bg-muted/20 rounded-xl border border-dashed border-border">
        <p className="text-muted-foreground">Encara no hi ha missatges de contacte.</p>
      </div>
    );
  }

  return (
    <>
      {/* --- DIÃ€LEG DE CONFIRMACIÃ“ (Global per la taula) --- */}
      <AlertDialog open={!!leadToDelete} onOpenChange={(open) => !open && setLeadToDelete(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>EstÃ s segur?</AlertDialogTitle>
            <AlertDialogDescription>
              Aquesta acciÃ³ eliminarÃ  permanentment el missatge de la base de dades.
              No es pot desfer.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isPending}>CancelÂ·lar</AlertDialogCancel>
            <AlertDialogAction 
              onClick={(e) => {
                e.preventDefault();
                handleDeleteConfirm();
              }}
              className="bg-red-600 hover:bg-red-700 text-white"
              disabled={isPending}
            >
              {isPending ? 'Eliminant...' : 'SÃ­, eliminar'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* ğŸ“± VERSIÃ“ MÃ’BIL (Cards) */}
      <div className="grid grid-cols-1 gap-4 md:hidden">
        {leads.map((lead) => (
          <div key={lead.id} className={`relative bg-card border border-border rounded-xl p-5 shadow-sm transition-opacity ${isPending ? 'opacity-50' : ''}`}>
            {/* BotÃ³ Eliminar MÃ²bil */}
            <button 
              onClick={() => setLeadToDelete(lead.id)}
              disabled={isPending}
              className="absolute top-4 right-4 p-2 text-muted-foreground hover:text-red-500 transition-colors"
            >
              <Trash2 className="w-4 h-4" />
            </button>

            <Link href={`./missatges/${lead.id}`} className="block">
              <div className="flex justify-between items-start mb-3 pr-8">
                <div className="flex items-center gap-2">
                  <User className="w-4 h-4 text-primary" />
                  <span className="font-semibold text-foreground">{lead.full_name || 'AnÃ²nim'}</span>
                </div>
              </div>
              <div className="space-y-2 text-sm text-muted-foreground">
                 {/* ... detalls ... */}
                 <div className="flex items-center gap-2">
                    <Mail className="w-3 h-3" />
                    <span className="truncate">{lead.email}</span>
                 </div>
                 <p className="line-clamp-2 text-xs italic">{lead.message}</p>
              </div>
            </Link>
          </div>
        ))}
      </div>

      {/* ğŸ’» VERSIÃ“ ESCRIPTORI (Taula) */}
      <div className="hidden md:block overflow-hidden rounded-xl border border-border shadow-sm bg-card">
        <table className={`w-full text-sm text-left ${isPending ? 'opacity-70' : ''}`}>
          <thead className="bg-muted/50 text-muted-foreground uppercase text-xs font-semibold">
            <tr>
              <th className="px-6 py-4">Data</th>
              <th className="px-6 py-4">Nom</th>
              <th className="px-6 py-4">Email</th>
              <th className="px-6 py-4">Servei</th>
              <th className="px-6 py-4">Missatge</th>
              <th className="px-6 py-4 text-right">Accions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-border">
            {leads.map((lead) => (
              <tr key={lead.id} className="group hover:bg-muted/30 transition-colors">
                <td className="px-6 py-4 whitespace-nowrap text-muted-foreground">
                  <div className="flex items-center gap-2">
                    <Calendar className="w-3 h-3" />
                    {formatDate(lead.created_at)}
                  </div>
                </td>
                <td className="px-6 py-4 font-medium">{lead.full_name || 'AnÃ²nim'}</td>
                <td className="px-6 py-4">{lead.email}</td>
                <td className="px-6 py-4">
                  <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
                    {lead.service || 'General'}
                  </span>
                </td>
                <td className="px-6 py-4 max-w-xs text-muted-foreground truncate">{lead.message}</td>
                
                {/* ACCIONS */}
                <td className="px-6 py-4 text-right">
                  <div className="flex items-center justify-end gap-2">
                    <Link href={`./missatges/${lead.id}`}>
                      <Button variant="ghost" size="icon" className="h-8 w-8 hover:bg-primary/10">
                        <Eye className="w-4 h-4" />
                      </Button>
                    </Link>
                    
                    {/* BotÃ³ que obre el diÃ leg */}
                    <Button 
                      variant="ghost" 
                      size="icon" 
                      className="h-8 w-8 text-muted-foreground hover:bg-red-100 hover:text-red-600"
                      onClick={() => setLeadToDelete(lead.id)}
                      disabled={isPending}
                    >
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </>
  );
}

// =================== FILE: src/components/admin/posts/PostEditorLayout.tsx ===================

'use client'

import { useState } from 'react';
import { SocialsManager } from '@/components/admin/socials/SocialManager';
import { type Database } from '@/types/database.types';

type Post = Database['public']['Tables']['posts']['Row'];
type SocialPost = Database['public']['Tables']['social_posts']['Row'];

interface PostEditorLayoutProps {
  post: Post;
  socialPosts: SocialPost[];
  children: React.ReactNode; // AquÃ­ hi anirÃ  el formulari d'ediciÃ³ del blog (el que ja tenies)
}

export function PostEditorLayout({ post, socialPosts, children }: PostEditorLayoutProps) {
  const [activeTab, setActiveTab] = useState<'content' | 'social'>('content');

  return (
    <div className="space-y-6">
      {/* CapÃ§alera del Post */}
      <div className="flex justify-between items-center border-b pb-4">
        <div>
            <h1 className="text-2xl font-bold text-gray-900">{post.title}</h1>
            <p className="text-sm text-gray-500">Estat: {post.status}</p>
        </div>
        
        {/* NavegaciÃ³ per Pestanyes */}
        <div className="flex bg-gray-100 p-1 rounded-lg">
            <button
                onClick={() => setActiveTab('content')}
                className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${
                    activeTab === 'content' 
                    ? 'bg-white text-blue-600 shadow-sm' 
                    : 'text-gray-500 hover:text-gray-700'
                }`}
            >
                ğŸ“ Contingut & SEO
            </button>
            <button
                onClick={() => setActiveTab('social')}
                className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${
                    activeTab === 'social' 
                    ? 'bg-white text-purple-600 shadow-sm' 
                    : 'text-gray-500 hover:text-gray-700'
                }`}
            >
                ğŸ¤– IA Social Media
            </button>
        </div>
      </div>

      {/* Contingut de les Pestanyes */}
      <div className="min-h-125">
        {activeTab === 'content' && (
            <div className="animate-in fade-in slide-in-from-bottom-2 duration-300">
                {/* Renderitzem el formulari d'ediciÃ³ normal */}
                {children}
            </div>
        )}

        {activeTab === 'social' && (
            <div className="animate-in fade-in slide-in-from-bottom-2 duration-300">
                <SocialsManager 
                    postId={post.id} 
                    existingPosts={socialPosts} 
                />
            </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/components/admin/posts/PostViewTabs.tsx ===================

'use client';

import { useState } from 'react';
import { SocialsManager } from '@/components/admin/socials/SocialManager';
import { FileText, Share2 } from 'lucide-react';
import { type Database } from '@/types/database.types';
import { cn } from '@/lib/utils';

type SocialPost = Database['public']['Tables']['social_posts']['Row'];

interface PostViewTabsProps {
  postId: string;
  socialPosts: SocialPost[];
  children: React.ReactNode;
}

type TabKey = 'content' | 'social';

export function PostViewTabs({ postId, socialPosts, children }: PostViewTabsProps) {
  const [activeTab, setActiveTab] = useState<TabKey>('content');

  return (
    <div className="space-y-6">
      {/* CONTAINER NAVEGACIÃ“:
        - MÃ²bil: Fons gris suau (muted), padding, cantonades arrodonides.
        - Desktop (sm): Fons transparent, sense padding, vora inferior standard.
      */}
      <div className="sm:border-b sm:border-border">
        <nav 
          className={cn(
            "grid grid-cols-2 p-1 bg-muted rounded-xl gap-1", // Estil MÃ²bil (Segmented Control)
            "sm:flex sm:bg-transparent sm:p-0 sm:gap-8 sm:rounded-none" // Estil Desktop (Tabs clÃ ssics)
          )}
          aria-label="GestiÃ³ de l'article" 
          role="tablist"
        >
          {/* Tab: Contingut */}
          <ResponsiveTabButton
            id="content"
            isActive={activeTab === 'content'}
            onClick={() => setActiveTab('content')}
            icon={<FileText className="w-4 h-4" />}
            label="Contingut"
            desktopLabel="Contingut de l'Article"
          />

          {/* Tab: Social */}
          <ResponsiveTabButton
            id="social"
            isActive={activeTab === 'social'}
            onClick={() => setActiveTab('social')}
            icon={<Share2 className="w-4 h-4" />}
            label="Social IA"
            desktopLabel="DistribuciÃ³ Social (IA)"
            badgeCount={socialPosts.length > 0 ? socialPosts.length : undefined}
            activeColorClass="text-purple-600 sm:border-purple-500"
          />
        </nav>
      </div>

      {/* AREA DE CONTINGUT */}
      <div 
        className="min-h-[500px] animate-in fade-in slide-in-from-bottom-2 duration-300"
        role="tabpanel"
        id={`panel-${activeTab}`}
        aria-labelledby={`tab-${activeTab}`}
      >
        {activeTab === 'content' ? (
          <section aria-label="Editor de contingut">
            {children}
          </section>
        ) : (
          <section aria-label="Gestor de xarxes socials" className="max-w-4xl">
            <SocialsManager postId={postId} existingPosts={socialPosts} />
          </section>
        )}
      </div>
    </div>
  );
}

// ğŸ§© Subcomponent que canvia d'estil radicalment segons la pantalla
interface ResponsiveTabButtonProps {
  id: string;
  isActive: boolean;
  onClick: () => void;
  icon: React.ReactNode;
  label: string; // Text curt per mÃ²bil
  desktopLabel: string; // Text llarg per desktop
  badgeCount?: number;
  activeColorClass?: string;
}

function ResponsiveTabButton({ 
  id,
  isActive, 
  onClick, 
  icon, 
  label, 
  desktopLabel,
  badgeCount, 
  activeColorClass = 'text-primary sm:border-primary' 
}: ResponsiveTabButtonProps) {
  return (
    <button
      id={`tab-${id}`}
      role="tab"
      aria-selected={isActive}
      aria-controls={`panel-${id}`}
      onClick={onClick}
      className={cn(
        // ESTILS BASE (Comuns)
        "flex items-center justify-center gap-2 text-sm font-medium transition-all outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
        
        // ğŸ“± ESTILS MÃ’BIL (Pill / Button shape)
        "rounded-lg py-2.5",
        isActive 
          ? "bg-background text-foreground shadow-sm" // Actiu mÃ²bil: blanc amb ombra
          : "text-muted-foreground hover:bg-background/50 hover:text-foreground", // Inactiu mÃ²bil

        // ğŸ’» ESTILS DESKTOP (Tab shape)
        "sm:rounded-t-md sm:rounded-b-none sm:bg-transparent sm:py-4 sm:shadow-none sm:px-1 sm:border-b-2 sm:border-transparent sm:justify-start",
        isActive 
          ? cn("sm:bg-transparent", activeColorClass) // Actiu desktop: vora de color
          : "sm:hover:border-border sm:hover:text-foreground"
      )}
    >
      {icon}
      
      {/* Text: Mostrem el curt en mÃ²bil, el llarg en desktop */}
      <span className="block sm:hidden">{label}</span>
      <span className="hidden sm:block">{desktopLabel}</span>

      {badgeCount !== undefined && (
        <span className={cn(
          "ml-1.5 rounded-full px-2 py-0.5 text-[10px] font-bold sm:text-xs sm:font-medium",
          isActive 
            ? "bg-primary/10 text-primary" 
            : "bg-muted-foreground/20 text-muted-foreground"
        )}>
          {badgeCount}
        </span>
      )}
    </button>
  );
}

// =================== FILE: src/components/admin/socials/ConnectSocials.tsx ===================

'use client'

import { Button } from '@/components/ui/button';
import { type Database } from '@/types/database.types';

// Assumim que rebrem les connexions existents per mostrar "Connectat" o no
type Connection = Database['public']['Tables']['social_connections']['Row'];

interface ConnectSocialsProps {
  connections: Connection[];
}

export function ConnectSocials({ connections }: ConnectSocialsProps) {
  
  const handleConnect = (provider: 'linkedin' | 'facebook') => {
    // Redirigim a la nostra API d'inici
    window.location.href = `/api/oauth/init?provider=${provider}`;
  };

  const linkedinConnected = connections.find(c => c.provider === 'linkedin');
  const facebookConnected = connections.find(c => c.provider === 'facebook');

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
      
      {/* LINKEDIN CARD */}
      <div className="p-4 border rounded-lg bg-white shadow-sm flex justify-between items-center">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-blue-700 text-white rounded flex items-center justify-center font-bold">
            in
          </div>
          <div>
            <h3 className="font-bold text-sm">LinkedIn</h3>
            <p className="text-xs text-gray-500">
              {linkedinConnected 
                ? `Connectat com: ${linkedinConnected.provider_page_name || 'Usuari'}` 
                : 'No connectat'}
            </p>
          </div>
        </div>
        <Button 
          variant={linkedinConnected ? "outline" : "default"}
          onClick={() => handleConnect('linkedin')}
          disabled={!!linkedinConnected} // Deshabilitem si ja estÃ  connectat (per ara)
        >
          {linkedinConnected ? 'âœ… Connectat' : 'Connectar'}
        </Button>
      </div>

      {/* FACEBOOK CARD */}
      <div className="p-4 border rounded-lg bg-white shadow-sm flex justify-between items-center">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-blue-600 text-white rounded flex items-center justify-center font-bold">
            f
          </div>
          <div>
            <h3 className="font-bold text-sm">Facebook / Instagram</h3>
            <p className="text-xs text-gray-500">
               {facebookConnected 
                ? `PÃ gina: ${facebookConnected.provider_page_name}` 
                : 'No connectat'}
            </p>
          </div>
        </div>
        <Button 
          variant={facebookConnected ? "outline" : "default"}
          onClick={() => handleConnect('facebook')}
          disabled={!!facebookConnected}
        >
           {facebookConnected ? 'âœ… Connectat' : 'Connectar'}
        </Button>
      </div>

    </div>
  );
}

// =================== FILE: src/components/admin/socials/SocialManager.tsx ===================

'use client'

import { useState } from 'react';
import { SocialPostCard } from './SocialPostCard';
import { generateSocialsForPost, updateSocialPostContent } from '@/actions/social-media';
import { type Database } from '@/types/database.types';

type SocialPost = Database['public']['Tables']['social_posts']['Row'];

interface SocialsManagerProps {
    postId: string;
    existingPosts: SocialPost[];
}

export function SocialsManager({ postId, existingPosts }: SocialsManagerProps) {
    const [isGenerating, setIsGenerating] = useState(false);
    const [isSaving, setIsSaving] = useState(false);

    // BotÃ³ per generar si no n'hi ha
    const handleGenerate = async () => {
        setIsGenerating(true);
        try {
            const res = await generateSocialsForPost(postId);
            if (!res.success) alert(res.message);
            // La revalidatePath del server action actualitzarÃ  la vista automÃ ticament
        } catch (e) {
            console.error(e);
            alert("Error inesperat generant socials");
        } finally {
            setIsGenerating(false);
        }
    };

    // FunciÃ³ per guardar edicions (ARA ACCEPTA MEDIA URL)
    const handleUpdate = async (id: string, content: string, mediaUrl?: string) => {
        setIsSaving(true);
        try {
            // Passem el 3r parÃ metre
            await updateSocialPostContent(id, content, mediaUrl);
        } catch (e) {
            console.error(e);
            alert("Error guardant");
        } finally {
            setIsSaving(false);
        }
    };

    if (existingPosts.length === 0) {
        return (
            <div className="p-8 border-2 border-dashed border-gray-300 rounded-lg text-center bg-gray-50">
                <h3 className="text-lg font-medium text-gray-700 mb-2">Aquest post encara no tÃ© contingut social</h3>
                <p className="text-sm text-gray-500 mb-6">Genera automÃ ticament esborranys per a LinkedIn, Facebook i Instagram.</p>
                <button
                    onClick={handleGenerate}
                    disabled={isGenerating}
                    className="bg-indigo-600 text-white px-6 py-3 rounded-lg shadow hover:bg-indigo-700 disabled:opacity-50 transition-all flex items-center gap-2 mx-auto"
                >
                    {isGenerating ? 'âœ¨ La IA estÃ  treballant...' : 'âœ¨ Generar Socials amb IA'}
                </button>
            </div>
        );
    }

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <h2 className="text-xl font-bold text-gray-800">ğŸ“² DistribuciÃ³ Social</h2>
                <button
                    onClick={handleGenerate}
                    className="text-xs text-indigo-600 hover:underline"
                    disabled={isGenerating}
                >
                    {isGenerating ? 'Regenerant...' : 'ğŸ”„ Regenerar de nou'}
                </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                {/* Ordenem per tenir sempre el mateix ordre visual */}
                {existingPosts
                    .sort((a, b) => a.platform.localeCompare(b.platform))
                    .map((post) => (
                        <SocialPostCard
                            key={post.id}
                            post={post}
                            onSave={handleUpdate}
                            isSaving={isSaving}
                        />
                    ))}
            </div>
        </div>
    );
}

// =================== FILE: src/components/admin/socials/SocialPostCard.tsx ===================

'use client'

import { useState, useRef, useEffect } from 'react';
import { type Database } from '@/types/database.types';
import { publishSocialPost, changeSocialStatus } from '@/actions/social-media';
import { createClient } from '@/lib/supabase/client';
import { Loader2, Send, CheckCircle, ImagePlus, X, Save } from 'lucide-react';
import Image from 'next/image';
import { cn } from '@/lib/utils';

type SocialPost = Database['public']['Tables']['social_posts']['Row'];
type PostStatus = 'draft' | 'approved' | 'published' | 'failed';

interface SocialPostCardProps {
  post: SocialPost;
  onSave: (id: string, content: string, mediaUrl?: string) => void;
  isSaving: boolean;
}

// ğŸ¨ ESTILS PREMIUM PER PLATAFORMA
const PLATFORM_THEMES: Record<string, { border: string, bg: string, icon: string, text: string }> = {
  linkedin: { 
    border: 'border-blue-700/20', 
    bg: 'bg-blue-50/30 dark:bg-blue-900/10', 
    text: 'text-blue-700 dark:text-blue-400',
    icon: 'ğŸ‘”' 
  },
  facebook: { 
    border: 'border-blue-600/20', 
    bg: 'bg-indigo-50/30 dark:bg-indigo-900/10', 
    text: 'text-indigo-700 dark:text-indigo-400',
    icon: 'ğŸ“˜' 
  },
  instagram: { 
    border: 'border-pink-500/20', 
    bg: 'bg-pink-50/30 dark:bg-pink-900/10', 
    text: 'text-pink-700 dark:text-pink-400',
    icon: 'ğŸ“¸' 
  }
};

const STATUS_CONFIG: Record<string, string> = {
  draft: 'bg-gray-100 text-gray-600 border-gray-200 dark:bg-zinc-800 dark:text-zinc-400',
  approved: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/40 dark:text-blue-300',
  published: 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/40 dark:text-green-400',
  failed: 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/40 dark:text-red-400',
};

export function SocialPostCard({ post, onSave, isSaving }: SocialPostCardProps) {
  const [content, setContent] = useState(post.content);
  const [mediaUrl, setMediaUrl] = useState<string | null>(post.media_url);
  const [isUploading, setIsUploading] = useState(false);
  const [isPublishing, setIsPublishing] = useState(false);
  const [isDirty, setIsDirty] = useState(false);

  const fileInputRef = useRef<HTMLInputElement>(null);
  const textareaRef = useRef<HTMLTextAreaElement>(null); 
  const supabase = createClient();

  const theme = PLATFORM_THEMES[post.platform] || PLATFORM_THEMES.linkedin;

  // ğŸª„ AUTO-RESIZE: Ajusta l'alÃ§ada del textarea automÃ ticament
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto';
      textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
    }
  }, [content]);

  const deleteImageFromStorage = async (urlToDelete: string) => {
    if (!urlToDelete) return;
    try {
      const urlParts = urlToDelete.split('/social-media/');
      if (urlParts.length > 1) {
        const filePath = urlParts[1];
        await supabase.storage.from('social-media').remove([filePath]);
      }
    } catch (error) {
      console.error("Error esborrant imatge:", error);
    }
  };

  const handleStatusChange = async (e: React.ChangeEvent<HTMLSelectElement>) => {
    const newStatus = e.target.value as PostStatus;
    if (newStatus === 'published') {
      alert("Per passar a Published fes servir el botÃ³ de Publicar.");
      return;
    }
    try {
      await changeSocialStatus(post.id, newStatus);
    } catch (error) {
      console.error(error);
      alert("Error canviant l'estat");
    }
  };

  const handleContentChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setContent(e.target.value);
    setIsDirty(true);
  };

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (mediaUrl) await deleteImageFromStorage(mediaUrl);

    setIsUploading(true);
    try {
      const fileExt = file.name.split('.').pop();
      const fileName = `${post.id}-${Date.now()}.${fileExt}`;
      const { error: uploadError } = await supabase.storage.from('social-media').upload(fileName, file);
      if (uploadError) throw uploadError;

      const { data: { publicUrl } } = supabase.storage.from('social-media').getPublicUrl(fileName);
      setMediaUrl(publicUrl);
      setIsDirty(true);
      onSave(post.id, content, publicUrl);
      setIsDirty(false);
    } catch (error) {
      console.error(error);
      alert('Error pujant imatge');
    } finally {
      setIsUploading(false);
      if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  const handleRemoveImage = async () => {
    if (!mediaUrl || !confirm("Segur que vols eliminar la imatge?")) return;
    await deleteImageFromStorage(mediaUrl);
    setMediaUrl(null);
    setIsDirty(true);
    onSave(post.id, content, '');
    setIsDirty(false);
  };

  const handleSave = () => {
    onSave(post.id, content, mediaUrl || '');
    setIsDirty(false);
  };

  const handlePublish = async () => {
    if (post.platform === 'instagram' && !mediaUrl) {
      alert("âš ï¸ Instagram requereix imatge.");
      return;
    }
    if (!confirm(`Publicar a ${post.platform}?`)) return;

    if (isDirty) await onSave(post.id, content, mediaUrl || '');

    setIsPublishing(true);
    try {
      const res = await publishSocialPost(post.id, mediaUrl || undefined);
      if (res.success) alert("ğŸš€ Publicat!");
      else alert("âŒ " + res.message);
    } catch (e) {
      console.error(e);
      alert("Error inesperat.");
    } finally {
      setIsPublishing(false);
    }
  };

  const isPublished = post.status === 'published';

  return (
    <div className={cn(
      "group relative flex flex-col h-full rounded-2xl shadow-sm hover:shadow-md transition-all duration-300 border bg-white dark:bg-zinc-900/50 overflow-hidden",
      theme.border, theme.bg
    )}>
      
      {/* --- BARRA SUPERIOR (HEADER) --- */}
      <div className="flex items-center justify-between p-4 border-b border-gray-100 dark:border-white/5">
        <div className="flex items-center gap-2.5">
          <div className="text-xl filter drop-shadow-sm transform group-hover:scale-110 transition-transform">
            {theme.icon}
          </div>
          <span className={cn("font-bold text-sm tracking-wide capitalize", theme.text)}>
            {post.platform}
          </span>
        </div>

        {/* Selector d'Estat Estilitzat */}
        <div className="relative z-10">
          <select
            value={post.status}
            onChange={handleStatusChange}
            disabled={isPublishing}
            className={cn(
              "appearance-none pl-3 pr-8 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider cursor-pointer outline-none transition-all hover:brightness-95 shadow-sm border",
              STATUS_CONFIG[post.status]
            )}
          >
            <option value="draft" className="text-gray-900 bg-white">Draft</option>
            <option value="approved" className="text-gray-900 bg-white">Approved</option>
            <option value="published" className="text-gray-900 bg-white">Published</option>
            <option value="failed" className="text-gray-900 bg-white">Failed</option>
          </select>
          
          {/* Fletxeta custom */}
          <div className="absolute right-2.5 top-1/2 -translate-y-1/2 pointer-events-none opacity-60">
            <svg width="8" height="6" viewBox="0 0 8 6" fill="currentColor" className="text-current">
               <path d="M4 6L0 0H8L4 6Z" />
            </svg>
          </div>
        </div>
      </div>

      {/* --- COS DE LA TARGETA --- */}
      <div className="flex-1 p-0 flex flex-col">
        
        {/* Ã€rea MultimÃ¨dia */}
        {mediaUrl && (
          <div className="relative w-full aspect-video bg-black/5 dark:bg-black/40 group/media">
            {mediaUrl.match(/\.(mp4|mov|webm)$/i) ? (
               <video src={mediaUrl} className="w-full h-full object-contain" controls />
            ) : (
              <Image src={mediaUrl} alt="Preview" fill className="object-cover transition-opacity duration-500" />
            )}
            
            {!isPublished && (
              <button
                onClick={handleRemoveImage}
                className="absolute top-2 right-2 p-1.5 bg-black/50 hover:bg-red-500 text-white rounded-full opacity-0 group-hover/media:opacity-100 transition-all backdrop-blur-sm"
                title="Eliminar arxiu"
              >
                <X className="w-4 h-4" />
              </button>
            )}
          </div>
        )}

        {/* Text Area IntelÂ·ligent */}
        <div className="relative flex-1 p-4">
          <textarea
            ref={textareaRef}
            value={content}
            onChange={handleContentChange}
            disabled={isPublished}
            className="w-full h-full min-h-37.5 bg-transparent resize-none outline-none text-sm text-gray-700 dark:text-gray-200 leading-relaxed placeholder-gray-400 font-medium"
            placeholder={`Escriu alguna cosa brillant per a ${post.platform}...`}
            style={{ overflow: 'hidden' }}
          />
          
          {/* Comptador de carÃ cters */}
          <div className="absolute bottom-2 right-4 text-[10px] text-gray-400 font-mono opacity-50 select-none">
            {content.length} chars
          </div>
        </div>
      </div>

      {/* --- FOOTER (ACCIONS) --- */}
      <div className="p-3 bg-white/50 dark:bg-black/20 border-t border-gray-100 dark:border-white/5 flex justify-between items-center backdrop-blur-sm">
        
        {/* Upload Button */}
        {!isPublished ? (
          <div>
            <input
              type="file"
              ref={fileInputRef}
              className="hidden"
              accept="image/*,video/*"
              onChange={handleImageUpload}
            />
            <button
              onClick={() => fileInputRef.current?.click()}
              disabled={isUploading || isSaving}
              className="group flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-semibold text-gray-500 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all"
            >
              {isUploading ? <Loader2 className="w-4 h-4 animate-spin" /> : <ImagePlus className="w-4 h-4 group-hover:scale-110 transition-transform" />}
              <span>{mediaUrl ? 'Canviar' : 'Afegir Media'}</span>
            </button>
          </div>
        ) : (
          <div className="flex items-center gap-1 text-green-600 text-xs font-bold px-2 py-1 bg-green-50 rounded-md">
            <CheckCircle className="w-3.5 h-3.5" /> Publicat
          </div>
        )}

        {/* Action Buttons */}
        <div className="flex items-center gap-2">
          {isDirty && !isPublished && (
            <button
              onClick={handleSave}
              disabled={isSaving}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 dark:bg-zinc-800 dark:text-gray-300 rounded-lg transition-all active:scale-95"
            >
              {isSaving ? <Loader2 className="w-3.5 h-3.5 animate-spin" /> : <Save className="w-3.5 h-3.5" />}
              Guardar
            </button>
          )}

          {!isPublished && (
            <button
              onClick={handlePublish}
              disabled={isPublishing || isSaving}
              className={cn(
                "flex items-center gap-2 px-4 py-1.5 rounded-lg text-xs font-bold text-white shadow-lg shadow-blue-500/20 transition-all active:scale-95",
                isPublishing 
                  ? "bg-gray-400 cursor-not-allowed" 
                  : "bg-linear-to-r from-gray-900 to-black hover:from-gray-800 hover:to-gray-900 dark:from-white dark:to-gray-200 dark:text-black"
              )}
            >
              {isPublishing ? (
                <><Loader2 className="w-3.5 h-3.5 animate-spin" /> Publicant...</>
              ) : (
                <><Send className="w-3.5 h-3.5" /> Publicar</>
              )}
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/components/admin/UserDeleteButton.tsx ===================

'use client';

import { useState, useTransition } from 'react';
import { Trash2, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { deleteUserFromOrg } from '@/app/actions/delete-user';

export function UserDeleteButton({ userId }: { userId: string }) {
  const [isPending, startTransition] = useTransition();
  const [showConfirm, setShowConfirm] = useState(false);

  const handleDelete = async () => {
    startTransition(async () => {
      const result = await deleteUserFromOrg(userId);
      if (!result.success) {
        alert(result.message); // O usa un toast si en tens
      }
      setShowConfirm(false);
    });
  };

  if (showConfirm) {
    return (
      <div className="flex items-center gap-2 animate-in fade-in slide-in-from-right-5 duration-200">
        <span className="text-xs text-red-500 font-medium hidden sm:inline">Segur?</span>
        <Button 
          size="sm" 
          variant="destructive" 
          onClick={handleDelete}
          disabled={isPending}
          className="h-8 px-3"
        >
          {isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : 'Si, esborra'}
        </Button>
        <Button 
          size="sm" 
          variant="ghost" 
          onClick={() => setShowConfirm(false)}
          disabled={isPending}
          className="h-8 w-8 p-0"
        >
          âœ•
        </Button>
      </div>
    );
  }

  return (
    <Button
      variant="ghost"
      size="icon"
      className="h-8 w-8 text-muted-foreground hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"
      onClick={() => setShowConfirm(true)}
      title="Eliminar de l'organitzaciÃ³"
    >
      <Trash2 className="w-4 h-4" />
    </Button>
  );
}

// =================== FILE: src/components/animations/Reveal.tsx ===================

// src/components/animations/Reveal.tsx
'use client';

import { motion, useInView, useAnimation, useReducedMotion } from 'framer-motion';
import { useRef, useEffect } from 'react';

interface RevealProps {
  children: React.ReactNode;
  width?: 'fit-content' | '100%';
  delay?: number;
  duration?: number;
  direction?: 'up' | 'down' | 'left' | 'right' | 'none';
  className?: string;
  // Nova prop per desactivar desplaÃ§ament en mÃ²bil si va molt carregat
  disableMobileMovement?: boolean; 
}

export const Reveal = ({ 
  children, 
  width = 'fit-content', 
  delay = 0,
  duration = 0.5,
  direction = 'up',
  className = "",
  disableMobileMovement = false
}: RevealProps) => {
  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, margin: "-10%" }); // Marge relatiu % Ã©s millor per mÃ²bil
  const mainControls = useAnimation();
  
  // Respectar preferÃ¨ncies d'accessibilitat del sistema (si l'usuari tÃ© "Reduir moviment" activat)
  const shouldReduceMotion = useReducedMotion();

  useEffect(() => {
    if (isInView) {
      mainControls.start('visible');
    }
  }, [isInView, mainControls]);

  // CALCULEM EL MOVIMENT OPTIMITZAT
  // En lloc de moure 75px, en movem menys per evitar "salts" grans en pantalles petites
  const distance = 30; 

  const getHiddenVariant = () => {
    if (shouldReduceMotion) return { opacity: 0, x: 0, y: 0 }; // NomÃ©s fade-in si demana poc moviment

    switch(direction) {
      // Use 'translate3d' implÃ­citament amb framer-motion per activar GPU
      case 'up': return { opacity: 0, y: distance }; 
      case 'down': return { opacity: 0, y: -distance };
      case 'left': return { opacity: 0, x: distance, y: 0 };
      case 'right': return { opacity: 0, x: -distance, y: 0 };
      default: return { opacity: 0, x: 0, y: 0 };
    }
  };

  return (
    <div 
      ref={ref} 
      className={className}
      style={{ 
        position: 'relative', 
        width, 
        overflow: 'visible',
        // TRUC PER EVITAR PIXELAT EN TEXTOS (Safari/Chrome)
        WebkitFontSmoothing: 'antialiased',
        backfaceVisibility: 'hidden',
        transform: 'translateZ(0)' 
      }} 
    >
      <motion.div
        variants={{
          hidden: getHiddenVariant(),
          visible: { 
            opacity: 1, 
            x: 0, 
            y: 0,
            transition: { 
                duration: duration, 
                delay: delay,
                // Use 'easeOut' que Ã©s mÃ©s suau per a la GPU que 'spring'
                ease: [0.25, 0.1, 0.25, 1.0] 
            }
          },
        }}
        initial="hidden"
        animate={mainControls}
        // 'willChange' avisa al navegador que prepari la GPU
        style={{ willChange: 'opacity, transform' }} 
      >
        {children}
      </motion.div>
    </div>
  );
};

// Component extra per a llistes (Cards de posts, serveis, etc.)
// Fa que apareguin en cascada (Stagger)
export const StaggerContainer = ({ children, className }: { children: React.ReactNode, className?: string }) => {
  return (
    <motion.div
      className={className}
      initial="hidden"
      whileInView="visible"
      viewport={{ once: true, margin: "-50px" }}
      variants={{
        hidden: {},
        visible: {
          transition: {
            staggerChildren: 0.15 // 150ms entre cada element
          }
        }
      }}
    >
      {children}
    </motion.div>
  );
};

export const StaggerItem = ({ children, className }: { children: React.ReactNode, className?: string }) => {
  return (
    <motion.div
      className={className}
      variants={{
        hidden: { opacity: 0, y: 20 },
        visible: { opacity: 1, y: 0, transition: { duration: 0.5 } }
      }}
    >
      {children}
    </motion.div>
  );
};

// =================== FILE: src/components/charts/ScoreRing.tsx ===================

'use client';
import { RadialBarChart, RadialBar, PolarAngleAxis, ResponsiveContainer } from 'recharts';

export function ScoreRing({ score, label }: { score: number; label: string }) {
  // Color dinÃ mic
  const color = score >= 90 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
  
  const data = [{ name: 'Score', value: score, fill: color }];

  return (
    <div className="flex flex-col items-center justify-center w-full h-full">
        <div className="relative w-[120px] h-[120px]">
            <ResponsiveContainer width="100%" height="100%">
                <RadialBarChart 
                    innerRadius="80%" 
                    outerRadius="100%" 
                    barSize={10} 
                    data={data} 
                    startAngle={90} 
                    endAngle={-270}
                >
                    <PolarAngleAxis type="number" domain={[0, 100]} angleAxisId={0} tick={false} />
                    <RadialBar background dataKey="value" cornerRadius={10} />
                </RadialBarChart>
            </ResponsiveContainer>
            {/* Text al centre */}
            <div className="absolute inset-0 flex items-center justify-center">
                <span className="text-3xl font-bold" style={{ color }}>{score}</span>
            </div>
        </div>
        <p className="mt-2 text-sm font-medium text-slate-500 uppercase tracking-wider">{label}</p>
    </div>
  );
}

// =================== FILE: src/components/dashboard/AuditCard.tsx ===================

'use client';

import { Link } from '@/routing';
import { Card, CardContent } from '@/components/ui/card';
import { ArrowRight, Globe } from 'lucide-react';

type AuditProps = {
  id: string;
  url: string;
  status: 'processing' | 'completed' | 'failed';
  seoScore: number | null;
  createdAt: string | Date;
};

export function AuditCard({ audit }: { audit: AuditProps }) {
  return (
    <Link href={`/dashboard/audits/${audit.id}`} className="block group h-full">
      {/* Estil Fosc + Light Adaptable (bg-card en light, fons fosc en dark) */}
      <Card className="bg-card dark:bg-[#0f111a]/50 border border-border dark:border-white/5 hover:border-primary/50 transition-all h-full shadow-sm hover:shadow-md group-hover:-translate-y-1 backdrop-blur-sm">
        <CardContent className="p-6 flex flex-col h-full">
          
          {/* Header Card */}
          <div className="flex justify-between items-start mb-4">
            <div className="p-2.5 bg-muted dark:bg-white/5 rounded-lg text-muted-foreground group-hover:text-primary group-hover:bg-primary/10 transition-colors">
              <Globe className="w-5 h-5" />
            </div>
            <StatusBadge status={audit.status} />
          </div>

          {/* Body Card */}
          <div className="flex-grow">
            <h3 className="text-lg font-bold text-foreground dark:text-white truncate mb-1" title={audit.url}>
              {audit.url.replace(/^https?:\/\//, '').replace(/\/$/, '')}
            </h3>
            <p className="text-xs text-muted-foreground dark:text-slate-500 mb-6">
              {new Date(audit.createdAt).toLocaleDateString()}
            </p>
          </div>

          {/* Footer Card */}
          <div className="mt-auto flex items-center justify-between pt-4 border-t border-border dark:border-white/5">
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-wider text-muted-foreground font-bold">SEO SCORE</span>
              <span className={`text-xl font-bold ${getScoreColor(audit.seoScore ?? 0)}`}>
                {audit.seoScore ?? '-'}
              </span>
            </div>
            <div className="w-8 h-8 rounded-full bg-muted dark:bg-white/5 flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-all text-muted-foreground">
              <ArrowRight className="w-4 h-4" />
            </div>
          </div>
        </CardContent>
      </Card>
    </Link>
  );
}

// Helpers locals
function StatusBadge({ status }: { status: string }) {
  const styles = {
    completed: 'text-green-600 bg-green-100 border-green-200 dark:text-green-400 dark:bg-green-500/10 dark:border-green-500/20',
    processing: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-400 dark:bg-blue-500/10 dark:border-blue-500/20 animate-pulse',
    failed: 'text-red-600 bg-red-100 border-red-200 dark:text-red-400 dark:bg-red-500/10 dark:border-red-500/20'
  };
  const label = status === 'completed' ? 'Completada' : status === 'processing' ? 'Analitzant' : 'Error';

  return (
    <span className={`px-2.5 py-1 rounded-full text-[10px] uppercase font-bold tracking-wider border ${styles[status as keyof typeof styles] || 'text-muted-foreground bg-muted border-border'}`}>
      {label}
    </span>
  );
}

function getScoreColor(score: number) {
  if (score >= 90) return 'text-green-600 dark:text-green-400';
  if (score >= 50) return 'text-yellow-600 dark:text-yellow-400';
  return 'text-red-600 dark:text-red-400';
}

// =================== FILE: src/components/dashboard/DashboardHeader.tsx ===================

'use client';

import { Bell, Search } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { ThemeToggle } from '@/components/ui/theme-toggle';
import { useTranslations } from 'next-intl';
import { LanguageSwitcher } from '../layout/LanguageSwitcher'; // âš ï¸ OJO AQUÃ

export function DashboardHeader({ userEmail }: { userEmail?: string }) {
   const t = useTranslations('DashboardHeader');

   return (
      <header className="h-16 border-b border-border bg-background/80 backdrop-blur-xl sticky top-0 z-30 px-4 md:px-6 flex items-center justify-center md:justify-between transition-colors duration-300">

         <div className="flex items-center w-full max-w-xs md:max-w-md mr-4">
            <div className="relative w-full">
               <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
               <Input
                  placeholder={t('search_placeholder')}
                  className="pl-10 bg-muted/50 border-transparent focus:bg-background focus:border-primary transition-all h-9 rounded-full"
               />
            </div>
         </div>

         <div className="flex items-center gap-2 md:gap-4 shrink-0">
            <LanguageSwitcher />
            <ThemeToggle />

            <Button variant="ghost" size="icon" className="relative rounded-full text-muted-foreground hover:text-foreground hidden sm:flex">
               <Bell className="w-5 h-5" />
               <span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-background"></span>
            </Button>

            <div className="h-6 w-px bg-border mx-1 hidden sm:block"></div>

            <div className="flex items-center gap-3">
               <div className="text-right hidden md:block">
                  <p className="text-sm font-medium text-foreground leading-none">{t('account')}</p>
                  <p className="text-xs text-muted-foreground truncate max-w-30">{userEmail}</p>
               </div>
               <div className="w-9 h-9 rounded-full bg-linear-to-br from-primary to-blue-500 flex items-center justify-center text-white font-bold shadow-lg ring-2 ring-background">
                  {userEmail ? userEmail.charAt(0).toUpperCase() : 'U'}
               </div>
            </div>
         </div>
      </header>
   );
}

// =================== FILE: src/components/dashboard/LogoutButton.tsx ===================

'use client';

import { LogOut, Loader2 } from 'lucide-react'; // Afegim Loader2
import { useTranslations } from 'next-intl';
import { useState } from 'react';
import { signOutAction } from '@/features/auth/actions/auth';
import { cn } from '@/lib/utils'; // Important per fusionar classes
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';

interface LogoutButtonProps {
  minimal?: boolean;   // Si Ã©s true, nomÃ©s mostra icona
  className?: string;  // Per sobreescriure estils (flex-col vs flex-row)
}

export function LogoutButton({ minimal = false, className }: LogoutButtonProps) {
  const t = useTranslations('Sidebar'); // O 'Navbar', segons on tinguis les traduccions de logout
  const [isLoading, setIsLoading] = useState(false);

  const handleLogout = async () => {
    setIsLoading(true);
    await signOutAction();
  };

  return (
    <AlertDialog>
      <AlertDialogTrigger asChild>
        <button 
          className={cn(
            // Estils base per defecte (Sidebar)
            "flex items-center gap-3 px-3 py-2.5 w-full rounded-lg text-sm font-medium transition-colors",
            "text-red-600 hover:bg-red-50 dark:hover:bg-red-900/10",
            // Si passem una className des de fora (MÃ²bil), aquesta guanya
            className
          )}
          disabled={isLoading}
        >
          {isLoading ? (
             <Loader2 className="w-5 h-5 animate-spin" />
          ) : (
             <LogOut className={cn("w-5 h-5", minimal && "w-6 h-6" /* Icona una mica mÃ©s gran al mÃ²bil */)} strokeWidth={2} />
          )}
          
          {/* NomÃ©s mostrem el text si NO Ã©s minimal */}
          {!minimal && (
            <span>{t('logout')}</span>
          )}
        </button>
      </AlertDialogTrigger>
      
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>{t('logout_confirm_title')}</AlertDialogTitle>
          <AlertDialogDescription>
            {t('logout_confirm_desc')}
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>{t('cancel')}</AlertDialogCancel>
          <AlertDialogAction 
            onClick={handleLogout}
            className="bg-red-600 text-white hover:bg-red-700 focus:ring-red-600"
          >
            {isLoading ? '...' : t('logout_action')}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}

// =================== FILE: src/components/dashboard/Sidebar.tsx ===================

'use client';

import { Link } from '@/routing';
import { usePathname } from 'next/navigation';
import { useTranslations } from 'next-intl';
import {
  LayoutDashboard,
  Settings,
  FileText,
  BarChart3,
  Users,
  ShieldCheck // <--- Icona per Admin
  
} from 'lucide-react';
import { cn } from '@/lib/utils'; // Assegura't de tenir aquesta utilitat o fes servir template strings
import { LogoutButton } from './LogoutButton'; // <--- Importa el nou component
interface SidebarProps {
  userRole?: 'admin' | 'client' | 'lead';
}

export function Sidebar({ userRole = 'client' }: SidebarProps) {
  const t = useTranslations('Sidebar');
  const pathname = usePathname();

  // Definim els items segons el rol
  const menuItems = [
    {
      label: t('overview'),
      href: '/dashboard',
      icon: LayoutDashboard,
      roles: ['admin', 'client', 'lead'],
    },
    {
      label: 'Admin Panel', // Pots posar t('admin_panel')
      href: '/admin',       // <--- La ruta on vols anar
      icon: ShieldCheck,
      roles: ['admin'],     // <--- NOMÃ‰S ADMIN
    },
    {
      label: t('projects'),
      href: '/dashboard/projects',
      icon: FileText,
      roles: ['admin', 'client'],
    },
    {
      label: t('analytics'),
      href: '/dashboard/audits',
      icon: BarChart3,
      roles: ['admin', 'client'],
    },
    {
      label: t('users'),
      href: '/dashboard/users',
      icon: Users,
      roles: ['admin'], // NomÃ©s admin
    },
    {
      label: t('settings'),
      href: '/dashboard/settings',
      icon: Settings,
      roles: ['admin'],
    },
  ];

  // Filtrem els items segons el rol de l'usuari
  const visibleItems = menuItems.filter(item => item.roles.includes(userRole));

  return (
    <aside className="w-64 h-screen bg-slate-50 dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col fixed left-0 top-0">

      {/* Logo Area */}
      <div className="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-800">
        <span className="font-bold text-xl tracking-tight">DigitAI<span className="text-blue-600">.</span></span>
      </div>

      {/* Navigation */}
      <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
        {visibleItems.map((item) => {
          const isActive = pathname === item.href;

          return (
            <Link
              key={item.href} // UTILITZEM LA URL COM A KEY (Ã‰s Ãºnica)
              href={item.href}
              className={cn(
                "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200",
                isActive
                  ? "bg-blue-600 text-white shadow-md shadow-blue-500/20"
                  : "text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white"
              )}
            >
              <item.icon className={cn("w-5 h-5", isActive ? "text-white" : "text-current")} />
              {item.label}
            </Link>
          );
        })}
      </nav>

      {/* Footer / Logout */}
      <div className="p-4 border-t border-slate-200 dark:border-slate-800">
        {/* Footer / Logout */}
        <div className="p-4 border-t border-slate-200 dark:border-slate-800">
          <LogoutButton /> {/* <--- SubstituÃ¯m el <button> antic per aquest */}
        </div>
      </div>
    </aside>
  );
}

// =================== FILE: src/components/icons/GoogleIcon.tsx ===================

export const GoogleIcon = ({ className }: { className?: string }) => (
  <svg 
    xmlns="http://www.w3.org/2000/svg" 
    viewBox="0 0 24 24" 
    className={className}
  >
    <path
      d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
      fill="#4285F4"
    />
    <path
      d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
      fill="#34A853"
    />
    <path
      d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
      fill="#FBBC05"
    />
    <path
      d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
      fill="#EA4335"
    />
  </svg>
);

// =================== FILE: src/components/icons/TechIcons.tsx ===================

import Image from 'next/image';


type IconProps = { className?: string };

// âœ… NEXT.JS ORIGINAL (La "N" amb l'ombra)
export function NextjsIcon({ className }: IconProps) {
    return (
        <svg
            viewBox="0 0 180 180"
            fill="none"
            className={className}
            xmlns="http://www.w3.org/2000/svg"
        >
            <mask id="mask0_next" style={{ maskType: 'alpha' }} maskUnits="userSpaceOnUse" x="0" y="0" width="180" height="180">
                <circle cx="90" cy="90" r="90" fill="black" />
            </mask>
            <g mask="url(#mask0_next)">
                {/* Cercle de fons: Negre en Light, Blanc en Dark */}
                <circle cx="90" cy="90" r="90" className="fill-black dark:fill-white" />

                {/* La "N" */}
                <path
                    d="M149.508 157.52L69.142 54H54V125.97H66.1136V69.3836L139.999 164.845C143.333 162.614 146.509 160.165 149.508 157.52Z"
                    fill="url(#paint0_linear_next)"
                />
                <rect x="115" y="54" width="12" height="72" className="fill-white dark:fill-black" />
            </g>
            {/* Gradient per donar l'efecte d'ombra de la N */}
            <defs>
                <linearGradient id="paint0_linear_next" x1="109" y1="116.5" x2="144.5" y2="160.5" gradientUnits="userSpaceOnUse">
                    <stop stopColor="white" className="stop-white dark:stop-black" />
                    <stop offset="1" stopColor="white" stopOpacity="0" className="stop-white dark:stop-black" />
                </linearGradient>
            </defs>
            {/* Hack per canviar colors de gradient via CSS no Ã©s fÃ cil, 
          aixÃ­ que fem una versiÃ³ simplificada sÃ²lida que funciona sempre 100% */}
            <path
                d="M149.5 157.5L69.1 54H54V126H66.1V69.4L140 164.8C143.3 162.6 146.5 160.2 149.5 157.5Z"
                className="fill-white dark:fill-black"
            />
        </svg>
    );
}

// âœ… n8n: Carrega el teu fitxer 'public/n8n.svg'
export function N8nIcon({ className }: IconProps) {
    return (
        <Image
            src="/n8n-color.svg"
            alt="n8n"
            className={className}
            width={50}
            height={50}
        />
    );
}

// âœ… MAKE: Carrega el teu fitxer 'public/makecolor.svg'
// El filtre CSS del pare (TechStackSection) el posarÃ  en gris quan toqui.
export function MakeIcon({ className }: IconProps) {
    return (
        <Image
            src="/make-color.svg"
            alt="Make"
            className={className}
            width={50}
            height={50}
        />
    );
}

export function SupabaseIcon({ className }: IconProps) {
    return (
        <svg viewBox="0 0 24 24" fill="none" className={className}>
            <path d="M11.5286 0.179546C11.8331 -0.0812412 12.2919 -0.0533377 12.5643 0.24243L23.6622 12.2932C23.9326 12.5868 23.8877 13.048 23.5614 13.2813L13.3359 20.5925L15.9762 23.1152C16.2584 23.3849 16.0599 23.8673 15.6692 23.8673H11.5286C11.2241 24.1281 10.7653 24.1002 10.4929 23.8044L-0.605008 11.7537C-0.875401 11.46 -0.830532 10.9989 -0.504224 10.7655L9.72131 3.45435L7.08095 0.931661C6.79877 0.661952 6.99727 0.179546 7.38795 0.179546H11.5286Z" fill="#3ECF8E" />
        </svg>
    );
}

export function AirtableIcon({ className }: IconProps) {
    return (
        <svg viewBox="0 0 24 24" fill="none" className={className}>
            <path d="M3 10v8l7 -3v-2.6z" fill="#F8D800" />
            <path d="M3 6l9 3l9 -3l-9 -3z" fill="#2D7FF9" />
            <path d="M14 12.3v8.7l7 -3v-8z" fill="#F82B60" />
        </svg>
    );
}

export function ReactIcon({ className }: IconProps) {
    return (
        <svg viewBox="0 0 24 24" fill="none" className={className}>
            <circle cx="12" cy="12" r="2" fill="#61DAFB" />
            <g stroke="#61DAFB" strokeWidth="1.5" fill="none">
                <ellipse cx="12" cy="12" rx="10" ry="4" />
                <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(60 12 12)" />
                <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(120 12 12)" />
            </g>
        </svg>
    );
}

export function OpenAIIcon({ className }: IconProps) {
    return (
        <svg viewBox="0 0 24 24" fill="none" className={className}>
            <path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1 .6765 8.1643l-.142-.0805-4.7784-2.7581a.7616.7616 0 0 0-.3927-.6765v-6.7369l.0048-.0048z" className="fill-black dark:fill-white" />
        </svg>
    );
}

export function GeminiIcon({ className }: IconProps) {
    return (
        <svg viewBox="0 0 24 24" fill="none" className={className}>
            <defs>
                <linearGradient id="gemini-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stopColor="#4E75F6" />
                    <stop offset="100%" stopColor="#E96C7C" />
                </linearGradient>
            </defs>
            <path d="M12 22C12 16.4772 16.4772 12 22 12C16.4772 12 12 7.52285 12 2C12 7.52285 7.52285 12 2 12C7.52285 12 12 16.4772 12 22Z" fill="url(#gemini-gradient)" />
        </svg>
    );
}

export function TypeScriptIcon({ className }: IconProps) {
    return (
        <svg viewBox="0 0 24 24" fill="none" className={className}>
            <path d="M2 0h20c1.1 0 2 0.9 2 2v20c0 1.1-0.9 2-2 2H2c-1.1 0-2-0.9-2-2V2c0-1.1 0.9-2 2-2zm13.5 17.9c1.3 0 2.2-0.7 2.6-1.7h-1.7c-0.2 0.4-0.5 0.6-0.9 0.6-0.7 0-1-0.6-1-1.7v-3.3h2.9v-1.4h-2.9v-2.1h-1.7v2.1h-1.4v1.4h1.4v3.6c0 1.6 0.9 2.5 2.7 2.5zm-6.7 0c1.5 0 2.6-0.8 2.8-2h-1.7c-0.2 0.5-0.6 0.8-1.1 0.8-0.8 0-1.2-0.6-1.2-1.6v-3.2h2.8v-1.4h-2.8v-2.1h-1.7v2.1h-1.6v1.4h1.6v3.5c0 1.7 1.1 2.5 2.9 2.5z" fill="#3178C6" />
        </svg>
    );
}

export function GitHubIcon({ className }: IconProps) {
    return (
        <svg viewBox="0 0 16 16" fill="none" className={className}>
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.65.72.26.98.19 1.12.08.14-.55.28-.94.55-1.15-2.2-.23-4.51-1.1-4.51-4.9 0-1.08.38-1.97 1.01-2.66-.1-.25-.44-1.26.1-2.62 0 0 .84-.27 2.75 1.02.8-.22 1.65-.33 2.5-.33.85 0 1.7.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.36.2 2.37.1 2.62.63.69 1.01 1.58 1.01 2.66 0 3.8-2.32 4.67-4.53 4.89.29.25.55.74.55 1.49 0 1.08-.01 1.95-.01 2.21 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" className="fill-black dark:fill-white" />
        </svg>
    );
}

export function VercelIcon({ className }: IconProps) {
    return (
        <svg viewBox="0 0 24 24" fill="none" className={className}>
            <path d="M12 1L24 22H0L12 1Z" className="fill-black dark:fill-white" />
        </svg>
    );
}



// =================== FILE: src/components/landing/AuditSection.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { AuditForm } from '@/features/audit/ui/AuditForm';
import { useTranslations } from 'next-intl';
import { User } from '@supabase/supabase-js';
import { Button } from '@/components/ui/button';
import { Link } from '@/routing'; 
import { LayoutDashboard, ArrowRight } from 'lucide-react';

interface Props {
  currentUser?: User | null;
}

export function AuditSection({ currentUser }: Props) {
  const t = useTranslations('AuditSection');
  const userName = currentUser?.email?.split('@')[0] || 'User';

  return (
    <section id="audit" className="py-14 relative overflow-hidden bg-background transition-colors duration-300">
      
      {/* FIX FONS: 
         1. ReduÃ¯t 'via-primary/5' a 'via-purple-500/1'.
         GairebÃ© invisible, nomÃ©s per trencar el pla.
      */}
      <div className="absolute inset-0 bg-linear-to-b from-transparent via-purple-500/1 to-transparent pointer-events-none" />
      
      {/* FIX SPOTLIGHT: 
         1. ReduÃ¯t opacitat del 50% al 15% (Light) i 5% (Dark).
         Ara no molesta a la vista.
      */}
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-150 h-150 bg-blue-500/10 dark:bg-primary/10 blur-[120px] rounded-full pointer-events-none opacity-15 dark:opacity-5" />

      <div className="container mx-auto px-4 relative z-10">
        
        <div className="max-w-3xl mx-auto text-center mb-12">
          <motion.div 
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
          >
            <h2 className="text-3xl lg:text-5xl font-bold mb-6 text-foreground leading-tight">
              {t('title_prefix')} <span className="text-red-500/80 line-through decoration-2">{t('title_cost')}</span> {t('title_connector')} <span className="text-transparent bg-clip-text bg-linear-to-r from-primary to-purple-500 pb-2">{t('title_investment')}</span>?
            </h2>
            
            <p className="text-lg text-muted-foreground leading-relaxed">
              {t('description_stat')}
              <br className="hidden md:block" />
              {t('description_cta')}
            </p>
          </motion.div>
        </div>

        {/* LOGICA CONDICIONAL DE UI */}
        <motion.div 
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true }}
          transition={{ delay: 0.2 }}
          className="max-w-xl mx-auto transform hover:scale-[1.01] transition-transform duration-500"
        >
          {currentUser ? (
            // Targeta Loguejat - Fons mÃ©s net
            <div className="p-8 rounded-2xl bg-white dark:bg-zinc-950 border border-slate-200 dark:border-white/10 shadow-2xl text-center space-y-6">
                <div className="w-16 h-16 bg-slate-50 dark:bg-zinc-900 rounded-full flex items-center justify-center mx-auto text-primary mb-4 border border-slate-100 dark:border-zinc-800">
                    <LayoutDashboard className="w-8 h-8" />
                </div>
                <div>
                    <h3 className="text-xl font-bold text-foreground">
                        {t('logged_title', { name: userName })} 
                    </h3>
                    <p className="text-muted-foreground mt-2">
                        {t('logged_desc')}
                    </p>
                </div>
                
                <Link href="/dashboard/new-audit">
                    <Button className="w-full h-12 text-lg font-bold rounded-xl gradient-bg text-white hover:opacity-90 shadow-lg">
                        {t('btn_dashboard')} <ArrowRight className="ml-2 w-5 h-5" />
                    </Button>
                </Link>
                
                <p className="text-xs text-muted-foreground">
                    {t('logged_footer')}
                </p>
            </div>
          ) : (
            <AuditForm />
          )}
        </motion.div>

      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/BenefitsSection.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { 
  Clock, 
  TrendingUp, 
  Zap, 
  Target, 
  Share2, 
  BrainCircuit 
} from 'lucide-react';

const BENEFITS = [
  {
    icon: Clock,
    title: 'Estalvi de temps',
    description: 'Automatitza tasques repetitives i allibera fins a 40 hores setmanals per centrar-te en el que realment importa.'
  },
  {
    icon: TrendingUp,
    title: 'Productivitat x3',
    description: "Incrementa l'eficiÃ¨ncia del teu equip amb processos intelÂ·ligents i fluxos de treball sense errors."
  },
  {
    icon: Zap,
    title: 'Respostes 24/7',
    description: 'Chatbots intelÂ·ligents que atenen els teus clients a qualsevol hora, sense descans i amb precisiÃ³.'
  },
  {
    icon: Target,
    title: 'AdaptaciÃ³ a mida',
    description: "No et donem una plantilla. La nostra IA s'entrena amb les dades especÃ­fiques del teu negoci."
  },
  {
    icon: Share2,
    title: 'MÃ rqueting Autopilot',
    description: 'GeneraciÃ³ i publicaciÃ³ de contingut a xarxes socials de forma autÃ²noma i estratÃ¨gica.'
  },
  {
    icon: BrainCircuit,
    title: 'Decisions amb Dades',
    description: 'AnalÃ­tica predictiva per anticipar-te a les tendÃ¨ncies del mercat i prendre millors decisions.'
  }
];

export function BenefitsSection() {
  return (
    <section id="beneficis" className="py-24 relative overflow-hidden">
      {/* Element decoratiu de fons */}
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-primary/5 rounded-full blur-3xl -z-10" />

      <div className="container mx-auto px-4">
        {/* CapÃ§alera de secciÃ³ */}
        <motion.div 
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true, margin: "-100px" }}
          className="text-center mb-16 max-w-3xl mx-auto"
        >
          <h2 className="text-4xl lg:text-5xl font-bold mb-6">
            Beneficis de la <span className="gradient-text">Nova Era</span>
          </h2>
          <p className="text-xl text-muted-foreground">
            La tecnologia no ha de ser complicada. Descobreix com simplifiquem el teu dia a dia.
          </p>
        </motion.div>
        
        {/* Graella de beneficis */}
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {BENEFITS.map((benefit, index) => (
            <motion.div
              key={index}
              initial={{ opacity: 0, y: 30 }}
              whileInView={{ opacity: 1, y: 0 }}
              viewport={{ once: true }}
              transition={{ delay: index * 0.1 }}
              whileHover={{ y: -5 }}
              className="solution-card-futuristic p-8 rounded-3xl flex flex-col items-center text-center group"
            >
              <div className="benefit-icon group-hover:scale-110 transition-transform duration-300">
                <benefit.icon className="h-8 w-8 text-white" />
              </div>
              <h3 className="text-xl font-bold mb-3">{benefit.title}</h3>
              <p className="text-muted-foreground leading-relaxed">
                {benefit.description}
              </p>
            </motion.div>
          ))}
        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/contact/contact-form.tsx ===================

'use client';

import { useActionState, useState } from 'react';
import { submitContactForm } from '@/actions/contact';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Checkbox } from '@/components/ui/checkbox';
import { Link } from '@/routing';
import { Loader2, Send, Bot, AppWindow, AlertCircle, MessageSquare, type LucideIcon } from 'lucide-react'; // âœ… Afegit type LucideIcon
import { motion } from 'framer-motion';
import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils';

const initialState = { success: false, message: '', errors: {} };

export function ContactForm() {
  const t = useTranslations('ContactSection');
  const [state, action, isPending] = useActionState(submitContactForm, initialState);
  const [serviceType, setServiceType] = useState('ia');
  const [termsAccepted, setTermsAccepted] = useState(false);

  return (
    <motion.div 
       initial={{ opacity: 0, x: 20 }} 
       whileInView={{ opacity: 1, x: 0 }} 
       viewport={{ once: true }}
       className={cn(
         "bg-white dark:bg-zinc-950 border border-slate-200 dark:border-white/10 rounded-3xl p-8 lg:p-10 shadow-2xl relative overflow-hidden",
         "md:bg-white/90 md:dark:bg-[#0f111a]/95 md:backdrop-blur-xl"
       )}
    >
      <form action={action} className="space-y-6 relative z-10">
        
        {/* SELECTOR DE SERVEI */}
        <div className="space-y-3 mb-6">
         
           
           <div className="grid grid-cols-2 gap-3">
             <ServiceButton 
               active={serviceType === 'ia'} 
               onClick={() => setServiceType('ia')} 
               icon={Bot} 
               label={t('options.ia')} 
             />
             <ServiceButton 
               active={serviceType === 'web'} 
               onClick={() => setServiceType('web')} 
               icon={AppWindow} 
               label={t('options.web')} 
             />
           </div>
           <input type="hidden" name="service" value={serviceType === 'ia' ? 'ia_automation' : 'web_app'} />
        </div>

        {/* INPUTS */}
        <div className="space-y-4">
          <FormInput name="fullName" label={t('form.name_label')} placeholder={t('form.name_placeholder')} error={state.errors?.fullName} />
          <FormInput name="email" type="email" label={t('form.email_label')} placeholder={t('form.email_placeholder')} error={state.errors?.email} />
          
          <div className="space-y-2">
             <label className="text-sm font-medium text-foreground ml-1 flex items-center gap-2">
                <MessageSquare className="w-4 h-4 text-muted-foreground" /> {t('form.message_label')}
             </label>
             <textarea 
               name="message" rows={4} required minLength={10} placeholder={t('form.message_placeholder')}
               className="w-full rounded-lg border border-input bg-slate-50 dark:bg-zinc-900 px-4 py-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all resize-none placeholder:text-muted-foreground/70"
             />
             <div className="flex justify-between items-start">
                <ErrorMessage errors={state.errors?.message} />
                <span className="text-[10px] text-muted-foreground ml-auto pt-1 opacity-70">MÃ­n. 10 carÃ cters</span>
             </div>
          </div>
        </div>

        {/* CHECKBOX */}
        <div className="space-y-2 pt-2">
            <div className="flex items-start space-x-3">
            <Checkbox 
                id="privacy-contact" name="privacy" value="on" required checked={termsAccepted} onCheckedChange={(c) => setTermsAccepted(c as boolean)}
                className="mt-1 border-muted-foreground/30 data-[state=checked]:bg-primary data-[state=checked]:border-primary" 
            />
            <label htmlFor="privacy-contact" className="text-sm text-muted-foreground leading-snug cursor-pointer select-none">
                {t.rich('privacy_text', {
                link: (chunks) => <Link href="/legal/privacitat" target="_blank" className="underline hover:text-primary transition-colors decoration-primary/30">{chunks}</Link>
                })}
            </label>
            </div>
            <ErrorMessage errors={state.errors?.privacy} />
        </div>

        {/* BOTÃ“ */}
        <div className="relative group pt-2">
            <Button 
              type="submit" disabled={isPending || !termsAccepted || state.success} 
              className={cn(
                "w-full h-14 text-lg font-bold rounded-xl transition-all shadow-lg flex items-center justify-center",
                termsAccepted && !state.success
                  ? "bg-linear-to-r from-primary to-purple-600 text-white hover:opacity-90 hover:shadow-primary/25 hover:scale-[1.01]" 
                  : "bg-muted text-muted-foreground cursor-not-allowed opacity-60"
              )}
            >
              {isPending ? <><Loader2 className="animate-spin mr-2" /> Enviant...</> : state.success ? "Enviat Correctament!" : <>{t('form.submit_button')} <Send className="ml-2 w-5 h-5" /></>}
            </Button>
        </div>

        {/* MISSATGES */}
        {state?.message && (
            <div className={cn("text-center text-sm font-medium mt-4 p-3 rounded-lg border flex items-center justify-center gap-2", state.success ? "bg-green-500/10 border-green-500/20 text-green-600" : "bg-red-500/10 border-red-500/20 text-red-600")}>
                {state.success ? null : <AlertCircle className="w-4 h-4" />} {state.message}
            </div>
        )}
      </form>
    </motion.div>
  );
}

// --- SUBCOMPONENTS TIPATS CORRECTAMENT ---

interface ServiceButtonProps {
  active: boolean;
  onClick: () => void;
  icon: LucideIcon; // âœ… Tipatge correcte per icones de Lucide
  label: string;
}

function ServiceButton({ active, onClick, icon: Icon, label }: ServiceButtonProps) {
  return (
    <button type="button" onClick={onClick}
      className={cn(
        "relative flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all duration-200 group",
        active 
          // ğŸ”¥ FIX LIGHT MODE:
          // Abans: bg-primary/5 (AixÃ² feia la taca lila).
          // Ara: bg-slate-50 (Gris molt net).
          // El 'dark:bg-zinc-900' es mantÃ© perquÃ¨ vas dir que en dark mode estava perfecte.
          ? "border-primary bg-slate-50 dark:bg-zinc-900 text-primary shadow-sm ring-1 ring-primary/20" 
          : "border-border bg-transparent dark:bg-zinc-950 text-muted-foreground hover:bg-slate-50 dark:hover:bg-zinc-900 hover:border-primary/30"
      )}
    >
      <Icon className={cn("w-6 h-6 mb-2 transition-colors", active ? "text-primary" : "text-muted-foreground group-hover:text-primary/70")} />
      <span className="text-xs font-bold text-center">{label}</span>
    </button>
  );
}

interface FormInputProps {
  name: string;
  type?: string;
  label: string;
  placeholder: string;
  error?: string[];
}

function FormInput({ name, type = "text", label, placeholder, error }: FormInputProps) {
  return (
    <div className="space-y-2">
      <label className="text-sm font-medium text-foreground ml-1">{label}</label>
      <Input name={name} type={type} placeholder={placeholder} required 
        className="bg-slate-50 dark:bg-zinc-900 border-input focus:border-primary h-12 text-foreground placeholder:text-muted-foreground/70 transition-all" 
      />
      <ErrorMessage errors={error} />
    </div>
  );
}

function ErrorMessage({ errors }: { errors?: string[] }) {
  if (!errors || !errors.length) return null;
  return <p className="text-xs font-medium text-destructive mt-1 flex items-center gap-1"><AlertCircle className="w-3 h-3" /> {errors[0]}</p>;
}

// =================== FILE: src/components/landing/contact/contact-info.tsx ===================

'use client';

import { Rocket, Shield, Users } from 'lucide-react';
import { motion } from 'framer-motion';
import { useTranslations } from 'next-intl';

export function ContactInfo() {
  const t = useTranslations('ContactSection');

  const features = [
    { icon: Rocket, title: t('features.agile.title'), desc: t('features.agile.desc') },
    { icon: Shield, title: t('features.tech.title'), desc: t('features.tech.desc') },
    { icon: Users, title: t('features.partners.title'), desc: t('features.partners.desc') }
  ];

  return (
    <motion.div 
      initial={{ opacity: 0, x: -20 }} 
      whileInView={{ opacity: 1, x: 0 }} 
      viewport={{ once: true }}
      className="space-y-10"
    >
      <div>
        <h2 className="text-4xl lg:text-5xl font-bold mb-6 text-foreground leading-tight">
          {t('title_prefix')} <span className="text-transparent bg-clip-text bg-linear-to-r from-primary to-purple-500 pb-2">{t('title_highlight')}</span>
        </h2>
        <p className="text-muted-foreground text-lg leading-relaxed max-w-lg">
          {t('description')}
        </p>
      </div>

      <div className="space-y-8">
        {features.map((item, i) => (
          <div key={i} className="flex gap-5 items-start group">
            {/* ğŸ”¥ FIX VISUAL:
                1. Eliminat 'bg-primary/10' -> Ara Ã©s 'bg-slate-100 dark:bg-zinc-800' (SÃ²lid i net).
                2. Eliminat 'backdrop-blur-sm' -> Millora rendiment i claredat.
                3. La icona es mantÃ© 'text-primary' per donar el toc de color sobre el gris.
            */}
            <div className="mt-1 w-12 h-12 rounded-2xl bg-slate-100 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform shadow-xs">
              <item.icon className="w-6 h-6 text-primary" />
            </div>
            <div>
              <h3 className="font-bold text-foreground text-xl mb-1">{item.title}</h3>
              <p className="text-muted-foreground leading-relaxed">{item.desc}</p>
            </div>
          </div>
        ))}
      </div>
    </motion.div>
  );
}

// =================== FILE: src/components/landing/ContactSection.tsx ===================

'use client';

import { ContactInfo } from '@/components/landing/contact/contact-info';
import { ContactForm } from '@/components/landing/contact/contact-form';

export function ContactSection() {
  return (
    <section id="contacte" className="py-24 bg-background relative overflow-hidden transition-colors duration-300">
      
      {/* FIX FONS: 
         1. Canviat 'via-primary/2' per 'via-purple-500/1'. 
         L'1% Ã©s prÃ cticament invisible, nomÃ©s trenca el blanc pur sense pintar-ho de lila.
      */}
      <div className="absolute top-0 left-0 w-full h-full bg-linear-to-b from-transparent via-purple-500/1 to-transparent pointer-events-none" />
      
      {/* FIX SPOTLIGHT: 
         1. ReduÃ¯t 'opacity-30' (Light) a 'opacity-10'. 
         2. Mantingut 'dark:opacity-5'.
         Ara en light mode Ã©s gairebÃ© imperceptible.
      */}
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-200 h-200 bg-primary/5 blur-[120px] rounded-full pointer-events-none opacity-10 dark:opacity-5" />

      <div className="container mx-auto px-6 md:px-10 lg:px-14 grid lg:grid-cols-2 gap-16 items-start relative z-10">
        <ContactInfo />
        <ContactForm />
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/diary/DiaryCard.tsx ===================

'use client';

import { useMotionValue, useTransform, motion, PanInfo, animate } from 'framer-motion';
import { useEffect, useState } from 'react';
import Image from 'next/image';
import { Cpu, ExternalLink, GripVertical } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Link } from '@/routing';
import { BlogPostDTO } from '@/types/models';

interface DiaryCardProps {
  post: BlogPostDTO;
  index: number;
  isFront: boolean;
  totalCards: number;
  currentCardNumber: number;
  onRemove: () => void;
}

export function DiaryCard({ post, index, isFront, onRemove, currentCardNumber, totalCards }: DiaryCardProps) {
  const [exitX, setExitX] = useState<number | null>(null);

  const x = useMotionValue(0);
  // ReduÃ¯m la rotaciÃ³ en mÃ²bil perquÃ¨ sigui mÃ©s estable
  const rotate = useTransform(x, [-200, 0, 200], [-5, 0, 5]); 
  const opacity = useTransform(x, [-300, -100, 0, 100, 300], [0, 1, 1, 1, 0]);

  const deterministicExitX = post.title.length % 2 === 0 ? 500 : -500;
  const visualIndex = Math.min(index, 2);

  // Simplifiquem posicions inicials

  const initialY = visualIndex * 10; 

  useEffect(() => {
    // NomÃ©s animem l'entrada si Ã©s la primera carta i estem en desktop (opcional)
    // O ho fem molt suau
    if (isFront) {
      const controls = animate(x, [0, 0], { duration: 0 }); // Evitem "salts" estranys al principi
      return () => controls.stop();
    }
  }, [isFront, x]);

  const handleDragEnd = (_: unknown, info: PanInfo) => {
    if (Math.abs(info.offset.x) > 100) {
      setExitX(info.offset.x > 0 ? 500 : -500);
      onRemove();
    }
  };

  return (
    <motion.div
      style={{
        x,
        rotate: isFront ? rotate : 0,
        zIndex: 100 - index,
        opacity: isFront ? opacity : 1,
        // Forcem l'Ãºs de la GPU per evitar pixelat
        transformPerspective: 1000,
        willChange: 'transform, opacity' 
      }}
      initial={{
        y: initialY + 10,
        opacity: 0,
        scale: 0.95
      }}
      animate={{ // Canviem whileInView per animate directe per evitar retards
        x: 0,
        y: visualIndex * 15, // SeparaciÃ³ vertical
        scale: 1 - (visualIndex * 0.05),
        opacity: index > 2 ? 0 : 1,
        rotate: index % 2 === 0 ? 1 : -1,
      }}
      transition={{ type: "spring", damping: 25, stiffness: 120 }} // MÃ©s rÃ pid i menys "bouncy"
      exit={{
        x: exitX ?? deterministicExitX,
        opacity: 0,
        scale: 0.8,
        transition: { duration: 0.3 }
      }}
      drag={isFront ? "x" : false}
      dragConstraints={{ left: -1000, right: 1000 }}
      dragElastic={0.1}
      onDragEnd={handleDragEnd}
      whileTap={{ cursor: "grabbing", scale: 1.01 }}
      className={`
        absolute top-0 w-full h-137.5 md:h-150 
        rounded-4xl 
        border border-border/50
        /* ğŸš€ OPTIMITZACIÃ“ CLAU: Fons sÃ²lid a mÃ²bil, Blur nomÃ©s a Desktop (md) */
        bg-card md:bg-card/90 md:backdrop-blur-xl 
        shadow-xl md:shadow-2xl 
        overflow-hidden flex flex-col origin-bottom
        ${isFront ? 'cursor-grab' : 'pointer-events-none brightness-95'}
        touch-none /* Important per evitar scroll de pÃ gina mentre arrossegues */
      `}
    >
      {/* ğŸ–¼ï¸ IMATGE */}
      <div className="h-[55%] relative bg-muted select-none pointer-events-none overflow-hidden">
        
        {/* Badge Tech */}
        {(post.totalReactions || 0) > 0 && (
          <div className="absolute top-3 left-3 z-20 flex items-center gap-1.5 
                        bg-black/60 backdrop-blur-md 
                        px-3 py-1 rounded-full 
                        text-cyan-400 text-xs font-bold font-mono border border-white/10">
            <Cpu className="w-3.5 h-3.5" />
            <span className="h-3 w-px bg-white/20 mx-0.5"></span>
            {post.totalReactions}
          </div>
        )}

        <div className="absolute top-4 right-4 z-20 bg-background/90 px-2.5 py-1 text-[10px] font-bold uppercase tracking-wider rounded-md shadow-sm">
          {post.date ? new Date(post.date).toLocaleDateString() : 'AVUI'}
        </div>

        {post.coverImage ? (
          <Image
            src={post.coverImage}
            alt={post.title}
            fill
            // ğŸš€ OPTIMITZACIÃ“: Carrega la imatge de la primera carta amb prioritat
            priority={isFront} 
            // ğŸš€ OPTIMITZACIÃ“: Mides correctes per no descarregar 4K en mÃ²bil
            sizes="(max-width: 768px) 100vw, 500px"
            className="object-cover transition-transform duration-700 hover:scale-105"
            draggable={false}
          />
        ) : (
          <div className="w-full h-full bg-secondary flex items-center justify-center">
            <span className="text-4xl font-black opacity-10">BLOG</span>
          </div>
        )}
        
        {/* Gradient simple en lloc de complex */}
        <div className="absolute inset-0 bg-linear-to-t from-background via-transparent to-transparent opacity-90" />
      </div>

      {/* ğŸ“ CONTINGUT */}
      <div className="h-[45%] p-5 md:p-8 flex flex-col justify-between relative">
        <div className="space-y-2 relative z-10">
          <div className="flex justify-between items-start">
             <span className="inline-flex px-2 py-0.5 rounded-md bg-primary/10 text-primary text-[10px] font-bold uppercase border border-primary/20">
               {post.tags[0] || 'GENERAL'}
             </span>
             {isFront && <GripVertical className="text-muted-foreground/30 w-5 h-5 animate-pulse" />}
          </div>

          <h3 className="text-xl md:text-2xl font-bold text-foreground leading-tight line-clamp-2">
            {post.title}
          </h3>

          <p className="text-muted-foreground text-xs md:text-sm line-clamp-3 leading-relaxed">
            {post.description}
          </p>
        </div>

        {/* BOTÃ“ */}
        <div className="pt-2 mt-auto">
          <Link href={`/blog/${post.slug}`} className="w-full block" onClick={(e) => e.stopPropagation()}>
            <Button
              className="w-full h-11 rounded-xl text-sm font-bold shadow-md"
              tabIndex={isFront ? 0 : -1}
              disabled={!isFront}
            >
              Llegir Article <ExternalLink className="w-4 h-4 ml-2" />
            </Button>
          </Link>

          <div className="flex justify-between items-center mt-3 px-1 text-[10px] text-muted-foreground font-medium">
             <span>{currentCardNumber} / {totalCards}</span>
             <span>{isFront ? "Llisca >>" : "En cua..."}</span>
          </div>
        </div>
      </div>
    </motion.div>
  );
}

// =================== FILE: src/components/landing/diary/DiaryEmptyState.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { RotateCcw, ArrowRight } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Link } from '@/routing';
import { useTranslations } from 'next-intl';

export function DiaryEmptyState({ onReset }: { onReset: () => void }) {
  const t = useTranslations('Diary.empty_state');

  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.9 }}
      animate={{ opacity: 1, scale: 1 }}
      className="absolute inset-0 flex flex-col items-center justify-center text-center p-8 bg-card/80 backdrop-blur-xl border border-border rounded-4xl shadow-2xl z-0"
    >
      <div className="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mb-6 animate-bounce">
        <span className="text-4xl">ğŸš€</span>
      </div>
      
      <h3 className="text-3xl font-bold text-foreground mb-3">{t('title')}</h3>
      
      <p className="text-muted-foreground mb-8 max-w-xs text-lg">
        {t('description')}
      </p>
      
      <div className="flex flex-col sm:flex-row gap-4 w-full justify-center">
        <Button variant="outline" onClick={onReset} className="h-12 px-6 rounded-full border-2">
          <RotateCcw className="w-4 h-4 mr-2" /> {t('btn_reset')}
        </Button>
        
        <Link href="/blog">
          <Button className="h-12 px-8 rounded-full shadow-lg shadow-primary/20">
            {t('btn_view_all')} <ArrowRight className="w-4 h-4 ml-2" />
          </Button>
        </Link>
      </div>
    </motion.div>
  );
}

// =================== FILE: src/components/landing/diary/DiaryStack.tsx ===================

'use client';

import { useState } from 'react';
import { AnimatePresence } from 'framer-motion';
import { BlogPostDTO } from '@/types/models';
import { DiaryCard } from './DiaryCard';
import { DiaryEmptyState } from './DiaryEmptyState';

export function DiaryStack({ posts }: { posts: BlogPostDTO[] }) {
  const [currentIndex, setCurrentIndex] = useState(0);

  const removeCard = () => {
    setCurrentIndex((prev) => prev + 1);
  };

  const resetStack = () => setCurrentIndex(0);

  // Agafem els 4 segÃ¼ents per tenir buffer visual
  const visiblePosts = posts.slice(currentIndex, currentIndex + 4); 

  return (
    // overflow-visible Ã©s CRÃTIC perquÃ¨ les cartes puguin "volar" des de fora
    <div className="relative w-full h-187.5 flex items-center justify-center overflow-visible my-8">
      
   

      {/* CONTENIDOR DE LA PILA */}
      <div className="relative w-full max-w-lg h-150 z-10 perspective-1000">
        <AnimatePresence mode="popLayout">
          
          {currentIndex >= posts.length ? (
            <DiaryEmptyState key="empty" onReset={resetStack} />
          ) : (
            visiblePosts.map((post, i) => {
              const stackIndex = i; 
              
              return (
                <DiaryCard
                  key={post.slug}
                  post={post}
                  index={stackIndex}
                  isFront={stackIndex === 0}
                  totalCards={posts.length}
                  currentCardNumber={currentIndex + stackIndex + 1}
                  onRemove={removeCard}
                />
              );
            }).reverse() 
          )}
        </AnimatePresence>
      </div>
    </div>
  );
}

// =================== FILE: src/components/landing/HeroSection.tsx ===================

'use client';

import { useState } from 'react';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { PlayCircle } from 'lucide-react';
import Link from 'next/link';
import { useTranslations } from 'next-intl';

export function HeroSection() {
  const t = useTranslations('Hero');
  const [isVideoLoaded, setIsVideoLoaded] = useState(false);
  // Estat per controlar si la imatge falla

  const YOUTUBE_VIDEO_ID = "tqMcdP_WiyA";

  return (
    <section id="inici" className="pt-32 pb-20 min-h-screen flex items-center hero-pattern overflow-hidden relative">
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-200 h-200 bg-primary/5 rounded-full blur-[120px] -z-10" />

      <div className="container mx-auto px-6 md:px-10 lg:px-14 grid lg:grid-cols-2 gap-16 items-center">

        {/* COLUMNA ESQUERRA (IGUAL) */}
        <motion.div
          initial={{ opacity: 0, x: -50 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.8 }}
        >
          <h1 className="text-5xl lg:text-7xl font-bold mb-6 leading-tight">
            {t('title_start')} <span className="text-transparent bg-clip-text bg-linear-to-r from-primary to-purple-400">{t('title_highlight_1')}</span>.<br />
            {t('title_middle')} <span className="text-foreground">{t('title_highlight_2')}</span>.
          </h1>
          <p className="text-xl text-muted-foreground mb-8 leading-relaxed max-w-lg">
            {t('subtitle')}
          </p>
          <div className="flex flex-col sm:flex-row gap-4">
            <Link href="#contacte">
              <Button size="lg">{t('cta_primary')}</Button>
            </Link>
            <Link href="#audit">
              <Button variant="outline" size="lg">{t('cta_secondary')}</Button>
            </Link>
          </div>
        </motion.div>

        {/* COLUMNA DRETA: Marc del VÃ­deo */}
        <motion.div
          initial={{ opacity: 0, x: 50 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.8, delay: 0.2 }}
          className="relative"
        >
          {/* CANVI CLAU: Hem tret 'aspect-video' d'aquÃ­. 
            Ara deixem que el contingut dicti l'alÃ§ada.
          */}
          <div className="relative w-full bg-card rounded-xl border border-border shadow-2xl overflow-hidden group flex flex-col">

            {/* BARRA SUPERIOR */}
            <div className="h-8 shrink-0 border-b border-border bg-muted/50 flex items-center px-4 gap-2 z-20 relative select-none">
              <div className="w-2.5 h-2.5 rounded-full bg-red-500/50"></div>
              <div className="w-2.5 h-2.5 rounded-full bg-yellow-500/50"></div>
              <div className="w-2.5 h-2.5 rounded-full bg-green-500/50"></div>

            </div>

            {/* CANVI CLAU 2: Posem 'aspect-video' AQUÃ.
               AixÃ² forÃ§a que l'Ã rea visual sigui exactament 16:9, perfecte per YouTube i fotos.
            */}
            <div className="relative w-full aspect-video bg-black">

              {!isVideoLoaded ? (
                <button
                  onClick={() => setIsVideoLoaded(true)}
                  className="relative w-full h-full group cursor-pointer block focus:outline-none"
                  aria-label="Reproduir vÃ­deo"
                >

                  <div className="absolute inset-0 bg-linear-to-br from-indigo-900 via-slate-900 to-black flex items-center justify-center">
                    <span className="text-white/20 font-bold text-4xl tracking-widest">DIGITAI STUDIOS</span>
                  </div>


                  {/* Overlay del botÃ³ Play */}
                  <div className="absolute inset-0 flex items-center justify-center bg-black/20 group-hover:bg-black/10 transition-colors z-10">
                    <PlayCircle className="w-20 h-20 text-white/90 drop-shadow-2xl scale-100 group-hover:scale-110 transition-transform duration-300" />
                  </div>
                </button>
              ) : (
                <iframe
                  src={`https://www.youtube-nocookie.com/embed/${YOUTUBE_VIDEO_ID}?autoplay=1&mute=0&rel=0&modestbranding=1&controls=1`}
                  title="DigitAI Hero Video"
                  frameBorder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowFullScreen
                  className="absolute inset-0 w-full h-full"
                />
              )}
            </div>
          </div>



        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/LatestPostsSection.tsx ===================

import { postService } from '@/services/container';
import { Link } from '@/routing';
import { ArrowRight, Sparkles } from 'lucide-react';
import { getTranslations } from 'next-intl/server';
import { DiaryStack } from './diary/DiaryStack';
import { Reveal } from '@/components/animations/Reveal';

export async function LatestPostsSection() {
  const posts = await postService.getLatestPosts();
  const latestPosts = posts.slice(0, 5); 
  const t = await getTranslations('LatestPosts');

  if (latestPosts.length === 0) return null;

  return (
    <section id="LatestPostsSection" className="py-16 md:py-24 bg-background relative overflow-hidden">
      
      {/* ğŸš€ OPTIMITZACIÃ“: Fons nomÃ©s visible en md+ o amb opacity molt baixa en mÃ²bil */}
      <div className="hidden md:block absolute top-1/2 left-0 -translate-y-1/2 w-125 h-125 bg-primary/10 blur-[100px] rounded-full pointer-events-none opacity-50" />
      <div className="hidden md:block absolute bottom-0 right-0 w-100 h-100 bg-blue-500/10 dark:bg-blue-500/20 blur-[120px] rounded-full pointer-events-none opacity-40" />
      
      {/* Grid pattern molt lleuger */}
      <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] bg-[size:40px_40px] opacity-[0.02] pointer-events-none" />

      <div className="container mx-auto px-6 md:px-10 lg:px-14 relative z-10">
        <div className="grid lg:grid-cols-2 gap-12 lg:gap-16 items-center">
          
          {/* COLUMNA ESQUERRA */}
          <div className="text-left space-y-6">
          
      
             <Reveal delay={0.1} direction="left">
              <h2 className="text-3xl md:text-5xl font-black text-foreground leading-tight tracking-tight">
                {t('title_prefix')} <br />
                <span className="text-transparent bg-clip-text bg-linear-to-r from-primary to-blue-500">
                  {t('title_highlight')}
                </span>
              </h2>
            </Reveal>
            <Reveal delay={0.2} direction="left">
              <p className="text-lg text-muted-foreground max-w-md leading-relaxed">
                {t('description')}
              </p>
            </Reveal>

             {/* Avatars i CTA (iguals) */}
             <Reveal delay={0.3} direction="left">
               {/* ... Avatars code ... */}
               <div className="flex items-center gap-4 pt-2">
                 <div className="flex -space-x-4 rtl:space-x-reverse">
                   {[...Array(4)].map((_, i) => (
                      <div key={i} className="w-10 h-10 rounded-full border-2 border-background bg-muted flex items-center justify-center overflow-hidden relative shadow-sm">
                         <img src={`https://api.dicebear.com/7.x/notionists/svg?seed=${i}&backgroundColor=transparent`} alt="avatar" loading="lazy" className="w-full h-full object-cover"/>
                      </div>
                   ))}
                 </div>
                 <div className="text-sm text-muted-foreground font-medium">
                   {t.rich('read_by', { strong: (chunks) => <span className="font-bold text-foreground">{chunks}</span> })}
                 </div>
               </div>
            </Reveal>
            
            <Reveal delay={0.4} direction="left">
               <div className="pt-4">
                  <Link href="/blog" className="group inline-flex items-center gap-2 text-foreground font-bold hover:text-primary transition-colors border-b-2 border-transparent hover:border-primary pb-0.5">
                    {t('cta')} <ArrowRight className="w-4 h-4 transition-transform group-hover:translate-x-1" />
                  </Link>
               </div>
            </Reveal>
          </div>

          {/* COLUMNA DRETA: Stack de Posts */}
          {/* ğŸš€ IMPORTANT: width="100%" i sense overflow ocult */}
          <div className="w-full min-h-137.5 md:min-h-150 flex items-center justify-center lg:justify-end">
             {/* No animem tot el bloc amb Reveal perquÃ¨ ja s'animen les cartes, i dues animacions sumades = lag */}
             <div className="relative w-full">
                <DiaryStack posts={latestPosts} />
             </div>
          </div>

        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/ProblemSolutionsSection.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { Calendar, BarChart3, Smartphone, X, Store, CheckCircle2 } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function ProblemSolutionSection() {
  const t = useTranslations('ProblemSolution');

  return (
    <section className="py-10 container mx-auto px-4 relative overflow-hidden transition-colors duration-300">
      
      <div className="grid lg:grid-cols-2 gap-16 items-center">
        
        {/* 1. TEXT NARRATIU */}
        <motion.div 
          initial={{ opacity: 0, x: -20 }}
          whileInView={{ opacity: 1, x: 0 }}
          viewport={{ once: true }}
        >
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold mb-6 uppercase tracking-wider">
             {t('badge')}
          </div>

          <h2 className="text-4xl lg:text-5xl font-bold mb-6 text-foreground leading-tight">
            {t('title_prefix')} <span className="gradient-text">{t('title_highlight')}</span>, <br />
            {t('title_suffix')}
          </h2>
          
          <p className="text-muted-foreground text-lg mb-8 leading-relaxed">
            {t('description_problem')}
            <br /><br />
            {t.rich('description_solution', {
              strong: (chunks) => <strong className="text-foreground font-semibold">{chunks}</strong>
            })}
          </p>

          <ul className="space-y-4 mb-8">
            {[
              t('benefits.appointments'),
              t('benefits.ecommerce'),
              t('benefits.pwa')
            ].map((item, i) => (
              <li key={i} className="flex items-center gap-3 text-slate-600 dark:text-slate-300 font-medium">
                <CheckCircle2 className="w-5 h-5 text-primary" /> {item}
              </li>
            ))}
          </ul>
        </motion.div>
        
        {/* 2. COMPARATIVA VISUAL */}
        <div className="relative h-[450px] lg:h-[500px] flex items-center justify-center perspective-1000">
          
          {/* --- CARD 1: EL PROBLEMA ("Web Aparador") --- */}
          <motion.div 
            // AnimaciÃ³ suau d'entrada
            initial={{ opacity: 0, rotate: -6, x: -20 }}
            whileInView={{ opacity: 1, rotate: -6, x: -35 }}
            viewport={{ once: true }}
            transition={{ duration: 0.8 }}
            // MIDES: 
            // - MÃ²bil: w-[260px] (lleugerament mÃ©s petit)
            // - Escriptori (md+): w-[280px] (Mida ORIGINAL)
            className="absolute left-4 md:left-0 w-[260px] md:w-[280px] p-6 rounded-2xl border border-slate-200 dark:border-white/5 bg-slate-100/80 dark:bg-[#0f111a]/80 backdrop-blur-sm z-0 grayscale opacity-70"
          >
             <div className="flex items-center gap-2 mb-4 text-slate-500">
                <Store className="w-5 h-5" />
                <span className="font-bold text-sm">{t('visual.problem_card.title')}</span>
             </div>
             <div className="space-y-3">
                <div className="flex items-center justify-between p-3 rounded bg-white dark:bg-white/5 border border-slate-200 dark:border-white/5 shadow-sm dark:shadow-none">
                   <span className="text-xs text-slate-500">{t('visual.problem_card.item1')}</span>
                   <X className="w-4 h-4 text-red-500" />
                </div>
                <div className="flex items-center justify-between p-3 rounded bg-white dark:bg-white/5 border border-slate-200 dark:border-white/5 shadow-sm dark:shadow-none">
                   <span className="text-xs text-slate-500">{t('visual.problem_card.item2')}</span>
                   <X className="w-4 h-4 text-red-500" />
                </div>
                <div className="flex items-center justify-between p-3 rounded bg-white dark:bg-white/5 border border-slate-200 dark:border-white/5 shadow-sm dark:shadow-none">
                   <span className="text-xs text-slate-500">{t('visual.problem_card.item3')}</span>
                   <X className="w-4 h-4 text-red-500" />
                </div>
             </div>
          </motion.div>

          {/* --- CARD 2: LA SOLUCIÃ“ (Ecosistema DigitAI) --- */}
          <motion.div
            // ANIMACIÃ“: Surt de darrere de l'altra targeta
            initial={{ opacity: 0, scale: 0.9, x: -40, rotate: -3 }}
            whileInView={{ opacity: 1, scale: 1, x: 20, rotate: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.8, delay: 0.2, type: "spring", bounce: 0.4 }}
            
            // MIDES:
            // - MÃ²bil: w-[300px] (Ajustat per pantalles petites)
            // - Escriptori (md+): w-[340px] (Mida ORIGINAL)
            className="relative z-20 w-[300px] md:w-[340px] bg-[#1a1d2d] border border-white/10 rounded-2xl shadow-2xl overflow-hidden"
          >
            <div className="h-2 w-full bg-linear-to-r from-[#06b6d4] via-[#3b82f6] to-[#a855f7]"></div>

            <div className="p-6">
              <h3 className="text-lg font-bold text-white mb-1">{t('visual.solution_card.title')}</h3>
              <p className="text-xs text-slate-400 mb-6">{t('visual.solution_card.subtitle')}</p>

              <div className="space-y-4">

                <div className="flex items-center gap-4 p-3 rounded-xl bg-primary/10 border border-primary/20">
                  <div className="p-2 bg-primary/20 rounded-lg text-primary">
                    <Calendar className="w-5 h-5" />
                  </div>
                  <div>
                    <div className="text-sm font-bold text-white">{t('visual.solution_card.widget1_title')}</div>
                    <div className="text-xs text-slate-400">{t('visual.solution_card.widget1_desc')}</div>
                  </div>
                </div>

                <div className="flex items-center gap-4 p-3 rounded-xl bg-blue-500/10 border border-blue-500/20">
                  <div className="p-2 bg-blue-500/20 rounded-lg text-blue-400">
                    <BarChart3 className="w-5 h-5" />
                  </div>
                  <div>
                    <div className="text-sm font-bold text-white">{t('visual.solution_card.widget2_title')}</div>
                    <div className="text-xs text-slate-400">{t('visual.solution_card.widget2_desc')}</div>
                  </div>
                </div>

                <div className="flex items-center gap-4 p-3 rounded-xl bg-cyan-500/10 border border-cyan-500/20">
                  <div className="p-2 bg-cyan-500/20 rounded-lg text-cyan-400">
                    <Smartphone className="w-5 h-5" />
                  </div>
                  <div>
                    <div className="text-sm font-bold text-white">{t('visual.solution_card.widget3_title')}</div>
                    <div className="text-xs text-slate-400">{t('visual.solution_card.widget3_desc')}</div>
                  </div>
                </div>

              </div>
            </div>

            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-linear-to-b from-primary/5 to-transparent pointer-events-none" />
          </motion.div>
        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/ProductTeaser.tsx ===================

'use client';

import { ArrowRight, ExternalLink } from 'lucide-react';
import Link from 'next/link';
import Image from 'next/image';
import { motion } from 'framer-motion';
import { useTranslations } from 'next-intl';

import ribotFlowImg from '@/assets/images/ribotflow.png';
import salutFlowImg from '@/assets/images/salutflow.png';

export function ProductTeaser() {
    const t = useTranslations('ProductTeaser');

    return (
        <section className="py-24 container mx-auto px-6 md:px-10 lg:px-14">

            {/* FONS CARD:
                1. Light: 'bg-linear-to-br from-slate-50 via-white to-slate-50' (Molt neutre, sense blau).
                2. Dark: 'dark:from-zinc-900 dark:via-zinc-950 dark:to-zinc-900'. (Negre net, sense primary/10).
                3. Borde: MÃ©s suau.
            */}
            <div className="rounded-3xl bg-linear-to-br from-slate-50 via-white to-slate-50 dark:from-zinc-900 dark:via-zinc-950 dark:to-zinc-900 border border-slate-200 dark:border-white/10 p-8 md:p-12 overflow-hidden relative transition-colors duration-300 shadow-2xl shadow-slate-200/50 dark:shadow-none">

                {/* BLOB FIX: ReduÃ¯t opacitat drÃ sticament (40% -> 10% en dark) */}
                <div className="absolute top-0 right-0 w-125 h-125 bg-blue-400/5 dark:bg-primary/5 blur-[100px] rounded-full opacity-30 dark:opacity-10 pointer-events-none"></div>

                <div className="grid lg:grid-cols-2 gap-16 items-center relative z-10">

                    {/* TEXT CONTENT */}
                    <div>
                        <h2 className="text-3xl md:text-5xl font-bold text-foreground mb-6 leading-tight">
                            {t('title_prefix')} <br />
                            <span className="text-transparent bg-clip-text bg-linear-to-r from-primary to-purple-400">
                                {t('title_highlight')}
                            </span>
                        </h2>

                        <p className="text-slate-600 dark:text-slate-400 text-lg mb-8 leading-relaxed">
                            {t.rich('description', {
                                strong: (chunks) => <strong>{chunks}</strong>,
                                br: () => <br />
                            })}
                        </p>

                        <Link href="/projectes" className="inline-flex items-center font-bold text-foreground hover:text-primary transition-colors group">
                            {t('cta')}
                            <ArrowRight className="ml-2 w-4 h-4 group-hover:translate-x-1 transition-transform" />
                        </Link>
                    </div>

                    {/* MOCKUP VISUAL (Sense canvis de lÃ²gica, nomÃ©s colors de fons ajustats per no ser liles) */}
                    <div className="relative h-100 w-full flex items-center justify-center perspective-1000">

                        {/* CARD 1: RIBOTFLOW */}
                        <motion.div
                            initial={{ opacity: 0, x: -20, rotate: -5 }}
                            whileInView={{ opacity: 1, x: 0, rotate: -6 }}
                            viewport={{ once: true }}
                            // Fons ajustat: dark:bg-[#0f111a] -> dark:bg-zinc-900
                            className="absolute left-4 top-10 w-3/4 h-64 bg-white dark:bg-zinc-900 rounded-xl border border-slate-200 dark:border-white/10 shadow-xl z-10 overflow-hidden"
                        >
                            <div className="h-12 border-b border-slate-100 dark:border-white/5 flex items-center justify-between px-4 bg-slate-50/50 dark:bg-white/5">
                                <div className="relative h-12 w-34">
                                    <Image src={ribotFlowImg} alt="RibotFlow Logo" fill className="object-contain object-left" placeholder="blur" />
                                </div>
                                <div className="flex gap-1.5">
                                    <div className="w-2 h-2 rounded-full bg-slate-300 dark:bg-white/20"></div>
                                    <div className="w-2 h-2 rounded-full bg-slate-300 dark:bg-white/20"></div>
                                </div>
                            </div>
                            <div className="p-4 space-y-3 opacity-50 grayscale hover:grayscale-0 transition-all duration-500">
                                <div className="flex gap-4">
                                    <div className="w-1/3 h-20 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10"></div>
                                    <div className="w-2/3 h-20 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10"></div>
                                </div>
                                <div className="h-16 w-full rounded-lg bg-slate-50 dark:bg-white/5"></div>
                            </div>
                        </motion.div>

                        {/* CARD 2: SALUTFLOW */}
                        <motion.div
                            initial={{ opacity: 0, x: 20, rotate: 5, y: 20 }}
                            whileInView={{ opacity: 1, x: 20, rotate: 3, y: 40 }}
                            viewport={{ once: true }}
                            transition={{ delay: 0.2 }}
                            // Fons ajustat
                            className="absolute right-4 top-24 w-3/4 h-64 bg-white dark:bg-zinc-900 rounded-xl border border-slate-200 dark:border-white/10 shadow-2xl z-20 overflow-hidden backdrop-blur-sm"
                        >
                            <div className="h-12 border-b border-slate-100 dark:border-white/5 flex items-center justify-between px-4 bg-slate-50/50 dark:bg-white/5">
                                <div className="relative h-22 w-48">
                                    <Image src={salutFlowImg} alt="SalutFlow Logo" fill className="object-contain object-left" placeholder="blur" />
                                </div>
                                <ExternalLink className="w-4 h-4 text-slate-400" />
                            </div>
                            <div className="p-4 space-y-3">
                                <div className="flex justify-between items-center mb-2">
                                    <div className="h-4 w-1/3 bg-blue-100 dark:bg-primary/20 rounded"></div>
                                    <div className="h-8 w-8 rounded-full bg-slate-100 dark:bg-white/10"></div>
                                </div>
                                <div className="space-y-2">
                                    <div className="h-10 w-full rounded border-l-4 border-blue-500 bg-slate-50 dark:bg-white/5 flex items-center px-3">
                                        <div className="h-2 w-1/2 bg-slate-200 dark:bg-white/20 rounded"></div>
                                    </div>
                                    <div className="h-10 w-full rounded border-l-4 border-green-500 bg-slate-50 dark:bg-white/5 flex items-center px-3">
                                        <div className="h-2 w-2/3 bg-slate-200 dark:bg-white/20 rounded"></div>
                                    </div>
                                    <div className="h-10 w-full rounded border-l-4 border-purple-500 bg-slate-50 dark:bg-white/5 flex items-center px-3">
                                        <div className="h-2 w-1/3 bg-slate-200 dark:bg-white/20 rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </motion.div>
                    </div>
                </div>
            </div>
        </section>
    );
}

// =================== FILE: src/components/landing/services/mockups/AppMockup.tsx ===================

'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { useState, useEffect } from 'react';
import { Send, Download, CheckCircle2, MessageSquare } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function AppMockup() {
  const t = useTranslations('Solutions.app_mockup');
  const [step, setStep] = useState(0);

  // Cicle d'animaciÃ³: InstalÂ·laciÃ³ (3s) -> Xat (5s) -> Ãˆxit (3s)
  useEffect(() => {
    const times = [3000, 5000, 3000];
    let currentStep = 0;

    const cycle = () => {
      setTimeout(() => {
        currentStep = (currentStep + 1) % 3;
        setStep(currentStep);
        cycle();
      }, times[currentStep]);
    };

    cycle();
    return () => {}; 
  }, []);

  return (
    <div className="grow relative flex justify-center mt-6 items-end h-80">
      
      {/* ğŸ“± MARC DEL MÃ’BIL (MÃ©s gran: w-48) */}
      <div className="w-48 bg-slate-900 border-[6px] border-slate-800 rounded-[2.5rem] relative z-10 overflow-hidden shadow-2xl h-full flex flex-col">
        
        {/* Dynamic Island */}
        <div className="absolute top-2 left-1/2 -translate-x-1/2 w-16 h-5 bg-black rounded-full z-40 flex items-center justify-center gap-2 pointer-events-none">
            <div className="w-1.5 h-1.5 rounded-full bg-slate-800/50"></div>
            <div className="w-1.5 h-1.5 rounded-full bg-blue-500/50 animate-pulse"></div>
        </div>

        {/* Pantalla (Contingut Canviant) */}
        <div className="flex-1 bg-slate-50 dark:bg-[#0f111a] relative overflow-hidden flex flex-col">
            
            {/* ğŸ”” PUSH NOTIFICATION (Integrada dins la pantalla per evitar talls) */}
            <AnimatePresence>
                {step === 1 && (
                    <motion.div 
                        initial={{ y: -50, opacity: 0 }}
                        animate={{ y: 0, opacity: 1 }}
                        exit={{ y: -50, opacity: 0 }}
                        className="absolute top-8 inset-x-2 z-30 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md p-2 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 flex items-center gap-2"
                    >
                        <div className="bg-green-500 w-7 h-7 rounded-full flex items-center justify-center text-white shrink-0">
                            <Send className="w-3.5 h-3.5" />
                        </div>
                        <div className="text-[10px] leading-tight overflow-hidden">
                            <div className="font-bold text-slate-800 dark:text-white truncate">{t('notif_title')}</div>
                            <div className="text-slate-500 truncate">{t('notif_msg')}</div>
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>

            <AnimatePresence mode="wait">
                
                {/* --- FASE 1: INSTALÂ·LACIÃ“ PWA --- */}
                {step === 0 && (
                    <motion.div 
                        key="install"
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, y: -20 }}
                        className="h-full flex flex-col items-center justify-center p-4 text-center space-y-4"
                    >
                        <div className="w-16 h-16 bg-linear-to-br from-cyan-400 to-blue-600 rounded-2xl shadow-lg flex items-center justify-center mb-2">
                            <span className="text-2xl font-bold text-white">Go</span>
                        </div>
                        <div>
                            <h4 className="font-bold text-slate-800 dark:text-white text-sm">{t('app_name')}</h4>
                            <p className="text-[10px] text-slate-500">{t('app_category')}</p>
                        </div>
                        
                        <motion.div 
                            initial={{ y: 20, opacity: 0 }}
                            animate={{ y: 0, opacity: 1 }}
                            transition={{ delay: 0.5 }}
                            className="w-full bg-blue-600 text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-blue-500/30 shadow-lg"
                        >
                            <Download className="w-3 h-3" /> {t('btn_install')}
                        </motion.div>
                        
                        {/* Cursor simulat */}
                        <motion.div 
                            initial={{ x: 20, y: 20, opacity: 0 }}
                            animate={{ x: 0, y: -15, opacity: 1 }}
                            transition={{ delay: 1, duration: 0.8 }}
                            className="absolute pointer-events-none"
                        >
                            <div className="w-4 h-4 bg-slate-400/50 rounded-full border border-white shadow-sm"></div>
                        </motion.div>
                    </motion.div>
                )}

                {/* --- FASE 2: XAT INTERACTIU --- */}
                {step === 1 && (
                    <motion.div 
                        key="chat"
                        className="h-full flex flex-col pt-8" // pt-8 per deixar espai a la dynamic island
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                    >
                        {/* Header Xat */}
                        <div className="h-10 border-b border-slate-100 dark:border-slate-800 flex items-center px-4 justify-between shrink-0">
                            <div className="flex items-center gap-2">
                                <div className="w-5 h-5 rounded-full bg-cyan-100 flex items-center justify-center text-[10px]">ğŸ¤–</div>
                                <span className="text-[10px] font-bold text-slate-700 dark:text-slate-200">{t('chat_header')}</span>
                            </div>
                        </div>

                        {/* Missatges */}
                        <div className="flex-1 p-3 space-y-3 overflow-hidden flex flex-col justify-end pb-4">
                            <motion.div 
                                initial={{ x: -20, opacity: 0 }}
                                animate={{ x: 0, opacity: 1 }}
                                className="bg-slate-200 dark:bg-slate-800 self-start rounded-2xl rounded-bl-none px-3 py-2 text-[10px] max-w-[85%] text-slate-700 dark:text-slate-300"
                            >
                                {t('chat_msg_bot')}
                            </motion.div>

                            <motion.div 
                                initial={{ x: 20, opacity: 0 }}
                                animate={{ x: 0, opacity: 1 }}
                                transition={{ delay: 1 }}
                                className="bg-blue-600 text-white self-end rounded-2xl rounded-br-none px-3 py-2 text-[10px] max-w-[85%] shadow-md"
                            >
                                {t('chat_msg_user')}
                            </motion.div>

                            <motion.div 
                                initial={{ x: -20, opacity: 0 }}
                                animate={{ x: 0, opacity: 1 }}
                                transition={{ delay: 2.5 }}
                                className="bg-slate-200 dark:bg-slate-800 self-start rounded-2xl rounded-bl-none px-3 py-2 text-[10px] max-w-[85%] text-slate-700 dark:text-slate-300"
                            >
                                <div className="flex gap-1">
                                    <span className="animate-bounce">.</span>
                                    <span className="animate-bounce delay-75">.</span>
                                    <span className="animate-bounce delay-150">.</span>
                                </div>
                            </motion.div>
                        </div>
                    </motion.div>
                )}

                {/* --- FASE 3: ÃˆXIT / CONFIRMACIÃ“ --- */}
                {step === 2 && (
                    <motion.div 
                        key="success"
                        initial={{ scale: 0.8, opacity: 0 }}
                        animate={{ scale: 1, opacity: 1 }}
                        className="h-full flex flex-col items-center justify-center bg-green-500 text-white p-6 text-center"
                    >
                        <motion.div 
                            initial={{ scale: 0 }}
                            animate={{ scale: 1 }}
                            transition={{ type: "spring" }}
                            className="w-16 h-16 bg-white text-green-500 rounded-full flex items-center justify-center mb-4 shadow-xl"
                        >
                            <CheckCircle2 className="w-8 h-8" strokeWidth={3} />
                        </motion.div>
                        <h4 className="font-bold text-lg mb-1">{t('success_title')}</h4>
                        <p className="text-xs opacity-90">{t('success_msg')}</p>
                        
                        <div className="mt-6 bg-white/20 backdrop-blur-sm rounded-lg p-2 w-full flex items-center gap-2">
                            <MessageSquare className="w-4 h-4" />
                            <span className="text-[10px] font-mono">ID: #8392A</span>
                        </div>
                    </motion.div>
                )}

            </AnimatePresence>
        </div>

        {/* Navigation Bar (Fals) */}
        <div className="h-1 bg-black w-1/3 mx-auto rounded-full mb-2 opacity-50 absolute bottom-1 left-1/2 -translate-x-1/2 z-50"></div>
      </div>
    </div>
  );
}

// =================== FILE: src/components/landing/services/mockups/AutomationFlow.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { MessageSquare, Zap, Database, Mail, Slack, BrainCircuit, CheckCircle2, LucideIcon } from 'lucide-react';

// 1. Definim els tipus per a les Props
interface NodeProps {
    icon: LucideIcon;
    color: 'blue' | 'purple' | 'indigo' | 'orange' | 'green';
    label: string;
    delay: number;
    cycle: number;
    pulse?: boolean;
    isFinal?: boolean;
}

export function AutomationFlow() {
  const cycle = 4; 

  return (
    // CONTENIDOR ADAPTABLE: 
    // Ajustem l'alÃ§ada: h-40 en mÃ²bil (mÃ©s baixet) i h-64 en escriptori.
    <div className="h-40 sm:h-56 md:h-64 w-full mt-4 relative bg-slate-50/80 dark:bg-[#0f111a] rounded-xl border border-slate-200 dark:border-white/10 overflow-hidden shadow-inner dark:shadow-2xl group flex items-center justify-center transition-colors duration-500">
      
      {/* FONS TÃˆCNIC (Grid adaptable) */}
      <div className="absolute inset-0 bg-[linear-gradient(to_right,#8080800a_1px,transparent_1px),linear-gradient(to_bottom,#8080800a_1px,transparent_1px)] bg-[size:24px_24px]"></div>
      <div className="absolute inset-0 bg-gradient-to-tr from-purple-500/0 via-transparent to-blue-500/0 dark:from-purple-500/5 dark:to-blue-500/5 pointer-events-none"></div>

      {/* ğŸ”´ TRUC MÃ€GIC RESPONSIVE: 
          Creem un contenidor de mida FIXA (500x200) que contÃ© tot el diagrama perfecte.
          DesprÃ©s, usem 'scale' per fer-lo petit en mÃ²bils sense trencar la posiciÃ³ dels elements.
      */}
      <div className="relative w-[500px] h-[200px] shrink-0 scale-[0.55] sm:scale-75 md:scale-90 lg:scale-100 transition-transform duration-500 origin-center flex items-center justify-center">

          {/* --- LAYER DE CONNEXIONS (SVG) --- */}
          {/* Ara l'SVG ocupa exactament l'espai del contenidor escalat */}
          <svg className="absolute inset-0 w-full h-full pointer-events-none overflow-visible z-0">
            <defs>
                <linearGradient id="flowGradient" x1="0" y1="0" x2="1" y2="0">
                    <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.5" />
                    <stop offset="100%" stopColor="#a855f7" stopOpacity="0.5" />
                </linearGradient>
            </defs>

            {/* LÃNIES ESTRUCTURALS ADAPTABLES */}
            <g className="stroke-slate-300 dark:stroke-slate-700 transition-colors duration-500">
                <path d="M 50 100 L 150 100" strokeWidth="2" /> {/* Start -> AI */}
                <path d="M 150 100 C 200 100, 200 50, 280 50" strokeWidth="2" fill="none" /> {/* AI -> Top */}
                <path d="M 150 100 C 200 100, 200 150, 280 150" strokeWidth="2" fill="none" /> {/* AI -> Bottom */}
                <path d="M 280 150 L 380 150" strokeWidth="2" /> {/* Slack -> Mail */}
            </g>

            {/* --- PARTÃCULES DE DADES --- */}
            
            {/* P1: Trigger -> AI */}
            <motion.circle r="4" fill="#3b82f6"
                animate={{ offsetDistance: ["0%", "100%"], opacity: [0, 1, 1, 0] }}
                transition={{ duration: cycle * 0.25, ease: "linear", repeat: Infinity, repeatDelay: cycle * 0.75 }}
                style={{ offsetPath: "path('M 50 100 L 150 100')" }}
            />

            {/* P2: AI -> Database */}
            <motion.circle r="4" fill="#a855f7"
                animate={{ offsetDistance: ["0%", "100%"], opacity: [0, 1, 1, 0] }}
                transition={{ duration: cycle * 0.25, ease: "linear", repeat: Infinity, delay: cycle * 0.25, repeatDelay: cycle * 0.75 }}
                style={{ offsetPath: "path('M 150 100 C 200 100, 200 50, 280 50')" }}
            />

            {/* P3: AI -> Slack */}
            <motion.circle r="4" fill="#a855f7"
                animate={{ offsetDistance: ["0%", "100%"], opacity: [0, 1, 1, 0] }}
                transition={{ duration: cycle * 0.25, ease: "linear", repeat: Infinity, delay: cycle * 0.25, repeatDelay: cycle * 0.75 }}
                style={{ offsetPath: "path('M 150 100 C 200 100, 200 150, 280 150')" }}
            />

            {/* P4: Slack -> Mail */}
            <motion.circle r="4" fill="#22c55e"
                animate={{ offsetDistance: ["0%", "100%"], opacity: [0, 1, 1, 0] }}
                transition={{ duration: cycle * 0.25, ease: "linear", repeat: Infinity, delay: cycle * 0.5, repeatDelay: cycle * 0.75 }}
                style={{ offsetPath: "path('M 280 150 L 380 150')" }}
            />
          </svg>


          {/* --- NODES (Posicionats en absolut dins del contenidor de 500x200) --- */}
          <div className="absolute inset-0">
            
            {/* NODE 1: TRIGGER (Webhook) */}
            <div className="absolute left-[30px] top-[80px]">
                <Node icon={MessageSquare} color="blue" label="Webhook" delay={0} cycle={cycle} />
            </div>

            {/* NODE 2: BRAIN (AI Processing) */}
            <div className="absolute left-[130px] top-[80px]">
                <Node icon={BrainCircuit} color="purple" label="AI Analyze" delay={cycle * 0.25} cycle={cycle} pulse />
            </div>

            {/* NODE 3: DATABASE (Storage) */}
            <div className="absolute left-[260px] top-[30px]">
                <Node icon={Database} color="indigo" label="Store Data" delay={cycle * 0.5} cycle={cycle} />
            </div>

            {/* NODE 4: SLACK (Notify Team) */}
            <div className="absolute left-[260px] top-[130px]">
                <Node icon={Slack} color="orange" label="Notify Team" delay={cycle * 0.5} cycle={cycle} />
            </div>

            {/* NODE 5: MAIL (Confirm Client) */}
            <div className="absolute left-[360px] top-[130px]">
                <Node icon={Mail} color="green" label="Send Email" delay={cycle * 0.75} cycle={cycle} isFinal />
            </div>

          </div>
      </div>
    </div>
  );
}

// --- COMPONENT AUXILIAR PER ALS NODES ---

function Node({ icon: Icon, color, label, delay, cycle, isFinal }: NodeProps) {
    const colors: Record<NodeProps['color'], string> = {
        blue:   "bg-white border-blue-200 text-blue-600 shadow-sm dark:bg-blue-950/50 dark:border-blue-500/50 dark:text-blue-400 dark:shadow-blue-500/20",
        purple: "bg-white border-purple-200 text-purple-600 shadow-sm dark:bg-purple-950/50 dark:border-purple-500/50 dark:text-purple-400 dark:shadow-purple-500/20",
        indigo: "bg-white border-indigo-200 text-indigo-600 shadow-sm dark:bg-indigo-950/50 dark:border-indigo-500/50 dark:text-indigo-400 dark:shadow-indigo-500/20",
        orange: "bg-white border-orange-200 text-orange-600 shadow-sm dark:bg-orange-950/50 dark:border-orange-500/50 dark:text-orange-400 dark:shadow-orange-500/20",
        green:  "bg-white border-emerald-200 text-emerald-600 shadow-sm dark:bg-emerald-950/50 dark:border-emerald-500/50 dark:text-emerald-400 dark:shadow-emerald-500/20",
    };

    return (
        <div className="flex flex-col items-center gap-2">
            <motion.div
                animate={{ 
                    scale: [1, 1.15, 1],
                    boxShadow: ["0 0 0px rgba(0,0,0,0)", "0 4px 12px rgba(0,0,0,0.1)", "0 0 0px rgba(0,0,0,0)"]
                }}
                transition={{ 
                    duration: 0.4, 
                    delay: delay, 
                    repeat: Infinity, 
                    repeatDelay: cycle - 0.4 
                }}
                className={`w-10 h-10 rounded-xl border flex items-center justify-center relative z-10 transition-colors duration-500 ${colors[color]}`}
            >
                <Icon className="w-5 h-5" />
                
                {/* Success Indicator */}
                {isFinal && (
                    <motion.div
                        animate={{ scale: [0, 1, 0] }}
                        transition={{ duration: 0.5, delay: delay + 0.2, repeat: Infinity, repeatDelay: cycle - 0.5 }}
                        className="absolute -top-2 -right-2 bg-green-500 text-white rounded-full p-0.5 border-2 border-white dark:border-slate-900 shadow-sm"
                    >
                        <CheckCircle2 className="w-3 h-3" />
                    </motion.div>
                )}
            </motion.div>

            <motion.span 
                animate={{ opacity: [0.6, 1, 0.6] }}
                transition={{ duration: 0.4, delay: delay, repeat: Infinity, repeatDelay: cycle - 0.4 }}
                className="text-[9px] font-mono font-bold uppercase tracking-wider px-1.5 py-0.5 rounded border transition-colors duration-500 whitespace-nowrap
                    text-slate-500 bg-slate-100 border-slate-200 
                    dark:text-slate-400 dark:bg-black/40 dark:border-white/5"
            >
                {label}
            </motion.span>
        </div>
    );
}

// =================== FILE: src/components/landing/services/mockups/TerminalMockup.tsx ===================

'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { useState, useEffect } from 'react';
import { Terminal, Play, CheckCircle2, Database, FileJson, FileCode, LucideIcon } from 'lucide-react';
import { cn } from '@/lib/utils';

// 1. DEFINIM EL TIPUS PER A UNA LÃNIA DE LOG
type LogEntry = {
  text: string;
  delay: number;
  color?: string;
};

// 2. DEFINIM EL TIPUS PER A UN ESCENARI
type ScenarioConfig = {
  id: string;
  label: string;
  icon: LucideIcon;
  color: string;
  borderColor: string;
  bgGlow: string;
  prompt: string;
  command: string;
  output: LogEntry[]; // Usem el tipus aquÃ­ tambÃ©
};

// --- CONFIGURACIÃ“ DELS ESCENARIS ---
// (Record<string, ScenarioConfig> assegura que l'objecte compleix el tipus)
const SCENARIOS: Record<string, ScenarioConfig> = {
  js: {
    id: 'js',
    label: 'Node.js',
    icon: FileJson,
    color: 'text-yellow-400',
    borderColor: 'border-yellow-500/50',
    bgGlow: 'bg-yellow-500/10',
    prompt: 'user@digitai:~/projects/api $',
    command: 'npm run deploy:production',
    output: [
      { text: '> building project...', delay: 500 },
      { text: '> optimizing chunks...', delay: 1200 },
      { text: 'âœ” Build completed in 840ms', color: 'text-green-400', delay: 2000 },
      { text: 'ğŸš€ Server running on port 3000', color: 'text-blue-400', delay: 2500 },
    ]
  },
  py: {
    id: 'py',
    label: 'Python',
    icon: FileCode,
    color: 'text-blue-400',
    borderColor: 'border-blue-500/50',
    bgGlow: 'bg-blue-500/10',
    prompt: '(env) main.py >',
    command: 'python3 train_model.py --epochs=10',
    output: [
      { text: 'TensorFlow: Loading GPU...', delay: 800 },
      { text: 'Epoch 1/10: loss: 0.4242 - acc: 0.8901', delay: 1600 },
      { text: 'Epoch 10/10: loss: 0.0123 - acc: 0.9998', delay: 2400 },
      { text: 'âœ¨ Model saved to /models/v1.h5', color: 'text-purple-400', delay: 3000 },
    ]
  },
  sql: {
    id: 'sql',
    label: 'SQL',
    icon: Database,
    color: 'text-pink-400',
    borderColor: 'border-pink-500/50',
    bgGlow: 'bg-pink-500/10',
    prompt: 'postgres@db:5432 #',
    command: 'SELECT * FROM leads WHERE status = "converted";',
    output: [
      { text: 'Querying table "leads"...', delay: 600 },
      { text: 'Index Scan using leads_pkey...', delay: 1400 },
      { text: '---------------------------------', delay: 1800 },
      { text: '(1,240 rows returned)', color: 'text-green-400', delay: 2200 },
    ]
  }
};

export function TerminalMockup() {
  const [activeTab, setActiveTab] = useState<string>('js');
  const [isTyping, setIsTyping] = useState(true);
  const [text, setText] = useState('');
  
  // 3. SOLUCIÃ“: SUBSTITUIM <any[]> PER <LogEntry[]>
  const [logs, setLogs] = useState<LogEntry[]>([]);
  
  const [completed, setCompleted] = useState(false);

  const scenario = SCENARIOS[activeTab];

  useEffect(() => {
    setText('');
    setLogs([]);
    setCompleted(false);
    setIsTyping(true);

    let currentText = '';
    const fullCommand = scenario.command;
    let charIndex = 0;

    const typeInterval = setInterval(() => {
      if (charIndex < fullCommand.length) {
        currentText += fullCommand.charAt(charIndex);
        setText(currentText);
        charIndex++;
      } else {
        clearInterval(typeInterval);
        setIsTyping(false);
        runExecution();
      }
    }, 50 + Math.random() * 50);

    return () => clearInterval(typeInterval);
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [activeTab]); // Afegim dependÃ¨ncia correcta

  const runExecution = () => {
    scenario.output.forEach((log, i) => {
      setTimeout(() => {
        // Ara TypeScript sap que 'log' Ã©s de tipus LogEntry
        setLogs(prev => [...prev, log]);
        if (i === scenario.output.length - 1) setCompleted(true);
      }, log.delay);
    });
  };

  return (
    <div className="w-full h-full p-4 md:p-6 flex items-center justify-center">
      
      <motion.div 
        layout
        className={cn(
            "w-full max-w-xl bg-[#09090b] rounded-xl border border-slate-800 shadow-2xl overflow-hidden flex flex-col relative transition-colors duration-500",
            "hover:shadow-primary/10 hover:border-slate-700"
        )}
      >
        <div className={`absolute inset-0 ${scenario.bgGlow} opacity-5 pointer-events-none transition-colors duration-700`}></div>

        {/* HEADER: TABS */}
        <div className="flex items-center bg-[#18181b] border-b border-slate-800 px-2 pt-2">
            <div className="flex gap-1.5 px-3 pb-2 mr-4">
                <div className="w-2.5 h-2.5 rounded-full bg-red-500/80"></div>
                <div className="w-2.5 h-2.5 rounded-full bg-yellow-500/80"></div>
                <div className="w-2.5 h-2.5 rounded-full bg-green-500/80"></div>
            </div>

            <div className="flex gap-1 overflow-x-auto scrollbar-hide">
                {Object.keys(SCENARIOS).map((key) => {
                    const tab = SCENARIOS[key];
                    return (
                        <button
                            key={key}
                            onClick={() => setActiveTab(key)}
                            className={cn(
                                "flex items-center gap-2 px-4 py-2 rounded-t-lg text-xs font-bold font-mono transition-all duration-300 relative",
                                activeTab === key 
                                    ? "bg-[#09090b] text-white border-t border-x border-slate-800" 
                                    : "text-slate-500 hover:text-slate-300 hover:bg-slate-800/50"
                            )}
                        >
                            {activeTab === key && (
                                <motion.div 
                                    layoutId="activeTabIndicator"
                                    className={`absolute top-0 left-0 right-0 h-0.5 ${tab.color.replace('text-', 'bg-')}`}
                                />
                            )}
                            <tab.icon className="w-3.5 h-3.5" />
                            {tab.label}
                        </button>
                    )
                })}
            </div>
            
            <div className="ml-auto px-3 pb-2 hidden sm:block">
                <div className={`w-6 h-6 rounded flex items-center justify-center transition-colors duration-300 ${completed ? 'text-green-500 bg-green-500/10' : 'text-slate-600'}`}>
                    {completed ? <CheckCircle2 className="w-3.5 h-3.5" /> : <Play className="w-3.5 h-3.5" />}
                </div>
            </div>
        </div>

        {/* CONSOLE BODY */}
        <div className="p-4 md:p-6 font-mono text-xs md:text-sm min-h-[220px] flex flex-col justify-end relative overflow-hidden">
            <div className="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:20px_20px]"></div>

            <div className="relative z-10 space-y-2">
                <div className="flex flex-wrap items-center gap-2 text-slate-300">
                    <span className={`font-bold ${scenario.color}`}>{scenario.prompt}</span>
                    <span className="text-white break-all">{text}</span>
                    {isTyping && (
                        <motion.span 
                            animate={{ opacity: [0, 1, 0] }}
                            transition={{ repeat: Infinity, duration: 0.8 }}
                            className="w-2 h-4 bg-slate-400 block"
                        />
                    )}
                </div>

                <div className="space-y-1 pl-2 border-l-2 border-slate-800">
                    <AnimatePresence mode='popLayout'>
                        {logs.map((log, i) => (
                            <motion.div 
                                key={i}
                                initial={{ opacity: 0, x: -10 }}
                                animate={{ opacity: 1, x: 0 }}
                                className={cn("flex items-center gap-2", log.color || "text-slate-400")}
                            >
                                <span>{log.text}</span>
                            </motion.div>
                        ))}
                    </AnimatePresence>
                </div>

                {!isTyping && completed && (
                    <motion.div 
                        initial={{ opacity: 0 }} 
                        animate={{ opacity: 1 }}
                        className="flex items-center gap-2 text-slate-300 mt-4"
                    >
                        <span className={`font-bold ${scenario.color}`}>{scenario.prompt}</span>
                        <motion.span 
                            animate={{ opacity: [0, 1, 0] }}
                            transition={{ repeat: Infinity, duration: 0.8 }}
                            className="w-2 h-4 bg-slate-400 block"
                        />
                    </motion.div>
                )}
            </div>
        </div>

        {/* STATUS BAR */}
        <div className="h-6 bg-[#18181b] border-t border-slate-800 flex items-center px-3 justify-between text-[10px] text-slate-500 font-mono">
            <div className="flex gap-4">
                <span>UTF-8</span>
                <span>Mem: {completed ? '42MB' : 'Processing...'}</span>
            </div>
            <div className="flex items-center gap-1.5">
                <Terminal className="w-3 h-3" />
                <span>bash</span>
            </div>
        </div>

      </motion.div>
    </div>
  );
}

// =================== FILE: src/components/landing/services/mockups/WebMockup.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { LayoutGrid, List, Search, MoreHorizontal, Plus, UserCircle } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function WebMockup() {
  const t = useTranslations('Solutions.dashboard_mockup');

  return (
    // CONTENIDOR PRINCIPAL
    <div className="w-full mt-6 -mb-1 relative">
      
      {/* ğŸ–¥ï¸ FINESTRA NAVEGADOR (Full Width) */}
      <div className="w-full bg-slate-100 dark:bg-[#0b0d14] rounded-t-xl border-t border-x border-slate-200 dark:border-white/10 shadow-2xl overflow-hidden flex flex-col">
        
        {/* Browser Chrome (Barra Superior) */}
        <div className="h-9 bg-white dark:bg-[#151925] border-b border-slate-200 dark:border-white/5 flex items-center px-4 justify-between shrink-0">
          <div className="flex gap-1.5">
            <div className="w-2.5 h-2.5 rounded-full bg-red-400/80"></div>
            <div className="w-2.5 h-2.5 rounded-full bg-yellow-400/80"></div>
            <div className="w-2.5 h-2.5 rounded-full bg-green-400/80"></div>
          </div>
          
          {/* Fake URL Bar - Responsive */}
          <div className="hidden sm:flex flex-1 mx-4 h-6 bg-slate-100 dark:bg-white/5 rounded-md items-center px-3 max-w-sm border border-slate-200 dark:border-white/5">
            <div className="w-3 h-3 text-slate-400 mr-2"><Search className="w-3 h-3" /></div>
            <div className="h-1.5 w-24 bg-slate-300 dark:bg-white/10 rounded-full"></div>
          </div>

          <div className="flex items-center gap-2">
             <div className="h-2 w-8 bg-slate-200 dark:bg-white/10 rounded-full hidden sm:block"></div>
             <UserCircle className="w-5 h-5 text-slate-300 dark:text-slate-600" />
          </div>
        </div>

        {/* ğŸ§© UI DASHBOARD (App Layout) */}
        <div className="flex flex-1 min-h-55 bg-slate-50/50 dark:bg-transparent relative overflow-hidden">
            
            {/* Sidebar (Esquerra) */}
            <div className="w-14 border-r border-slate-200 dark:border-white/5 bg-white dark:bg-[#151925] flex flex-col items-center py-4 gap-4 z-10">
                <div className="p-2 bg-blue-600/10 text-blue-600 rounded-lg">
                    <LayoutGrid className="w-5 h-5" />
                </div>
                <div className="p-2 text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 rounded-lg transition-colors">
                    <List className="w-5 h-5" />
                </div>
                <div className="mt-auto p-2 bg-green-500 rounded-full text-white shadow-lg shadow-green-500/30">
                    <Plus className="w-4 h-4" />
                </div>
            </div>

            {/* Main Content (Grid Responsive) */}
            <div className="flex-1 p-4 md:p-6 overflow-hidden relative">
                
                {/* Header Content */}
                <div className="flex justify-between items-end mb-6">
                    <div>
                        <div className="h-2 w-16 bg-blue-500/20 rounded-full mb-2"></div>
                        <div className="h-5 w-32 bg-slate-800 dark:bg-white rounded-md"></div>
                    </div>
                    <div className="flex -space-x-2">
                        {[1,2,3].map(i => (
                            <div key={i} className="w-8 h-8 rounded-full border-2 border-white dark:border-[#0b0d14] bg-slate-200 dark:bg-slate-700"></div>
                        ))}
                    </div>
                </div>

                {/* KANBAN BOARD / GRID WIDGETS */}
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                    
                    {/* Column 1: To Do */}
                    <div className="space-y-3">
                        <div className="flex justify-between text-[10px] uppercase font-bold text-slate-400 mb-1">
                            <span>{t('col_todo')}</span>
                            <MoreHorizontal className="w-3 h-3" />
                        </div>
                        
                        {/* Task Card 1 */}
                        <motion.div 
                            initial={{ y: 20, opacity: 0 }}
                            whileInView={{ y: 0, opacity: 1 }}
                            transition={{ delay: 0.1 }}
                            className="bg-white dark:bg-[#1e2330] p-3 rounded-lg border border-slate-200 dark:border-white/5 shadow-sm hover:shadow-md hover:border-blue-500/30 transition-all cursor-default group"
                        >
                            <div className="flex gap-2 mb-2">
                                <span className="w-8 h-1.5 rounded-full bg-orange-400/20"></span>
                                <span className="w-4 h-1.5 rounded-full bg-blue-400/20"></span>
                            </div>
                            <div className="h-2 w-3/4 bg-slate-200 dark:bg-slate-600 rounded-full mb-1"></div>
                            <div className="h-2 w-1/2 bg-slate-200 dark:bg-slate-600 rounded-full"></div>
                            
                            {/* Hover Reveal Action */}
                            <div className="mt-3 flex justify-between items-center opacity-50 group-hover:opacity-100 transition-opacity">
                                <div className="w-4 h-4 rounded-full bg-slate-200 dark:bg-slate-700"></div>
                                <div className="text-[9px] text-slate-400">{t('card_date')}</div>
                            </div>
                        </motion.div>

                        {/* Task Card 2 (Skeleton) */}
                        <div className="bg-slate-200/50 dark:bg-white/5 p-3 rounded-lg border border-transparent h-24 animate-pulse"></div>
                    </div>

                    {/* Column 2: In Progress */}
                    <div className="space-y-3">
                        <div className="flex justify-between text-[10px] uppercase font-bold text-slate-400 mb-1">
                            <span>{t('col_progress')}</span>
                            <MoreHorizontal className="w-3 h-3" />
                        </div>

                        {/* Active Task Card */}
                        <motion.div 
                            initial={{ y: 20, opacity: 0 }}
                            whileInView={{ y: 0, opacity: 1 }}
                            transition={{ delay: 0.3 }}
                            className="bg-white dark:bg-[#1e2330] p-3 rounded-lg border-l-4 border-l-blue-500 border-y border-r border-slate-200 dark:border-r-white/5 dark:border-y-white/5 shadow-lg relative"
                        >
                            {/* Cursor Interactiu */}
                            <motion.div 
                                animate={{ x: [10, 40, 10], y: [10, 30, 10] }}
                                transition={{ duration: 4, repeat: Infinity, ease: "easeInOut" }}
                                className="absolute -right-2 -bottom-2 z-20 pointer-events-none drop-shadow-xl"
                            >
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5.65376 12.3673H5.46026L5.31717 12.4976L0.500002 16.8829L0.500002 1.19841L11.7841 12.3673H5.65376Z" fill="#3b82f6" stroke="white" />
                                </svg>
                                <div className="absolute top-4 left-2 bg-blue-600 text-white text-[9px] px-1.5 py-0.5 rounded shadow-sm">{t('label_you')}</div>
                            </motion.div>

                            <div className="h-2 w-full bg-slate-800 dark:bg-slate-300 rounded-full mb-2"></div>
                            <div className="h-24 w-full bg-blue-50 dark:bg-blue-500/10 rounded border border-blue-100 dark:border-blue-500/20 mb-2 flex items-center justify-center">
                                <div className="text-[9px] text-blue-500 font-bold">{t('label_preview')}</div>
                            </div>
                        </motion.div>
                    </div>

                    {/* Column 3: Done */}
                    <div className="hidden md:block space-y-3">
                        <div className="flex justify-between text-[10px] uppercase font-bold text-slate-400 mb-1">
                            <span>{t('col_done')}</span>
                            <div className="text-green-500 text-[10px]">98%</div>
                        </div>
                        
                        {[1, 2].map((i) => (
                            <motion.div 
                                key={i}
                                initial={{ opacity: 0, x: 10 }}
                                whileInView={{ opacity: 0.6, x: 0 }}
                                transition={{ delay: 0.4 + (i * 0.1) }}
                                className="bg-slate-50 dark:bg-white/5 p-3 rounded-lg border border-slate-100 dark:border-white/5 opacity-60 grayscale"
                            >
                                <div className="flex items-center gap-2 mb-2">
                                    <div className="w-3 h-3 rounded-full border border-slate-400 flex items-center justify-center">
                                        <div className="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                                    </div>
                                    <div className="h-1.5 w-20 bg-slate-300 dark:bg-slate-600 rounded-full"></div>
                                </div>
                            </motion.div>
                        ))}
                    </div>

                </div>
            </div>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/components/landing/services/ServiceCard.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { LucideIcon, ArrowUpRight } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ServiceCardProps {
  title: string;
  description: string;
  icon: LucideIcon;
  iconColorClass?: string; // Ex: "text-blue-600"
  wrapperClass?: string;   // Ex: "md:col-span-2"
  children?: React.ReactNode; // El Mockup visual
  cta?: string; // Text del botÃ³ opcional
  delay?: number;
}

export function ServiceCard({
  title,
  description,
  icon: Icon,
  iconColorClass = "text-primary",
  wrapperClass,
  children,
  cta,
  delay = 0
}: ServiceCardProps) {
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      whileInView={{ opacity: 1, y: 0 }}
      viewport={{ once: true }}
      transition={{ delay, duration: 0.5 }}
      className={cn(
        "group relative overflow-hidden rounded-2xl border border-border bg-card hover:border-primary/30 transition-all duration-500 flex flex-col",
        wrapperClass
      )}
    >
      <div className="p-6 flex-1 z-10 flex flex-col h-full">
        {/* Icona */}
        <div className={cn(
          "w-10 h-10 rounded-lg flex items-center justify-center mb-4 border transition-colors",
          "bg-muted/50 border-border group-hover:border-primary/20", 
          // AquÃ­ podrÃ­em fer servir classes dinÃ miques de Tailwind si calguÃ©s, 
          // perÃ² el bg-muted/50 Ã©s mÃ©s net per defecte.
        )}>
          <Icon className={cn("w-5 h-5", iconColorClass)} />
        </div>

        {/* Textos */}
        <h3 className="text-xl font-bold text-foreground mb-2">{title}</h3>
        <p className="text-sm text-muted-foreground leading-relaxed mb-4 grow">
          {description}
        </p>

        {/* CTA Opcional */}
        {cta && (
          <button className={cn(
            "text-xs font-bold flex items-center gap-1 hover:gap-2 transition-all mt-auto",
            iconColorClass
          )}>
            {cta} <ArrowUpRight className="w-3 h-3" />
          </button>
        )}
      </div>

      {/* Ã€rea del Mockup Visual */}
      {children && (
        <div className="relative w-full mt-auto">
           {children}
        </div>
      )}
    </motion.div>
  );
}

// =================== FILE: src/components/landing/ServicesGrid.tsx ===================

'use client';

import { useTranslations } from 'next-intl';
import { Globe, Smartphone, BrainCircuit, Users } from 'lucide-react';
import { ServiceCard } from './services/ServiceCard'; // Importa els nous components
import { WebMockup } from './services/mockups/WebMockup';
import { AppMockup } from './services/mockups/AppMockup';
import { AutomationFlow } from './services/mockups/AutomationFlow';
import { TerminalMockup } from './services/mockups/TerminalMockup';

export function ServicesGrid() {
  const t = useTranslations('Services');

  return (
    <section id="serveis" className="bg-background relative overflow-hidden py-24 transition-colors duration-300">

      {/* âœ… CORRECCIÃ“ APLICADA AQUÃ: Padding responsiu */}
      <div className="container mx-auto px-6 md:px-10 lg:px-14">

        {/* CAPÃ‡ALERA */}
        <div className="text-center mb-16 max-w-3xl mx-auto">
     
          <h2 className="text-4xl lg:text-5xl font-extrabold mb-6 text-foreground leading-tight tracking-tight">
            {t('title_prefix')} <span className="text-transparent bg-clip-text bg-linear-to-r from-primary to-purple-500 pb-2">
              {t('title_highlight')}
            </span>
          </h2>
          <p className="text-lg text-muted-foreground max-w-2xl mx-auto">
            {t('subtitle')}
          </p>
        </div>

        {/* BENTO GRID */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">

          {/* 1. APPWEBS (Ample) */}
          <ServiceCard
            title={t('cards.appwebs.title')}
            description={t('cards.appwebs.description')}
            icon={Globe}
            iconColorClass="text-blue-500"
            wrapperClass="md:col-span-2 flex-row md:flex-row"
          >
            <WebMockup />
          </ServiceCard>

          {/* 2. APPS (Vertical) */}
          <ServiceCard
            title={t('cards.apps.title')}
            description={t('cards.apps.description')}
            icon={Smartphone}
            iconColorClass="text-cyan-500"
            delay={0.1}
          >
            <AppMockup />
          </ServiceCard>

          {/* 3. AUTOMATITZACIÃ“ (Vertical) */}
          <ServiceCard
            title={t('cards.automation.title')}
            description={t('cards.automation.description')}
            icon={BrainCircuit}
            iconColorClass="text-purple-500"
            delay={0.2}
          >
            <AutomationFlow />
          </ServiceCard>

          {/* 4. FORMACIÃ“ (Ample + CTA) */}
          <ServiceCard
            title={t('cards.training.title')}
            description={t('cards.training.description')}
            icon={Users}
            iconColorClass="text-green-500"
            wrapperClass="md:col-span-2 flex-col md:flex-row"
            cta={t('cards.training.cta')}
            delay={0.3}
          >
            <TerminalMockup />
          </ServiceCard>

        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/SocialSection.tsx ===================

'use client';

import { Facebook, Linkedin, Instagram } from 'lucide-react';
import { motion } from 'framer-motion';

const SOCIALS = [
  {
    name: 'LinkedIn',
    icon: Linkedin,
    href: 'https://www.linkedin.com/in/digitai-studios-105a0136a/',
    color: 'hover:text-[#0077b5]', // Color oficial LinkedIn
  },
  {
    name: 'Instagram',
    icon: Instagram,
    href: 'https://www.instagram.com/digitaistudios/',
    color: 'hover:text-[#E1306C]', // Color oficial Instagram
  },
  {
    name: 'Facebook',
    icon: Facebook,
    href: 'https://www.facebook.com/profile.php?id=61576974390567',
    color: 'hover:text-[#1877F2]', // Color oficial Facebook
  },
];

export function SocialSection() {
  return (
    <section className="py-12 bg-muted/30 border-y border-border/40">
      <div className="container mx-auto px-4 text-center">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true }}
        >
          <p className="text-sm font-semibold uppercase tracking-widest text-muted-foreground mb-6">
            Segueix la revoluciÃ³
          </p>
          
          <div className="flex justify-center items-center gap-8 md:gap-12">
            {SOCIALS.map((social) => (
              <a
                key={social.name}
                href={social.href}
                target="_blank"
                rel="noopener noreferrer"
                aria-label={`Segueix-nos a ${social.name}`}
                className={`transform transition-all duration-300 hover:scale-110 text-muted-foreground ${social.color}`}
              >
                <social.icon className="w-8 h-8 md:w-10 md:h-10" />
              </a>
            ))}
          </div>
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/solutions/data.ts ===================

import {
    CreditCard, CalendarCheck, BarChart4,
    Wifi, LucideIcon
} from 'lucide-react';

export interface SolutionItem {
    id: string;
    icon: LucideIcon;
    color: string;
    // Guardem les claus dels tags, no el text final
    tagKeys: string[]; 
}

export const SOLUTIONS: SolutionItem[] = [
    {
        id: 'iot',
        icon: Wifi,
        color: 'from-cyan-500 to-blue-500',
        tagKeys: ['qr', 'domotics', 'sensors', 'remote']
    },
    {
        id: 'finance',
        icon: CreditCard,
        color: 'from-green-500 to-emerald-600',
        tagKeys: ['stripe', 'invoicing', 'ocr', 'signature']
    },
    {
        id: 'booking',
        icon: CalendarCheck,
        color: 'from-purple-500 to-pink-500',
        tagKeys: ['engine', 'whatsapp', 'wallet', 'crm']
    },
    {
        id: 'growth',
        icon: BarChart4,
        color: 'from-orange-500 to-red-500',
        tagKeys: ['social', 'bi', 'kpis', 'leads']
    }
];

// =================== FILE: src/components/landing/solutions/MobileSolutionsDock.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { cn } from '@/lib/utils';
import { SolutionItem } from './data';

interface Props {
  solutions: SolutionItem[];
  activeTab: string;
  setActiveTab: (id: string) => void;
}

export function MobileSolutionsDock({ solutions, activeTab, setActiveTab }: Props) {
  return (
    <div className="lg:hidden w-full flex justify-center mt-0">
      {/* ğŸš€ Fons sÃ²lid en mÃ²bil per evitar cÃ rrega de GPU, amb ombra forta */}
      <div className="flex items-center gap-1.5 p-1.5 
                      bg-slate-900 border border-white/10 
                      rounded-full shadow-xl shadow-black/20 relative z-20">
        {solutions.map((item) => {
          const isActive = activeTab === item.id;

          return (
            <button
              key={item.id}
              onClick={() => setActiveTab(item.id)}
              className="relative flex flex-col items-center justify-center w-12 h-12 rounded-full transition-all duration-300"
              aria-label={item.id}
            >
              {/* Fons actiu (PÃ­ndola brillant) */}
              {isActive && (
                <motion.div
                  layoutId="activeDock"
                  className={`absolute inset-0 rounded-full bg-linear-to-br ${item.color} opacity-20`}
                  transition={{ type: "spring", bounce: 0.2, duration: 0.4 }} // AnimaciÃ³ mÃ©s curta
                />
              )}

              {/* Icona */}
              <div className={cn(
                "relative z-10 transition-all duration-300",
                isActive 
                  ? "text-white scale-110" // Treta l'ombra brillant drop-shadow
                  : "text-slate-400"
              )}>
                <item.icon className="w-5 h-5" />
              </div>

              {/* Punt indicador */}
              {isActive && (
                <motion.div
                  layoutId="activeDot"
                  className={`absolute bottom-2 w-1 h-1 rounded-full bg-white`}
                />
              )}
            </button>
          );
        })}
      </div>
    </div>
  );
}

// =================== FILE: src/components/landing/solutions/mockups/MockupBooking.tsx ===================

'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { CalendarCheck, MessageSquare, Clock, ChevronRight, CheckCircle2, User, Bot } from 'lucide-react';
import { useTranslations } from 'next-intl';
import { useState, useEffect } from 'react';

export function MockupBooking() {
  const t = useTranslations('Solutions.booking');
  const [step, setStep] = useState(0);

  // Array de dies de la setmana traduÃ¯ts o abreujats
  const weekDays = ['M', 'T', 'W', 'T', 'F', 'S', 'S']; 

  useEffect(() => {
    const cycle = async () => {
      setStep(0);
      setTimeout(() => setStep(1), 1000); // Pas 1: SolÂ·licitud
      setTimeout(() => setStep(2), 3000); // Pas 2: Processant
      setTimeout(() => setStep(3), 5000); // Pas 3: Ãˆxit
      setTimeout(() => setStep(0), 8000); // Reset
    };
    cycle();
    const interval = setInterval(cycle, 10000);
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="relative w-full h-full min-h-75 flex flex-col items-center justify-center p-6 overflow-visible">
       
       {/* Fons Ambient */}
       <div className="absolute top-0 left-0 w-64 h-64 bg-purple-500/20 rounded-full blur-[80px]" />
       <div className="absolute bottom-0 right-0 w-64 h-64 bg-pink-500/20 rounded-full blur-[80px]" />

       {/* =================================================================================
           ğŸ“± VERSIÃ“ MÃ’BIL: WIDGET D'ESTAT
           md:hidden
       ================================================================================= */}
       <div className="md:hidden w-full max-w-70 h-55 flex flex-col items-center justify-center relative">
          <AnimatePresence mode="wait">
             
             {/* ESTAT 0: IDLE */}
             {step === 0 && (
                <motion.div
                   key="idle"
                   initial={{ scale: 0.8, opacity: 0 }}
                   animate={{ scale: 1, opacity: 1 }}
                   exit={{ scale: 0.8, opacity: 0 }}
                   className="flex flex-col items-center gap-3 text-center"
                >
                   <div className="w-16 h-16 bg-slate-800/50 backdrop-blur-md border border-white/10 rounded-full flex items-center justify-center shadow-lg relative">
                      <CalendarCheck className="w-8 h-8 text-slate-400" />
                      <div className="absolute top-0 right-0 w-4 h-4 bg-green-500 rounded-full animate-pulse" />
                   </div>
                   <p className="text-sm text-slate-400 font-medium">{t('status_idle')}</p>
                </motion.div>
             )}

             {/* ESTAT 1: SOLÂ·LICITUD */}
             {step === 1 && (
                <motion.div
                   key="request"
                   initial={{ y: 20, opacity: 0 }}
                   animate={{ y: 0, opacity: 1 }}
                   exit={{ y: -20, opacity: 0 }}
                   className="w-full bg-slate-900 border border-slate-700 p-5 rounded-2xl shadow-xl"
                >
                   <div className="flex items-center gap-3 mb-3">
                      <div className="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
                         <User className="w-5 h-5 text-white" />
                      </div>
                      <div>
                         <div className="text-xs text-slate-400 uppercase font-bold">{t('new_message_label')}</div>
                         <div className="text-sm font-bold text-white">{t('mock_user_name')}</div>
                      </div>
                   </div>
                   <div className="bg-slate-800/50 p-3 rounded-lg text-xs text-slate-200 italic">
                      "{t('chat_user_1')}"
                   </div>
                </motion.div>
             )}

             {/* ESTAT 2: IA */}
             {step === 2 && (
                <motion.div
                   key="ai"
                   initial={{ scale: 0.9, opacity: 0 }}
                   animate={{ scale: 1, opacity: 1 }}
                   exit={{ scale: 1.1, opacity: 0 }}
                   className="w-full bg-linear-to-br from-purple-900 to-slate-900 border border-purple-500/30 p-5 rounded-2xl shadow-xl flex flex-col items-center text-center"
                >
                   <div className="relative mb-3">
                      <div className="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center z-10 relative">
                         <Bot className="w-6 h-6 text-white" />
                      </div>
                      <motion.div 
                        animate={{ rotate: 360 }}
                        transition={{ repeat: Infinity, duration: 3, ease: "linear" }}
                        className="absolute -inset-1 border-2 border-dashed border-purple-400/50 rounded-xl z-0"
                      />
                   </div>
                   <h4 className="text-white font-bold text-sm">{t('agent_name')}</h4>
                   <p className="text-xs text-purple-300 mt-1">{t('status_processing')}</p>
                </motion.div>
             )}

             {/* ESTAT 3: ÃˆXIT */}
             {step === 3 && (
                <motion.div
                   key="done"
                   initial={{ y: 20, opacity: 0 }}
                   animate={{ y: 0, opacity: 1 }}
                   className="w-full bg-white dark:bg-slate-900 border border-green-500/50 p-0 rounded-2xl shadow-2xl overflow-hidden"
                >
                   <div className="bg-green-500 p-3 flex justify-between items-center">
                      <span className="text-xs font-black text-white uppercase tracking-wider flex items-center gap-2">
                         <CheckCircle2 className="w-4 h-4" /> {t('status_confirmed')}
                      </span>
                      <span className="text-[10px] text-green-100 bg-green-600 px-2 py-0.5 rounded-full">{t('tag_auto')}</span>
                   </div>
                   <div className="p-5 flex items-center gap-4">
                      <div className="flex flex-col items-center justify-center bg-slate-100 dark:bg-slate-800 rounded-lg w-14 h-14 border border-slate-200 dark:border-slate-700">
                         <span className="text-[10px] text-slate-400 uppercase font-bold">{t('month_short')}</span>
                         <span className="text-2xl font-black text-slate-800 dark:text-white leading-none">15</span>
                      </div>
                      <div>
                         <div className="text-sm font-bold text-slate-800 dark:text-white">{t('mock_user_name')}</div>
                         <div className="text-xs text-slate-500 flex items-center gap-1 mt-1">
                            <Clock className="w-3 h-3" /> 10:00 AM
                         </div>
                      </div>
                   </div>
                </motion.div>
             )}

          </AnimatePresence>
       </div>

       {/* =================================================================================
           ğŸ’» VERSIÃ“ ESCRIPTORI: CALENDARI + XAT BUBBLE
           hidden md:flex
       ================================================================================= */}
       <div className="hidden md:flex relative w-full h-full items-center justify-center perspective-1000">
          
          {/* 1. Calendari Central */}
          <motion.div 
            initial={{ rotateX: 10, scale: 0.95 }}
            whileInView={{ rotateX: 0, scale: 1 }}
            transition={{ duration: 0.8 }}
            className="absolute w-125 h-80 bg-white/80 dark:bg-slate-900/90 backdrop-blur-xl border border-white/50 dark:border-white/10 rounded-2xl shadow-2xl p-6 flex flex-col z-0 overflow-hidden"
          >
             <div className="flex justify-between items-center mb-6">
                <div className="flex items-center gap-3">
                   <div className="p-2 bg-purple-500/10 rounded-lg">
                      <CalendarCheck className="w-6 h-6 text-purple-600 dark:text-purple-400" />
                   </div>
                   <div className="font-bold text-lg text-foreground">{t('month_year')}</div>
                </div>
                <div className="flex gap-1">
                   <div className="w-8 h-8 rounded-full border border-border flex items-center justify-center"><ChevronRight className="w-4 h-4 rotate-180" /></div>
                   <div className="w-8 h-8 rounded-full border border-border flex items-center justify-center"><ChevronRight className="w-4 h-4" /></div>
                </div>
             </div>

             <div className="grid grid-cols-7 gap-2 flex-1">
                {weekDays.map((d, i) => (
                   <div key={`h-${i}`} className="text-center text-xs font-bold text-muted-foreground py-2">{d}</div>
                ))}
                {[...Array(31)].map((_, i) => {
                   const day = i + 1;
                   const isSelected = day === 15;
                   const isPast = day < 15;
                   
                   return (
                      <div key={`d-${day}`} className="relative group">
                         <div className={`
                            h-8 w-8 mx-auto rounded-full flex items-center justify-center text-xs font-medium transition-all
                            ${isSelected && step >= 3 ? 'bg-purple-600 text-white shadow-lg shadow-purple-500/30 scale-110' : 
                              isPast ? 'text-muted-foreground opacity-50' : 'text-foreground hover:bg-muted'}
                         `}>
                            {day}
                         </div>
                      </div>
                   )
                })}
             </div>
          </motion.div>

          {/* 2. Targeta NotificaciÃ³ (Dreta) */}
          <motion.div 
             initial={{ y: 20, opacity: 0, x: 50 }}
             animate={{ 
                y: step >= 3 ? 0 : 20, 
                opacity: step >= 3 ? 1 : 0,
                x: step >= 3 ? 0 : 50
             }}
             transition={{ type: "spring", stiffness: 50 }}
             className="absolute bottom-10 right-0 z-20 w-72 bg-slate-950/90 backdrop-blur-md border border-purple-500/30 rounded-xl p-4 shadow-[0_20px_50px_-10px_rgba(168,85,247,0.4)] flex items-start gap-4"
          >
             <div className="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center shrink-0 shadow-lg shadow-green-500/20">
                <CheckCircle2 className="w-6 h-6 text-white" />
             </div>
             <div>
                <div className="text-xs font-bold text-purple-400 uppercase tracking-wider mb-1">{t('new_booking')}</div>
                <div className="text-sm font-bold text-white">{t('mock_user_name')}</div>
                <div className="text-xs text-slate-400 flex items-center gap-1 mt-1">
                   <Clock className="w-3 h-3" /> {t('date_long')}
                </div>
             </div>
          </motion.div>

          {/* 3. MISSATGE FLOTANT (Esquerra) */}
          <motion.div
             initial={{ opacity: 0, scale: 0.8, x: -100, y: -20 }}
             animate={{ 
                opacity: step >= 1 ? 1 : 0, 
                scale: step >= 1 ? 1 : 0.8, 
                x: step >= 1 ? -140 : -100, 
                y: step >= 1 ? -30 : -20 
             }}
             transition={{ type: "spring", stiffness: 100, damping: 15 }}
             className="absolute left-1/2 bottom-1/2 z-30 bg-white dark:bg-slate-800 p-4 rounded-2xl rounded-br-none shadow-2xl border border-border max-w-55"
          >
             <div className="flex items-center gap-2 mb-2 opacity-50">
                <MessageSquare className="w-3 h-3" /> <span className="text-[10px] uppercase font-bold">{t('platform_whatsapp')}</span>
             </div>
             <p className="text-sm text-foreground italic">"{t('chat_user_1')}"</p>
          </motion.div>

       </div>
    </div>
  )
}

// =================== FILE: src/components/landing/solutions/mockups/MockupFinance.tsx ===================

'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { Wifi, TrendingUp, ArrowDownLeft, ArrowUpRight, CreditCard, Layers, DollarSign, Wallet, Bell } from 'lucide-react';
import { useTranslations } from 'next-intl';
import { useState, useEffect } from 'react';

export function MockupFinance() {
  const t = useTranslations('Solutions.finance');
  const graphPath = "M0 80 C 40 80, 50 110, 90 60 S 150 40, 200 20 S 260 50, 320 10";

  // Estat per l'animaciÃ³ del MÃ²bil
  const [step, setStep] = useState(0); 

  useEffect(() => {
    const cycle = async () => {
      setStep(0);
      setTimeout(() => setStep(1), 1000); // 1. NotificaciÃ³
      setTimeout(() => setStep(2), 3500); // 2. Expanded (Detall)
      setTimeout(() => setStep(3), 6500); // 3. Total Balance
      setTimeout(() => setStep(0), 10000); // Reset
    };
    cycle();
    const interval = setInterval(cycle, 11000);
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="relative w-full h-full min-h-[250px] flex flex-col items-center justify-center p-4 overflow-visible">
       
       <div className="absolute top-0 right-0 w-64 h-64 bg-emerald-500/10 rounded-full blur-[80px]" />
       <div className="absolute bottom-0 left-0 w-64 h-64 bg-blue-500/10 rounded-full blur-[80px]" />

       {/* =================================================================================
           ğŸ“± VERSIÃ“ MÃ’BIL: LIVE TRANSACTION (Compacte)
           (md:hidden)
       ================================================================================= */}
       <div className="md:hidden w-full max-w-[260px] flex flex-col items-center gap-4">
          <AnimatePresence mode="wait">
             
             {/* ESTAT 0: ICONA FLOTANT (Wallet) */}
             {step === 0 && (
                <motion.div
                   key="idle"
                   initial={{ scale: 0.8, opacity: 0 }}
                   animate={{ scale: 1, opacity: 1 }}
                   exit={{ scale: 0.5, opacity: 0 }}
                   className="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center border border-white/10 shadow-xl"
                >
                   <Wallet className="w-8 h-8 text-emerald-400" />
                </motion.div>
             )}

             {/* ESTAT 1: NOTIFICACIÃ“ REBUDA */}
             {step === 1 && (
                <motion.div
                   key="notification"
                   initial={{ y: -20, opacity: 0 }}
                   animate={{ y: 0, opacity: 1 }}
                   exit={{ y: 20, opacity: 0 }}
                   className="w-full bg-slate-900/90 backdrop-blur-md border border-white/10 p-3 rounded-2xl shadow-xl flex items-center gap-3"
                >
                   <div className="w-10 h-10 bg-emerald-500/20 rounded-full flex items-center justify-center text-emerald-400 shrink-0">
                      <DollarSign className="w-5 h-5" />
                   </div>
                   <div>
                      <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Pagament Rebut</div>
                      <div className="text-sm font-bold text-white">Stripe Inc.</div>
                   </div>
                   <div className="ml-auto text-emerald-400 font-mono font-bold">+$125</div>
                </motion.div>
             )}

             {/* ESTAT 2: DETALL EXPANDIT (Ticket) */}
             {step === 2 && (
                <motion.div
                   key="detail"
                   initial={{ scale: 0.9, opacity: 0 }}
                   animate={{ scale: 1, opacity: 1 }}
                   exit={{ scale: 1.1, opacity: 0 }}
                   className="w-full bg-gradient-to-b from-slate-800 to-slate-900 border border-white/10 p-5 rounded-2xl shadow-2xl"
                >
                   <div className="text-center mb-4">
                      <div className="text-3xl font-black text-white mb-1">$1,250.00</div>
                      <div className="text-xs text-emerald-400 font-bold bg-emerald-500/10 px-2 py-1 rounded-full inline-block">
                         Completed
                      </div>
                   </div>
                   
                   <div className="space-y-3">
                      <div className="flex justify-between text-xs border-b border-white/5 pb-2">
                         <span className="text-slate-400">Client</span>
                         <span className="text-white font-medium">Acme Corp</span>
                      </div>
                      <div className="flex justify-between text-xs border-b border-white/5 pb-2">
                         <span className="text-slate-400">MÃ¨tode</span>
                         <span className="text-white font-medium flex items-center gap-1">
                            <CreditCard className="w-3 h-3" /> â€¢â€¢â€¢â€¢ 4242
                         </span>
                      </div>
                      <div className="flex justify-between text-xs">
                         <span className="text-slate-400">Data</span>
                         <span className="text-white font-medium">15 Gen, 10:42</span>
                      </div>
                   </div>
                </motion.div>
             )}

             {/* ESTAT 3: BALANÃ‡ TOTAL (Dashboard Mini) */}
             {step === 3 && (
                <motion.div
                   key="balance"
                   initial={{ y: 20, opacity: 0 }}
                   animate={{ y: 0, opacity: 1 }}
                   className="w-full bg-black border border-slate-800 p-4 rounded-2xl shadow-xl flex items-center justify-between"
                >
                   <div>
                      <div className="text-[10px] text-slate-500 font-bold uppercase">{t('total_balance')}</div>
                      <div className="text-xl font-bold text-white">$24,500</div>
                   </div>
                   <div className="h-10 w-24">
                      {/* Mini Sparkline */}
                      <svg className="w-full h-full overflow-visible" viewBox="0 0 100 40">
                         <path d="M0 40 L20 30 L40 35 L60 10 L80 20 L100 5" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" />
                      </svg>
                   </div>
                </motion.div>
             )}

          </AnimatePresence>
       </div>

       {/* --- ESCRIPTORI (Mantiguda Igual) --- */}
       <div className="hidden md:flex relative w-full h-full items-center justify-center perspective-1000">
          <motion.div 
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.2, duration: 0.5 }}
            className="absolute w-[85%] h-[75%] top-[15%] bg-white/50 dark:bg-slate-900/80 backdrop-blur-xl border border-white/40 dark:border-white/10 rounded-3xl shadow-2xl p-6 flex flex-col justify-end z-0"
          >
             <div className="absolute top-6 left-6 right-6 flex justify-between items-center">
                <div>
                   <div className="text-[10px] text-muted-foreground font-bold uppercase tracking-wider">{t('total_balance')}</div>
                   <div className="text-3xl font-black text-foreground flex items-center gap-2">
                      $24,500
                      <span className="text-[10px] bg-green-500/20 text-green-600 px-2 py-0.5 rounded-full flex items-center">
                         <TrendingUp className="w-3 h-3 mr-1" /> +12%
                      </span>
                   </div>
                </div>
                <div className="w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center border border-border">
                   <Layers className="w-5 h-5 text-muted-foreground" />
                </div>
             </div>

             <div className="relative h-24 w-full mb-6 mt-16">
                <svg className="w-full h-full overflow-visible" preserveAspectRatio="none" viewBox="0 0 320 100">
                   <defs>
                      <linearGradient id="gradientGraph" x1="0" y1="0" x2="0" y2="1">
                         <stop offset="0%" stopColor="#10b981" stopOpacity="0.3" />
                         <stop offset="100%" stopColor="#10b981" stopOpacity="0" />
                      </linearGradient>
                   </defs>
                   <motion.path 
                      d={`${graphPath} V 120 H 0 Z`} 
                      fill="url(#gradientGraph)" 
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      transition={{ delay: 1, duration: 1 }}
                   />
                   <motion.path
                      d={graphPath}
                      fill="none"
                      stroke="#10b981"
                      strokeWidth="3"
                      strokeLinecap="round"
                      initial={{ pathLength: 0 }}
                      animate={{ pathLength: 1 }}
                      transition={{ duration: 2, ease: "easeInOut", delay: 0.5 }}
                   />
                </svg>
             </div>

             <div className="space-y-3">
                {[1, 2].map((i) => (
                   <div key={i} className="flex items-center justify-between p-3 rounded-xl bg-white/40 dark:bg-white/5 border border-white/20">
                      <div className="flex items-center gap-3">
                         <div className={`w-8 h-8 rounded-full flex items-center justify-center ${i === 1 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                            {i === 1 ? <ArrowDownLeft className="w-4 h-4" /> : <ArrowUpRight className="w-4 h-4" />}
                         </div>
                         <div className="flex flex-col">
                            <span className="text-xs font-bold text-foreground">{i === 1 ? 'Stripe Inc.' : 'AWS EMEA'}</span>
                         </div>
                      </div>
                      <span className={`text-xs font-bold ${i === 1 ? 'text-green-600' : 'text-foreground'}`}>
                         {i === 1 ? '+$1,250.00' : '-$64.00'}
                      </span>
                   </div>
                ))}
             </div>
          </motion.div>

          <motion.div 
            initial={{ y: 0, opacity: 0, rotateX: 10 }}
            animate={{ y: -40, opacity: 1, rotateX: 0 }}
            transition={{ type: "spring", stiffness: 60, damping: 20 }}
            whileHover={{ scale: 1.05, rotateY: 5, y: -50 }}
            className="absolute z-20 w-80 h-48 bg-gradient-to-br from-[#1a1a1a] via-[#0f0f0f] to-black rounded-2xl p-6 shadow-[0_20px_50px_-12px_rgba(0,0,0,0.5)] border border-slate-700/50 flex flex-col justify-between group overflow-hidden"
          >
             <div className="absolute inset-0 opacity-20 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] mix-blend-overlay"></div>
             
             <motion.div 
                animate={{ x: ['-200%', '200%'] }}
                transition={{ repeat: Infinity, duration: 4, ease: "linear", repeatDelay: 1 }}
                className="absolute top-0 bottom-0 w-32 bg-gradient-to-r from-transparent via-white/5 to-transparent skew-x-12 pointer-events-none"
             />

             <div className="flex justify-between items-start relative z-10">
                <div className="text-white/90 font-bold text-lg tracking-wider flex items-center gap-2">
                   <CreditCard className="w-5 h-5" /> DigitAI
                </div>
                <Wifi className="w-6 h-6 text-white/50 rotate-90" />
             </div>

             <div className="relative z-10">
                <div className="w-10 h-8 bg-gradient-to-br from-yellow-200 to-yellow-500 rounded-md mb-3 relative overflow-hidden shadow-inner border border-yellow-600/50">
                   <div className="absolute top-1/2 w-full h-px bg-yellow-700/50"></div>
                   <div className="absolute left-1/2 h-full w-px bg-yellow-700/50"></div>
                </div>
                <div className="text-white/90 font-mono text-lg tracking-widest shadow-black drop-shadow-md whitespace-nowrap">
                   â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 4242
                </div>
             </div>

             <div className="flex justify-between items-end relative z-10">
                <div className="flex flex-col">
                   <span className="text-[8px] text-white/50 uppercase tracking-wider">{t('card_holder')}</span>
                   <span className="text-xs text-white font-medium tracking-wide">J. DOE</span>
                </div>
                <div className="flex flex-col items-end">
                   <span className="text-[8px] text-white/50 uppercase tracking-wider">EXP</span>
                   <span className="text-xs text-white font-medium tracking-wide">09/29</span>
                </div>
             </div>
          </motion.div>
       </div>

    </div>
  )
}

// =================== FILE: src/components/landing/solutions/mockups/MockupGrowth.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { TrendingUp, Activity, DollarSign, Zap } from 'lucide-react';
import { useState, useEffect } from 'react';

export function MockupGrowth() {
  const [revenue, setRevenue] = useState(8450);
  
  // 1. Dades Vives: Incrementa suaument
  useEffect(() => {
    const interval = setInterval(() => {
      setRevenue(prev => {
        const next = prev + 15;
        return next > 9999 ? 8450 : next;
      });
    }, 50);
    return () => clearInterval(interval);
  }, []);

  return (
    // CONTENIDOR RESPONSIVE I ADAPTABLE AL TEMA (Light/Dark)
    <div className="relative w-full h-full min-h-[260px] flex items-center justify-center p-4">
      
      {/* Targeta Principal amb Glassmorphism */}
      <div className="relative w-full max-w-[380px] aspect-[4/3] bg-white dark:bg-[#0a0a0a] rounded-2xl border border-slate-200 dark:border-white/10 shadow-2xl overflow-hidden flex flex-col group transition-colors duration-500">
        
        {/* --- FONS AMBIENTAL (Subtil) --- */}
        {/* Light: Graella grisa molt suau | Dark: Graella fosca */}
        <div className="absolute inset-0 bg-[linear-gradient(to_right,#8080800a_1px,transparent_1px),linear-gradient(to_bottom,#8080800a_1px,transparent_1px)] bg-[size:20px_20px]" />
        
        {/* Glow Taronja de fons (MÃ©s fort en dark) */}
        <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-40 h-40 bg-orange-500/10 dark:bg-orange-500/20 blur-[60px] rounded-full pointer-events-none" />

        {/* --- HEADER --- */}
        <div className="relative z-10 flex justify-between items-start p-5 border-b border-slate-100 dark:border-white/5">
            <div>
                <div className="flex items-center gap-2 mb-1">
                    <div className="p-1.5 bg-orange-100 dark:bg-orange-500/20 rounded-md">
                        <Activity className="w-3.5 h-3.5 text-orange-600 dark:text-orange-400" />
                    </div>
                    <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest">
                        Real-time Growth
                    </span>
                </div>
                <div className="text-3xl font-black text-slate-900 dark:text-white flex items-baseline gap-1 font-mono tracking-tight">
                    ${revenue.toLocaleString()}
                </div>
            </div>
            
            {/* Badge ROI (Pulsant) */}
            <motion.div 
                animate={{ scale: [1, 1.05, 1], boxShadow: ["0 0 0px rgba(249,115,22,0)", "0 4px 12px rgba(249,115,22,0.3)", "0 0 0px rgba(249,115,22,0)"] }}
                transition={{ duration: 2, repeat: Infinity }}
                className="bg-orange-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold flex items-center gap-1 shadow-lg shadow-orange-500/20"
            >
                <TrendingUp className="w-3 h-3" /> +28%
            </motion.div>
        </div>

        {/* --- Ã€REA DEL GRÃ€FIC --- */}
        <div className="relative flex-1 w-full mt-2">
            
            {/* LÃ­nia d'escaneig vertical (Scanner) */}
            <motion.div 
                animate={{ left: ['0%', '100%'], opacity: [0, 1, 0] }}
                transition={{ duration: 3, repeat: Infinity, ease: "easeInOut" }}
                className="absolute top-0 bottom-0 w-[1px] bg-gradient-to-b from-transparent via-orange-400 to-transparent z-20"
            />

            <svg className="w-full h-full overflow-visible px-4 pb-2" viewBox="0 0 340 120" preserveAspectRatio="none">
                <defs>
                    <linearGradient id="areaGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stopColor="#f97316" stopOpacity="0.3" /> {/* Light */}
                        <stop offset="100%" stopColor="#f97316" stopOpacity="0" />
                    </linearGradient>
                    <filter id="orangeGlow" x="-20%" y="-20%" width="140%" height="140%">
                        <feGaussianBlur stdDeviation="3" result="blur" />
                        <feComposite in="SourceGraphic" in2="blur" operator="over" />
                    </filter>
                </defs>

                {/* 1. Ombra de la lÃ­nia (DÃ³na profunditat en Light Mode) */}
                <motion.path
                    d="M0 100 C 40 100, 70 120, 120 70 S 180 50, 240 80 S 300 40, 340 10"
                    fill="none"
                    stroke="rgba(0,0,0,0.1)"
                    strokeWidth="4"
                    className="dark:hidden" // NomÃ©s en light mode
                    initial={{ pathLength: 0 }}
                    animate={{ pathLength: 1 }}
                    transition={{ duration: 1.5, delay: 0.1 }}
                    style={{ transform: 'translateY(4px)' }}
                />

                {/* 2. Ã€rea sota la lÃ­nia */}
                <motion.path
                    d="M0 100 C 40 100, 70 120, 120 70 S 180 50, 240 80 S 300 40, 340 10 V 150 H 0 Z"
                    fill="url(#areaGradient)"
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ duration: 1 }}
                />

                {/* 3. LÃ­nia Principal (Taronja) */}
                <motion.path
                    d="M0 100 C 40 100, 70 120, 120 70 S 180 50, 240 80 S 300 40, 340 10"
                    fill="none"
                    stroke="#f97316"
                    strokeWidth="4"
                    strokeLinecap="round"
                    initial={{ pathLength: 0 }}
                    animate={{ pathLength: 1 }}
                    transition={{ duration: 1.5, ease: "easeOut" }}
                    // Glow nomÃ©s en dark mode per no "embrutar" el light
                    className="dark:drop-shadow-[0_0_8px_rgba(249,115,22,0.8)]"
                />

                {/* 4. Punts Interactius (Pop-up seqÃ¼encial) */}
                {[
                    { cx: 120, cy: 70, label: "$3k" },
                    { cx: 240, cy: 80, label: "$5k" },
                    { cx: 340, cy: 10, label: "$8.4k" }
                ].map((p, i) => (
                    <g key={i}>
                        {/* Cercle */}
                        <motion.circle
                            cx={p.cx}
                            cy={p.cy}
                            r="5"
                            className="fill-white stroke-orange-500 dark:fill-slate-900 dark:stroke-orange-400"
                            strokeWidth="3"
                            initial={{ scale: 0 }}
                            animate={{ scale: [0, 1.2, 1] }}
                            transition={{ delay: 1.5 + (i * 0.4), duration: 0.5 }}
                        />
                        {/* Etiqueta flotant */}
                        <motion.g
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ delay: 1.8 + (i * 0.4) }}
                        >
                            <rect x={p.cx - 18} y={p.cy - 30} width="36" height="20" rx="4" className="fill-slate-900 dark:fill-white" />
                            <text x={p.cx} y={p.cy - 16} textAnchor="middle" className="fill-white dark:fill-slate-900 text-[10px] font-bold font-mono">
                                {p.label}
                            </text>
                        </motion.g>
                    </g>
                ))}
            </svg>
        </div>

        {/* --- FLOATERS (ELEMENTS FLOTANTS DECORATIUS) --- */}
        
        {/* Moneda Flotant */}
        <motion.div
            animate={{ y: [0, -10, 0], rotate: [0, 5, 0] }}
            transition={{ duration: 4, repeat: Infinity, ease: "easeInOut" }}
            className="absolute top-20 right-8 bg-white dark:bg-slate-800 p-2 rounded-full shadow-lg border border-orange-100 dark:border-white/10 z-20"
        >
            <DollarSign className="w-5 h-5 text-orange-500" />
        </motion.div>

        {/* PartÃ­cules (Espurnes d'Ã¨xit) - Deterministes */}
        {[...Array(6)].map((_, i) => (
            <motion.div
                key={i}
                className="absolute w-1.5 h-1.5 bg-orange-400 rounded-full opacity-60"
                style={{
                    left: `${(i * 17) % 80 + 10}%`,
                    top: `${(i * 23) % 50 + 40}%`
                }}
                animate={{
                    y: [0, -60],
                    opacity: [0, 1, 0],
                    scale: [0.5, 1, 0]
                }}
                transition={{
                    duration: 2 + (i % 2),
                    repeat: Infinity,
                    delay: i * 0.7,
                    ease: "easeOut"
                }}
            />
        ))}

      </div>
    </div>
  );
}

// =================== FILE: src/components/landing/solutions/mockups/MockupIoT.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { QrCode, Lock, Unlock, ScanLine } from 'lucide-react';
import { useState, useEffect } from 'react';

export function MockupIoT() {
  const [isOpen, setIsOpen] = useState(false);

  useEffect(() => {
    const cycle = async () => {
      setIsOpen(false);
      const openTimer = setTimeout(() => setIsOpen(true), 2000);
      const closeTimer = setTimeout(() => setIsOpen(false), 6000);
      return () => {
        clearTimeout(openTimer);
        clearTimeout(closeTimer);
      };
    };
    cycle();
    const interval = setInterval(cycle, 7000);
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="relative w-full h-full flex flex-col items-center justify-end overflow-hidden bg-slate-900/50 rounded-2xl">
       
       {/* --- FONS --- */}
       <div className="absolute inset-0 flex items-center justify-center">
          <div className="w-full h-full bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-blue-900/40 via-slate-900 to-slate-950 flex flex-col items-center justify-center perspective-500">
             {/* Text reduÃ¯t en mÃ²bil */}
             <div className="text-[60px] md:text-[100px] font-black text-white/5 tracking-tighter animate-pulse">
                OFFICE
             </div>
             <div className={`w-32 h-1 bg-cyan-500 shadow-[0_0_20px_cyan] transition-opacity duration-500 ${isOpen ? 'opacity-100' : 'opacity-20'}`} />
          </div>
       </div>

       {/* --- PORTES --- */}
       <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
          <div className="absolute top-[15%] w-[90%] h-3 md:h-4 bg-slate-700 rounded-full border-b border-slate-500 z-20 shadow-lg" />

          {/* Ajustem el desplaÃ§ament x segons la pantalla */}
          <motion.div
            animate={{ x: isOpen ? '-85%' : 0 }}
            transition={{ type: "spring", stiffness: 50, damping: 15 }}
            className="w-[35%] h-[60%] bg-blue-50/5 backdrop-blur-md border-l border-t border-b border-white/20 shadow-xl relative z-10 flex items-center justify-end"
          >
             <div className="w-1 h-12 md:h-16 bg-slate-400/50 rounded-full mr-2" />
             <div className="absolute top-0 right-0 w-full h-full bg-gradient-to-br from-white/10 to-transparent pointer-events-none" />
          </motion.div>

          <motion.div
            animate={{ x: isOpen ? '85%' : 0 }}
            transition={{ type: "spring", stiffness: 50, damping: 15 }}
            className="w-[35%] h-[60%] bg-blue-50/5 backdrop-blur-md border-r border-t border-b border-white/20 shadow-xl relative z-10 flex items-center justify-start"
          >
             <div className="w-1 h-12 md:h-16 bg-slate-400/50 rounded-full ml-2" />
             <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-bl from-white/10 to-transparent pointer-events-none" />
          </motion.div>
       </div>

       {/* --- LECTOR (MÃ©s petit en mÃ²bil) --- */}
       <div className="absolute right-[5%] top-[40%] w-6 h-10 md:w-10 md:h-16 bg-slate-800 rounded-md border border-slate-600 flex flex-col items-center justify-center shadow-lg z-0">
          <motion.div 
            animate={{ backgroundColor: isOpen ? '#22c55e' : '#ef4444' }}
            className="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full mb-1 shadow-[0_0_5px_currentColor]" 
          />
          <div className="w-3 h-4 md:w-4 md:h-6 bg-black/50 rounded-[2px]" />
       </div>

       {/* --- MÃ’BIL --- */}
       <motion.div 
         animate={{ 
            y: isOpen ? 100 : 0,
            opacity: isOpen ? 0 : 1,
            scale: isOpen ? 0.8 : 1
         }}
         transition={{ duration: 0.5 }}
         // Mida mÃ©s continguda en mÃ²bil
         className="absolute bottom-4 z-30"
       >
          <div className="relative w-24 h-40 md:w-32 md:h-56 bg-slate-900 rounded-[1.5rem] md:rounded-[2rem] border-4 border-slate-700 shadow-2xl flex flex-col items-center overflow-hidden">
             
             <div className="w-full h-full bg-slate-950 flex flex-col items-center justify-center relative">
                <div className="absolute top-4 text-[6px] md:text-[8px] text-slate-400 uppercase tracking-widest font-bold">DigitAI Access</div>

                <div className="bg-white p-1.5 md:p-2 rounded-lg relative overflow-hidden">
                   <QrCode className="w-12 h-12 md:w-16 md:h-16 text-black" />
                   <motion.div 
                      animate={{ top: ['0%', '100%', '0%'] }}
                      transition={{ repeat: Infinity, duration: 1.5, ease: "linear" }}
                      className="absolute left-0 w-full h-0.5 bg-green-500 shadow-[0_0_10px_#22c55e] opacity-80"
                   />
                </div>

                <div className="mt-2 md:mt-4 flex items-center gap-1 md:gap-2 px-2 md:px-3 py-1 rounded-full bg-slate-800 border border-slate-700">
                   <motion.div animate={{ opacity: [0.5, 1, 0.5] }} transition={{ repeat: Infinity, duration: 1 }}>
                      <ScanLine className="w-2.5 h-2.5 md:w-3 md:h-3 text-cyan-400" />
                   </motion.div>
                   <span className="text-[6px] md:text-[8px] font-mono text-cyan-400">CONNECTING...</span>
                </div>
             </div>

             <div className="absolute top-2 w-8 md:w-10 h-2 md:h-3 bg-black rounded-full z-40" />
          </div>
       </motion.div>

       {/* --- ESTAT --- */}
       <motion.div
          animate={{ opacity: isOpen ? 1 : 0, y: isOpen ? 0 : 10 }}
          className="absolute bottom-10 z-20 bg-green-500/20 backdrop-blur-md border border-green-500/50 text-green-400 px-3 py-1.5 md:px-4 md:py-2 rounded-full font-bold text-[10px] md:text-sm flex items-center gap-2 shadow-[0_0_20px_rgba(34,197,94,0.2)]"
       >
          <Unlock className="w-3 h-3 md:w-4 md:h-4" /> ACCÃ‰S AUTORITZAT
       </motion.div>

    </div>
  )
}

// =================== FILE: src/components/landing/solutions/SolutionsDisplay.tsx ===================

'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { SolutionItem } from './data';
import { MockupIoT } from './mockups/MockupIoT';
import { MockupFinance } from './mockups/MockupFinance';
import { MockupBooking } from './mockups/MockupBooking';
import { MockupGrowth } from './mockups/MockupGrowth';
import { useTranslations } from 'next-intl';

export function SolutionsDisplay({ solution }: { solution: SolutionItem }) {
  const t = useTranslations('Solutions');
  
  return (
    <div className="w-full h-full relative flex flex-col">
      {/* ğŸš€ OPTIMITZACIÃ“: Fons sÃ²lid a mÃ²bil, Vidre a Desktop */}
      <div className="absolute inset-0 
                      bg-card border border-border/50 
                      md:bg-linear-to-br md:from-white/40 md:to-white/10 md:dark:from-slate-900/80 md:dark:to-slate-900/40 
                      md:backdrop-blur-xl md:border-white/20 
                      rounded-3xl md:rounded-4xl shadow-xl overflow-hidden">

        <AnimatePresence mode="wait">
          <motion.div
            key={solution.id}
            initial={{ opacity: 0, x: 10 }} // AnimaciÃ³ lateral simple Ã©s mÃ©s lleugera que scale
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: -10 }}
            transition={{ duration: 0.2, ease: "easeOut" }} // MÃ©s rÃ pid (snappy)
            className="w-full h-full p-6 md:p-10 lg:p-12 flex flex-col will-change-transform"
          >
            {/* Header Text */}
            <div className="mb-4 md:mb-6 shrink-0 relative z-10">
              <h3 className="text-xl md:text-3xl font-bold text-foreground mb-2 md:mb-4 flex items-center gap-2 md:gap-3">
                <solution.icon className={`w-5 h-5 md:w-8 md:h-8 text-transparent bg-clip-text bg-linear-to-r ${solution.color}`} />
                {t(`${solution.id}.title`)}
              </h3>
              <p className="text-sm md:text-lg text-muted-foreground leading-relaxed md:max-w-2xl line-clamp-3 md:line-clamp-none">
                {t(`${solution.id}.description`)}
              </p>
            </div>

            {/* Mockup Area */}
            {/* Donem espai abaix pel Dock mÃ²bil (pb-20) */}
            <div className="flex-1 relative flex items-center justify-center 
                          bg-muted/30 dark:bg-black/20 
                          rounded-2xl border border-dashed border-border/50 
                          overflow-hidden min-h-0 pb-20 lg:pb-0">
              
              {/* ğŸš€ OPTIMITZACIÃ“: Escala reduÃ¯da en mÃ²bil per evitar layout thrashing */}
              <div className="w-full h-full relative scale-[0.85] md:scale-[0.85] lg:scale-100 origin-center transition-transform duration-500">
                {/* Lazy loading conceptual dels mockups (dependrÃ  de com estiguin fets els components interns) */}
                {solution.id === 'iot' && <MockupIoT />}
                {solution.id === 'finance' && <MockupFinance />}
                {solution.id === 'booking' && <MockupBooking />}
                {solution.id === 'growth' && <MockupGrowth />}
              </div>
            </div>

            {/* Tags Footer - NomÃ©s Desktop */}
            <div className="hidden lg:flex mt-4 md:mt-8 flex-wrap gap-2">
              {solution.tagKeys.map(tagKey => (
                <span key={tagKey} className="px-3 py-1 rounded-full bg-background/50 border border-border text-xs font-bold uppercase tracking-wider text-muted-foreground">
                  {t(`tags.${tagKey}`)}
                </span>
              ))}
            </div>

          </motion.div>
        </AnimatePresence>

      </div>
    </div>
  );
}

// =================== FILE: src/components/landing/solutions/SolutionsNavigation.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { ArrowRight } from 'lucide-react';
import { cn } from '@/lib/utils';
import { SolutionItem } from './data';
import { useTranslations } from 'next-intl';

interface Props {
  solutions: SolutionItem[];
  activeTab: string;
  setActiveTab: (id: string) => void;
}

export function SolutionsNavigation({ solutions, activeTab, setActiveTab }: Props) {
  const t = useTranslations('Solutions');

  return (
    <div className="hidden lg:flex col-span-4 flex-col gap-4">
      {solutions.map((item) => {
        const isActive = activeTab === item.id;
        
        return (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={cn(
              "relative group flex items-center gap-4 p-6 rounded-2xl text-left transition-all duration-300 border border-transparent outline-none focus:ring-2 focus:ring-primary/20",
              isActive 
                ? "bg-white dark:bg-slate-900 shadow-xl border-primary/20 scale-[1.02]" 
                : "hover:bg-white/50 dark:hover:bg-white/5 hover:border-border"
            )}
          >
            {/* 1. FONS ANIMAT (PosiciÃ³ absoluta, es queda al fons) */}
            {isActive && (
              <motion.div
                layoutId="activeGlow"
                className={`absolute inset-0 rounded-2xl bg-linear-to-r ${item.color} opacity-5 dark:opacity-10`}
              />
            )}

            {/* 2. CONTINGUT (Afegim 'relative z-10' per posar-ho a sobre del fons) */}
            <div className={cn(
              "w-12 h-12 rounded-xl flex items-center justify-center transition-colors duration-300 shrink-0 relative z-10",
              isActive 
                ? `bg-linear-to-br ${item.color} text-white shadow-lg` 
                : "bg-muted text-muted-foreground group-hover:text-foreground"
            )}>
              <item.icon className="w-6 h-6" />
            </div>
            
            <div className="flex-1 relative z-10">
              <h3 className={cn("font-bold text-lg", isActive ? "text-foreground" : "text-muted-foreground group-hover:text-foreground")}>
                {t(`${item.id}.title`)}
              </h3>
              {isActive && (
                <motion.p 
                  initial={{ opacity: 0, height: 0 }}
                  animate={{ opacity: 1, height: 'auto' }}
                  className="text-xs text-muted-foreground mt-1"
                >
                  {item.tagKeys.map(key => t(`tags.${key}`)).join(' â€¢ ')}
                </motion.p>
              )}
            </div>
            
            {isActive && (
                <ArrowRight className="w-5 h-5 text-primary animate-pulse shrink-0 relative z-10" />
            )}
          </button>
        );
      })}
    </div>
  );
}

// =================== FILE: src/components/landing/solutions/SolutionsShowcase.tsx ===================

'use client';

import { useState } from 'react';
import { useTranslations } from 'next-intl';
import { SOLUTIONS } from './data';
import { SolutionsNavigation } from './SolutionsNavigation';
import { SolutionsDisplay } from './SolutionsDisplay';
import { MobileSolutionsDock } from './MobileSolutionsDock';
import { Reveal } from '@/components/animations/Reveal';

export function SolutionsShowcase() {
  const [activeTab, setActiveTab] = useState(SOLUTIONS[0].id);
  const activeSolution = SOLUTIONS.find(s => s.id === activeTab)!;
  const t = useTranslations('SolutionsSection');

  return (
    <section className="py-16 md:py-24 bg-background relative overflow-hidden transition-colors duration-500">
      
      {/* ğŸš€ OPTIMITZACIÃ“: Blob nomÃ©s visible a partir de Tablet (md). A mÃ²bil Ã©s massa pesat. */}
      <div 
        className={`hidden md:block absolute inset-0 opacity-10 bg-linear-to-br ${activeSolution.color} blur-[150px] transition-all duration-700 will-change-[background-color]`} 
      />
      
      {/* Pattern lleuger per a mÃ²bil en lloc del blob */}
      <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] bg-size-[40px_40px] opacity-[0.03] pointer-events-none" />

      <div className="container mx-auto px-6 md:px-10 lg:px-14 relative z-10">
        
        {/* HEADER */}
        <div className="max-w-3xl mx-auto mb-8 md:mb-16 text-center">
          <Reveal direction="up" width="100%">
            <h2 className="text-3xl md:text-5xl font-black text-foreground mb-4">
              {t('title_prefix')} <span className="text-transparent bg-clip-text bg-linear-to-r from-primary to-purple-400">{t('title_highlight')}</span>.
            </h2>
          </Reveal>
          
          <Reveal direction="up" delay={0.1} width="100%">
            <p className="text-lg md:text-xl text-muted-foreground">
              {t('description')}
            </p>
          </Reveal>
        </div>

        {/* --- ESTRUCTURA RESPONSIVE --- */}
        <Reveal delay={0.2} width="100%" direction="up">
          <div className="flex flex-col lg:grid lg:grid-cols-12 gap-6 lg:gap-8 items-stretch lg:h-162.5">
            
            {/* 1. NAVEGACIÃ“ D'ESCRIPTORI */}
            <SolutionsNavigation 
              solutions={SOLUTIONS} 
              activeTab={activeTab} 
              setActiveTab={setActiveTab} 
            />
            
            {/* 2. VISUALITZACIÃ“ */}
            <div className="lg:col-span-8 flex flex-col h-125 md:h-162.5 lg:h-auto relative z-10">
               <SolutionsDisplay solution={activeSolution} />
               
               {/* 3. DOCK MÃ’BIL - Dins el mateix bloc per context */}
               <div className="absolute -bottom-4 left-0 right-0 z-50 flex justify-center lg:hidden pointer-events-none">
                  <div className="pointer-events-auto">
                    <MobileSolutionsDock 
                        solutions={SOLUTIONS} 
                        activeTab={activeTab} 
                        setActiveTab={setActiveTab} 
                    />
                  </div>
               </div>
            </div>

          </div>
        </Reveal>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/TechStackSection.tsx ===================

'use client';

import { motion, useAnimationControls } from 'framer-motion';
import { useState, useEffect } from 'react';
import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils';
// ğŸ‘‡ AFEGEIX MakeIcon A L'IMPORT
import { 
  NextjsIcon, SupabaseIcon, N8nIcon, AirtableIcon, 
  ReactIcon, OpenAIIcon, GeminiIcon, TypeScriptIcon, 
  GitHubIcon, VercelIcon, MakeIcon 
} from '@/components/icons/TechIcons';

const TECHNOLOGIES = [
  { name: "Next.js", color: "#000000", Icon: NextjsIcon },
  { name: "Supabase", color: "#3ECF8E", Icon: SupabaseIcon },
  
  // âœ… n8n: El color #FF6D5A Ã©s el taronja/vermell oficial.
  // Quan el 'grayscale' desaparegui al hover, es veurÃ  d'aquest color.
  { name: "n8n", color: "#FF6D5A", Icon: N8nIcon },

  // âœ… MAKE: Afegit nou
  { name: "Make", color: "#642191", Icon: MakeIcon },

  { name: "Airtable", color: "#F82B60", Icon: AirtableIcon },
  { name: "React Native", color: "#61DAFB", Icon: ReactIcon },
  { name: "OpenAI", color: "#10A37F", Icon: OpenAIIcon },
  { name: "Gemini", color: "#4E75F6", Icon: GeminiIcon },
  { name: "TypeScript", color: "#3178C6", Icon: TypeScriptIcon },
  { name: "GitHub", color: "#000000", Icon: GitHubIcon },
  { name: "Vercel", color: "#000000", Icon: VercelIcon },
];

export function TechStackSection() {
  const t = useTranslations('TechStack');
  const controls = useAnimationControls();
  const [activeTech, setActiveTech] = useState<string | null>(null);

  const infiniteTechnologies = [...TECHNOLOGIES, ...TECHNOLOGIES];

  useEffect(() => {
    controls.start({
      x: "-50%",
      transition: {
        duration: 30,
        ease: "linear",
        repeat: Infinity,
      }
    });
  }, [controls]);

  const handleInteractionStart = (name: string) => {
    setActiveTech(name);
    controls.stop();
  };

  const handleInteractionEnd = () => {
    setActiveTech(null);
    controls.start({
      x: "-50%",
      transition: {
        duration: 20,
        ease: "linear",
        repeat: Infinity,
      }
    });
  };

  return (
    <section className="py-6 border-y border-slate-200 dark:border-white/5 bg-slate-50 dark:bg-white/1 overflow-hidden relative">

      <div className="absolute inset-y-0 left-0 w-24 bg-linear-to-r from-slate-50 dark:from-[#0a0a0a] to-transparent z-10 pointer-events-none" />
      <div className="absolute inset-y-0 right-0 w-24 bg-linear-to-l from-slate-50 dark:from-[#0a0a0a] to-transparent z-10 pointer-events-none" />

      <div className="container mx-auto px-4 mb-4">
        <p className="text-center text-xs font-bold text-slate-500 uppercase tracking-[0.2em]">
          {t('subtitle')}
        </p>
      </div>

      <div className="flex w-full overflow-hidden py-10">
        <motion.div
          className="flex items-center gap-12 md:gap-24 px-12"
          animate={controls}
          initial={{ x: 0 }}
        >
          {infiniteTechnologies.map((tech, i) => (
            <div
              key={`${tech.name}-${i}`}
              className="relative group flex flex-col items-center justify-center min-w-20"
              onMouseEnter={() => handleInteractionStart(tech.name)}
              onMouseLeave={handleInteractionEnd}
              onTouchStart={() => handleInteractionStart(tech.name)}
              onTouchEnd={handleInteractionEnd}
              onClick={() => handleInteractionStart(tech.name)}
            >
              <motion.div
                className={cn(
                  "w-16 h-16 md:w-20 md:h-20 transition-all duration-300 z-40 flex items-center justify-center",
                  // ESTAT INACTIU: Opacitat al 70% i ESCALA DE GRISOS (B&N)
                  !activeTech && "opacity-70 grayscale",
                  
                  // ESTAT ACTIU (HOVER):
                  // 1. grayscale-0 -> Recupera el color original (Vermell per n8n, Lila per Make)
                  // 2. opacity-100 -> Totalment visible
                  // 3. scale-110 -> Una mica mÃ©s gran
                  activeTech === tech.name && "opacity-100 grayscale-0 scale-110 drop-shadow-xl",
                  
                  // ESTAT QUAN UN ALTRE ESTÃ€ ACTIU: MÃ©s apagat
                  activeTech && activeTech !== tech.name && "opacity-30 grayscale scale-90"
                )}
              >
                <tech.Icon className="w-full h-full" />
              </motion.div>

              <motion.span
                initial={{ opacity: 0, y: -10 }}
                animate={{
                  opacity: activeTech === tech.name ? 1 : 0,
                  y: activeTech === tech.name ? 0 : -10
                }}
                className="absolute top-full mt-4 text-xs font-bold whitespace-nowrap px-3 py-1 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-lg z-20 pointer-events-none"
                style={{ color: activeTech === tech.name ? tech.color : 'inherit' }}
              >
                {tech.name}
              </motion.span>
            </div>
          ))}
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/TestimonialsSection.tsx ===================

// FITXER: src/components/landing/TestimonialsSection.tsx

'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Star, Quote, ChevronLeft, ChevronRight, Globe, Smartphone, Zap, Users, Code, ExternalLink } from 'lucide-react';
import Image, { StaticImageData } from 'next/image';
import Link from 'next/link';
import type { Testimonial } from '@/lib/data';
import { useTranslations } from 'next-intl';

type Props = {
   testimonials: Testimonial[];
};

export function TestimonialsSection({ testimonials }: Props) {
   const t = useTranslations('Testimonials'); // Namespace principal
   const [currentIndex, setCurrentIndex] = useState(0);
   const [itemsToShow, setItemsToShow] = useState(3);

   useEffect(() => {
      const handleResize = () => {
         if (window.innerWidth < 768) {
            setItemsToShow(1);
         } else {
            setItemsToShow(3);
         }
      };
      handleResize();
      window.addEventListener('resize', handleResize);
      return () => window.removeEventListener('resize', handleResize);
   }, []);

   const nextSlide = () => setCurrentIndex((prev) => (prev + 1) % testimonials.length);
   const prevSlide = () => setCurrentIndex((prev) => (prev - 1 + testimonials.length) % testimonials.length);

   const getVisibleItems = () => {
      const items = [];
      for (let i = 0; i < itemsToShow; i++) {
         items.push(testimonials[(currentIndex + i) % testimonials.length]);
      }
      return items;
   };

   return (
      <section id="testimonis" className="py-16 bg-muted/30 relative overflow-hidden">
         <div className="container mx-auto px-6 md:px-10 lg:px-14 relative z-10">

            {/* CAPÃ‡ALERA TRADUÃDA */}
            <div className="flex flex-col md:flex-row justify-between items-end md:mb-16 gap-6">
               <div className="max-w-2xl">
                  <h2 className="text-3xl lg:text-5xl font-bold text-foreground leading-tight">
                     {t('title_prefix')} <br />
                     <span className="text-transparent bg-clip-text bg-linear-to-r from-primary to-purple-500 pb-2">{t('title_highlight')}</span>.
                  </h2>
               </div>

               <div className="flex gap-3">
                  <button onClick={prevSlide} className="p-3 rounded-full border border-border bg-card hover:bg-primary hover:text-white transition-all shadow-sm" aria-label="Previous">
                     <ChevronLeft className="w-6 h-6" />
                  </button>
                  <button onClick={nextSlide} className="p-3 rounded-full border border-border bg-card hover:bg-primary hover:text-white transition-all shadow-sm" aria-label="Next">
                     <ChevronRight className="w-6 h-6" />
                  </button>
               </div>
            </div>

            {/* GRID */}
            <div className={`grid gap-8 py-6 ${itemsToShow === 1 ? 'grid-cols-1' : 'grid-cols-3'}`}>
               <AnimatePresence mode='popLayout'>
                  {getVisibleItems().map((item, i) => (
                     <motion.div
                        key={`${item.id}-${currentIndex + i}`}
                        initial={{ opacity: 0, x: 50 }}
                        animate={{ opacity: 1, x: 0 }}
                        exit={{ opacity: 0, x: -50 }}
                        transition={{ duration: 0.4, ease: "easeInOut" }}
                        className="h-112.5 perspective-1000"
                     >
                        <TestimonialCard item={item} />
                     </motion.div>
                  ))}
               </AnimatePresence>
            </div>

         </div>
      </section>
   );
}

// --- SUB-COMPONENTS TRADUÃTS ---

function TestimonialCard({ item }: { item: Testimonial }) {
   const t = useTranslations('Testimonials'); // Reutilitzem el namespace

   return (
      <div className="relative w-full h-full group">
         <div className="absolute inset-x-4 top-4 bottom-20 transition-all duration-500 cubic-bezier(0.25, 0.8, 0.25, 1) group-hover:-translate-y-20 ">
            <div className="w-full h-full rounded-t-xl overflow-hidden border border-primary/20 bg-slate-900 dark:bg-black shadow-2xl group-hover:shadow-primary/20">
               {item.projectType === 'web' && <MockupWeb url={item.projectUrl} image={item.image} title={item.company} />}
               {item.projectType === 'app' && <MockupApp url={item.projectUrl} image={item.image} title={item.company} />}
               {item.projectType === 'automation' && <MockupAutomation />}
            </div>
         </div>

         <div className="absolute bottom-0 left-0 right-0 h-70 bg-card border border-border rounded-2xl p-8 shadow-xl z-10 transition-transform duration-500 group-hover:translate-y-6 flex flex-col">
            <Quote className="absolute top-6 right-6 text-primary/10 w-12 h-12 rotate-180" />

            <div className="flex items-center gap-3 mb-4">
               <div className="w-12 h-12 rounded-full bg-linear-to-br from-primary/20 to-blue-500/20 border border-primary/30 flex items-center justify-center text-lg font-bold text-primary shrink-0">
                  {item.name.charAt(0)}
               </div>
               <div>
                  <div className="font-bold text-foreground text-sm md:text-base">{item.name}</div>
                  <div className="text-xs text-muted-foreground">{item.company}</div>
               </div>
            </div>

            <div className="flex gap-1 mb-4">
               {[...Array(5)].map((_, i) => (
                  <Star key={i} className={`w-4 h-4 ${i < item.rating ? 'fill-yellow-400 text-yellow-400' : 'text-slate-300 dark:text-slate-700'}`} />
               ))}
            </div>

            <p className="text-sm md:text-base text-muted-foreground leading-relaxed overflow-hidden text-ellipsis line-clamp-4">
               "{item.text}"
            </p>

            <div className="mt-auto pt-4 border-t border-border flex justify-between items-center opacity-50">
               <span className="text-[10px] uppercase tracking-widest font-bold">{t('project_label')}</span>
               <div className="w-16 h-1 bg-foreground/10 rounded-full"></div>
            </div>
         </div>
      </div>
   )
}

function MockupWeb({ url, image, title }: { url?: string, image?: string | StaticImageData, title: string }) {
   const t = useTranslations('Testimonials.mockups'); // Namespace especÃ­fic per botons
   const Wrapper = url ? Link : 'div';

   return (
      <Wrapper href={url || '#'} target={url ? "_blank" : undefined} className="block w-full h-full cursor-pointer group/mockup">
         <div className="w-full h-full bg-slate-50 dark:bg-[#0f111a] flex flex-col relative">
            {url && (
               <div className="absolute inset-0 z-30 bg-black/60 backdrop-blur-[2px] flex items-center justify-center opacity-0 group-hover/mockup:opacity-100 transition-opacity duration-300">
                  <span className="bg-white text-black px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-lg transform scale-90 group-hover/mockup:scale-100 transition-transform">
                     {t('visit_web')} <ExternalLink className="w-3 h-3" />
                  </span>
               </div>
            )}
            <div className="h-6 bg-slate-200 dark:bg-white/10 flex items-center px-3 gap-1.5 z-10">
               <div className="w-2 h-2 rounded-full bg-red-400/80"></div>
               <div className="w-2 h-2 rounded-full bg-yellow-400/80"></div>
               <div className="w-2 h-2 rounded-full bg-green-400/80"></div>
            </div>
            <div className="flex-1 relative w-full">
               {image ? (
                  <Image src={image} alt={title} fill className="object-cover object-top" />
               ) : (
                  <div className="flex flex-col items-center justify-center h-full gap-2 bg-white dark:bg-black/50">
                     <Globe className="w-8 h-8 text-blue-500/20" />
                     <span className="text-xs text-muted-foreground font-bold">{title}</span>
                  </div>
               )}
            </div>
         </div>
      </Wrapper>
   )
}

function MockupApp({ url, image, title }: { url?: string, image?: string | StaticImageData, title: string }) {
   const t = useTranslations('Testimonials.mockups');
   const Wrapper = url ? Link : 'div';
   return (
      <Wrapper href={url || '#'} target={url ? "_blank" : undefined} className="block w-full h-full cursor-pointer group/mockup">
         <div className="w-full h-full bg-slate-800 dark:bg-black flex items-end justify-center p-4 pb-0 group/mockup relative">
            <div className="absolute inset-0 z-30 bg-black/60 backdrop-blur-[2px] flex items-center justify-center opacity-0 group-hover/mockup:opacity-100 transition-opacity duration-300 rounded-t-xl">
               <span className="bg-white text-black px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-lg">
                  {t('view_app')} <ExternalLink className="w-3 h-3" />
               </span>
            </div>
            <div className="w-32 h-full bg-black border-2 border-slate-700 rounded-t-xl overflow-hidden relative">
               {image ? (
                  <Image src={image} alt={title} fill className="object-cover" />
               ) : (
                  <div className="w-full h-full bg-slate-900 flex flex-col items-center justify-center">
                     <Smartphone className="w-6 h-6 text-primary" />
                     <span className="text-[10px] text-slate-400 mt-2">{title}</span>
                  </div>
               )}
            </div>
         </div>
      </Wrapper>
   )
}

function MockupAutomation() {
   const t = useTranslations('Testimonials.mockups');

   return (
      <div className="w-full h-full bg-[#1a1d2d] relative overflow-hidden group/mockup">
         <div className="absolute inset-0 z-30 bg-black/60 backdrop-blur-[2px] flex items-center justify-center opacity-0 group-hover/mockup:opacity-100 transition-opacity duration-300">
            <span className="bg-white text-black px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-lg">
               {t('view_flow')} <Zap className="w-3 h-3" />
            </span>
         </div>
         <div className="absolute inset-0 bg-[radial-gradient(#ffffff10_1px,transparent_1px)] bg-size-[12px_12px]"></div>
         <svg className="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 100 100" preserveAspectRatio="none">
            {/* ... SVG Path Logic ... (mateix que tenies) */}
            <defs>
               <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#a855f7" stopOpacity="0.5" />
                  <stop offset="100%" stopColor="#22c55e" stopOpacity="0.5" />
               </linearGradient>
            </defs>
            <path
               d="M 20 30 C 50 30, 50 70, 80 70"
               stroke="url(#lineGradient)"
               strokeWidth="1.5"
               fill="none"
               vectorEffect="non-scaling-stroke"
            />
            <motion.circle
               r="3"
               fill="#a855f7"
               animate={{ offsetDistance: ["0%", "100%"] }}
               transition={{ duration: 2, repeat: Infinity, ease: "linear" }}
               style={{ offsetPath: "path('M 20 30 C 50 30, 50 70, 80 70')" }}
            />
         </svg>
         <div className="absolute left-[20%] top-[30%] -translate-x-1/2 -translate-y-1/2 w-10 h-10 rounded-lg bg-purple-500/20 border border-purple-500 flex items-center justify-center z-10 shadow-[0_0_15px_rgba(168,85,247,0.4)] backdrop-blur-sm">
            <Users className="w-5 h-5 text-purple-400" />
         </div>
         <div className="absolute left-[80%] top-[50%] -translate-x-1/2 -translate-y-1/2 w-10 h-10 rounded-lg bg-green-500/20 border border-green-500 flex items-center justify-center z-10 shadow-[0_0_15px_rgba(34,197,94,0.4)] backdrop-blur-sm">
            <Code className="w-5 h-5 text-green-400" />
         </div>
      </div>
   )
}

// =================== FILE: src/components/layout/Footer.tsx ===================

'use client';

// 1ï¸âƒ£ CANVI IMPORTANT: Fem servir el Link del router internacionalitzat
import { Link } from '@/routing'; 
import { Facebook, Instagram, Linkedin, Mail, MapPin } from 'lucide-react';
import { useTranslations } from 'next-intl';

const SOCIALS = [
  { icon: Linkedin, href: "https://www.linkedin.com/in/digitai-studios-105a0136a/", label: 'LinkedIn' },
  { icon: Instagram, href: "https://www.instagram.com/digitaistudios/", label: 'Instagram' },
  { icon: Facebook, href: "https://www.facebook.com/profile.php?id=61576974390567", label: 'Facebook' },
];

export function Footer() {
  const t = useTranslations('Footer');
  const tNav = useTranslations('Navbar');
  const currentYear = new Date().getFullYear();

  // 2ï¸âƒ£ CANVI DE LÃ’GICA: Afegim '/' davant dels '#'
  // AixÃ² li diu al navegador: "Ves a la pÃ gina d'inici (/) i desprÃ©s busca la secciÃ³ (#)"
  const FOOTER_LINKS = [
    {
      title: t('services_title'),
      links: [
        { label: 'AppWebs & SaaS', href: '/#serveis' },       // Abans '#serveis'
        { label: 'Apps MÃ²bils', href: '/#serveis' },          // Abans '#serveis'
        { label: 'AutomatitzaciÃ³ IA', href: '/#serveis' },    // Abans '#serveis'
        { label: 'FormaciÃ³ In-Company', href: '/#serveis' },  // Abans '#serveis'
      ],
    },
    {
      title: t('company_title'),
      links: [
        { label: t('about'), href: '/#hero' },                // Abans '#hero'
        { label: tNav('projects'), href: '/projectes' },      // Rutes absolutes (correcte)
        { label: tNav('blog'), href: '/blog' },
        { label: t('contact'), href: '/#contacte' },          // Abans '#contacte'
      ],
    },
    {
      title: t('legal_title'),
      links: [
        { label: t('legal_notice'), href: '/legal/avis-legal' },
        { label: t('privacy'), href: '/legal/privacitat' },
        { label: t('cookies'), href: '/legal/cookies' },
      ],
    },
  ];

  return (
    <footer className="bg-background border-t border-border pt-16 pb-8 transition-colors duration-300">
      <div className="container mx-auto px-6 md:px-14">
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-12 mb-16">
          
          {/* COLUMNA 1: MARCA & INFO */}
          <div className="lg:col-span-2 space-y-6">
            <Link href="/" className="inline-block">
              <span className="text-2xl font-bold tracking-tight text-foreground">
                DigitAI <span className="gradient-text">Studios</span>
              </span>
            </Link>
            <p className="text-muted-foreground leading-relaxed max-w-sm text-sm">
              {t('description')}
            </p>
            
            <div className="flex gap-4">
              {SOCIALS.map((social, i) => (
                <a 
                  key={i}
                  href={social.href}
                  target="_blank"
                  rel="noopener noreferrer"
                  aria-label={social.label}
                  className="w-9 h-9 rounded-full bg-muted/50 flex items-center justify-center text-muted-foreground hover:bg-primary/10 hover:text-primary transition-all border border-transparent hover:border-primary/20"
                >
                  <social.icon className="w-4 h-4" />
                </a>
              ))}
            </div>

            <div className="space-y-3 pt-2">
                <div className="flex items-center gap-3 text-sm text-muted-foreground group">
                    <Mail className="w-4 h-4 text-primary group-hover:scale-110 transition-transform" />
                    <a href="mailto:info@digitaistudios.com" className="hover:text-foreground transition-colors">
                        info@digitaistudios.com
                    </a>
                </div>
                <div className="flex items-center gap-3 text-sm text-muted-foreground">
                    <MapPin className="w-4 h-4 text-primary" />
                    <span>Girona, Catalunya</span>
                </div>
            </div>
          </div>

          {/* COLUMNS DINÃ€MIQUES DE LINKS */}
          {FOOTER_LINKS.map((section) => (
            <div key={section.title} className="space-y-6">
              <h4 className="font-bold text-foreground text-base">{section.title}</h4>
              <ul className="space-y-3">
                {section.links.map((link) => (
                  <li key={link.label}>
                    <Link 
                      href={link.href} 
                      className="text-sm text-muted-foreground hover:text-primary transition-colors flex items-center gap-2 group w-fit"
                    >
                      <span className="w-1.5 h-1.5 rounded-full bg-primary/0 group-hover:bg-primary transition-all duration-300"></span>
                      {link.label}
                    </Link>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>

        {/* COPYRIGHT */}
        <div className="border-t border-border pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-muted-foreground">
          <p>Â© {currentYear} DigitAI Studios. {t('rights_reserved')}</p>
          <div className="flex items-center gap-1">
             <span>{t('made_with_love')}</span>
          </div>
        </div>

      </div>
    </footer>
  );
}

// =================== FILE: src/components/layout/LanguageSwitcher.tsx ===================

// =================== FILE: src/components/layout/LanguageSwitcher.tsx ===================

'use client';

import { useLocale, useTranslations } from 'next-intl';
import { usePathname, useRouter } from '@/routing'; 
import { Button } from '@/components/ui/button';
import { 
  DropdownMenu, 
  DropdownMenuContent, 
  DropdownMenuItem, 
  DropdownMenuTrigger 
} from '@/components/ui/dropdown-menu'; 
import { Languages } from 'lucide-react';
import { startTransition } from 'react';

// --- COMPONENTS SVG FLAGS (Disseny consistent 36x24) ---

function CatalanFlag({ className }: { className?: string }) {
  return (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24" className={className} preserveAspectRatio="none">
      <rect width="36" height="24" fill="#FACC15" /> 
      <rect y="3" width="36" height="3" fill="#EF4444" />
      <rect y="9" width="36" height="3" fill="#EF4444" />
      <rect y="15" width="36" height="3" fill="#EF4444" />
      <rect y="21" width="36" height="3" fill="#EF4444" />
    </svg>
  );
}

function SpanishFlag({ className }: { className?: string }) {
  return (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24" className={className} preserveAspectRatio="none">
      {/* Vermell Superior */}
      <rect width="36" height="6" fill="#AD1519" />
      {/* Groc Central */}
      <rect y="6" width="36" height="12" fill="#FABD00" />
      {/* Vermell Inferior */}
      <rect y="18" width="36" height="6" fill="#AD1519" />
    </svg>
  );
}

function EnglishFlag({ className }: { className?: string }) {
  // VersiÃ³ simplificada USA per icones petites
  return (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24" className={className} preserveAspectRatio="none">
      <rect width="36" height="24" fill="#B22234" />
      <rect y="2.18" width="36" height="2.18" fill="white" />
      <rect y="6.54" width="36" height="2.18" fill="white" />
      <rect y="10.9" width="36" height="2.18" fill="white" />
      <rect y="15.26" width="36" height="2.18" fill="white" />
      <rect y="19.62" width="36" height="2.18" fill="white" />
      {/* CantÃ³ Blau */}
      <rect width="14.4" height="12.9" fill="#3C3B6E" />
      {/* Estrelles simplificades (punts blancs) */}
      <circle cx="2.5" cy="2.5" r="1" fill="white" />
      <circle cx="7" cy="6" r="1" fill="white" />
      <circle cx="11.5" cy="10" r="1" fill="white" />
    </svg>
  );
}

function ItalianFlag({ className }: { className?: string }) {
  return (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 24" className={className} preserveAspectRatio="none">
      <rect width="12" height="24" fill="#008C45" /> 
      <rect x="12" width="12" height="24" fill="#FFFFFF" /> 
      <rect x="24" width="12" height="24" fill="#CD212A" /> 
    </svg>
  );
}

// --- CONFIGURACIÃ“ ---
// Mapeig de Locale -> Component Bandera
// AixÃ² permet afegir idiomes fÃ cilment en el futur
const LANGUAGE_CONFIG = {
  ca: { Flag: CatalanFlag, labelKey: 'ca' },
  es: { Flag: SpanishFlag, labelKey: 'es' },
  en: { Flag: EnglishFlag, labelKey: 'en' },
  it: { Flag: ItalianFlag, labelKey: 'it' },
} as const;

type SupportedLocale = keyof typeof LANGUAGE_CONFIG;

// --- COMPONENT PRINCIPAL ---

export function LanguageSwitcher() {
  const t = useTranslations('Common.languages');
  const locale = useLocale() as SupportedLocale;
  const router = useRouter();
  const pathname = usePathname();

  const handleLanguageChange = (nextLocale: SupportedLocale) => {
    startTransition(() => {
    
      router.replace(pathname, { locale: nextLocale });
    });
  };

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="icon" className="rounded-full hover:bg-muted w-9 h-9">
          <Languages className="w-5 h-5 text-muted-foreground" />
          <span className="sr-only">Canviar idioma</span>
        </Button>
      </DropdownMenuTrigger>
      
      <DropdownMenuContent align="end">
        {Object.entries(LANGUAGE_CONFIG).map(([key, config]) => {
          const langKey = key as SupportedLocale;
          const { Flag } = config;
          const isActive = locale === langKey;

          return (
            <DropdownMenuItem 
              key={langKey}
              onClick={() => handleLanguageChange(langKey)}
              className={`gap-3 cursor-pointer ${isActive ? 'bg-primary/10 font-bold text-primary' : ''}`}
            >
              <Flag className="w-6 h-4 rounded-[2px] shadow-sm object-cover border border-black/10" /> 
              <span className="leading-none text-sm">{t(key)}</span>
              
              {isActive && (
                <span className="ml-auto w-1.5 h-1.5 rounded-full bg-primary animate-pulse" />
              )}
            </DropdownMenuItem>
          );
        })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

// =================== FILE: src/components/layout/LegalLayout.tsx ===================

'use client';


import Link from "next/link";
import { usePathname } from "next/navigation";
import { cn } from "@/lib/utils";
import { Scale, Shield, Cookie, FileText } from "lucide-react";
import { createClient } from '@/lib/supabase/client';
import { useEffect, useState } from "react";
import type { User } from '@supabase/supabase-js';
import { useTranslations } from 'next-intl'; // Importem el hook

export default function LegalLayout({ children }: { children: React.ReactNode }) {
  const t = useTranslations('LegalLayout'); // Namespace LegalLayout
  const pathname = usePathname();
  const [user, setUser] = useState<User | null>(null);
  
  useEffect(() => {
    const supabase = createClient();
    supabase.auth.getUser().then(({ data }) => setUser(data.user));
  }, []);

  // Definim els links a dins per traduir-los
  const LEGAL_NAV = [
    { name: t('links.notice'), href: '/legal/avis-legal', icon: Scale },
    { name: t('links.privacy'), href: '/legal/privacitat', icon: Shield },
    { name: t('links.cookies'), href: '/legal/cookies', icon: Cookie },
  ];

  const cleanPath = pathname.replace(/^\/[a-z]{2}\//, '/').replace(/^\/[a-z]{2}$/, '');

  return (
    <div className="min-h-screen flex flex-col bg-background text-foreground">
      
      
      <main className="flex-1 container mx-auto px-4 py-32">
        <div className="grid lg:grid-cols-4 gap-10">
          
          {/* SIDEBAR NAVEGACIÃ“ */}
          <aside className="lg:col-span-1 hidden lg:block">
             <div className="sticky top-32 space-y-4">
                <div className="px-4">
                    <h3 className="font-bold text-lg flex items-center gap-2 text-foreground">
                        <FileText className="w-5 h-5 text-primary" /> 
                        {t('sidebar_title')}
                    </h3>
                    <p className="text-xs text-muted-foreground mt-1">
                        {t('sidebar_desc')}
                    </p>
                </div>

                <nav className="flex flex-col space-y-1">
                   {LEGAL_NAV.map((item) => {
                      const isActive = cleanPath === item.href || pathname.endsWith(item.href);

                      return (
                        <Link 
                           key={item.href} 
                           href={item.href}
                           className={cn(
                             "flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200",
                             isActive 
                               ? "bg-primary/10 text-primary border border-primary/20 shadow-sm font-bold" 
                               : "text-muted-foreground hover:bg-muted hover:text-foreground border border-transparent"
                           )}
                        >
                           <item.icon className={cn("w-4 h-4", isActive && "text-primary")} />
                           {item.name}
                        </Link>
                      )
                   })}
                </nav>
             </div>
          </aside>

          {/* MENU MÃ’BIL */}
          <div className="lg:hidden col-span-1 mb-6 overflow-x-auto pb-2 scrollbar-hide">
             <div className="flex gap-2 w-max">
                {LEGAL_NAV.map((item) => {
                    const isActive = cleanPath === item.href || pathname.endsWith(item.href);
                    return (
                        <Link 
                           key={item.href} 
                           href={item.href}
                           className={cn(
                             "flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium border transition-colors whitespace-nowrap",
                             isActive 
                               ? "bg-primary text-primary-foreground border-primary" 
                               : "bg-background border-border text-muted-foreground"
                           )}
                        >
                           <item.icon className="w-4 h-4" />
                           {item.name}
                        </Link>
                    )
                })}
             </div>
          </div>

          {/* CONTINGUT PRINCIPAL */}
          <div className="lg:col-span-3">
             <div className="bg-card border border-border rounded-3xl p-8 md:p-12 shadow-sm animate-in fade-in slide-in-from-bottom-4 duration-500">
                <article className="prose prose-slate dark:prose-invert max-w-none prose-headings:font-bold prose-a:text-primary hover:prose-a:underline prose-img:rounded-xl">
                   {children}
                </article>
             </div>
          </div>

        </div>
      </main>
   
    </div>
  );
}

// =================== FILE: src/components/layout/Navbar.tsx ===================

'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useTranslations } from 'next-intl';
import { ChevronDown } from 'lucide-react';
import { cn } from '@/lib/utils';
import type { User as SupabaseUser } from '@supabase/supabase-js';
import Image from 'next/image';
import logo from '@/assets/images/digitai-logo.png';

// COMPONENTS
import { ThemeToggle } from "@/components/ui/theme-toggle";
import { LanguageSwitcher } from './LanguageSwitcher';
import { UserNav } from './UserNav';
import { PublicMobileNav } from './PublicMobilNav';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

type Props = {
  user: SupabaseUser | null;
};

// Definim els links del Dropdown
const DROPDOWN_LINKS = [
  { href: '/#solutions', label: 'Solucions TecnolÃ²giques' },
  { href: '/#services', label: 'Serveis & Packs' },
  { href: '/#audit', label: 'Auditoria Web GratuÃ¯ta' },
  { href: '/#blog-feed', label: 'Blog & Recursos' },
  { href: '/#testimonials', label: "Casos d'Ãˆxit" },
  { href: '/#contact', label: 'Contacte' }
];

export function Navbar({ user }: Props) {
  const t = useTranslations('Navbar');
  const [isScrolled, setIsScrolled] = useState(false);
  const pathname = usePathname();

  // Control d'scroll per canviar l'estil del header
  useEffect(() => {
    const handleScroll = () => setIsScrolled(window.scrollY > 20);
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  const handleScrollToSection = (e: React.MouseEvent<HTMLAnchorElement>, href: string) => {
    const isHomePage = ['/', '/ca', '/es', '/en', '/it'].includes(pathname);

    if (isHomePage && href.includes('#')) {
      e.preventDefault();
      const id = href.split('#')[1];
      const element = document.getElementById(id);
      if (element) {
        const headerOffset = 85;
        const elementPosition = element.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
        window.scrollTo({ top: offsetPosition, behavior: "smooth" });
        window.history.pushState(null, '', href);
      }
    }
  };

  return (
    <>
      <header
        className={cn(
          "fixed top-0 w-full z-50 transition-all duration-300 border-b border-transparent",
          isScrolled
            ? "bg-background/80 backdrop-blur-xl shadow-sm border-border py-3"
            : "bg-transparent py-4 md:py-6"
        )}
      >
        <div className="container mx-auto px-4 flex items-center justify-between">

          {/* 1. LOGO DE MARCA - AMB EFECTE "VIU" */}
          <Link href="/" className="flex items-center space-x-2">
            {/* MODIFICACIÃ“ AQUÃ:
                - transition-all duration-300: Suavitat en l'animaciÃ³.
                - hover:scale-110: Es fa un 10% mÃ©s gran.
                - hover:drop-shadow-[...]: Crea la brillantor lila (#a855f7) al voltant de la silueta.
            */}
            <div className="relative h-8 w-32 transition-all duration-300 ease-in-out hover:scale-110 hover:drop-shadow-[0_0_15px_rgba(168,85,247,0.7)]">
              <Image
                src={logo}
                alt="DigitAI Studios Logo"
                fill
                className="object-contain object-left"
                priority
              />
            </div>
          </Link>

          {/* 2. MENU ESCRIPTORI CENTRAL */}
          <nav className="hidden md:flex items-center gap-8">
            <Link href="/" className={cn("text-sm font-medium hover:text-primary transition-colors", pathname === '/' ? "text-primary" : "text-muted-foreground")}>
              {t('home')}
            </Link>

            {/* Dropdown "Solucions" */}
            <DropdownMenu>
              <DropdownMenuTrigger className="flex items-center gap-1 text-sm font-medium text-muted-foreground hover:text-primary transition-colors outline-none data-[state=open]:text-primary group">
                {t('solutions')}
                <ChevronDown className="w-4 h-4 transition-transform duration-200 group-data-[state=open]:rotate-180" />
              </DropdownMenuTrigger>

              <DropdownMenuContent align="start" className="w-56 p-2 bg-card border-border shadow-xl">
                {DROPDOWN_LINKS.map((link) => (
                  <DropdownMenuItem key={link.href} asChild>
                    <Link
                      href={link.href}
                      onClick={(e) => handleScrollToSection(e, link.href)}
                      className="cursor-pointer font-medium text-sm py-2.5 px-3 rounded-md hover:bg-primary/10 hover:text-primary transition-colors block w-full"
                    >
                      {link.label}
                    </Link>
                  </DropdownMenuItem>
                ))}
              </DropdownMenuContent>
            </DropdownMenu>

            <Link href="/projectes" className={cn("text-sm font-medium hover:text-primary transition-colors", pathname === '/projectes' ? "text-primary" : "text-muted-foreground")}>
              {t('projects')}
            </Link>

            <Link href="/blog" className={cn("text-sm font-medium hover:text-primary transition-colors", pathname === '/blog' ? "text-primary" : "text-muted-foreground")}>
              {t('blog')}
            </Link>
          </nav>

          {/* 3. Ã€REA D'ACCIONS (DRETA) */}
          <div className="flex items-center gap-2 md:gap-4">
            {/* Utilitats */}
            <div className="hidden md:flex items-center gap-1 pr-2 border-r border-border/50">
              <ThemeToggle />
              <LanguageSwitcher />
            </div>

            {/* MÃ²bil: NomÃ©s mostrar toggles, el menÃº va a baix */}
            <div className="flex md:hidden gap-1">
              <ThemeToggle />
              <LanguageSwitcher />
            </div>

            {/* LÃ²gica d'Usuari encapsulada */}
            <UserNav user={user} />
          </div>

        </div>
      </header>

      {/* 4. BARRA DE NAVEGACIÃ“ MÃ’BIL */}
      <PublicMobileNav user={user} />
    </>
  );
}

// =================== FILE: src/components/layout/PublicMobilNav.tsx ===================

'use client';

import { Link, usePathname } from '@/routing';
import { Home, Zap, FolderGit2, BookOpen, LayoutDashboard, UserCircle, type LucideIcon, ChevronUp } from 'lucide-react';
import { cn } from '@/lib/utils';
import { useTranslations } from 'next-intl';
import type { User } from '@supabase/supabase-js';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

// 1. Definim el tipus d'item
type NavItem = {
  id: string;
  label: string;
  href: string;
  icon: LucideIcon;
  isDropdown?: boolean;
};

interface PublicMobileNavProps {
  user: User | null;
}

export function PublicMobileNav({ user }: PublicMobileNavProps) {
  const t = useTranslations('Navbar');
  const pathname = usePathname();

  const handleScrollToSection = (e: React.MouseEvent<HTMLAnchorElement>, href: string) => {
    const isHomePage = pathname.replace(/^\/[a-z]{2}/, '') === '' || pathname === '/';

    if (isHomePage && href.includes('#')) {
      e.preventDefault();
      const id = href.split('#')[1];
      const element = document.getElementById(id);

      if (element) {
        setTimeout(() => {
          const headerOffset = 85;
          const elementPosition = element.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
          window.scrollTo({ top: offsetPosition, behavior: "smooth" });
          window.history.pushState(null, '', href);
        }, 100);
      }
    }
  };

  const SOLUTIONS_LINKS = [
    { href: '/#solutions', label: 'Solucions Tech' },
    { href: '/#services', label: 'Serveis' },
    { href: '/#audit', label: 'Auditoria Web' },
    { href: '/#testimonials', label: "Casos d'Ãˆxit" },
    { href: '/#contacte', label: 'Contacte' }
  ];

  const authItem: NavItem = user
    ? { id: 'auth', label: t('dashboard'), href: '/dashboard', icon: LayoutDashboard }
    : { id: 'auth', label: t('login'), href: '/auth/login', icon: UserCircle };

  const NAV_ITEMS: NavItem[] = [
    { id: 'home', label: t('home'), href: '/', icon: Home },
    { id: 'solutions', label: t('solutions'), href: '#', icon: Zap, isDropdown: true },
    { id: 'projects', label: t('projects'), href: '/projectes', icon: FolderGit2 },
    { id: 'blog', label: t('blog'), href: '/blog', icon: BookOpen },
    authItem,
  ];

  return (
    <div className="md:hidden fixed bottom-0 left-0 w-full z-50 bg-background/95 backdrop-blur-xl border-t border-border pb-safe transition-all duration-300">
      
      {/* ğŸ› ï¸ CANVI CLAU: 
          SubstituÃ¯m 'flex justify-around px-2' per 'grid grid-cols-5'.
          AixÃ² fa que cada icona tingui exactament la mateixa amplada.
      */}
      <div className="grid grid-cols-5 h-16 items-center">
        {NAV_ITEMS.map((item) => {

          const isActive = item.href === '/'
            ? pathname === '/'
            : pathname.startsWith(item.href.replace('/#', ''));

          const Icon = item.icon;
          const isAuthItem = item.id === 'auth';

          // --- CAS A: Ã‰S UN DROPDOWN (Solucions) ---
          if (item.isDropdown) {
            return (
              <DropdownMenu key={item.id}>
                <DropdownMenuTrigger className="flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform outline-none group focus:outline-none">
                  <div className="relative">
                    <Icon className={cn("w-6 h-6 group-data-[state=open]:text-primary text-muted-foreground")} strokeWidth={2.5} />
                    <div className="absolute -top-1 -right-1 bg-background rounded-full p-px border border-border">
                      <ChevronUp className="w-2 h-2 text-muted-foreground" />
                    </div>
                  </div>
                  <span className="text-[10px] font-medium text-muted-foreground group-data-[state=open]:text-primary truncate w-full text-center px-1">
                    {item.label}
                  </span>
                </DropdownMenuTrigger>

                <DropdownMenuContent
                  side="top"
                  align="center"
                  className="w-56 mb-4 p-2 bg-card/95 backdrop-blur-md border-border shadow-2xl rounded-xl z-[60]"
                >
                  {SOLUTIONS_LINKS.map((subLink) => (
                    <DropdownMenuItem key={subLink.href} asChild>
                      <Link
                        href={subLink.href}
                        onClick={(e) => handleScrollToSection(e, subLink.href)}
                        className="w-full cursor-pointer text-sm py-2.5 px-2 font-medium rounded-lg focus:bg-primary/10 active:bg-primary/10"
                      >
                        {subLink.label}
                      </Link>
                    </DropdownMenuItem>
                  ))}
                </DropdownMenuContent>
              </DropdownMenu>
            );
          }

          // --- CAS B: Ã‰S UN LINK NORMAL ---
          return (
            <Link
              key={item.id}
              href={item.href}
              onClick={(e) => item.href.includes('#') && handleScrollToSection(e, item.href)}
              className={cn(
                "flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform",
                isActive
                  ? "text-primary"
                  : isAuthItem && user
                    ? "text-foreground font-medium"
                    : "text-muted-foreground hover:text-foreground"
              )}
            >
              <Icon
                className={cn(
                  "w-6 h-6 transition-all",
                  isActive && "fill-current/20 scale-110",
                  (!isActive && isAuthItem) && "opacity-80"
                )}
                strokeWidth={isActive ? 2.5 : 2}
              />
              <span className={cn("text-[10px] truncate w-full text-center px-1", isActive ? "font-bold" : "font-medium")}>
                {item.label}
              </span>
            </Link>
          );
        })}
      </div>
    </div>
  );
}

// =================== FILE: src/components/layout/ScrollManager.tsx ===================

'use client'; // ğŸ‘ˆ Important: AixÃ² habilita els hooks

import { useScrollToAnchor } from '@/hooks/use-scroll-to-anchor';

export function ScrollManager() {
  // Activem el hook aquÃ­, on sÃ­ que estÃ  permÃ¨s
  useScrollToAnchor();
  
  return null; // No pinta res, nomÃ©s gestiona l'efecte
}

// =================== FILE: src/components/layout/UserNav.tsx ===================

'use client';

import { useState } from 'react';
import { useRouter, Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { LayoutDashboard, LogOut, ShieldAlert, Loader2 } from 'lucide-react';
import { signOutAction } from '@/features/auth/actions/auth';
import type { User } from '@supabase/supabase-js';
import { useTranslations } from 'next-intl';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';

interface UserNavProps {
  user: User | null;
}

export function UserNav({ user }: UserNavProps) {
  const t = useTranslations('Navbar');
  const router = useRouter();
  const [isSigningOut, setIsSigningOut] = useState(false);

  // ComprovaciÃ³ d'admin (Idealment aixÃ² vindria del perfil a la DB, perÃ² per UI rÃ pida serveix)
  const isAdmin = user?.email === 'digitaistudios.developer@gmail.com' || user?.user_metadata?.role === 'admin';

  const handleSignOut = async () => {
    setIsSigningOut(true);
    await signOutAction();
    router.refresh();
    router.push('/auth/login');
  };

  // CAS 1: USUARI AUTENTICAT
  if (user) {
    return (
      <div className="flex items-center gap-2 sm:gap-4">
        {/* EnllaÃ§ Admin (NomÃ©s visible en Desktop si Ã©s admin) */}
        {isAdmin && (
          <Link
            href="/admin"
            className="hidden sm:flex flex-col items-center justify-center gap-1 text-muted-foreground hover:text-red-500 transition-colors"
            title="Panell d'Administrador"
          >
            <ShieldAlert className="w-5 h-5" strokeWidth={2} />
          </Link>
        )}

        {/* BotÃ³ Dashboard Principal */}
        <Link href="/dashboard">
          <Button className="gradient-bg text-white border-0 shadow-lg shadow-primary/20 h-9 px-3 sm:px-4 sm:h-10 transition-transform hover:scale-105">
            <LayoutDashboard className="w-4 h-4 mr-2" /> 
            <span className="hidden sm:inline">{t('dashboard')}</span>
            <span className="sm:hidden">Dash</span>
          </Button>
        </Link>

        {/* Avatar + Logout (Simplificat) */}
        <div className="flex items-center gap-2 pl-2 border-l border-border/50">
            <Avatar className="h-8 w-8 border border-border hidden sm:block">
                <AvatarImage src={user.user_metadata?.avatar_url} />
                <AvatarFallback>{user.email?.[0]?.toUpperCase()}</AvatarFallback>
            </Avatar>
            
            <Button 
                variant="ghost" 
                size="icon" 
                onClick={handleSignOut} 
                disabled={isSigningOut}
                title={t('logout')}
                className="text-muted-foreground hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-950/30 rounded-full"
            >
            {isSigningOut ? <Loader2 className="w-5 h-5 animate-spin" /> : <LogOut className="w-5 h-5" />}
            </Button>
        </div>
      </div>
    );
  }

  // CAS 2: USUARI CONVIDAT (Guest)
  return (
    <div className="flex items-center gap-2 sm:gap-3">
      <Link href="/auth/login" className="text-sm font-bold text-muted-foreground hover:text-primary transition-colors px-2 hidden sm:block">
        {t('login')}
      </Link>
      <Link href="/auth/register">
        <Button className="gradient-bg text-white border-0 shadow-md shadow-primary/10 h-9 px-4 sm:h-10 rounded-full">
          {t('register')}
        </Button>
      </Link>
    </div>
  );
}

// =================== FILE: src/components/project-card-image.tsx ===================

import Image from 'next/image';
import { Project } from '@/types/models'; // O on tinguis la interfÃ­cie definida
import { cn } from '@/lib/utils';

interface ProjectCardImageProps {
  project: Project;
  locale: string; // L'idioma actual de la pÃ gina
  className?: string;
}

export function ProjectCardImage({ project, locale, className }: ProjectCardImageProps) {
  // 1. Comprovem si tenim imatges adaptatives per aquest projecte
  if (project.adaptiveImages) {
    // 2. Busquem el set d'imatges per l'idioma actual o fem servir el default
    const imageSet = project.adaptiveImages[locale] || project.adaptiveImages['default'];

    if (imageSet) {
      return (
        <div className={cn("relative w-full h-full", className)}>
          {/* Imatge per TEMA CLAR (Light Mode) */}
          <div className="block dark:hidden w-full h-full">
            <Image
              src={imageSet.light}
              alt={project.imageAlt}
              fill
              className="object-cover"
              sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
            />
          </div>

          {/* Imatge per TEMA FOSC (Dark Mode) */}
          <div className="hidden dark:block w-full h-full">
            <Image
              src={imageSet.dark}
              alt={project.imageAlt}
              fill
              className="object-cover"
              sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
            />
          </div>
        </div>
      );
    }
  }

  // 3. Fallback: Si no hi ha configuraciÃ³ adaptativa (cas RibotFlow), renderitzem la normal
  return (
    <div className={cn("relative w-full h-full", className)}>
      <Image
        src={project.image}
        alt={project.imageAlt}
        fill
        className="object-cover"
        sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
      />
    </div>
  );
}

// =================== FILE: src/components/theme-provider.tsx ===================

"use client"

import * as React from "react"
import { ThemeProvider as NextThemesProvider } from "next-themes"

export function ThemeProvider({
  children,
  ...props
}: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}

// =================== FILE: src/components/ui/alert-dialog.tsx ===================

"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}


// =================== FILE: src/components/ui/avatar.tsx ===================

"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }


// =================== FILE: src/components/ui/back-button.tsx ===================

'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';

interface BackButtonProps {
  projectId?: string; // Opcional: Si el sabem, podem forÃ§ar tornar al projecte
}

export function BackButton({ projectId }: BackButtonProps) {
  const router = useRouter();
  const searchParams = useSearchParams();
  
  // Mirem si venim amb un parÃ metre ?source=project
  const source = searchParams.get('source');

  const handleBack = () => {
    if (source === 'project' && projectId) {
      // Si venim explÃ­citament del projecte, tornem al projecte
      router.push(`/admin/projects/${projectId}`);
    } else {
      // Comportament per defecte (historial enrere o llista de tests)
      // Si no hi ha historial, router.back() a vegades no fa res, 
      // aixÃ­ que podrÃ­em forÃ§ar /admin/tests com a fallback segur.
      router.back();
    }
  };

  return (
    <Button 
      variant="ghost" 
      size="sm" 
      onClick={handleBack}
      className="text-slate-400 hover:text-white hover:bg-white/10 gap-2 pl-0"
    >
      <ArrowLeft className="w-4 h-4" />
      <span className="hidden sm:inline">Tornar enrere</span>
      <span className="sm:hidden">Tornar</span>
    </Button>
  );
}

// =================== FILE: src/components/ui/badge.tsx ===================

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }


// =================== FILE: src/components/ui/button.tsx ===================

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

// DefiniciÃ³ de les variants de disseny
const buttonVariants = cva(
  "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline: "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, ...props }, ref) => {
    return (
      <button
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }

// =================== FILE: src/components/ui/card.tsx ===================

import * as React from "react"
import { cn } from "@/lib/utils"

const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("rounded-lg border bg-card text-card-foreground shadow-sm", className)} {...props} />
  )
)
Card.displayName = "Card"

const CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("flex flex-col space-y-1.5 p-6", className)} {...props} />
  )
)
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(
  ({ className, ...props }, ref) => (
    <h3 ref={ref} className={cn("text-2xl font-semibold leading-none tracking-tight", className)} {...props} />
  )
)
CardTitle.displayName = "CardTitle"

const CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
  )
)
CardContent.displayName = "CardContent"

export { Card, CardHeader, CardTitle, CardContent }

// =================== FILE: src/components/ui/checkbox.tsx ===================

"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="grid place-content-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }


// =================== FILE: src/components/ui/dropdown-menu.tsx ===================

'use client';

import * as React from 'react';
import { Slot } from '@radix-ui/react-slot';
import { cn } from '@/lib/utils';

// Context per gestionar l'estat obert/tancat
const DropdownContext = React.createContext<{
  open: boolean;
  setOpen: (open: boolean) => void;
} | null>(null);

export const DropdownMenu = ({ children }: { children: React.ReactNode }) => {
  const [open, setOpen] = React.useState(false);
  const containerRef = React.useRef<HTMLDivElement>(null);

  // Tancar si es clica fora
  React.useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  return (
    <DropdownContext.Provider value={{ open, setOpen }}>
      <div ref={containerRef} className="relative inline-block text-left">
         {children}
      </div>
    </DropdownContext.Provider>
  );
};

export const DropdownMenuTrigger = React.forwardRef<
  HTMLButtonElement,
  React.ButtonHTMLAttributes<HTMLButtonElement> & { asChild?: boolean }
>(({ className, children, asChild = false, ...props }, ref) => {
  const context = React.useContext(DropdownContext);
  if (!context) throw new Error("DropdownMenuTrigger must be used within DropdownMenu");

  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      ref={ref}
      onClick={(e) => {
        if (props.onClick) props.onClick(e);
        context.setOpen(!context.open);
      }}
      data-state={context.open ? 'open' : 'closed'}
      className={className}
      {...props}
    >
      {children}
    </Comp>
  );
});
DropdownMenuTrigger.displayName = "DropdownMenuTrigger";

// âœ… AQUÃ ESTÃ€ LA SOLUCIÃ“: Afegim 'side' a la definiciÃ³ de tipus
export const DropdownMenuContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & { 
    align?: 'start' | 'end' | 'center'; 
    side?: 'top' | 'bottom'; // ğŸ‘ˆ AFEGIT: Ara TypeScript accepta aquesta propietat
  }
>(({ className, align = 'center', side = 'bottom', children, ...props }, ref) => {
  const context = React.useContext(DropdownContext);
  if (!context) throw new Error("DropdownMenuContent must be used within DropdownMenu");

  if (!context.open) return null;

  const alignmentClasses = {
    start: 'left-0',
    end: 'right-0',
    center: 'left-1/2 -translate-x-1/2',
  };

  // âœ… LÃ²gica CSS per posar-ho a dalt o a baix
  const sideClasses = {
    top: 'bottom-full mb-2 origin-bottom', // Surt cap amunt
    bottom: 'mt-2 origin-top',             // Surt cap avall (default)
  };

  return (
    <div
      ref={ref}
      className={cn(
        "absolute z-50 min-w-48 overflow-hidden rounded-md border border-border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95",
        alignmentClasses[align],
        sideClasses[side], // ğŸ‘ˆ Apliquem la classe
        className
      )}
      {...props}
    >
      {children}
    </div>
  );
});
DropdownMenuContent.displayName = "DropdownMenuContent";

export interface DropdownMenuItemProps extends React.HTMLAttributes<HTMLDivElement> {
  inset?: boolean;
  asChild?: boolean;
}

export const DropdownMenuItem = React.forwardRef<HTMLDivElement, DropdownMenuItemProps>(
  ({ className, inset, asChild = false, onClick, ...props }, ref) => {
    const context = React.useContext(DropdownContext);
    
    const handleClick = (e: React.MouseEvent<HTMLDivElement>) => {
      if (onClick) onClick(e);
      context?.setOpen(false); 
    };

    const Comp = asChild ? Slot : "div";

    return (
      <Comp
        ref={ref}
        onClick={handleClick}
        className={cn(
          "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors hover:bg-accent hover:text-accent-foreground data-disabled:pointer-events-none data-disabled:opacity-50",
          inset && "pl-8",
          className
        )}
        {...props}
      />
    );
  }
);
DropdownMenuItem.displayName = "DropdownMenuItem";

// =================== FILE: src/components/ui/input.tsx ===================

import * as React from "react"
import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.InputHTMLAttributes<HTMLInputElement>>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }

// =================== FILE: src/components/ui/pagination-controls.tsx ===================

'use client';

import { Button } from '@/components/ui/button'; // Si tens Shadcn, sinÃ³ un button normal
import { useRouter, useSearchParams } from 'next/navigation';

interface Props {
  metadata: {
    page: number;
    totalPages: number;
    total: number;
  };
}

export function PaginationControls({ metadata }: Props) {
  const router = useRouter();
  const searchParams = useSearchParams();

  const handlePageChange = (newPage: number) => {
    const params = new URLSearchParams(searchParams);
    params.set('page', newPage.toString());
    router.push(`?${params.toString()}`); // AixÃ² recarrega la pÃ gina amb la nova query
  };

  return (
    <div className="flex items-center justify-between py-4 border-t border-border mt-4">
      <div className="text-sm text-muted-foreground">
        Mostrant pÃ gina <span className="font-medium text-foreground">{metadata.page}</span> de{' '}
        <span className="font-medium text-foreground">{metadata.totalPages}</span> ({metadata.total} total)
      </div>
      
      <div className="flex gap-2">
        <Button
          variant="outline"
          size="sm"
          onClick={() => handlePageChange(metadata.page - 1)}
          disabled={metadata.page <= 1}
        >
          Anterior
        </Button>
        <Button
          variant="outline"
          size="sm"
          onClick={() => handlePageChange(metadata.page + 1)}
          disabled={metadata.page >= metadata.totalPages}
        >
          SegÃ¼ent
        </Button>
      </div>
    </div>
  );
}

// =================== FILE: src/components/ui/progress.tsx ===================

"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }


// =================== FILE: src/components/ui/select.tsx ===================

"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default"
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  align = "center",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        position={position}
        align={align}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}


// =================== FILE: src/components/ui/tabs.tsx ===================

"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  )
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-0.75",
        className
      )}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }


// =================== FILE: src/components/ui/textarea.tsx ===================

import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }


// =================== FILE: src/components/ui/theme-toggle.tsx ===================

"use client"

import * as React from "react"
import { Moon, Sun } from "lucide-react"
import { useTheme } from "next-themes"
import { Button } from "@/components/ui/button"

export function ThemeToggle() {
  const { setTheme, theme } = useTheme()

  return (
    <Button
      variant="ghost"
      size="icon"
      onClick={() => setTheme(theme === "light" ? "dark" : "light")}
      className="relative rounded-full hover:bg-muted transition-colors"
      aria-label="Canviar tema"
    >
      <Sun className="h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0 text-orange-500" />
      <Moon className="absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100 text-blue-400" />
    </Button>
  )
}

// =================== FILE: src/config/site-config.json ===================

{
  "name": "DigitAI Template Default",
  "description": "Plantilla base per a negocis",
  "sector": "general",
  "features": {
    "booking": true,
    "ecommerce": false,
    "blog": true,
    "gallery": true,
    "faq": true
  },
  "theme": {
    "primary": "#000000",
    "layout": "modern"
  },
  "contact": {
    "email": "demo@example.com",
    "phone": "+34 600 000 000",
    "address": "Barcelona",
    "socials": {}
  }
}

// =================== FILE: src/features/analytics/actions.ts ===================

'use server';

import { headers } from 'next/headers';
import { analyticsRepository } from '@/services/container';
import { AnalyticsEventDTO } from '@/types/models';
import { UAParser } from 'ua-parser-js';

type AnalyticsPayload = {
  event_name: string;
  path: string;
  session_id: string;
  referrer?: string;
  duration?: number;
  meta?: Record<string, unknown>;
};

// ğŸ‘‡ 1. DEFINIM EL TIPUS DE RETORN EXPLÃCITAMENT
type TrackEventResponse = {
  success: boolean;
  eventId: number | null; // Pot ser un nÃºmero o null si falla
};

// ğŸ‘‡ 2. APLIQUEM EL TIPUS A LA PROMESA DE LA FUNCIÃ“
export async function trackEventAction(data: AnalyticsPayload): Promise<TrackEventResponse> {
  try {
    const headersList = await headers();
    const userAgent = headersList.get('user-agent') || '';

    // Parseig del User Agent
    const parser = new UAParser(userAgent);
    const result = parser.getResult();

    const isDev = process.env.NODE_ENV === 'development';

    const country = headersList.get('x-vercel-ip-country') || (isDev ? 'ES' : null);
    const city = headersList.get('x-vercel-ip-city') || (isDev ? 'Girona' : null);

    const eventDTO: AnalyticsEventDTO = {
      event_name: data.event_name,
      path: data.path,
      session_id: data.session_id,
      referrer: data.referrer,
      duration: data.duration,
      meta: {
        ...data.meta,
        raw_ua: userAgent,
        screen_resolution: data.meta?.screen_width
      },
      geo: { country, city },
      device: {
        type: result.device.type || 'desktop',
        browser: result.browser.name || 'Unknown',
        os: result.os.name || 'Unknown'
      }
    };

    // Deleguem al repositori
    const eventId = await analyticsRepository.trackEvent(eventDTO);

    // ğŸ‘‡ 3. RETORNEM L'OBJECTE AMB LA FORMA CORRECTA
    return { success: true, eventId };

  } catch (err) {
    console.error("ğŸ’¥ Error en analytics action:", err);
    // ğŸ‘‡ 4. RETORNEM UN FALLBACK SEGUR EN CAS D'ERROR
    return { success: false, eventId: null };
  }
}

// L'acciÃ³ d'actualitzar durada es mantÃ© igual
export async function updateSessionDurationAction(eventId: number, duration: number) {
  try {
    await analyticsRepository.updateDuration(eventId, duration);
    return { success: true };
  } catch (err) {
    console.error("ğŸ’¥ Error en analytics action:", err)
    return { success: false };
  }
}

// =================== FILE: src/features/analytics/ui/AnalyticsTracker.tsx ===================

'use client';

import { useEffect, useRef } from 'react';
import { usePathname, useSearchParams } from 'next/navigation';
import { trackEventAction, updateSessionDurationAction } from '../actions';

export function AnalyticsTracker() {
  const pathname = usePathname();
  const searchParams = useSearchParams();
  
  // âœ… SOLUCIÃ“ 1: Inicialitzem a 0 per evitar l'error "Impure function"
  const startTime = useRef<number>(0); 
  const currentEventId = useRef<number | null>(null);
  const lastPath = useRef<string | null>(null);

  useEffect(() => {
    // 1. GestiÃ³ SessiÃ³
    let sessionId = localStorage.getItem('digitai_session_id');
    if (!sessionId) {
        sessionId = `sess_${Math.random().toString(36).slice(2)}_${Date.now()}`;
        localStorage.setItem('digitai_session_id', sessionId);
    }

    const rawPath = pathname || '/';
    
    // Evitem duplicats en React Strict Mode
    if (lastPath.current === rawPath) return;
    
    // ğŸ›‘ SORTIDA DE PÃ€GINA ANTERIOR
    if (currentEventId.current && startTime.current > 0) {
        const duration = Math.round((Date.now() - startTime.current) / 1000);
        updateSessionDurationAction(currentEventId.current, duration);
    }

    // ğŸš€ ENTRADA A NOVA PÃ€GINA
    lastPath.current = rawPath;
    startTime.current = Date.now(); // âœ… AquÃ­ Ã©s segur cridar Date.now() (dins useEffect)
    
    const track = async () => {
      const response = await trackEventAction({
        event_name: 'page_view',
        path: rawPath,
        session_id: sessionId as string,
        referrer: document.referrer,
        meta: {
           screen_width: window.innerWidth,
           language: navigator.language
        }
      });

      // âœ… SOLUCIÃ“ 2: TypeScript ja no es queixarÃ  perquÃ¨ hem tipat l'acciÃ³ al pas segÃ¼ent
      if (response.success && response.eventId) {
        currentEventId.current = response.eventId;
      }
    };

    track();

    // ğŸ§¹ NETEJA FINAL (Tancar pestanya)
    return () => {
      if (currentEventId.current && startTime.current > 0) {
        const duration = Math.round((Date.now() - startTime.current) / 1000);
        updateSessionDurationAction(currentEventId.current, duration);
      }
    };

  }, [pathname, searchParams]);

  return null;
}

// =================== FILE: src/features/analytics/ui/BarListChart.tsx ===================

'use client';

import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  title: string;
  data: { name: string; value: number; color?: string }[];
};

export function BarListChart({ title, data }: Props) {
  // ğŸ” CONSOLE LOG PER DEPURAR
  console.log(`[BarListChart] Dades rebudes per "${title}":`, data);

  // ProtecciÃ³ contra dades buides o nulÂ·les
  const safeData = Array.isArray(data) ? data : [];

  return (
    <Card className="bg-card border-border text-card-foreground flex flex-col shadow-sm h-full">      
      <CardHeader className="py-3 px-4 shrink-0 border-b border-border/30">
        <CardTitle className="text-xs font-bold text-muted-foreground uppercase tracking-wider">
          {title}
        </CardTitle>
      </CardHeader>
      
      <CardContent className="flex-1 p-4 min-h-62.5"> 
        <div className="w-full h-full min-h-50">
            {safeData.length === 0 ? (
                <div className="flex h-full items-center justify-center text-xs text-muted-foreground border-2 border-dashed border-muted/50 rounded-lg">
                    {/* Missatge visible si no hi ha dades */}
                    Sense dades per {title}
                </div>
            ) : (
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart 
                    layout="vertical" 
                    data={safeData} 
                    margin={{ left: 0, right: 10, bottom: 0, top: 0 }} 
                    barCategoryGap={12}
                  >
                    <XAxis type="number" hide />
                    <YAxis
                      dataKey="name"
                      type="category"
                      width={80}
                      tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 10, fontWeight: 500 }}
                      tickLine={false}
                      axisLine={false}
                      tickFormatter={(val) => val.length > 10 ? `${val.substring(0, 10)}..` : val}
                    />
                    <Tooltip 
                        cursor={{ fill: 'hsl(var(--muted))', opacity: 0.1 }} 
                        contentStyle={{ 
                            backgroundColor: 'hsl(var(--popover))', 
                            borderColor: 'hsl(var(--border))', 
                            fontSize: '12px', 
                            color: 'hsl(var(--popover-foreground))', 
                            borderRadius: '6px',
                            boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'
                        }} 
                        itemStyle={{ padding: 0 }}
                    />
                    <Bar dataKey="value" radius={[0, 4, 4, 0]} barSize={16} animationDuration={800}>
                      {safeData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color || '#6366f1'} />
                      ))}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
            )}
        </div>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/analytics/ui/DeviceChart.tsx ===================

'use client';

import { PieChart, Pie, Cell, Tooltip, ResponsiveContainer, Legend } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  data: { name: string; value: number; fill: string }[];
};

export function DeviceChart({ data }: Props) {
  if (!data || data.length === 0) {
      return (
        <Card className="bg-card border-border h-full flex items-center justify-center text-muted-foreground text-xs p-4">
            Sense dades
        </Card>
      )
  }

  return (
    <Card className="bg-card border-border text-card-foreground h-full flex flex-col shadow-sm">
      <CardHeader className="py-2 px-3 shrink-0 border-b border-border/30">
        <CardTitle className="text-xs font-bold text-muted-foreground uppercase tracking-wider">Dispositius</CardTitle>
      </CardHeader>
      <CardContent className="flex-1 min-h-0 p-0 relative">
        <ResponsiveContainer width="100%" height="100%">
            {/* âœ… CORRECCIÃ“: Afegim 'left' i 'right' a 0 */}
            <PieChart margin={{ top: 0, bottom: 0, left: 0, right: 0 }}>
              <Pie
                data={data}
                cx="50%"
                cy="50%"
                innerRadius="40%" 
                outerRadius="65%"
                paddingAngle={3}
                dataKey="value"
                stroke="hsl(var(--card))"
                strokeWidth={2}
              >
                {data.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.fill} />
                ))}
              </Pie>
              <Tooltip 
                 contentStyle={{ backgroundColor: 'hsl(var(--popover))', borderColor: 'hsl(var(--border))', borderRadius: '6px', color: 'hsl(var(--popover-foreground))', fontSize: '11px' }}
                 itemStyle={{ color: 'hsl(var(--popover-foreground))' }}
              />
              <Legend 
                verticalAlign="bottom" 
                height={28} 
                iconType="circle" 
                iconSize={6}
                wrapperStyle={{ fontSize: '10px', paddingTop: '0px' }}
              />
            </PieChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/analytics/ui/TopPagesCard.tsx ===================

'use client';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  data: { path: string; views: number }[];
};

export function TopPagesCard({ data }: Props) {
  // Ordenar i limitar
  const sortedData = [...data].sort((a, b) => b.views - a.views);
  const maxViews = sortedData[0]?.views || 0;

  return (
    <Card className="bg-card border-border text-card-foreground h-full flex flex-col shadow-sm overflow-hidden">
      <CardHeader className="py-3 px-4 shrink-0 border-b border-border/40 bg-muted/10">
        <div className="flex justify-between items-center">
             <CardTitle className="text-sm font-bold">PÃ gines MÃ©s Visitades</CardTitle>
             <span className="text-[10px] text-muted-foreground uppercase tracking-wider font-bold">Vistes</span>
        </div>
      </CardHeader>
      
      {/* Scrollable Area */}
      <CardContent className="flex-1 overflow-y-auto p-0 min-h-0 custom-scrollbar">
        <div className="flex flex-col">
           {sortedData.length === 0 ? (
                <div className="p-4 text-center text-xs text-muted-foreground">Sense dades</div>
           ) : (
               sortedData.map((page, index) => {
                    const percentage = maxViews > 0 ? (page.views / maxViews) * 100 : 0;
                    return (
                      <div key={index} className="group px-4 py-2.5 border-b border-border/20 last:border-0 hover:bg-muted/30 transition-colors relative">
                        {/* Contingut Text */}
                        <div className="flex justify-between text-xs mb-1.5 relative z-10 font-medium">
                          <span className="truncate pr-4 w-[85%]" title={page.path}>
                            {page.path}
                          </span>
                          <span className="text-foreground font-mono tabular-nums w-[15%] text-right">
                            {page.views}
                          </span>
                        </div>
                        
                        {/* Barra de ProgrÃ©s (Background) */}
                        <div className="h-1.5 w-full bg-muted rounded-full overflow-hidden">
                          <div 
                             className="h-full bg-primary/70 group-hover:bg-primary transition-all duration-500 rounded-full"
                             style={{ width: `${percentage}%` }}
                          />
                        </div>
                      </div>
                    );
               })
           )}
        </div>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/analytics/ui/TrafficChart.tsx ===================

'use client';

import { AreaChart, Area, XAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';


type Props = {
  data: { date: string; visitors: number; views: number }[];
};

export function TrafficChart({ data }: Props) {
  return (
    // NOTA: Eliminem el <Card> pare si ja l'hem posat al layout, 
    // perÃ² si el deixem, li traiem la vora per no duplicar.
    <div className="h-full w-full flex flex-col">      
      <div className="py-3 px-4 shrink-0 border-b border-border/40">
        <h3 className="text-sm font-bold text-foreground">TrÃ nsit (Ãšltims 7 dies)</h3>
      </div>
      <div className="flex-1 min-h-0 w-full">
        <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={data} margin={{ top: 10, right: 0, left: 0, bottom: 0 }}>
              <defs>
                <linearGradient id="colorViews" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#8884d8" stopOpacity={0.3} />
                  <stop offset="95%" stopColor="#8884d8" stopOpacity={0} />
                </linearGradient>
                <linearGradient id="colorVisitors" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#82ca9d" stopOpacity={0.3} />
                  <stop offset="95%" stopColor="#82ca9d" stopOpacity={0} />
                </linearGradient>
              </defs>
              
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="hsl(var(--border))" opacity={0.4} />
              
              <XAxis 
                dataKey="date" 
                axisLine={false} 
                tickLine={false} 
                tick={{ fontSize: 10, fill: 'hsl(var(--muted-foreground))' }} 
                dy={10}
                interval="preserveStartEnd"
              />
              
              <Tooltip
                contentStyle={{ 
                    backgroundColor: 'hsl(var(--card))', 
                    borderColor: 'hsl(var(--border))', 
                    color: 'hsl(var(--foreground))',
                    borderRadius: '8px',
                    fontSize: '12px',
                    boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'
                }}
              />
              
              <Area type="monotone" dataKey="views" stroke="#8884d8" strokeWidth={2} fillOpacity={1} fill="url(#colorViews)" name="Vistes" />
              <Area type="monotone" dataKey="visitors" stroke="#82ca9d" strokeWidth={2} fillOpacity={1} fill="url(#colorVisitors)" name="Usuaris" />
            </AreaChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
}

// =================== FILE: src/features/analytics/ui/UnifiedStatBar.tsx ===================

import { Card } from '@/components/ui/card';
import { Users, Eye, MousePointerClick, Clock, TrendingUp } from 'lucide-react';

interface UnifiedStatBarProps {
  views: number;
  visitors: number;
  events: number;
  avgTime: string;
}

interface StatItemProps {
  label: string;
  value: number | string;
  icon: React.ReactNode;
}

export function UnifiedStatBar({ views, visitors, events, avgTime }: UnifiedStatBarProps) {
  return (
    // CANVI: bg-card i border-border (s'adapten automÃ ticament)
    <Card className="bg-card border-border text-card-foreground p-4 shadow-sm">
        <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
        
            {/* TÃ­tol */}
            <div className="flex items-center gap-3 lg:pr-8 lg:border-r border-border pb-4 lg:pb-0 border-b lg:border-b-0">
                <div className="p-2 bg-primary/10 rounded-lg">
                    <TrendingUp className="text-primary h-6 w-6" />
                </div>
                <div>
                    <h1 className="text-lg font-bold leading-tight">Dashboard</h1>
                    <p className="text-xs text-muted-foreground">Temps real</p>
                </div>
            </div>

            {/* MÃ¨triques */}
            <div className="flex-1 grid grid-cols-2 gap-y-6 lg:flex lg:justify-around lg:items-center">
                <StatItem label="Vistes (7d)" value={views} icon={<Eye className="h-4 w-4 text-blue-500" />} />
                
                <div className="hidden lg:block h-8 w-px bg-border" />
                
                <StatItem label="Usuaris" value={visitors} icon={<Users className="h-4 w-4 text-green-500" />} />
                
                <div className="hidden lg:block h-8 w-px bg-border" />
                
                <StatItem label="Events" value={events} icon={<MousePointerClick className="h-4 w-4 text-purple-500" />} />
                
                <div className="hidden lg:block h-8 w-px bg-border" />
                
                <StatItem label="Temps MitjÃ " value={avgTime} icon={<Clock className="h-4 w-4 text-orange-500" />} />
            </div>
        </div>
    </Card>
  );
}

function StatItem({ label, value, icon }: StatItemProps) {
    return (
        <div className="flex flex-col items-center gap-1 min-w-[100px]">
            <span className="text-[10px] uppercase tracking-wider text-muted-foreground font-bold flex items-center gap-2">
                {icon} {label}
            </span>
            <span className="text-2xl font-bold leading-none">
                 {value}
            </span>
        </div>
    )
}

// =================== FILE: src/features/analytics/ui/VerticalBarChart.tsx ===================

'use client';

import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, CartesianGrid } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  title: string;
  data: { name: string; value: number; color?: string }[];
};

export function VerticalBarChart({ title, data }: Props) {
  return (
    // 1. Treiem 'col-span-2' perquÃ¨ s'adapti a la columna del sidebar
    <Card className="bg-card border-border text-card-foreground h-full flex flex-col min-h-0 shadow-sm">
      <CardHeader className="py-2 px-3 shrink-0 border-b border-border/30">
        <CardTitle className="text-xs font-bold text-muted-foreground uppercase tracking-wider">{title}</CardTitle>
      </CardHeader>
      <CardContent className="flex-1 min-h-0 p-0 relative">
        <div className="absolute inset-0 pt-2 pb-1 pr-2 pl-0">
            <ResponsiveContainer width="100%" height="100%">
            <BarChart 
                data={data} 
                // 2. Ajustem marges: 'left: -20' era el problema. Posem 0 i deixem que YAxis gestioni l'ample.
                margin={{ top: 10, right: 0, left: 0, bottom: 0 }}
            >
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="hsl(var(--border))" opacity={0.4} />
                
                <XAxis 
                    dataKey="name" 
                    stroke="hsl(var(--muted-foreground))"
                    fontSize={10} 
                    tickLine={false}
                    axisLine={false}
                    interval={0}
                    // Trunquem a 3 lletres (codi paÃ­s) o pocs carÃ cters per evitar solapament
                    tickFormatter={(value) => value.substring(0, 3).toUpperCase()}
                    dy={5}
                />
                
                <YAxis 
                    stroke="hsl(var(--muted-foreground))"
                    fontSize={10} 
                    tickLine={false} 
                    axisLine={false} 
                    width={30} // Espai fix petit per als nÃºmeros de l'esquerra
                />
                
                <Tooltip 
                    cursor={{ fill: 'hsl(var(--muted))', opacity: 0.2 }}
                    contentStyle={{ 
                        backgroundColor: 'hsl(var(--popover))', 
                        borderColor: 'hsl(var(--border))', 
                        color: 'hsl(var(--popover-foreground))', 
                        borderRadius: '6px', 
                        fontSize: '11px',
                        padding: '8px'
                    }}
                    itemStyle={{ color: 'hsl(var(--popover-foreground))' }}
                />
                
                <Bar dataKey="value" radius={[4, 4, 0, 0]} animationDuration={1000}>
                    {data.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color || '#10b981'} />
                    ))}
                </Bar>
            </BarChart>
            </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/audit/ui/AuditForm.tsx ===================

'use client';

import { useActionState } from 'react'; // Next.js 15+ (si uses 14, canvia a useFormState)
import { processWebAudit } from '@/actions/audit'; 
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Search, Loader2, AlertCircle } from 'lucide-react';
import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils';

export function AuditForm() {
  const [state, action, isPending] = useActionState(processWebAudit, { message: '', errors: {} });
  const t = useTranslations('AuditForm');

  return (
    <div className="w-full">
      <div className="border border-border rounded-2xl p-8 bg-white/50 dark:bg-white/2 backdrop-blur-xl shadow-xl dark:shadow-2xl transition-all duration-300">
        
        <h3 className="text-xl font-bold text-center text-foreground mb-6 flex items-center justify-center gap-2">
          <Search className="w-5 h-5 text-primary" />
          {t('title')}
        </h3>
        
        <form action={action} className="space-y-4">
          
          <div className="space-y-1">
            <div className="relative flex items-center group">
              
              {/* PREFIX VISUAL (No s'envia, nomÃ©s decora) */}
              <div className="absolute left-3 flex items-center pointer-events-none select-none z-10">
                <span className="text-muted-foreground text-sm font-medium bg-slate-100 dark:bg-white/10 px-2 py-1 rounded border border-border/50">
                  https://
                </span>
              </div>

              {/* INPUT REAL */}
              <Input 
                name="url" 
                placeholder="digitaistudios.com" 
                className={cn(
                  "pl-20 bg-white dark:bg-white/5 border-slate-200 dark:border-white/10 text-foreground h-12 transition-all",
                  "focus:border-primary/50 placeholder:text-muted-foreground",
                  state.errors?.url && "border-red-500 focus:border-red-500"
                )}
              />
            </div>

            {state.errors?.url && (
              <p className="text-red-500 text-xs flex items-center gap-1 mt-1 ml-1 animate-in slide-in-from-top-1">
                <AlertCircle className="w-3 h-3" /> {state.errors.url[0]}
              </p>
            )}
          </div>

          <div className="space-y-1">
            <Input 
              name="email" 
              placeholder={t('placeholder_email')} 
              className={cn(
                "bg-white dark:bg-white/5 border-slate-200 dark:border-white/10 text-foreground h-12 transition-all",
                "focus:border-primary/50 placeholder:text-muted-foreground",
                state.errors?.email && "border-red-500 focus:border-red-500"
              )}
            />
            {state.errors?.email && (
              <p className="text-red-500 text-xs flex items-center gap-1 mt-1 ml-1 animate-in slide-in-from-top-1">
                <AlertCircle className="w-3 h-3" /> {state.errors.email[0]}
              </p>
            )}
          </div>

          <Button 
            type="submit" 
            disabled={isPending} 
            className="w-full h-12 mt-2 text-base font-semibold rounded-lg gradient-bg text-white border-0 hover:opacity-90 shadow-lg shadow-primary/20 transition-all"
          >
            {isPending ? (
              <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> {t('cta_loading')}</>
            ) : (
              t('cta_button')
            )}
          </Button>
          
          {state.message && (
            <p className={cn(
              "text-center text-sm mt-4 p-2 rounded-lg border border-border/50",
              state.errors && Object.keys(state.errors).length > 0 ? "bg-red-500/10 text-red-500" : "bg-green-500/10 text-green-500"
            )}>
              {state.message}
            </p>
          )}
        </form>
      </div>
      
      <p className="text-center text-xs text-muted-foreground mt-4 opacity-60">
        {t('privacy_note')}
      </p>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/AuditHeader.tsx ===================

import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Share2 } from 'lucide-react';
// ğŸ‘‡ Importem el botÃ³ real
import { DownloadAuditButton } from './DownloadAuditButton';
// ğŸ‘‡ 1. Importem el tipus correcte per als issues
import { AuditIssue } from '@/adapters/IWebScanner';

type Props = { 
  url: string; 
  date: Date;
  pdfData: {
    url: string;
    date: string;
    scores: { seo: number; perf: number; a11y: number; best: number };
    screenshot?: string;
    // ğŸ‘‡ 2. Corregim 'any[]' per 'AuditIssue[]'
    issues: AuditIssue[];
    
  }
};

export function AuditHeader({ url, date, pdfData }: Props) {
  return (
    <div className="flex flex-col md:flex-row md:items-center justify-between gap-6 border-b border-white/5 pb-6">
      <div>
        <Link href="/dashboard" className="text-xs font-medium text-slate-400 hover:text-primary flex items-center gap-1 mb-3 transition-colors uppercase tracking-wider">
          <ArrowLeft className="w-3 h-3" /> Tornar al Dashboard
        </Link>
        <h1 className="text-3xl md:text-4xl font-bold text-white tracking-tight truncate max-w-2xl">
          Informe: <span className="text-transparent bg-clip-text bg-linear-to-r from-blue-400 to-primary">{url}</span>
        </h1>
        <p className="text-sm text-slate-500 mt-2 font-mono">
          ID: {date.getTime().toString(36).toUpperCase()} â€¢ Generat el {date.toLocaleDateString()}
        </p>
      </div>
      
      <div className="flex gap-3">
        <Button variant="outline" className="border-slate-700 text-slate-300 hover:bg-slate-800 hover:text-white">
            <Share2 className="w-4 h-4 mr-2" /> Compartir
        </Button>
        
        {/* BotÃ³ de descarrega */}
        <DownloadAuditButton data={pdfData} />
      </div>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/BusinessOpportunities.tsx ===================

import { BusinessSuggestion } from "@/types/ai";
import { Lightbulb, Calendar, ShoppingCart, Users, BarChart3, Settings, Rocket } from "lucide-react";

interface Props {
  suggestions: BusinessSuggestion[];
}

export function BusinessOpportunities({ suggestions }: Props) {
  if (!suggestions || suggestions.length === 0) return null;

  // Helper per mapejar icones (string -> component)
  const getIcon = (iconName: string) => {
    switch (iconName) {
      case 'calendar': return <Calendar className="w-5 h-5 text-blue-600" />;
      case 'shop': return <ShoppingCart className="w-5 h-5 text-green-600" />;
      case 'user': return <Users className="w-5 h-5 text-purple-600" />;
      case 'chart': return <BarChart3 className="w-5 h-5 text-amber-600" />;
      case 'settings': return <Settings className="w-5 h-5 text-slate-600" />;
      default: return <Lightbulb className="w-5 h-5 text-yellow-500" />;
    }
  };

  return (
    <div className="bg-gradient-to-br from-indigo-50 to-white dark:from-indigo-950/20 dark:to-background border border-indigo-100 dark:border-indigo-900/50 rounded-xl p-6 shadow-sm">
      <div className="flex items-center gap-2 mb-6">
        <div className="p-2 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg">
          <Rocket className="w-5 h-5 text-indigo-600 dark:text-indigo-400" />
        </div>
        <div>
          <h3 className="text-lg font-bold text-foreground">Oportunitats de Creixement</h3>
          <p className="text-sm text-muted-foreground">Detectades per IA segons el teu sector</p>
        </div>
      </div>

      <div className="grid gap-4 md:grid-cols-3">
        {suggestions.map((item, idx) => (
          <div key={idx} className="bg-white dark:bg-slate-900 p-4 rounded-lg border border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-md transition-shadow">
            <div className="flex items-start justify-between mb-3">
              <div className="p-2 bg-slate-50 dark:bg-slate-800 rounded-md">
                {getIcon(item.icon)}
              </div>
              {item.impact === 'high' && (
                <span className="text-[10px] font-bold uppercase tracking-wider text-emerald-600 bg-emerald-50 dark:bg-emerald-950/30 px-2 py-1 rounded-full">
                  Alt Impacte
                </span>
              )}
            </div>
            <h4 className="font-semibold text-foreground mb-1">{item.title}</h4>
            <p className="text-sm text-muted-foreground leading-relaxed">{item.description}</p>
          </div>
        ))}
      </div>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/CoreVitalsGrid.tsx ===================

import { Zap, LayoutTemplate, MoveHorizontal, Clock, Gauge } from 'lucide-react';

// Tipus locals per la UI (no cal importar el Zod schema aquÃ­, per mantenir desacoblament)
export type AuditMetric = {
  score?: number | null;
  value?: string;
  description?: string;
};

type LighthouseAuditUI = {
  id: string;
  title?: string;
  description?: string;
  score?: number | null;
  displayValue?: string;
};

type CoreVitalsGridProps = {
  metrics?: {
    fcp?: AuditMetric;
    lcp?: AuditMetric;
    cls?: AuditMetric;
    tbt?: AuditMetric;
    si?: AuditMetric;
  };
  googleAudits?: Record<string, LighthouseAuditUI>;
};

export function CoreVitalsGrid({ metrics, googleAudits }: CoreVitalsGridProps) {
  
  const getMetric = (key: string, googleKey: string): AuditMetric => {
    // 1. Prioritat: Dades netes processades
    if (metrics && metrics[key as keyof typeof metrics]) {
      return metrics[key as keyof typeof metrics]!;
    }
    
    // 2. Fallback: Dades crues
    if (googleAudits && googleAudits[googleKey]) {
      const audit = googleAudits[googleKey];
      return {
        score: audit.score,
        value: audit.displayValue,
        description: audit.title
      };
    }

    return { score: null, value: 'N/A', description: 'No disponible' };
  };

  const fcp = getMetric('fcp', 'first-contentful-paint');
  const lcp = getMetric('lcp', 'largest-contentful-paint');
  const cls = getMetric('cls', 'cumulative-layout-shift');
  const tbt = getMetric('tbt', 'total-blocking-time');
  const si = getMetric('si', 'speed-index');

  // Si no hi ha dades, no pintem res
  if (fcp.value === 'N/A' && lcp.value === 'N/A') return null;

  return (
    <div className="mb-8">
      <h2 className="text-xl font-bold text-foreground mb-4 flex items-center gap-2">
        <span className="w-1.5 h-6 bg-primary rounded-full"></span>
        MÃ¨triques de Rendiment (Core Web Vitals)
      </h2>
      
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
        <MetricCard title="FCP" subtitle="First Contentful Paint" value={fcp.value || "N/A"} score={fcp.score} icon={Zap} tooltip="Temps fins primer contingut." />
        <MetricCard title="LCP" subtitle="Largest Contentful Paint" value={lcp.value || "N/A"} score={lcp.score} icon={LayoutTemplate} tooltip="Temps element mÃ©s gran." />
        <MetricCard title="CLS" subtitle="Cumulative Layout Shift" value={cls.value || "N/A"} score={cls.score} icon={MoveHorizontal} tooltip="Estabilitat visual." />
        <MetricCard title="TBT" subtitle="Total Blocking Time" value={tbt.value || "N/A"} score={tbt.score} icon={Clock} tooltip="Temps de bloqueig." />
        <MetricCard title="SI" subtitle="Speed Index" value={si.value || "N/A"} score={si.score} icon={Gauge} tooltip="Ãndex de velocitat." />
      </div>
    </div>
  );
}

// ... (El component MetricCard es queda igual que al teu codi original)
type MetricCardProps = {
    title: string;
    subtitle: string;
    value: string;
    score?: number | null;
    icon: React.ElementType;
    tooltip?: string;
};
  
function MetricCard({ title, subtitle, value, score, icon: Icon, tooltip }: MetricCardProps) {
    let colorClass = 'text-slate-500 dark:text-slate-400';
    let bgClass = 'bg-slate-100 border-slate-200 dark:bg-slate-800/50 dark:border-slate-700';
    let iconColor = 'text-slate-400';

    if (typeof score === 'number') {
        if (score >= 0.9) {
            colorClass = 'text-green-600 dark:text-green-400';
            bgClass = 'bg-green-50 border-green-200 dark:bg-green-500/10 dark:border-green-500/20';
            iconColor = 'text-green-500';
        } else if (score >= 0.5) {
            colorClass = 'text-yellow-600 dark:text-yellow-400';
            bgClass = 'bg-yellow-50 border-yellow-200 dark:bg-yellow-500/10 dark:border-yellow-500/20';
            iconColor = 'text-yellow-500';
        } else {
            colorClass = 'text-red-600 dark:text-red-400';
            bgClass = 'bg-red-50 border-red-200 dark:bg-red-500/10 dark:border-red-500/20';
            iconColor = 'text-red-500';
        }
    }

    return (
        <div className={`p-4 rounded-xl border ${bgClass} flex flex-col items-center text-center transition-all hover:scale-[1.02] h-full justify-between`} title={tooltip}>
            <div className="flex flex-col items-center">
                <div className={`mb-3 p-2.5 rounded-full bg-background/50 ${iconColor}`}>
                    <Icon className="w-5 h-5" />
                </div>
                <span className="text-sm font-bold text-foreground mb-1">{title}</span>
                <span className="text-[10px] text-muted-foreground uppercase tracking-wide mb-2 px-2 line-clamp-1">{subtitle}</span>
            </div>
            <span className={`text-2xl font-extrabold ${colorClass}`}>{value}</span>
        </div>
    )
}

// =================== FILE: src/features/audit/ui/components/CreateAuditForm.tsx ===================

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Loader2, Search } from 'lucide-react'; // Treiem 'Globe' perquÃ¨ posarem text
import { createAuditAction } from '@/actions/audit'; 

export function CreateAuditForm() {
  const [url, setUrl] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError('');

    try {
        const result = await createAuditAction(url);
        
        if (result && !result.success) {
            setError(result.message || 'Error desconegut durant l\'auditoria.');
            setIsLoading(false);
        }
    } catch (err) {
        console.error("Error al formulari:", err);
        setError("Error de connexiÃ³. Torna-ho a provar.");
        setIsLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="space-y-2">
         <label className="text-sm font-medium text-slate-700 dark:text-slate-300 ml-1">
            URL del Lloc Web
         </label>
         
         <div className="relative flex items-center">
            {/* 1. PREFIX VISUAL (Igual que a la Landing) */}
            <div className="absolute left-3 pointer-events-none select-none z-10 flex items-center">
               <span className="text-sm font-medium text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-white/10 px-2 py-0.5 rounded border border-slate-200 dark:border-white/10">
                 https://
               </span>
            </div>
            
            {/* 2. INPUT ADAPTAT */}
            <Input 
               type="text" // Canviem a 'text' perquÃ¨ 'url' obligaria a escriure http://
               placeholder="exemple.com" // Placeholder sense protocol
               value={url}
               onChange={(e) => setUrl(e.target.value)}
               required
               disabled={isLoading} 
               // Padding esquerre gran (pl-24) per deixar lloc al prefix "https://"
               className="pl-24 h-12 transition-colors
                          bg-white dark:bg-white/5 
                          border-slate-200 dark:border-white/10 
                          text-slate-900 dark:text-white 
                          placeholder:text-slate-400 dark:placeholder:text-slate-600
                          focus:border-primary focus:ring-primary"
            />
         </div>
      </div>

      {error && (
         <div className="p-3 bg-red-50 border border-red-200 dark:bg-red-500/10 dark:border-red-500/20 rounded-lg text-red-600 dark:text-red-400 text-sm animate-in fade-in slide-in-from-top-1">
            {error}
         </div>
      )}

      <Button 
         type="submit" 
         disabled={isLoading || !url} 
         className="w-full h-12 gradient-bg text-white font-bold rounded-xl hover:opacity-90 transition-all shadow-lg shadow-primary/20"
      >
         {isLoading ? (
            <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Analitzant Web...</>
         ) : (
            <><Search className="w-4 h-4 mr-2" /> ComenÃ§ar AnÃ lisi</>
         )}
      </Button>
      
      <p className="text-xs text-center text-slate-500">
         L'anÃ lisi pot trigar entre 10 i 30 segons depenent de la velocitat de Google.
      </p>
    </form>
  );
}

// =================== FILE: src/features/audit/ui/components/DownloadAuditButton.tsx ===================

'use client';

import React from 'react';
import dynamic from 'next/dynamic';
import { Button } from '@/components/ui/button';
import { Download, Loader2 } from 'lucide-react';
// Assegura't que el nom del fitxer coincideix exactament (MajÃºscules/minÃºscules)
import { AuditPDFDocument } from '@/features/audit/ui/pdf/AuditPdfDocument'; 
import { AuditIssue } from '@/adapters/IWebScanner';

const PDFDownloadLink = dynamic(
  () => import('@react-pdf/renderer').then((mod) => mod.PDFDownloadLink),
  { 
    ssr: false,
    loading: () => (
      <Button variant="outline" disabled className="bg-background text-muted-foreground border-border">
         <Loader2 className="w-4 h-4 mr-2 animate-spin" /> Preparant PDF...
      </Button>
    )
  }
);

type Props = {
  data: {
    url: string;
    date: string;
    scores: { seo: number; perf: number; a11y: number; best: number };
    screenshot?: string;
    issues: AuditIssue[]; 
  }
};

export function DownloadAuditButton({ data }: Props) {
  return (
    <PDFDownloadLink
      document={
        <AuditPDFDocument 
            url={data.url}
            date={data.date}
            scores={data.scores}
            screenshot={data.screenshot}
            issues={data.issues}
        />
      }
      fileName={`audit-${data.url.replace(/[^a-z0-9]/gi, '_')}.pdf`}
    >
      {({ loading }) => (
        <Button 
            // Canviem l'estil perquÃ¨ sigui consistent amb el tema
            className="bg-primary text-primary-foreground hover:bg-primary/90 shadow-sm"
            disabled={loading}
        >
          {loading ? (
            <>
               <Loader2 className="w-4 h-4 mr-2 animate-spin" /> Generant...
            </>
          ) : (
            <>
               <Download className="w-4 h-4 mr-2" /> Descarregar PDF
            </>
          )}
        </Button>
      )}
    </PDFDownloadLink>
  );
}

// =================== FILE: src/features/audit/ui/components/IssuesList.tsx ===================

'use client'; // Important: useTranslations funciona en Client Components o Server Components, perÃ² aquÃ­ ja Ã©s client.

import { Card, CardContent } from '@/components/ui/card';
import { AlertTriangle, CheckCircle } from 'lucide-react';
import { AuditIssue } from '@/adapters/IWebScanner';
import { useTranslations } from 'next-intl';

type Props = { issues: AuditIssue[] };

export function IssuesList({ issues }: Props) {
  const t = useTranslations('AuditIssues'); // namespace 'AuditIssues'

  return (
    <div className="mt-12">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-foreground flex items-center gap-2">
           <AlertTriangle className="text-yellow-500" />
           {/* Pots traduir tambÃ© aquest tÃ­tol si vols */}
           Accions Recomanades
        </h2>
        <span className="bg-red-500/10 text-red-600 dark:text-red-400 text-xs font-bold px-3 py-1 rounded-full border border-red-500/20">
           {issues?.length || 0} Errors CrÃ­tics
        </span>
      </div>
      
      <div className="grid gap-4">
        {issues?.map((issue, index) => {
           // LÃ’GICA DE TRADUCCIÃ“ INTELÂ·LIGENT
           // 1. Mirem si tenim traducciÃ³ per aquest ID especÃ­fic (ex: 'server-response-time.title')
           // 2. Si no, fem servir el text original que ve de Google (fallback)
           
           const hasTranslation = t.has(`${issue.id}.title`);
           const title = hasTranslation ? t(`${issue.id}.title`) : issue.title;
           const description = hasTranslation ? t(`${issue.id}.description`) : issue.description;

           return (
             <Card key={index} className="bg-card border border-border hover:border-primary/50 transition-colors group shadow-sm">
                <CardContent className="p-5 flex gap-4">
                   <div className="shrink-0 mt-1">
                      <div className="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
                   </div>
                   <div className="flex-1">
                      <h3 className="font-bold text-foreground group-hover:text-primary transition-colors text-lg mb-1">
                          {title}
                      </h3>
                      <p className="text-sm text-muted-foreground leading-relaxed mb-3">
                          {description}
                      </p>
                      {issue.displayValue && (
                          <div className="inline-flex items-center gap-2 px-3 py-1 rounded bg-red-500/5 border border-red-500/10 text-xs font-mono text-red-600 dark:text-red-400">
                              <span>Dada:</span>
                              <span className="font-bold">{issue.displayValue}</span>
                          </div>
                      )}
                   </div>
                </CardContent>
             </Card>
           );
        })}
        
        {(!issues || issues.length === 0) && (
            <div className="text-center py-12 bg-muted/30 rounded-xl border border-dashed border-border">
                <CheckCircle className="w-12 h-12 text-green-500 mx-auto mb-4 opacity-50" />
                <p className="text-muted-foreground">IncreÃ¯ble! No hem trobat errors crÃ­tics.</p>
            </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/MobilePreviw.tsx ===================

import Image from 'next/image';

export function MobilePreview({ screenshot }: { screenshot: string }) {
  if (!screenshot) return null;
  
  return (
    <div className="mt-8 flex flex-col items-center">
      <h2 className="text-xl font-bold text-white mb-6">Vista PrÃ¨via MÃ²bil</h2>
      {/* Mockup Minimalista Fosc */}
      <div className="relative border-slate-800 bg-slate-900 border-[10px] rounded-[2.5rem] h-[600px] w-[300px] shadow-2xl shadow-black">
         <div className="h-[32px] w-[3px] bg-slate-800 absolute -start-[13px] top-[72px] rounded-s-lg"></div>
         <div className="h-[46px] w-[3px] bg-slate-800 absolute -start-[13px] top-[124px] rounded-s-lg"></div>
         <div className="h-[46px] w-[3px] bg-slate-800 absolute -start-[13px] top-[178px] rounded-s-lg"></div>
         <div className="h-[64px] w-[3px] bg-slate-800 absolute -end-[13px] top-[142px] rounded-e-lg"></div>
         <div className="rounded-[2rem] overflow-hidden w-[280px] h-[580px] bg-black">
            <Image
                src={screenshot}
                alt="Mobile Screenshot"
                width={280}
                height={580}
                className="w-full h-full object-cover opacity-90 hover:opacity-100 transition-opacity"
                unoptimized
            />
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/ScoreGrid.tsx ===================

import { Card, CardContent } from '@/components/ui/card';
import { ScoreRing } from '@/components/charts/ScoreRing';

type Props = { seo: number; perf: number };

export function ScoreGrid({ seo, perf }: Props) {
  return (
    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
      <ScoreCard score={seo} label="SEO" />
      <ScoreCard score={perf} label="Rendiment" />
      <ScoreCard score={85} label="Accessibilitat" />
      <ScoreCard score={92} label="Best Practices" />
    </div>
  );
}

function ScoreCard({ score, label }: { score: number; label: string }) {
  return (
    // Canviem bg-[#0f111a]/50 per bg-background/40 o bg-card
    <Card className="bg-background/40 border border-border hover:border-primary/20 transition-colors backdrop-blur-md shadow-sm">
      <CardContent className="pt-6 pb-6 flex justify-center">
        <ScoreRing score={score} label={label} />
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/audit/ui/pdf/AuditPdfDocument.tsx ===================

import React from 'react';
import { Page, Text, View, Document, StyleSheet, Image } from '@react-pdf/renderer';

// Definim els tipus de dades que necessitem
type Issue = {
  title: string;
  description: string;
};

type Props = {
  url: string;
  date: string;
  scores: { seo: number; perf: number; a11y: number; best: number };
  screenshot?: string;
  issues: Issue[];
};

// ESTILS DEL PDF (Semblant a CSS perÃ² en objecte JS)
const styles = StyleSheet.create({
  page: {
    flexDirection: 'column',
    backgroundColor: '#0f111a', // Fons fosc
    color: '#ffffff',
    padding: 30,
    fontFamily: 'Helvetica',
  },
  header: {
    marginBottom: 20,
    borderBottomWidth: 1,
    borderBottomColor: '#334155',
    paddingBottom: 10,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  title: { fontSize: 24, fontWeight: 'bold', color: '#ffffff' },
  subtitle: { fontSize: 10, color: '#94a3b8', marginTop: 4 },
  brand: { fontSize: 10, color: '#7c3aed', textTransform: 'uppercase' }, // Lila de marca
  
  // Grid de Puntuacions
  scoresContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 30,
    backgroundColor: '#1e293b',
    padding: 15,
    borderRadius: 8,
  },
  scoreItem: { alignItems: 'center', width: '25%' },
  scoreValue: { fontSize: 28, fontWeight: 'bold' },
  scoreLabel: { fontSize: 10, color: '#94a3b8', marginTop: 4, textTransform: 'uppercase' },

  // SecciÃ³ MÃ²bil
  sectionTitle: { fontSize: 16, marginBottom: 10, color: '#ffffff', marginTop: 10 },
  imageContainer: {
    alignItems: 'center',
    marginBottom: 20,
    padding: 10,
    backgroundColor: '#1e293b',
    borderRadius: 8,
  },
  screenshot: { width: 200, height: 400, borderRadius: 4, objectFit: 'contain' },

  // Llista d'Errors
  issueCard: {
    marginBottom: 8,
    padding: 10,
    backgroundColor: '#ffffff', // Targetes blanques per contrast de lectura
    borderRadius: 4,
    borderLeftWidth: 4,
    borderLeftColor: '#ef4444', // Vermell error
  },
  issueTitle: { fontSize: 12, color: '#0f111a', fontWeight: 'bold' },
  issueDesc: { fontSize: 10, color: '#475569', marginTop: 2 },
  
  footer: {
    position: 'absolute',
    bottom: 30,
    left: 30,
    right: 30,
    textAlign: 'center',
    fontSize: 8,
    color: '#64748b',
    borderTopWidth: 1,
    borderTopColor: '#334155',
    paddingTop: 10,
  }
});

// Helper per colors
const getScoreColor = (score: number) => {
  if (score >= 90) return '#4ade80'; // Verd
  if (score >= 50) return '#facc15'; // Groc
  return '#f87171'; // Vermell
};

export const AuditPDFDocument = ({ url, date, scores, screenshot, issues }: Props) => (
  <Document>
    <Page size="A4" style={styles.page}>
      
      {/* 1. HEADER */}
      <View style={styles.header}>
        <View>
            <Text style={styles.brand}>DigitAI Studios Audit</Text>
            <Text style={styles.title}>Informe d'Auditoria</Text>
            <Text style={styles.subtitle}>{url}</Text>
        </View>
        <View>
            <Text style={styles.subtitle}>{date}</Text>
        </View>
      </View>

      {/* 2. PUNTUACIONS */}
      <View style={styles.scoresContainer}>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.seo) }]}>{scores.seo}</Text>
            <Text style={styles.scoreLabel}>SEO</Text>
        </View>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.perf) }]}>{scores.perf}</Text>
            <Text style={styles.scoreLabel}>Rendiment</Text>
        </View>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.a11y) }]}>{scores.a11y}</Text>
            <Text style={styles.scoreLabel}>Accessibilitat</Text>
        </View>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.best) }]}>{scores.best}</Text>
            <Text style={styles.scoreLabel}>Best Practices</Text>
        </View>
      </View>

      {/* 3. CAPTURA DE PANTALLA (Si n'hi ha) */}
      {screenshot && (
        <View style={styles.imageContainer}>
            <Text style={[styles.subtitle, { marginBottom: 10 }]}>Vista PrÃ¨via Dispositiu MÃ²bil</Text>
            <Image src={screenshot} style={styles.screenshot} />
        </View>
      )}

      {/* 4. LLISTA D'ERRORS */}
      <Text style={styles.sectionTitle}>Accions Recomanades ({issues.length})</Text>
      {issues.slice(0, 8).map((issue, index) => ( // Limitem a 8 per no fer 50 pÃ gines de cop
        <View key={index} style={styles.issueCard}>
            <Text style={styles.issueTitle}>{issue.title}</Text>
            <Text style={styles.issueDesc}>{issue.description}</Text>
        </View>
      ))}

      {/* 5. FOOTER */}
      <Text style={styles.footer}>
        Generat automÃ ticament per DigitAI Studios. Aquest informe Ã©s privat i confidencial.
        Visita'ns a https://digitaistudios.com per a mÃ©s serveis.
      </Text>

    </Page>
  </Document>
);

// =================== FILE: src/features/auth/actions/auth.ts ===================

'use server';

import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { getTranslations } from 'next-intl/server'; // ğŸ‘ˆ Per traduir errors al servidor
import { AuthService } from '@/services/AuthService';
import { SupabaseProfileRepository } from '@/repositories/supabase/SupabaseProfileRepository';

// 1ï¸âƒ£ INSTANCIACIÃ“ DE DEPENDÃˆNCIES
// (Idealment aixÃ² vindria d'un container.ts, perÃ² aquÃ­ tambÃ© estÃ  bÃ©)
const profileRepo = new SupabaseProfileRepository();
const authService = new AuthService(profileRepo);

const MAIN_ORG_ID = process.env.NEXT_PUBLIC_MAIN_ORG_ID;

// Definim el tipus de l'estat del formulari per a TypeScript
export type AuthFormState = {
  success: boolean;
  message?: string;
  errors?: Record<string, string[]>;
  shouldRedirectToLogin?: boolean;
};

// ==========================================
// ğŸšª SIGN OUT (La teva acciÃ³ existent)
// ==========================================
export async function signOutAction() {
  const supabase = await createClient();
  await supabase.auth.signOut();
  redirect('/');
}

// ==========================================
// ğŸ”‘ LOGIN ACTION (Amb filtre d'OrganitzaciÃ³)
// ==========================================
export async function loginAction(
  prevState: AuthFormState, 
  formData: FormData
): Promise<AuthFormState> {
  
  if (!MAIN_ORG_ID) {
    return { success: false, message: "Error de configuraciÃ³: Manca ORG_ID" };
  }

  const t = await getTranslations('Auth'); // Carreguem traduccions
  
  // Cridem al nostre servei intelÂ·ligent
  const result = await authService.login(formData, MAIN_ORG_ID);

  if (!result.success) {
    return { 
      success: false, 
      // TraduÃ¯m el codi d'error (ex: 'auth.error.not_in_org')
      message: t(result.error!) 
    };
  }

  // Si tot va bÃ©, redirigim
  redirect('/dashboard');
}

// ==========================================
// ğŸ“ REGISTER ACTION (Amb control Multitenancy)
// ==========================================
export async function registerAction(
  prevState: AuthFormState, 
  formData: FormData
): Promise<AuthFormState> {
  
  if (!MAIN_ORG_ID) {
    return { success: false, message: "Error de configuraciÃ³: Manca ORG_ID" };
  }

  const t = await getTranslations('Auth');
  
  // Cridem al servei
  const result = await authService.register(formData, MAIN_ORG_ID);

  if (!result.success) {
    // CAS ESPECIAL: L'usuari ja existeix globalment a Supabase
    if (result.redirectToLogin) {
       return { 
         success: false, 
         message: t(result.error), // "Ja tens compte, fes login..."
         shouldRedirectToLogin: true 
       };
    }

    return { 
      success: false, 
      message: t(result.error!) 
    };
  }

  // Si el registre Ã©s correcte, normalment Supabase fa auto-login o envia email de confirmaciÃ³.
  // Redirigim a una pÃ gina d'espera o al dashboard directament.
  redirect('/dashboard'); 
}

// =================== FILE: src/features/auth/actions/reset-password.ts ===================

// =================== FILE: src/features/auth/actions/reset-password.ts ===================

'use server'

import { z } from 'zod';
import { createClient } from '@/lib/supabase/server';
import { getLocale } from 'next-intl/server';
import { redirect } from '@/routing'; // Usem el teu routing tipat

// Esquema per solÂ·licitar el reset
const ForgotPasswordSchema = z.object({
  email: z.string().email({ message: "L'email no Ã©s vÃ lid." }),
});

// Esquema per actualitzar la contrasenya
const ResetPasswordSchema = z.object({
  password: z.string().min(6, { message: "La contrasenya ha de tenir mÃ­nim 6 carÃ cters." }),
  confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
  message: "Les contrasenyes no coincideixen",
  path: ["confirmPassword"],
});

export type AuthState = {
  message?: string;
  success?: boolean;
  errors?: Record<string, string[]>;
};

/**
 * 1. L'usuari demana restablir la contrasenya via email
 */
export async function requestPasswordReset(prevState: AuthState, formData: FormData): Promise<AuthState> {
  const email = formData.get('email') as string;
  const locale = await getLocale();

  const validated = ForgotPasswordSchema.safeParse({ email });

  if (!validated.success) {
    return { errors: validated.error.flatten().fieldErrors };
  }

  const supabase = await createClient();
  
  // Aquest URL Ã©s on anirÃ  l'usuari desprÃ©s de fer clic al correu.
  // IMPORTANT: Redirigim al callback, que intercanviarÃ  el codi per sessiÃ³,
  // i desprÃ©s el callback redirigirÃ  a /auth/reset-password
  const redirectUrl = `${process.env.NEXT_PUBLIC_BASE_URL}/${locale}/auth/callback?next=/auth/reset-password`;

  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: redirectUrl,
  });

  if (error) {
    // Per seguretat, a vegades Ã©s millor no dir si l'email existeix o no, 
    // perÃ² per UX aquÃ­ mostrem l'error si Ã©s genÃ¨ric.
    return { message: error.message, success: false };
  }

  return { 
    success: true, 
    message: "Si l'email existeix, rebrÃ s un enllaÃ§ per restablir la contrasenya." 
  };
}

/**
 * 2. L'usuari (ja autenticat via link mÃ gic) posa la nova contrasenya
 */
export async function updatePassword(prevState: AuthState, formData: FormData): Promise<AuthState> {
  const password = formData.get('password') as string;
  const confirmPassword = formData.get('confirmPassword') as string;

  const validated = ResetPasswordSchema.safeParse({ password, confirmPassword });

  if (!validated.success) {
    return { errors: validated.error.flatten().fieldErrors };
  }

  const supabase = await createClient();

  const { error } = await supabase.auth.updateUser({
    password: validated.data.password
  });

  if (error) {
    return { message: "Error actualitzant la contrasenya.", success: false };
  }

  // Si tot va bÃ©, redirigim al dashboard
  const locale = await getLocale();
  redirect({ href: '/dashboard', locale });
  return { success: true }; // Codi mort per la redirecciÃ³, perÃ² necessari per TS
}

// =================== FILE: src/features/auth/ui/ForgotPasswordForm.tsx ===================

// =================== FILE: src/features/auth/ui/ForgotPasswordForm.tsx ===================

'use client'

import { useActionState } from 'react';
import { useTranslations } from 'next-intl';
import { requestPasswordReset } from '../actions/reset-password';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent } from '@/components/ui/card';
import { Loader2, CheckCircle2 } from 'lucide-react';

export function ForgotPasswordForm() {
  const t = useTranslations('Auth'); // Assegura't de tenir les traduccions
  
  const [state, action, isPending] = useActionState(requestPasswordReset, {
    message: '',
    errors: {}
  });

  if (state.success) {
    return (
      <Card className="border-green-200 bg-green-50">
        <CardContent className="pt-6 text-center space-y-4">
          <CheckCircle2 className="w-12 h-12 text-green-600 mx-auto" />
          <p className="text-green-800 font-medium">{state.message}</p>
          <p className="text-sm text-green-700">Revisa la teva safata d'entrada.</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardContent className="pt-6">
        <form action={action} className="space-y-4">
          <div className="space-y-2">
            <label htmlFor="email" className="text-sm font-medium">Email</label>
            <Input 
              id="email" 
              name="email" 
              type="email" 
              placeholder="tu@exemple.com"
              className={state.errors?.email ? "border-red-500" : ""}
            />
            {state.errors?.email && (
              <p className="text-sm text-red-500">{state.errors.email[0]}</p>
            )}
          </div>

          {state.message && !state.success && (
            <p className="text-sm text-red-500 text-center bg-red-50 p-2 rounded">{state.message}</p>
          )}

          <Button type="submit" className="w-full" disabled={isPending}>
            {isPending ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : "Enviar enllaÃ§ de recuperaciÃ³"}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/auth/ui/LoginForm.tsx ===================

'use client';

import { useState } from 'react';
// ğŸ‘‡ CANVIAT de 'react-dom' a 'react' i reanomenat
import { useActionState } from 'react'; 
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { createClient } from '@/lib/supabase/client';
import { Loader2, LogIn, Info } from 'lucide-react';
import { Link } from '@/routing';
import { useTranslations } from 'next-intl';
import { GoogleIcon } from '@/components/icons/GoogleIcon';
import { toast } from 'sonner';

// Importem la Server Action que hem creat abans
// âš ï¸ Ajusta la ruta si el vas guardar a src/auth/actions/auth.ts
import { loginAction } from '@/features/auth/actions/auth'; 

interface LoginFormProps {
  prefilledEmail?: string;
}

export function LoginForm({ prefilledEmail }: LoginFormProps) {
  const t = useTranslations('Auth');
  
  // ğŸ‘‡ CANVIAT: useActionState ens dona isPending directament!
  const [state, formAction, isPending] = useActionState(loginAction, { 
    success: false, 
    message: '' 
  });

  const [isGoogleLoading, setIsGoogleLoading] = useState(false);
  const supabase = createClient();

  const handleGoogleLogin = async () => {
    setIsGoogleLoading(true);
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: `${window.location.origin}/auth/callback`,
        queryParams: { access_type: 'offline', prompt: 'consent' },
      },
    });
    if (error) {
        toast.error(error.message);
        setIsGoogleLoading(false);
    }
  };

  return (
    <div className="w-full max-w-md mx-auto space-y-6">
      <div className="text-center space-y-2">
        <h1 className="text-3xl font-bold text-foreground">{t('login_title')}</h1>
        <p className="text-muted-foreground">{t('login_subtitle')}</p>
      </div>

      <div className="grid grid-cols-1 gap-4">
        <Button 
          variant="outline" 
          onClick={handleGoogleLogin} 
          disabled={isGoogleLoading || isPending}
          className="w-full h-12 border-border bg-card hover:bg-muted text-foreground gap-3 font-medium"
        >
          {isGoogleLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <GoogleIcon className="w-5 h-5" />}
          {t('social_google')}
        </Button>
      </div>

      <div className="relative">
        <div className="absolute inset-0 flex items-center"><span className="w-full border-t border-border" /></div>
        <div className="relative flex justify-center text-xs uppercase"><span className="bg-background px-2 text-muted-foreground">{t('or_email')}</span></div>
      </div>

      <form action={formAction} className="space-y-4">
        
        {state?.message && (
          <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-500 text-sm flex items-center gap-2">
            <Info className="w-4 h-4 shrink-0" />
            <span>{state.message}</span>
          </div>
        )}

        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">{t('label_email')}</label>
          <Input type="email" name="email" defaultValue={prefilledEmail} required autoFocus={!prefilledEmail} />
        </div>
        
        <div className="space-y-2">
          <div className="flex justify-between">
            <label className="text-sm font-medium text-foreground ml-1">{t('label_password')}</label>
            <Link href="/auth/forgot-password" className="text-sm text-primary hover:underline">{t('forgot_password')}</Link>
          </div>
          <Input type="password" name="password" required autoFocus={!!prefilledEmail} />
        </div>

        <Button 
          type="submit" 
          disabled={isPending} 
          className="w-full h-12 gradient-bg text-white font-bold"
        >
           {isPending ? <Loader2 className="animate-spin" /> : <><LogIn className="w-4 h-4 mr-2" /> {t('cta_login')}</>}
        </Button>

      </form>

      <p className="text-center text-sm text-muted-foreground">
        {t('no_account_prefix')} <Link href="/auth/register" className="text-primary hover:underline font-medium">{t('register_link')}</Link>
      </p>
    </div>
  );
}

// =================== FILE: src/features/auth/ui/RegisterForm.tsx ===================

'use client';

import { useState } from 'react';
// ğŸ‘‡ CANVI CLAU: Importem useActionState de 'react'
import { useActionState } from 'react'; 
import { useTranslations } from 'next-intl';

import { Link } from '@/routing'; 
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Checkbox } from '@/components/ui/checkbox';
import { createClient } from '@/lib/supabase/client';
import { Loader2, UserPlus, Info } from 'lucide-react';
import { GoogleIcon } from '@/components/icons/GoogleIcon';
import { toast } from 'sonner';

import { registerAction } from '@/features/auth/actions/auth'; 


export function RegisterForm({ prefilledEmail }: { prefilledEmail: string }) {
  const t = useTranslations('Auth');
  
  // ğŸ‘‡ CANVI CLAU: useActionState substitueix useFormState
  // Retorna: [estat, acciÃ³, pendent]
  const [state, formAction, isPending] = useActionState(registerAction, { 
    success: false, 
    message: '' 
  });

  const [fullName, setFullName] = useState('');
  const [termsAccepted, setTermsAccepted] = useState(false);
  const [isGoogleLoading, setIsGoogleLoading] = useState(false);
  const supabase = createClient();

  const handleGoogleRegister = async () => {
    if (!termsAccepted) {
      toast.error("Accepta la polÃ­tica de privacitat primer.");
      return;
    }
    setIsGoogleLoading(true);
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: `${window.location.origin}/auth/callback`,
        queryParams: { access_type: 'offline', prompt: 'consent' },
      },
    });
    if (error) {
      toast.error(error.message);
      setIsGoogleLoading(false);
    }
  };

  const isEmailLocked = !!prefilledEmail;

  return (
    <div className="w-full max-w-md mx-auto space-y-6">
      <div className="text-center space-y-2">
        <h1 className="text-3xl font-bold text-foreground">{t('register_title')}</h1>
        <p className="text-muted-foreground">{t('register_subtitle')}</p>
      </div>

      <div className="grid grid-cols-1 gap-4">
        <Button
          variant="outline"
          onClick={handleGoogleRegister}
          disabled={isGoogleLoading || isPending}
          className="w-full h-12 border-border bg-card hover:bg-muted text-foreground gap-3 font-medium"
        >
          {isGoogleLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <GoogleIcon className="w-5 h-5" />}
          {t('social_google_register')}
        </Button>
      </div>

      <div className="relative">
        <div className="absolute inset-0 flex items-center"><span className="w-full border-t border-border" /></div>
        <div className="relative flex justify-center text-xs uppercase"><span className="bg-background px-2 text-muted-foreground">O amb email</span></div>
      </div>

      <form action={formAction} className="space-y-4">
        {state?.message && (
          <div className="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20 text-yellow-600 text-sm flex items-center gap-2">
            <Info className="w-4 h-4 shrink-0" />
            <span>{state.message}</span>
            {state.shouldRedirectToLogin && <Link href="/auth/login" className="underline font-bold ml-1">Anar al Login</Link>}
          </div>
        )}

        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">Nom Complet</label>
          <Input name="full_name" type="text" placeholder="Joan Garcia" value={fullName} onChange={(e) => setFullName(e.target.value)} required />
        </div>

        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">Email</label>
          <Input name="email" type="email" defaultValue={prefilledEmail} readOnly={isEmailLocked} required />
        </div>

        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">Contrasenya</label>
          <Input name="password" type="password" required minLength={6} />
        </div>

        <div className="flex items-start space-x-3 pt-2">
          <Checkbox id="privacy" checked={termsAccepted} onCheckedChange={(c) => setTermsAccepted(c as boolean)} />
          <label htmlFor="privacy" className="text-sm text-muted-foreground cursor-pointer">
            He llegit i accepto la <Link href="/legal/privacitat" target="_blank" className="underline">polÃ­tica de privacitat</Link>.
          </label>
        </div>

        {/* ğŸ‘‡ Ara podem usar el botÃ³ directament perquÃ¨ isPending ve del hook principal */}
        <Button 
          type="submit" 
          disabled={isPending || !termsAccepted} 
          className="w-full h-12 gradient-bg text-white font-bold"
        >
          {isPending ? <Loader2 className="animate-spin" /> : <><UserPlus className="w-4 h-4 mr-2" /> Crear Compte</>}
        </Button>
      </form>

      <p className="text-center text-sm text-muted-foreground">
        {t('already_have_account')} <Link href="/auth/login" className="text-primary hover:underline font-medium">{t('login_link')}</Link>
      </p>
    </div>
  );
}

// =================== FILE: src/features/auth/ui/ResetPasswordForm.tsx ===================

// =================== FILE: src/features/auth/ui/ResetPasswordForm.tsx ===================

'use client'

import { useActionState } from 'react';
import { updatePassword } from '../actions/reset-password';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent } from '@/components/ui/card';
import { Loader2 } from 'lucide-react';

export function ResetPasswordForm() {
  const [state, action, isPending] = useActionState(updatePassword, {
    message: '',
    errors: {}
  });

  return (
    <Card>
      <CardContent className="pt-6">
        <form action={action} className="space-y-4">
          <div className="space-y-2">
            <label htmlFor="password" className="text-sm font-medium">Nova Contrasenya</label>
            <Input 
              id="password" 
              name="password" 
              type="password" 
              className={state.errors?.password ? "border-red-500" : ""}
            />
            {state.errors?.password && (
              <p className="text-sm text-red-500">{state.errors.password[0]}</p>
            )}
          </div>

          <div className="space-y-2">
            <label htmlFor="confirmPassword" className="text-sm font-medium">Confirmar Contrasenya</label>
            <Input 
              id="confirmPassword" 
              name="confirmPassword" 
              type="password" 
              className={state.errors?.confirmPassword ? "border-red-500" : ""}
            />
            {state.errors?.confirmPassword && (
              <p className="text-sm text-red-500">{state.errors.confirmPassword[0]}</p>
            )}
          </div>

          {state.message && (
            <p className="text-sm text-red-500 text-center">{state.message}</p>
          )}

          <Button type="submit" className="w-full" disabled={isPending}>
            {isPending ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : "Guardar nova contrasenya"}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/blog/actions/admin-actions.ts ===================

'use server';

import { postService } from '@/services/container';
import { requireAdmin } from '@/lib/auth/admin-guard';
import { revalidatePath } from 'next/cache';


// ğŸ‘‡ 1. Definim el tipus de retorn
export type ActionState = {
  success: boolean;
  message: string;
};

export async function togglePostStatusAction(slug: string, currentStatus: boolean): Promise<ActionState> {
  await requireAdmin(); // ğŸ›¡ï¸ Seguretat
  
  try {
    await postService.updatePost(slug, {
      published: !currentStatus
    });
    revalidatePath('/admin/blog');
    return { success: true, message: 'Estat actualitzat correctament.' };
  } catch (e) {
    console.error(e);
    return { success: false, message: 'Error actualitzant l\'estat.' };
  }
}

export async function deletePostAction(slug: string): Promise<ActionState> {
  await requireAdmin();
  
  try {
    await postService.deletePost(slug);
    revalidatePath('/admin/blog');
    return { success: true, message: 'Post eliminat.' };
  } catch (e) {
    console.error(e);
    return { success: false, message: 'Error eliminant el post.' };
  }
}

// ğŸ‘‡ 2. Tipem el prevState correctament en lloc de 'any'
export async function updatePostDetailsAction(prevState: ActionState, formData: FormData): Promise<ActionState> {
  // 1. Logs inicials
  console.log("ğŸš€ [Server Action] updatePostDetailsAction INICIAT");
  
  try {
    await requireAdmin();
    console.log("âœ… [Server Action] Admin verificat");

    // 2. ExtracciÃ³ de dades
    const slug = formData.get('slug') as string;
    const title = formData.get('title') as string;
    const description = formData.get('description') as string;
    const date = formData.get('date') as string;
    const content = formData.get('content') as string;
    const reviewed = formData.get('reviewed') === 'on';

    // 3. Log de dades rebudes (Important per debug)
    console.log("ğŸ“¦ [Server Action] Dades rebudes:", {
        slug,
        title,
        descriptionLength: description?.length,
        contentLength: content?.length, // Veurem si arriba text o estÃ  buit
        contentPreview: content?.substring(0, 20) + '...',
        reviewed,
        date
    });

    if (!slug) {
        console.error("âŒ [Server Action] Error: Falta l'slug");
        return { success: false, message: "Error: No s'ha trobat l'identificador del post." };
    }

    // 4. Crida al servei
    console.log("ğŸ”„ [Server Action] Cridant a postService.updatePost...");
    await postService.updatePost(slug, {
      title,
      description,
      content, 
      reviewed,
      date: date ? new Date(date).toISOString() : undefined,
    });
    console.log("âœ… [Server Action] postService.updatePost FINALITZAT sense errors");

    // 5. RevalidaciÃ³
    revalidatePath('/admin/blog');
    revalidatePath(`/admin/blog/${slug}`);
    revalidatePath(`/admin/blog/${slug}/edit`); // Important revalidar la prÃ²pia pÃ gina
    
    // âŒ HEM TRET EL REDIRECT PERQUÃˆ ET QUEDIS AQUÃ
    
    return { success: true, message: 'Canvis guardats correctament.' };

  } catch (e) {
    console.error("ğŸ’¥ [Server Action] EXCEPCIÃ“ CAPTURADA:", e);
    // Si l'error fos un redirect, el deixem passar, perÃ² com l'hem tret, aixÃ² serÃ  un error real.
    if ((e as Error).message === 'NEXT_REDIRECT') throw e;
    
    return { success: false, message: `Error guardant: ${(e as Error).message}` };
  }
}

// =================== FILE: src/features/blog/actions.ts ===================

'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';
import { postRepository } from '@/services/container';
export async function togglePostStatus(id: string, currentStatus: boolean) {
  const supabase = await createClient();
  
  // 1. Verificar sessiÃ³ (per seguretat)
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("No autoritzat");

  // 2. Actualitzar estat
  // Si estava true -> false. Si estava false -> true.
  // TambÃ© actualitzem 'status' (l'enum) per coherÃ¨ncia.
  const newStatus = !currentStatus;
  const newStatusEnum = newStatus ? 'published' : 'published';

  const { error } = await supabase
    .from('posts')
    .update({ 
        published: newStatus,
        status: newStatusEnum,
        published_at: newStatus ? new Date().toISOString() : null // Guardem data si publiquem
    })
    .eq('id', id);

  if (error) {
    console.error("Error toggling post:", error);
    return { success: false, message: error.message };
  }

  // 3. Refrescar la pÃ gina perquÃ¨ el botÃ³ canviÃ¯ de color sol
  revalidatePath('/admin/blog');
  revalidatePath(`/admin/blog/[slug]`, 'page'); // Refresca totes les subrutes dinÃ miques si cal
  
  return { success: true };
}

export async function toggleReactionAction(slug: string, reaction: string, visitorId: string) {
  try {
    if (!visitorId) return { success: false, message: "No visitor ID" };

    const result = await postRepository.toggleReaction(slug, reaction, visitorId);
    
    // Revalidem la pÃ gina del blog perquÃ¨ es recalculin els totals al servidor si cal
    revalidatePath(`/blog/${slug}`);
    
    return { success: true, action: result };
  } catch (error) {
    console.error("Error reaction:", error);
    return { success: false };
  }
}

// =================== FILE: src/features/blog/types.ts ===================

export type BlogPost = {
  slug: string;
  title: string;
  date: string;
  description: string;
  content: string; // El cos en Markdown
  tags: string[];
};

// =================== FILE: src/features/blog/ui/AdminPostList.tsx ===================

// src/features/blog/ui/AdminPostList.tsx
'use client';

import { BlogPostDTO } from '@/types/models';
import { Button } from '@/components/ui/button';
import {
  Edit, Trash2, Eye, EyeOff, Calendar,
  CheckCircle2, Share2,
  ChevronLeft,
  ChevronRight
} from 'lucide-react';
import { togglePostStatusAction, deletePostAction } from '../actions/admin-actions';
import { useTransition } from 'react';
import { Link, useRouter } from '@/routing'; // ğŸ‘ˆ Importem useRouter
import { cn } from '@/lib/utils';

interface AdminPostListProps {
  posts: BlogPostDTO[];
  currentPage: number; // ğŸ‘ˆ Nou prop
  totalPages: number;  // ğŸ‘ˆ Nou prop
}

export function AdminPostList({ posts, currentPage, totalPages }: AdminPostListProps) {
  const router = useRouter(); // Assegura't de tenir aixÃ² importat de '@/routing' o 'next/navigation'
  const [isPending, startTransition] = useTransition();

  // NavegaciÃ³ principal al fer clic a la fila
  const handleRowClick = (slug: string) => {
    router.push(`/admin/blog/${slug}`);
  };
  const handlePageChange = (newPage: number) => {
    // Naveguem a la nova URL, Next.js farÃ  el refresh de dades automÃ tic
    router.push(`/admin/blog?page=${newPage}`);
  };

  const handleToggle = (e: React.MouseEvent, slug: string, currentStatus: boolean) => {
    e.stopPropagation(); // ğŸ›‘ Evita que s'obri la fila quan cliquem el botÃ³
    if (confirm(`Vols canviar l'estat a ${!currentStatus ? 'PUBLICAT' : 'ESBORRANY'}?`)) {
      startTransition(async () => {
        await togglePostStatusAction(slug, currentStatus);
      });
    }
  };

  const handleDelete = (e: React.MouseEvent, slug: string) => {
    e.stopPropagation(); // ğŸ›‘ Evita que s'obri la fila
    if (confirm('EstÃ s segur?')) {
      startTransition(async () => {
        await deletePostAction(slug);
      });
    }
  };

  // Helper per calcular estat social
  const getSocialStatus = (socials: BlogPostDTO['social_posts']) => {
    if (!socials || socials.length === 0) return 'none';
    const hasPublished = socials.some(p => p.status === 'published' || p.status === 'scheduled');
    return hasPublished ? 'published' : 'draft';
  };

  return (
    <div className="flex flex-col min-h-150"> {/* Altura mÃ­nima per evitar salts */}

      {/* TAULA (Amb flex-grow per ocupar espai) */}
      <div className="overflow-x-auto grow">
        <table className="w-full text-sm text-left">
          <thead className="bg-muted text-muted-foreground font-medium border-b border-border uppercase text-xs">
            <tr>
              <th className="px-6 py-4">TÃ­tol</th>
              <th className="px-6 py-4">Estat Web</th>
              <th className="px-6 py-4 text-center">Social (IA)</th>
              <th className="px-6 py-4">Data</th>
              <th className="px-6 py-4 text-right">Accions</th>
            </tr>
          </thead>

          <tbody className="divide-y divide-border">
            {posts.map((post) => {
              const socialStatus = getSocialStatus(post.social_posts);
              const socialCount = post.social_posts?.length || 0;

              return (
                <tr
                  key={post.slug}
                  // ğŸ‘‡ MAGIA AQUÃ: Tota la fila Ã©s clicable
                  onClick={() => handleRowClick(post.slug)}
                  className="hover:bg-muted/50 transition-colors group cursor-pointer"
                >

                  {/* TÃTOL */}
                  <td className="px-6 py-4">
                    <div className="flex items-center gap-2">
                      <div className="font-bold text-foreground line-clamp-1 group-hover:text-primary transition-colors">
                        {post.title}
                      </div>
                      {post.reviewed && (
                        <div className="text-green-500" title="Revisat i aprovat">
                          <CheckCircle2 className="w-4 h-4 fill-green-500/10" />
                        </div>
                      )}
                    </div>
                    <div className="text-xs text-muted-foreground font-mono">{post.slug}</div>
                  </td>

                  {/* ESTAT WEB */}
                  <td className="px-6 py-4">
                    <span
                      className={cn(
                        "inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border",
                        post.published
                          ? "bg-green-500/10 text-green-600 border-green-500/20"
                          : "bg-yellow-500/10 text-yellow-600 border-yellow-500/20"
                      )}
                    >
                      {post.published ? 'Publicat' : 'Esborrany'}
                    </span>
                  </td>

                  {/* ESTAT SOCIAL */}
                  <td className="px-6 py-4 text-center">
                    <div className="flex justify-center">
                      {socialStatus === 'none' && (
                        <div title="Sense contingut social generat" className="opacity-20">
                          <Share2 className="w-5 h-5" />
                        </div>
                      )}

                      {socialStatus === 'draft' && (
                        <div title={`${socialCount} Posts generats (Esborranys)`} className="relative text-orange-500">
                          <Share2 className="w-5 h-5" />
                          <span className="absolute -top-1 -right-2 flex h-4 w-4 items-center justify-center rounded-full bg-orange-100 text-[9px] font-bold border border-orange-200">
                            {socialCount}
                          </span>
                        </div>
                      )}

                      {socialStatus === 'published' && (
                        <div title="DistribuciÃ³ Social Activa" className="relative text-purple-600">
                          <Share2 className="w-5 h-5 fill-purple-100" />
                          <div className="absolute -bottom-1 -right-1 bg-background rounded-full p-px">
                            <CheckCircle2 className="w-3 h-3 text-purple-600 fill-white" />
                          </div>
                        </div>
                      )}
                    </div>
                  </td>

                  {/* DATA */}
                  <td className="px-6 py-4 text-muted-foreground">
                    <div className="flex items-center gap-2">
                      <Calendar className="w-3.5 h-3.5 opacity-70" />
                      {post.date ? new Date(post.date).toLocaleDateString() : '-'}
                    </div>
                  </td>

                  {/* ACCIONS */}
                  <td className="px-6 py-4 text-right">
                    <div className="flex items-center justify-end gap-1 opacity-80 group-hover:opacity-100 transition-opacity">

                      {/* PUBLICAR / DESPUBLICAR */}
                      <Button
                        size="icon"
                        variant="ghost"
                        // Passem l'event 'e' per fer stopPropagation
                        onClick={(e) => handleToggle(e, post.slug, post.published)}
                        disabled={isPending}
                        className="hover:bg-background hover:text-foreground relative z-10"
                        title={post.published ? "Despublicar" : "Publicar"}
                      >
                        {post.published
                          ? <Eye className="w-4 h-4 text-green-500" />
                          : <EyeOff className="w-4 h-4 text-muted-foreground" />
                        }
                      </Button>

                      {/* EDITAR (Encara que la fila ho fa, el mantenim per claredat visual) */}
                      <Link href={`/admin/blog/${post.slug}`} onClick={(e) => e.stopPropagation()}>
                        <Button size="icon" variant="ghost" className="hover:bg-background hover:text-blue-500 relative z-10" title="Editar">
                          <Edit className="w-4 h-4" />
                        </Button>
                      </Link>

                      {/* ELIMINAR */}
                      <Button
                        size="icon"
                        variant="ghost"
                        onClick={(e) => handleDelete(e, post.slug)}
                        disabled={isPending}
                        className="hover:bg-red-500/10 hover:text-red-500 relative z-10"
                        title="Eliminar"
                      >
                        <Trash2 className="w-4 h-4" />
                      </Button>

                    </div>
                  </td>
                </tr>
              )
            })}

            {posts.length === 0 && (
              <tr>
                <td colSpan={5} className="text-center py-12 text-muted-foreground">
                  No s'han trobat articles.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
      {/* PEU DE PÃ€GINA AMB PAGINACIÃ“ */}
      {totalPages > 1 && (
        <div className="flex items-center justify-between px-6 py-4 border-t border-border bg-muted/20">
          <div className="text-xs text-muted-foreground">
            PÃ gina <strong>{currentPage}</strong> de <strong>{totalPages}</strong>
          </div>

          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => handlePageChange(currentPage - 1)}
              disabled={currentPage <= 1}
              className="h-8 px-3"
            >
              <ChevronLeft className="w-4 h-4 mr-1" /> Anterior
            </Button>

            <Button
              variant="outline"
              size="sm"
              onClick={() => handlePageChange(currentPage + 1)}
              disabled={currentPage >= totalPages}
              className="h-8 px-3"
            >
              SegÃ¼ent <ChevronRight className="w-4 h-4 ml-1" />
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/features/blog/ui/EditPostForm.tsx ===================

'use client';

import { useActionState, useState, useEffect } from 'react';
import { BlogPostDTO } from '@/types/models';
import { updatePostDetailsAction, ActionState } from '@/features/blog/actions/admin-actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent } from '@/components/ui/card';
import { Save, Eye, PenTool, ExternalLink, Loader2, CheckCircle2, ArrowLeft } from 'lucide-react';
import { Link } from '@/routing';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Checkbox } from '@/components/ui/checkbox';
import { toast } from 'sonner';

const initialState: ActionState = {
    success: false,
    message: '',
};

export function EditPostForm({ post }: { post: BlogPostDTO }) {
    const [state, formAction, isPending] = useActionState(updatePostDetailsAction, initialState);
    
    // Estats locals
    const [content, setContent] = useState(post.content || '');
    const [title, setTitle] = useState(post.title);
    
    // GestiÃ³ simplificada de l'estat "Reviewed"
    // NomÃ©s ens interessa per mostrar/amagar el check visual i l'input hidden
    const [isReviewed, setIsReviewed] = useState<boolean>(!!post.reviewed);

    useEffect(() => {
        if (state.message) {
            state.success ? toast.success(state.message) : toast.error(state.message);
        }
    }, [state]);

    return (
        <form action={formAction} className="max-w-5xl mx-auto pb-20">
            <input type="hidden" name="slug" value={post.slug} />
            
            {/* Input Hidden MANUAL: Aquest Ã©s el que realment llegeix el servidor */}
            <input type="hidden" name="reviewed" value={isReviewed ? "on" : "off"} />

            {/* HEADER */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 pb-6 border-b border-border">
                <div className="flex items-center gap-3 w-full md:w-auto">
                    <Link href={`/admin/blog/${post.slug}`}>
                        <Button variant="ghost" size="icon" type="button" className="hover:bg-muted text-muted-foreground hover:text-foreground shrink-0">
                            <ArrowLeft className="w-5 h-5" />
                        </Button>
                    </Link>
                    <div>
                        <h1 className="text-2xl font-bold text-foreground leading-tight">Editar Article</h1>
                        <p className="text-muted-foreground text-xs md:text-sm truncate max-w-[200px] md:max-w-md">
                            {post.title}
                        </p>
                    </div>
                </div>

                <div className="flex flex-wrap items-center gap-2 w-full md:w-auto justify-end">
                    {post.published && (
                        <Link href={`/blog/${post.slug}`} target="_blank" className="w-full sm:w-auto">
                            <Button variant="outline" size="sm" type="button" className="w-full gap-2">
                                <ExternalLink className="w-4 h-4" /> 
                                <span className="hidden sm:inline">Veure Web</span>
                                <span className="sm:hidden">Web</span>
                            </Button>
                        </Link>
                    )}
                    
                    <Button type="submit" disabled={isPending} className="w-full sm:w-auto bg-primary text-primary-foreground hover:bg-primary/90 gap-2 min-w-[140px]">
                        {isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4" />}
                        {isPending ? 'Guardant...' : 'Guardar Canvis'}
                    </Button>
                </div>
            </div>

            <Tabs defaultValue="edit" className="w-full space-y-6">
                <div className="flex items-center justify-between border-b border-border pb-px">
                    <TabsList className="bg-muted/50 p-1 w-full sm:w-auto grid grid-cols-2 sm:flex">
                        <TabsTrigger value="edit" className="gap-2 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm">
                            <PenTool className="w-4 h-4" /> EdiciÃ³
                        </TabsTrigger>
                        <TabsTrigger value="preview" className="gap-2 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm">
                            <Eye className="w-4 h-4" /> Vista PrÃ¨via
                        </TabsTrigger>
                    </TabsList>
                </div>

                <TabsContent value="edit" className="space-y-8 animate-in fade-in-50 duration-300">
                    <Card className="bg-card border-border shadow-sm">
                        <CardContent className="p-4 md:p-6 space-y-6">
                            
                            {/* Checkbox SAFE MODE */}
                            <div 
                                className="flex items-center space-x-3 p-4 bg-muted/30 hover:bg-muted/50 transition-colors rounded-lg border border-border cursor-pointer select-none" 
                                onClick={() => setIsReviewed(!isReviewed)}
                            >
                                <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${isReviewed ? 'bg-green-600 border-green-600' : 'bg-background border-input'}`}>
                                    {isReviewed && <CheckCircle2 className="w-3.5 h-3.5 text-white" />}
                                </div>
                                
                                <div className="grid gap-1 leading-none">
                                    <label className="text-sm font-medium flex items-center gap-2 cursor-pointer pointer-events-none">
                                        <span className={isReviewed ? 'text-green-600 font-bold' : 'text-muted-foreground'}>Marcar com a Revisat</span>
                                    </label>
                                    <p className="text-xs text-muted-foreground hidden sm:block">Aquest article compleix els estÃ ndards de qualitat.</p>
                                </div>
                            </div>

                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <label className="text-sm font-medium text-foreground">TÃ­tol Principal</label>
                                    <Input
                                        name="title"
                                        value={title}
                                        onChange={(e) => setTitle(e.target.value)}
                                        required
                                        className="text-base md:text-lg font-bold h-12 bg-background border-input focus:ring-primary/20"
                                    />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-sm font-medium text-foreground">Data de PublicaciÃ³</label>
                                    <Input
                                        type="datetime-local"
                                        name="date"
                                        defaultValue={post.date ? new Date(post.date).toISOString().slice(0, 16) : ''}
                                        className="h-12 bg-background border-input focus:ring-primary/20"
                                    />
                                </div>
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-medium text-foreground">DescripciÃ³ SEO</label>
                                <Textarea
                                    name="description"
                                    defaultValue={post.description || ''}
                                    rows={3}
                                    className="resize-none bg-background border-input focus:ring-primary/20"
                                />
                            </div>
                        </CardContent>
                    </Card>

                    <div className="space-y-2">
                        <label className="text-sm font-medium text-foreground ml-1">Contingut (Markdown / MDX)</label>
                        <div className="relative rounded-xl border border-input shadow-sm bg-background focus-within:ring-2 focus-within:ring-primary/20 transition-all">
                            <Textarea
                                name="content"
                                value={content}
                                onChange={(e) => setContent(e.target.value)}
                                className="min-h-[500px] w-full p-4 md:p-6 font-mono text-sm leading-relaxed border-0 focus-visible:ring-0 resize-y bg-transparent"
                                placeholder="# Escriu el teu article aquÃ­..."
                            />
                        </div>
                    </div>
                </TabsContent>

                <TabsContent value="preview" className="animate-in fade-in-50 duration-300">
                    <div className="border border-border rounded-xl bg-background shadow-lg overflow-hidden min-h-[500px]">
                        <div className="bg-muted/50 border-b border-border p-3 flex items-center gap-2">
                            <div className="flex gap-1.5">
                                <div className="w-2.5 h-2.5 rounded-full bg-red-400/80"></div>
                                <div className="w-2.5 h-2.5 rounded-full bg-yellow-400/80"></div>
                                <div className="w-2.5 h-2.5 rounded-full bg-green-400/80"></div>
                            </div>
                            <div className="mx-auto text-[10px] text-muted-foreground font-mono bg-background px-3 py-1 rounded border border-border opacity-70">
                                preview mode
                            </div>
                        </div>

                        <div className="p-6 md:p-12 max-w-3xl mx-auto">
                            <h1 className="text-3xl md:text-5xl font-extrabold mb-6 text-foreground tracking-tight">{title}</h1>
                            <div className="prose prose-slate dark:prose-invert max-w-none">
                                <pre className="whitespace-pre-wrap font-sans text-base leading-relaxed">
                                    {content || <span className="text-muted-foreground italic">ComenÃ§a a escriure per veure el resultat...</span>}
                                </pre>
                            </div>
                        </div>
                    </div>
                </TabsContent>
            </Tabs>
        </form>
    );
}

// =================== FILE: src/features/blog/ui/MDXContent.tsx ===================

import { MDXRemote } from 'next-mdx-remote/rsc';
import { Button } from '@/components/ui/button';
import React, { ComponentPropsWithoutRef } from 'react';
import { CheckCircle2 } from 'lucide-react';
import remarkGfm from 'remark-gfm';
import { Link } from '@/routing'; // âœ… 1. IMPORTEM EL LINK

// Tipus
type HeadingProps = ComponentPropsWithoutRef<'h1'>;
type ParagraphProps = ComponentPropsWithoutRef<'p'>;
type ListProps = ComponentPropsWithoutRef<'ul'>;
type CalloutProps = { children: React.ReactNode };
type TableProps = ComponentPropsWithoutRef<'table'>;
type ThProps = ComponentPropsWithoutRef<'th'>;
type TdProps = ComponentPropsWithoutRef<'td'>;

// Component de VÃ­deo
const Video = ({ id }: { id: string }) => (
  <div className="my-12 rounded-xl overflow-hidden shadow-2xl ring-1 ring-slate-900/10 aspect-video bg-slate-900 mx-auto w-full">
    <iframe
      className="w-full h-full"
      src={`https://www.youtube.com/embed/${id}`}
      title="YouTube video player"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowFullScreen
    />
  </div>
);

const components = {
  h1: (props: HeadingProps) => (
    <h1 {...props} className="text-3xl md:text-5xl font-extrabold mt-12 mb-6 text-foreground tracking-tight leading-tight" />
  ),
  h2: (props: HeadingProps) => (
    <h2 {...props} className="text-2xl md:text-3xl font-bold mt-12 mb-6 text-foreground border-b border-border/50 pb-2" />
  ),
  h3: (props: HeadingProps) => (
    <h3 {...props} className="text-xl md:text-2xl font-bold mt-8 mb-4 text-foreground" />
  ),
  p: (props: ParagraphProps) => (
    <p {...props} className="text-xl leading-8 text-slate-900 dark:text-slate-400 mb-8 font-sans" />
  ),
  strong: (props: ComponentPropsWithoutRef<'strong'>) => <strong {...props} className="font-bold text-foreground" />,
  a: (props: ComponentPropsWithoutRef<'a'>) => <a {...props} className="text-primary underline underline-offset-4 hover:text-primary/80 font-medium transition-colors" />,
  ul: (props: ListProps) => (
    <ul {...props} className="list-disc list-outside ml-6 space-y-3 mb-8 text-xl text-slate-900 dark:text-slate-500" />
  ),
  li: (props: ComponentPropsWithoutRef<'li'>) => <li {...props} className="pl-2" />,
  blockquote: (props: ComponentPropsWithoutRef<'blockquote'>) => (
    <blockquote {...props} className="border-l-4 border-primary pl-6 py-4 my-10 italic text-2xl text-slate-800 dark:text-slate-100 bg-muted/30 rounded-r-lg" />
  ),
  table: (props: TableProps) => (
    <div className="my-12 w-full overflow-x-auto rounded-xl border border-border shadow-sm">
      <table {...props} className="w-full text-left text-sm" />
    </div>
  ),
  thead: (props: ComponentPropsWithoutRef<'thead'>) => (
    <thead {...props} className="bg-muted/50 text-foreground border-b border-border" />
  ),
  tbody: (props: ComponentPropsWithoutRef<'tbody'>) => (
    <tbody {...props} className="divide-y divide-border bg-card" />
  ),
  tr: (props: ComponentPropsWithoutRef<'tr'>) => (
    <tr {...props} className="transition-colors hover:bg-muted/20" />
  ),
  th: (props: ThProps) => (
    <th {...props} className="px-6 py-4 font-bold text-foreground uppercase tracking-wider text-xs align-middle" />
  ),
  td: (props: TdProps) => (
    <td {...props} className="px-6 py-4 text-slate-600 dark:text-slate-300 align-middle leading-relaxed" />
  ),

  // âœ… 2. FIX DEL BUTTON (ARA NAVEGA)
  Button: ({ href, ...props }: React.ComponentProps<typeof Button> & { href?: string }) => {
    // Si tÃ© href, l'embolcallem amb Link
    if (href) {
      return (
        <div className="my-8 flex justify-center w-full">
          <Link href={href}>
            <Button size="lg" className="px-8 py-6 text-lg shadow-lg hover:scale-105 transition-transform w-full sm:w-auto" {...props} />
          </Link>
        </div>
      );
    }
    // Si no tÃ© href, es comporta com un botÃ³ normal
    return (
      <div className="my-8 flex justify-center w-full">
        <Button size="lg" className="px-8 py-6 text-lg shadow-lg hover:scale-105 transition-transform w-full sm:w-auto" {...props} />
      </div>
    );
  },

  // âœ… 3. FIX DEL CALLOUT (RESPONSIU MÃ’BIL)
  Callout: ({ children }: CalloutProps) => (
    // Canviat 'flex' per 'flex flex-col md:flex-row' per adaptar-se al mÃ²bil
    <div className="flex flex-col md:flex-row gap-4 md:gap-6 bg-primary/5 border border-primary/20 text-foreground p-6 md:p-8 my-10 rounded-xl shadow-sm items-start">
      <div className="shrink-0 mt-1 hidden md:block">
        <CheckCircle2 className="h-8 w-8 text-primary" />
      </div>
      {/* Icona mÃ©s petita per a mÃ²bil inline amb el tÃ­tol si calguÃ©s, o a dalt */}
      <div className="md:hidden flex items-center gap-2 mb-2">
         <CheckCircle2 className="h-6 w-6 text-primary" />
         <span className="font-bold text-primary">Nota</span>
      </div>
      
      <div className="text-lg leading-relaxed text-slate-900 dark:text-slate-100 w-full [&>div]:my-0">
        {children}
      </div>
    </div>
  ),

  Video,
};

export function MDXContent({ source }: { source: string }) {
  if (!source) return null;

  return (
    <article className="max-w-none w-full">
      <MDXRemote 
        source={source} 
        components={components} 
        options={{
          mdxOptions: {
            remarkPlugins: [remarkGfm],
          },
        }}
      />
    </article>
  );
}

// =================== FILE: src/features/blog/ui/PostStatusToggle.tsx ===================

// src/features/blog/ui/PostStatusToggle.tsx

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Loader2, Eye, EyeOff } from 'lucide-react'; // Canvi icones mÃ©s clares
import { togglePostStatus } from '../actions';
import { useRouter } from 'next/navigation';

type Props = {
  postId: string;
  isPublished: boolean;
};

export function PostStatusToggle({ postId, isPublished }: Props) {
  const [isLoading, setIsLoading] = useState(false);
  const router = useRouter();

  const handleToggle = async () => {
    setIsLoading(true);
    try {
      await togglePostStatus(postId, isPublished);
      router.refresh();
    } catch (error) {
      console.error(error);
      alert("Error canviant l'estat");
    } finally {
      setIsLoading(false);
    }
  };

  if (isPublished) {
    return (
      <Button 
        variant="outline" 
        onClick={handleToggle} 
        disabled={isLoading}
        className="border-yellow-500/30 text-yellow-600 dark:text-yellow-500 hover:bg-yellow-500/10 hover:border-yellow-500/50"
      >
        {isLoading ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <EyeOff className="w-4 h-4 mr-2" />}
        Despublicar
      </Button>
    );
  }

  return (
    <Button 
      variant="outline"
      onClick={handleToggle} 
      disabled={isLoading}
      className="border-primary/30 text-primary hover:bg-primary/5 hover:border-primary/60"
    >
      {isLoading ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Eye className="w-4 h-4 mr-2" />}
      Publicar
    </Button>
  );
}

// =================== FILE: src/features/blog/ui/ReactionDock.tsx ===================

'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { toggleReactionAction } from '../actions';
import { cn } from '@/lib/utils';
import { Plus, Heart } from 'lucide-react'; // Icones del Trigger

// 1. DEFINICIÃ“ DE TIPUS (Per arreglar l'error 'any')
type ReactionItem = {
    id: string;
    emoji: string;
    label: string;
};

interface ReactionButtonProps {
    reaction: ReactionItem;
    count: number;
    isActive: boolean;
    onReact: (id: string) => void;
}

const REACTIONS: ReactionItem[] = [
    { id: 'like', emoji: 'â¤ï¸', label: 'Love' },
    { id: 'mindblown', emoji: 'ğŸ¤¯', label: 'Wow' },
    { id: 'rocket', emoji: 'ğŸš€', label: 'Boost' },
    { id: 'party', emoji: 'ğŸ‰', label: 'Party' },
];

type Props = {
    slug: string;
    initialCounts: Record<string, number>;
};

export function ReactionDock({ slug, initialCounts }: Props) {
    const [counts, setCounts] = useState(initialCounts);
    const [myReactions, setMyReactions] = useState<Set<string>>(new Set());
    const [visitorId, setVisitorId] = useState<string>('');
    const [isMounted, setIsMounted] = useState(false);
    
    // Estat per obrir/tancar el menÃº (Unificat MÃ²bil/PC)
    const [isOpen, setIsOpen] = useState(false);

    // 1. INITIAL SETUP
    useEffect(() => {
        const timer = setTimeout(() => {
            setIsMounted(true);
            let vid = localStorage.getItem('digitai_visitor_id');
            if (!vid) {
                vid = Math.random().toString(36).substring(2) + Date.now().toString(36);
                localStorage.setItem('digitai_visitor_id', vid);
            }
            setVisitorId(vid);
        }, 0);
        return () => clearTimeout(timer);
    }, []);

    // 2. LOAD STATE
    useEffect(() => {
        if (!isMounted) return;
        const timer = setTimeout(() => {
            const stored = localStorage.getItem(`react_${slug}`);
            if (stored) {
                try { setMyReactions(new Set(JSON.parse(stored))); } catch { setMyReactions(new Set()); }
            } else {
                setMyReactions(new Set());
            }
        }, 0);
        return () => clearTimeout(timer);
    }, [slug, isMounted]);

    // 3. HANDLER
    const handleReact = async (reactionId: string) => {
        if (!visitorId) return;
        
        // HÃ ptic Feedback
        if (typeof navigator !== 'undefined' && navigator.vibrate) {
            try { navigator.vibrate(50); } catch {}
        }

        const isActive = myReactions.has(reactionId);

        setMyReactions(prev => {
            const next = new Set(prev);
            if (isActive) next.delete(reactionId); else next.add(reactionId);
            localStorage.setItem(`react_${slug}`, JSON.stringify(Array.from(next)));
            return next;
        });

        setCounts(prev => ({
            ...prev,
            [reactionId]: Math.max(0, (prev[reactionId] || 0) + (isActive ? -1 : 1))
        }));

        await toggleReactionAction(slug, reactionId, visitorId);
    };

    if (!isMounted) return null;

    return (
        // CONTENIDOR FIX (POSICIÃ“ RESPONSIVE)
        // MÃ²bil: bottom-24 (sobre navbar). Escriptori: bottom-8 (cantonada)
        <div className="fixed bottom-24 right-4 md:bottom-8 md:right-8 z-50 flex flex-col-reverse items-end gap-4">
            
            {/* 1. BOTÃ“ TRIGGER PRINCIPAL (FAB) */}
            <button 
                onClick={() => setIsOpen(!isOpen)}
                className={cn(
                    "w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center shadow-2xl border border-white/20 backdrop-blur-xl transition-all duration-500 ease-out z-50",
                    isOpen 
                        ? "bg-slate-900 text-white rotate-[135deg] border-red-500/50" 
                        : "bg-slate-900/80 hover:bg-slate-800 text-cyan-400 hover:scale-110"
                )}
            >
                <Plus className="w-6 h-6 md:w-7 md:h-7" />
            </button>

            {/* 2. LLISTA DESPLEGABLE (Vertical) */}
            <AnimatePresence>
                {isOpen && (
                    <div className="flex flex-col gap-3 pb-2 items-end">
                        {REACTIONS.map((r, i) => (
                            <motion.div
                                key={r.id}
                                initial={{ opacity: 0, y: 20, scale: 0.5, x: 20 }}
                                animate={{ opacity: 1, y: 0, scale: 1, x: 0 }}
                                exit={{ opacity: 0, y: 20, scale: 0.5, transition: { duration: 0.2 } }}
                                transition={{ 
                                    delay: i * 0.05, 
                                    type: "spring", 
                                    stiffness: 300, 
                                    damping: 20 
                                }}
                                className="flex items-center gap-3 justify-end group"
                            >
                                {/* Etiqueta (Tooltip) */}
                                <span className="text-[10px] md:text-xs font-bold text-white bg-black/60 px-2 py-1 rounded-md backdrop-blur-sm border border-white/5 opacity-0 group-hover:opacity-100 transition-opacity translate-x-2 group-hover:translate-x-0">
                                    {r.label}
                                </span>
                                
                                {/* BotÃ³ de ReacciÃ³ */}
                                <ReactionButton 
                                    reaction={r} 
                                    count={counts[r.id]} 
                                    isActive={myReactions.has(r.id)} 
                                    onReact={handleReact}
                                />
                            </motion.div>
                        ))}
                    </div>
                )}
            </AnimatePresence>
        </div>
    );
}

// ==========================================
// SUB-COMPONENT BOTÃ“ (Tipat Correctament)
// ==========================================
function ReactionButton({ reaction: r, count, isActive, onReact }: ReactionButtonProps) {
    return (
        <div className="relative">
            {/* Comptador (Badge) */}
            <AnimatePresence>
                {(count || 0) > 0 && (
                    <motion.div
                        key="count"
                        initial={{ opacity: 0, scale: 0 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, scale: 0 }}
                        className="absolute -top-2 -left-2 z-20 font-bold text-white bg-cyan-600 px-1.5 py-0.5 min-w-[20px] text-center rounded-full text-[10px] border border-cyan-400 shadow-lg pointer-events-none"
                    >
                        {count}
                    </motion.div>
                )}
            </AnimatePresence>

            {/* El BotÃ³ en si */}
            <motion.button
                whileHover={{ scale: 1.1 }}
                whileTap={{ scale: 0.9 }}
                onClick={() => onReact(r.id)}
                className={cn(
                    "w-10 h-10 md:w-12 md:h-12 flex items-center justify-center text-xl md:text-2xl rounded-full shadow-lg border backdrop-blur-md transition-all duration-300 relative overflow-hidden",
                    isActive 
                        ? "bg-slate-800 border-cyan-500/50 shadow-cyan-500/20" 
                        : "bg-slate-900/90 border-slate-700 hover:bg-slate-800"
                )}
            >
                <span className="filter drop-shadow-md select-none relative z-10">{r.emoji}</span>
                
                {isActive && (
                    <motion.div
                        layoutId={`glow-${r.id}`}
                        className="absolute inset-0 bg-cyan-500/20 blur-md"
                    />
                )}
            </motion.button>
        </div>
    );
}

// =================== FILE: src/features/email/templates/AuditReadyEmail.tsx ===================

import {
  Body,
  Container,
  Head,
  Heading,
  Html,
  Preview,
  Section,
  Text,
  Button,
  Hr,
  Row,
  Column,
  Img,
  Link,
} from '@react-email/components';

interface Suggestion {
  title: string;
  description: string;
  icon: string;
  impact: string;
}

interface AuditReadyEmailProps {
  businessName: string;
  url: string;
  seoScore: number;
  perfScore: number;
  auditId: string;
  baseUrl?: string;
  suggestions?: Suggestion[];
}

const getColor = (score: number) => {
  if (score >= 90) return '#22c55e';
  if (score >= 50) return '#eab308';
  return '#ef4444';
};

const getGrade = (score: number) => {
  if (score >= 90) return 'A';
  if (score >= 80) return 'B';
  if (score >= 60) return 'C';
  return 'D';
};

export const AuditReadyEmail = ({
  businessName = "El teu negoci",
  url = "exemple.com",
  seoScore = 45,
  perfScore = 82,
  auditId = "123",
  baseUrl = "https://digitai-studios.com", 
  suggestions = [],
}: AuditReadyEmailProps) => {
  
  const seoColor = getColor(seoScore);
  const perfColor = getColor(perfScore);

  // ğŸ”§ FIX LOGO: Si estem en localhost, els correus no poden veure la imatge.
  // Posa aquÃ­ la URL real del teu logo hostatjat a internet per fer proves
  const logoUrl = baseUrl?.includes('localhost') 
    ? 'https://via.placeholder.com/150x50?text=DigitAI+Logo' // Placeholder per local
    : `${baseUrl}/images/digitai-logo.png`; // URL ProducciÃ³

  return (
    <Html>
      <Head />
      <Preview>Resultats de l'anÃ lisi digital de {businessName}</Preview>
      
      <Body style={main}>
        <Container style={container}>
          
          {/* HEADER */}
          <Section style={header}>
            <Img
              src={logoUrl} 
              width="150"
              alt="DigitAI Studios"
              style={logo}
            />
          </Section>

          {/* HERO */}
          <Section style={heroSection}>
            <Heading style={heroTitle}>
              AnÃ lisi finalitzat
            </Heading>
            <Text style={heroText}>
              Hem analitzat la presÃ¨ncia digital de <strong>{url}</strong>.
              AquÃ­ tens el resum del rendiment tÃ¨cnic actual.
            </Text>
          </Section>

          {/* GRÃ€FIQUES */}
          <Section style={statsContainer}>
            <Row>
              <Column style={statCard}>
                <Text style={statLabel}>SEO</Text>
                <Heading style={{ ...statNumber, color: seoColor }}>
                  {seoScore} <span style={gradeLabel}>{getGrade(seoScore)}</span>
                </Heading>
                <div style={progressBarBg}>
                  <div style={{ ...progressBarFill, width: `${seoScore}%`, backgroundColor: seoColor }} />
                </div>
              </Column>
              <Column style={{ width: '20px' }} />
              <Column style={statCard}>
                <Text style={statLabel}>VELOCITAT</Text>
                <Heading style={{ ...statNumber, color: perfColor }}>
                  {perfScore} <span style={gradeLabel}>{getGrade(perfScore)}</span>
                </Heading>
                <div style={progressBarBg}>
                  <div style={{ ...progressBarFill, width: `${perfScore}%`, backgroundColor: perfColor }} />
                </div>
              </Column>
            </Row>
          </Section>

          {/* ğŸ‘‡ SECCIÃ“ MILLORADA VISUALMENT */}
          {suggestions.length > 0 && (
            <Section style={opportunityBox}>
              <Heading as="h3" style={opportunityTitle}>
                ğŸš€ Pla de Creixement
              </Heading>
              <Text style={paragraph}>
                Des de <strong>DigitAI Studios</strong> hem detectat punts clau que podrien augmentar la facturaciÃ³ del teu negoci:
              </Text>
              
              {/* ITERACIÃ“ DE SUGGERIMENTS */}
              {suggestions.map((item, index) => (
                <Section key={index} style={suggestionRow}>
                  <Row>
                    {/* COLUMNA ICONA (Fixa) */}
                    <Column width="40" style={{ verticalAlign: 'top', paddingTop: '4px' }}>
                      <div style={iconContainer}>
                        {/* Mapeig d'icones mÃ©s robust */}
                        {item.icon?.includes('calendar') ? 'ğŸ“…' : 
                         item.icon?.includes('shop') ? 'ğŸ›’' : 
                         item.icon?.includes('user') ? 'ğŸ‘¥' : 
                         item.icon?.includes('chart') ? 'ğŸ“ˆ' : 'ğŸ’¡'}
                      </div>
                    </Column>
                    {/* COLUMNA TEXT (Fluida) */}
                    <Column style={{ paddingLeft: '10px' }}>
                      <Text style={suggestionTitle}>{item.title}</Text>
                      <Text style={suggestionDesc}>{item.description}</Text>
                    </Column>
                  </Row>
                </Section>
              ))}
              
              <Text style={{ ...paragraph, fontSize: '14px', marginTop: '15px', fontStyle: 'italic', color: '#166534', textAlign: 'center' }}>
                Podem implementar aquestes millores en menys de 48h.
              </Text>
            </Section>
          )}

          {/* CTA FINAL */}
          <Section style={contentBox}>
            <Text style={paragraph}>
              Tens l'informe tÃ¨cnic complet disponible al teu panell. Si vols que t'ajudem a escalar el negoci, parlem.
            </Text>
            <Button
              style={button}
              href={`${baseUrl}/contact`}
            >
              SOLÂ·LICITAR IMPLEMENTACIÃ“ â†’
            </Button>
             <Text style={{ textAlign: 'center', marginTop: '15px' }}>
                <Link href={`${baseUrl}/dashboard/audits/${auditId}`} style={{ fontSize: '14px', color: '#64748b', textDecoration: 'underline' }}>
                  O veure nomÃ©s l'informe tÃ¨cnic
                </Link>
            </Text>
          </Section>

          <Hr style={hr} />

          {/* FOOTER */}
          <Section style={footer}>
            <Text style={footerText}>
              Â© 2024 DigitAI Studios. Transformant negocis.
            </Text>
            <Text style={footerText}>
              <Link href={`${baseUrl}/contact`} style={link}>Contacte</Link> â€¢ 
              <Link href={`${baseUrl}/privacy`} style={link}> Baixa</Link>
            </Text>
          </Section>

        </Container>
      </Body>
    </Html>
  );
};

export default AuditReadyEmail;

// --- ESTILS CSS (AJUSTATS PER EVITAR TALLS) ---

const main = { backgroundColor: '#f1f5f9', fontFamily: '"Helvetica Neue", Helvetica, Arial, sans-serif' };
const container = { margin: '0 auto', padding: '0', backgroundColor: '#ffffff', maxWidth: '600px', width: '100%', borderRadius: '12px', overflow: 'hidden', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)' };
const header = { padding: '30px 40px', backgroundColor: '#1e293b', textAlign: 'center' as const };
const logo = { margin: '0 auto', display: 'block' }; // display block ajuda a centrar
const heroSection = { padding: '40px 40px 20px', textAlign: 'center' as const };
const heroTitle = { fontSize: '24px', fontWeight: 'bold', color: '#0f172a', margin: '0 0 10px' };
const heroText = { fontSize: '16px', color: '#64748b', lineHeight: '24px', margin: '0' };
const statsContainer = { padding: '0 40px 20px' };
const statCard = { backgroundColor: '#f8fafc', border: '1px solid #e2e8f0', borderRadius: '8px', padding: '20px', textAlign: 'center' as const, width: '48%' };
const statLabel = { fontSize: '11px', fontWeight: 'bold', letterSpacing: '1px', color: '#94a3b8', margin: '0 0 5px' };
const statNumber = { fontSize: '36px', fontWeight: '800', margin: '0 0 15px', lineHeight: '1' };
const gradeLabel = { fontSize: '16px', color: '#94a3b8', fontWeight: 'normal', verticalAlign: 'top' };
const progressBarBg = { backgroundColor: '#e2e8f0', borderRadius: '99px', height: '8px', width: '100%', overflow: 'hidden', marginBottom: '10px' };
const progressBarFill = { height: '100%', borderRadius: '99px' };
const contentBox = { padding: '0 40px 40px' };
const paragraph = { fontSize: '16px', lineHeight: '26px', color: '#334155', marginBottom: '16px' };
const button = { backgroundColor: '#7c3aed', borderRadius: '8px', color: '#ffffff', fontSize: '16px', fontWeight: 'bold', textDecoration: 'none', textAlign: 'center' as const, display: 'block', width: '100%', padding: '16px', boxShadow: '0 4px 6px -1px rgba(124, 58, 237, 0.3)' };
const hr = { borderColor: '#e2e8f0', margin: '0' };
const footer = { backgroundColor: '#f8fafc', padding: '24px 40px', textAlign: 'center' as const };
const footerText = { fontSize: '12px', color: '#94a3b8', margin: '5px 0' };
const link = { color: '#7c3aed', textDecoration: 'none' };

// ESTILS OPORTUNITATS (REVISATS)
const opportunityBox = {
  backgroundColor: '#f0fdf4', 
  border: '1px solid #bbf7d0',
  borderRadius: '8px',
  padding: '24px',
  margin: '0 40px 30px', 
  width: 'auto', // Deixa que s'adapti
};

const opportunityTitle = {
  fontSize: '18px',
  color: '#166534', 
  margin: '0 0 16px', // MÃ©s espai a sota
};

const suggestionRow = {
  marginBottom: '12px',
  backgroundColor: '#ffffff',
  padding: '12px', // Padding intern per evitar que el text toqui les vores
  borderRadius: '6px',
  border: '1px solid #e2e8f0',
  width: '100%', // ForÃ§a l'amplada completa
};

const iconContainer = {
  fontSize: '24px',
  textAlign: 'center' as const,
};

const suggestionTitle = {
  fontWeight: 'bold',
  color: '#1e293b',
  fontSize: '15px',
  margin: '0 0 4px',
  display: 'block',
};

const suggestionDesc = {
  fontSize: '14px',
  color: '#64748b',
  margin: '0',
  lineHeight: '20px',
  display: 'block',
};

// =================== FILE: src/features/projects/actions/destroy-actions.ts ===================

'use server';

import { requireAdmin } from '@/lib/auth/admin-guard';
import { DestructionService, DestructionResult } from '@/services/factory/DestructionService';
import { revalidatePath } from 'next/cache';
// âœ… CORRECCIÃ“ 1: Importar redirect des de next/navigation
import { redirect } from 'next/navigation';

export type DestroyState = {
  message: string;
  errors?: string[];
  success: boolean;
  details?: DestructionResult;
};

export async function destroyProjectAction(
  prevState: DestroyState, 
  formData: FormData
): Promise<DestroyState> {
  await requireAdmin();

  const repoName = formData.get('repoName') as string;
  const confirmation = formData.get('confirmation') as string;

  if (confirmation !== 'SI') {
    return { 
      success: false, 
      message: "ConfirmaciÃ³ incorrecta. Has d'escriure 'SI' en majÃºscules." 
    };
  }

  if (!repoName) {
    return { success: false, message: "Falta el nom del repositori." };
  }

  try {
    const service = new DestructionService();
    // Aquest mÃ¨tode retorna un objecte amb els logs, no llanÃ§a error si tot va bÃ©
    const result = await service.destroyClient(repoName);

    console.log("DESTRUCCIÃ“ COMPLETADA:", result);

  } catch (error: unknown) {
    // Si l'error Ã©s una instÃ ncia d'Error, n'agafem el missatge
    const msg = error instanceof Error ? error.message : 'Error desconegut';
    return { success: false, message: msg };
  }

  // âœ… CORRECCIÃ“ 2: El redirect es fa FORA del try/catch
  // Si arribem aquÃ­, Ã©s que no hi ha hagut errors al catch.
  revalidatePath('/admin/projects');
  
  // El redirect llanÃ§a un error intern (NEXT_REDIRECT), aixÃ­ que tÃ¨cnicament "surt" de la funciÃ³ aquÃ­.
  redirect('/admin/projects?destroyed=true');
  
  // TypeScript pot queixar-se que "falta el return" si no detecta que redirect Ã©s terminal.
  // Aquest return mai s'executarÃ , perÃ² satisfÃ  al compilador estricte:
  return { success: true, message: "Redirigint..." }; 
}

// =================== FILE: src/features/projects/actions/invite-actions.ts ===================

'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';
import { z } from 'zod'; 

// 1. Tipus d'estat
export type InviteState = {
  success: boolean;
  error: string | null;
  message: string | null;
};

// 2. Schema de validaciÃ³
const inviteSchema = z.object({
  email: z.string().email("L'email no Ã©s vÃ lid."),
  projectId: z.string().uuid("L'ID del projecte no Ã©s vÃ lid."),
  orgId: z.string().min(1, "Falta l'ID de l'organitzaciÃ³.")
});

export async function inviteClientAction(prevState: InviteState, formData: FormData): Promise<InviteState> {
  const email = formData.get('email') as string;
  const projectId = formData.get('projectId') as string;
  const orgId = formData.get('orgId') as string;

  // âœ… CORRECCIÃ“ ZOD: safeParse retorna un objecte on l'error tÃ© la propietat 'issues'
  const validatedFields = inviteSchema.safeParse({ email, projectId, orgId });

  if (!validatedFields.success) {
    // ğŸ‘‡ AQUI ESTAVA L'ERROR: Usem .issues[0].message en lloc de .errors
    return { 
        success: false, 
        error: validatedFields.error.issues[0].message, 
        message: null 
    };
  }

  try {
    const supabase = await createClient();

    // A. Comprovar sessiÃ³
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { success: false, error: "SessiÃ³ caducada.", message: null };

    // B. LÃ²gica d'InvitaciÃ³ (Supabase Admin)
    // âš ï¸ NOTA: Per fer servir 'admin.inviteUserByEmail', el teu client de supabase
    // ha de tenir permisos d'administrador o fer servir la 'SERVICE_ROLE_KEY'.
    // Si aixÃ² falla amb "Forbidden", haurem de crear un client admin especÃ­fic.
    
    const { error: inviteError } = await supabase.auth.admin.inviteUserByEmail(email, {
      data: { 
          organization_id: orgId, 
          project_id: projectId,
          role: 'client' // Opcional: marca'l com a client a les metadades
      },
      redirectTo: `${process.env.NEXT_PUBLIC_APP_URL}/auth/callback` // Opcional: on va quan accepta
    });

    if (inviteError) {
        console.error("âŒ Error Supabase Invite:", inviteError);
        // Gestionem errors comuns de manera amigable
        if (inviteError.message.includes("already")) {
             return { success: false, error: "Aquest usuari ja estÃ  registrat.", message: null };
        }
        throw new Error("No s'ha pogut enviar la invitaciÃ³.");
    }

    // C. Revalidar
    revalidatePath(`/dashboard/projects/${projectId}`);

    return { success: true, error: null, message: `InvitaciÃ³ enviada a ${email}` };

  } catch (error: unknown) {
    const msg = error instanceof Error ? error.message : "Error desconegut";
    return { success: false, error: msg, message: null };
  }
}

// =================== FILE: src/features/projects/actions/project-actions.ts ===================

'use server';

import { SupabaseProjectRepository } from '@/repositories/supabase/SupabaseProjectRepository';
import { requireAdmin } from '@/lib/auth/admin-guard';
import { revalidatePath } from 'next/cache';

const repo = new SupabaseProjectRepository();

export async function addProjectMemberAction(projectId: string, userId: string) {
    await requireAdmin();
    const { error } = await repo.addMember(projectId, userId);
    
    if (error) {
        // Codi 23505 Ã©s "Unique violation" (ja existeix)
        if (error.code === '23505') return { success: false, message: 'Usuari ja vinculat.' };
        return { success: false, message: error.message };
    }

    revalidatePath(`/admin/projects/${projectId}`);
    return { success: true, message: 'Membre afegit al projecte.' };
}

export async function removeProjectMemberAction(projectId: string, userId: string) {
    await requireAdmin();
    const { error } = await repo.removeMember(projectId, userId);
    
    if (error) return { success: false, message: error.message };

    revalidatePath(`/admin/projects/${projectId}`);
    return { success: true, message: 'Membre eliminat del projecte.' };
}

// =================== FILE: src/features/projects/actions.ts ===================

'use server';

import { InfrastructureService } from '@/services/factory/InfrastrocutreService';
import { TenantService } from '@/services/TenantService';
import { AIService } from '@/services/ai/AIService'; 
import { ImageService } from '@/services/ImageService';
import { createClient } from '@/lib/supabase/server';
import { ActionResult } from '@/types/actions';
import { getSectorConfig } from '@/types/sectors';
import { I18nSchema } from '@/types/i18n';
import { randomUUID } from 'crypto'; // Necessari per generar slugs Ãºnics
import { SupabaseClient } from '@supabase/supabase-js'; // ğŸ‘ˆ 1. IMPORT NECESSARI
// 2. Definim la forma d'un item del catÃ leg base
interface SeedItem {
    name: string;
    desc: string;
    price: number;
    img: string;
}
const infra = new InfrastructureService();
const tenant = new TenantService();
const ai = new AIService();
const imageService = new ImageService();

// ğŸ¦´ ESQUELET ESTRUCTURAL (Base segura)
const BASE_SKELETON = {
    Navbar: {
        links: { home: "Inici", services: "Serveis", blog: "Blog", shop: "Botiga", contact: "Contacte", about: "Nosaltres" },
        cta: "AccÃ©s Clients",
        actions: { login: "Entrar", cart: "Cistella", menu: "MenÃº" }
    },
    Footer: {
        description: "Transformem idees en realitats digitals.",
        rights_reserved: "Tots els drets reservats.",
        legal: { privacy: "Privacitat", cookies: "Cookies", terms: "Termes" }
    },
    Booking: {
        title: "Reserva la teva cita",
        subtitle: "Selecciona el servei i l'hora.",
        steps: {
            services: { title: "Serveis", select: "Seleccionar", duration: "min" },
            datetime: { select_day_title: "Tria dia", select_time_title: "Tria hora", loading: "Cercant...", back: "Enrere", empty_state_day: "Selecciona dia", empty_state_slots: "No hi ha hores" },
            form: { title: "Dades", subtitle: "Completa la reserva", personal_info: "Info", labels: { name: "Nom", email: "Email" }, submit: "Confirmar", submitting: "Enviant..." },
            success: { title: "Reserva Confirmada!", message: "RebrÃ s un email.", home_button: "Inici" }
        },
        errors: { load_slots: "Error horaris", required_field: "Obligatori" }
    },
    Shop: { featuredTitle: "Destacats", featuredSubtitle: "SelecciÃ³ exclusiva", addToCart: "Afegir", outOfStock: "Esgotat" },
    featured_products: { title: "SelecciÃ³", subtitle: "Els nostres millors productes", limit: 4 },
    Blog: { title: "Blog", subtitle: "NotÃ­cies i consells", readMore: "Llegir mÃ©s", empty: "No hi ha articles" }
};

export async function createProjectAction(prevState: ActionResult | unknown, formData: FormData): Promise<ActionResult> {
    console.log("ğŸ [ACTION] Iniciant procÃ©s de creaciÃ³ de projecte...");

    // 1. EXTRACCIÃ“ DE DADES BÃ€SIQUES
    const businessName = formData.get('businessName') as string;
    const slug = formData.get('slug') as string;
    const description = formData.get('description') as string;
    const primaryColor = formData.get('primaryColor') as string;
    const logoFile = formData.get('logo') as File;
    const layoutVariant = (formData.get('layoutVariant') as 'modern' | 'shop') || 'modern';
    const sector = (formData.get('sector') as string) || "General";

    // 2. DADES DE CONTACTE
    const publicEmail = formData.get('publicEmail') as string;
    const phone = formData.get('phone') as string;
    const address = formData.get('address') as string;
    const socials = {
        instagram: formData.get('instagram') as string,
        linkedin: formData.get('linkedin') as string,
        twitter: formData.get('twitter') as string
    };

    // 3. SECCIONS DINÃ€MIQUES
    const enabledSectionsRaw = formData.get('enabledSections') as string;
    let landingSections = [
        { id: 'hero', type: 'hero' },
        { id: 'services', type: 'services' },
        { id: 'contact', type: 'contact' }
    ];

    if (enabledSectionsRaw) {
        try {
            const sectionIds = JSON.parse(enabledSectionsRaw) as string[];
            landingSections = sectionIds.map(id => ({ id, type: id }));
        } catch (e) {
            console.error("âš ï¸ [ACTION] Error parsejant enabledSections:", e);
        }
    }

    if (!businessName || !slug) return { success: false, error: "Falten dades obligatÃ²ries." };

    try {
        const supabase = await createClient();
        const { data: { user } } = await supabase.auth.getUser();
        if (!user || !user.email) return { success: false, error: "SessiÃ³ caducada." };

        // ğŸ—ï¸ 4. CREAR REPO
        console.log(`ğŸ—ï¸ [ACTION] Creant Repositori GitHub: ${slug}...`);
        const repoData = await infra.createRepository(slug, description);
        const isReady = await infra.waitForRepoReady(slug);
        
        if (!isReady) throw new Error("GitHub Timeout.");
        console.log(`âœ… [ACTION] Repo creat: ${repoData.html_url}`);

        // ğŸ§  5. GENERAR CONTINGUT
        let finalContent: I18nSchema; 
        const sectorConfig = getSectorConfig(sector);

        try {
            console.log("ğŸš€ [ACTION] Cridant IA...");
            const aiContent = await ai.generateTranslationFile(businessName, description, sector);
            const mergedContent = { ...aiContent, ...BASE_SKELETON } as I18nSchema;
            finalContent = imageService.enrichWithImages(mergedContent);
        } catch (e) {
            console.error("âš ï¸ [ACTION] Error IA, usant fallback.", e);
            finalContent = {
                ...BASE_SKELETON,
                hero: { title: businessName, subtitle: description, cta: "Contactar", image_prompt: "" },
                about: { badge: "Info", title: "Sobre nosaltres", description: description, image_prompt: "", stats: { label1: "Exp", value1: "+1", label2: "Clients", value2: "+10", label3: "Servei", value3: "24/7" } },
                services: { badge: "Serveis", title: "Serveis", subtitle: "El que oferim", items: [] },
                testimonials: { badge: "Opinions", title: "Opinions", subtitle: "", reviews: [] },
                featured_products: { title: "Productes Destacats", subtitle: "La nostra millor selecciÃ³", limit: 4 },
                map: { title: "On Som", subtitle: "Vine a visitar-nos." },
                cta_banner: { heading: "Impulsa el teu negoci", subheading: "Contacta'ns", buttonText: "Contactar" },
                faq: { title: "FAQ", subtitle: "", items: [] },
                contact: { title: "Contacte", description: "Parlem-ne.", button: "Enviar" }
            } as I18nSchema;
        }

        // ğŸ—„ï¸ 6. DATABASE (Tenant)
        console.log("ğŸ—„ï¸ [ACTION] Guardant Tenant...");
        const { org } = await tenant.createTenantStructure({
            businessName, slug, repoUrl: repoData.html_url,
            branding: { colors: { primary: primaryColor } },
            creatorUserId: user.id, creatorEmail: user.email
        });

        // ğŸŒ± 6.5 SEEDING (NOU!)
        // Si el projecte tÃ© la secciÃ³ 'featured_products', creem productes
        if (landingSections.some(s => s.id === 'featured_products')) {
            console.log("ğŸŒ± [ACTION] Sembrant productes d'exemple...");
            await seedProducts(supabase, org.id, sector);
        }

        // ğŸ“¦ 7. INJECCIÃ“
        console.log("ğŸ“¦ [ACTION] Injectant configuraciÃ³...");
        const siteConfigData = {
            name: businessName,
            description: finalContent.hero.subtitle,
            sector: sectorConfig.key,
            features: sectorConfig.features,
            theme: { primary: primaryColor, layout: layoutVariant },
            landing: { sections: landingSections }, 
            contact: { 
                email: publicEmail || user.email, 
                phone: phone || "+34 600 000 000", 
                address: address || "Catalunya", 
                socials 
            }
        };

        const filesToInject: Record<string, string> = {
            'src/messages/ca.json': JSON.stringify(finalContent, null, 2),
            'src/config/site-config.json': JSON.stringify(siteConfigData, null, 2)
        };

        await infra.commitFiles(slug, filesToInject);

        // ğŸš€ 8. DEPLOY & LOGO
        console.log("ğŸš€ [ACTION] Desplegant...");
        if (logoFile && logoFile.size > 0) {
            await infra.uploadLogo(slug, logoFile);
        }
        await infra.deployToVercel(slug, org.id, repoData.id);

        console.log("ğŸ‰ [ACTION] COMPLETAT!");
        return { success: true, repoUrl: repoData.html_url };

    } catch (error: unknown) {
        console.error("âŒ [ACTION] ERROR:", error);
        return { success: false, error: error instanceof Error ? error.message : "Error desconegut" };
    }
}

// ------------------------------------------------------------------
// ğŸ› ï¸ HELPER: SEEDING DE PRODUCTES (DinÃ mic per sector)
// ------------------------------------------------------------------
// 3. Tipem el client de Supabase correctament
async function seedProducts(supabase: SupabaseClient, orgId: string, sector: string) {
    const products = getProductsBySector(sector, orgId);

    // Ara TypeScript sap que 'products' tÃ© l'estructura correcta per a la DB
    const { error } = await supabase.from('products').insert(products);

    if (error) {
        console.error("âš ï¸ Error fent seeding:", error.message);
    } else {
        console.log(`âœ… Seeding correcte: ${products.length} productes creats.`);
    }
}
function getProductsBySector(sector: string, orgId: string) {
    const common = { 
        organization_id: orgId, 
        currency: 'EUR', 
        stock: 50, 
        active: true 
    };

    // 4. Tipem el diccionari de catÃ legs
    const catalogs: Record<string, SeedItem[]> = {
        restaurant: [
            { name: "MenÃº DegustaciÃ³", desc: "ExperiÃ¨ncia gastronÃ²mica completa.", price: 45.00, img: "https://images.unsplash.com/photo-1544025162-d76690b67f11?auto=format&fit=crop&w=800" },
            { name: "Vi de la Casa", desc: "SelecciÃ³ del sommelier.", price: 18.50, img: "https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?auto=format&fit=crop&w=800" },
            { name: "Postres Artesans", desc: "Fets al dia.", price: 8.00, img: "https://images.unsplash.com/photo-1563729784474-d77dbb933a9e?auto=format&fit=crop&w=800" },
            { name: "CÃ²ctel Especial", desc: "Per acabar la vetllada.", price: 12.00, img: "https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?auto=format&fit=crop&w=800" }
        ],
        fashion: [
            { name: "Jaqueta Premium", desc: "Disseny exclusiu.", price: 89.90, img: "https://images.unsplash.com/photo-1551028919-ac66e6a39d44?auto=format&fit=crop&w=800" },
            { name: "Samarreta CotÃ³", desc: "100% orgÃ nica.", price: 29.90, img: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=800" },
            { name: "Bossa de Pell", desc: "Feta a mÃ .", price: 120.00, img: "https://images.unsplash.com/photo-1584917865442-de89df76afd3?auto=format&fit=crop&w=800" },
            { name: "Ulleres de Sol", desc: "ProtecciÃ³ UV.", price: 45.00, img: "https://images.unsplash.com/photo-1572635196237-14b3f281503f?auto=format&fit=crop&w=800" }
        ],
        services: [
            { name: "Consultoria 1h", desc: "SessiÃ³ estratÃ¨gica.", price: 100.00, img: "https://images.unsplash.com/photo-1552664730-d307ca884978?auto=format&fit=crop&w=800" },
            { name: "Auditoria Web", desc: "AnÃ lisi complet.", price: 250.00, img: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?auto=format&fit=crop&w=800" },
            { name: "Pack Inici", desc: "Tot per comenÃ§ar.", price: 500.00, img: "https://images.unsplash.com/photo-1434626881859-194d67b2b86f?auto=format&fit=crop&w=800" },
            { name: "Suport Mensual", desc: "Manteniment inclÃ²s.", price: 50.00, img: "https://images.unsplash.com/photo-1516321318423-f06f85e504b3?auto=format&fit=crop&w=800" }
        ]
    };

    // Seleccionem el catÃ leg o el per defecte (services)
    const selectedCatalog = catalogs[sector] || catalogs['services'];

    // Mapegem a l'estructura de la DB
    return selectedCatalog.map((item, index) => ({
        ...common,
        slug: `prod-${index}-${randomUUID().substring(0, 8)}`,
        name: item.name,
        description: item.desc,
        price: item.price,
        images: [item.img] // Array de text
    }));
}

// =================== FILE: src/features/projects/data/projects-data.ts ===================

import { Project } from '@/types/models';

// --- IMATGES EXISTENTS ---
import ribotFlowImg from '@/assets/images/ribotflowPresentacio.jpg';
import salutFlowImgDark from '@/assets/images/getsalutflowIntroDark.jpg';
import salutFlowImgLight from '@/assets/images/getsalutflowIntroLight.jpg';
import salutFlowImgDarkCA from '@/assets/images/getsalutflowDarkCA.jpg';
import salutFlowImgLightCA from '@/assets/images/getsalutflowLightCA.jpg';

// --- âœ… NOVES IMATGES TRIATU (Assegura't que els fitxers existeixen) ---
import triaTuImgCA from '@/assets/images/triatu_ca.jpg'; 
import triaTuImgES from '@/assets/images/triatu_es.jpg'; 
import triaTuImgEN from '@/assets/images/triatu_en.jpg'; 

export const PROJECTS: Project[] = [
  {
    id: 'ribotflow',
    title: 'RibotFlow',
    tagline: 'El Sistema Operatiu Integral',
    description: '...', 
    stats: ['CRM + FacturaciÃ³', 'AutomatitzaciÃ³ IA', 'Control Financer'],
    tags: ['ERP', 'Business', 'IA', 'Supabase'],
    color: 'from-purple-500 to-pink-500',
    image: ribotFlowImg,
    imageAlt: "Panell de control fosc de RibotFlow",
    link: 'https://ribotflow.com'
  },
  {
    id: 'salutflow',
    title: 'SalutFlow',
    tagline: 'El teu Centre Esportiu, Digitalitzat',
    description: '...',
    stats: ['App PWA', 'Pagaments Stripe', "Llistes d'Espera"],
    tags: ['SaaS', 'Sport', 'PWA', 'Stripe'],
    color: 'from-cyan-400 to-blue-600',
    link: 'https://getsalutflow.com',
    imageAlt: "App mÃ²bil SalutFlow",
    
    image: salutFlowImgDark,

    adaptiveImages: {
      ca: {
        light: salutFlowImgLightCA,
        dark: salutFlowImgDarkCA
      },
      default: { // Per defecte (EN/ES) si no hi ha especÃ­fica
        light: salutFlowImgLight,
        dark: salutFlowImgDark
      }
    }
  },
  // âœ¨ NOU PROJECTE TRIATU
  {
    id: 'triatu',
    title: 'TriaTu',
    tagline: 'El teu Xef Personal amb IA', // Fallback, el real ve del JSON
    description: '...', 
    stats: ['Receptes Generatives', 'GestiÃ³ de Rebost', 'Cuina d\'Aprofitament'], // Fallback
    tags: ['FoodTech', 'AI', 'Next.js', 'Gamification'],
    color: 'from-emerald-500 to-teal-600', 
    
    // Imatge per defecte (si falla la lÃ²gica d'idioma)
    image: triaTuImgEN, 
    imageAlt: "InterfÃ­cie de l'assistent de cuina TriaTu",
    link: 'https://triatu.vercel.app',

    // âœ… LÃ²gica d'imatges per idioma
    adaptiveImages: {
      ca: {
        light: triaTuImgCA,
        dark: triaTuImgCA // Utilitzem la mateixa si no tens versiÃ³ fosca especÃ­fica
      },
      es: {
        light: triaTuImgES,
        dark: triaTuImgES
      },
      en: {
        light: triaTuImgEN,
        dark: triaTuImgEN
      },
      default: {
        light: triaTuImgEN,
        dark: triaTuImgEN
      }
    }
  }
];

// =================== FILE: src/features/projects/index.ts ===================

// Exportem nomÃ©s el que volem que la resta de l'app pugui utilitzar
export * from './ui/ProjectsHero';
export * from './ui/ProjectList';
export * from './ui/ProjectsCTA';
export * from './data/projects-data'; // Opcional, si necessites els tipus a fora

// =================== FILE: src/features/projects/ui/DeleteProjectButton.tsx ===================

'use client';

import { useActionState, useState } from 'react';
import { destroyProjectAction } from '../actions/destroy-actions';
import { Trash2, AlertTriangle, X, Loader2 } from 'lucide-react';

interface Props {
  repoName: string; // El nom del repo/slug del client
}

export function DestructionButton({ repoName }: Props) {
  const [isOpen, setIsOpen] = useState(false);
  const [confirmInput, setConfirmInput] = useState('');
  
  // Hook de React 19/Next 15 per gestionar formularis
  const [state, formAction, isPending] = useActionState(destroyProjectAction, {
    success: false,
    message: '',
  });

  if (!isOpen) {
    return (
      <button 
        onClick={() => setIsOpen(true)}
        className="flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 hover:bg-red-200 rounded-lg text-sm font-bold border border-red-200 transition-colors"
      >
        <Trash2 className="w-4 h-4" />
        Destruir Client
      </button>
    );
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
      <div className="bg-white dark:bg-slate-900 w-full max-w-md rounded-xl shadow-2xl border border-red-500 overflow-hidden">
        
        {/* Header vermell */}
        <div className="bg-red-600 p-4 flex items-center justify-between text-white">
          <h2 className="font-bold flex items-center gap-2 text-lg">
            <AlertTriangle className="w-5 h-5" />
            ZONA DE PERILL
          </h2>
          <button onClick={() => setIsOpen(false)} className="hover:bg-red-700 p-1 rounded">
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* Contingut */}
        <div className="p-6 space-y-4">
          <p className="text-slate-700 dark:text-slate-300">
            EstÃ s a punt d'<strong>ELIMINAR PER SEMPRE</strong> el client:
            <br />
            <code className="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-red-600 font-mono mt-1 block w-fit">
              {repoName}
            </code>
          </p>
          
          <ul className="text-sm text-slate-500 list-disc pl-5 space-y-1">
            <li>S'eliminarÃ  el projecte de <strong>Vercel</strong>.</li>
            <li>S'esborrarÃ  el repositori de <strong>GitHub</strong>.</li>
            <li>Es destruirÃ  tota la <strong>Base de Dades</strong> (Supabase).</li>
          </ul>

          {/* Missatge d'error si falla */}
          {state.message && (
            <div className="bg-red-50 text-red-600 p-3 rounded-md text-sm font-medium border border-red-100">
              {state.message}
            </div>
          )}

          {/* Formulari */}
          <form action={formAction} className="space-y-4 mt-4">
            <input type="hidden" name="repoName" value={repoName} />
            
            <div>
              <label className="block text-xs font-bold uppercase text-slate-500 mb-1">
                Escriu "SI" per confirmar:
              </label>
              <input 
                type="text" 
                name="confirmation"
                value={confirmInput}
                onChange={(e) => setConfirmInput(e.target.value)}
                placeholder="SI"
                className="w-full p-2 border border-slate-300 dark:border-slate-700 rounded-md bg-transparent focus:ring-2 focus:ring-red-500 outline-none"
                autoComplete="off"
              />
            </div>

            <div className="flex justify-end gap-2 pt-2">
              <button
                type="button"
                onClick={() => setIsOpen(false)}
                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium"
                disabled={isPending}
              >
                CancelÂ·lar
              </button>
              
              <button
                type="submit"
                disabled={confirmInput !== 'SI' || isPending}
                className="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg text-sm font-bold flex items-center gap-2"
              >
                {isPending && <Loader2 className="w-4 h-4 animate-spin" />}
                {isPending ? 'Destruint...' : 'CONFIRMAR DESTRUCCIÃ“'}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/features/projects/ui/form/AISection.tsx ===================

'use client';

import { Sparkles, Bot, Briefcase, ListFilter } from 'lucide-react';
import { FormSection } from './FormSection';

interface Props {
  defaultValue?: string;
}

// ğŸ§  TAXONOMIA EXPANDIDA PER A MILLOR CONTEXT IA
const SECTOR_GROUPS = {
  "Gastronomia i Hosteleria": [
    "Restaurant / Bistro",
    "Cafeteria / Fleca",
    "Bar de Copes / Oci Nocturn",
    "Hotel / Turisme Rural",
    "CÃ tering / Events"
  ],
  "Salut, Bellesa i Benestar": [
    "GimnÃ s / Entrenador Personal",
    "Perruqueria / Barberia",
    "Centre d'EstÃ¨tica / Spa",
    "FisioterÃ pia / Osteopatia",
    "Psicologia / Coaching",
    "Ioga / Pilates",
    "ClÃ­nica Dental / MÃ¨dica"
  ],
  "Serveis Professionals": [
    "Advocats / Legal",
    "Assessoria / Gestoria",
    "Consultoria de Negoci",
    "AgÃ¨ncia de MÃ rqueting / Publicitat",
    "Desenvolupament Web / IT",
    "Arquitectura / Interiorisme",
    "ImmobiliÃ ria"
  ],
  "Oficis i Reformes": [
    "Reformes Integrals",
    "ConstrucciÃ³",
    "Fusteria / Ebenisteria",
    "Electricista / Lampista",
    "Jardineria / Paisatgisme",
    "Neteja i Manteniment",
    "Taller MecÃ nic"
  ],
  "ComerÃ§ i Retail": [
    "Botiga de Roba / Moda",
    "AlimentaciÃ³ / Gourmet",
    "Botiga d'Animals / VeterinÃ ria",
    "Floristeria",
    "E-commerce (NomÃ©s Online)"
  ],
  "EducaciÃ³ i Altres": [
    "AcadÃ¨mia / Classes Particulars",
    "Llar d'Infants / Escola",
    "AssociaciÃ³ / ONG",
    "Artista / Creatiu",
    "Altres"
  ]
};

export function AISection({ defaultValue }: Props) {
  return (
    <FormSection 
      title="IntelÂ·ligÃ¨ncia Artificial" 
      description="Defineix el teu negoci perquÃ¨ la IA redacti els continguts perfectes."
      icon={<Bot className="w-5 h-5" />}
      delay={0.2}
    >
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        {/* Input DescripciÃ³ */}
        <div className="space-y-2">
            <label className="text-sm font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2">
                <Sparkles className="w-4 h-4 text-purple-500" /> DescripciÃ³ del Negoci
            </label>
            <div className="relative">
                <textarea 
                    name="description" 
                    required 
                    defaultValue={defaultValue}
                    rows={5}
                    className="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none text-sm resize-none leading-relaxed shadow-sm" 
                    placeholder="Ex: Som una fusteria artesanal a Olot especialitzada en mobles a mida de fusta massissa. Busquem transmetre tradiciÃ³ perÃ² amb dissenys moderns..." 
                />
                <div className="absolute bottom-3 right-3 text-xs text-slate-400 pointer-events-none">
                    MÃ©s detall = Millor web
                </div>
            </div>
        </div>

        {/* Selector de Sector Millorat */}
        <div className="space-y-4">
            <div>
                <label className="text-sm font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2 mb-2">
                    <Briefcase className="w-4 h-4 text-purple-500" /> Sector d'Activitat
                </label>
                <div className="relative">
                    <select 
                        name="sector" 
                        className="w-full p-3 pl-10 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none text-sm appearance-none cursor-pointer shadow-sm truncate"
                    >
                        {Object.entries(SECTOR_GROUPS).map(([group, sectors]) => (
                            <optgroup key={group} label={group} className="font-bold text-slate-900 dark:text-white">
                                {sectors.map(sector => (
                                    <option key={sector} value={sector} className="font-normal text-slate-600">
                                        {sector}
                                    </option>
                                ))}
                            </optgroup>
                        ))}
                    </select>
                    
                    {/* Icona esquerra */}
                    <div className="absolute left-3 top-3.5 pointer-events-none text-slate-400">
                        <ListFilter className="w-4 h-4" />
                    </div>

                    {/* Fletxa custom dreta */}
                    <div className="absolute right-3 top-3.5 pointer-events-none opacity-50">
                        <svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                    </div>
                </div>
            </div>

            {/* Targeta Informativa */}
            <div className="p-4 bg-linear-to-br from-purple-50 to-indigo-50 dark:from-purple-900/10 dark:to-indigo-900/10 rounded-xl border border-purple-100 dark:border-purple-800/30">
                <h4 className="text-xs font-bold text-purple-700 dark:text-purple-300 mb-1 flex items-center gap-1">
                    <Bot className="w-3 h-3" /> MÃ gia en acciÃ³
                </h4>
                <p className="text-xs text-slate-600 dark:text-slate-400 leading-snug">
                    Seleccionant el sector correcte, la IA sabrÃ  quins serveis, preguntes freqÃ¼ents i estil de text generar per a tu automÃ ticament.
                </p>
            </div>
        </div>

      </div>
    </FormSection>
  );
}

// =================== FILE: src/features/projects/ui/form/ContactSection.tsx ===================

'use client';

import { Mail, Phone, MapPin, Share2, Instagram, Linkedin, Twitter } from 'lucide-react';
// Assegura't que FormSection existeix. Si no, fes-m'ho saber i et dono el codi.
import { FormSection } from './FormSection'; 

export function ContactSection() {
  return (
    <FormSection 
      title="Dades de Contacte i Xarxes" 
      description="Aquesta informaciÃ³ apareixerÃ  al Footer i a la pÃ gina de Contacte."
      icon={<Share2 className="w-5 h-5" />}
      delay={0.2}
    >
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        {/* COLUMNA 1: CONTACTE DIRECTE */}
        <div className="space-y-4">
          <h3 className="text-sm font-bold text-slate-900 dark:text-white flex items-center gap-2">
            <Mail className="w-4 h-4 text-indigo-500" /> Contacte
          </h3>
          
          <div>
            <label className="block text-xs font-medium text-slate-500 mb-1">Email PÃºblic</label>
            <div className="relative">
              <input 
                type="email" 
                name="publicEmail" 
                placeholder="hola@elmeunegoci.com"
                className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
              />
              <Mail className="w-4 h-4 text-slate-400 absolute left-3 top-2.5" />
            </div>
          </div>

          <div>
            <label className="block text-xs font-medium text-slate-500 mb-1">TelÃ¨fon</label>
            <div className="relative">
              <input 
                type="tel" 
                name="phone" 
                placeholder="+34 600 000 000"
                className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
              />
              <Phone className="w-4 h-4 text-slate-400 absolute left-3 top-2.5" />
            </div>
          </div>

          <div>
            <label className="block text-xs font-medium text-slate-500 mb-1">AdreÃ§a FÃ­sica</label>
            <div className="relative">
              <input 
                type="text" 
                name="address" 
                placeholder="Carrer Exemple, 123, Barcelona"
                className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
              />
              <MapPin className="w-4 h-4 text-slate-400 absolute left-3 top-2.5" />
            </div>
          </div>
        </div>

        {/* COLUMNA 2: XARXES SOCIALS */}
        <div className="space-y-4">
          <h3 className="text-sm font-bold text-slate-900 dark:text-white flex items-center gap-2">
            <Share2 className="w-4 h-4 text-indigo-500" /> Xarxes Socials
          </h3>

          <div>
            <label className="block text-xs font-medium text-slate-500 mb-1">Instagram (URL)</label>
            <div className="relative">
              <input 
                type="url" 
                name="instagram" 
                placeholder="https://instagram.com/..."
                className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
              />
              <Instagram className="w-4 h-4 text-pink-500 absolute left-3 top-2.5" />
            </div>
          </div>

          <div>
            <label className="block text-xs font-medium text-slate-500 mb-1">LinkedIn (URL)</label>
            <div className="relative">
              <input 
                type="url" 
                name="linkedin" 
                placeholder="https://linkedin.com/in/..."
                className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
              />
              <Linkedin className="w-4 h-4 text-blue-600 absolute left-3 top-2.5" />
            </div>
          </div>

          <div>
            <label className="block text-xs font-medium text-slate-500 mb-1">Twitter / X (URL)</label>
            <div className="relative">
              <input 
                type="url" 
                name="twitter" 
                placeholder="https://twitter.com/..."
                className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
              />
              <Twitter className="w-4 h-4 text-sky-500 absolute left-3 top-2.5" />
            </div>
          </div>
        </div>

      </div>
    </FormSection>
  );
}

// =================== FILE: src/features/projects/ui/form/DesignSection.tsx ===================

'use client';

import { 
  Palette, Layout, Layers, ShoppingBag, Calendar, BookOpen, Lock, LayoutDashboard,
  Star, Wrench, Users, MessageCircle, Mail, HelpCircle,
  MapPin,  Rocket, Tag, Store
} from 'lucide-react';
import { FormSection } from './FormSection';
import { motion } from 'framer-motion';
import { useState } from 'react';

// 1. MÃ’DULS FUNCIONALS (Feature Flags)
const MODULES = [
  { id: 'booking', label: 'Reserves', icon: Calendar, desc: 'Sistema de cites' },
  { id: 'ecommerce', label: 'Botiga Online', icon: Store, desc: 'Venda de productes' },
  { id: 'blog', label: 'Blog', icon: BookOpen, desc: 'NotÃ­cies i SEO' },
  { id: 'inventory', label: 'Inventari', icon: Layers, desc: "GestiÃ³ d'estoc" },
  { id: 'accessControl', label: 'Zona Privada', icon: Lock, desc: 'Login clients' },
  { id: 'chatbot', label: 'Assistent IA', icon: MessageCircle, desc: 'AtenciÃ³ 24/7' },
];

// 2. SECCIONS DE LA LANDING (Visuals)
const SECTIONS_CONFIG = [
    { id: 'hero', label: 'Hero / Intro', icon: Layout, required: true },
    { id: 'about', label: 'Nosaltres', icon: Users, default: true }, // Inclou Stats
    { id: 'services', label: 'Serveis', icon: Wrench, default: true },
    { id: 'featured_products', label: 'Top Vendes', icon: Tag, default: false },
    { id: 'cta_banner', label: 'Crida AcciÃ³', icon: Rocket, default: true },
    { id: 'testimonials', label: 'Ressenyes', icon: Star, default: true },
    { id: 'map', label: 'UbicaciÃ³', icon: MapPin, default: true },
    { id: 'faq', label: 'Preguntes', icon: HelpCircle, default: false },
    { id: 'contact', label: 'Contacte', icon: Mail, required: true },
];

// 3. COLORS RÃ€PIDS (Opcional, si vols mantenir el teu input lliure, pots esborrar aixÃ²)
const PRESET_COLORS = [
  "#6366f1", "#0ea5e9", "#22c55e", "#ef4444", "#f97316", "#a855f7", "#0f172a"
];

export function DesignSection({ defaultColor }: { defaultColor?: string }) {
  
  // Estat per gestionar les seccions activades (per defecte: required + default)
  const [selectedSections, setSelectedSections] = useState<string[]>(
    SECTIONS_CONFIG.filter(s => s.required || s.default).map(s => s.id)
  );

  const [color, setColor] = useState(defaultColor || "#6366f1");

  const toggleSection = (id: string, required?: boolean) => {
    if (required) return;
    setSelectedSections(prev => 
      prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]
    );
  };

  return (
    <FormSection 
      title="Disseny i Funcionalitat" 
      description="Personalitza l'aspecte, les seccions visibles i els mÃ²duls actius."
      icon={<Palette className="w-5 h-5" />}
      delay={0.3}
    >
        {/* INPUT HIDDEN PER ENVIAR L'ARRAY AL SERVIDOR */}
        <input type="hidden" name="enabledSections" value={JSON.stringify(selectedSections)} />

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            {/* Color */}
            <div>
                <label className="block text-sm font-medium mb-3 text-slate-700 dark:text-slate-300">Color Primari</label>
                <div className="flex flex-col gap-3">
                    {/* Input Color Lliure */}
                    <div className="flex items-center gap-4 p-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
                        <input 
                            type="color" 
                            name="primaryColor" 
                            value={color}
                            onChange={(e) => setColor(e.target.value)}
                            className="h-10 w-10 rounded-lg cursor-pointer border-0 bg-transparent" 
                        />
                        <div className="text-xs text-slate-500">
                            Tria el color de la teva marca.
                        </div>
                    </div>
                    {/* Presets RÃ pids */}
                    <div className="flex gap-2">
                        {PRESET_COLORS.map(c => (
                            <button 
                                key={c} type="button" 
                                onClick={() => setColor(c)}
                                className={`w-6 h-6 rounded-full border border-slate-200 transition-transform hover:scale-110 ${color === c ? 'ring-2 ring-offset-1 ring-slate-400' : ''}`}
                                style={{ backgroundColor: c }}
                            />
                        ))}
                    </div>
                </div>
            </div>

            {/* Layout */}
            <div>
                <label className="block text-sm font-medium mb-3 text-slate-700 dark:text-slate-300">Tipus de Web</label>
                <div className="grid grid-cols-2 gap-3">
                    <label className="cursor-pointer group">
                        <input type="radio" name="layoutVariant" value="modern" defaultChecked className="peer hidden" />
                        <div className="p-3 border-2 border-slate-200 dark:border-slate-700 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/20 transition-all text-center group-hover:border-indigo-200">
                            <Layout className="w-6 h-6 mx-auto mb-2 text-slate-400 peer-checked:text-indigo-600" />
                            <span className="text-xs font-bold block">Corporativa</span>
                        </div>
                    </label>
                    <label className="cursor-pointer group">
                        <input type="radio" name="layoutVariant" value="shop" className="peer hidden" />
                        <div className="p-3 border-2 border-slate-200 dark:border-slate-700 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/20 transition-all text-center group-hover:border-indigo-200">
                            <ShoppingBag className="w-6 h-6 mx-auto mb-2 text-slate-400 peer-checked:text-indigo-600" />
                            <span className="text-xs font-bold block">E-Commerce</span>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        {/* --- SECCIONS DE LA LANDING (Amb State React) --- */}
        <div className="pt-8 border-t border-slate-100 dark:border-slate-800 mt-6">
            <div className="flex items-center justify-between mb-4">
                <label className="text-sm font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2">
                    <LayoutDashboard className="w-4 h-4 text-indigo-500" /> 
                    Blocs de la PÃ gina d'Inici
                </label>
                <span className="text-[10px] uppercase tracking-wider text-slate-400 font-bold bg-slate-100 px-2 py-1 rounded-md">100% Configurable</span>
            </div>
            
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                {SECTIONS_CONFIG.map((sec) => {
                    const isSelected = selectedSections.includes(sec.id);
                    return (
                        <div 
                            key={sec.id} 
                            onClick={() => toggleSection(sec.id, sec.required)}
                            className={`cursor-pointer group relative`}
                        >
                            <motion.div 
                                whileHover={{ scale: 1.05 }}
                                whileTap={{ scale: 0.95 }}
                                className={`
                                    flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all h-24
                                    ${isSelected 
                                        ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/20 dark:text-indigo-300 shadow-sm' 
                                        : 'border-slate-200 bg-white text-slate-500 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-400'}
                                    ${sec.required ? 'opacity-80 cursor-not-allowed' : ''}
                                `}
                            >
                                <sec.icon className="w-6 h-6 mb-2" />
                                <span className="text-[11px] font-bold capitalize text-center leading-tight">{sec.label}</span>
                            </motion.div>

                            {/* Indicador */}
                            {isSelected && (
                                <div className="absolute top-2 right-2 w-2.5 h-2.5 rounded-full bg-indigo-500 shadow-sm" />
                            )}
                        </div>
                    );
                })}
            </div>
        </div>

        {/* MÃ²duls Funcionals (Backend) */}
        <div className="pt-8 border-t border-slate-100 dark:border-slate-800 mt-6">
            <label className="block text-sm font-medium mb-4 text-slate-700 dark:text-slate-300">
                MÃ²duls de GestiÃ³ (Backend)
            </label>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                {MODULES.map((mod) => (
                    <label key={mod.id} className="relative cursor-pointer group">
                        <input type="checkbox" name={`module_${mod.id}`} className="peer hidden" />
                        <motion.div 
                            whileHover={{ y: -2 }}
                            whileTap={{ scale: 0.98 }}
                            className="p-4 border border-slate-200 dark:border-slate-700 rounded-xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/20 transition-all h-full shadow-sm hover:shadow-md bg-white dark:bg-slate-800"
                        >
                            <div className="flex items-start justify-between mb-2">
                                <mod.icon className="w-6 h-6 text-slate-400 peer-checked:text-indigo-600 dark:peer-checked:text-indigo-400" />
                                <div className="w-4 h-4 rounded border border-slate-300 peer-checked:bg-indigo-500 peer-checked:border-indigo-500 transition-colors flex items-center justify-center">
                                    <svg className="w-3 h-3 text-white opacity-0 peer-checked:opacity-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                            </div>
                            <span className="block text-sm font-bold text-slate-800 dark:text-slate-100">{mod.label}</span>
                            <span className="text-xs text-slate-500 leading-tight block mt-1">{mod.desc}</span>
                        </motion.div>
                    </label>
                ))}
            </div>
        </div>
    </FormSection>
  );
}

// =================== FILE: src/features/projects/ui/form/FormSection.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { ReactNode } from 'react';

interface FormSectionProps {
  title: string;
  description?: string;
  icon: ReactNode;
  children: ReactNode;
  delay?: number;
}

export function FormSection({ title, description, icon, children, delay = 0 }: FormSectionProps) {
  return (
    <motion.section 
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5, delay }}
      className="bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm hover:shadow-md transition-shadow"
    >
      <div className="flex items-center gap-3 mb-4 border-b border-slate-100 dark:border-slate-800 pb-4">
        <div className="p-2.5 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-lg">
          {icon}
        </div>
        <div>
          <h3 className="font-bold text-slate-800 dark:text-slate-200">{title}</h3>
          {description && <p className="text-xs text-slate-500">{description}</p>}
        </div>
      </div>
      <div className="space-y-6">
        {children}
      </div>
    </motion.section>
  );
}

// =================== FILE: src/features/projects/ui/form/IdentitySection.tsx ===================

'use client';

import { Github, Globe, Upload, AlertCircle, CheckCircle2, Loader2 } from 'lucide-react';
import { FormSection } from './FormSection';
import { RefObject, useRef, useState } from 'react';
import imageCompression from 'browser-image-compression';

interface Props {
  defaultName?: string;
  defaultSlug?: string;
  slugRef: RefObject<HTMLInputElement | null>;
}

export function IdentitySection({ defaultName, defaultSlug, slugRef }: Props) {
  const [fileStatus, setFileStatus] = useState<'idle' | 'compressing' | 'success' | 'error'>('idle');
  const [fileMessage, setFileMessage] = useState<string>('');
  const [preview, setPreview] = useState<string | null>(null);
  
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const name = e.target.value;
    if (slugRef.current) {
        const currentSlug = slugRef.current.value;
        if (!currentSlug || currentSlug.startsWith('client-')) {
            const generated = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            slugRef.current.value = generated ? `client-${generated}` : '';
        }
    }
  };

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    
    if (!file) {
        setFileStatus('idle');
        setFileMessage('');
        setPreview(null);
        return;
    }

    if (!file.type.startsWith('image/')) {
        setFileStatus('error');
        setFileMessage('NomÃ©s s\'accepten imatges (JPG, PNG, WEBP).');
        e.target.value = ''; 
        return;
    }

    setFileStatus('compressing');
    setFileMessage(`Optimitzant imatge (${(file.size / 1024 / 1024).toFixed(2)} MB)...`);

    try {
        const options = {
            maxSizeMB: 1, 
            maxWidthOrHeight: 1200,
            useWebWorker: true,
            fileType: file.type as string
        };

        const compressedFile = await imageCompression(file, options);

        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(new File([compressedFile], file.name, { type: file.type }));
        if (fileInputRef.current) {
            fileInputRef.current.files = dataTransfer.files;
        }

        setFileStatus('success');
        setFileMessage(`Llest! ReduÃ¯t a ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);
        setPreview(URL.createObjectURL(compressedFile));

    } catch (error) {
        console.error("Error comprimint:", error);
        setFileStatus('error');
        setFileMessage('No s\'ha pogut processar la imatge.');
    }
  };

  return (
    <FormSection 
      title="Identitat Digital" 
      description="Defineix com es dirÃ  el negoci i el seu domini."
      icon={<Globe className="w-5 h-5" />}
      delay={0.1}
    >
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="space-y-2">
            <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Nom del Negoci</label>
            <input 
                name="businessName" 
                required 
                defaultValue={defaultName} 
                onChange={handleNameChange}
                className="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" 
                placeholder="Ex: Restaurant Can Roca" 
            />
        </div>

        <div className="space-y-2">
            <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Identificador (URL)</label>
            <div className="relative group">
                <Github className="absolute left-3 top-3.5 w-4 h-4 text-slate-400 group-focus-within:text-blue-500 transition-colors" />
                <input 
                    name="slug" 
                    required 
                    ref={slugRef}
                    defaultValue={defaultSlug}
                    className="w-full pl-9 p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none" 
                    placeholder="client-nom-negoci" 
                />
            </div>
            <p className="text-[10px] text-slate-400">Es crearÃ  un repo a GitHub amb aquest nom.</p>
        </div>
      </div>

      <div 
        className={`
            relative p-4 border-2 border-dashed rounded-xl transition-all group overflow-hidden
            ${fileStatus === 'error' ? 'border-red-300 bg-red-50' : 
              fileStatus === 'success' ? 'border-green-300 bg-green-50 dark:bg-green-900/10' : 
              'border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50'}
        `}
      >
        <label className="flex items-center gap-4 cursor-pointer relative z-10">
            
            <div className={`
                p-3 rounded-full shrink-0 transition-transform group-hover:scale-105
                ${fileStatus === 'error' ? 'bg-red-100 text-red-500' : 
                  fileStatus === 'success' ? 'bg-green-100 text-green-600' : 
                  fileStatus === 'compressing' ? 'bg-blue-100 text-blue-600' :
                  'bg-blue-100 dark:bg-blue-900/30 text-blue-600'}
            `}>
                {fileStatus === 'compressing' ? <Loader2 className="w-6 h-6 animate-spin" /> :
                 fileStatus === 'success' ? <CheckCircle2 className="w-6 h-6" /> :
                 fileStatus === 'error' ? <AlertCircle className="w-6 h-6" /> :
                 <Upload className="w-6 h-6" />}
            </div>

            <div className="flex-1 min-w-0">
                <span className={`block text-sm font-medium ${fileStatus === 'error' ? 'text-red-600' : 'text-slate-700 dark:text-slate-200'}`}>
                    {fileStatus === 'compressing' ? 'Optimitzant imatge...' :
                     fileStatus === 'success' ? 'Imatge llesta per pujar' :
                     fileStatus === 'error' ? 'Error al fitxer' :
                     'Pujar Logotip'}
                </span>
                
                <span className="text-xs text-slate-500 truncate block">
                    {fileMessage || "Formats: PNG, JPG, WEBP. AutomÃ ticament comprimit."}
                </span>
            </div>

            <input 
                ref={fileInputRef}
                type="file" 
                name="logo" 
                required={!preview} 
                accept="image/png, image/jpeg, image/webp" 
                className="hidden" 
                onChange={handleFileChange}
            />

            {/* ğŸ‘‡ AQUÃ ESTAVA L'ERROR. Usem <img> normal, no <Image> */}
            {preview && (
                <div className="w-12 h-12 rounded-lg border border-slate-200 overflow-hidden shrink-0 relative bg-white">
                    <img 
                        src={preview} 
                        alt="Logo Preview" 
                        className="w-full h-full object-cover" 
                    />
                </div>
            )}
        </label>
      </div>
    </FormSection>
  );
}

// =================== FILE: src/features/projects/ui/form/NewProjectForm.tsx ===================

'use client';

import { useActionState, useRef } from 'react';
import { createProjectAction } from '@/features/projects/actions';
import { ActionResult } from '@/types/actions';
import { Rocket, CheckCircle2, AlertTriangle } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

// Importem els nostres components atÃ²mics
import { IdentitySection } from './IdentitySection';
import { AISection } from './AISection';
import { DesignSection } from './DesignSection';
import { SubmitButton } from './SubmitButton'; // ğŸ‘ˆ El nou botÃ³
import { ContactSection } from './ContactSection';

const initialState: ActionResult = { success: false, error: '', fields: {} };

export function NewProjectForm() {
    const [state, formAction, isPending] = useActionState(createProjectAction, initialState);

    // Ref inicialitzat a null, compatible amb la nova interfÃ­cie de IdentitySection
    const slugRef = useRef<HTMLInputElement>(null);

    return (
        <div className="max-w-3xl mx-auto pb-32"> {/* pb-32 per deixar espai al botÃ³ flotant */}

            {/* Header Visual */}
            <motion.div
                initial={{ opacity: 0, y: -20 }}
                animate={{ opacity: 1, y: 0 }}
                className="text-center mb-10"
            >
                <div className="inline-flex items-center justify-center p-4 bg-slate-900 rounded-2xl shadow-2xl mb-4">
                    <Rocket className="w-8 h-8 text-white" />
                </div>
                <h1 className="text-3xl font-bold text-slate-900 dark:text-white mb-2">Crear Nou Projecte</h1>
                <p className="text-slate-500">Configura la identitat, la IA i l'estructura en uns segons.</p>
            </motion.div>

            <form action={formAction} className="space-y-6">

                {/* PAS 1 */}
                <IdentitySection
                    defaultName={state.fields?.businessName}
                    defaultSlug={state.fields?.slug}
                    slugRef={slugRef}
                />
                {/* ğŸ‘‡ PAS 1.5: CONTACTE (NOU) */}
                <ContactSection />
                {/* PAS 2 */}
                <AISection
                    defaultValue={state.fields?.description}
                />

                {/* PAS 3 */}
                <DesignSection
                    defaultColor={state.fields?.primaryColor}
                />

                {/* BOTÃ“ FLOTANT */}
                <SubmitButton isPending={isPending} />

                {/* FEEDBACK MESSAGES (Alertes) */}
                <AnimatePresence>
                    {state?.error && (
                        <motion.div
                            initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }}
                            className="p-4 bg-red-50 text-red-600 border border-red-200 rounded-xl flex items-center gap-3"
                        >
                            <AlertTriangle className="w-5 h-5 shrink-0" />
                            <div>
                                <p className="font-bold text-sm">Hi ha hagut un error</p>
                                <p className="text-xs">{state.error}</p>
                            </div>
                        </motion.div>
                    )}

                    {state?.success && state.repoUrl && (
                        <motion.div
                            initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }}
                            className="p-6 bg-green-50 text-green-800 border border-green-200 rounded-xl text-center"
                        >
                            <CheckCircle2 className="w-10 h-10 mx-auto mb-2 text-green-600" />
                            <h3 className="text-xl font-bold mb-1">Projecte Enlairat! ğŸ›¸</h3>
                            <p className="mb-4 text-sm opacity-80">El repositori i el desplegament estan en marxa.</p>
                            <a href={state.repoUrl} target="_blank" className="inline-block px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm hover:bg-green-700 transition-colors">
                                Veure Repositori
                            </a>
                        </motion.div>
                    )}
                </AnimatePresence>

            </form>
        </div>
    );
}

// =================== FILE: src/features/projects/ui/form/SubmitButton.tsx ===================

'use client';

import { Loader2, Rocket } from 'lucide-react';
import { motion } from 'framer-motion';

interface Props {
  isPending: boolean;
}

export function SubmitButton({ isPending }: Props) {
  return (
    <div className="mt-8 pt-4"> {/* Marge superior en lloc de posiciÃ³ fixa */}
      <motion.button 
        type="submit" 
        disabled={isPending}
        whileHover={{ scale: 1.01 }}
        whileTap={{ scale: 0.98 }}
        className={`
            w-full py-4 px-8 rounded-xl font-bold text-lg shadow-xl flex items-center justify-center gap-3 transition-all
            ${isPending 
                ? 'bg-slate-100 text-slate-400 cursor-not-allowed' 
                : 'bg-slate-900 text-white dark:bg-white dark:text-slate-900 hover:shadow-2xl hover:shadow-blue-500/20'
            }
        `}
      >
        {isPending ? (
            <>
                <Loader2 className="animate-spin w-5 h-5" /> 
                <span>Processant...</span>
            </>
        ) : (
            <>
                <span>LlanÃ§ar Coet</span>
                <Rocket className="w-5 h-5 fill-current" />
            </>
        )}
      </motion.button>
    </div>
  );
}

// =================== FILE: src/features/projects/ui/InviteClientForm.tsx ===================

'use client';

import { useActionState } from 'react';
// âœ… CANVI CLAU: Importem des de 'invite-actions', no de 'actions'
import { inviteClientAction, InviteState } from '@/features/projects/actions/invite-actions'; 
import { Mail, Send, Loader2 } from 'lucide-react';

const initialState: InviteState = { 
  success: false, 
  error: null, 
  message: null 
};

export function InviteClientForm({ projectId, orgId }: { projectId: string, orgId: string }) {
  const [state, action, isPending] = useActionState(inviteClientAction, initialState);

  // ... (la resta del component es queda IGUAL)
  if (state.success) {
      return (
          <div className="p-4 bg-green-50 border border-green-200 rounded-lg text-green-800 text-center animate-in zoom-in">
              âœ… <strong>{state.message}</strong><br/>
              El client rebrÃ  un correu per activar el seu compte.
          </div>
      );
  }

  return (
    <form action={action} className="flex flex-col gap-3">
        {/* ... inputs iguals ... */}
        <input type="hidden" name="projectId" value={projectId} />
        <input type="hidden" name="orgId" value={orgId} />
        
        <div className="flex gap-2">
            <div className="relative flex-1">
                <Mail className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                <input 
                    name="email" 
                    type="email" 
                    required 
                    placeholder="email@client.com" 
                    className="w-full pl-9 p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                />
            </div>
            <button 
                type="submit" 
                disabled={isPending}
                className="bg-black text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-800 disabled:opacity-50 flex items-center gap-2"
            >
                {isPending ? <Loader2 className="animate-spin w-4 h-4" /> : <><Send className="w-4 h-4" /> Convidar</>}
            </button>
        </div>
        
        {state.error && (
            <p className="text-xs text-red-500 font-medium ml-1">âŒ {state.error}</p>
        )}
    </form>
  );
}

// =================== FILE: src/features/projects/ui/ProjectCampaignsList.tsx ===================

'use client';

import { Link } from '@/routing';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { FlaskConical, Users, ListChecks, ArrowRight, Plus, Folder } from 'lucide-react';

type CampaignSummary = {
    id: string;
    title: string;
    status: string | null;
    testerCount: number;
    taskCount: number;
    createdAt: string | null;
};

export function ProjectCampaignsList({ campaigns, projectId }: { campaigns: CampaignSummary[], projectId: string }) {
    
    return (
        <div className="space-y-6">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <h3 className="text-xl font-bold text-foreground flex items-center gap-2">
                    <div className="p-2 bg-purple-100 dark:bg-purple-900/20 rounded-lg text-purple-600 dark:text-purple-400">
                        <FlaskConical className="w-5 h-5" />
                    </div>
                    Campanyes de Test
                    <span className="ml-2 text-sm font-medium text-muted-foreground bg-muted px-2 py-0.5 rounded-full">
                        {campaigns.length}
                    </span>
                </h3>
                <Link href={`/admin/tests/new?projectId=${projectId}`}>
                    <Button size="sm" className="bg-purple-600 hover:bg-purple-700 text-white shadow-lg shadow-purple-500/20">
                        <Plus className="w-4 h-4 mr-2" /> Nova Campanya
                    </Button>
                </Link>
            </div>

            {campaigns.length === 0 ? (
                <div className="border-2 border-dashed border-border bg-muted/10 rounded-2xl p-12 text-center flex flex-col items-center">
                    <div className="w-12 h-12 bg-muted rounded-full flex items-center justify-center mb-4">
                        <Folder className="w-6 h-6 text-muted-foreground" />
                    </div>
                    <h4 className="text-foreground font-semibold mb-1">Sense proves actives</h4>
                    <p className="text-muted-foreground text-sm mb-6 max-w-sm">
                        Aquest projecte encara no tÃ© cap campanya de QA configurada. ComenÃ§a creant-ne una.
                    </p>
                    <Link href={`/admin/tests/new?projectId=${projectId}`}>
                        <Button variant="outline" className="border-purple-200 text-purple-700 hover:bg-purple-50 dark:border-purple-800 dark:text-purple-300 dark:hover:bg-purple-900/20">
                            Crear primera prova
                        </Button>
                    </Link>
                </div>
            ) : (
                <div className="grid gap-4 md:grid-cols-2">
                    {campaigns.map((camp) => (
                        <Link key={camp.id} href={`/admin/tests/${camp.id}?source=project`} className="block group h-full">
                            <Card className="bg-card border-border hover:border-purple-500/50 dark:hover:border-purple-500/50 hover:shadow-md transition-all duration-300 h-full overflow-hidden relative">
                                {/* DecoraciÃ³ Hover */}
                                <div className="absolute inset-0 bg-linear-to-r from-purple-500/0 via-purple-500/0 to-purple-500/0 group-hover:via-purple-500/5 transition-colors duration-500 pointer-events-none" />
                                
                                <CardHeader className="pb-3 border-b border-border/50 bg-muted/20">
                                    <div className="flex justify-between items-start gap-4">
                                        <CardTitle className="text-base font-bold text-foreground truncate leading-tight">
                                            {camp.title}
                                        </CardTitle>
                                        <StatusBadge status={camp.status || 'unknown'} />
                                    </div>
                                </CardHeader>
                                <CardContent className="pt-4">
                                    <div className="flex items-center gap-6 text-sm">
                                        <div className="flex items-center gap-2 text-muted-foreground group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                                            <Users className="w-4 h-4" />
                                            <span className="font-mono font-bold text-foreground">{camp.testerCount}</span> 
                                            <span className="text-xs">testers</span>
                                        </div>
                                        <div className="flex items-center gap-2 text-muted-foreground group-hover:text-green-600 dark:group-hover:text-green-400 transition-colors">
                                            <ListChecks className="w-4 h-4" />
                                            <span className="font-mono font-bold text-foreground">{camp.taskCount}</span> 
                                            <span className="text-xs">tasques</span>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-5 flex items-center justify-end">
                                        <span className="text-xs font-bold text-purple-600 dark:text-purple-400 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all transform -translate-x-2.5 group-hover:translate-x-0">
                                            Gestionar <ArrowRight className="w-3 h-3" />
                                        </span>
                                    </div>
                                </CardContent>
                            </Card>
                        </Link>
                    ))}
                </div>
            )}
        </div>
    );
}

// ğŸ¨ StatusBadge amb colors Adaptatius (Light/Dark)
function StatusBadge({ status }: { status: string }) {
    const styles: Record<string, string> = {
        active: 'bg-green-100 text-green-700 border-green-200 dark:bg-green-500/10 dark:text-green-400 dark:border-green-500/20',
        draft: 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-500/10 dark:text-yellow-400 dark:border-yellow-500/20',
        completed: 'bg-slate-100 text-slate-600 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700',
        unknown: 'bg-slate-100 text-slate-500 border-slate-200 dark:bg-slate-800 dark:text-slate-500 dark:border-slate-700'
    };
  
    const style = styles[status] || styles.unknown;

    return (
        <span className={`px-2.5 py-0.5 rounded-full text-[10px] uppercase font-bold tracking-wider border ${style}`}>
            {status}
        </span>
    )
}

// =================== FILE: src/features/projects/ui/ProjectCard.tsx ===================

'use client';

import Image from 'next/image';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { ExternalLink, Layers } from 'lucide-react';
import type { Project } from '@/types/models';
import { useTranslations, useLocale } from 'next-intl';

interface Props {
  project: Project;
  index: number;
}

export function ProjectCard({ project, index }: Props) {
  const isReversed = index % 2 !== 0;
  const t = useTranslations('ProjectCard');
  const locale = useLocale();

  const adaptiveSet = project.adaptiveImages
    ? (project.adaptiveImages[locale] || project.adaptiveImages['default'])
    : null;

  return (
    <div className={`flex flex-col lg:flex-row gap-8 md:gap-16 items-start ${isReversed ? 'lg:flex-row-reverse' : ''}`}>
      
      {/* --- COLUMNA VISUAL --- */}
      <motion.div
        initial={{ opacity: 0, y: 30 }}
        whileInView={{ opacity: 1, y: 0 }}
        viewport={{ once: true }}
        transition={{ duration: 0.8 }}
        className="w-full lg:flex-1 relative group"
      >
        {/* Glow */}
        <div className={`absolute inset-0 bg-linear-to-r ${project.color} opacity-20 blur-[60px] group-hover:opacity-30 transition-opacity duration-500 pointer-events-none`}></div>

        {/* Marc Navegador */}
        <div className="relative rounded-xl border border-border bg-card shadow-2xl overflow-hidden transform transition-transform duration-500 group-hover:scale-[1.02] md:group-hover:-translate-y-2">
          
          {/* Header */}
          <div className="h-6 md:h-8 border-b border-border bg-muted/30 flex items-center px-3 gap-1.5 md:gap-2 relative z-20">
            <div className="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full bg-red-500/50"></div>
            <div className="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full bg-yellow-500/50"></div>
            <div className="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full bg-green-500/50"></div>
            <div className="ml-2 md:ml-4 px-2 py-0.5 rounded bg-background/50 text-[8px] md:text-[10px] text-muted-foreground font-mono border border-border w-full max-w-37.5 md:max-w-50 opacity-50 truncate">
              https://{project.id}.com
            </div>
          </div>

          {/* CONTENIDOR HÃBRID:
             - MÃ²bil: w-full h-auto (S'adapta a la imatge, NO TALLA)
             - Desktop (md): md:aspect-video (ForÃ§a format gran panorÃ mic)
          */}
          <div className="relative w-full h-auto md:aspect-video bg-muted/20 overflow-hidden group-hover:shadow-inner transition-all">
            {adaptiveSet ? (
              <>
                {/* LIGHT MODE */}
                <div className="block dark:hidden w-full h-full">
                    <Image
                        src={adaptiveSet.light}
                        alt={`${project.imageAlt} (Light)`}
                        width={1200}
                        height={900}
                        // LA MÃ€GIA DEL CSS:
                        // MÃ²bil: w-full h-auto (es veu tota)
                        // Desktop: h-full object-cover (omple el requadre gran, retalla si cal per omplir)
                        className="w-full h-auto md:h-full md:object-cover md:object-top transition-transform duration-700 group-hover:scale-105"
                        sizes="(max-width: 768px) 100vw, 50vw"
                        placeholder="blur"
                    />
                </div>
                {/* DARK MODE */}
                <div className="hidden dark:block w-full h-full">
                    <Image
                        src={adaptiveSet.dark}
                        alt={`${project.imageAlt} (Dark)`}
                        width={1200}
                        height={900}
                        className="w-full h-auto md:h-full md:object-cover md:object-top transition-transform duration-700 group-hover:scale-105"
                        sizes="(max-width: 768px) 100vw, 50vw"
                        placeholder="blur"
                    />
                </div>
              </>
            ) : project.image ? (
              <Image
                src={project.image}
                alt={project.imageAlt}
                width={1200}
                height={900}
                className="w-full h-auto md:h-full md:object-cover md:object-top transition-transform duration-700 group-hover:scale-105"
                sizes="(max-width: 768px) 100vw, 50vw"
                placeholder="blur"
              />
            ) : (
              <div className="aspect-video flex flex-col items-center justify-center text-muted-foreground/30">
                <Layers className="w-12 h-12 md:w-16 md:h-16 mb-4" />
                <span className="text-xs md:text-sm font-bold uppercase tracking-widest">Captura de {project.title}</span>
              </div>
            )}
          </div>
        </div>
      </motion.div>

      {/* --- COLUMNA TEXT --- */}
      <motion.div
        initial={{ opacity: 0, y: 30 }}
        whileInView={{ opacity: 1, y: 0 }}
        viewport={{ once: true }}
        transition={{ duration: 0.8, delay: 0.2 }}
        className="w-full lg:flex-1 space-y-6 md:space-y-8 py-2"
      >
        <div>
          <div className={`inline-block px-3 py-1 rounded-lg bg-linear-to-r ${project.color} bg-opacity-10 text-[10px] md:text-xs font-bold text-white mb-4 shadow-sm`}>
            {project.tags[0]}
          </div>
          <h2 className="text-3xl md:text-4xl font-bold text-foreground mb-2">{project.title}</h2>
          <p className={`text-lg md:text-xl font-medium bg-linear-to-r ${project.color} bg-clip-text text-transparent`}>
            {t(`${project.id}.tagline`)}
          </p>
        </div>

        <p className="text-base md:text-lg text-muted-foreground leading-relaxed">
          {t(`${project.id}.description`)}
        </p>

        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
          {[0, 1, 2].map((i) => (
            <div key={i} className="flex items-center gap-3 text-sm text-foreground font-medium">
              <div className={`w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-linear-to-r ${project.color}`}></div>
              {t(`${project.id}.stats.${i}`)}
            </div>
          ))}
        </div>

        <div className="flex flex-wrap gap-2 pt-2">
          {project.tags.map((tag) => (
            <span key={tag} className="px-2.5 py-0.5 md:px-3 md:py-1 rounded-full border border-border bg-muted/20 text-[10px] md:text-xs font-medium text-muted-foreground">
              {tag}
            </span>
          ))}
        </div>

        <div className="flex gap-4 pt-4">
          <a href={project.link} target="_blank" rel="noreferrer" className="w-full sm:w-auto">
            <Button className="w-full sm:w-auto gradient-bg text-white border-0 shadow-lg hover:opacity-90 transition-transform hover:-translate-y-1">
              {t('view_web')} <ExternalLink className="ml-2 w-4 h-4" />
            </Button>
          </a>
        </div>
      </motion.div>

    </div>
  );
}

// =================== FILE: src/features/projects/ui/ProjectList.tsx ===================

import { PROJECTS } from '../data/projects-data';
import { ProjectCard } from './ProjectCard';

export function ProjectsList() {
  return (
    <section className="py-10 pb-20 md:pb-32">
      {/* âœ… CORRECCIÃ“: Padding responsiu */}
      <div className="container mx-auto px-6 md:px-10 lg:px-14 space-y-20 md:space-y-32">
         {PROJECTS.map((project, index) => (
            <ProjectCard key={project.id} project={project} index={index} />
         ))}
      </div>
    </section>
  );
}

// =================== FILE: src/features/projects/ui/ProjectsCTA.tsx ===================

'use client';

import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { ArrowRight } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function ProjectsCTA() {
  const t = useTranslations('ProjectsCTA');

  return (
    <section className="py-16 md:py-24 border-t border-border bg-muted/10">
       {/* âœ… CORRECCIÃ“: Padding responsiu */}
       <div className="container mx-auto px-6 md:px-10 lg:px-14 text-center">
          <h2 className="text-2xl md:text-3xl font-bold text-foreground mb-4 md:mb-6">
             {t('title_prefix')} <span className="gradient-text">{t('title_highlight')}</span>{t('title_suffix')}
          </h2>
          <p className="text-sm md:text-base text-muted-foreground mb-8 md:mb-10 max-w-xl mx-auto px-4">
             {t('description')}
          </p>
          <Link href="/#contacte">
             <Button size="lg" className="h-12 md:h-14 px-6 md:px-8 text-base md:text-lg rounded-full gradient-bg text-white hover:opacity-90 shadow-xl w-full sm:w-auto transition-transform hover:scale-105">
                {t('button')} <ArrowRight className="ml-2 w-5 h-5" />
             </Button>
          </Link>
       </div>
    </section>
  );
}

// =================== FILE: src/features/projects/ui/ProjectsHero.tsx ===================

'use client';

import { motion } from 'framer-motion';

import { useTranslations } from 'next-intl';

export function ProjectsHero() {
  const t = useTranslations('ProjectsHero');

  return (
    <section className="pt-32 pb-16 md:pt-48 md:pb-24 relative overflow-hidden">
      {/* Fons decoratiu */}
      <div className="absolute top-0 left-1/2 -translate-x-1/2 w-150 md:w-250 h-75 md:h-125 bg-primary/10 blur-[80px] md:blur-[120px] rounded-full pointer-events-none opacity-50" />
      
      {/* âœ… CORRECCIÃ“: Padding responsiu */}
      <div className="container mx-auto px-6 md:px-10 lg:px-14 text-center relative z-10">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8 }}
        >
  
          <h1 className="text-4xl md:text-6xl lg:text-7xl font-bold mb-6 text-foreground leading-tight">
            {t('title_prefix')} <br className="hidden md:block" />
            <span className="gradient-text">{t('title_highlight')}</span>
          </h1>
          <p className="text-base md:text-xl text-muted-foreground max-w-2xl mx-auto leading-relaxed px-4">
            {t('description')}
          </p>
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/features/projects/ui/ProjectTeamManeger.tsx ===================

'use client';

import { useState } from 'react';
import { ProjectMember } from '@/repositories/supabase/SupabaseProjectRepository'; // Importa el tipus
import { addProjectMemberAction, removeProjectMemberAction } from '../actions/project-actions';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Trash2, UserPlus, Shield } from 'lucide-react';
import { toast } from 'sonner';

type Candidate = {
    id: string;
    email: string;
    full_name: string | null;
};

interface Props {
    projectId: string;
    members: ProjectMember[];
    candidates: Candidate[];
}

export function ProjectTeamManager({ projectId, members, candidates }: Props) {
    const [selectedUserId, setSelectedUserId] = useState<string>('');
    const [isPending, setIsPending] = useState(false);

    const handleAdd = async () => {
        if (!selectedUserId) return;
        setIsPending(true);
        const res = await addProjectMemberAction(projectId, selectedUserId);
        
        if (res.success) {
            toast.success(res.message);
            setSelectedUserId(''); // Reset
        } else {
            toast.error(res.message);
        }
        setIsPending(false);
    };

    const handleRemove = async (userId: string) => {
        if (!confirm("Segur que vols eliminar aquest membre del projecte?")) return;
        setIsPending(true);
        const res = await removeProjectMemberAction(projectId, userId);
        
        if (res.success) toast.success(res.message);
        else toast.error(res.message);
        setIsPending(false);
    };

    return (
        <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 shadow-sm h-full flex flex-col">
            <h3 className="text-lg font-bold mb-6 flex items-center gap-2 text-slate-900 dark:text-white">
                <Shield className="w-5 h-5 text-blue-500" /> Equip del Projecte
            </h3>

            {/* AFEGIR MEMBRE */}
            <div className="flex gap-2 mb-6">
                <Select value={selectedUserId} onValueChange={setSelectedUserId}>
                    <SelectTrigger className="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700">
                        <SelectValue placeholder="Seleccionar usuari..." />
                    </SelectTrigger>
                    <SelectContent>
                        {candidates.length === 0 ? (
                            <SelectItem value="none" disabled>No hi ha mÃ©s candidats</SelectItem>
                        ) : (
                            candidates.map(c => (
                                <SelectItem key={c.id} value={c.id}>
                                    {c.full_name || 'Sense nom'} ({c.email})
                                </SelectItem>
                            ))
                        )}
                    </SelectContent>
                </Select>
                <Button onClick={handleAdd} disabled={isPending || !selectedUserId} className="bg-blue-600 text-white">
                    <UserPlus className="w-4 h-4" />
                </Button>
            </div>

            {/* LLISTA DE MEMBRES */}
            <div className="space-y-3 flex-1 overflow-y-auto max-h-[300px] pr-1">
                {members.map((m) => (
                    <div key={m.user_id} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-700 group">
                        <div className="flex items-center gap-3">
                            <Avatar className="h-9 w-9 border border-slate-200 dark:border-slate-700">
                                <AvatarImage src={m.profile.avatar_url || ''} />
                                <AvatarFallback>{m.profile.email[0].toUpperCase()}</AvatarFallback>
                            </Avatar>
                            <div>
                                <p className="text-sm font-bold text-slate-900 dark:text-slate-200">
                                    {m.profile.full_name || 'Usuari'}
                                </p>
                                <p className="text-xs text-slate-500">{m.profile.email}</p>
                            </div>
                        </div>
                        
                        <Button 
                            variant="ghost" 
                            size="icon" 
                            onClick={() => handleRemove(m.user_id)}
                            disabled={isPending}
                            className="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 transition-opacity"
                        >
                            <Trash2 className="w-4 h-4" />
                        </Button>
                    </div>
                ))}

                {members.length === 0 && (
                    <div className="text-center py-8 text-slate-400 text-sm italic">
                        No hi ha ningÃº vinculat. Afegeix el primer membre.
                    </div>
                )}
            </div>
        </div>
    );
}

// =================== FILE: src/features/tests/actions/admin-actions.ts ===================

'use server';

import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { requireAdmin } from '@/lib/auth/admin-guard'; // La teva funciÃ³ de seguretat
import { revalidatePath } from 'next/cache';
import { redirect } from 'next/navigation';
import { postService } from '@/services/container'; // Soluciona "No se encuentra postService"
  
const repo = new SupabaseTestRepository();
// 1. Definim el tipus d'estat (State)
export type ActionState = {
  success: boolean;
  message: string;
};
export async function addTesterAction(campaignId: string, userId: string) {
  await requireAdmin(); // ğŸ›¡ï¸ Seguretat crÃ­tica

  const { error } = await repo.assignTester(campaignId, userId);

  if (error) {
    // Codi d'error de Postgres per duplicats (si ja estava assignat)
    if (error.code === '23505') return { success: false, message: 'Aquest usuari ja estÃ  assignat.' };
    return { success: false, message: error.message };
  }

  revalidatePath('/admin/tests/[id]', 'page');
  return { success: true, message: 'Tester assignat correctament.' };
}

export async function removeTesterAction(campaignId: string, userId: string) {
  await requireAdmin();

  const { error } = await repo.removeTester(campaignId, userId);
  if (error) return { success: false, message: error.message };

  revalidatePath('/admin/tests/[id]', 'page');
  return { success: true, message: 'Tester eliminat.' };
}


// 2. Apliquem el tipus a 'prevState' i al retorn
export async function createCampaignAction(
  prevState: ActionState,
  formData: FormData
): Promise<ActionState> {

  await requireAdmin();

  const projectId = formData.get('projectId') as string;
  const title = formData.get('title') as string;
  const description = formData.get('description') as string;
  const instructions = formData.get('instructions') as string;

  if (!projectId || !title) {
    return { success: false, message: 'Falten camps obligatoris' };
  }

  try {
    const { data, error } = await repo.createCampaign({
      projectId, title, description, instructions
    });

    if (error) {
      return { success: false, message: error.message };
    }

    // Si tot va bÃ©, redirigim (aixÃ² interromp l'execuciÃ³, Ã©s normal)
    redirect(`/admin/tests/${data.id}`);

  } catch (error) {
    // Si l'error Ã©s la redirecciÃ³ de Next.js, la deixem passar
    if ((error as Error).message === 'NEXT_REDIRECT') {
      throw error;
    }
    return { success: false, message: 'Error creant la campanya' };
  }
}

export async function updatePostDetailsAction(prevState: ActionState, formData: FormData): Promise<ActionState> {
  await requireAdmin();

  const slug = formData.get('slug') as string;
  const title = formData.get('title') as string;
  const description = formData.get('description') as string;
  const date = formData.get('date') as string;

  // âœ… RECUPEREM EL CONTINGUT (AixÃ² faltava o fallava)
  const content = formData.get('content') as string;

  // âœ… RECUPEREM EL CHECKBOX (Si estÃ  marcat envia 'on', si no null)
  const reviewed = formData.get('reviewed') === 'on';

  try {
    await postService.updatePost(slug, {
      title,
      description,
      content, // ğŸ‘ˆ Passem el contingut
      reviewed, // ğŸ‘ˆ Passem l'estat revisat
      date: date ? new Date(date).toISOString() : undefined,
    });

    revalidatePath('/admin/blog');

    // Opcional: Si vols que es quedi a la pÃ gina d'ediciÃ³ per seguir escrivint,
    // comenta la lÃ­nia del redirect o fes un revalidatePath de la pÃ gina actual.
    // redirect({ href: '/admin/blog', locale }); 

    return { success: true, message: 'Canvis guardats correctament.' };
  } catch (e) {
    if ((e as Error).message === 'NEXT_REDIRECT') throw e;
    console.error(e);
    return { success: false, message: 'Error guardant els canvis.' };
  }
}
// ... imports existents

export async function updateCampaignAction(
  prevState: ActionState, 
  formData: FormData
): Promise<ActionState> {
  await requireAdmin();

  const id = formData.get('id') as string;
  if (!id) return { success: false, message: "Falta l'ID de la campanya" };

  // âœ… CORRECCIÃ“: Definim el tipus exacte en lloc de 'any'
  // AixÃ² diu: "updates Ã©s un objecte on les claus sÃ³n strings opcionals"
  const updates: {
    title?: string;
    description?: string;
    status?: string;
    instructions?: string;
  } = {};
  
  // Ara TypeScript estÃ  content perquÃ¨ sap quÃ¨ esperar
  if (formData.has('title')) updates.title = formData.get('title') as string;
  if (formData.has('description')) updates.description = formData.get('description') as string;
  if (formData.has('status')) updates.status = formData.get('status') as string;
  if (formData.has('instructions')) updates.instructions = formData.get('instructions') as string;

  const { error } = await repo.updateCampaign(id, updates);

  if (error) return { success: false, message: error.message };

  revalidatePath(`/admin/tests/${id}`);
  return { success: true, message: 'Guardat correctament!' };
}

export async function deleteCampaignAction(campaignId: string, projectId: string) {
  await requireAdmin();

  const { error } = await repo.deleteCampaign(campaignId);

  if (error) {
    // Si falla, no podem fer gaire cosa mÃ©s que llenÃ§ar error o retornar-lo
    throw new Error(error.message);
  }

  // Refresquem la pÃ gina del projecte perquÃ¨ desaparegui de la llista
  revalidatePath(`/admin/projects/${projectId}`);
  
  // Redirigim a la fitxa del projecte
  redirect(`/admin/projects/${projectId}`);
}

// =================== FILE: src/features/tests/actions/task-actions.ts ===================

// fitxer: src/features/tests/actions/task-actions.ts

'use server';

import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { requireAdmin } from '@/lib/auth/admin-guard';
import { revalidatePath } from 'next/cache';
import { z } from 'zod';

const repo = new SupabaseTestRepository();

// 1. Definim el tipus per a l'estat de l'acciÃ³
export type TaskActionState = {
  success: boolean;
  message: string;
};

// ValidaciÃ³ Zod
const TaskSchema = z.object({
  campaignId: z.string().uuid(),
  title: z.string().min(3, "El tÃ­tol Ã©s massa curt"),
  description: z.string().optional(),
});

// 2. Tipem 'prevState' correctament
export async function addTaskAction(prevState: TaskActionState, formData: FormData): Promise<TaskActionState> {
  await requireAdmin();

  const rawData = {
    campaignId: formData.get('campaignId'),
    title: formData.get('title'),
    description: formData.get('description'),
  };

  const validated = TaskSchema.safeParse(rawData);

  if (!validated.success) {
    // 3. CORRECCIÃ“ ZOD: Usem .issues[0] per assegurar el tipatge correcte
    return { success: false, message: validated.error.issues[0].message };
  }

  const { error } = await repo.createTask({
      campaignId: validated.data.campaignId as string,
      title: validated.data.title as string,
      description: validated.data.description as string,
      orderIndex: 999 
  });

  if (error) return { success: false, message: error.message };

  revalidatePath(`/admin/tests/${rawData.campaignId}`);
  return { success: true, message: 'Tasca afegida correctament' };
}

export async function deleteTaskAction(taskId: string, campaignId: string): Promise<TaskActionState> {
    await requireAdmin();
    const { error } = await repo.deleteTask(taskId);
    if(error) return { success: false, message: error.message };
    
    revalidatePath(`/admin/tests/${campaignId}`);
    return { success: true, message: 'Tasca eliminada' };
}

// =================== FILE: src/features/tests/actions.ts ===================

'use server';

import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';

const repo = new SupabaseTestRepository();

export async function submitTestFeedback(taskId: string, status: 'pass' | 'fail' | 'blocked', comment: string) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) return { success: false, message: 'No autenticat' };

  const { error } = await repo.saveResult(user.id, taskId, status, comment);

  if (error) return { success: false, message: error.message };
  
  // Refresquem el dashboard per veure el canvi d'estat
  revalidatePath('/dashboard/projects/[id]', 'page'); 
  return { success: true };
}

// =================== FILE: src/features/tests/ui/CampaignAnalytics.tsx ===================

'use client';

import { Card, CardContent } from '@/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Progress } from '@/components/ui/progress';
import { CheckCircle2, XCircle, AlertTriangle, MessageSquare, Activity } from 'lucide-react';

type TestResult = {
    id: string;
    status: 'pass' | 'fail' | 'blocked';
    comment?: string | null;
    updated_at: string;
    taskTitle: string;
    user_id: string;
    tester: {
        id?: string;
        full_name: string | null;
        email: string;
        avatar_url: string | null;
    };
};

type AnalyticsData = {
    results: TestResult[];
    totalTasks: number;
};

type UserStat = {
    user: TestResult['tester'];
    completed: number;
    passed: number;
    failed: number;
};

export function CampaignAnalytics({ data }: { data: AnalyticsData }) {
    const { results, totalTasks } = data;

    // 1. CÃ lculs KPI Globals
    const totalExecutions = results.length;
    const passed = results.filter(r => r.status === 'pass').length;
    const failed = results.filter(r => r.status === 'fail').length;
    
    const successRate = totalExecutions > 0 ? Math.round((passed / totalExecutions) * 100) : 0;

    // 2. Agrupar per Usuari (Leaderboard)
    const userStats = new Map<string, UserStat>();
    
    results.forEach(r => {
        if (!userStats.has(r.user_id)) {
            userStats.set(r.user_id, { 
                user: r.tester, 
                completed: 0, 
                passed: 0, 
                failed: 0 
            });
        }
        const stats = userStats.get(r.user_id)!;
        stats.completed++;
        if (r.status === 'pass') stats.passed++;
        if (r.status === 'fail') stats.failed++;
    });

    const leaderboard = Array.from(userStats.values());

    // 3. Filtrar IncidÃ¨ncies
    const issues = results.filter(r => r.status === 'fail' || r.status === 'blocked' || r.comment);

    return (
        <div className="space-y-8">
            
            {/* KPI CARDS */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <Card className="bg-card border-border text-card-foreground shadow-sm">
                    <CardContent className="p-6">
                        <div className="text-muted-foreground text-xs uppercase font-bold mb-1">Total Validacions</div>
                        <div className="text-3xl font-bold text-foreground">{totalExecutions}</div>
                    </CardContent>
                </Card>
                <Card className="bg-card border-border text-card-foreground shadow-sm">
                    <CardContent className="p-6">
                        <div className="text-muted-foreground text-xs uppercase font-bold mb-1">Taxa d'Ãˆxit</div>
                        <div className={`text-3xl font-bold ${successRate > 80 ? 'text-green-600 dark:text-green-400' : 'text-yellow-600 dark:text-yellow-400'}`}>
                            {successRate}%
                        </div>
                    </CardContent>
                </Card>
                <Card className="bg-red-50 dark:bg-red-900/10 border-red-200 dark:border-red-900/20 shadow-sm">
                    <CardContent className="p-6">
                        <div className="text-red-600 dark:text-red-400 text-xs uppercase font-bold mb-1">Errors CrÃ­tics</div>
                        <div className="text-3xl font-bold text-red-700 dark:text-red-500">{failed}</div>
                    </CardContent>
                </Card>
                <Card className="bg-card border-border text-card-foreground shadow-sm">
                    <CardContent className="p-6">
                        <div className="text-muted-foreground text-xs uppercase font-bold mb-1">Testers Actius</div>
                        <div className="text-3xl font-bold text-blue-600 dark:text-blue-400">{leaderboard.length}</div>
                    </CardContent>
                </Card>
            </div>

            <div className="grid lg:grid-cols-3 gap-8">
                
                {/* FEEDBACK & INCIDÃˆNCIES */}
                <div className="lg:col-span-2 space-y-4">
                    <h3 className="font-bold text-foreground flex items-center gap-2">
                        <MessageSquare className="w-5 h-5 text-orange-500" />
                        Feedback i IncidÃ¨ncies Recents
                    </h3>
                    
                    {issues.length === 0 ? (
                        <div className="p-8 border border-dashed border-border rounded-xl text-center text-muted-foreground bg-muted/20">
                            Tot net! No hi ha comentaris ni errors reportats.
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {issues.map((issue) => (
                                <div key={issue.id} className="bg-card border border-border p-4 rounded-xl flex gap-4 items-start shadow-sm">
                                    <div className="mt-1 shrink-0">
                                        {issue.status === 'fail' && <XCircle className="w-5 h-5 text-red-500" />}
                                        {issue.status === 'blocked' && <AlertTriangle className="w-5 h-5 text-orange-500" />}
                                        {issue.status === 'pass' && <CheckCircle2 className="w-5 h-5 text-green-500" />}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between items-start mb-1">
                                            <h4 className="font-bold text-foreground text-sm truncate pr-2">{issue.taskTitle}</h4>
                                            <span className="text-xs text-muted-foreground whitespace-nowrap">
                                                {new Date(issue.updated_at).toLocaleDateString()}
                                            </span>
                                        </div>
                                        {issue.comment && (
                                            <p className="text-sm text-foreground bg-muted p-3 rounded-lg mb-3 leading-relaxed">
                                                "{issue.comment}"
                                            </p>
                                        )}
                                        <div className="flex items-center gap-2">
                                            <Avatar className="w-5 h-5">
                                                <AvatarImage src={issue.tester.avatar_url || ''} />
                                                <AvatarFallback className="text-[9px]">{issue.tester.email[0].toUpperCase()}</AvatarFallback>
                                            </Avatar>
                                            <span className="text-xs text-muted-foreground truncate">{issue.tester.full_name || issue.tester.email}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* LEADERBOARD */}
                <div className="space-y-4">
                    <h3 className="font-bold text-foreground flex items-center gap-2">
                        <Activity className="w-5 h-5 text-blue-500" />
                        ProgrÃ©s de l'Equip
                    </h3>
                    
                    <div className="bg-card border border-border rounded-xl p-4 space-y-6 shadow-sm">
                        {leaderboard.length === 0 ? (
                            <p className="text-sm text-muted-foreground text-center">Encara ningÃº ha comenÃ§at.</p>
                        ) : (
                            leaderboard.map((stat, index) => {
                                const progress = totalTasks > 0 ? Math.round((stat.completed / totalTasks) * 100) : 0;
                                return (
                                    <div key={`${stat.user.email}-${index}`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <div className="flex items-center gap-2 min-w-0">
                                                <Avatar className="w-6 h-6">
                                                    <AvatarImage src={stat.user.avatar_url || ''} />
                                                    <AvatarFallback className="text-[10px]">{stat.user.email[0].toUpperCase()}</AvatarFallback>
                                                </Avatar>
                                                <span className="text-sm font-medium text-foreground truncate max-w-[100px]">
                                                    {stat.user.full_name || 'Usuari'}
                                                </span>
                                            </div>
                                            <span className="text-xs font-bold text-foreground">{progress}%</span>
                                        </div>
                                        <Progress value={progress} className="h-1.5" />
                                        <div className="flex gap-2 mt-1 justify-end font-mono">
                                            <span className="text-[10px] text-green-600 dark:text-green-400">{stat.passed} OK</span>
                                            <span className="text-[10px] text-red-600 dark:text-red-400">{stat.failed} KO</span>
                                        </div>
                                    </div>
                                )
                            })
                        )}
                    </div>
                </div>

            </div>
        </div>
    );
}

// =================== FILE: src/features/tests/ui/CampaignDetailsForm.tsx ===================

'use client';

import { useActionState, useEffect } from 'react';
import { TestCampaignDTO } from '@/types/models';
import { updateCampaignAction, ActionState } from '@/features/tests/actions/admin-actions';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Save, Loader2 } from 'lucide-react';
import { toast } from 'sonner';

const initialState: ActionState = { success: false, message: '' };

export function CampaignDetailsForm({ campaign }: { campaign: TestCampaignDTO }) {
    const [stateGeneral, actionGeneral, isPendingGeneral] = useActionState(updateCampaignAction, initialState);
    const [stateDocs, actionDocs, isPendingDocs] = useActionState(updateCampaignAction, initialState);

    useEffect(() => {
        if (stateGeneral.success) toast.success(stateGeneral.message);
        else if (stateGeneral.message) toast.error(stateGeneral.message);
    }, [stateGeneral]);

    useEffect(() => {
        if (stateDocs.success) toast.success(stateDocs.message);
        else if (stateDocs.message) toast.error(stateDocs.message);
    }, [stateDocs]);

    return (
        <div className="grid lg:grid-cols-2 gap-8">
            
            {/* --- CONFIGURACIÃ“ GENERAL --- */}
            <Card className="bg-card border-border shadow-sm">
                <CardContent className="p-6">
                    <form action={actionGeneral} className="space-y-4">
                        <input type="hidden" name="id" value={campaign.id} />
                        
                        <h3 className="text-lg font-bold text-foreground mb-4">ConfiguraciÃ³ General</h3>
                        
                        <div className="space-y-2">
                            <label className="text-sm font-medium text-foreground">TÃ­tol de la Campanya</label>
                            <Input 
                                name="title"
                                defaultValue={campaign.title} 
                                className="bg-background border-input text-foreground" 
                            />
                        </div>
                        
                        <div className="space-y-2">
                            <label className="text-sm font-medium text-foreground">Estat</label>
                            <select 
                                name="status"
                                className="w-full h-10 px-3 py-2 rounded-md border border-input bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                                defaultValue={campaign.status}
                            >
                                <option value="active">Activa (Visible)</option>
                                <option value="draft">Esborrany (Oculta)</option>
                                <option value="completed">Tancada</option>
                            </select>
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-medium text-foreground">DescripciÃ³ Curta</label>
                            <Input 
                                name="description"
                                defaultValue={campaign.description || ''} 
                                className="bg-background border-input text-foreground" 
                            />
                        </div>

                        <Button disabled={isPendingGeneral} className="w-full mt-4">
                            {isPendingGeneral ? <Loader2 className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4 mr-2" />}
                            Guardar ConfiguraciÃ³
                        </Button>
                    </form>
                </CardContent>
            </Card>

            {/* --- DOCUMENTACIÃ“ --- */}
            <Card className="bg-card border-border shadow-sm flex flex-col">
                <CardContent className="p-6 flex-1 flex flex-col h-full">
                    <form action={actionDocs} className="contents">
                        <input type="hidden" name="id" value={campaign.id} />

                        <div className="mb-2">
                            <h3 className="text-lg font-bold text-foreground">DocumentaciÃ³ per al Tester</h3>
                            <p className="text-xs text-muted-foreground mt-1">
                                Aquest text apareixerÃ  a la part esquerra de la pantalla del tester.
                            </p>
                        </div>
                        
                        <Textarea 
                            name="instructions"
                            className="bg-background border-input text-foreground font-mono text-sm flex-1 min-h-[300px] resize-none leading-relaxed p-4 mb-4" 
                            defaultValue={campaign.instructions || ''}
                            placeholder="# Guia de Proves..."
                        />
                        
                        <Button disabled={isPendingDocs} className="w-full bg-blue-600 hover:bg-blue-700 text-white">
                            {isPendingDocs ? <Loader2 className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4 mr-2" />}
                            Guardar DocumentaciÃ³
                        </Button>
                    </form>
                </CardContent>
            </Card>
        </div>
    )
}

// =================== FILE: src/features/tests/ui/CreateCampaignForm.tsx ===================

'use client';

import { useActionState } from 'react';
import { createCampaignAction, ActionState } from '@/features/tests/actions/admin-actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Save, Loader2, AlertCircle } from 'lucide-react';

const initialState: ActionState = {
  success: false,
  message: '',
};

type ProjectSummary = {
    id: string;
    name: string;
};

export function CreateCampaignForm({ projects }: { projects: ProjectSummary[] }) {
  const [state, action, isPending] = useActionState(createCampaignAction, initialState);

  return (
    <form action={action} className="space-y-6">
        
        <div className="space-y-2">
            <label className="text-sm font-medium text-foreground">Projecte</label>
            <select name="projectId" required className="w-full p-3 rounded-lg bg-background border border-input text-foreground focus:ring-2 focus:ring-ring outline-none">
                <option value="">Selecciona...</option>
                {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
            </select>
        </div>
        <div className="space-y-2">
            <label className="text-sm font-medium text-foreground">TÃ­tol</label>
            <Input name="title" required className="bg-background border-input text-foreground" />
        </div>
        <div className="space-y-2">
            <label className="text-sm font-medium text-foreground">DescripciÃ³</label>
            <Input name="description" className="bg-background border-input text-foreground" />
        </div>
        <div className="space-y-2">
            <label className="text-sm font-medium text-foreground">Instruccions Inicials</label>
            <textarea name="instructions" rows={4} className="w-full p-3 rounded-lg bg-background border border-input text-foreground focus:ring-2 focus:ring-ring outline-none" />
        </div>
        
        {state.message && !state.success && (
            <div className="text-red-500 text-sm flex gap-2 font-medium bg-red-50 dark:bg-red-900/10 p-2 rounded">
                <AlertCircle className="w-4 h-4"/> {state.message}
            </div>
        )}

        <Button type="submit" disabled={isPending} className="w-full">
            {isPending ? <Loader2 className="animate-spin" /> : <><Save className="w-4 h-4 mr-2" /> Crear</>}
        </Button>
    </form>
  );
}

// =================== FILE: src/features/tests/ui/DeleteCampaignButton.tsx ===================

'use client';

import { useState } from 'react';
import { deleteCampaignAction } from '@/features/tests/actions/admin-actions';
import { Button } from '@/components/ui/button';
import { Trash2, Loader2 } from 'lucide-react';
import { toast } from 'sonner';

interface Props {
  campaignId: string;
  projectId: string;
}

export function DeleteCampaignButton({ campaignId, projectId }: Props) {
  const [isDeleting, setIsDeleting] = useState(false);

  const handleDelete = async () => {
    if (!confirm("âš ï¸ ATENCIÃ“: EstÃ s segur que vols eliminar aquesta campanya?\n\nS'esborraran totes les tasques, resultats i assignacions de forma permanent.")) {
      return;
    }

    setIsDeleting(true);
    try {
      await deleteCampaignAction(campaignId, projectId);
      toast.success("Campanya eliminada");
    } catch (error) {
      console.error(error);
      toast.error("Error eliminant la campanya");
      setIsDeleting(false);
    }
  };

  return (
    <Button 
      variant="destructive" 
      size="sm" 
      onClick={handleDelete} 
      disabled={isDeleting}
      className="bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 dark:bg-red-900/10 dark:text-red-400 dark:border-red-900/50 dark:hover:bg-red-900/30 transition-colors"
    >
      {isDeleting ? <Loader2 className="w-4 h-4 animate-spin" /> : <Trash2 className="w-4 h-4 mr-2" />}
      Eliminar Test
    </Button>
  );
}

// =================== FILE: src/features/tests/ui/MissionCard.tsx ===================

'use client';

import { Link } from '@/routing';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { ArrowRight, CheckCircle2, XCircle, Zap } from 'lucide-react';
// ğŸ‘‡ Importem el tipus correcte
import type { MissionStats } from '@/services/GamificationService';

interface Props {
    id: string; 
    projectId: string;
    title: string;
    description: string | null;
    stats: MissionStats; // Ara sÃ­ que coincidirÃ  amb el que retorna el servei
}

export function MissionCard({ id, projectId, title, description, stats }: Props) {
    // Determinem el color de la vora segons l'estat
    let borderClass = "hover:border-purple-500/50";
    if (stats.failed > 0) borderClass = "border-red-500/30 hover:border-red-500";
    else if (stats.progress === 100) borderClass = "border-green-500/50 hover:border-green-500";

    return (
        <Link href={`/dashboard/projects/${projectId}/${id}`} className="group block h-full">
            <Card className={`h-full transition-all duration-300 hover:shadow-xl hover:-translate-y-1 bg-white dark:bg-slate-900 border ${borderClass}`}>
                <CardHeader className="pb-3">
                    <div className="flex justify-between items-start mb-2">
                        <Badge variant="outline" className="bg-purple-500/10 text-purple-500 border-purple-500/20 font-mono text-[10px]">
                            {stats.xpReward} XP
                        </Badge>
                        {stats.progress === 100 && (
                            <Badge className="bg-green-500 text-white hover:bg-green-600">COMPLETAT</Badge>
                        )}
                    </div>
                    <CardTitle className="text-lg font-bold group-hover:text-purple-400 transition-colors line-clamp-1 text-foreground">
                        {title}
                    </CardTitle>
                </CardHeader>
                
                <CardContent>
                    <p className="text-sm text-muted-foreground line-clamp-2 mb-6 h-10">
                        {description || "Sense descripciÃ³ disponible..."}
                    </p>

                    {/* BARRA DE PROGRÃ‰S */}
                    <div className="mb-4">
                        <div className="flex justify-between text-xs font-bold mb-1.5">
                            <span className="text-muted-foreground">ProgrÃ©s</span>
                            <span className={stats.progress === 100 ? "text-green-500" : "text-foreground"}>{stats.progress}%</span>
                        </div>
                        <Progress value={stats.progress} className="h-2 bg-slate-100 dark:bg-slate-800" />
                    </div>

                    {/* GRID D'ESTADÃSTIQUES */}
                    <div className="grid grid-cols-3 gap-2 py-3 border-t border-border">
                        <div className="flex flex-col items-center p-2 rounded bg-green-500/5 border border-green-500/10">
                            <CheckCircle2 className="w-4 h-4 text-green-500 mb-1" />
                            <span className="text-xs font-bold text-green-600 dark:text-green-400">{stats.passed}</span>
                            <span className="text-[10px] text-muted-foreground uppercase">Fets</span>
                        </div>
                        <div className="flex flex-col items-center p-2 rounded bg-red-500/5 border border-red-500/10">
                            <XCircle className="w-4 h-4 text-red-500 mb-1" />
                            <span className="text-xs font-bold text-red-600 dark:text-red-400">{stats.failed}</span>
                            <span className="text-[10px] text-muted-foreground uppercase">Errors</span>
                        </div>
                        <div className="flex flex-col items-center p-2 rounded bg-muted border border-border">
                            <Zap className="w-4 h-4 text-yellow-500 mb-1" />
                            <span className="text-xs font-bold text-foreground">{stats.pending}</span>
                            <span className="text-[10px] text-muted-foreground uppercase">Queden</span>
                        </div>
                    </div>

                    <div className="mt-4 flex items-center justify-end text-xs font-bold text-purple-600 dark:text-purple-400 group-hover:text-purple-500 transition-colors">
                        Continuar MissiÃ³ <ArrowRight className="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" />
                    </div>
                </CardContent>
            </Card>
        </Link>
    );
}

// =================== FILE: src/features/tests/ui/TaskManager.tsx ===================

// fitxer: src/features/tests/ui/TaskManager.tsx

'use client';

import { useActionState, useRef } from 'react';
import { TestTaskDTO } from '@/types/models';
// Importem el tipus que hem definit abans
import { addTaskAction, deleteTaskAction, TaskActionState } from '../actions/task-actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
// 1. CORRECCIÃ“: Eliminem CardContent que no es feia servir
import { Plus, Trash2, ListChecks } from 'lucide-react';
import { toast } from 'sonner';

const initialState: TaskActionState = { success: false, message: '' };

export function TaskManager({ campaignId, tasks }: { campaignId: string, tasks: TestTaskDTO[] }) {
    const formRef = useRef<HTMLFormElement>(null);

    // 2. CORRECCIÃ“: Tipem 'prev' i usem '_' per 'state' si no el pintem a la UI
    // (O millor, fem servir state.message si volem mostrar errors en text vermell)
    // De moment, per treure l'error de "unused", el renomenem a "_state"
    const [_state, action, isPending] = useActionState(async (prev: TaskActionState, formData: FormData) => {
        const result = await addTaskAction(prev, formData);
        if (result.success) {
            formRef.current?.reset();
            toast.success("Tasca afegida!");
        } else {
            toast.error(result.message);
        }
        return result;
    }, initialState);

    const handleDelete = async (taskId: string) => {
        if(!confirm("Segur que vols esborrar aquesta tasca?")) return;
        const res = await deleteTaskAction(taskId, campaignId);
        if(res.success) toast.success("Esborrada");
        else toast.error(res.message);
    }

    return (
        <div className="grid lg:grid-cols-3 gap-8">
            
            {/* COLUMNA 1: LLISTAT DE TASQUES EXISTENTS */}
            <div className="lg:col-span-2 space-y-4">
                <h3 className="text-lg font-bold text-white flex items-center gap-2">
                    <ListChecks className="w-5 h-5 text-blue-500" /> 
                    Llista de VerificaciÃ³ ({tasks.length})
                </h3>
                
                {tasks.length === 0 && (
                    <div className="p-8 border-2 border-dashed border-slate-800 rounded-xl text-center text-slate-500">
                        No hi ha tasques definides. Afegeix la primera a la dreta ğŸ‘‰
                    </div>
                )}

                <div className="space-y-2">
                    {tasks.map((task, index) => (
                        <div key={task.id} className="bg-slate-900 border border-slate-800 p-4 rounded-lg flex items-start justify-between group hover:border-slate-700 transition-colors">
                            <div className="flex gap-3">
                                <span className="bg-slate-800 text-slate-400 w-6 h-6 flex items-center justify-center rounded text-xs font-mono mt-0.5">
                                    {index + 1}
                                </span>
                                <div>
                                    <p className="font-medium text-slate-200">{task.title}</p>
                                    {task.description && (
                                        <p className="text-sm text-slate-500 mt-1">{task.description}</p>
                                    )}
                                </div>
                            </div>
                            <Button 
                                size="icon" 
                                variant="ghost" 
                                className="text-slate-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                onClick={() => handleDelete(task.id)}
                            >
                                <Trash2 className="w-4 h-4" />
                            </Button>
                        </div>
                    ))}
                </div>
            </div>

            {/* COLUMNA 2: FORMULARI PER AFEGIR (Sticky) */}
            <div className="lg:col-span-1">
                <div className="bg-slate-900 border border-slate-800 p-6 rounded-xl sticky top-6">
                    <h3 className="font-bold text-white mb-4">Nova Tasca</h3>
                    <form ref={formRef} action={action} className="space-y-4">
                        <input type="hidden" name="campaignId" value={campaignId} />
                        
                        <div>
                            <label className="text-xs text-slate-400 uppercase font-bold">TÃ­tol (AcciÃ³)</label>
                            <Input 
                                name="title" 
                                placeholder="Ex: Verificar registre..." 
                                className="bg-black border-slate-700 text-white mt-1" 
                                required
                            />
                        </div>

                        <div>
                            <label className="text-xs text-slate-400 uppercase font-bold">Detalls (Opcional)</label>
                            <Textarea 
                                name="description" 
                                placeholder="Ex: L'usuari hauria de rebre un correu..." 
                                className="bg-black border-slate-700 text-white mt-1 resize-none" 
                                rows={3}
                            />
                        </div>

                        <Button type="submit" disabled={isPending} className="w-full bg-blue-600 hover:bg-blue-700 text-white">
                            <Plus className="w-4 h-4 mr-2" /> Afegir a la Llista
                        </Button>
                    </form>
                </div>
            </div>

        </div>
    );
}

// =================== FILE: src/features/tests/ui/TaskRunner.tsx ===================

'use client';

import { useState } from 'react';
import { TestTaskDTO, TestResultDTO } from '@/types/models';
import { CheckCircle, XCircle, AlertTriangle, ChevronDown, ChevronUp } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { submitTestFeedback } from '../actions';

// Simple toast casolÃ  o usa 'sonner'/'react-hot-toast' si en tens
const notify = (msg: string) => alert(msg); 

export function TaskRunner({ task, existingResult }: { task: TestTaskDTO, existingResult?: TestResultDTO }) {
  const [isOpen, setIsOpen] = useState(!existingResult); 
  const [status, setStatus] = useState<string | null>(existingResult?.status || null);
  const [comment, setComment] = useState(existingResult?.comment || '');
  const [isSaving, setIsSaving] = useState(false);

  const handleSubmit = async (newStatus: 'pass' | 'fail' | 'blocked') => {
    setIsSaving(true);
    setStatus(newStatus); 
    
    const res = await submitTestFeedback(task.id, newStatus, comment);
    
    if (res.success) {
      setIsOpen(false); 
    } else {
      notify('Error guardant.');
    }
    setIsSaving(false);
  };

  return (
    <div className={`border rounded-xl mb-4 transition-all bg-white dark:bg-slate-900 ${
        status === 'pass' ? 'border-green-500/30 bg-green-50/10' : 
        status === 'fail' ? 'border-red-500/30 bg-red-50/10' : 
        'border-border'
    }`}>
      
      {/* Header */}
      <div 
        className="p-4 flex items-center justify-between cursor-pointer select-none"
        onClick={() => setIsOpen(!isOpen)}
      >
        <div className="flex items-center gap-3">
          {status === 'pass' && <CheckCircle className="text-green-500 w-5 h-5" />}
          {status === 'fail' && <XCircle className="text-red-500 w-5 h-5" />}
          {status === 'blocked' && <AlertTriangle className="text-orange-500 w-5 h-5" />}
          {!status && <div className="w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600" />}
          
          <span className={`font-medium ${status ? 'text-slate-500' : 'text-foreground'}`}>
            {task.title}
          </span>
        </div>
        {isOpen ? <ChevronUp className="w-4 h-4 text-slate-400" /> : <ChevronDown className="w-4 h-4 text-slate-400" />}
      </div>

      {/* Cos */}
      {isOpen && (
        <div className="px-4 pb-4 pt-0 border-t border-border mt-2">
          <p className="text-sm text-muted-foreground my-4 leading-relaxed bg-muted/30 p-3 rounded-lg border border-border">
            ğŸ“ <strong>InstrucciÃ³:</strong> {task.description}
          </p>

          <textarea 
            placeholder="Afegeix comentaris..." 
            value={comment || ''}
            onChange={(e) => setComment(e.target.value)}
            className="w-full p-2 mb-4 text-sm bg-background border border-input rounded-md min-h-[80px]"
          />

          <div className="flex gap-2 justify-end">
            <Button 
                size="sm" variant="outline" 
                className="border-red-200 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"
                onClick={() => handleSubmit('fail')} disabled={isSaving}
            >
              <XCircle className="w-4 h-4 mr-2" /> Falla
            </Button>
            <Button 
                size="sm" 
                className="bg-green-600 hover:bg-green-700 text-white"
                onClick={() => handleSubmit('pass')} disabled={isSaving}
            >
              <CheckCircle className="w-4 h-4 mr-2" /> Funciona
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/features/tests/ui/TesterManager.tsx ===================

'use client';

import { useState, useMemo } from 'react';
import { TesterProfile } from '@/types/models';
import { addTesterAction, removeTesterAction } from '@/features/tests/actions/admin-actions';
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Trash2, UserPlus, Search, Check } from 'lucide-react';
import { toast } from 'sonner'; 

interface Props {
  campaignId: string;
  assignedTesters: TesterProfile[];
  availableTesters: TesterProfile[];
}

export function TesterManager({ campaignId, assignedTesters, availableTesters }: Props) {
  const [searchTerm, setSearchTerm] = useState('');
  const [isPending, setIsPending] = useState(false);

  const filteredCandidates = useMemo(() => {
    const assignedIds = new Set(assignedTesters.map(t => t.id));
    const uniqueCandidates = new Map();

    availableTesters.forEach(u => {
        if (assignedIds.has(u.id)) return;
        if (searchTerm && !u.email.toLowerCase().includes(searchTerm.toLowerCase())) return;
        
        // Evitem duplicats a la llista de candidats tambÃ©
        if (!uniqueCandidates.has(u.id)) {
            uniqueCandidates.set(u.id, u);
        }
    });

    return Array.from(uniqueCandidates.values());
  }, [assignedTesters, availableTesters, searchTerm]);

  const handleAdd = async (userId: string) => {
    setIsPending(true);
    const res = await addTesterAction(campaignId, userId);
    if (res.success) toast.success(res.message);
    else toast.error(res.message);
    setIsPending(false);
  };

  const handleRemove = async (userId: string) => {
    if(!confirm("Segur que vols treure l'accÃ©s a aquest usuari?")) return;
    setIsPending(true);
    const res = await removeTesterAction(campaignId, userId);
    if (res.success) toast.success(res.message);
    else toast.error(res.message);
    setIsPending(false);
  };

  return (
    <div className="grid lg:grid-cols-2 gap-8">
        
        {/* LLISTA ACTUAL (ASSIGNATS) */}
        <div className="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-6 shadow-sm">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                <Check className="w-5 h-5 text-green-500" /> Testers Actius ({assignedTesters.length})
            </h3>
            
            <div className="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                {assignedTesters.length === 0 && (
                    <p className="text-sm text-slate-500 italic">No hi ha ningÃº assignat encara.</p>
                )}
                
                {assignedTesters.map((tester, index) => (
                    // âœ… CORRECCIÃ“: Afegim l'index a la clau per fer-la Ãºnica segur
                    <div key={`assigned-${tester.id}-${index}`} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-700">
                        <div className="flex items-center gap-3">
                            <Avatar className="h-8 w-8">
                                <AvatarImage src={tester.avatar_url || ''} />
                                <AvatarFallback>{tester.email?.[0]?.toUpperCase() || 'U'}</AvatarFallback>
                            </Avatar>
                            <div className="overflow-hidden">
                                <p className="text-sm font-medium truncate">{tester.full_name || 'Sense nom'}</p>
                                <p className="text-xs text-slate-500 truncate">{tester.email}</p>
                            </div>
                        </div>
                        <Button 
                            size="icon" 
                            variant="ghost" 
                            onClick={() => handleRemove(tester.id)}
                            disabled={isPending}
                            className="text-slate-400 hover:text-red-500 hover:bg-red-50"
                        >
                            <Trash2 className="w-4 h-4" />
                        </Button>
                    </div>
                ))}
            </div>
        </div>

        {/* LLISTA CANDIDATS (DISPONIBLES) */}
        <div className="bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-800 p-6">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-700 dark:text-slate-300">
                <UserPlus className="w-5 h-5" /> Afegir Testers
            </h3>

            <div className="relative mb-4">
                <Search className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                <input 
                    type="text" 
                    placeholder="Buscar per email..." 
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full pl-9 p-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                />
            </div>

            <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                {filteredCandidates.length === 0 ? (
                    <p className="text-sm text-slate-400 text-center py-4">
                        {searchTerm ? 'Cap resultat trobat.' : 'No hi ha candidats disponibles.'}
                    </p>
                ) : (
                    filteredCandidates.map((user, index) => (
                        // âœ… CORRECCIÃ“: Afegim l'index a la clau aquÃ­ tambÃ©
                        <div key={`candidate-${user.id}-${index}`} className="flex items-center justify-between p-2 hover:bg-white dark:hover:bg-slate-800 rounded-lg transition-colors group cursor-pointer border border-transparent hover:border-slate-200 dark:hover:border-slate-700" onClick={() => handleAdd(user.id)}>
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 flex items-center justify-center text-xs font-bold">
                                    {user.email?.[0]?.toUpperCase() || 'U'}
                                </div>
                                <div>
                                    <p className="text-sm text-slate-700 dark:text-slate-300 font-medium">{user.email}</p>
                                </div>
                            </div>
                            <Button size="sm" variant="ghost" className="opacity-0 group-hover:opacity-100 text-blue-600 font-bold" disabled={isPending}>
                                Assignar
                            </Button>
                        </div>
                    ))
                )}
            </div>
        </div>
    </div>
  );
}

// =================== FILE: src/features/tests/ui/VisualFlowBuilder.tsx ===================

'use client';

import { useActionState, useRef, useEffect } from 'react';
import { TestTaskDTO } from '@/types/models';
import { addTaskAction, deleteTaskAction, TaskActionState } from '../actions/task-actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Plus, Trash2, ArrowDown, GripVertical, CheckSquare } from 'lucide-react';
import { toast } from 'sonner';
import { motion, AnimatePresence } from 'framer-motion';

const initialState: TaskActionState = { success: false, message: '' };

export function VisualFlowBuilder({ campaignId, tasks }: { campaignId: string, tasks: TestTaskDTO[] }) {
    const formRef = useRef<HTMLFormElement>(null);
    
    // Hook per gestionar l'acciÃ³ de crear
    const [state, action, isPending] = useActionState(async (prev: TaskActionState, formData: FormData) => {
        const result = await addTaskAction(prev, formData);
        if (result.success) {
            formRef.current?.reset();
            toast.success("Pas afegit al flux!");
            // Fem scroll automÃ tic al final per veure el nou pas
            setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 300);
        } else {
            toast.error(result.message);
        }
        return result;
    }, initialState);

    const handleDelete = async (taskId: string) => {
        if(!confirm("Segur que vols eliminar aquest pas del flux?")) return;
        const res = await deleteTaskAction(taskId, campaignId);
        if(res.success) toast.success("Pas eliminat");
        else toast.error(res.message);
    }

    return (
        <div className="max-w-3xl mx-auto py-8">
            
            {/* CAPÃ‡ALERA DEL DIAGRAMA */}
            <div className="text-center mb-10">
                <h3 className="text-2xl font-bold text-white mb-2">Flux de NavegaciÃ³ (User Journey)</h3>
                <p className="text-slate-400 text-sm">Defineix el camÃ­ exacte que ha de seguir el tester.</p>
            </div>

            <div className="relative space-y-0">
                {/* LÃNIA CENTRAL CONNECTORA */}
                {tasks.length > 0 && (
                    <div className="absolute left-1/2 top-4 bottom-20 w-0.5 bg-slate-800 -translate-x-1/2 z-0"></div>
                )}

                {/* --- LLISTAT DE PASSOS (NODES) --- */}
                <AnimatePresence>
                    {tasks.map((task, index) => (
                        <motion.div 
                            key={task.id}
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            exit={{ opacity: 0, scale: 0.9 }}
                            className="relative z-10 flex flex-col items-center"
                        >
                            {/* Targeta del Pas */}
                            <div className="bg-slate-900 border border-slate-700 w-full max-w-md rounded-xl p-5 shadow-xl hover:border-purple-500/50 transition-colors group relative">
                                
                                {/* NÃºmero de Pas (Badge) */}
                                <div className="absolute -left-4 -top-4 w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg border-2 border-slate-950">
                                    {index + 1}
                                </div>

                                <div className="flex justify-between items-start mb-2">
                                    <h4 className="font-bold text-white text-lg flex items-center gap-2">
                                        <CheckSquare className="w-5 h-5 text-green-500" />
                                        {task.title}
                                    </h4>
                                    <button 
                                        onClick={() => handleDelete(task.id)}
                                        className="text-slate-500 hover:text-red-500 transition-colors p-1"
                                    >
                                        <Trash2 className="w-4 h-4" />
                                    </button>
                                </div>
                                
                                {task.description && (
                                    <p className="text-slate-400 text-sm bg-black/20 p-3 rounded-lg border border-white/5">
                                        {task.description}
                                    </p>
                                )}
                            </div>

                            {/* Fletxa Connectora (Excepte l'Ãºltim si estem editant) */}
                            <div className="h-12 flex items-center justify-center">
                                <ArrowDown className="text-slate-600 w-6 h-6 animate-pulse" />
                            </div>
                        </motion.div>
                    ))}
                </AnimatePresence>

                {/* --- FORMULARI PER AFEGIR (NODE FINAL) --- */}
                <div className="relative z-10 flex flex-col items-center">
                    <div className="bg-slate-950 border-2 border-dashed border-slate-700 w-full max-w-md rounded-xl p-6 shadow-inner">
                        <h4 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 text-center">
                            Afegir SegÃ¼ent Pas
                        </h4>
                        
                        <form ref={formRef} action={action} className="space-y-4">
                            <input type="hidden" name="campaignId" value={campaignId} />
                            
                            <div>
                                <Input 
                                    name="title" 
                                    placeholder="Ex: Clicar al botÃ³ 'Registrar-se'" 
                                    className="bg-slate-900 border-slate-700 text-white focus:ring-purple-500" 
                                    required
                                    autoComplete="off"
                                />
                            </div>

                            <div>
                                <Textarea 
                                    name="description" 
                                    placeholder="Detalls: L'usuari hauria de veure un modal de confirmaciÃ³..." 
                                    className="bg-slate-900 border-slate-700 text-white resize-none text-xs" 
                                    rows={2}
                                />
                            </div>

                            <Button 
                                type="submit" 
                                disabled={isPending} 
                                className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold"
                            >
                                {isPending ? 'Afegint...' : <><Plus className="w-4 h-4 mr-2" /> Afegir Pas al Diagrama</>}
                            </Button>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    );
}

// =================== FILE: src/hooks/use-scroll-to-anchor.ts ===================

'use client';

import { useEffect } from 'react';
import { usePathname } from 'next/navigation';

export function useScrollToAnchor() {
  const pathname = usePathname();

  useEffect(() => {
    // Aquesta funciÃ³ s'executa quan canvia el path o es carrega el component
    const hash = window.location.hash;
    if (hash) {
      const id = hash.replace('#', '');
      const element = document.getElementById(id);
      
      if (element) {
        // Petit timeout per donar temps al navegador a renderitzar
        setTimeout(() => {
          const headerOffset = 85;
          const elementPosition = element.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

          window.scrollTo({
            top: offsetPosition,
            behavior: "smooth"
          });
        }, 100);
      }
    }
  }, [pathname]); // DependÃ¨ncia: s'executa quan canvia la ruta
}

// =================== FILE: src/i18n/request.ts ===================

import { getRequestConfig } from 'next-intl/server';
import { notFound } from 'next/navigation';
import { routing, type Locale } from '@/routing'; // ğŸ‘ˆ IMPORTEM DE LA FONT ÃšNICA

export default getRequestConfig(async ({ requestLocale }) => {
  const locale = await requestLocale;

  // Ara validem contra la configuraciÃ³ centralitzada
  // AixÃ­ no hem de mantenir dues llistes d'idiomes
  if (!locale || !routing.locales.includes(locale as Locale)) {
    notFound();
  }

  return {
    locale,
    messages: (await import(`../../messages/${locale}.json`)).default
  };
});

// =================== FILE: src/lib/audit-dictionary.ts ===================

// src/lib/audit-dictionary.ts

export const AUDIT_TRANSLATIONS: Record<
  string, // id de l'auditoria
  Record<
    string, // locale, p.ex. 'ca', 'es', 'en'
    { title: string; description: string }
  >
> = {
  // AQUESTA Ã‰S L'ESTRUCTURA CORRECTA AMB KEY DE LOCALE:
  'is-on-https': {
    ca: {
      title: 'El lloc web no utilitza HTTPS segur',
      description: 'La teva web no Ã©s segura. AixÃ² espanta els clients i Google et penalitza greument.'
    },
    es: {
      title: 'El sitio web no usa HTTPS seguro',
      description: 'Tu web no es segura. Esto asusta a los clientes y Google te penaliza.'
    },
    en: {
      title: 'Website is not using secure HTTPS',
      description: 'Your website is not secure. This scares users and Google may penalize you.'
    }
  },
  // âš ï¸ CORRECCIÃ“: ESTRUCTURA DE FALLBACK SIMPLE REQUEREIX CLAU 'ca' EXPLÃCITA
  'meta-description': {
    ca: { 
        title: 'Manca la Meta DescripciÃ³',
        description: 'Google no sap de quÃ¨ tracta la teva web. Necessites un resum atractiu per aparÃ¨ixer als resultats de cerca.'
    }
  },
  'document-title': {
    ca: {
        title: 'La pÃ gina no tÃ© tÃ­tol',
        description: 'El tÃ­tol Ã©s l\'element mÃ©s important per al SEO. Sense ell, Ã©s invisible.'
    }
  },
  'image-alt': {
    ca: {
        title: 'Imatges sense text alternatiu',
        description: 'Les imatges necessiten una descripciÃ³ perquÃ¨ Google les pugui "veure" i indexar.'
    }
  },
  'viewport': {
    ca: {
        title: 'No estÃ  adaptada a mÃ²bils',
        description: 'La web no tÃ© l\'etiqueta viewport correcta, fent que es vegi malament en dispositius mÃ²bils.'
    }
  },
  'server-response-time': {
    ca: {
        title: 'El servidor Ã©s massa lent',
        description: 'El temps de resposta inicial Ã©s alt. Considera canviar de hosting o optimitzar el backend.'
    }
  },
  'render-blocking-resources': {
    ca: {
        title: 'Recursos que bloquegen la visualitzaciÃ³',
        description: 'Hi ha CSS o JS que impedeixen que la web es mostri rÃ pidament. S\'han de diferir.'
    }
  },
  'unminified-css': {
    ca: {
        title: 'CSS no optimitzat',
        description: 'Els fitxers d\'estil sÃ³n massa grans. Minificar-los milloraria la velocitat.'
    }
  },
  'unminified-javascript': {
    ca: {
        title: 'JavaScript no optimitzat',
        description: 'El codi script Ã©s massa pesat. Cal comprimir-lo per accelerar la cÃ rrega.'
    }
  },
  'uses-optimized-images': {
    ca: {
        title: 'Imatges massa pesades',
        description: 'Les imatges no estan optimitzades. Utilitza formats moderns com WebP per estalviar dades.'
    }
  },
  'largest-contentful-paint': {
    ca: {
        title: 'CÃ rrega del contingut principal (LCP) lenta',
        description: 'L\'element mÃ©s gran de la web triga massa a aparÃ¨ixer. AixÃ² frustra els usuaris.'
    }
  },
  'cumulative-layout-shift': {
    ca: {
        title: 'La web es "mou" mentre carrega (CLS)',
        description: 'Els elements canvien de lloc sobtadament, causant una mala experiÃ¨ncia d\'usuari.'
    }
  }
};

export function translateIssue(
  id: string,
  defaultTitle: string,
  defaultDesc: string,
  locale: string = 'ca'
) {
  const translationForId = AUDIT_TRANSLATIONS[id];
  if (translationForId) {
    const translationForLocale = translationForId[locale];
    if (translationForLocale) return translationForLocale;
  }

  // Si no troba la traducciÃ³, torna al text per defecte (en anglÃ¨s de Google)
  return {
    title: defaultTitle,
    description: (defaultDesc || '').split('[')[0].replace(/\.$/, '')
  };
}

// =================== FILE: src/lib/auth/admin-guard.ts ===================

import { createClient } from '@/lib/supabase/server';
import { notFound, redirect } from 'next/navigation';

/**
 * Aquesta funciÃ³ actua com un tallafocs.
 * Si l'usuari no Ã©s l'Admin, atura l'execuciÃ³ i llanÃ§a un 404.
 */
export async function requireAdmin() {
  const supabase = await createClient();
  
  // 1. Obtenim l'usuari
  const { data: { user }, error } = await supabase.auth.getUser();

  // 2. Si no estÃ  loguejat -> Al login
  if (error || !user) {
    redirect('/auth/login');
  }

  // 3. VERIFICACIÃ“ MESTRA
  // Comparem l'email de l'usuari amb la variable d'entorn
  const adminEmail = process.env.ADMIN_EMAIL;

  if (!adminEmail) {
    console.error("âŒ ERROR CRÃTIC: No s'ha configurat ADMIN_EMAIL al .env");
    // Per seguretat, si no hi ha config, bloquegem tothom
    notFound(); 
  }

  if (user.email !== adminEmail) {
    console.warn(`âš ï¸ ALERTA DE SEGURETAT: L'usuari ${user.email} ha intentat accedir a l'admin.`);
    // 4. Si no Ã©s l'admin, mostrem un 404 (Not Found).
    // AixÃ­ ni tan sols saben que la pÃ gina existeix.
    notFound();
  }

  // Si arriba aquÃ­, ets tu. Benvingut, cap.
  return user;
}

// =================== FILE: src/lib/auth/errors.ts ===================

// Hem tret el prefix 'auth.' del principi de cada valor
export const AUTH_ERRORS = {
  INVALID_LOGIN: 'error.invalid_login', 
  USER_NOT_IN_ORG: 'error.not_in_org', 
  EMAIL_TAKEN_IN_ORG: 'error.email_taken', 
  TECHNICAL_ERROR: 'error.technical',
  CONFIRM_EMAIL: 'error.confirm_email',
  ACCOUNT_EXISTS_GLOBAL: 'info.account_exists_please_login' 
};

export function mapSupabaseError(errorMsg: string): string {
  if (errorMsg.includes('Invalid login credentials')) return AUTH_ERRORS.INVALID_LOGIN;
  if (errorMsg.includes('Email not confirmed')) return AUTH_ERRORS.CONFIRM_EMAIL;
  if (errorMsg.includes('User already registered')) return AUTH_ERRORS.ACCOUNT_EXISTS_GLOBAL;
  return AUTH_ERRORS.TECHNICAL_ERROR;
}

// =================== FILE: src/lib/data.ts ===================

// FITXER: src/lib/data.ts

import { StaticImageData } from 'next/image';

// Imatges reals (Assegura't que els fitxers existeixen a aquesta ruta)
import garatgeImg from '@/assets/images/testimoni-garatgeestacio.jpg';
import salutFlowImg from '@/assets/images/salutflow.png';
import dataflow from '@/assets/images/cap-dataflow.jpg';
import jardineriaPons from '@/assets/images/jardinariapontsweb.jpg';




export type Testimonial = {
  id: number | string;
  name: string;
  company: string;
  text: string;
  rating: number;
  projectType: 'web' | 'app' | 'automation';
  projectUrl?: string;
  image?: string | StaticImageData;
};

export const TESTIMONIALS: Testimonial[] = [
  {
    id: 'garatge-estacio',
    name: "Vado",
    company: "Garatge EstaciÃ³",
    // âœ… Text especÃ­fic sobre el nou disseny i les reserves d'autocaravanes
    text: "Estem molt contents amb el nou disseny. El sistema de reserves online per a cites de taller i la zona d'autocaravanes ens ha facilitat moltÃ­ssim la gestiÃ³.",
    rating: 5,
    projectType: 'web',
    projectUrl: 'https://garatgeestacio.com',
    image: garatgeImg
  },
  {
    id: 'guirigall',
    name: "Adriana",
    company: "Guirigall",
    // âœ… Text especÃ­fic sobre automatitzaciÃ³ de RRSS
    text: "L'automatitzaciÃ³ de les xarxes socials ha estat un canvi clau. Ara tenim presÃ¨ncia constant sense haver d'estar pendents del mÃ²bil cada dia.",
    rating: 5,
    projectType: 'automation'
  },
  {
    id: 'inspira',
    name: "Santi Gomez",
    company: "Inspira",
    text: "L'App getSalutFlow ha professionalitzat la relaciÃ³ amb els nostres usuaris. Una eina intuÃ¯tiva que ens ajuda a crÃ©ixer.",
    rating: 5,
    projectType: 'app',
    projectUrl: 'https://getsalutflow.com',
    image: salutFlowImg
  },
  {
    id: 'aquabalance',
    name: "Marta Puig",
    company: "Aquabalance",
    text: "NecessitÃ vem una web que transmetÃ©s pau i professionalitat. El resultat ha superat les expectatives amb una imatge neta i moderna.",
    rating: 5,
    projectType: 'web',
    projectUrl: 'https://aquabalance.com',
    image: salutFlowImg
  },
  {
    id: 'jardineria-pons',
    name: "Mercel Pons",
    company: "Jardineria Pons",
    text: "Una web rÃ pida i directa. Ara els clients poden veure clarament els nostres serveis i contactar-nos fÃ cilment.",
    rating: 5,
    projectType: 'web',
    projectUrl: 'https://www.jardineriapons.com/',
    image: jardineriaPons
  },
  {
    id: 'analytic',
    name: "Ignasi Farreras",
    company: "Ocaso",
    text: "L'appWeb ens permet visualitzar grafiques i estadistiques arxius exel que ens permet ser mes aguils i eficients.",
    rating: 5,
    projectType: 'web',
    projectUrl: 'https://analytics-pwa.vercel.app/',
    image: dataflow
  }
];

// =================== FILE: src/lib/factory/config-generator.ts ===================

// src/services/factory/config-generator.ts

import { MasterConfig } from '@/types/config';
import { AiGeneratedConfig } from '@/types/ai-response';
import { mapAiJsonToMasterConfig } from './config-mapper';

export function generateConfigFileContent(aiRawData: unknown, organizationId: string): string {
  
  // 1. Cast segur: Assumim que l'objecte que ve compleix AiGeneratedConfig
  // (En un entorn mÃ©s estricte utilitzariem Zod per validar-ho, perÃ² aquÃ­ el Cast Ã©s acceptable)
  const typedAiData = aiRawData as AiGeneratedConfig;

  // 2. Mapejar a MasterConfig (AquÃ­ es produeix la mÃ gia que arregla Navbar/Footer)
  const configObject: MasterConfig = mapAiJsonToMasterConfig(typedAiData, organizationId);

  // 3. Convertir a String JSON
  const jsonString = JSON.stringify(configObject, null, 2);

  // 4. Retornar el codi font TypeScript
  return `
import { MasterConfig, ConfigLandingSection } from "@/types/config";

export const CONFIG: MasterConfig = ${jsonString} as unknown as MasterConfig;
`;
}

// =================== FILE: src/lib/factory/config-mapper.ts ===================

// src/services/factory/config-mapper.ts

import { MasterConfig, ConfigLandingSection, SectionType } from '@/types/config';
import { AiGeneratedConfig, AiSectionObj } from '@/types/ai-response';

export function mapAiJsonToMasterConfig(aiData: AiGeneratedConfig, organizationId: string): MasterConfig {
  
  // 1. NormalitzaciÃ³ de les Seccions de la Landing
  // Utilitzem un Type Guard simple per saber si Ã©s string o objecte
  const landingSections: ConfigLandingSection[] = (aiData.landing?.sections || []).map((section): ConfigLandingSection => {
    if (typeof section === 'string') {
      return { id: section, type: section as SectionType }; 
    }
    // Si Ã©s objecte, sabem que compleix AiSectionObj
    const s = section as AiSectionObj;
    return { id: s.id, type: s.type as SectionType };
  });

  // 2. TransformaciÃ³ d'Stats (d'Objecte pla a Array)
  const aboutStats = aiData.about?.stats 
    ? [
        { label: aiData.about.stats.label1 || "", value: aiData.about.stats.value1 || "" },
        { label: aiData.about.stats.label2 || "", value: aiData.about.stats.value2 || "" },
        { label: aiData.about.stats.label3 || "", value: aiData.about.stats.value3 || "" }
      ].filter(stat => stat.label !== "" && stat.value !== "") // Netegem buits
    : [];

  // 3. ConstrucciÃ³ de l'objecte Mestre
  const config: MasterConfig = {
    organizationId: organizationId,

    identity: {
      name: aiData.name || "Projecte Sense Nom",
      description: aiData.description || "DescripciÃ³ pendent",
      logoUrl: "/images/logo-placeholder.png",
      faviconUrl: "/favicon.ico",
      contactEmail: aiData.contact?.email || "info@example.com",
      address: aiData.contact?.address
    },

    branding: {
      colors: {
        primary: aiData.theme?.primary || "#000000",
        secondary: aiData.theme?.secondary || "#333333",
        background: "#ffffff",
        foreground: "#09090b"
      },
      radius: 0.5
    },

    modules: {
      layout: {
        variant: aiData.theme?.layout || 'modern',
        stickyHeader: true
      },
      landing: {
        active: true,
        sections: landingSections
      },
      auth: {
        active: true,
        allowPublicRegistration: false,
        redirects: {
          admin: "/admin",
          client: "/dashboard"
        }
      },
      dashboard: true,
      booking: aiData.features?.booking ?? false,
      ecommerce: aiData.features?.ecommerce ?? false,
      blog: aiData.features?.blog ?? true,
      inventory: false,
      accessControl: true,
      chatbot: aiData.features?.faq ?? false
    },

    i18n: {
      locales: ["ca", "es"],
      defaultLocale: "ca"
    },

    footer: {
      bottomText: aiData.Footer?.description || `Â© ${new Date().getFullYear()} ${aiData.name}.`,
      columns: [
        {
          title: "Legal",
          links: [
            { label: aiData.Footer?.legal?.privacy || "Privacitat", href: "/legal/privacy" },
            { label: aiData.Footer?.legal?.cookies || "Cookies", href: "/legal/cookies" },
            { label: aiData.Footer?.legal?.terms || "Termes", href: "/legal/terms" }
          ]
        }
      ],
      socials: aiData.contact?.socials as Record<string, string> || {}
    },

    content: {
      hero: aiData.hero ? {
        title: aiData.hero.title,
        subtitle: aiData.hero.subtitle,
        cta: aiData.hero.cta
      } : undefined,
      
      about: aiData.about ? {
        title: aiData.about.title,
        description: aiData.about.description,
        image_url: aiData.about.image,
        stats: aboutStats
      } : undefined
    }
  };

  return config;
}

// =================== FILE: src/lib/mock-audit.ts ===================

// Dades falses per poder dissenyar la UI de l'informe
export const MOCK_REPORT = {
  scores: {
    seo: 85,
    performance: 62,
    accessibility: 90,
    best_practices: 75
  },
  issues: [
    { type: 'error', message: 'Falta l\'etiqueta H1 a la pÃ gina principal', impact: 'high' },
    { type: 'warning', message: 'Imatges sense atribut ALT detectades', impact: 'medium' },
    { type: 'success', message: 'Certificat SSL vÃ lid i actiu', impact: 'none' }
  ],
  technologies: ['Next.js', 'Tailwind CSS', 'Vercel']
};

// =================== FILE: src/lib/schemas/social-ai.ts ===================

// src/lib/schemas/social-ai.ts
import { z } from 'zod';

// Definim l'estructura exacta que volem que la IA ens retorni
export const SocialDraftsSchema = z.object({
  linkedin: z.object({
    content: z.string().describe("Text professional, amb salts de lÃ­nia, emojis sobris i hashtags al final."),
    suggested_hashtags: z.array(z.string()).describe("5-7 hashtags rellevants per LinkedIn"),
  }),
  facebook: z.object({
    content: z.string().describe("Text atractiu, una mica mÃ©s casual perÃ² informatiu. Crida a l'acciÃ³ clara."),
  }),
  instagram: z.object({
    content: z.string().describe("Caption visual, curta i amb ganxo. Molts emojis i hashtags."),
    image_prompt: z.string().describe("Un prompt detallat per generar una imatge amb IA (DALL-E 3) si no es vol fer servir la foto del post."),
  }),
});

export type SocialDrafts = z.infer<typeof SocialDraftsSchema>;

// =================== FILE: src/lib/supabase/client.ts ===================

import { createBrowserClient } from '@supabase/ssr'
// ğŸ‘‡ Importa els tipus
import { Database } from '@/types/database.types' 

export function createClient() {
  // ğŸ‘‡ Afegeix el genÃ¨ric <Database> aquÃ­
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}

// =================== FILE: src/lib/supabase/middleware.ts ===================

import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'
import { Database } from '@/types/database.types'

// ğŸ‘‡ Afegeix el genÃ¨ric <Database> aquÃ­
export async function updateSession(
  request: NextRequest, 
  response: NextResponse // âœ… Rebem la resposta del i18n
) {
  const supabase = createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => {
            request.cookies.set(name, value)
            response.cookies.set(name, value, options)
          })
        },
      },
    }
  )

  // AixÃ² refresca el token si Ã©s necessari
  const { data: { user } } = await supabase.auth.getUser()

  // ğŸ›¡ï¸ PROTECCIÃ“ DE RUTES
  // Si intenta accedir a /dashboard sense usuari -> Login
  if (request.nextUrl.pathname.includes('/dashboard') && !user) {
    // Detectem el locale actual de la URL per redirigir al login correcte
    const locale = request.nextUrl.pathname.split('/')[1] || 'ca';
    const loginUrl = request.nextUrl.clone()
    loginUrl.pathname = `/${locale}/auth/login`
    return NextResponse.redirect(loginUrl)
  }

  return response
}

// =================== FILE: src/lib/supabase/server.ts ===================

import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
// ğŸ‘‡ Importem el client bÃ sic tambÃ©
import { createClient as createSupabaseClient } from '@supabase/supabase-js'
import { Database } from '@/types/database.types'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch { }
        },
      },
    }
  )
}

// ğŸ‘‡ NOVA FUNCIÃ“: Client Admin (Bypass RLS)
// Aquest client NO fa servir cookies, fa servir la clau secreta
export function createAdminClient() {
  return createSupabaseClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!, // <--- Aquesta clau Ã©s CRÃTICA
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    }
  )
}

// =================== FILE: src/lib/utils/media.ts ===================

export function getMediaType(url: string): 'IMAGE' | 'VIDEO' {
  const extension = url.split('.').pop()?.toLowerCase();
  if (['mp4', 'mov', 'avi', 'webm'].includes(extension || '')) {
    return 'VIDEO';
  }
  return 'IMAGE';
}

// =================== FILE: src/lib/utils.ts ===================

import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}


// =================== FILE: src/lib/validations/audit.ts ===================

import { z } from "zod";

export const auditSchema = z.object({
  url: z.string()
    .min(3, "La URL Ã©s massa curta")
    .transform((val) => {
      // 1. Neteja bÃ sica
      const clean = val.trim().toLowerCase();
      
      // 2. Elimina protocol o www manual si l'usuari l'ha posat
      const domain = clean.replace(/^(https?:\/\/)?(www\.)?/, '');
      
      // 3. ForÃ§a sempre https://
      return `https://${domain}`;
    })
    // 4. Valida que el resultat sigui una URL real
    .pipe(z.string().url("Introdueix un domini vÃ lid (ex: digitaistudios.com)")),
  
  // Accepta string buit o email vÃ lid
  email: z.string().email("Si us plau, introdueix un email vÃ lid").optional().or(z.literal('')),
});

export type AuditSchema = z.infer<typeof auditSchema>;

// =================== FILE: src/lib/validations/contact.ts ===================

import { z } from 'zod';

// Definim els valors com a constants per evitar errors de tipus
const SERVICE_VALUES = ['ia_automation', 'web_app'] as const;

export const ContactFormSchema = z.object({
  fullName: z.string().min(2, { message: "El nom Ã©s obligatori i ha de tenir almenys 2 lletres." }),
  
  email: z.string().email({ message: "L'email no sembla vÃ lid." }),
  
  // Fem servir 'message' directe, que Ã©s el que demanava el teu TypeScript
  service: z.enum(SERVICE_VALUES, {
    message: "Has de seleccionar un servei de la llista."
  }),
  
  message: z.string().min(10, { message: "Explica'ns una mica mÃ©s (mÃ­nim 10 carÃ cters)." }),
  
  privacy: z.literal('on', {
    message: "Has d'acceptar la polÃ­tica de privacitat."
  }),
});

// Tipus inferits
export type ContactFormData = z.infer<typeof ContactFormSchema>;

export type FormState = {
  success: boolean;
  message: string;
  errors?: {
    fullName?: string[];
    email?: string[];
    service?: string[];
    message?: string[];
    privacy?: string[];
  };
};

// =================== FILE: src/proxy.ts ===================

// =================== FILE: src/proxy.ts ===================

import createMiddleware from 'next-intl/middleware';
import { routing } from '@/routing';
import { updateSession } from '@/lib/supabase/middleware';
import { NextRequest } from 'next/server';

const intlMiddleware = createMiddleware(routing);

export async function proxy(request: NextRequest) {
  const response = intlMiddleware(request);
  return await updateSession(request, response);
}

export const config = {
  matcher: [
    // ğŸ‘‡ HE AFEGIT 'webmanifest' i 'mp4' A L'EXCEPCIÃ“ DEL REGEX
    // AixÃ² diu: "Executa el middleware a tot ARREU EXCEPTE api, next, imatges, manifest i videos"
    '/((?!api|_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt|..*\\.(?:svg|png|jpg|jpeg|gif|webp|webmanifest|mp4)$).*)',
  ],
};

// =================== FILE: src/repositories/interfaces/IAnalyticsRepository.ts ===================

import { AnalyticsEventDTO } from '@/types/models';
export type StatItem = { name: string; value: number; color?: string }; // Tipus genÃ¨ric per grÃ fics

export type DailyStats = {
  date: string;
  visitors: number;
  views: number;
  totalDuration: number; // ğŸ‘ˆ AFEGIT: Durada total en segons per aquell dia
};

// ğŸ‘‡ NOUS TIPUS
export type PageStat = { path: string; views: number };
export type DeviceStat = { name: string; value: number; fill: string }; // 'fill' Ã©s pel color del grÃ fic
export type CountryStat = { country: string; visitors: number };

export interface IAnalyticsRepository {
  // ğŸŸ¢ ARA (CorrecciÃ³): Ha de retornar Promise<number | null>
  trackEvent(event: AnalyticsEventDTO): Promise<number | null>;
  getLast7DaysStats(): Promise<DailyStats[]>;
  // ğŸ‘‡ NOU MÃˆTODE AGREGAT
  getAdvancedStats(): Promise<{
    topPages: PageStat[];
    devices: DeviceStat[];
    countries: StatItem[]; // Ara usem StatItem (mÃ©s flexible)
    referrers: StatItem[]; // Nou
    browsers: StatItem[];  // Nou
    os: StatItem[];        // Nou
  }>;

  // 2. Nou mÃ¨tode per actualitzar nomÃ©s la durada
  updateDuration(eventId: number, duration: number): Promise<void>;

}

// =================== FILE: src/repositories/interfaces/IAuditRepository.ts ===================

import { AuditDTO } from '@/types/models';
// ğŸ‘‡ Definim aquest tipus aquÃ­ perquÃ¨ sigui clar
export type AuditSummary = {
  id: string;
  url: string;
  email: string | null;
  status: AuditDTO['status'];
  seoScore: number | null;
  performanceScore: number | null;
  createdAt: Date; // Important: L'app treballa amb Date, la DB amb string
};

export interface IAuditRepository {
  getAuditsByUserEmail(email: string): Promise<AuditDTO[]>;
  getAuditById(id: string): Promise<AuditDTO | null>;
  createAudit(url: string, email: string): Promise<AuditDTO>;
  
  updateStatus(
    id: string,
    status: AuditDTO['status'],
    results?: { seoScore?: number; performanceScore?: number; reportData?: unknown }
  ): Promise<void>;

  getAuditsByUserId(userId: string): Promise<AuditDTO[]>;
  createAuditForUser(url: string, userId: string, email: string): Promise<AuditDTO>;
  createPublicAudit(url: string, email: string): Promise<AuditDTO>;
  
// ğŸ‘‡ El mÃ¨tode ha de retornar aquest tipus concret
  getAllLight(): Promise<AuditSummary[]>;
}

// =================== FILE: src/repositories/interfaces/IContactRepository.ts ===================

import { createClient } from '@/lib/supabase/server';
import { ContactFormData } from '@/lib/validations/contact';

export class ContactRepository {
  async create(data: ContactFormData) {
    const supabase = await createClient();

    // 1. Mapeig correcte:
    // data.fullName (Zod) -> full_name (Supabase)
    const { data: inserted, error } = await supabase
      .from('contact_leads') 
      .insert({
        full_name: data.fullName, // âœ… Corregit (era name)
        email: data.email,
        service: data.service,    // âœ… Afegit (faltava al teu codi anterior, perÃ² Zod el tÃ©)
        message: data.message,
        source: 'web_form',
        
        // âš ï¸ He tret 'phone' i 'status' perquÃ¨ l'error deia que no existeixen 
        // a la definiciÃ³ de tipus de 'contact_leads'. 
        // Si vols guardar-los, has d'afegir-los primer al schema Zod i a la taula Supabase.
      })
      .select()
      .single();

    if (error) {
      console.error('âŒ Error guardant a DB:', error);
      throw new Error('Database insertion failed');
    }

    return inserted;
  }
}

// =================== FILE: src/repositories/interfaces/IPostRepository.ts ===================

import { BlogPostDTO } from '@/types/models';

export interface IPostRepository {
  getPostBySlug(slug: string): Promise<BlogPostDTO | null>;
  getAllPublishedPosts(): Promise<BlogPostDTO[]>;
  
  // ğŸ‘‡ NOUS MÃˆTODES D'ADMINISTRACIÃ“
  getAllPosts(): Promise<BlogPostDTO[]>; // Inclou esborranys i arxivats
  updatePost(slug: string, data: Partial<BlogPostDTO>): Promise<void>;
  deletePost(slug: string): Promise<void>;
  getAdminPostBySlug(slug: string): Promise<BlogPostDTO | null>;
  getPublishedPostsPaginated(page: number, pageSize: number): Promise<{ posts: BlogPostDTO[]; total: number }>;

}

// =================== FILE: src/repositories/supabase/SupabaseAnalyticsRepository.ts ===================

import { createClient, createAdminClient } from '@/lib/supabase/server';
import { AnalyticsEventDTO } from '@/types/models';
import { Database, Json } from '@/types/database.types';
import {
  IAnalyticsRepository,
  DailyStats,
  PageStat,
  DeviceStat,
  StatItem
} from '../interfaces/IAnalyticsRepository';

type AnalyticsInsert = Database['public']['Tables']['analytics_events']['Insert'];

// âœ… 1. INTERFÃCIES LOCALS (Utilitzades per mapejar la resposta crua de la DB)
interface StatDBResult {
  name: string;
  value: number;
}

interface TopPageDBResult {
  path: string;
  visits: number;
}

export class SupabaseAnalyticsRepository implements IAnalyticsRepository {

  // --- ESCRIURE DADES (TRACKING) ---
  async trackEvent(event: AnalyticsEventDTO): Promise<number | null> {
    const supabaseAdmin = createAdminClient();

    const payload: AnalyticsInsert = {
      event_name: event.event_name,
      path: event.path,
      session_id: event.session_id,
      meta: (event.meta as unknown as Json) || null,
      duration_seconds: event.duration || 0,
      referrer: event.referrer || null,
      country_code: event.geo?.country || null,
      city: event.geo?.city || null,
      device_type: event.device?.type || 'unknown',
      browser: event.device?.browser || 'unknown',
      os: event.device?.os || 'unknown'
    };

    const { data, error } = await supabaseAdmin
      .from('analytics_events')
      .insert(payload)
      .select('id')
      .single();

    if (error) {
      console.error("Error tracking event:", error.message);
      return null;
    }
    return data.id;
  }

  async updateDuration(eventId: number, duration: number): Promise<void> {
    if (duration <= 0) return;
    const supabaseAdmin = createAdminClient();
    await supabaseAdmin
      .from('analytics_events')
      .update({ duration_seconds: duration })
      .eq('id', eventId);
  }

  // --- LLEGIR DADES (DASHBOARD) ---

  async getLast7DaysStats(): Promise<DailyStats[]> {
    const supabase = await createClient();
    
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    const { data, error } = await supabase
      .from('analytics_events')
      .select('created_at, session_id, duration_seconds')
      .gte('created_at', sevenDaysAgo.toISOString());

    if (error || !data) return [];

    const statsMap = new Map<string, { views: number; sessions: Set<string>; duration: number }>();

    for (let i = 6; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const key = d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
      statsMap.set(key, { views: 0, sessions: new Set(), duration: 0 });
    }

    data.forEach((row) => {
      if (!row.created_at) return;

      const date = new Date(row.created_at);
      const key = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
      
      if (statsMap.has(key)) {
        const entry = statsMap.get(key)!;
        entry.views++;
        if (row.session_id) entry.sessions.add(row.session_id);
        entry.duration += row.duration_seconds || 0;
      }
    });

    return Array.from(statsMap.entries()).map(([date, val]) => ({
      date,
      views: val.views,
      visitors: val.sessions.size,
      totalDuration: val.duration
    }));
  }

  async getAdvancedStats(): Promise<{
    topPages: PageStat[];
    devices: DeviceStat[];
    countries: StatItem[];
    referrers: StatItem[];
    browsers: StatItem[];
    os: StatItem[];
  }> {
    const supabase = await createClient();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    const dateStr = thirtyDaysAgo.toISOString();

    console.log("ğŸ“Š [AnalyticsRepo] Fetching advanced stats since:", dateStr);

    // 1. Preparem les crides (Sense 'any', usant @ts-expect-error)
    // Utilitzem @ts-expect-error perquÃ¨ els tipus no existeixen al client encara,
    // perÃ² NO fem servir 'as any'.
    
 
    const pagesReq = supabase.from('mv_analytics_top_pages').select('path, visits').limit(10);
    

    const countriesReq = supabase.rpc('get_analytics_countries', { date_from: dateStr });
   
    const devicesReq = supabase.rpc('get_analytics_devices', { date_from: dateStr });
 
    const referrersReq = supabase.rpc('get_analytics_referrers', { date_from: dateStr });
 
    const browsersReq = supabase.rpc('get_analytics_browsers', { date_from: dateStr });
 
    const osReq = supabase.rpc('get_analytics_os', { date_from: dateStr });

    // 2. Executem tot en paralÂ·lel
    const [pagesRes, countriesRes, devicesRes, referrersRes, browsersRes, osRes] = await Promise.all([
      pagesReq,
      countriesReq,
      devicesReq,
      referrersReq,
      browsersReq,
      osReq
    ]);

    // 3. CASTING STRICTE (AquÃ­ Ã©s on arreglem l'error de l'ESLint)
    // Convertim 'unknown' -> 'TopPageDBResult[]' explÃ­citament.
    // AixÃ² satisfÃ  ESLint (no hi ha 'any') i TypeScript (tipatge segur).

    const rawPages = (pagesRes.data || []) as unknown as TopPageDBResult[];
    const rawCountries = (countriesRes.data || []) as unknown as StatDBResult[];
    const rawDevices = (devicesRes.data || []) as unknown as StatDBResult[];
    const rawReferrers = (referrersRes.data || []) as unknown as StatDBResult[];
    const rawBrowsers = (browsersRes.data || []) as unknown as StatDBResult[];
    const rawOs = (osRes.data || []) as unknown as StatDBResult[];

    // 4. MAPPING FINAL
    const topPages = rawPages.map((p) => ({ 
        path: p.path, 
        views: p.visits 
    }));

    const countries = rawCountries.map((c) => ({
        name: (!c.name || c.name === 'XX') ? 'Desconegut' : c.name,
        value: c.value,
        color: '#10b981'
    }));

    const devices = rawDevices.map((d, i) => {
        const colors = ['#8884d8', '#00C49F', '#FFBB28', '#FF8042'];
        return {
            name: d.name,
            value: d.value,
            fill: colors[i % colors.length]
        };
    });

    const referrers = rawReferrers.map((r) => ({
        name: r.name,
        value: r.value,
        color: '#3b82f6'
    }));

    const browsers = rawBrowsers.map((b) => ({
        name: b.name,
        value: b.value,
        color: '#f59e0b'
    }));

    const os = rawOs.map((o) => ({
        name: o.name,
        value: o.value,
        color: '#ec4899'
    }));

    return {
      topPages,
      devices,
      countries,
      referrers,
      browsers,
      os
    };
  }
}

// =================== FILE: src/repositories/supabase/SupabaseAuditRepository.ts ===================

import { createClient, createAdminClient } from '@/lib/supabase/server';
import { IAuditRepository, AuditSummary } from '../interfaces/IAuditRepository';
import { AuditDTO } from '@/types/models';
import { Database } from '@/types/database.types';

// Tipus directe de la fila de la DB
type AuditRow = Database['public']['Tables']['web_audits']['Row'];

export class SupabaseAuditRepository implements IAuditRepository {

  private mapToDTO(row: AuditRow): AuditDTO {
    return {
      id: row.id,
      url: row.url,
      status: row.status as AuditDTO['status'],
      seoScore: row.seo_score,
      performanceScore: row.performance_score,
      createdAt: row.created_at ? new Date(row.created_at) : new Date(),
      // Fem un cast segur cap a un objecte genÃ¨ric o unknown
      reportData: row.report_data as Record<string, unknown>,
    };
  }

  async getAuditsByUserEmail(email: string): Promise<AuditDTO[]> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('web_audits')
      .select('*')
      .eq('email', email)
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);
    return data.map(this.mapToDTO);
  }

  async getAuditById(id: string): Promise<AuditDTO | null> {
    const supabase = await createClient();
    const { data } = await supabase.from('web_audits').select('*').eq('id', id).single();
    return data ? this.mapToDTO(data) : null;
  }

  async createAudit(url: string, email: string): Promise<AuditDTO> {
    console.log(`[Repo] Creant auditoria per: ${email} - URL: ${url}`);

    const supabaseAdmin = createAdminClient();

    const { data, error } = await supabaseAdmin
      .from('web_audits')
      .insert({
        url,
        email,
        status: 'processing'
      })
      .select()
      .single();

    if (error) {
      console.error('[Repo] Error Supabase:', error);
      throw new Error(`Error creating audit: ${error.message}`);
    }

    console.log('[Repo] Auditoria creada OK:', data.id);
    return this.mapToDTO(data);
  }

  async updateStatus(
    id: string,
    status: AuditDTO['status'],
    results?: {
      seoScore?: number;
      performanceScore?: number;
      reportData?: Record<string, unknown>
    }
  ): Promise<void> {
    const supabaseAdmin = createAdminClient();

    // Utilitzem Partial<AuditRow> per assegurar que els camps coincideixen amb la DB
    // Omitim 'id' i 'created_at' perquÃ¨ no els tocarem
    const updatePayload: Partial<AuditRow> = { status };

    if (results) {
      if (results.seoScore !== undefined) updatePayload.seo_score = results.seoScore;
      if (results.performanceScore !== undefined) updatePayload.performance_score = results.performanceScore;

      if (results.reportData !== undefined) {
        // âœ… CORRECCIÃ“ CLAU:
        // En lloc de 'as any', fem un cast al tipus especÃ­fic que Supabase espera per aquesta columna.
        // AixÃ² satisfÃ  l'Eslint i mantÃ© la seguretat de tipus relativa a la DB.
        updatePayload.report_data = results.reportData as AuditRow['report_data'];
      }
    }

    const { error } = await supabaseAdmin
      .from('web_audits')
      .update(updatePayload)
      .eq('id', id);

    if (error) throw new Error(error.message);
  }
  async getAuditsByUserId(userId: string): Promise<AuditDTO[]> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('web_audits')
      .select('*')
      .eq('user_id', userId) // ğŸ‘ˆ Filtrem per ID, molt mÃ©s robust
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);
    return data.map(this.mapToDTO);
  }

  // CAS 1: Des del Dashboard (Tenim ID segur)
  async createAuditForUser(url: string, userId: string, email: string): Promise<AuditDTO> {
    const supabaseAdmin = createAdminClient();
    const { data, error } = await supabaseAdmin
      .from('web_audits')
      .insert({
        url,
        user_id: userId, // âœ… Clau
        email: email,
        status: 'processing'
      })
      .select()
      .single();

    if (error) throw new Error(error.message);
    return this.mapToDTO(data);
  }

  // CAS 2: Des de la Landing (NomÃ©s tenim Email)
  async createPublicAudit(url: string, email: string): Promise<AuditDTO> {
    const supabaseAdmin = createAdminClient();

    // Opcional: Buscar si ja existeix un usuari amb aquest email per lligar-ho?
    // Per ara, ho guardem sense user_id (o amb un user_id temporal si la taula ho requereix)
    // NOTA: Si la taula 'web_audits' tÃ© 'user_id' com NOT NULL, necessitem una estratÃ¨gia aquÃ­.
    // L'estratÃ¨gia habitual Ã©s crear un usuari "fantasma" o deixar el camp nullable.
    // Assumint que user_id pot ser null o gestionem el registre desprÃ©s.

    const { data, error } = await supabaseAdmin
      .from('web_audits')
      .insert({
        url,
        email: email,
        status: 'processing'
        // user_id: null (si la DB ho permet)
      })
      .select()
      .single();

    if (error) throw new Error(error.message);
    return this.mapToDTO(data);
  }
  async getAllLight(): Promise<AuditSummary[]> {
    // âŒ ABANS: const supabase = await createClient();
    // Aquest client respecta RLS, per aixÃ² nomÃ©s veus les teves.

    // âœ… ARA: Fem servir el client Admin (Service Role)
    // Aquest client tÃ© "superpoders" i ho veu tot.
    // Ã‰s segur fer-ho aquÃ­ perquÃ¨ l'Action 'getAdminAudits' ja ha verificat el login.
    const supabase = createAdminClient();

    const { data, error } = await supabase
      .from('web_audits')
      .select('id, created_at, url, email, seo_score, performance_score, status')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('âŒ [AUDIT REPO] Error:', error);
      return [];
    }

    return data.map(row => ({
      id: row.id,
      url: row.url,
      email: row.email,
      status: row.status as AuditDTO['status'],
      seoScore: row.seo_score,
      performanceScore: row.performance_score,
      createdAt: row.created_at ? new Date(row.created_at) : new Date()
    }));
  }


  // Per al detall (mÃ©s endavant), sÃ­ que voldrem el report_data
  async getById(id: string) {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('web_audits')
      .select('*')
      .eq('id', id)
      .single();

    if (error) return null;
    return data;
  }
}

// =================== FILE: src/repositories/supabase/SupabaseContactRepository.ts ===================

import { createClient } from '@/lib/supabase/server'; // Client estÃ ndard per a lectures (respecta sessiÃ³)
import { createClient as createAdminClient } from '@supabase/supabase-js'; // âš ï¸ Client Admin per a inserts
import { ContactFormData } from '@/lib/validations/contact';

export class SupabaseContactRepository {

  // 1ï¸âƒ£ MÃˆTODE CREATE: Utilitza la clau Mestra (Service Role)
  // AixÃ² permet que qualsevol (fins i tot si no estÃ  loguejat) pugui enviar el formulari
  // sense xocar amb les polÃ­tiques RLS.
  async create(data: ContactFormData) {
    // Creem una instÃ ncia d'admin al vol
    const supabaseAdmin = createAdminClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY! // Assegura't de tenir aixÃ² al .env.local
    );

    const { data: inserted, error } = await supabaseAdmin
      .from('contact_leads')
      .insert({
        full_name: data.fullName,
        email: data.email,
        service: data.service,
        message: data.message,
        source: 'landing_contact_form',

      })
      .select()
      .single();

    if (error) {
      console.error('âŒ [REPO] Error Supabase (Create):', error);
      throw new Error('Error guardant el lead a la base de dades');
    }

    return inserted;
  }

  // 2ï¸âƒ£ MÃˆTODES DE LECTURA: Utilitzen el client de sessiÃ³ (Cookies)
  // NomÃ©s funcionaran si estÃ s loguejat al Dashboard. AixÃ² Ã©s CORRECTE per seguretat.

  async getAll() {
    console.log('ğŸ” [REPO] Iniciant lectura de contact_leads...');
    const supabase = await createClient(); // Client normal (cookies)

    const { data, error } = await supabase
      .from('contact_leads')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('âŒ [REPO] Error Supabase (Get All):', error.message);
      throw new Error("No s'han pogut carregar els missatges.");
    }

    console.log(`âœ… [REPO] Dades recuperades: ${data?.length || 0} files.`);
    return data;
  }

  async getPaginated(page: number, limit: number) {
    const supabase = await createClient();

    const from = (page - 1) * limit;
    const to = from + limit - 1;

    console.log(`ğŸ” [REPO] PaginaciÃ³: de ${from} a ${to}`);

    const { data, count, error } = await supabase
      .from('contact_leads')
      .select('*', { count: 'exact' })
      .order('created_at', { ascending: false })
      .range(from, to);

    if (error) {
      console.error('âŒ [REPO] Error paginaciÃ³:', error.message);
      throw new Error("No s'han pogut carregar els missatges.");
    }

    return {
      data: data || [],
      total: count || 0
    };
  }

  async getById(id: string) {
    const supabase = await createClient();

    const { data, error } = await supabase
      .from('contact_leads')
      .select('*')
      .eq('id', id)
      .single();

    if (error) {
      console.error(`âŒ [REPO] Error recuperant lead ${id}:`, error.message);
      return null;
    }

    return data;
  }

  async delete(id: string) {
    console.log(`ğŸ—‘ï¸ [REPO] Intentant eliminar lead: ${id} de la taula contact_leads`);
    const supabase = await createClient();

    // Afegim { count: 'exact' } per saber si REALMENT s'ha esborrat
    const { error, count } = await supabase
      .from('contact_leads') // ğŸ‘ˆ NOM CORRECTE
      .delete({ count: 'exact' })
      .eq('id', id);

    if (error) {
      console.error(`âŒ [REPO] Error eliminant lead ${id}:`, error.message);
      throw new Error('Error eliminant el missatge de la base de dades.');
    }

    // Si no hi ha error perÃ² count Ã©s 0, alguna cosa passa (ID incorrecte o permisos RLS)
    if (count === 0) {
      console.warn(`âš ï¸ [REPO] Alerta: Supabase ha retornat 0 files eliminades. Revisa RLS.`);
      // Opcional: throw new Error("No tens permÃ­s per eliminar o el missatge ja no existeix.");
    }

    console.log(`âœ… [REPO] Lead eliminat correctament.`);
    return true;
  }
}

// =================== FILE: src/repositories/supabase/SupabasePostRepository.ts ===================

import { createClient, createAdminClient } from '@/lib/supabase/server';
import { IPostRepository } from '@/repositories/interfaces/IPostRepository';
import { BlogPostDTO } from '@/types/models';
import { Database } from '@/types/database.types';

// 1. Tipus base
type PostRow = Database['public']['Tables']['posts']['Row'];
type PostUpdate = Database['public']['Tables']['posts']['Update'];
type PostInsert = Database['public']['Tables']['posts']['Insert'];

// 2. âœ… DEFINICIÃ“ ESTRICTA DEL JOIN AMB EL NOM CORRECTE DE LA COLUMNA
type PostRowWithRelations = PostRow & {
  social_posts: {
    id: string;
    platform: string;
    status: string;
    scheduled_at: string | null; // ğŸ‘ˆ CORREGIT: Ha de coincidir amb SQL
  }[];
};

const MY_ORG_ID = process.env.NEXT_PUBLIC_MAIN_ORG_ID!;
if (!MY_ORG_ID) throw new Error("Manca NEXT_PUBLIC_MAIN_ORG_ID");

export class SupabasePostRepository implements IPostRepository {

  // ğŸ”„ Mapper: DB -> App
  private mapToDTO(row: PostRowWithRelations): BlogPostDTO {
    return {
      id: row.id,
      slug: row.slug,
      title: row.title,
      date: row.published_at ?? row.created_at,
      description: row.description,
      content: row.content_mdx,
      tags: row.tags ? (row.tags as string[]) : [],
      coverImage: row.cover_image,
      published: row.published ?? false,
      reviewed: row.reviewed ?? false,

      // ğŸ‘‡ Mapeig del Array
      social_posts: Array.isArray(row.social_posts)
        ? row.social_posts.map(sp => ({
          id: sp.id,
          platform: sp.platform,
          status: sp.status,
          // ğŸ”„ Mapeig de noms: DB (snake_case) -> DTO (camelCase)
          scheduledFor: sp.scheduled_at || null
        }))
        : []
    };
  }

  // --- LECTURA PÃšBLICA (WEB) ---
  // (Aquesta part no canvia, la deixo resumida)
  async getPostBySlug(slug: string): Promise<BlogPostDTO | null> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .eq('slug', slug)
      .eq('status', 'published')
      .eq('published', true)
      .eq('organization_id', MY_ORG_ID)
      .single();

    if (error || !data) return null;
    // Cast manual per satisfer el mapToDTO encara que no porti socials
    return this.mapToDTO({ ...data, social_posts: [] } as unknown as PostRowWithRelations);
  }

  async getAllPublishedPosts(): Promise<BlogPostDTO[]> {
    const supabase = await createClient();
    // ... (El teu codi existent de getAllPublishedPosts estÃ  bÃ©)
    // Simplement recorda que aquÃ­ no estem fent join amb socials, aixÃ­ que al map:
    // return this.mapToDTO({ ...row, social_posts: [] } as unknown as PostRowWithRelations);
    // (O simplement ignora el camp si Ã©s opcional al DTO)

    // Per simplicitat, aquÃ­ tens el bloc sencer si vols assegurar:
    const { data: posts } = await supabase
      .from('posts')
      .select('*')
      .eq('status', 'published')
      .eq('published', true)
      .eq('organization_id', MY_ORG_ID)
      .order('published_at', { ascending: false });

    if (!posts || posts.length === 0) return [];

    const slugs = posts.map(p => p.slug);
    const { data: reactions } = await supabase
      .from('post_reactions')
      .select('post_slug')
      .in('post_slug', slugs);

    const reactionCounts = new Map<string, number>();
    reactions?.forEach(r => {
      reactionCounts.set(r.post_slug, (reactionCounts.get(r.post_slug) || 0) + 1);
    });

    return posts.map(row => ({
      ...this.mapToDTO({ ...row, social_posts: [] } as unknown as PostRowWithRelations),
      totalReactions: reactionCounts.get(row.slug) || 0
    }));
  }

  // --- GESTIÃ“ ADMIN (DASHBOARD) ---

  async getAllPosts(): Promise<BlogPostDTO[]> {
    const supabase = createAdminClient();

    // A getAllPosts()
    const { data, error } = await supabase
      .from('posts')
      .select(`
    id, slug, title, published, reviewed, published_at, created_at, cover_image,
    description, organization_id, 
    social_posts ( id, platform, status, scheduled_at )
  `) // ğŸ‘ˆ NO DEMANEM 'content_mdx' NI 'tags' si sÃ³n pesats
      .eq('organization_id', MY_ORG_ID)
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);

    // ğŸ› ï¸ TRUC: Casting a 'unknown' i desprÃ©s al nostre tipus manual
    // AixÃ² calla els errors de tipatge de Supabase quan fem Joins complexos
    return (data as unknown as PostRowWithRelations[]).map(row => this.mapToDTO(row));
  }

  async createPost(data: Partial<BlogPostDTO>): Promise<string> {
    const supabase = createAdminClient();
    const generatedSlug = data.slug || data.title?.toLowerCase().replace(/ /g, '-').replace(/[^\w-]/g, '') || 'untitled';

    const insertData: PostInsert = {
      organization_id: MY_ORG_ID,
      title: data.title || 'Nou Article',
      slug: generatedSlug,
      content_mdx: data.content || '',
      published: false,
      status: 'draft',
    };

    const { data: newPost, error } = await supabase
      .from('posts')
      .insert(insertData)
      .select('slug')
      .single();

    if (error) throw new Error(error.message);
    return newPost.slug;
  }

  async updatePost(slug: string, data: Partial<BlogPostDTO>): Promise<void> {
    const supabase = createAdminClient();
    const updateData: PostUpdate = {};

    if (data.title !== undefined) updateData.title = data.title;
    if (data.description !== undefined) updateData.description = data.description;
    if (data.content !== undefined) updateData.content_mdx = data.content;
    if (data.tags !== undefined) updateData.tags = data.tags;
    if (data.coverImage !== undefined) updateData.cover_image = data.coverImage;
    if (data.reviewed !== undefined) updateData.reviewed = data.reviewed;

    if (data.published !== undefined) {
      updateData.published = data.published;
      updateData.status = data.published ? 'published' : 'draft';
      if (data.published) updateData.published_at = data.date || new Date().toISOString();
    } else if (data.date) {
      updateData.published_at = data.date;
    }

    const { error } = await supabase
      .from('posts')
      .update(updateData)
      .eq('slug', slug)
      .eq('organization_id', MY_ORG_ID);

    if (error) throw new Error(error.message);
  }

  async deletePost(slug: string): Promise<void> {
    const supabase = createAdminClient();
    const { error } = await supabase
      .from('posts')
      .delete()
      .eq('slug', slug)
      .eq('organization_id', MY_ORG_ID);

    if (error) throw new Error(error.message);
  }

  async getAdminPostBySlug(slug: string): Promise<BlogPostDTO | null> {
    const supabase = createAdminClient();

    const { data, error } = await supabase
      .from('posts')
      .select(`
        *,
        social_posts (
          id,
          platform,
          status,
          content,
          scheduled_at 
        )
      `) // ğŸ‘† CORREGIT: 'scheduled_at' aquÃ­ tambÃ©
      .eq('slug', slug)
      .eq('organization_id', MY_ORG_ID)
      .single();

    if (error || !data) return null;

    // ğŸ› ï¸ TRUC: Casting
    return this.mapToDTO(data as unknown as PostRowWithRelations);
  }

  // ... (Reaccions igual)
  async getPostReactions(slug: string): Promise<Record<string, number>> {
    const supabase = await createClient();
    const { data } = await supabase.from('post_reactions').select('reaction_type').eq('post_slug', slug);
    const counts: Record<string, number> = {};
    data?.forEach(r => counts[r.reaction_type] = (counts[r.reaction_type] || 0) + 1);
    return counts;
  }

  async toggleReaction(slug: string, reaction: string, visitorId: string) {
    const supabase = createAdminClient();
    const { data: post } = await supabase.from('posts').select('id').eq('slug', slug).eq('organization_id', MY_ORG_ID).single();
    if (!post) throw new Error("Post not found");

    const { data: existing } = await supabase.from('post_reactions').select('id').eq('post_slug', slug).eq('reaction_type', reaction).eq('visitor_id', visitorId).maybeSingle();

    if (existing) {
      await supabase.from('post_reactions').delete().eq('id', existing.id);
      return 'removed';
    } else {
      await supabase.from('post_reactions').insert({ post_slug: slug, reaction_type: reaction, visitor_id: visitorId });
      return 'added';
    }
  }
  // âœ… NOU MÃˆTODE PAGINAT
  async getPaginatedPosts(page: number, pageSize: number): Promise<{ posts: BlogPostDTO[]; total: number }> {
    const supabase = createAdminClient();

    // CÃ lcul del rang (ex: PÃ gina 1 -> 0 a 19)
    const start = (page - 1) * pageSize;
    const end = start + pageSize - 1;

    const { data, count, error } = await supabase
      .from('posts')
      .select(`
        id, slug, title, published, reviewed, published_at, created_at, cover_image, description, organization_id,
        social_posts ( id, platform, status, scheduled_at )
      `, { count: 'exact' }) // ğŸ‘ˆ Demanem el total de files
      .eq('organization_id', MY_ORG_ID)
      .order('created_at', { ascending: false })
      .range(start, end); // ğŸ‘ˆ Tallem les dades

    if (error) throw new Error(error.message);

    // Mapegem les dades (utilitzant el teu helper existent)
    const posts = (data as unknown as PostRowWithRelations[]).map(row => this.mapToDTO(row));

    return {
      posts,
      total: count || 0
    };

  }


  // ğŸ‘‡ NOU MÃˆTODE PER AL BLOG PÃšBLIC (Paginat + NomÃ©s Publicats)
  async getPublishedPostsPaginated(page: number, pageSize: number): Promise<{ posts: BlogPostDTO[]; total: number }> {
    const supabase = await createClient();

    const start = (page - 1) * pageSize;
    const end = start + pageSize - 1;

    // 1. Obtenim els posts filtrats
    const { data, count, error } = await supabase
      .from('posts')
      .select('*', { count: 'exact' })
      .eq('status', 'published')
      .eq('published', true)
      .eq('organization_id', process.env.NEXT_PUBLIC_MAIN_ORG_ID!)
      .order('published_at', { ascending: false })
      .range(start, end);

    if (error) throw new Error(error.message);

    // 2. Obtenim les reaccions
    const slugs = data?.map(p => p.slug) || [];
    const reactionCounts = new Map<string, number>();

    if (slugs.length > 0) {
      const { data: reactions } = await supabase
        .from('post_reactions')
        .select('post_slug')
        .in('post_slug', slugs);

      reactions?.forEach(r => {
        reactionCounts.set(r.post_slug, (reactionCounts.get(r.post_slug) || 0) + 1);
      });
    }

    // 3. Mapegem a DTO
    const posts = (data || []).map(row => ({
      // âœ… CORRECCIÃ“: Canviem 'any' per 'PostRowWithRelations'
      // Com que li estem afegint manualment 'social_posts: []', TypeScript
      // acceptarÃ  que aixÃ² ara compleix amb el tipus PostRowWithRelations.
      ...this.mapToDTO({ ...row, social_posts: [] } as unknown as PostRowWithRelations),
      totalReactions: reactionCounts.get(row.slug) || 0
    }));

    return {
      posts,
      total: count || 0
    };
  }

}


// =================== FILE: src/repositories/supabase/SupabaseProfileRepository.ts ===================

import { createAdminClient } from '@/lib/supabase/server';

export class SupabaseProfileRepository {

    // Buscar si existeix perfil per a un email en una ORG concreta
    // Usem admin client per saltar-nos RLS si cal, o per seguretat en server actions
    async findByEmailAndOrg(email: string, orgId: string) {
        const supabase = createAdminClient();

        const { data } = await supabase
            .from('profiles')
            .select('id')
            .eq('email', email)
            .eq('organization_id', orgId)
            .maybeSingle();

        return data;
    }

    // Crear perfil manualment (quan l'usuari d'Auth ja existeix)
    async createProfile(userId: string, email: string, orgId: string, fullName?: string) {
        const supabase = createAdminClient();

        return await supabase.from('profiles').insert({
            id: userId, // Mateix ID que auth.users
            email: email,
            organization_id: orgId,
            full_name: fullName
        });
    }
}

// =================== FILE: src/repositories/supabase/SupabaseProjectRepository.ts ===================

import {  createAdminClient } from '@/lib/supabase/server';

export type ProjectMember = {
    user_id: string;
    role: string;
    profile: {
        full_name: string | null;
        email: string;
        avatar_url: string | null;
    };
};

export class SupabaseProjectRepository {

    // A. Afegir membre al projecte
    async addMember(projectId: string, userId: string, role: string = 'member') {
        const supabase = createAdminClient(); // Admin powers
        return supabase
            .from('project_members')
            .insert({ project_id: projectId, user_id: userId, role })
            .select()
            .single();
    }

    // B. Eliminar membre
    async removeMember(projectId: string, userId: string) {
        const supabase = createAdminClient();
        return supabase
            .from('project_members')
            .delete()
            .eq('project_id', projectId)
            .eq('user_id', userId);
    }


    // D. Obtenir candidats
    async getAvailableCandidates(projectId: string, organizationId: string) {
        // ğŸ”¥ CANVI CLAU: AdminClient per poder llistar TOTS els perfils de l'org
        const supabase = createAdminClient();

        // 1. Tots els de l'organitzaciÃ³
        const { data: orgUsers } = await supabase
            .from('profiles')
            .select('*')
            .eq('organization_id', organizationId);

        // 2. Els que ja sÃ³n al projecte
        const { data: currentMembers } = await supabase
            .from('project_members')
            .select('user_id')
            .eq('project_id', projectId);

        if (!orgUsers) return [];

        const memberIds = new Set(currentMembers?.map(m => m.user_id));

        // Retornem nomÃ©s els que NO sÃ³n membres encara
        return orgUsers.filter(u => !memberIds.has(u.id));
    }
    // C. Obtenir membres del projecte
   // C. Obtenir membres del projecte
  async getMembers(projectId: string): Promise<ProjectMember[]> {
    const supabase = createAdminClient();

    // 1. Obtenim la relaciÃ³ projecte-usuari
    const { data: members, error } = await supabase
      .from('project_members')
      .select('user_id, role')
      .eq('project_id', projectId);

    if (error || !members) return [];

    // 2. Obtenim els detalls dels perfils
    const userIds = members.map(m => m.user_id);
    if (userIds.length === 0) return [];

    const { data: userDetails } = await supabase
      .from('profiles')
      .select('id, full_name, email, avatar_url')
      .in('id', userIds);

    // 3. Unim les dades i assegurem el tipatge (Evitem errors TS)
    return members.map(m => {
      const profileData = userDetails?.find(u => u.id === m.user_id);

      return {
        user_id: m.user_id,
        // âœ… CORRECCIÃ“ 1: Si role Ã©s null, posem 'member' per defecte
        role: m.role || 'member', 
        
        // âœ… CORRECCIÃ“ 2: ConstruÃ¯m l'objecte profile netament
        profile: {
          full_name: profileData?.full_name || 'Usuari Desconegut',
          email: profileData?.email || 'Sense email',
          avatar_url: profileData?.avatar_url || null
        }
      };
    });
  }
}

// =================== FILE: src/repositories/supabase/SupabaseTestRepository.ts ===================

import { createClient, createAdminClient } from '@/lib/supabase/server';
import { Database } from '@/types/database.types';
import { CampaignContext, TestCampaignDTO, TestTaskDTO, TestResultDTO, TesterProfile } from '@/types/models';
import type { MissionStats } from '@/services/GamificationService'; // ğŸ‘ˆ Importamos el tipo para asegurar que cumplimos el contrato
type TestCampaignRow = Database['public']['Tables']['test_campaigns']['Row'];

type CampaignQueryResponse = TestCampaignRow & {
  projects: { name: string; domain: string | null } | null;
  test_tasks: {
    id: string;
    test_results: { count: number }[];
  }[];
};
// 1. Tipus per a la resposta "bruta" de Supabase (Raw Data)
// AixÃ² ens evita usar 'any' quan fem el cast
type CampaignResponse = {
  id: string;
  campaign: {
    id: string;
    title: string;
    description: string | null;
    status: string | null;
    project_id: string;
    test_tasks: { id: string }[]; // Array d'objectes amb id
  } | null;
};

// 2. Tipus per al resultat d'usuari
type UserResultRow = {
  task_id: string;
  status: string;
};
export class SupabaseTestRepository {

  // A. Context del Test (Admin o User)
  async getCampaignWithContext(campaignId: string, userId: string): Promise<CampaignContext> {
    const supabase = createAdminClient();

    // 1. Campanya
    const { data: campaignData } = await supabase
      .from('test_campaigns')
      .select('*')
      .eq('id', campaignId)
      .single();

    if (!campaignData) return { campaign: null, tasks: [], results: [] };

    // 2. Tasques
    const { data: tasksData } = await supabase
      .from('test_tasks')
      .select('*')
      .eq('campaign_id', campaignId)
      .order('order_index', { ascending: true });

    // 3. Resultats
    const taskIds = tasksData?.map(t => t.id) || [];
    const { data: resultsData } = await supabase
      .from('test_results')
      .select('*')
      .in('task_id', taskIds)
      .eq('user_id', userId);

    // Mapeig
    const campaign: TestCampaignDTO = {
      id: campaignData.id,
      projectId: campaignData.project_id,
      title: campaignData.title,
      description: campaignData.description,
      instructions: campaignData.instructions,
      status: campaignData.status || 'active',
      createdAt: new Date(campaignData.created_at || Date.now())
    };

    const tasks: TestTaskDTO[] = (tasksData || []).map(t => ({
      id: t.id,
      campaignId: t.campaign_id,
      title: t.title,
      description: t.description,
      orderIndex: t.order_index ?? 0
    }));

    const results: TestResultDTO[] = (resultsData || []).map(r => ({
      id: r.id,
      taskId: r.task_id,
      userId: r.user_id,
      status: (r.status as 'pass' | 'fail' | 'blocked') || 'blocked',
      comment: r.comment,
      updatedAt: new Date(r.updated_at || Date.now())
    }));

    return { campaign, tasks, results };
  }

  // --- MÃˆTODES D'ESCRIPTURA ---

  async saveResult(userId: string, taskId: string, status: string, comment: string) {
    const supabase = await createClient(); // Usuari normal
    return supabase.from('test_results').upsert({
      user_id: userId,
      task_id: taskId,
      status,
      comment,
      updated_at: new Date().toISOString()
    }, { onConflict: 'task_id, user_id' });
  }

  async createTask(data: { campaignId: string; title: string; description?: string; orderIndex: number }) {
    const supabase = createAdminClient();
    return supabase.from('test_tasks').insert({
      campaign_id: data.campaignId,
      title: data.title,
      description: data.description,
      order_index: data.orderIndex
    }).select().single();
  }

  async deleteTask(taskId: string) {
    const supabase = createAdminClient();
    return supabase.from('test_tasks').delete().eq('id', taskId);
  }

  async reorderTasks(tasks: { id: string; order_index: number }[]) {
    const supabase = createAdminClient();
    for (const t of tasks) {
      await supabase.from('test_tasks').update({ order_index: t.order_index }).eq('id', t.id);
    }
  }

  async assignTester(campaignId: string, userId: string) {
    const supabase = createAdminClient();
    return supabase.from('test_assignments').insert({
      campaign_id: campaignId,
      user_id: userId
    });
  }

  async removeTester(campaignId: string, userId: string) {
    const supabase = createAdminClient();
    return supabase.from('test_assignments').delete()
      .eq('campaign_id', campaignId)
      .eq('user_id', userId);
  }

  async createCampaign(data: { projectId: string; title: string; description: string; instructions: string }) {
    const supabase = createAdminClient();
    return supabase.from('test_campaigns').insert({
      project_id: data.projectId,
      title: data.title,
      description: data.description,
      instructions: data.instructions,
      status: 'active'
    }).select().single();
  }

  async updateCampaign(id: string, data: { title?: string; description?: string; instructions?: string; status?: string }) {
    const supabase = createAdminClient();
    return supabase.from('test_campaigns').update(data).eq('id', id);
  }

  // --- MÃˆTODES DE LECTURA (Corregits amb Manual Join) ---

  async getAllCampaignsForAdmin() {
    const supabase = createAdminClient();
    const { data, error } = await supabase
      .from('test_campaigns')
      .select(`
        *,
        projects(name, domain),
        test_tasks ( id, test_results (count) )
      `)
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);

    const typedData = data as unknown as CampaignQueryResponse[];

    return typedData.map((camp) => {
      const totalResults = camp.test_tasks?.reduce((acc, task) => {
        const count = task.test_results?.[0]?.count || 0;
        return acc + count;
      }, 0) || 0;

      return {
        ...camp,
        stats: {
          total_tasks: camp.test_tasks?.length || 0,
          total_results: totalResults
        }
      };
    });
  }

  async getCampaignsByProject(projectId: string) {
    const supabase = createAdminClient();
    const { data, error } = await supabase
      .from('test_campaigns')
      .select(`
        *,
        test_assignments (count),
        test_tasks (count)
      `)
      .eq('project_id', projectId)
      .order('created_at', { ascending: false });

    if (error) return [];

    return data.map(camp => ({
      id: camp.id,
      title: camp.title,
      status: camp.status,
      testerCount: camp.test_assignments?.[0]?.count || 0,
      taskCount: camp.test_tasks?.[0]?.count || 0,
      createdAt: camp.created_at
    }));
  }

  // A. Llistar tots els usuaris (Legacy - potser ja no s'usa)
  async getAvailableTesters(): Promise<TesterProfile[]> {
    const supabase = createAdminClient();
    const { data } = await supabase
      .from('profiles')
      .select('id, email, full_name, avatar_url')
      .neq('role', 'admin')
      .order('email');
    return data || [];
  }


  // B. Llistar testers assignats (i filtrar duplicats per OrgID implÃ­citament agafant el primer)
  async getAssignedTesters(campaignId: string): Promise<TesterProfile[]> {
    const supabase = createAdminClient();

    const { data: assignments } = await supabase
      .from('test_assignments')
      .select('user_id')
      .eq('campaign_id', campaignId);

    if (!assignments || assignments.length === 0) return [];

    const userIds = assignments.map(a => a.user_id);
    const { data: profiles } = await supabase
      .from('profiles')
      .select('id, email, full_name, avatar_url')
      .in('id', userIds);

    // Netejar duplicats en JS (el mÃ¨tode rÃ pid)
    const uniqueMap = new Map();
    profiles?.forEach(p => {
      if (!uniqueMap.has(p.id)) uniqueMap.set(p.id, p);
    });

    return Array.from(uniqueMap.values());
  }

  // D. Obtenir candidats vÃ lids per a un test
  async getProjectMembersForTest(campaignId: string, projectId: string, organizationId: string): Promise<TesterProfile[]> {
    const supabase = createAdminClient();

    // 1. Membres del Projecte (IDs)
    const { data: projectMembers } = await supabase
      .from('project_members')
      .select('user_id')
      .eq('project_id', projectId);

    if (!projectMembers || projectMembers.length === 0) return [];

    // 2. Membres del Test (per excloure)
    const { data: testMembers } = await supabase
      .from('test_assignments')
      .select('user_id')
      .eq('campaign_id', campaignId);

    const assignedIds = new Set(testMembers?.map(t => t.user_id));

    // 3. Filtrar IDs
    const candidateIds = projectMembers
      .map(pm => pm.user_id)
      .filter(uid => !assignedIds.has(uid));

    if (candidateIds.length === 0) return [];

    // 4. Obtenir perfils (FILTRANT PER ORGANITZACIÃ“)
    const { data: profiles } = await supabase
      .from('profiles')
      .select('id, email, full_name, avatar_url')
      .in('id', candidateIds)
      .eq('organization_id', organizationId); // ğŸ‘ˆ Filtre clau

    return profiles || [];
  }
  // I. Eliminar Campanya (Admin)
  async deleteCampaign(campaignId: string) {
    const supabase = createAdminClient(); // Admin per saltar restriccions
    return supabase
      .from('test_campaigns')
      .delete()
      .eq('id', campaignId);
  }
  // J. Obtenir les meves missions (Tester Dashboard)
  async getMyAssignments(userId: string) {
    const supabase = await createClient(); // Client normal (RLS aplicat)

    const { data, error } = await supabase
      .from('test_assignments')
      .select(`
        id, 
        assigned_at,
        campaign:test_campaigns (
            id, title, description, status, project_id,
            project:projects ( name, domain ),
            test_tasks ( count )
        )
      `) // ğŸ‘† He afegit 'id' al principi perquÃ¨ el necessites abaix
      .eq('user_id', userId)
      .order('assigned_at', { ascending: false });

    if (error || !data) return [];

    // 1. Definim el tipus del resultat del Join per treure l'any
    type AssignmentRow = {
      id: string;
      assigned_at: string | null;
      campaign: {
        id: string;
        title: string;
        description: string | null;
        status: string | null;
        project: { name: string; domain: string | null } | null;
        test_tasks: { count: number }[];
      } | null;
    };

    // 2. Fem el cast segur
    const rows = data as unknown as AssignmentRow[];

    // 3. Mapegem
    return rows.map((row) => {
      const campaign = row.campaign;

      // Si per algun motiu la campanya s'ha esborrat perÃ² l'assignaciÃ³ no, evitem error
      if (!campaign) return null;

      return {
        assignmentId: row.id,
        campaignId: campaign.id,
        title: campaign.title,
        description: campaign.description,
        projectName: campaign.project?.name,
        projectDomain: campaign.project?.domain,
        // Supabase torna el count dins d'un array d'objectes
        totalTasks: campaign.test_tasks?.[0]?.count || 0,
        status: campaign.status,
        assignedAt: row.assigned_at
      };
    })
      // Filtrem els nuls (campanyes esborrades) i nomÃ©s les actives
      // Aquest "predicate" (item is ...) ajuda a TS a saber que ja no hi ha nulls
      .filter((item): item is NonNullable<typeof item> => item !== null && item.status === 'active');
  }

  async getActiveMissionsForUser(userId: string, projectId: string) {
    const supabase = await createClient();

    // 1. QUERY
    const { data: assignmentsData } = await supabase
      .from('test_assignments')
      .select(`
            id,
            campaign:test_campaigns (
                id, title, description, status, project_id,
                test_tasks ( id ) 
            )
        `)
      .eq('user_id', userId)
      .not('campaign', 'is', null);

    const assignments = (assignmentsData || []) as unknown as CampaignResponse[];

    // 2. FILTRATGE
    const activeAssignments = assignments.filter(a =>
      a.campaign &&
      a.campaign.status === 'active' &&
      a.campaign.project_id === projectId
    );

    // 3. OBTENIR RESULTATS
    const allTaskIds = activeAssignments.flatMap(a =>
      a.campaign ? a.campaign.test_tasks.map(t => t.id) : []
    );

    let userResults: UserResultRow[] = [];

    if (allTaskIds.length > 0) {
      const { data: res } = await supabase
        .from('test_results')
        .select('task_id, status')
        .eq('user_id', userId)
        .in('task_id', allTaskIds);

      if (res) {
        userResults = res as UserResultRow[];
      }
    }

    // 4. MAPATGE FINAL (DTO)
    return activeAssignments.map(assign => {
      const campaign = assign.campaign!;

      const campaignTaskIds = new Set(campaign.test_tasks.map(t => t.id));
      const relevantResults = userResults.filter(r => campaignTaskIds.has(r.task_id));

      // --- ğŸ§® CÃ€LCULS COMPLETES PER A MISSIONSTATS ---
      const totalTasks = campaign.test_tasks.length;

      // Comptem per estat
      const passed = relevantResults.filter(r => r.status === 'pass').length;
      const failed = relevantResults.filter(r => r.status === 'fail').length;
      const blocked = relevantResults.filter(r => r.status === 'blocked').length;

      // Pendents sÃ³n els que no tenen cap resultat registrat
      const pending = totalTasks - (passed + failed + blocked);

      // ProgrÃ©s basat en TASQUES PASSADES (Ãˆxit)
      const progress = totalTasks > 0 ? Math.round((passed / totalTasks) * 100) : 0;

      // XP Reward (LÃ²gica de negoci: 100 XP per tasca)
      const xpReward = totalTasks * 100;

      // ConstruÃ¯m l'objecte que compleix amb MissionStats
      const stats: MissionStats = {
        total: totalTasks,
        passed,
        failed,
        blocked,
        pending,
        progress,
        xpReward
      };

      return {
        id: campaign.id,
        title: campaign.title,
        description: campaign.description,
        stats: stats // âœ… Ara sÃ­ que tÃ© totes les propietats requerides
      };
    });
  }
  // K. Obtenir resultats detallats d'una campanya (Analytics)
  async getCampaignResults(campaignId: string) {
    const supabase = createAdminClient();

    // 1. Obtenim totes les tasques de la campanya (per saber el total)
    const { data: tasks } = await supabase
      .from('test_tasks')
      .select('id, title')
      .eq('campaign_id', campaignId);

    if (!tasks) return { results: [], totalTasks: 0 };

    const taskIds = tasks.map(t => t.id);
    const taskMap = new Map(tasks.map(t => [t.id, t.title]));

    // 2. Obtenim tots els resultats d'aquestes tasques
    const { data: results } = await supabase
      .from('test_results')
      .select(`
        id, status, comment, updated_at, task_id, user_id
      `)
      .in('task_id', taskIds)
      .order('updated_at', { ascending: false });

    // 3. Obtenim els usuaris involucrats (per mostrar noms)
    const userIds = Array.from(new Set(results?.map(r => r.user_id) || []));
    const { data: profiles } = await supabase
      .from('profiles')
      .select('id, full_name, email, avatar_url')
      .in('id', userIds);

    const profileMap = new Map(profiles?.map(p => [p.id, p]));

    // 4. Combinem les dades en un objecte fÃ cil de consumir per la UI
    const enrichedResults = results?.map(r => ({
      id: r.id,
      // âœ… CORRECCIÃ“: Fem un cast explÃ­cit a l'estat
      status: (r.status as 'pass' | 'fail' | 'blocked') || 'blocked',
      comment: r.comment,
      updated_at: r.updated_at || new Date().toISOString(), // Assegurem data
      task_id: r.task_id,
      user_id: r.user_id,
      taskTitle: taskMap.get(r.task_id) || 'Tasca desconeguda',
      tester: profileMap.get(r.user_id) || { id: 'unknown', full_name: 'Desconegut', email: '...', avatar_url: null }
    })) || [];

    return {
      results: enrichedResults,
      totalTasks: tasks.length,
      tasks: tasks // Retornem tambÃ© l'estructura per si cal
    };
  }
}




// =================== FILE: src/routing.ts ===================

import { defineRouting } from 'next-intl/routing';
import { createNavigation } from 'next-intl/navigation';

export const routing = defineRouting({
  locales: ['ca', 'es', 'en', 'it'],
  defaultLocale: 'ca',
  localePrefix: 'as-needed' // Opcional: per si vols /ca o no
});

// Exportem tipus per a reutilitzar
export type Locale = (typeof routing.locales)[number];

export const { Link, redirect, usePathname, useRouter, getPathname } =
  createNavigation(routing);

// =================== FILE: src/services/ai/AIService.ts ===================

import { GeminiProvider } from "./providers/GeminiProvider";
import { OpenAIProvider } from "./providers/OpenAIProvider";
import { I18nSchema } from "@/types/i18n";
import { getSectorConfig, SectorConfig } from "@/types/sectors";
// ğŸ‘‡ IMPORTANT: Importem el tipus del fitxer centralitzat, no el redefinim aquÃ­
import { BusinessSuggestion } from "@/types/ai"; 

export class AIService {
  private gemini: GeminiProvider;
  private openai: OpenAIProvider;

  constructor() {
    this.gemini = new GeminiProvider();
    this.openai = new OpenAIProvider();
  }

  // ===========================================================================
  // 1ï¸âƒ£ GENERACIÃ“ DE CONTINGUT WEB (COPYWRITING) - ORQUESTRACIÃ“
  // ===========================================================================
  async generateTranslationFile(
    businessName: string, 
    description: string, 
    sectorInput: string
  ): Promise<I18nSchema> {
    
    const sectorConfig: SectorConfig = getSectorConfig(sectorInput);
    console.log(`ğŸ¤– [AIService] Generant Copywriting Premium per: "${businessName}"...`);

    // --- INTENT 1: GOOGLE GEMINI (Prioritari) ---
    try {
        console.log(`ğŸ”µ [AIService] Provant ${this.gemini.providerName}...`);
        return await this.gemini.generateContent(businessName, description, sectorConfig);
    } catch (error) {
        console.warn(`âš ï¸ [AIService] Gemini ha fallat. Canviant a OpenAI...`, error);
    }

    // --- INTENT 2: OPENAI (Reserva) ---
    try {
        console.log(`ğŸŸ¢ [AIService] Provant ${this.openai.providerName}...`);
        return await this.openai.generateContent(businessName, description, sectorConfig);
    } catch (error) {
        console.error(`âŒ [AIService] OpenAI tambÃ© ha fallat.`, error);
    }

    // --- INTENT 3: FALLBACK (Seguretat total) ---
    console.error("ğŸ”¥ [AIService] TOTS ELS MODELS HAN FALLAT. Usant fallback.");
    return this.getFallbackContent(businessName, description, sectorConfig);
  }

  // ===========================================================================
  // 2ï¸âƒ£ ANÃ€LISI D'OPORTUNITATS DE NEGOCI (PER AL CORREU)
  // ===========================================================================
  async analyzeBusinessOpportunity(url: string, pageText: string): Promise<BusinessSuggestion[]> {
    console.log(`ğŸ•µï¸ [AIService] Analitzant oportunitats de negoci per: ${url}...`);

    // Intent 1: Gemini
    try {
      console.log(`ğŸ”µ Provant Gemini (Analyze)...`);
      return await this.gemini.analyzeBusiness(url, pageText);
    } catch (error) {
      // AQUÃ Ã‰S ON EL SISTEMA SALTA AUTOMÃ€TICAMENT QUAN GEMINI ESTÃ€ BLOQUEJAT (429)
      console.warn("âš ï¸ Gemini Analysis failed. Trying OpenAI...", error);
    }

    // Intent 2: OpenAI
    try {
      console.log(`ğŸŸ¢ Provant OpenAI (Analyze)...`);
      return await this.openai.analyzeBusiness(url, pageText);
    } catch (error) {
      console.error("âŒ OpenAI Analysis failed.", error);
    }

    // Fallback manual: Si tot falla, retornem aquests 3 suggeriments professionals
    console.log("ğŸ”¥ Tots els models han fallat. Usant fallback manual.");
    return [
      {
        title: "CaptaciÃ³ AutomÃ tica de Clients",
        description: "Implementar formularis intelÂ·ligents per convertir visites en clients potencials sense esforÃ§ manual.",
        icon: "user",
        impact: "high"
      },
      {
        title: "Sistema de Reserves / Cites",
        description: "Permet als teus clients reservar els teus serveis 24/7 directament des del mÃ²bil.",
        icon: "calendar",
        impact: "high"
      },
      {
        title: "AnalÃ­tica de Vendes",
        description: "Panell de control per saber exactament d'on venen els teus millors clients.",
        icon: "chart",
        impact: "medium"
      }
    ];
  }

  // ===========================================================================
  // ğŸ§± FALLBACK CONTENT (SCHEMA)
  // ===========================================================================
  private getFallbackContent(name: string, desc: string, _config: SectorConfig): I18nSchema {
    return {
      hero: { title: name, subtitle: desc, cta: "Contactar", image_prompt: "" },
      about: { 
          badge: "Info", title: "Sobre nosaltres", description: desc, image_prompt: "", 
          stats: { label1: "ExperiÃ¨ncia", value1: "+10", label2: "Clients", value2: "100%", label3: "Projectes", value3: "+50" } 
      },
      services: { badge: "Serveis", title: "Serveis", subtitle: "", items: [] },
      featured_products: { title: "Productes", subtitle: "SelecciÃ³", limit: 4 }, // âœ… Afegit el que has posat
      testimonials: { badge: "Opinions", title: "Opinions", subtitle: "", reviews: [] },
      cta_banner: { heading: "T'interessa?", subheading: "Parlem avui", buttonText: "Contactar" },
      map: { title: "UbicaciÃ³", subtitle: "Vine a veure'ns" }, // âœ… Afegit el que has posat
      faq: { title: "Preguntes", subtitle: "", items: [] },
      contact: { title: "Contacte", description: "", button: "Enviar" }
    };
  }
}

// =================== FILE: src/services/ai/interfaces/IAIProvider.ts ===================

import { I18nSchema } from "@/types/i18n";
import { SectorConfig } from "@/types/sectors";
import { BusinessSuggestion } from "@/types/ai"; // ğŸ‘ˆ Importa el tipus nou

export interface IAIProvider {
  providerName: string;

  // 1. Generar Web (Factory)
  generateContent(
    businessName: string, 
    description: string, 
    sectorConfig: SectorConfig
  ): Promise<I18nSchema>;

  // 2. Analitzar Negoci (Auditoria Comercial) ğŸ‘ˆ NOU MÃˆTODE
  analyzeBusiness(
    url: string, 
    pageText: string
  ): Promise<BusinessSuggestion[]>;
}

// =================== FILE: src/services/ai/prompts/WebsitePrompt.ts ===================

import { SectorConfig } from "@/types/sectors";

export class WebsitePrompt {
    /**
     * Genera el prompt mestre per a la creaciÃ³ de contingut web.
     * Centralitza tota l'enginyeria de prompts en un sol lloc.
     */
    static build(name: string, desc: string, config: SectorConfig): string {
        return `
      ACTUA COM: Un Copywriter sÃ¨nior especialitzat en Branding i Vendes.
      OBJECTIU: Crear els textos per a la nova web del negoci "${name}".
      IDIOMA: CATALÃ€ Natiu (persuasiu, natural, sense faltes).

      CONTEXT DEL NEGOCI:
      - Nom: "${name}"
      - DescripciÃ³ Original: "${desc}"
      - Sector: ${config.key}
      - Personalitat de Marca: ${config.aiPersona}

      ğŸ›‘ REGLES D'OR (STRICT MODE):
      1. PROHIBIT fer servir clixÃ©s buits.
      2. SIGUES ESPECÃFIC: Inventa detalls plausibles basats en el sector.
      3. BENEFICIS > CARACTERÃSTIQUES.

      INSTRUCCIONS PER SECCIÃ“:

      1. HERO: Title (ganxo fort), Subtitle (proposta valor), Image Prompt (English).
      2. ABOUT: Badge, Title, Description (storytelling), Stats (mÃ¨triques creatives, NO "anys/clients").
      3. SERVICES: 3-4 serveis clau. icon_name en anglÃ¨s.
      
      4. FEATURED_PRODUCTS (NOU):
         - Title: Ex: "Els nostres Top Vendes" o "La SelecciÃ³ del Xef".
         - Subtitle: Una frase que inciti a comprar.
         - Limit: 4.

      5. TESTIMONIALS: 3 ressenyes realistes.
      6. FAQ: 4 preguntes reals amb respostes Ãºtils.
      
      7. MAP (NOU):
         - Title: Ex: "Visita'ns al cor de l'EmpordÃ ".
         - Subtitle: InstrucciÃ³ clara per arribar-hi.

      8. CTA_BANNER i CONTACT: Textos finals de tancament.

      OUTPUT: Retorna el JSON complet seguint l'esquema estrictament.
    `;
    }

    /**
     * Genera el prompt per detectar oportunitats de negoci en una web existent.
     */
    static buildBusinessAnalysis(url: string, text: string): string {
        return `
      ACTUA COM: Un Consultor de TransformaciÃ³ Digital expert en Vendes B2B.
      OBJECTIU: Analitzar el contingut d'una web i proposar 3 funcionalitats tecnolÃ²giques per augmentar la facturaciÃ³.

      DADES DE LA WEB:
      - URL: "${url}"
      - CONTINGUT EXTRET: "${text.substring(0, 5000)}" (Pot contenir brutÃ­cia HTML, ignora-la).

      TASCA:
      1. Identifica el sector del negoci (ex: Reformes, Advocats, Botiga, Restaurant).
      2. Detecta QUÃˆ LI FALTA a nivell digital que la competÃ¨ncia moderna sÃ­ que tÃ©.
      3. Proposa 3 mÃ²duls concrets.

      EXEMPLES DE SUGGERIMENTS (Icones vÃ lides: 'calendar', 'shop', 'user', 'chart', 'settings'):
      - Si venen serveis (advocat/metge) -> "Reserva de Cita Online" (calendar).
      - Si fan obres/reformes -> "Calculadora de Pressupostos" (chart) o "Galeria Abans/DesprÃ©s" (settings).
      - Si venen productes fÃ­sics -> "Botiga Online / Click&Collect" (shop).
      - Si tenen clients recurrents -> "Ã€rea Privada de Clients" (user).

      FORMAT DE RESPOSTA (JSON Array estricte):
      [
        {
          "title": "TÃ­tol Comercial (ex: Automatitza les cites)",
          "description": "ExplicaciÃ³ del benefici econÃ²mic (ex: Deixa de perdre trucades fora d'horari).",
          "icon": "calendar",
          "impact": "high"
        }
      ]
    `;
    }

}

// =================== FILE: src/services/ai/providers/GeminiProvider.ts ===================

import { GoogleGenAI, Schema } from "@google/genai";
import { IAIProvider } from "../interfaces/IAIProvider";
import { WebsitePrompt } from "../prompts/WebsitePrompt";
import { I18nSchema } from "@/types/i18n";
import { SectorConfig } from "@/types/sectors";
import { BusinessSuggestion } from "@/types/ai";

export class GeminiProvider implements IAIProvider {
    public providerName = "Google Gemini (New SDK)";
    private client: GoogleGenAI;
    private modelName = "gemini-2.5-flash"; // O "gemini-1.5-flash"


    constructor() {
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) throw new Error("Manca GEMINI_API_KEY");
        this.client = new GoogleGenAI({ apiKey });
    }

    // ===========================================================================
    // 1ï¸âƒ£ GENERACIÃ“ DE CONTINGUT WEB
    // ===========================================================================
    async generateContent(name: string, desc: string, config: SectorConfig): Promise<I18nSchema> {
        console.log(`ğŸ¤– [Gemini] 1. Preparant prompt per a: ${name}`);
        const prompt = WebsitePrompt.build(name, desc, config);

        const schema = this.getResponseSchema();

        console.log(`ğŸ¤– [Gemini] 2. Enviant peticiÃ³ a Google (${this.modelName})...`);
        const startTime = Date.now();

        try {
            const response = await this.client.models.generateContent({
                model: this.modelName,
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                config: {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                    temperature: 0.7,
                },
            });

            const duration = Date.now() - startTime;
            console.log(`ğŸ¤– [Gemini] 3. Resposta rebuda en ${duration}ms`);

            const text = response.text;
            if (!text) throw new Error("Gemini ha retornat una resposta buida");

            // LOG CRÃTIC: Veure el JSON cru abans de parsejar
            console.log(`ğŸ“œ [Gemini] JSON CRU (Primeres 200 lletres): ${text.substring(0, 200)}...`);

            const parsed = JSON.parse(text) as I18nSchema;

            // VerificaciÃ³ rÃ pida
            const hasMap = !!parsed.map;
            const hasProducts = !!parsed.featured_products;
            console.log(`âœ… [Gemini] 4. JSON vÃ lid. Inclou Mapa? ${hasMap ? 'SI' : 'NO'}. Inclou Productes? ${hasProducts ? 'SI' : 'NO'}`);

            return parsed;

        } catch (error) {
            console.error("âŒ [Gemini] Error greu generant contingut:", error);
            throw error;
        }
    }

    // ===========================================================================
    // 2ï¸âƒ£ ANÃ€LISI D'OPORTUNITATS (BUSINESS ANALYSIS)
    // ===========================================================================
    async analyzeBusiness(url: string, pageText: string): Promise<BusinessSuggestion[]> {
        const prompt = `
        Analitza aquesta web: ${url}
        Text: ${pageText.substring(0, 3000)}
        Actua com a consultor digital i proposa 3 millores.
        Format JSON array.
    `;

        // Esquema per a l'Array de suggeriments (Strings + Cast final)
        const schema = {
            type: 'ARRAY',
            items: {
                type: 'OBJECT',
                properties: {
                    title: { type: 'STRING' },
                    description: { type: 'STRING' },
                    icon: { type: 'STRING' },
                    impact: { type: 'STRING' }
                },
                required: ["title", "description", "icon", "impact"]
            }
        } as unknown as Schema; // ğŸ‘ˆ EL TRUC MÃ€GIC

        try {
            const response = await this.client.models.generateContent({
                model: this.modelName,
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                config: {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                    temperature: 0.5,
                },
            });

            const text = response.text;
            if (!text) return [];

            return JSON.parse(text) as BusinessSuggestion[];
        } catch (e) {
            console.warn("âš ï¸ Gemini analyzeBusiness error:", e);
            throw e;
        }
    }

    // ===========================================================================
    // ğŸ”’ SCHEMA PRIVAT
    // ===========================================================================
    private getResponseSchema(): Schema {
        // Definim l'objecte amb strings normals per evitar problemes d'importaciÃ³ d'Enums
        const schemaObj = {
            type: 'OBJECT',
            properties: {
                hero: {
                    type: 'OBJECT',
                    properties: {
                        title: { type: 'STRING' }, subtitle: { type: 'STRING' }, cta: { type: 'STRING' }, image_prompt: { type: 'STRING' },
                    },
                    required: ["title", "subtitle", "cta", "image_prompt"],
                },
                about: {
                    type: 'OBJECT',
                    properties: {
                        badge: { type: 'STRING' }, title: { type: 'STRING' }, description: { type: 'STRING' }, image_prompt: { type: 'STRING' },
                        stats: {
                            type: 'OBJECT',
                            properties: {
                                label1: { type: 'STRING' }, value1: { type: 'STRING' },
                                label2: { type: 'STRING' }, value2: { type: 'STRING' },
                                label3: { type: 'STRING' }, value3: { type: 'STRING' },
                            },
                        },
                    },
                    required: ["title", "description", "stats"],
                },
                services: {
                    type: 'OBJECT',
                    properties: {
                        badge: { type: 'STRING' }, title: { type: 'STRING' }, subtitle: { type: 'STRING' },
                        items: {
                            type: 'ARRAY',
                            items: {
                                type: 'OBJECT',
                                properties: { title: { type: 'STRING' }, description: { type: 'STRING' }, icon_name: { type: 'STRING' } },
                            },
                        },
                    },
                    required: ["items"],
                },
                featured_products: {
                    type: 'OBJECT',
                    properties: {
                        title: { type: 'STRING' },
                        subtitle: { type: 'STRING' },
                        limit: { type: 'NUMBER' }
                    },
                    required: ["title", "subtitle"]
                },
                testimonials: {
                    type: 'OBJECT',
                    properties: {
                        badge: { type: 'STRING' }, title: { type: 'STRING' }, subtitle: { type: 'STRING' },
                        reviews: {
                            type: 'ARRAY',
                            items: {
                                type: 'OBJECT',
                                properties: { author: { type: 'STRING' }, role: { type: 'STRING' }, text: { type: 'STRING' }, avatar_gender: { type: 'STRING', nullable: true } },
                            },
                        },
                    },
                    required: ["reviews"],
                },
                map: {
                    type: 'OBJECT',
                    properties: {
                        title: { type: 'STRING' },
                        subtitle: { type: 'STRING' }
                    },
                    required: ["title", "subtitle"]
                },
                cta_banner: {
                    type: 'OBJECT',
                    properties: { heading: { type: 'STRING' }, subheading: { type: 'STRING' }, buttonText: { type: 'STRING' } },
                    required: ["heading", "buttonText"],
                },
                faq: {
                    type: 'OBJECT',
                    properties: {
                        title: { type: 'STRING' }, subtitle: { type: 'STRING' },
                        items: {
                            type: 'ARRAY',
                            items: {
                                type: 'OBJECT',
                                properties: { question: { type: 'STRING' }, answer: { type: 'STRING' } },
                            },
                        },
                    },
                    required: ["title", "items"],
                },
                contact: {
                    type: 'OBJECT',
                    properties: { title: { type: 'STRING' }, description: { type: 'STRING' }, button: { type: 'STRING' } },
                    required: ["title", "button"],
                },
            },
            required: ["hero", "about", "services", "featured_products", "testimonials", "map", "cta_banner", "faq", "contact"],
        };

        // ğŸ‘ˆ AQUEST Ã‰S EL CASTEIG QUE ARREGLA TOTS ELS ERRORS
        return schemaObj as unknown as Schema;
    }
}

// =================== FILE: src/services/ai/providers/OpenAIProvider.ts ===================

import OpenAI from "openai";
import { IAIProvider } from "../interfaces/IAIProvider";
import { WebsitePrompt } from "../prompts/WebsitePrompt";
import { I18nSchema } from "@/types/i18n";
import { SectorConfig } from "@/types/sectors";
import { BusinessSuggestion } from "@/types/ai";


export class OpenAIProvider implements IAIProvider {
  public providerName = "OpenAI GPT-4o Mini";
  private client: OpenAI;

  constructor() {
    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) throw new Error("Manca OPENAI_API_KEY");
    this.client = new OpenAI({ apiKey });
  }

  async generateContent(name: string, desc: string, config: SectorConfig): Promise<I18nSchema> {
    const prompt = WebsitePrompt.build(name, desc, config);

    const completion = await this.client.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { 
          role: "system", 
          content: "Ets un expert Copywriter i desenvolupador JSON. Retorna SEMPRE un JSON vÃ lid que compleixi estrictament l'estructura demanada." 
        },
        { role: "user", content: prompt }
      ],
      response_format: { type: "json_object" }, // Forcem mode JSON
      temperature: 0.7,
    });

    const content = completion.choices[0].message.content;
    if (!content) throw new Error("OpenAI ha retornat una resposta buida");

    return JSON.parse(content) as I18nSchema;
  }
  // ğŸ‘‡ 2. NOU MÃˆTODE D'ANÃ€LISI
  async analyzeBusiness(url: string, pageText: string): Promise<BusinessSuggestion[]> {
    const prompt = WebsitePrompt.buildBusinessAnalysis(url, pageText);

    const completion = await this.client.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: "Retorna nomÃ©s JSON vÃ lid." },
        { role: "user", content: prompt }
      ],
      response_format: { type: "json_object" },
      temperature: 0.5,
    });

    const content = completion.choices[0].message.content;
    if (!content) throw new Error("OpenAI empty response");

    // OpenAI sol tornar { "suggestions": [...] } o directament l'array segons com li doni.
    // Com que el prompt demana array, a vegades el posa dins d'una clau arrel.
    const parsed = JSON.parse(content);
    return Array.isArray(parsed) ? parsed : (parsed.suggestions || []);
  }

}

// =================== FILE: src/services/AuditService.ts ===================

// src/services/AuditService.ts

import { IAuditRepository } from '@/repositories/interfaces/IAuditRepository';
import { IWebScanner } from '@/adapters/IWebScanner';
import { ResendEmailService } from '@/services/email/ResendEmailService';
// ğŸ‘‡ 1. IMPORTS NOUS
import { AIService} from '@/services/ai/AIService';
import { BusinessSuggestion } from "@/types/ai"; // ğŸ‘ˆ IMPORTA D'AQUÃ
export class AuditService {
  constructor(
    private auditRepo: IAuditRepository,
    private scanner: IWebScanner,
    private emailService: ResendEmailService,
    private aiService: AIService // ğŸ‘ˆ 2. INJECTEM EL SERVEI AL CONSTRUCTOR
  ) { }

  // ... (performPublicAudit, performUserAudit, getDashboardAudits, getAuditDetails es queden igual) ...
  // NomÃ©s assegura't que criden a this.performFullAudit

  async performPublicAudit(url: string, email: string, locale: string) {
    return this.performFullAudit(url, { email }, locale);
  }

  async performUserAudit(url: string, userId: string, userEmail: string, locale: string) {
    return this.performFullAudit(url, { userId, email: userEmail }, locale);
  }

  async getDashboardAudits() {
    return await this.auditRepo.getAllLight();
  }

  async getAuditDetails(id: string) {
    return await this.auditRepo.getAuditById(id);
  }

  // ğŸ‘‡ 3. LÃ’GICA CENTRAL ACTUALITZADA
  private async performFullAudit(url: string, user: { userId?: string, email: string }, locale: string) {
    console.log(`ğŸš€ [AuditService] Iniciant auditoria PREMIUM per: ${url}`);

    let newAudit;
    // Creem l'auditoria a la DB (Estat: processing)
    if (user.userId) {
      newAudit = await this.auditRepo.createAuditForUser(url, user.userId, user.email);
    } else {
      newAudit = await this.auditRepo.createPublicAudit(url, user.email);
    }

    try {
      // ---------------------------------------------------------
      // FASE 1: ESCANEIG TÃˆCNIC (Google Lighthouse)
      // ---------------------------------------------------------
      const scanResult = await this.scanner.scanUrl(url);

      // ---------------------------------------------------------
      // FASE 2: ANÃ€LISI COMERCIAL (IA / Gemini) ğŸ§ 
      // ---------------------------------------------------------
      let suggestions: BusinessSuggestion[] = [];
      try {
        // A. Necessitem el text de la web per a la IA. 
        // Fem un fetch rÃ pid (timeout 5s) per no bloquejar massa.
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(url, { signal: controller.signal });
        clearTimeout(timeoutId);
        
        const html = await response.text();
        // B. Neteja bÃ sica (treure etiquetes HTML per estalviar tokens)
        const textOnly = html.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi, "")
                             .replace(/<style[^>]*>([\s\S]*?)<\/style>/gi, "")
                             .replace(/<[^>]+>/g, ' ')
                             .replace(/\s+/g, ' ')
                             .trim();

        // C. Cridem al nostre nou AIService
        suggestions = await this.aiService.analyzeBusinessOpportunity(url, textOnly);
        
      } catch (err) {
        console.warn("âš ï¸ No s'ha pogut fer l'anÃ lisi IA (continuem igualment):", err);
        // No fem throw, perquÃ¨ volem que l'auditoria tÃ¨cnica es guardi igualment.
      }

      // ---------------------------------------------------------
      // FASE 3: GUARDAR A LA DB
      // ---------------------------------------------------------
      await this.auditRepo.updateStatus(newAudit.id, 'completed', {
        seoScore: scanResult.seoScore,
        performanceScore: scanResult.performanceScore,
        reportData: {
          screenshot: scanResult.screenshot,
          issues: scanResult.issues,
          metrics: scanResult.metrics,
          raw: scanResult.reportData,
          suggestions: suggestions // ğŸ‘ˆ GUARDEM ELS SUGGERIMENTS A JSON
        }
      });

      // ---------------------------------------------------------
      // FASE 4: ENVIAR EMAIL (AMB LA NOVA PLANTILLA)
      // ---------------------------------------------------------
      try {
        await this.emailService.sendAuditResult(user.email, {
          url: url,
          seo: scanResult.seoScore,
          perf: scanResult.performanceScore,
          id: newAudit.id,
          suggestions: suggestions // ğŸ‘ˆ PASSEM ELS SUGGERIMENTS AL EMAIL
        }, locale);
      } catch (emailErr) {
        console.error("Error enviant email:", emailErr);
      }

      return newAudit.id;

    } catch (error) {
      console.error("âŒ Error audit service:", error);
      await this.auditRepo.updateStatus(newAudit.id, 'failed');
      throw new Error("No s'ha pogut completar l'auditoria.");
    }
  }
}

// =================== FILE: src/services/AuthService.ts ===================

import { createClient } from '@/lib/supabase/server';
import { SupabaseProfileRepository } from '@/repositories/supabase/SupabaseProfileRepository';
import { AUTH_ERRORS, mapSupabaseError } from '@/lib/auth/errors';

export class AuthService {
  constructor(private profileRepo: SupabaseProfileRepository) {}

  // ==========================================================
  // 1ï¸âƒ£ LOGIC DE LOGIN (Filtratge per Org)
  // ==========================================================
  async login(formData: FormData, orgId: string) {
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;
    const supabase = await createClient();

    // A. AutenticaciÃ³ TÃ¨cnica (Supabase Global)
    const { error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      return { success: false, error: mapSupabaseError(error.message) };
    }

    // B. AutoritzaciÃ³ de Negoci (La nostra taula Profiles)
    // Comprovem si aquest email tÃ© accÃ©s a l'organitzaciÃ³ actual
    const profile = await this.profileRepo.findByEmailAndOrg(email, orgId);

    if (!profile) {
      // â›” CRÃTIC: EstÃ  loguejat a Supabase, perÃ² no tÃ© perfil en aquesta Org.
      // El fem fora immediatament.
      await supabase.auth.signOut(); 
      return { success: false, error: AUTH_ERRORS.USER_NOT_IN_ORG };
    }

    // âœ… Tot correcte
    return { success: true };
  }

  // ==========================================================
  // 2ï¸âƒ£ LOGIC DE REGISTER (GestiÃ³ Mult-Tenancy)
  // ==========================================================
  async register(formData: FormData, orgId: string) {
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;
    const fullName = formData.get('full_name') as string;
    
    const supabase = await createClient();

    // A. Comprovar si JA existeix en AQUESTA organitzaciÃ³
    const existingLocalProfile = await this.profileRepo.findByEmailAndOrg(email, orgId);
    if (existingLocalProfile) {
      return { success: false, error: AUTH_ERRORS.EMAIL_TAKEN_IN_ORG };
    }

    // B. Intentar crear l'usuari a Supabase (Global)
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          full_name: fullName,
          org_id: orgId, // AixÃ² activarÃ  el trigger de Postgres (si en tens)
          role: 'client'
        }
      }
    });

    // CAS ESPECIAL: L'usuari ja existeix globalment (user retornat, identitats buides o error especÃ­fic)
    if (data.user && data.user.identities && data.user.identities.length === 0) {
       // L'usuari existeix a Auth, perÃ² no en aquesta Org (perquÃ¨ hem passat el check A).
       // ğŸš¨ NO PODEM REGISTRAR-LO DIRECTAMENT PERQUÃˆ NO SABEM LA SEVA CONTRASENYA ANTIGA.
       // SoluciÃ³: El redirigim al login perquÃ¨ posi la seva contrasenya i (idealment) fem el linkatge allÃ .
       // Per ara, li diem que faci login.
       return { 
         success: false, 
         error: AUTH_ERRORS.ACCOUNT_EXISTS_GLOBAL, 
         redirectToLogin: true 
       };
    }

    if (error) {
      return { success: false, error: mapSupabaseError(error.message) };
    }

    return { success: true };
  }
}

// =================== FILE: src/services/ContactService.ts ===================

import { ContactFormData } from '@/lib/validations/contact';
import { SupabaseContactRepository } from '@/repositories/supabase/SupabaseContactRepository';
import { NodemailerAdapter } from '@/adapters/nodemailer/NodemailerAdapter';

export class ContactService {
  // Injectem dependÃ¨ncies al constructor
  constructor(
    private repository: SupabaseContactRepository,
    private mailer: NodemailerAdapter
  ) { }
  private PAGE_SIZE = 10; // ğŸ‘ˆ Constant de negoci
  async processContactForm(data: ContactFormData) {
    // 1. Guardar a DB (Si falla aixÃ², parem i salta error)
    const savedLead = await this.repository.create(data);

    // 2. Enviar Email a l'empresa
    // ConstruÃ¯m l'HTML aquÃ­ o en un helper separat
    const htmlContent = `
      <h2>Nou contacte de: ${data.fullName}</h2>
      <p><strong>Servei:</strong> ${data.service}</p>
      <p><strong>Email:</strong> ${data.email}</p>
      <p><strong>Missatge:</strong><br/>${data.message}</p>
    `;

    // Intentem enviar el correu
    // Posem un try/catch aquÃ­ perquÃ¨ si falla l'email, 
    // NO volem dir-li a l'usuari que ha fallat tot (ja hem guardat el lead)
    try {
      await this.mailer.sendMail({
        to: 'info@digitaistudios.com',
        subject: `ğŸš€ Nou Lead Web: ${data.service}`,
        html: htmlContent
      });
    } catch (emailError) {
      console.error('âš ï¸ Lead guardat perÃ² error enviant email:', emailError);
      // Opcional: Podries guardar un log d'error a DB
    }

    return savedLead;
  }

  async getDashboardLeads(page: number = 1) {
    // Validem que la pÃ gina no sigui negativa
    const currentPage = page < 1 ? 1 : page;

    const result = await this.repository.getPaginated(currentPage, this.PAGE_SIZE);

    return {
      leads: result.data,
      metadata: {
        total: result.total,
        page: currentPage,
        pageSize: this.PAGE_SIZE,
        totalPages: Math.ceil(result.total / this.PAGE_SIZE)
      }
    };
  }
  async getLeadDetails(id: string) {
    return await this.repository.getById(id);

  }
  async deleteLead(id: string) {
    return await this.repository.delete(id);
  }
}

// =================== FILE: src/services/container.ts ===================

// 1. Importem les Classes (els plÃ nols)
import { SupabaseAuditRepository } from '@/repositories/supabase/SupabaseAuditRepository';
import { SupabasePostRepository } from '@/repositories/supabase/SupabasePostRepository';
import { SupabaseAnalyticsRepository } from '@/repositories/supabase/SupabaseAnalyticsRepository';

import { ResendEmailService } from '@/services/email/ResendEmailService';
import { AuditService } from '@/services/AuditService';
import { PostService } from '@/services/PostService';
// ğŸ‘‡ 1. IMPORT NOU
import { AIService } from '@/services/ai/AIService';
import { GooglePageSpeedAdapter } from '@/adapters/GooglePageSpeedAdapter'; // ğŸ‘ˆ El nou adaptador
// ---------------------------------------------------------------------------
// 2. Instanciem els Repositoris (Capa de Dades)
// ---------------------------------------------------------------------------
export const auditRepository = new SupabaseAuditRepository();
export const postRepository = new SupabasePostRepository(); // ğŸ‘ˆ AquÃ­ neix la instÃ ncia
// ğŸ‘‡ Instanciem Analytics
export const analyticsRepository = new SupabaseAnalyticsRepository();
// ---------------------------------------------------------------------------
// 3. Instanciem els Adaptadors (Capa Externa)
// ---------------------------------------------------------------------------
const googleKey = process.env.GOOGLE_PAGESPEED_API_KEY || '';
const webScanner = new GooglePageSpeedAdapter(googleKey);

// ğŸ‘‡ 2. INSTANCIEM EL SERVEI D'EMAIL
export const emailService = new ResendEmailService();
// ---------------------------------------------------------------------------
// ğŸ‘‡ 2. INSTANCIEM EL SERVEI D'INTELÂ·LIGÃˆNCIA ARTIFICIAL
export const aiService = new AIService();
// 4. Instanciem els Serveis (Capa de Negoci)
//    AquÃ­ fem la InjecciÃ³ de DependÃ¨ncies
// ---------------------------------------------------------------------------
// ğŸ‘‡ 3. ARA LI PASSEM ELS 3 ARGUMENTS QUE DEMANA
export const auditService = new AuditService(
  auditRepository,
  webScanner,
  emailService, // <--- AQUEST ERA EL QUE FALTAVA
  aiService // <--- AQUESTA Ã‰S LA PEÃ‡A QUE FALTAVA
);
// El PostService necessita el postRepository per funcionar
export const postService = new PostService(postRepository);


// =================== FILE: src/services/email/ResendEmailService.ts ===================

import { Resend } from 'resend';
import { render } from '@react-email/render';
import AuditReadyEmail from '@/features/email/templates/AuditReadyEmail'; // Assegura't que la ruta Ã©s correcta
import { BusinessSuggestion } from '@/types/ai';

const resend = new Resend(process.env.RESEND_API_KEY);

export class ResendEmailService {

  async sendAuditResult(
    to: string,
    data: {
      url: string,
      seo: number,
      perf: number,
      id: string,
      suggestions?: BusinessSuggestion[] // âœ… AixÃ² ja ho tenies bÃ©
    },
    locale: string
  ) {
    try {
      const lang = locale || 'ca';
      const domain = process.env.NEXT_PUBLIC_APP_URL || 'https://digitaistudios.com';
      
      // âœ… CORRECCIÃ“ 1: Usem 'lang' per crear la URL base. 
      // AixÃ­ el botÃ³ "Veure Informe" anirÃ  a /ca/dashboard o /es/dashboard
      const baseUrlWithLang = `${domain}/${lang}`;

      // 1. GENEREM L'HTML
      const emailHtml = await render(
        AuditReadyEmail({
          businessName: "El teu Negoci", // Podries passar el nom real si el tens a 'data'
          url: data.url,
          seoScore: data.seo,
          perfScore: data.perf,
          auditId: data.id,
          baseUrl: baseUrlWithLang, // ğŸ‘ˆ Passem la URL amb idioma
          suggestions: data.suggestions // âœ… CORRECCIÃ“ 2: Passem els suggeriments al template!
        })
      );

      // 2. ENVIEM EL CORREU
      await resend.emails.send({
        from: 'DigitAI Studios <info@digitaistudios.com>',
        to: [to],
        subject: `ğŸš€ Resultats de l'Auditoria: ${data.url}`,
        html: emailHtml,
      });

      console.log(`ğŸ“§ Email enviat a ${to}`);

    } catch (error) {
      console.error("âŒ Resend Error:", error);
    }
  }
}

// =================== FILE: src/services/factory/DestructionService.ts ===================

import { Octokit } from '@octokit/rest';
import { createClient, SupabaseClient } from '@supabase/supabase-js';

// Definim tipus estrictes per als resultats
export interface DestructionResult {
  vercel: string;
  github: string;
  supabase: string;
  success: boolean;
}

interface ApiError {
  status?: number;
  message?: string;
}

// InterfÃ­cie mÃ­nima per la resposta de Vercel
interface VercelProjectResponse {
  id: string;
  name: string;
}

export class DestructionService {
  private octokit: Octokit;
  private supabase: SupabaseClient;
  
  // Variables d'entorn
  private readonly GITHUB_TOKEN = process.env.GITHUB_ACCESS_TOKEN;
  private readonly TARGET_ORG = process.env.GITHUB_TARGET_ORG;
  private readonly SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
  private readonly SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;
  private readonly VERCEL_TOKEN = process.env.VERCEL_TOKEN;

  constructor() {
    if (!this.GITHUB_TOKEN || !this.SUPABASE_URL || !this.SUPABASE_SERVICE_KEY || !this.VERCEL_TOKEN) {
      throw new Error("âŒ Error Fatal: Falten variables d'entorn al servidor.");
    }

    this.octokit = new Octokit({ auth: this.GITHUB_TOKEN });
    this.supabase = createClient(this.SUPABASE_URL, this.SUPABASE_SERVICE_KEY, {
      auth: { autoRefreshToken: false, persistSession: false }
    });
  }

  // MÃ¨tode principal que orquestra tot
  async destroyClient(repoName: string): Promise<DestructionResult> {
    const vercelLog = await this.destroyVercel(repoName);
    const githubLog = await this.destroyGitHub(repoName);
    const supabaseLog = await this.destroySupabase(repoName);

    return {
      success: true,
      vercel: vercelLog,
      github: githubLog,
      supabase: supabaseLog
    };
  }

  // --- MÃˆTODES PRIVATS (LÃ²gica del teu script adaptada) ---

  private async destroyVercel(name: string): Promise<string> {
    try {
      // 1. Buscar projecte
      const getRes = await fetch(`https://api.vercel.com/v9/projects/${name}`, {
        headers: { 'Authorization': `Bearer ${this.VERCEL_TOKEN}` }
      });

      if (getRes.status === 404) return "ğŸ”¸ No existeix a Vercel.";
      
      // Cast segur
      const project = (await getRes.json()) as VercelProjectResponse;

      // 2. Eliminar projecte
      const delRes = await fetch(`https://api.vercel.com/v9/projects/${project.id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${this.VERCEL_TOKEN}` }
      });

      if (delRes.ok) return "âœ… Eliminat de Vercel.";
      return `âŒ Error Vercel: ${await delRes.text()}`;
    } catch (error: unknown) {
      return `âŒ Error ConnexiÃ³ Vercel: ${this.formatError(error)}`;
    }
  }

  private async destroyGitHub(name: string): Promise<string> {
    try {
      await this.octokit.repos.delete({
        owner: this.TARGET_ORG!,
        repo: name
      });
      return "âœ… Eliminat de GitHub.";
    } catch (error: unknown) {
      const e = error as ApiError; // Type Assertion controlada
      if (e.status === 404) return "ğŸ”¸ No existeix a GitHub.";
      return `âŒ Error GitHub: ${e.message || 'Desconegut'}`;
    }
  }

  private async destroySupabase(slug: string): Promise<string> {
    try {
      // 1. Buscar OrganitzaciÃ³
      const { data: org } = await this.supabase
        .from('organizations')
        .select('id')
        .eq('slug', slug)
        .single();

      if (!org) return "âš ï¸ No s'ha trobat l'organitzaciÃ³ a Supabase.";

      const orgId = org.id;
      
      // 2. Neteja en cascada (Llista del teu script)
      const dependentTables = [
        'order_items', 'orders', 'bookings', 'services', 
        'products', 'posts', 'profiles', 'projects'
      ];

      const logs: string[] = [];

      for (const table of dependentTables) {
        const { error } = await this.supabase
          .from(table)
          .delete()
          .eq('organization_id', orgId);
        
        if (error) logs.push(`Error ${table}: ${error.message}`);
      }

      // 3. Esborrar el pare
      const { error: orgError } = await this.supabase
        .from('organizations')
        .delete()
        .eq('id', orgId);

      if (orgError) return `âŒ Error Fatal Supabase: ${orgError.message}`;
      
      return "âœ… Dades i OrganitzaciÃ³ eliminades.";
    } catch (error: unknown) {
      return `âŒ Error Inesperat Supabase: ${this.formatError(error)}`;
    }
  }

  // Helper per evitar 'any' als catch
  private formatError(error: unknown): string {
    if (error instanceof Error) return error.message;
    return String(error);
  }
}

// =================== FILE: src/services/factory/InfrastrocutreService.ts ===================

import { Octokit } from '@octokit/rest';
import { MasterConfig } from '@/types/config';

export class InfrastructureService {
  // 1. Canviem a propietat privada nullable (Lazy Loading)
  private _octokit: Octokit | null = null;

  constructor() {
    // 2. CONSTRUCTOR BUIT: AixÃ­ no peta en arrencar el servidor/script
  }

  // 3. GETTER MÃ€GIC: Es connecta nomÃ©s quan realment ho necessites
  private get octokit(): Octokit {
    if (!this._octokit) {
      const token = process.env.GITHUB_ACCESS_TOKEN;
      if (!token) throw new Error("âŒ Missing GITHUB_ACCESS_TOKEN: Revisa .env.local");
      this._octokit = new Octokit({ auth: token });
    }
    return this._octokit;
  }

  /**
   * ğŸ›¡ï¸ SANITITZACIÃ“ CRÃTICA
   * Neteja la descripciÃ³ per complir les regles estrictes de GitHub
   */
  private sanitizeGitHubDescription(description: string): string {
    if (!description) return "DigitAI PWA Project";

    return description
      .replace(/[\r\n\t\x00-\x1F\x7F]+/g, " ") // ReemplaÃ§a controls per espais
      .trim()
      .substring(0, 349); // Talla de seguretat
  }

  async createRepository(slug: string, rawDescription: string) {
    console.log(`ğŸ­ [Infra] Clonant repo ${slug}...`);

    const safeDescription = this.sanitizeGitHubDescription(rawDescription);

    try {
      // 'this.octokit' crida al getter automÃ ticament
      const { data } = await this.octokit.repos.createUsingTemplate({
        template_owner: process.env.GITHUB_TEMPLATE_OWNER!,
        template_repo: process.env.GITHUB_TEMPLATE_REPO!,
        owner: process.env.GITHUB_TARGET_ORG!, // O GITHUB_ORG segons el teu env
        name: slug,
        private: false, // ğŸ”’ Recomanat TRUE per defecte (abans tenies false)
        description: safeDescription,
        include_all_branches: false
      });

      return { id: data.id, html_url: data.html_url };
    } catch (error: unknown) {
      const errorMessage = error instanceof Error ? error.message : "Unknown GitHub Error";
      console.error(`âŒ [GitHub] Error creant repo: ${errorMessage}`);
      throw new Error(`GitHub Create Failed: ${errorMessage}`);
    }
  }

  async waitForRepoReady(slug: string, attempts = 20): Promise<boolean> {
    const owner = process.env.GITHUB_TARGET_ORG || process.env.GITHUB_ORG!;

    for (let i = 0; i < attempts; i++) {
      try {
        await this.octokit.repos.getContent({
          owner,
          repo: slug,
          path: 'package.json'
        });
        return true;
      } catch (e: unknown) {
        console.log(e)
        // Ignorem l'error mentre esperem
        console.log(`â³ [Infra] Esperant GitHub... (${i + 1}/${attempts})`);
        await new Promise(r => setTimeout(r, 4000));
      }
    }
    return false;
  }

  async uploadLogo(slug: string, file: File) {
    if (!file || file.size === 0) return;

    try {
      const arrayBuffer = await file.arrayBuffer();
      const buffer = Buffer.from(arrayBuffer);
      const owner = process.env.GITHUB_TARGET_ORG || process.env.GITHUB_ORG!;
      const path = 'public/branding/logo.png';

      let sha: string | undefined;
      try {
        const { data } = await this.octokit.repos.getContent({ owner, repo: slug, path });
        if (!Array.isArray(data)) {
          sha = data.sha;
        }
      } catch (e) {
           console.log(e)
        // Ignorem si no existeix
      }

      await this.octokit.repos.createOrUpdateFileContents({
        owner,
        repo: slug,
        path,
        message: 'branding: update logo',
        content: buffer.toString('base64'),
        sha,
        committer: { name: 'DigitAI Bot', email: 'bot@digitai.studios' },
        author: { name: 'DigitAI Bot', email: 'bot@digitai.studios' }
      });
      console.log(`ğŸ–¼ï¸ [Infra] Logo pujat correctament.`);
    } catch (error: unknown) {
      console.error("âš ï¸ [Infra] Error pujant logo (no crÃ­tic):", error);
    }
  }

  // MÃ¨tode Legacy (per compatibilitat, tot i que usarem commitFiles)
  async injectConfig(slug: string, config: MasterConfig) {
    const configContent = `
import { MasterConfig } from '@/types/config';

export const CONFIG: MasterConfig = ${JSON.stringify(config, null, 2)};
`;
    const owner = process.env.GITHUB_TARGET_ORG || process.env.GITHUB_ORG!;
    const path = 'src/config/digitai.config.ts';

    let sha: string | undefined;
    try {
      const { data } = await this.octokit.repos.getContent({ owner, repo: slug, path });
      if (!Array.isArray(data)) sha = data.sha;
    } catch (e) { console.log(e) }

    try {
      await this.octokit.repos.createOrUpdateFileContents({
        owner,
        repo: slug,
        path,
        message: 'setup: inject configuration',
        content: Buffer.from(configContent).toString('base64'),
        sha,
        committer: { name: 'DigitAI Bot', email: 'bot@digitai.studios' },
        author: { name: 'DigitAI Bot', email: 'bot@digitai.studios' }
      });
      console.log(`âš™ï¸ [Infra] Config injectada.`);
    } catch (error: unknown) {
      const msg = error instanceof Error ? error.message : "Unknown Error";
      throw new Error(`Config Injection Failed: ${msg}`);
    }
  }

  async deployToVercel(slug: string, orgId: string, repoId: number) {
    console.log(`ğŸš€ [Infra] Desplegant a Vercel...`);

    const VERCEL_TOKEN = process.env.VERCEL_TOKEN!;

    const envVars: Record<string, string> = {
      NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL || "",
      NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || "",
      NEXT_PUBLIC_ORG_ID: orgId,
    };

    if (process.env.CLIENT_RESEND_API_KEY) envVars['RESEND_API_KEY'] = process.env.CLIENT_RESEND_API_KEY;
    if (process.env.CLIENT_GEMINI_API_KEY) envVars['GEMINI_API_KEY'] = process.env.CLIENT_GEMINI_API_KEY;
    if (process.env.CLIENT_STRIPE_SECRET_KEY) envVars['STRIPE_SECRET_KEY'] = process.env.CLIENT_STRIPE_SECRET_KEY;
    if (process.env.CLIENT_STRIPE_WEBHOOK_SECRET) envVars['STRIPE_WEBHOOK_SECRET'] = process.env.CLIENT_STRIPE_WEBHOOK_SECRET;

    const createRes = await fetch('https://api.vercel.com/v9/projects', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${VERCEL_TOKEN}` },
      body: JSON.stringify({
        name: slug,
        framework: 'nextjs',
        gitRepository: { type: 'github', repo: `${process.env.GITHUB_TARGET_ORG || process.env.GITHUB_ORG}/${slug}` },
        environmentVariables: Object.entries(envVars).map(([key, value]) => ({
          key, value, target: ['production', 'preview', 'development'], type: 'encrypted'
        })),
      })
    });

    if (!createRes.ok) {
      const err = await createRes.json() as { error?: { code: string, message: string } };
      if (err.error?.code === 'project_already_exists') {
        console.warn(`âš ï¸ [Vercel] El projecte '${slug}' ja existeix. Continuem amb el deploy.`);
      } else {
        throw new Error(`Error Vercel Create: ${err.error?.message}`);
      }
    }

    const deployRes = await fetch('https://api.vercel.com/v13/deployments', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${VERCEL_TOKEN}` },
      body: JSON.stringify({
        name: slug,
        gitSource: { type: 'github', repoId: repoId, ref: 'main' },
        projectSettings: { framework: 'nextjs' }
      })
    });

    if (!deployRes.ok) {
      const err = await deployRes.json() as { error?: { message: string } };
      throw new Error(`Error Vercel Deploy: ${err.error?.message}`);
    }

    console.log(`âœ… [Infra] Desplegament iniciat a Vercel.`);
  }

  /**
   * âœ… NOU MÃˆTODE: Puja mÃºltiples fitxers al GitHub d'una tacada.
   */
  async commitFiles(slug: string, files: Record<string, string>): Promise<void> {
    const owner = process.env.GITHUB_ORG || process.env.GITHUB_TARGET_ORG;
    if (!owner) throw new Error("GITHUB_ORG no definit");

    console.log(`ğŸ“¦ [INFRA] Pujant ${Object.keys(files).length} fitxers al repo: ${slug}...`);

    for (const [path, content] of Object.entries(files)) {
      try {
        let sha: string | undefined;
        try {
          const { data } = await this.octokit.repos.getContent({
            owner,
            repo: slug,
            path,
          });
          if (!Array.isArray(data) && data.sha) {
            sha = data.sha;
          }
        } catch (e) {
             console.log(e)
          // Ignorem 404
        }

        await this.octokit.repos.createOrUpdateFileContents({
          owner,
          repo: slug,
          path,
          message: `feat(factory): update ${path} generated by AI`,
          content: Buffer.from(content).toString('base64'),
          sha,
        });

        console.log(`   âœ… Fitxer creat: ${path}`);
      } catch (error) {
        console.error(`   âŒ Error pujant ${path}:`, error);
        throw new Error(`Error escrivint al GitHub: ${path}`);
      }
    }
  }
}

// =================== FILE: src/services/GamificationService.ts ===================

import { createClient } from '@/lib/supabase/server';

export type MissionStats = {
    total: number;
    passed: number;
    failed: number;
    blocked: number;
    pending: number;
    progress: number;
    xpReward: number;
};

// Tipus de retorn per a les estadÃ­stiques d'usuari
export type UserGamificationStats = {
    xp: number;
    level: number;
    completedTasks: number;
    nextLevelXp: number;
    progressToNext: number;
    rankName: string; // NomÃ©s el text (ex: "Novell")
};

export class GamificationService {
    
    async getUserStats(userId: string): Promise<UserGamificationStats> {
        const supabase = await createClient();
        
        const { count } = await supabase
            .from('test_results')
            .select('*', { count: 'exact', head: true })
            .eq('user_id', userId)
            .eq('status', 'pass');

        const completedTasks = count || 0;
        const xp = completedTasks * 100;
        const level = Math.floor(xp / 1000) + 1;
        const nextLevelXp = level * 1000;
        
        // Evitem divisiÃ³ per zero si estem al nivell 1 amb 0 XP
        const progressToNext = nextLevelXp > 0 
            ? ((xp % 1000) / 1000) * 100 
            : 0;

        return {
            xp,
            level,
            completedTasks,
            nextLevelXp,
            progressToNext,
            rankName: this.getRankName(level)
        };
    }

    calculateMissionStats(totalTasks: number, userResults: { status: string }[]): MissionStats {
        const passed = userResults.filter(r => r.status === 'pass').length;
        const failed = userResults.filter(r => r.status === 'fail').length;
        const blocked = userResults.filter(r => r.status === 'blocked').length;
        const pending = totalTasks - (passed + failed + blocked);
        
        const progress = totalTasks > 0 ? Math.round((passed / totalTasks) * 100) : 0;
        const xpReward = totalTasks * 100;

        return { total: totalTasks, passed, failed, blocked, pending, progress, xpReward };
    }

    // Retornem nomÃ©s la CLAU del rang, les icones les posarÃ  el Frontend
    private getRankName(level: number): string {
        if (level < 2) return "Novell";
        if (level < 5) return "Bug Hunter";
        if (level < 10) return "Expert";
        return "Mestre";
    }
}

// =================== FILE: src/services/ImageService.ts ===================

import { I18nSchema } from "@/types/i18n";

export class ImageService {
  
  /**
   * Recorre tot l'objecte JSON i enriqueix les propietats 'image' i 'avatar'
   * utilitzant els prompts generats per la IA.
   */
  public enrichWithImages(data: I18nSchema): I18nSchema {
    console.log("ğŸ¨ [ImageService] Generant URLs visuals...");

    // 1. Hero Section
    if (data.hero.image_prompt) {
      data.hero.image = this.generateImageUrl(data.hero.image_prompt, "1920", "1080");
    }

    // 2. About Section
    if (data.about.image_prompt) {
      data.about.image = this.generateImageUrl(data.about.image_prompt, "800", "600");
    }

    // 3. Testimonials (Avatars)
    if (data.testimonials && Array.isArray(data.testimonials.reviews)) {
      data.testimonials.reviews.forEach((review, index) => {
          // Normalitzem el gÃ¨nere
          const gender = review.avatar_gender === 'female' ? 'women' : 'men';
          // ID determinista perquÃ¨ no canviÃ¯ a cada render en el futur
          const id = 20 + index; 
          
          // AssignaciÃ³ segura (grÃ cies a l'update de I18nSchema)
          review.avatar = `https://randomuser.me/api/portraits/${gender}/${id}.jpg`;
      });
    }

    return data;
  }

  /**
   * Genera una URL d'imatge sintÃ¨tica o d'estoc basada en keywords.
   * Utilitza Pollinations.ai (molt rÃ pid i estable per a demos/MVP).
   */
  private generateImageUrl(prompt: string, width: string, height: string): string {
    // Netegem el prompt per fer-lo segur a la URL
    const safePrompt = encodeURIComponent(prompt.trim());
    
    // Retornem la URL llesta per consumir
    return `https://image.pollinations.ai/prompt/${safePrompt}?width=${width}&height=${height}&nologo=true&model=flux`;
  }
}

// =================== FILE: src/services/PostService.ts ===================

import { IPostRepository } from '@/repositories/interfaces/IPostRepository';
import { BlogPostDTO } from '@/types/models';
import { cache } from 'react'; // ğŸ‘ˆ IMPORT IMPORTANT

export class PostService {
  private PAGE_SIZE = 9; // ğŸ‘ˆ 9 posts (Grid 3x3 perfecte)
  constructor(private postRepo: IPostRepository) {
    // Envoltem el mÃ¨tode original amb la cache de React
    this.getPost = cache(this.getPost.bind(this)); 
  }

  async getPost(slug: string): Promise<BlogPostDTO | null> {
    return this.postRepo.getPostBySlug(slug);
  }

  async getLatestPosts(): Promise<BlogPostDTO[]> {
    return this.postRepo.getAllPublishedPosts();
  }

  // ğŸ‘‡ MÃ¨todes Admin
  async getAllPostsForAdmin(): Promise<BlogPostDTO[]> {
    return this.postRepo.getAllPosts();
  }

  async updatePost(slug: string, data: Partial<BlogPostDTO>): Promise<void> {
    return this.postRepo.updatePost(slug, data);
  }

  async deletePost(slug: string): Promise<void> {
    return this.postRepo.deletePost(slug);
  }

  async getAdminPost(slug: string): Promise<BlogPostDTO | null> {
    // Sense cache, volem dades fresques a l'admin
    return this.postRepo.getAdminPostBySlug(slug);
  }

  // ğŸ‘‡ NOU MÃˆTODE QUE UTILITZARÃ€ LA PÃ€GINA
  async getPublicBlogPosts(page: number = 1) {
    const currentPage = page < 1 ? 1 : page;

    // Cridem al repositori nou
    const { posts, total } = await this.postRepo.getPublishedPostsPaginated(currentPage, this.PAGE_SIZE);

    return {
      posts,
      metadata: {
        total,
        page: currentPage,
        pageSize: this.PAGE_SIZE,
        totalPages: Math.ceil(total / this.PAGE_SIZE)
      }
    };
  }
  
}

// =================== FILE: src/services/publishers/facebook.ts ===================

import { createClient } from '@/lib/supabase/server';
import { getMediaType } from '@/lib/utils/media';

export class FacebookPublisher {
  static async publish(content: string, link?: string, mediaUrl?: string) {
    console.log("ğŸ” FACEBOOK PUBLISHER REBUT URL:", mediaUrl);

    let pageId: string | undefined | null = process.env.FACEBOOK_PAGE_ID;
    let accessToken: string | undefined | null = process.env.FACEBOOK_ACCESS_TOKEN;

    // 1ï¸âƒ£ ESTRATÃˆGIA HÃBRIDA (BUSCAR A LA DB SI EL ENV FALLA)
    if (!pageId || !accessToken) {
        console.log("âš ï¸ No hi ha credencials al .env, buscant a Supabase...");
        
        const supabase = await createClient();
        
        // A. Obtenim l'usuari actual
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("âŒ CRÃTIC: No hi ha usuari loguejat.");

        // B. ğŸ‘‡ CANVI CLAU: Obtenim TOTS els perfils (totes les teves organitzacions)
        const { data: profiles } = await supabase.from('profiles')
            .select('organization_id')
            .eq('id', user.id); // Sense .single() perquÃ¨ pots tenir-ne molts!
        
        if (!profiles || profiles.length === 0) {
            throw new Error(`âŒ L'usuari ${user.id} no pertany a cap organitzaciÃ³.`);
        }

        // Extraiem la llista d'IDs (ex: ['org_1', 'org_2'])
        const orgIds = profiles.map(p => p.organization_id);
        console.log(`ğŸ¢ L'usuari pertany a ${orgIds.length} organitzacions. Buscant Facebook...`);

        // C. ğŸ‘‡ Busquem quina d'aquestes organitzacions tÃ© Facebook connectat
        const { data: creds } = await supabase.from('social_connections')
            .select('*')
            .in('organization_id', orgIds) // Busquem DINS de la llista d'orgs
            .eq('provider', 'facebook')
            .maybeSingle(); // Agafem la primera que trobem que tingui FB
        
        if (!creds) throw new Error("Cap de les teves organitzacions tÃ© Facebook connectat a la DB.");

        console.log(`âœ… ConnexiÃ³ trobada a l'organitzaciÃ³: ${creds.organization_id}`);

        pageId = creds.provider_page_id;
        accessToken = creds.access_token;
    } else {
        console.log("âœ… Usant credencials de FACEBOOK del fitxer .env");
    }

    // ComprovaciÃ³ final
    if (!pageId || !accessToken) {
        throw new Error("No s'han pogut resoldre les credencials de Facebook.");
    }

    // ---------------------------------------------------------
    // ğŸš€ LÃ’GICA DE PUBLICACIÃ“ (AixÃ² es mantÃ© igual)
    // ---------------------------------------------------------
    const finalMessage = link ? `${content}\n\nâ€”\nğŸš€ Vols saber-ne mÃ©s? Llegeix l'article complet aquÃ­:\nğŸ‘‰ ${link}` : content;

    if (mediaUrl) {
      console.log(`ğŸ“¥ Baixant imatge...`);
      const imgRes = await fetch(mediaUrl).catch(err => { throw new Error(`Error network: ${err.message}`) });
      
      if (!imgRes.ok) throw new Error(`Error descarregant imatge (${imgRes.status})`);
      const imgBlob = await imgRes.blob();
      console.log(`âš–ï¸ Mida imatge: ${imgBlob.size} bytes`);

      const formData = new FormData();
      formData.append('access_token', accessToken!); 

      const type = getMediaType(mediaUrl);

      if (type === 'VIDEO') {
        const endpoint = `https://graph.facebook.com/v19.0/${pageId}/videos`;
        formData.append('description', finalMessage);
        formData.append('file', imgBlob, 'video.mp4');
        
        const res = await fetch(endpoint, { method: 'POST', body: formData });
        return handleResponse(res);

      } else {
        const endpoint = `https://graph.facebook.com/v19.0/${pageId}/photos`;
        formData.append('caption', finalMessage);
        formData.append('source', imgBlob, 'image.jpg');
        formData.append('published', 'true');

        const res = await fetch(endpoint, { method: 'POST', body: formData });
        return handleResponse(res);
      }
    } else {
      console.log("ğŸ“ Publicant nomÃ©s text...");
      const endpoint = `https://graph.facebook.com/v19.0/${pageId}/feed`;
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ access_token: accessToken, message: finalMessage }),
      });
      return handleResponse(res);
    }
  }
}

async function handleResponse(response: Response) {
  const data = await response.json();
  if (data.error) throw new Error(`FB Error: ${data.error.message}`);
  return data.id || data.post_id;
}

// =================== FILE: src/services/publishers/instagram.ts ===================

import { createClient } from '@/lib/supabase/server';
import { getMediaType } from '@/lib/utils/media';

interface InstaContainerPayload {
  access_token: string;
  caption: string;
  media_type: 'IMAGE' | 'VIDEO';
  image_url?: string;
  video_url?: string;
}

export class InstagramPublisher {
  static async publish(content: string, link?: string, mediaUrl?: string) {
    if (!mediaUrl) throw new Error("Instagram necessita obligatÃ²riament una imatge o vÃ­deo.");

    console.log(`ğŸ“¸ INSTAGRAM PUBLISHER REBUT URL:`, mediaUrl);

    // FIX: Variables d'entorn
    let instagramUserId: string | undefined | null = process.env.INSTAGRAM_BUSINESS_ID; // Nou al .env
    let accessToken: string | undefined | null = process.env.FACEBOOK_ACCESS_TOKEN; // FB Token serveix per Insta

    // 1ï¸âƒ£ ESTRATÃˆGIA HÃBRIDA
    if (!instagramUserId || !accessToken) {
        console.log("âš ï¸ No hi ha credencials INSTAGRAM al .env, buscant a Supabase...");
        
        const supabase = await createClient();
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("âŒ CRÃTIC: No hi ha usuari loguejat.");

        // Obtenim TOTS els perfils
        const { data: profiles } = await supabase.from('profiles')
            .select('organization_id')
            .eq('id', user.id); 
        
        if (!profiles || profiles.length === 0) throw new Error(`âŒ L'usuari ${user.id} no tÃ© perfils.`);

        const orgIds = profiles.map(p => p.organization_id);

        // Busquem connexiÃ³ FB (Insta estÃ  dins de FB)
        const { data: creds } = await supabase.from('social_connections')
            .select('*')
            .in('organization_id', orgIds)
            .eq('provider', 'facebook') // Instagram via Facebook
            .maybeSingle();
        
        if (!creds || !creds.provider_page_id) throw new Error("No hi ha connexiÃ³ amb Facebook/Instagram a la DB.");

        // Busquem l'ID d'Instagram Business associat a la pÃ gina
        console.log("ğŸ” Buscant compte d'Instagram vinculat a la pÃ gina de Facebook...");
        const igAccountRes = await fetch(`https://graph.facebook.com/v19.0/${creds.provider_page_id}?fields=instagram_business_account&access_token=${creds.access_token}`);
        const igData = await igAccountRes.json();
        
        instagramUserId = igData.instagram_business_account?.id;
        accessToken = creds.access_token;
    }

    if (!instagramUserId || !accessToken) throw new Error("No s'ha pogut obtenir l'ID d'Instagram.");

    console.log(`âœ… ID Instagram: ${instagramUserId}`);
    const mediaType = getMediaType(mediaUrl);

    // --- TEXT FINAL ---
    const finalCaption = link ? `${content}\n\nğŸ”— Link a la Bio o copia aquÃ­:\n${link}` : content;

    // --- PAS 1: Crear Contenidor ---
    const createMediaUrl = `https://graph.facebook.com/v19.0/${instagramUserId}/media`;
    
    const containerBody: InstaContainerPayload = {
      caption: finalCaption, 
      access_token: accessToken,
      media_type: mediaType 
    };

    if (mediaType === 'VIDEO') {
      containerBody.video_url = mediaUrl;
    } else {
      containerBody.image_url = mediaUrl;
    }
    
    const containerRes = await fetch(createMediaUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(containerBody)
    });

    const containerData = await containerRes.json();
    if (containerData.error) throw new Error(`Error Insta Container: ${containerData.error.message}`);
    
    const creationId = containerData.id;

    // --- PAS 1.5: POLLING ---
    let isReady = false;
    let attempts = 0;
    const maxAttempts = 20;

    while (!isReady && attempts < maxAttempts) {
      attempts++;
      console.log(`â³ Processant media Instagram (${attempts}/${maxAttempts})...`);
      await new Promise(resolve => setTimeout(resolve, 2000));

      const statusUrl = `https://graph.facebook.com/v19.0/${creationId}?fields=status_code&access_token=${accessToken}`;
      const statusRes = await fetch(statusUrl);
      const statusData = await statusRes.json();

      if (statusData.status_code === 'FINISHED') isReady = true;
      else if (statusData.status_code === 'ERROR') throw new Error("Instagram ha fallat al processar.");
    }

    if (!isReady) throw new Error("Timeout: Instagram ha trigat massa.");

    // --- PAS 2: Publicar ---
    console.log("ğŸš€ Publicant post definitiu...");
    const publishUrl = `https://graph.facebook.com/v19.0/${instagramUserId}/media_publish`;
    const publishRes = await fetch(publishUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        creation_id: creationId,
        access_token: accessToken
      })
    });
    
    const publishData = await publishRes.json();
    if (publishData.error) throw new Error(`Error Insta Publish: ${publishData.error.message}`);

    return publishData.id;
  }
}

// =================== FILE: src/services/publishers/linkedin.ts ===================

import { createClient } from '@/lib/supabase/server';
import { getMediaType } from '@/lib/utils/media';

interface LinkedInRegisterRequest {
  registerUploadRequest: {
    recipes: string[];
    owner: string;
    serviceRelationships: { relationshipType: "OWNER"; identifier: "urn:li:userGeneratedContent" }[];
  };
}

interface LinkedInRegisterResponse {
  value: {
    asset: string;
    uploadMechanism: {
      "com.linkedin.digitalmedia.uploading.MediaUploadHttpRequest": {
        uploadUrl: string;
        headers: Record<string, string>;
      };
    };
  };
}

export class LinkedInPublisher {
  static async publish(content: string, link?: string, mediaUrl?: string) {
    console.log("ğŸš€ Iniciant LinkedIn Publisher...");

    // FIX: Variables d'entorn
    let accessToken: string | undefined | null = process.env.LINKEDIN_ACCESS_TOKEN;
    let authorUrn: string | undefined | null = process.env.LINKEDIN_PERSON_URN; // ex: urn:li:person:12345

    // 1ï¸âƒ£ ESTRATÃˆGIA HÃBRIDA
    if (!accessToken || !authorUrn) {
        console.log("âš ï¸ No hi ha credencials LINKEDIN al .env, buscant a Supabase...");
        
        const supabase = await createClient();
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("No user");

        const { data: profiles } = await supabase.from('profiles').select('organization_id').eq('id', user.id);
        if (!profiles || profiles.length === 0) throw new Error("Perfil no trobat");

        const orgIds = profiles.map(p => p.organization_id);

        const { data: creds } = await supabase
            .from('social_connections')
            .select('*')
            .in('organization_id', orgIds)
            .eq('provider', 'linkedin')
            .maybeSingle();

        if (!creds) throw new Error("LinkedIn no estÃ  connectat a la DB.");

        accessToken = creds.access_token;
        const isOrg = creds.provider_page_id && !isNaN(Number(creds.provider_page_id));
        authorUrn = `urn:li:${isOrg ? 'organization' : 'person'}:${creds.provider_page_id || creds.provider_account_id}`;
    }

    if (!accessToken || !authorUrn) throw new Error("No s'ha pogut obtenir accÃ©s a LinkedIn.");

    console.log(`âœ… Publicant com a: ${authorUrn}`);

    // --- CONTINGUT ---
    const finalContent = link ? `${content}\n\nâ€”\nğŸš€ Vols saber-ne mÃ©s? Llegeix l'article complet aquÃ­:\nğŸ‘‰ ${link}` : content;

    let assetUrn: string | undefined = undefined;

    // --- PAS 1: PUJADA D'IMATGE (ASSET) ---
    if (mediaUrl && getMediaType(mediaUrl) === 'IMAGE') {
        console.log("ğŸ“¥ Descarregant imatge...");
        const imageRes = await fetch(mediaUrl);
        if (!imageRes.ok) throw new Error("Error baixant imatge");
        const imageBlob = await imageRes.blob();

        // 1. Registrar
        console.log("1ï¸âƒ£ Registrant Upload...");
        const registerBody: LinkedInRegisterRequest = {
            registerUploadRequest: {
                recipes: ["urn:li:digitalmediaRecipe:feedshare-image"],
                owner: authorUrn,
                serviceRelationships: [{ relationshipType: "OWNER", identifier: "urn:li:userGeneratedContent" }]
            }
        };

        const regRes = await fetch('https://api.linkedin.com/v2/assets?action=registerUpload', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(registerBody)
        });

        const regData: LinkedInRegisterResponse = await regRes.json();
        if (!regData.value) throw new Error("Error registrant asset a LinkedIn");
        
        const uploadUrl = regData.value.uploadMechanism['com.linkedin.digitalmedia.uploading.MediaUploadHttpRequest'].uploadUrl;
        assetUrn = regData.value.asset;

        // 2. Pujar Binari
        console.log("2ï¸âƒ£ Pujant bytes...");
        await fetch(uploadUrl, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/octet-stream' },
            body: imageBlob
        });

        // 3. ESPERAR QUE ESTIGUI LLESTA (POLLING)
        let isReady = false;
        let attempts = 0;
        console.log("â³ Esperant processament de LinkedIn...");
        
        while (!isReady && attempts < 10) { 
            await new Promise(r => setTimeout(r, 2000));
            attempts++;
            
            const statusRes = await fetch(`https://api.linkedin.com/v2/assets/${assetUrn}`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const statusData = await statusRes.json();
            
            if (statusData.recipes?.[0]?.status === 'AVAILABLE') {
                isReady = true;
                console.log("âœ… Imatge processada i llesta!");
            }
        }
    }

    // --- PAS 2: CREAR POST ---
    console.log("3ï¸âƒ£ Publicant Post...");

    const requestBody = {
      author: authorUrn,
      lifecycleState: 'PUBLISHED',
      specificContent: {
        'com.linkedin.ugc.ShareContent': {
          shareCommentary: { text: finalContent },
          shareMediaCategory: assetUrn ? 'IMAGE' : 'NONE',
          media: assetUrn ? [{
            status: 'READY',
            description: { text: 'Image' },
            media: assetUrn, 
            title: { text: 'Image' }
          }] : undefined
        },
      },
      visibility: { 'com.linkedin.ugc.MemberNetworkVisibility': 'PUBLIC' },
    };

    const response = await fetch('https://api.linkedin.com/v2/ugcPosts', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json', 'X-Restli-Protocol-Version': '2.0.0' },
      body: JSON.stringify(requestBody),
    });

    if (!response.ok) {
        const err = await response.json();
        if (response.status === 400 && JSON.stringify(err).includes("duplicate")) {
            console.warn("âš ï¸ Post duplicat, ignorant error.");
            return "DUPLICATE_IGNORED";
        }
        throw new Error(`LinkedIn Error: ${err.message}`);
    }

    const data = await response.json();
    return data.id; 
  }
}

// =================== FILE: src/services/social-generator.ts ===================

import { GoogleGenAI } from "@google/genai";

interface SocialContent {
  linkedin: { content: string };
  facebook: { content: string };
  instagram: { content: string };
}

export class SocialGeneratorService {
  static async generateFromPost(title: string, postContent: string): Promise<SocialContent> {
    
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) throw new Error("Manca la GEMINI_API_KEY al fitxer .env");

    // 1. Inicialitzem amb la NOVA llibreria (igual que AIService)
    const genAI = new GoogleGenAI({ apiKey });
    
    // Model que sabem que funciona bÃ© amb JSON
    const modelName = "gemini-2.5-flash"; 

    const prompt = `
      Ets un Expert en Copywriting persuasiu.
      Objectiu: Aconseguir CLICS cap al blog. No expliquis tot l'article, crea intriga.

      TÃTOL: "${title}"
      RESUM: "${postContent.substring(0, 4000)}"

      ğŸ›‘ REGLES D'OR (BREVETAT I MISTERI):
      1. MÃ€XIM 3-4 FRASES per post. Sigues concÃ­s.
      2. No donis la soluciÃ³ final, nomÃ©s planteja el problema i promet la soluciÃ³ al link.
      3. ComenÃ§a amb una pregunta o dada xocant.
      4. Idioma: CATALÃ€.
      5. NO posis el link (s'afegeix automÃ ticament desprÃ©s).

      ğŸ¯ ESTRATÃˆGIA PER PLATAFORMA:
      - LinkedIn: Professional perÃ² intrigant.
      - Facebook: Curiositat pura.
      - Instagram: Frase curta + Emojis + Hashtags.

      OUTPUT: Retorna JSON pur seguint l'esquema.
    `;

    // 2. Definim l'esquema estricte (AixÃ­ evitem errors de parseig)
    const schema = {
        type: "OBJECT",
        properties: {
            linkedin: { type: "OBJECT", properties: { content: { type: "STRING" } } },
            facebook: { type: "OBJECT", properties: { content: { type: "STRING" } } },
            instagram: { type: "OBJECT", properties: { content: { type: "STRING" } } }
        },
        required: ["linkedin", "facebook", "instagram"]
    };

    try {
        console.log(`ğŸ¤– Generant Social Media amb ${modelName}...`);

        // 3. Crida a l'API amb la sintaxi nova
        const response = await genAI.models.generateContent({
            model: modelName,
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            config: {
                responseMimeType: "application/json",
                responseSchema: schema,
                temperature: 0.7
            }
        });

        const text = response.text;
        if (!text) throw new Error("Resposta buida de Gemini");

        // 4. Retornem el JSON parsejat (ja validat per l'esquema)
        return JSON.parse(text) as SocialContent;

    } catch (error: unknown) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        console.error(`âš ï¸ Error generant Social Content: ${errorMessage}`);
        
        // Fallback d'emergÃ¨ncia
        return {
            linkedin: { content: `Nou article disponible: ${title}. Llegeix-lo ara!` },
            facebook: { content: `No us perdeu el nostre nou post: ${title}.` },
            instagram: { content: `Nou post! ğŸš€ ${title} #blog #novetat` }
        };
    }
  }
}

// =================== FILE: src/services/social-publisher.ts ===================

import { LinkedInPublisher } from './publishers/linkedin';
import { FacebookPublisher } from './publishers/facebook';
import { InstagramPublisher } from './publishers/instagram';

type PublishPayload = {
    platform: 'linkedin' | 'facebook' | 'instagram';
    content: string;
    mediaUrl?: string | null;
    link?: string;
};

export class SocialPublisherService {
    static async publish(payload: PublishPayload) {
        console.log(`ğŸš€ SocialService: Enrutant cap a ${payload.platform}...`);
        console.log(`ğŸ“¦ Payload Media: ${payload.mediaUrl ? payload.mediaUrl : 'CAP'}`);

        let externalId = '';

        try {
            switch (payload.platform) {
                case 'linkedin':
                    // âš ï¸ CORRECCIÃ“: Passem el 3r argument (mediaUrl)
                    externalId = await LinkedInPublisher.publish(
                        payload.content,
                        payload.link,
                        payload.mediaUrl || undefined
                    );
                    break;

                case 'facebook':
                    // âš ï¸ CORRECCIÃ“ CRÃTICA: AquÃ­ faltava passar payload.mediaUrl !!
                    externalId = await FacebookPublisher.publish(
                        payload.content,
                        payload.link,
                        payload.mediaUrl || undefined // <--- AQUESTA ERA LA PEÃ‡A QUE FALTAVA
                    );
                    break;

                case 'instagram':
                    if (!payload.mediaUrl) throw new Error("Instagram requereix imatge.");

                    // ABANS: externalId = await InstagramPublisher.publish(payload.content, payload.mediaUrl);

                    // ARA: Li passem tambÃ© el link
                    externalId = await InstagramPublisher.publish(
                        payload.content,
                        payload.link,
                        payload.mediaUrl
                    );
                    break;

                default:
                    throw new Error(`Plataforma ${payload.platform} no suportada.`);
            }

            return { success: true, externalId };

        } catch (error: unknown) {
            console.error(`âŒ Error al servei ${payload.platform}:`, error);
            throw error;
        }
    }
}

// =================== FILE: src/services/TenantService.ts ===================

import { createAdminClient } from '@/lib/supabase/server';
import { Database, Json } from '@/types/database.types'; // ğŸ‘ˆ Importem 'Json'

// Helpers de tipus
type TableInsert<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Insert'];
type UserRole = Database['public']['Enums']['user_role'];

export class TenantService {
    private supabase = createAdminClient();

    async createTenantStructure(data: {
        businessName: string;
        slug: string;
        repoUrl: string;
        branding: Record<string, unknown>;
        creatorUserId: string;
        creatorEmail: string;
    }) {
        console.log(`ğŸ—ï¸ [Tenant] 1. Iniciant procÃ©s per: ${data.slug}`);

        // ---------------------------------------------------------
        // PAS 1: ORGANITZACIÃ“
        // ---------------------------------------------------------
        let org;

        const orgPayload: TableInsert<'organizations'> = {
            name: data.businessName,
            slug: data.slug,
        };

        const { data: newOrg, error: orgError } = await this.supabase
            .from('organizations')
            .insert(orgPayload)
            .select()
            .single();

        if (orgError) {
            if (orgError.code === '23505') {
                console.warn(`âš ï¸ [Tenant] L'Org ja existeix. Recuperant...`);
                const { data: existingOrg } = await this.supabase
                    .from('organizations')
                    .select('*')
                    .eq('slug', data.slug)
                    .single();

                if (!existingOrg) throw new Error("No s'ha pogut recuperar l'org existent.");
                org = existingOrg;
            } else {
                throw new Error(`Error DB Org: ${orgError.message}`);
            }
        } else {
            org = newOrg;
            console.log(`âœ… [Tenant] OrganitzaciÃ³ creada: ${org.id}`);
        }

        // ---------------------------------------------------------
        // PAS 2: PERFIL (Imprescindible abans del projecte)
        // ---------------------------------------------------------
        console.log(`ğŸ—ï¸ [Tenant] 2. Assegurant Perfil...`);

        // Assegura't que 'admin' existeix al teu enum SQL. Si no, posa 'lead'.
        const role: UserRole = 'admin';

        const profilePayload: TableInsert<'profiles'> = {
            id: data.creatorUserId,
            organization_id: org.id,
            email: data.creatorEmail,
            role: role,
            full_name: data.businessName,
        };

        const { error: profileError } = await this.supabase
            .from('profiles')
            .upsert(profilePayload, { onConflict: 'id, organization_id' });

        if (profileError) {
            console.error("âŒ Error profile:", profileError);
            throw new Error(`Error DB Profile: ${profileError.message}`);
        }

        // ---------------------------------------------------------
        // PAS 3: PROJECTE
        // ---------------------------------------------------------
        console.log(`ğŸ—ï¸ [Tenant] 3. Creant Projecte...`);

        const { data: existingProject } = await this.supabase
            .from('projects')
            .select('*')
            .eq('organization_id', org.id)
            .eq('domain', data.slug)
            .maybeSingle();

        let project;

        if (existingProject) {
            console.warn(`âš ï¸ [Tenant] El projecte ja existeix.`);
            project = existingProject;
        } else {
            // âœ… SOLUCIÃ“ AL 'ANY': Casting segur a Json
            // 'unknown' esborra el tipus original, 'Json' aplica el de Supabase
            const brandingJson = data.branding as unknown as Json;

            const projectPayload: TableInsert<'projects'> = {
                client_id: data.creatorUserId,
                name: data.businessName,
                domain: data.slug,
                repository_url: data.repoUrl,
                organization_id: org.id,
                status: 'pending',

                // Utilitzem la variable amb el cast correcte
                branding_config: brandingJson,

                // Cast manual per a objectes literals
                features_config: { blog: true, booking: false, ecommerce: false } as unknown as Json
            };

            const { data: newProj, error: projError } = await this.supabase
                .from('projects')
                .insert(projectPayload)
                .select()
                .single();

            if (projError) throw new Error(`Error DB Project: ${projError.message}`);
            project = newProj;
            console.log(`âœ… [Tenant] Projecte creat: ${project.id}`);
        }

        return { org, project };
    }
    async inviteOrLinkUser(email: string, orgId: string, projectId: string) {
        console.log(`ğŸ” [Tenant] Gestionant usuari: ${email}`);

        // 1. Busquem si ja tÃ© perfil
        const { data: existingProfile } = await this.supabase
            .from('profiles')
            .select('id')
            .eq('email', email)
            .eq('organization_id', orgId) // Important filtrar per org
            .maybeSingle();

        let userId = existingProfile?.id;

        if (!userId) {
            // 2. Si no tÃ© perfil, mirem si l'usuari d'Auth existeix (Global)
            const { data: { users } } = await this.supabase.auth.admin.listUsers();
            const existingAuthUser = users.find(u => u.email === email);

            if (existingAuthUser) {
                userId = existingAuthUser.id;
            } else {
                // 3. Si no existeix a Auth, l'invitem
                const { data: invite, error } = await this.supabase.auth.admin.inviteUserByEmail(email, {
                    data: { org_id: orgId, role: 'client' } // Metadades
                });
                if (error) throw error;
                userId = invite.user.id;
            }

            // 4. Creem el perfil
            await this.supabase.from('profiles').insert({
                id: userId,
                email: email,
                organization_id: orgId,
                role: 'client', // o el rol que toqui
                full_name: email.split('@')[0]
            });
        }

        // 5. Vinculem al Projecte (si el projecte guarda clients)
        // Nota: Si el projecte nomÃ©s tÃ© 'client_id' (owner), potser no cal fer aixÃ² si Ã©s un usuari secundari.
        // Si Ã©s per convidar l'owner, ja ho fem al createTenantStructure.

        return userId;
    }
}

// =================== FILE: src/types/actions.ts ===================

export type ActionResult = {
  success?: boolean;
  error?: string;
  repoUrl?: string;
  // ğŸ‘‡ Afegim aixÃ² per retornar les dades si falla
  fields?: {
    businessName?: string;
    slug?: string;
    description?: string;
    primaryColor?: string;
  };
};

// =================== FILE: src/types/ai-response.ts ===================

// src/types/ai-response.ts

// 1. Sub-estructures per evitar 'any'
export interface AiHero {
  title?: string;
  subtitle?: string;
  cta?: string;
  image?: string;
  image_prompt?: string;
}

export interface AiStatsObj {
  label1?: string;
  value1?: string;
  label2?: string;
  value2?: string;
  label3?: string;
  value3?: string;
}

export interface AiAbout {
  title?: string;
  description?: string;
  stats?: AiStatsObj; // La IA ho torna com objecte pla
  image?: string;
  badge?: string;
}

export interface AiSocials {
  instagram?: string;
  linkedin?: string;
  twitter?: string;
  facebook?: string;
}

export interface AiContact {
  email?: string;
  phone?: string;
  address?: string;
  socials?: AiSocials;
}

export interface AiTheme {
  primary?: string;
  secondary?: string;
  layout?: 'modern' | 'shop';
}

export interface AiNavbar {
  links?: Record<string, string>;
  cta?: string;
}

export interface AiFooterLegal {
  privacy?: string;
  cookies?: string;
  terms?: string;
}

export interface AiFooter {
  description?: string;
  legal?: AiFooterLegal;
}

export interface AiFeatures {
  booking?: boolean;
  ecommerce?: boolean;
  blog?: boolean;
  gallery?: boolean;
  faq?: boolean;
}

export interface AiSectionObj {
  id: string;
  type: string;
}

// 2. L'objecte PRINCIPAL que retorna Gemini
export interface AiGeneratedConfig {
  name: string;
  description: string;
  sector?: string;
  
  theme?: AiTheme;
  Navbar?: AiNavbar;
  Footer?: AiFooter;
  contact?: AiContact;
  features?: AiFeatures;

  // La landing pot ser strings ("hero") o objectes ({id: "hero" ...})
  landing?: {
    sections?: Array<string | AiSectionObj>;
  };

  // Seccions de contingut especÃ­fic
  hero?: AiHero;
  about?: AiAbout;
  
  // Si en el futur hi ha mÃ©s seccions, s'han de tipar aquÃ­, MAI posar [key: string]: any
}

// =================== FILE: src/types/ai.ts ===================

export interface BusinessSuggestion {
  title: string;      // Ex: "PassarelÂ·la de Pagament"
  description: string; // Ex: "Cobra per avanÃ§at i evita impagats."
  icon: 'calendar' | 'shop' | 'user' | 'chart' | 'settings';
  impact: 'high' | 'medium';
}

// =================== FILE: src/types/config.ts ===================

// PROJECTE: Master Template
// FITXER: src/types/config.ts

// ==========================================
// 1. Definicions de Seccions
// ==========================================

// A. Els noms de les seccions disponibles
export type SectionType = 
  | 'hero' 
  | 'features' 
  | 'services' 
  | 'contact' 
  | 'testimonials' 
  | 'map' 
  | 'stats' 
  | 'faq' 
  | 'cta_banner' 
  | 'featured_products' 
  | 'about';

// B. La definiciÃ³ d'objecte (necessÃ ria per la Factory)
export interface SectionConfig {
  id: string;
  type: SectionType;
}

// C. El tipus hÃ­brid (accepta String legacy o Objecte nou)
export type ConfigLandingSection = SectionType | SectionConfig;

// ==========================================
// 2. ConfiguraciÃ³ de Contingut EstÃ tic
// ==========================================

export interface AboutConfigInput {
  title?: string;
  description?: string;
  image_url?: string;
  stats?: Array<{ label: string; value: string }>;
}

export interface HeroConfigInput {
  title?: string;
  subtitle?: string;
  cta?: string;
}

export interface AIItem {
  title: string;
  description: string;
  icon?: string;
}

export interface ServicesIntroConfigInput {
  title: string;
  subtitle: string;
  items?: AIItem[];
}

export interface TestimonialItem {
  text: string;
  author: string;
  role: string;
  rating: number;
}

export interface StaticContentConfig {
  hero?: HeroConfigInput;
  about?: AboutConfigInput;
  services_intro?: ServicesIntroConfigInput;
  testimonials?: {
    title: string;
    subtitle: string;
    items: TestimonialItem[];
  };
}

// ==========================================
// 3. Estructures Auxiliars
// ==========================================
export type ModuleStatus = boolean;

export interface FooterLink {
  label: string;
  href: string;
}

export interface FooterColumn {
  title: string;
  links: FooterLink[];
}

export interface SiteFooterConfig {
  columns: FooterColumn[];
  socials?: Record<string, string>;
  bottomText: string;
}

export interface SiteIdentity {
  name: string;
  description: string;
  logoUrl: string;
  faviconUrl: string;
  contactEmail: string;
  address?: string;
}

export interface SiteBranding {
  colors: {
    primary: string;
    secondary: string;
    background: string;
    foreground: string;
  };
  radius: number;
}

// ==========================================
// 4. ConfiguraciÃ³ de MÃ²duls
// ==========================================
export interface SiteModules {
  layout: {
    variant: 'modern' | 'shop';
    stickyHeader: boolean;
  };

  landing: {
    active: boolean;
    // Ara accepta tant strings com objectes
    sections: ConfigLandingSection[];
  };

  auth: {
    active: boolean;
    allowPublicRegistration: boolean;
    redirects: {
      admin: string;
      client: string;
    };
  };

  dashboard: ModuleStatus;
  booking: ModuleStatus;
  ecommerce: ModuleStatus;
  blog: ModuleStatus;
  inventory: ModuleStatus;
  accessControl: ModuleStatus;
  chatbot: ModuleStatus;
}

export interface I18nConfig {
  locales: string[];
  defaultLocale: string;
}

// ==========================================
// ğŸ§  CONFIGURACIÃ“ MESTRA
// ==========================================
export interface MasterConfig {
  organizationId?: string;
  identity: SiteIdentity;
  branding: SiteBranding;
  modules: SiteModules;
  i18n: I18nConfig;
  footer: SiteFooterConfig;
  content?: StaticContentConfig;
}

// =================== FILE: src/types/database.types.ts ===================

export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "13.0.5"
  }
  graphql_public: {
    Tables: {
      [_ in never]: never
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      graphql: {
        Args: {
          extensions?: Json
          operationName?: string
          query?: string
          variables?: Json
        }
        Returns: Json
      }
    }
    Enums: {
      [_ in never]: never
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
  public: {
    Tables: {
      analytics_events: {
        Row: {
          browser: string | null
          city: string | null
          country: string | null
          country_code: string | null
          created_at: string | null
          device_type: string | null
          duration_seconds: number | null
          event_name: string
          id: number
          meta: Json | null
          os: string | null
          path: string | null
          referrer: string | null
          region: string | null
          session_id: string
        }
        Insert: {
          browser?: string | null
          city?: string | null
          country?: string | null
          country_code?: string | null
          created_at?: string | null
          device_type?: string | null
          duration_seconds?: number | null
          event_name: string
          id?: never
          meta?: Json | null
          os?: string | null
          path?: string | null
          referrer?: string | null
          region?: string | null
          session_id: string
        }
        Update: {
          browser?: string | null
          city?: string | null
          country?: string | null
          country_code?: string | null
          created_at?: string | null
          device_type?: string | null
          duration_seconds?: number | null
          event_name?: string
          id?: never
          meta?: Json | null
          os?: string | null
          path?: string | null
          referrer?: string | null
          region?: string | null
          session_id?: string
        }
        Relationships: []
      }
      analytics_visitors: {
        Row: {
          country: string | null
          device_type: string | null
          first_seen_at: string | null
          last_seen_at: string | null
          referrer: string | null
          visitor_id: string
        }
        Insert: {
          country?: string | null
          device_type?: string | null
          first_seen_at?: string | null
          last_seen_at?: string | null
          referrer?: string | null
          visitor_id: string
        }
        Update: {
          country?: string | null
          device_type?: string | null
          first_seen_at?: string | null
          last_seen_at?: string | null
          referrer?: string | null
          visitor_id?: string
        }
        Relationships: []
      }
      blocked_dates: {
        Row: {
          created_at: string | null
          date: string
          id: string
          organization_id: string
          reason: string | null
        }
        Insert: {
          created_at?: string | null
          date: string
          id?: string
          organization_id: string
          reason?: string | null
        }
        Update: {
          created_at?: string | null
          date?: string
          id?: string
          organization_id?: string
          reason?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "blocked_dates_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      bookings: {
        Row: {
          created_at: string | null
          customer_email: string
          customer_name: string
          end_time: string
          form_data: Json | null
          id: string
          organization_id: string
          service_id: string
          start_time: string
          status: string | null
          user_id: string | null
        }
        Insert: {
          created_at?: string | null
          customer_email: string
          customer_name: string
          end_time: string
          form_data?: Json | null
          id?: string
          organization_id: string
          service_id: string
          start_time: string
          status?: string | null
          user_id?: string | null
        }
        Update: {
          created_at?: string | null
          customer_email?: string
          customer_name?: string
          end_time?: string
          form_data?: Json | null
          id?: string
          organization_id?: string
          service_id?: string
          start_time?: string
          status?: string | null
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "bookings_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "bookings_service_id_fkey"
            columns: ["service_id"]
            isOneToOne: false
            referencedRelation: "services"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "bookings_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
      contact_leads: {
        Row: {
          created_at: string
          email: string
          full_name: string
          id: string
          message: string
          service: string
          source: string | null
        }
        Insert: {
          created_at?: string
          email: string
          full_name: string
          id?: string
          message: string
          service: string
          source?: string | null
        }
        Update: {
          created_at?: string
          email?: string
          full_name?: string
          id?: string
          message?: string
          service?: string
          source?: string | null
        }
        Relationships: []
      }
      content_queue: {
        Row: {
          created_at: string | null
          generated_mdx: string | null
          id: string
          image_prompt: string | null
          organization_id: string
          prompt_context: string | null
          status: Database["public"]["Enums"]["content_status"] | null
          target_keywords: string[] | null
          topic: string
        }
        Insert: {
          created_at?: string | null
          generated_mdx?: string | null
          id?: string
          image_prompt?: string | null
          organization_id: string
          prompt_context?: string | null
          status?: Database["public"]["Enums"]["content_status"] | null
          target_keywords?: string[] | null
          topic: string
        }
        Update: {
          created_at?: string | null
          generated_mdx?: string | null
          id?: string
          image_prompt?: string | null
          organization_id?: string
          prompt_context?: string | null
          status?: Database["public"]["Enums"]["content_status"] | null
          target_keywords?: string[] | null
          topic?: string
        }
        Relationships: [
          {
            foreignKeyName: "content_queue_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      order_items: {
        Row: {
          id: string
          order_id: string
          product_id: string | null
          product_name: string
          quantity: number
          unit_price: number
        }
        Insert: {
          id?: string
          order_id: string
          product_id?: string | null
          product_name: string
          quantity: number
          unit_price: number
        }
        Update: {
          id?: string
          order_id?: string
          product_id?: string | null
          product_name?: string
          quantity?: number
          unit_price?: number
        }
        Relationships: [
          {
            foreignKeyName: "order_items_order_id_fkey"
            columns: ["order_id"]
            isOneToOne: false
            referencedRelation: "orders"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "order_items_product_id_fkey"
            columns: ["product_id"]
            isOneToOne: false
            referencedRelation: "products"
            referencedColumns: ["id"]
          },
        ]
      }
      orders: {
        Row: {
          created_at: string | null
          customer_details: Json | null
          customer_email: string
          id: string
          organization_id: string
          payment_id: string | null
          payment_method: string | null
          status: string | null
          total_amount: number
          user_id: string | null
        }
        Insert: {
          created_at?: string | null
          customer_details?: Json | null
          customer_email: string
          id?: string
          organization_id: string
          payment_id?: string | null
          payment_method?: string | null
          status?: string | null
          total_amount: number
          user_id?: string | null
        }
        Update: {
          created_at?: string | null
          customer_details?: Json | null
          customer_email?: string
          id?: string
          organization_id?: string
          payment_id?: string | null
          payment_method?: string | null
          status?: string | null
          total_amount?: number
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "orders_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "orders_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
      organizations: {
        Row: {
          branding_config: Json | null
          created_at: string | null
          domain: string | null
          id: string
          name: string
          plan: string | null
          slug: string
        }
        Insert: {
          branding_config?: Json | null
          created_at?: string | null
          domain?: string | null
          id?: string
          name: string
          plan?: string | null
          slug: string
        }
        Update: {
          branding_config?: Json | null
          created_at?: string | null
          domain?: string | null
          id?: string
          name?: string
          plan?: string | null
          slug?: string
        }
        Relationships: []
      }
      post_reactions: {
        Row: {
          created_at: string | null
          id: string
          post_slug: string
          reaction_type: string
          visitor_id: string
        }
        Insert: {
          created_at?: string | null
          id?: string
          post_slug: string
          reaction_type: string
          visitor_id: string
        }
        Update: {
          created_at?: string | null
          id?: string
          post_slug?: string
          reaction_type?: string
          visitor_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "post_reactions_post_slug_fkey"
            columns: ["post_slug"]
            isOneToOne: false
            referencedRelation: "posts"
            referencedColumns: ["slug"]
          },
        ]
      }
      posts: {
        Row: {
          content_mdx: string | null
          cover_image: string | null
          created_at: string | null
          description: string | null
          id: string
          organization_id: string
          published: boolean | null
          published_at: string | null
          reviewed: boolean | null
          slug: string
          status: Database["public"]["Enums"]["post_status"] | null
          tags: string[] | null
          title: string
          updated_at: string | null
        }
        Insert: {
          content_mdx?: string | null
          cover_image?: string | null
          created_at?: string | null
          description?: string | null
          id?: string
          organization_id: string
          published?: boolean | null
          published_at?: string | null
          reviewed?: boolean | null
          slug: string
          status?: Database["public"]["Enums"]["post_status"] | null
          tags?: string[] | null
          title: string
          updated_at?: string | null
        }
        Update: {
          content_mdx?: string | null
          cover_image?: string | null
          created_at?: string | null
          description?: string | null
          id?: string
          organization_id?: string
          published?: boolean | null
          published_at?: string | null
          reviewed?: boolean | null
          slug?: string
          status?: Database["public"]["Enums"]["post_status"] | null
          tags?: string[] | null
          title?: string
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "posts_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      products: {
        Row: {
          active: boolean | null
          created_at: string | null
          currency: string | null
          description: string | null
          id: string
          images: string[] | null
          metadata: Json | null
          name: string
          organization_id: string
          price: number
          slug: string
          stock: number | null
        }
        Insert: {
          active?: boolean | null
          created_at?: string | null
          currency?: string | null
          description?: string | null
          id?: string
          images?: string[] | null
          metadata?: Json | null
          name: string
          organization_id: string
          price?: number
          slug: string
          stock?: number | null
        }
        Update: {
          active?: boolean | null
          created_at?: string | null
          currency?: string | null
          description?: string | null
          id?: string
          images?: string[] | null
          metadata?: Json | null
          name?: string
          organization_id?: string
          price?: number
          slug?: string
          stock?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "products_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      profiles: {
        Row: {
          avatar_url: string | null
          created_at: string | null
          email: string
          full_name: string | null
          id: string
          organization_id: string
          role: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id: string | null
          updated_at: string | null
        }
        Insert: {
          avatar_url?: string | null
          created_at?: string | null
          email: string
          full_name?: string | null
          id: string
          organization_id: string
          role?: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id?: string | null
          updated_at?: string | null
        }
        Update: {
          avatar_url?: string | null
          created_at?: string | null
          email?: string
          full_name?: string | null
          id?: string
          organization_id?: string
          role?: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id?: string | null
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "profiles_id_fkey"
            columns: ["id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "profiles_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      project_members: {
        Row: {
          added_at: string | null
          project_id: string
          role: string | null
          user_id: string
        }
        Insert: {
          added_at?: string | null
          project_id: string
          role?: string | null
          user_id: string
        }
        Update: {
          added_at?: string | null
          project_id?: string
          role?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "fk_project_members_users"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "project_members_project_id_fkey"
            columns: ["project_id"]
            isOneToOne: false
            referencedRelation: "projects"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "project_members_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
      projects: {
        Row: {
          branding_config: Json | null
          client_id: string
          created_at: string | null
          domain: string | null
          features_config: Json | null
          features_enabled: Json | null
          github_repo_url: string | null
          hosting_url: string | null
          id: string
          name: string
          organization_id: string | null
          repository_url: string | null
          status: Database["public"]["Enums"]["project_status"] | null
        }
        Insert: {
          branding_config?: Json | null
          client_id: string
          created_at?: string | null
          domain?: string | null
          features_config?: Json | null
          features_enabled?: Json | null
          github_repo_url?: string | null
          hosting_url?: string | null
          id?: string
          name: string
          organization_id?: string | null
          repository_url?: string | null
          status?: Database["public"]["Enums"]["project_status"] | null
        }
        Update: {
          branding_config?: Json | null
          client_id?: string
          created_at?: string | null
          domain?: string | null
          features_config?: Json | null
          features_enabled?: Json | null
          github_repo_url?: string | null
          hosting_url?: string | null
          id?: string
          name?: string
          organization_id?: string | null
          repository_url?: string | null
          status?: Database["public"]["Enums"]["project_status"] | null
        }
        Relationships: [
          {
            foreignKeyName: "projects_client_id_fkey"
            columns: ["client_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "projects_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      schedules: {
        Row: {
          created_at: string | null
          day_of_week: number
          end_time: string
          id: string
          is_active: boolean | null
          organization_id: string
          start_time: string
        }
        Insert: {
          created_at?: string | null
          day_of_week: number
          end_time: string
          id?: string
          is_active?: boolean | null
          organization_id: string
          start_time: string
        }
        Update: {
          created_at?: string | null
          day_of_week?: number
          end_time?: string
          id?: string
          is_active?: boolean | null
          organization_id?: string
          start_time?: string
        }
        Relationships: [
          {
            foreignKeyName: "schedules_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      services: {
        Row: {
          active: boolean | null
          created_at: string | null
          description: string | null
          duration_minutes: number | null
          form_schema: Json | null
          id: string
          organization_id: string
          price: number | null
          title: string
        }
        Insert: {
          active?: boolean | null
          created_at?: string | null
          description?: string | null
          duration_minutes?: number | null
          form_schema?: Json | null
          id?: string
          organization_id: string
          price?: number | null
          title: string
        }
        Update: {
          active?: boolean | null
          created_at?: string | null
          description?: string | null
          duration_minutes?: number | null
          form_schema?: Json | null
          id?: string
          organization_id?: string
          price?: number | null
          title?: string
        }
        Relationships: [
          {
            foreignKeyName: "services_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      social_connections: {
        Row: {
          access_token: string
          created_at: string
          expires_at: number | null
          id: string
          organization_id: string | null
          provider: string
          provider_account_id: string | null
          provider_avatar_url: string | null
          provider_page_id: string | null
          provider_page_name: string | null
          refresh_token: string | null
          updated_at: string
          user_id: string | null
        }
        Insert: {
          access_token: string
          created_at?: string
          expires_at?: number | null
          id?: string
          organization_id?: string | null
          provider: string
          provider_account_id?: string | null
          provider_avatar_url?: string | null
          provider_page_id?: string | null
          provider_page_name?: string | null
          refresh_token?: string | null
          updated_at?: string
          user_id?: string | null
        }
        Update: {
          access_token?: string
          created_at?: string
          expires_at?: number | null
          id?: string
          organization_id?: string | null
          provider?: string
          provider_account_id?: string | null
          provider_avatar_url?: string | null
          provider_page_id?: string | null
          provider_page_name?: string | null
          refresh_token?: string | null
          updated_at?: string
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "social_connections_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "social_connections_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
      social_posts: {
        Row: {
          content: string
          created_at: string
          error_message: string | null
          external_id: string | null
          id: string
          media_url: string | null
          platform: Database["public"]["Enums"]["social_platform"]
          post_id: string
          published_at: string | null
          scheduled_at: string | null
          status: Database["public"]["Enums"]["social_status"]
          updated_at: string
        }
        Insert: {
          content: string
          created_at?: string
          error_message?: string | null
          external_id?: string | null
          id?: string
          media_url?: string | null
          platform: Database["public"]["Enums"]["social_platform"]
          post_id: string
          published_at?: string | null
          scheduled_at?: string | null
          status?: Database["public"]["Enums"]["social_status"]
          updated_at?: string
        }
        Update: {
          content?: string
          created_at?: string
          error_message?: string | null
          external_id?: string | null
          id?: string
          media_url?: string | null
          platform?: Database["public"]["Enums"]["social_platform"]
          post_id?: string
          published_at?: string | null
          scheduled_at?: string | null
          status?: Database["public"]["Enums"]["social_status"]
          updated_at?: string
        }
        Relationships: [
          {
            foreignKeyName: "social_posts_post_id_fkey"
            columns: ["post_id"]
            isOneToOne: false
            referencedRelation: "posts"
            referencedColumns: ["id"]
          },
        ]
      }
      test_assignments: {
        Row: {
          assigned_at: string | null
          campaign_id: string
          id: string
          user_id: string
        }
        Insert: {
          assigned_at?: string | null
          campaign_id: string
          id?: string
          user_id: string
        }
        Update: {
          assigned_at?: string | null
          campaign_id?: string
          id?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_assignments_campaign_id_fkey"
            columns: ["campaign_id"]
            isOneToOne: false
            referencedRelation: "test_campaigns"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "test_assignments_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
      test_campaigns: {
        Row: {
          created_at: string | null
          description: string | null
          id: string
          instructions: string | null
          project_id: string
          status: string | null
          title: string
        }
        Insert: {
          created_at?: string | null
          description?: string | null
          id?: string
          instructions?: string | null
          project_id: string
          status?: string | null
          title: string
        }
        Update: {
          created_at?: string | null
          description?: string | null
          id?: string
          instructions?: string | null
          project_id?: string
          status?: string | null
          title?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_campaigns_project_id_fkey"
            columns: ["project_id"]
            isOneToOne: false
            referencedRelation: "projects"
            referencedColumns: ["id"]
          },
        ]
      }
      test_results: {
        Row: {
          comment: string | null
          created_at: string | null
          device_info: string | null
          id: string
          status: string
          task_id: string
          updated_at: string | null
          user_id: string
        }
        Insert: {
          comment?: string | null
          created_at?: string | null
          device_info?: string | null
          id?: string
          status: string
          task_id: string
          updated_at?: string | null
          user_id: string
        }
        Update: {
          comment?: string | null
          created_at?: string | null
          device_info?: string | null
          id?: string
          status?: string
          task_id?: string
          updated_at?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_results_task_id_fkey"
            columns: ["task_id"]
            isOneToOne: false
            referencedRelation: "test_tasks"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "test_results_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
      test_tasks: {
        Row: {
          campaign_id: string
          description: string | null
          expected_result: string | null
          id: string
          order_index: number | null
          title: string
        }
        Insert: {
          campaign_id: string
          description?: string | null
          expected_result?: string | null
          id?: string
          order_index?: number | null
          title: string
        }
        Update: {
          campaign_id?: string
          description?: string | null
          expected_result?: string | null
          id?: string
          order_index?: number | null
          title?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_tasks_campaign_id_fkey"
            columns: ["campaign_id"]
            isOneToOne: false
            referencedRelation: "test_campaigns"
            referencedColumns: ["id"]
          },
        ]
      }
      web_audits: {
        Row: {
          created_at: string | null
          email: string | null
          id: string
          organization_id: string | null
          performance_score: number | null
          report_data: Json | null
          seo_score: number | null
          status: Database["public"]["Enums"]["audit_status"] | null
          url: string
          user_id: string | null
          visitor_id: string | null
        }
        Insert: {
          created_at?: string | null
          email?: string | null
          id?: string
          organization_id?: string | null
          performance_score?: number | null
          report_data?: Json | null
          seo_score?: number | null
          status?: Database["public"]["Enums"]["audit_status"] | null
          url: string
          user_id?: string | null
          visitor_id?: string | null
        }
        Update: {
          created_at?: string | null
          email?: string | null
          id?: string
          organization_id?: string | null
          performance_score?: number | null
          report_data?: Json | null
          seo_score?: number | null
          status?: Database["public"]["Enums"]["audit_status"] | null
          url?: string
          user_id?: string | null
          visitor_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "web_audits_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "web_audits_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Views: {
      mv_analytics_top_pages: {
        Row: {
          last_visit: string | null
          path: string | null
          unique_visitors: number | null
          visits: number | null
        }
        Relationships: []
      }
      users_summary: {
        Row: {
          avatar_url: string | null
          email: string | null
          full_name: string | null
          id: string | null
        }
        Insert: {
          avatar_url?: never
          email?: string | null
          full_name?: never
          id?: string | null
        }
        Update: {
          avatar_url?: never
          email?: string | null
          full_name?: never
          id?: string | null
        }
        Relationships: []
      }
    }
    Functions: {
      decrement_stock: {
        Args: { p_product_id: string; p_quantity: number }
        Returns: undefined
      }
      get_analytics_browsers: {
        Args: { date_from: string }
        Returns: {
          name: string
          value: number
        }[]
      }
      get_analytics_countries: {
        Args: { date_from: string }
        Returns: {
          name: string
          value: number
        }[]
      }
      get_analytics_devices: {
        Args: { date_from: string }
        Returns: {
          name: string
          value: number
        }[]
      }
      get_analytics_os: {
        Args: { date_from: string }
        Returns: {
          name: string
          value: number
        }[]
      }
      get_analytics_referrers: {
        Args: { date_from: string }
        Returns: {
          name: string
          value: number
        }[]
      }
      get_my_org_ids: { Args: never; Returns: string[] }
      is_admin: { Args: never; Returns: boolean }
      refresh_analytics_views: { Args: never; Returns: undefined }
    }
    Enums: {
      audit_status: "processing" | "completed" | "failed"
      content_status: "queued" | "generating" | "review" | "published"
      post_status: "draft" | "published" | "archived"
      project_status: "pending" | "active" | "maintenance" | "archived"
      social_platform: "linkedin" | "facebook" | "instagram"
      social_status: "draft" | "approved" | "scheduled" | "published" | "failed"
      user_role: "admin" | "client" | "lead" | "staff"
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  graphql_public: {
    Enums: {},
  },
  public: {
    Enums: {
      audit_status: ["processing", "completed", "failed"],
      content_status: ["queued", "generating", "review", "published"],
      post_status: ["draft", "published", "archived"],
      project_status: ["pending", "active", "maintenance", "archived"],
      social_platform: ["linkedin", "facebook", "instagram"],
      social_status: ["draft", "approved", "scheduled", "published", "failed"],
      user_role: ["admin", "client", "lead", "staff"],
    },
  },
} as const


// =================== FILE: src/types/i18n.ts ===================

export interface I18nSchema {
  hero: {
    title: string;
    subtitle: string;
    cta: string;
    image_prompt: string;
    image?: string;
  };
  about: {
    badge: string;
    title: string;
    description: string;
    image_prompt: string;
    image?: string;
    // Permetem flexibilitat en stats (objecte o array)
    stats: {
      label1: string; value1: string;
      label2: string; value2: string;
      label3: string; value3: string;
    } | Array<{ label: string; value: string }>;
  };
  services: {
    badge: string;
    title: string;
    subtitle: string;
    items: Array<{
      title: string;
      description: string;
      icon_name?: string;
    }>;
  };
  
  // âœ… CORRECCIÃ“ 1: Renomenat a 'featured_products' per coincidir amb el config
  // âœ… CORRECCIÃ“ 2: Afegit 'limit' (el component el fa servir per tallar l'array de DB)
  featured_products?: {
    badge?: string;
    title: string;
    subtitle: string;
    limit?: number; 
  };

  testimonials: {
    badge: string;
    title: string;
    subtitle: string;
    reviews: Array<{
      author: string;
      role: string;
      text: string;
      avatar_gender?: string; // Opcional
      avatar?: string;
    }>;
  };

  cta_banner: {
    heading: string;
    subheading: string;
    buttonText: string;
    buttonLink?: string;
  };

  // âœ… CORRECCIÃ“ 3: Afegit MAP (necessari pel fallback d'actions.ts)
  map?: {
    title: string;
    subtitle: string;
  };

  faq: {
    title: string;
    subtitle: string;
    items: Array<{
      question: string;
      answer: string;
    }>;
  };
  
  contact: {
    title: string;
    description: string;
    button: string;
  };
}

// =================== FILE: src/types/index.ts ===================

import { Database } from './database.types';

// Exportem el tipus base per als clients de Supabase
export type { Database };

// Helpers per tenir tipus nets als components
// En lloc d'escriure la ruta llarga, farÃ s servir 'Audit' o 'Profile'
export type Audit = Database['public']['Tables']['web_audits']['Row'];
export type NewAudit = Database['public']['Tables']['web_audits']['Insert']; // Per formularis
export type Profile = Database['public']['Tables']['profiles']['Row'];
export type Project = Database['public']['Tables']['projects']['Row'];

// Tipus per als Enums (molt Ãºtil per dropdowns)
export type UserRole = Database['public']['Enums']['user_role'];
export type AuditStatus = Database['public']['Enums']['audit_status'];
export type ContactLead = Database['public']['Tables']['contact_leads']['Row'];
export type BlogPost = Database['public']['Tables']['posts']['Row'];

// =================== FILE: src/types/joins.ts ===================

// src/types/models.ts (AmpliaciÃ³)

import { Database } from './database.types';

// Tipus base de les taules
type TestCampaign = Database['public']['Tables']['test_campaigns']['Row'];
type TestTask = Database['public']['Tables']['test_tasks']['Row'];
type TestResult = Database['public']['Tables']['test_results']['Row'];

// 1. Tipus per a la Campanya amb les Tasques (Nested)
export type CampaignWithTasks = TestCampaign & {
  test_tasks: TestTask[]; // La relaciÃ³ es diu com la taula normalment
};

// 2. Tipus per al Repositori (Campaign + Context)
export type CampaignContext = {
  campaign: TestCampaign | null;
  tasks: TestTask[];
  results: TestResult[];
};

// =================== FILE: src/types/models/factory.ts ===================

import { StaticImageData } from 'next/image';

// ==========================================
// 1. AUDITORIA SEO/PERFORMANCE
// ==========================================
export type AuditDTO = {
  id: string;
  url: string;
  status: 'processing' | 'completed' | 'failed';
  seoScore: number | null;
  performanceScore: number | null;
  createdAt: Date;
  reportData: Record<string, unknown> | null;
};

export interface IAuditRepository {
  getAuditsByUserEmail(email: string): Promise<AuditDTO[]>;
  getAuditById(id: string): Promise<AuditDTO | null>;
  createAudit(url: string, email: string): Promise<AuditDTO>;
  updateStatus(id: string, status: AuditDTO['status'], results?: { seoScore?: number; performanceScore?: number; reportData?: Record<string, unknown> }): Promise<void>;
}

// ==========================================
// 2. TESTING CAMPAIGNS (QA Intern)
// ==========================================
export type TestCampaignDTO = {
  id: string;
  projectId: string;
  title: string;
  description: string | null;
  instructions: string | null;
  status: string;
  createdAt: Date;
};

export type TestTaskDTO = {
  id: string;
  campaignId: string;
  title: string;
  description: string | null;
  orderIndex: number;
};

export type TestResultDTO = {
  id: string;
  taskId: string;
  userId: string;
  status: 'pass' | 'fail' | 'blocked';
  comment: string | null;
  updatedAt: Date;
};

export type CampaignContext = {
  campaign: TestCampaignDTO | null;
  tasks: TestTaskDTO[];
  results: TestResultDTO[];
};

export type TesterProfile = {
  id: string;
  email: string;
  full_name: string | null;
  avatar_url: string | null;
};

// ==========================================
// 3. ANALYTICS INTERN
// ==========================================
export type AnalyticsEventDTO = {
  event_name: string;
  path: string;
  session_id: string;
  duration?: number;
  referrer?: string;
  meta?: Record<string, unknown>;
  geo?: { country: string | null; city: string | null };
  device?: { type: string; browser: string; os: string };
};

// ==========================================
// 4. PORTFOLIO FACTORY
// ==========================================
export type ThemeImageSet = {
  light: StaticImageData;
  dark: StaticImageData;
};

export interface Project {
  id: string;
  title: string;
  tagline: string;
  description: string;
  stats: string[];
  tags: string[];
  color: string;
  link: string;
  imageAlt: string;
  image: StaticImageData;
  adaptiveImages?: Record<string, ThemeImageSet>; 
}

// =================== FILE: src/types/models/index.ts ===================

// EXPORTADOR PRINCIPAL
// AixÃ² permet fer: import { AuditDTO, ServiceDTO } from '@/types/models';

export * from './factory';
export * from './template';

// =================== FILE: src/types/models/template.ts ===================

// ==========================================
// MODELS DEL MASTER TEMPLATE (CÃ²pia per compatibilitat)
// ==========================================

// 1. Landing Sections (IA & Visuals)
export type SectionType = 
  | 'hero' | 'services' | 'contact' | 'stats' | 'testimonials' 
  | 'map' | 'faq' | 'cta_banner' | 'featured_products' | 'about';

export interface BaseSectionContent {
  title?: string;
  subtitle?: string;
}

export interface HeroContent extends BaseSectionContent {
  ctaText?: string;
  companyName: string;
}

export interface ServiceContent extends BaseSectionContent {
  headlinePrefix?: string;
  headlineHighlight?: string;
  emptyState?: { title: string; text: string };
  // âœ… CORREGIT: Tipat correcte per als items de la IA
  items?: Array<{ title: string; description: string }>;      
}

export interface AboutContent extends BaseSectionContent {
  badge?: string;
  description: string;
  imageUrl?: string; 
  features?: string[];
  stats?: Array<{ label: string; value: string }>;
  card?: { title: string; subtitle: string };
}

export interface StatsContent {
  items: Array<{ value: string; label: string }>;
}

export interface TestimonialsContent extends BaseSectionContent {
  reviews: Array<{
    author: string;
    role: string;
    text: string;
    rating: number;
  }>;
}

// 2. E-commerce (Client)
export interface Product {
  id: string;
  organization_id: string;
  slug: string;
  name: string;
  description: string | null;
  price: number;
  stock: number;
  active: boolean;
  images: string[];
  category_id?: string;
  created_at?: Date;
}

export interface CartItem {
  id: string;
  organization_id: string;
  name: string;
  price: number;
  stock: number;
  slug: string;
  image?: string;
  quantity: number;
}

// 3. Booking & Serveis (Client)
export interface ServiceDTO {
  id: string;
  title: string;
  description: string;
  price?: number;
  currency?: string;
  image_url?: string;
  // âœ… UNIFICAT: Fem servir sempre duration_minutes
  duration_minutes?: number; 
}
// Alias
export type Service = ServiceDTO;

export interface Booking {
  id: string;
  organization_id: string;
  service_id: string;
  user_id: string | null;
  start_time: Date;
  end_time: Date;
  status: 'pending' | 'confirmed' | 'cancelled';
  // RelaciÃ³ opcional
  services?: { title: string; duration_minutes?: number } | null;
}

// 4. Blog (Client)
export type PostStatus = 'draft' | 'published' | 'archived';

export interface BlogPostDTO {
  id: string;
  slug: string;
  title: string;
  description: string | null;
  content: string | null;
  coverImage: string | null; // CamelCase per UI
  tags: string[];
  date: string | null;
  
  // Camps Admin
  published: boolean;
  reviewed: boolean;
  status?: PostStatus; 
  
  social_posts?: {
    id: string;
    platform: string;
    status: string;
    scheduledFor: string | null;
  }[];

  totalReactions?: number;
}

// =================== FILE: src/types/sectors.ts ===================

export type SectorType = 'restaurant' | 'legal' | 'medical' | 'real_estate' | 'general';

export interface SectorConfig {
  key: SectorType;
  aiPersona: string; // La "personalitat" del bot
  keywords: {
    services: string; // Pistes per generar serveis      
    cta: string;      // Pista per al botÃ³ d'acciÃ³     
  };
  // âœ… NOVA SECCIÃ“: MÃ²duls funcionals
  features: {
    booking: boolean;      // Sistema de reserves
    ecommerce: boolean;    // Venda de productes
    blog: boolean;         // NotÃ­cies/Articles
    gallery: boolean;      // Galeria de fotos complexa
    faq: boolean;          // Preguntes freqÃ¼ents
  };
}

export const SECTOR_REGISTRY: Record<SectorType, SectorConfig> = {
  restaurant: {
    key: 'restaurant',
    aiPersona: "Ets un expert en mÃ rqueting gastronÃ²mic i copywriting culinari. Utilitza un llenguatge sensorial (gust, olfacte), apetitiu, acollidor i visual. Centra't en l'experiÃ¨ncia de compartir taula.",
    keywords: {
      services: "Plats Estrella, MenÃº DegustaciÃ³, Maridatge de Vins, Esdeveniments Privats",
      cta: "Reserva la teva Taula"
    },
    features: { booking: true, ecommerce: false, blog: false, gallery: true, faq: false }
  },
  legal: {
    key: 'legal',
    aiPersona: "Ets un advocat sÃ¨nior expert en comunicaciÃ³ corporativa. Utilitza un to professional, autoritari, seriÃ³s, discret i que transmeti mÃ xima confianÃ§a i seguretat jurÃ­dica.",
    keywords: {
      services: "Dret Civil, Dret Penal, Assessorament Mercantil, Divorcis i HerÃ¨ncies",
      cta: "SolÂ·licita Consulta PrÃ¨via"
    },
    features: { booking: false, ecommerce: false, blog: true, gallery: false, faq: true }
  },
  medical: {
    key: 'medical',
    aiPersona: "Ets un director mÃ¨dic d'una clÃ­nica de prestigi. Utilitza un to empÃ tic, cientÃ­fic, tranquilÂ·litzador i proper. La prioritat Ã©s la salut, la tecnologia puntera i el benestar del pacient.",
    keywords: {
      services: "DiagnÃ²stic AvanÃ§at, Tractaments Personalitzats, Medicina Preventiva, UrgÃ¨ncies 24h",
      cta: "Demanar Cita MÃ¨dica"
    },
    features: { booking: true, ecommerce: false, blog: true, gallery: false, faq: true }
  },
  real_estate: {
    key: 'real_estate',
    aiPersona: "Ets un agent immobiliari de luxe. Utilitza un to aspiracional, elegant i exclusiu. Ven l'estil de vida, els espais oberts i la llum, no nomÃ©s les parets.",
    keywords: {
      services: "Compra-Venda, Lloguer de Luxe, Taxacions ImmobiliÃ ries, GestiÃ³ Patrimonial",
      cta: "Veure Propietats Exclusives"
    },
    features: { booking: true, ecommerce: false, blog: false, gallery: true, faq: true }
  },
  general: {
    key: 'general',
    aiPersona: "Ets un consultor de negocis versÃ til i modern. Utilitza un to corporatiu orientat a resultats, eficiÃ¨ncia i innovaciÃ³.",
    keywords: {
      services: "Consultoria EstratÃ¨gica, Desenvolupament de Projectes, Suport Integral",
      cta: "Contactar Ara"
    }, features: { booking: false, ecommerce: false, blog: true, gallery: false, faq: false }
  }
};

// FunciÃ³ helper per normalitzar l'entrada
export function getSectorConfig(input: string): SectorConfig {
  const key = input.toLowerCase().trim() as SectorType;
  return SECTOR_REGISTRY[key] || SECTOR_REGISTRY.general;
}