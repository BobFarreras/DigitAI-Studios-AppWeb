ESTRUCTURA DEL PROJECTE (./src)

â”œâ”€â”€ actions
â”‚   â””â”€â”€ contact.ts
â”œâ”€â”€ adapters
â”‚   â”œâ”€â”€ google
â”‚   â”‚   â”œâ”€â”€ PageSpeedAdapter.ts
â”‚   â”‚   â””â”€â”€ schemas.ts
â”‚   â”œâ”€â”€ GooglePageSpeedAdapter.ts
â”‚   â”œâ”€â”€ interfaces
â”‚   â””â”€â”€ IWebScanner.ts
â”œâ”€â”€ app
â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â””â”€â”€ get-users.ts
â”‚   â”œâ”€â”€ api
â”‚   â”‚   â”œâ”€â”€ track
â”‚   â”‚   â””â”€â”€ web-audit
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â”œâ”€â”€ globals.css
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ manifest.ts
â”‚   â”œâ”€â”€ not-found.tsx
â”‚   â”œâ”€â”€ robots.ts
â”‚   â”œâ”€â”€ sitemap.ts
â”‚   â””â”€â”€ [locale]
â”‚       â”œâ”€â”€ (marketing)
â”‚       â”‚   â”œâ”€â”€ blog
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [slug]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ legal
â”‚       â”‚   â”‚   â”œâ”€â”€ avis-legal
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ cookies
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ privacitat
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ projectes
â”‚       â”‚       â””â”€â”€ page.tsx
â”‚       â”œâ”€â”€ admin
â”‚       â”‚   â”œâ”€â”€ analytics
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ blog
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [slug]
â”‚       â”‚   â”‚       â”œâ”€â”€ edit
â”‚       â”‚   â”‚       â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ debug
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ projects
â”‚       â”‚   â”‚   â”œâ”€â”€ new
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ tests
â”‚       â”‚   â”‚   â”œâ”€â”€ new
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ users
â”‚       â”‚       â””â”€â”€ page.tsx
â”‚       â”œâ”€â”€ auth
â”‚       â”‚   â”œâ”€â”€ callback
â”‚       â”‚   â”‚   â””â”€â”€ route.ts
â”‚       â”‚   â”œâ”€â”€ forgot-password
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ login
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ register
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ reset-password
â”‚       â”‚       â””â”€â”€ page.tsx
â”‚       â”œâ”€â”€ dashboard
â”‚       â”‚   â”œâ”€â”€ audits
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ MobilBottomBar.tsx
â”‚       â”‚   â”œâ”€â”€ new-audit
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ projects
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚       â””â”€â”€ [testId]
â”‚       â”‚   â”‚           â””â”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ tests
â”‚       â”‚       â””â”€â”€ page.tsx
â”‚       â””â”€â”€ layout.tsx
â”œâ”€â”€ assets
â”‚   â””â”€â”€ images
â”‚       â”œâ”€â”€ hero.webp
â”‚       â”œâ”€â”€ og-image.jpg
â”‚       â”œâ”€â”€ pantalla-ribotflow.jpg
â”‚       â”œâ”€â”€ pantalla-salutflow.jpg
â”‚       â”œâ”€â”€ ribotflow.png
â”‚       â”œâ”€â”€ salutflow.png
â”‚       â””â”€â”€ testimoni-garatgeestacio.jpg
â”œâ”€â”€ components
â”‚   â”œâ”€â”€ admin
â”‚   â”‚   â”œâ”€â”€ AdminSidebar.tsx
â”‚   â”‚   â””â”€â”€ AminMobileMenu.tsx
â”‚   â”œâ”€â”€ charts
â”‚   â”‚   â””â”€â”€ ScoreRing.tsx
â”‚   â”œâ”€â”€ dashboard
â”‚   â”‚   â”œâ”€â”€ AuditCard.tsx
â”‚   â”‚   â”œâ”€â”€ DashboardHeader.tsx
â”‚   â”‚   â””â”€â”€ Sidebar.tsx
â”‚   â”œâ”€â”€ icons
â”‚   â”‚   â””â”€â”€ GoogleIcon.tsx
â”‚   â”œâ”€â”€ landing
â”‚   â”‚   â”œâ”€â”€ AuditSection.tsx
â”‚   â”‚   â”œâ”€â”€ BenefitsSection.tsx
â”‚   â”‚   â”œâ”€â”€ ContactSection.tsx
â”‚   â”‚   â”œâ”€â”€ diary
â”‚   â”‚   â”‚   â”œâ”€â”€ DiaryCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ DiaryEmptyState.tsx
â”‚   â”‚   â”‚   â””â”€â”€ DiaryStack.tsx
â”‚   â”‚   â”œâ”€â”€ HeroSection.tsx
â”‚   â”‚   â”œâ”€â”€ LatestPostsSection.tsx
â”‚   â”‚   â”œâ”€â”€ ProblemSolutionsSection.tsx
â”‚   â”‚   â”œâ”€â”€ ProductTeaser.tsx
â”‚   â”‚   â”œâ”€â”€ services
â”‚   â”‚   â”‚   â”œâ”€â”€ mockups
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AppMockup.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AutomationFlow.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TerminalMockup.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ WebMockup.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ServiceCard.tsx
â”‚   â”‚   â”œâ”€â”€ ServicesGrid.tsx
â”‚   â”‚   â”œâ”€â”€ SocialSection.tsx
â”‚   â”‚   â”œâ”€â”€ solutions
â”‚   â”‚   â”‚   â”œâ”€â”€ data.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ MobileSolutionsDock.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ mockups
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MockupBooking.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MockupFinance.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MockupGrowth.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MockupIoT.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ SolutionsDisplay.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ SolutionsNavigation.tsx
â”‚   â”‚   â”‚   â””â”€â”€ SolutionsShowcase.tsx
â”‚   â”‚   â”œâ”€â”€ SolutionsShowcase.tsx
â”‚   â”‚   â”œâ”€â”€ TechStackSection.tsx
â”‚   â”‚   â””â”€â”€ TestimonialsSection.tsx
â”‚   â”œâ”€â”€ layout
â”‚   â”‚   â”œâ”€â”€ Footer.tsx
â”‚   â”‚   â”œâ”€â”€ LanguageSwitcher.tsx
â”‚   â”‚   â”œâ”€â”€ LegalLayout.tsx
â”‚   â”‚   â””â”€â”€ Navbar.tsx
â”‚   â”œâ”€â”€ theme-provider.tsx
â”‚   â””â”€â”€ ui
â”‚       â”œâ”€â”€ avatar.tsx
â”‚       â”œâ”€â”€ back-button.tsx
â”‚       â”œâ”€â”€ badge.tsx
â”‚       â”œâ”€â”€ button.tsx
â”‚       â”œâ”€â”€ card.tsx
â”‚       â”œâ”€â”€ checkbox.tsx
â”‚       â”œâ”€â”€ dropdown-menu.tsx
â”‚       â”œâ”€â”€ input.tsx
â”‚       â”œâ”€â”€ progress.tsx
â”‚       â”œâ”€â”€ select.tsx
â”‚       â”œâ”€â”€ tabs.tsx
â”‚       â”œâ”€â”€ textarea.tsx
â”‚       â””â”€â”€ theme-toggle.tsx
â”œâ”€â”€ features
â”‚   â”œâ”€â”€ analytics
â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ AnalyticsTracker.tsx
â”‚   â”‚       â”œâ”€â”€ BarListChart.tsx
â”‚   â”‚       â”œâ”€â”€ DeviceChart.tsx
â”‚   â”‚       â”œâ”€â”€ TopPagesCard.tsx
â”‚   â”‚       â”œâ”€â”€ TrafficChart.tsx
â”‚   â”‚       â”œâ”€â”€ UnifiedStatBar.tsx
â”‚   â”‚       â””â”€â”€ VerticalBarChart.tsx
â”‚   â”œâ”€â”€ audit
â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ AuditForm.tsx
â”‚   â”‚       â”œâ”€â”€ components
â”‚   â”‚       â”‚   â”œâ”€â”€ AuditHeader.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ CoreVitalsGrid.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ CreateAuditForm.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadAuditButton.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ IssuesList.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ MobilePreviw.tsx
â”‚   â”‚       â”‚   â””â”€â”€ ScoreGrid.tsx
â”‚   â”‚       â””â”€â”€ pdf
â”‚   â”‚           â””â”€â”€ AuditPdfDocument.tsx
â”‚   â”œâ”€â”€ auth
â”‚   â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚   â”‚   â”‚   â””â”€â”€ reset-password.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ ForgotPasswordForm.tsx
â”‚   â”‚       â”œâ”€â”€ LoginForm.tsx
â”‚   â”‚       â”œâ”€â”€ RegisterForm.tsx
â”‚   â”‚       â””â”€â”€ ResetPasswordForm.tsx
â”‚   â”œâ”€â”€ blog
â”‚   â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â”‚   â””â”€â”€ admin-actions.ts
â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ AdminPostList.tsx
â”‚   â”‚       â”œâ”€â”€ EditPostForm.tsx
â”‚   â”‚       â”œâ”€â”€ MDXContent.tsx
â”‚   â”‚       â”œâ”€â”€ PostStatusToggle.tsx
â”‚   â”‚       â””â”€â”€ ReactionDock.tsx
â”‚   â”œâ”€â”€ email
â”‚   â”‚   â””â”€â”€ templates
â”‚   â”‚       â””â”€â”€ AuditReadyEmail.tsx
â”‚   â”œâ”€â”€ projects
â”‚   â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â”‚   â””â”€â”€ project-actions.ts
â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚   â”‚   â”œâ”€â”€ data
â”‚   â”‚   â”‚   â””â”€â”€ projects-data.ts
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ InviteClientForm.tsx
â”‚   â”‚       â”œâ”€â”€ NewProjectForm.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectCampaignsList.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectCard.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectList.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectsCTA.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectsHero.tsx
â”‚   â”‚       â””â”€â”€ ProjectTeamManeger.tsx
â”‚   â””â”€â”€ tests
â”‚       â”œâ”€â”€ actions
â”‚       â”‚   â”œâ”€â”€ admin-actions.ts
â”‚       â”‚   â””â”€â”€ task-actions.ts
â”‚       â”œâ”€â”€ actions.ts
â”‚       â””â”€â”€ ui
â”‚           â”œâ”€â”€ CampaignAnalytics.tsx
â”‚           â”œâ”€â”€ CampaignDetailsForm.tsx
â”‚           â”œâ”€â”€ CreateCampaignForm.tsx
â”‚           â”œâ”€â”€ DeleteCampaignButton.tsx
â”‚           â”œâ”€â”€ MissionCard.tsx
â”‚           â”œâ”€â”€ TaskManager.tsx
â”‚           â”œâ”€â”€ TaskRunner.tsx
â”‚           â”œâ”€â”€ TesterManager.tsx
â”‚           â””â”€â”€ VisualFlowBuilder.tsx
â”œâ”€â”€ i18n
â”‚   â””â”€â”€ request.ts
â”œâ”€â”€ lib
â”‚   â”œâ”€â”€ audit-dictionary.ts
â”‚   â”œâ”€â”€ auth
â”‚   â”‚   â””â”€â”€ admin-guard.ts
â”‚   â”œâ”€â”€ data.ts
â”‚   â”œâ”€â”€ factory
â”‚   â”‚   â””â”€â”€ config-generator.ts
â”‚   â”œâ”€â”€ mock-audit.ts
â”‚   â”œâ”€â”€ supabase
â”‚   â”‚   â”œâ”€â”€ client.ts
â”‚   â”‚   â”œâ”€â”€ middleware.ts
â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”œâ”€â”€ utils.ts
â”‚   â””â”€â”€ validations
â”œâ”€â”€ proxy.ts
â”œâ”€â”€ repositories
â”‚   â”œâ”€â”€ interfaces
â”‚   â”‚   â”œâ”€â”€ IAnalyticsRepository.ts
â”‚   â”‚   â”œâ”€â”€ IAuditRepository.ts
â”‚   â”‚   â””â”€â”€ IPostRepository.ts
â”‚   â””â”€â”€ supabase
â”‚       â”œâ”€â”€ SupabaseAnalyticsRepository.ts
â”‚       â”œâ”€â”€ SupabaseAuditRepository.ts
â”‚       â”œâ”€â”€ SupabasePostRepository.ts
â”‚       â”œâ”€â”€ SupabaseProjectRepository.ts
â”‚       â””â”€â”€ SupabaseTestRepository.ts
â”œâ”€â”€ routing.ts
â”œâ”€â”€ services
â”‚   â”œâ”€â”€ AIService.ts
â”‚   â”œâ”€â”€ AuditService.ts
â”‚   â”œâ”€â”€ container.ts
â”‚   â”œâ”€â”€ email
â”‚   â”‚   â””â”€â”€ ResendEmailService.ts
â”‚   â”œâ”€â”€ FactoryService.ts
â”‚   â”œâ”€â”€ GamificationService.ts
â”‚   â””â”€â”€ PostService.ts
â””â”€â”€ types
    â”œâ”€â”€ actions.ts
    â”œâ”€â”€ config.ts
    â”œâ”€â”€ database.types.ts
    â”œâ”€â”€ index.ts
    â”œâ”€â”€ joins.ts
    â””â”€â”€ models.ts


CONTINGUT DELS FITXERS


// =================== FILE: src/actions/contact.ts ===================

'use server';

import { z } from 'zod';
import { createClient } from '@/lib/supabase/server';
// 1. Definim el tipus per al 'prevState' per evitar l'error d'ESLint


export type FormState = {
  success: boolean;
  message?: string;
  errors?: {
    fullName?: string[];
    email?: string[];
    service?: string[];
    message?: string[];
    privacy?: string[];
  };
};

// 2. Corregim l'schema de Zod
const ContactSchema = z.object({
  fullName: z.string().min(2, "Nom massa curt"),
  email: z.string().email("Email invÃ lid"),
  service: z.string().min(1, "Selecciona un servei"),
  message: z.string().min(10, "Explica'ns una mica mÃ©s"),
  // SOLUCIÃ“ ZOD: Usem errorMap aquÃ­ o simplement 'message'
  privacy: z.literal("on", { 
    message: "Has d'acceptar la polÃ­tica de privacitat" 
  }),
});

export async function submitContactForm(
  prevState: FormState, // Tipatge correcte
  formData: FormData
): Promise<FormState> {
  const rawData = Object.fromEntries(formData.entries());
  
  // Validar dades
  const validated = ContactSchema.safeParse(rawData);
  if (!validated.success) {
    return { 
      success: false, 
      errors: validated.error.flatten().fieldErrors 
    };
  }

  try {
   // 1. Creem el client tipat
  const supabase = await createClient(); 
  
  // 2. InserciÃ³ TIPADA i CORRECTA
  // NO facis: .from('contact_leads' as ContactLead) <- AixÃ² dÃ³na l'error que tenies
  // Has de fer servir l'string literal tal qual:
  const { error } = await supabase
    .from('contact_leads') 
    .insert({
      full_name: validated.data.fullName,
      email: validated.data.email,
      service: validated.data.service,
      message: validated.data.message,
      source: 'landing_contact_form'
    });

  if (error) {
    console.error("Error saving lead:", error);
    return { success: false, message: "Error tÃ¨cnic. Torna-ho a provar." };
  }

  return { success: true, message: "Missatge enviat! Et contactarem aviat." };
}
catch (err) {
    console.error("Unexpected error:", err);
    return { success: false, message: "Error inesperat. Torna-ho a provar." };
    }
  }

// =================== FILE: src/adapters/google/PageSpeedAdapter.ts ===================

import { IWebScanner, ScanResult, AuditIssue } from '@/adapters/IWebScanner';

export class PageSpeedAdapter implements IWebScanner {
  private apiKey: string;
  private apiUrl = 'https://www.googleapis.com/pagespeedonline/v5/runPagespeed';

  constructor(apiKey: string) {
    this.apiKey = apiKey;
  }

  async scanUrl(url: string): Promise<ScanResult> {
    // Demanem categories: PERFORMANCE, SEO, BEST_PRACTICES, ACCESSIBILITY
    const endpoint = `${this.apiUrl}?url=${encodeURIComponent(url)}&key=${this.apiKey}&category=PERFORMANCE&category=SEO&category=ACCESSIBILITY&strategy=mobile`;

    const response = await fetch(endpoint);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Google API Error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    const lighthouse = data.lighthouseResult;

    // 1. Extraure Puntuacions
    const performanceScore = Math.round((lighthouse.categories.performance?.score || 0) * 100);
    const seoScore = Math.round((lighthouse.categories.seo?.score || 0) * 100);

    // 2. Extraure la Captura de Pantalla (Base64)
    // Google la torna a 'lighthouse.audits["final-screenshot"].details.data'
    const screenshot = lighthouse.audits['final-screenshot']?.details?.data;

    // 3. Extraure Problemes (Issues)
    // Busquem audits que tinguin un score baix (< 0.9) i que siguin rellevants
    const issues: AuditIssue[] = [];
    const auditsObj = lighthouse.audits;

    // Llista d'IDs d'auditoria que ens interessen (Google en tÃ© molts)
    const criticalAudits = [
        'first-contentful-paint',
        'largest-contentful-paint',
        'cumulative-layout-shift',
        'server-response-time',
        'render-blocking-resources',
        'uses-optimized-images',
        'meta-description',
        'document-title',
        'link-text'
    ];

    criticalAudits.forEach((key) => {
        const audit = auditsObj[key];
        // Si existeix i la puntuaciÃ³ no Ã©s perfecta (< 0.9) o Ã©s informativa
        if (audit && typeof audit.score === 'number' && audit.score < 0.9) {
            issues.push({
                id: key,
                title: audit.title,
                description: audit.description,
                score: audit.score,
                displayValue: audit.displayValue
            });
        }
    });

    return {
      seoScore,
      performanceScore,
      screenshot, // Ara tenim la foto!
      issues,     // Ara tenim la llista de problemes!
      reportData: data // Guardem l'original per si de cas
    };
  }
}

// =================== FILE: src/adapters/google/schemas.ts ===================

import { z } from 'zod';

// 1. Esquema per a una mÃ¨trica individual (Audit)
export const LighthouseAuditSchema = z.object({
  id: z.string(),
  title: z.string().optional(),
  description: z.string().optional(),
  score: z.number().nullable().optional(),
  displayValue: z.string().optional(),
  numericValue: z.number().optional(),
  // Utilitzem .catch() o .optional() per evitar trencaments si ve alguna cosa rara
  details: z.record(z.string(), z.unknown()).optional(), 
});

// 2. Esquema per a les Categories
const CategorySchema = z.object({
  score: z.number().nullable().optional(),
});

// 3. Esquema Principal de la Resposta de Google
export const PageSpeedResponseSchema = z.object({
  lighthouseResult: z.object({
    categories: z.object({
      performance: CategorySchema.optional(),
      seo: CategorySchema.optional(),
      accessibility: CategorySchema.optional(),
      'best-practices': CategorySchema.optional(),
    }),
    // âš ï¸ CORRECCIÃ“ CRÃTICA AQUÃ ğŸ‘‡
    // Definim explÃ­citament que la CLAU Ã©s un string
    audits: z.record(z.string(), LighthouseAuditSchema),
  }),
});

// Exportem el tipus inferit
export type PageSpeedResponse = z.infer<typeof PageSpeedResponseSchema>;

// =================== FILE: src/adapters/GooglePageSpeedAdapter.ts ===================

import { IWebScanner, ScanResult, AuditIssue } from './IWebScanner';
import { translateIssue } from '@/lib/audit-dictionary';
// Assegura't que la ruta d'importaciÃ³ Ã©s correcta
import { PageSpeedResponseSchema } from './google/schemas';

export const AUDIT_TRANSLATIONS: Record<
    string, // id de l'auditoria
    Record<
        string, // locale, p.ex. 'ca', 'es', 'en'
        { title: string; description: string }
    >
> = {
    'is-on-https': {
        ca: {
            title: 'El lloc web no utilitza HTTPS segur',
            description: 'La teva web no Ã©s segura. AixÃ² espanta els clients i Google et penalitza greument.'
        },
        es: {
            title: 'El sitio web no usa HTTPS seguro',
            description: 'Tu web no es segura. Esto asusta a los clientes y Google te penaliza.'
        },
        en: {
            title: 'Website is not using secure HTTPS',
            description: 'Your website is not secure. This scares users and Google may penalize you.'
        }
    },
    // ... altres auditories
};

export class GooglePageSpeedAdapter implements IWebScanner {
    private apiKey?: string;
    private apiUrl = 'https://www.googleapis.com/pagespeedonline/v5/runPagespeed';

    constructor(apiKey?: string) {
        this.apiKey = apiKey;
    }

    async scanUrl(url: string, locale: string = 'ca'): Promise<ScanResult> {
        const params = new URLSearchParams({
            url,
            strategy: 'mobile',
            locale, // ara ve de fora
        });
        try {
            const check = await fetch(url, { method: 'HEAD' });
            if (check.status >= 400) {
                throw new Error(`La web retorna un error ${check.status}.`);
            }
        } catch (e) {
            console.error("Error connectant amb la web:", e);
            throw new Error(`No s'ha pogut accedir a la web: ${url}`);
        }



        ['PERFORMANCE', 'SEO', 'ACCESSIBILITY', 'BEST_PRACTICES'].forEach(cat => {
            params.append('category', cat);
        });
        if (this.apiKey) {
            params.append('key', this.apiKey);
        }

        // 3. CRIDA A GOOGLE
        const response = await fetch(`${this.apiUrl}?${params.toString()}`);

        if (!response.ok) {
            const errText = await response.text();
            throw new Error(`Google API Error (${response.status}): ${errText}`);
        }

        const rawJson = await response.json();

        // ğŸ›¡ï¸ VALIDACIÃ“ ZOD
        const validation = PageSpeedResponseSchema.safeParse(rawJson);

        if (!validation.success) {
            console.error("âŒ Dades invÃ lides de Google API:", validation.error);
            throw new Error("Error processant l'auditoria: L'estructura de dades de Google no Ã©s correcta.");
        }

        // Ara TypeScript sap perfectament quÃ¨ Ã©s 'data'
        const data = validation.data;
        const lh = data.lighthouseResult;

        // 4. EXTRACCIÃ“ DE PUNTUACIONS
        const scores = {
            performance: Math.round((lh.categories.performance?.score || 0) * 100),
            seo: Math.round((lh.categories.seo?.score || 0) * 100),
        };

        const audits = lh.audits;

        // 5. EXTRACCIÃ“ DE CORE WEB VITALS
        const getMetric = (key: string, desc: string) => {
            const audit = audits[key];
            return {
                value: audit?.displayValue,
                score: audit?.score ?? 0,
                description: desc
            };
        };

        const metrics = {
            fcp: getMetric('first-contentful-paint', "Temps fins al primer contingut visible."),
            lcp: getMetric('largest-contentful-paint', "Temps de cÃ rrega de l'element mÃ©s gran."),
            cls: getMetric('cumulative-layout-shift', "Estabilitat visual."),
            tbt: getMetric('total-blocking-time', "Temps de bloqueig del navegador."),
            si: getMetric('speed-index', "Ãndex de velocitat visual.")
        };

        // 6. PROCESSAMENT D'ERRORS (ISSUES)
        const issues: AuditIssue[] = Object.values(audits)
            .filter(a => typeof a.score === 'number' && a.score < 0.9)
            .map(a => {
                const cleanDescription = a.description?.split('[')[0].replace(/\.$/, '') || '';
                const translated = translateIssue(
                    a.id,
                    a.title || 'Unknown Issue',
                    a.description || '',
                    locale
                ); return {
                    id: a.id,
                    title: translated.title || a.title || 'Unknown Issue',
                    description: translated.description || cleanDescription,
                    score: a.score || 0,
                    displayValue: a.displayValue
                };
            })
            .sort((a, b) => a.score - b.score)
            .slice(0, 8);

        // 7. EXTRACCIÃ“ DE CAPTURA (Amb Type Guard)
        const screenshotAudit = audits['final-screenshot'];
        let screenshotData: string | undefined;

        // Verifiquem que 'details' existeixi i tingui la propietat 'data'
        if (screenshotAudit?.details && typeof screenshotAudit.details === 'object') {
            // Fem un cast segur perquÃ¨ sabem que Google torna { type: 'screenshot', data: 'base64...' }
            const details = screenshotAudit.details as { data?: string };
            if (details.data) {
                screenshotData = details.data;
            }
        }

        return {
            seoScore: scores.seo,
            performanceScore: scores.performance,
            screenshot: screenshotData,
            issues: issues,
            metrics: metrics,
            reportData: data
        };
    }
}

// =================== FILE: src/adapters/IWebScanner.ts ===================

import { AuditMetric } from '@/features/audit/ui/components/CoreVitalsGrid';

export type AuditIssue = {
  id: string;          // ğŸ‘ˆ AFEGIT: Necessari per traduir a la UI
  title: string;
  description: string;
  score: number;       
  displayValue?: string;
  impact?: string;     
  type?: 'error' | 'warning' | 'success';
};

export type ScanResult = {
  seoScore: number;
  performanceScore: number;
  screenshot?: string; 
  issues: AuditIssue[]; 
  reportData: unknown; 
  metrics?: {
    fcp?: AuditMetric;
    lcp?: AuditMetric;
    cls?: AuditMetric;
    tbt?: AuditMetric;
    si?: AuditMetric;
  };
};

export interface IWebScanner {
  scanUrl(url: string): Promise<ScanResult>;
}

// =================== FILE: src/app/actions/get-users.ts ===================

'use server'

import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';

export type UserProfile = {
  id: string;
  email: string;
  role: 'admin' | 'client' | 'lead';
  created_at: string;
  full_name: string | null;
};

export async function getAdminUsersList(): Promise<UserProfile[]> {
  const supabase = await createClient();
 
  // 1. Verificar sessiÃ³ actual
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) redirect('/auth/login');

  // 2. ğŸ›¡ï¸ SUPER ADMIN CHECK
  // Si el correu Ã©s el de la variable d'entorn, ets admin SI o SI.
  const isSuperAdmin = user.email === process.env.ADMIN_EMAIL;

  if (!isSuperAdmin) {
    // Si no ets el Super Admin per variable, comprovem la base de dades
    const { data: currentUserProfile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single();

    if (currentUserProfile?.role !== 'admin') {
      redirect('/'); // Fora d'aquÃ­
    }
  }

  // 3. Obtenir dades
  // NOTA IMPORTANT: Encara que el codi et deixi passar, el RLS (Row Level Security) 
  // de Supabase et pot bloquejar les dades si el teu rol a la DB no Ã©s 'admin'.
  const { data: profiles, error } = await supabase
    .from('profiles')
    .select('*')
    .order('created_at', { ascending: false });

  if (error) {
    console.error('Error fetching users:', error);
    return [];
  }

  return profiles as UserProfile[];
}

// =================== FILE: src/app/globals.css ===================

@import "tailwindcss";
@plugin "tailwindcss-animate";
/* ğŸ‘‡ AQUESTA Ã‰S LA LÃNIA MÃ€GICA ğŸ‘‡ */
@custom-variant dark (&:is(.dark *));
/* =========================================
   1. VARIABLES DE COLOR
   ========================================= */
:root {
  /* Mode Clar (EstÃ ndard) */
  --background: 0 0% 100%;
  --foreground: 260 10% 3.9%; /* Lleugerament tintat */
  --card: 0 0% 100%;
  --card-foreground: 260 10% 3.9%;
  --popover: 0 0% 100%;
  --popover-foreground: 260 10% 3.9%;
  --primary: 262 83% 58%;
  --primary-foreground: 0 0% 98%;
  --secondary: 260 4.8% 95.9%;
  --secondary-foreground: 260 5.9% 10%;
  --muted: 260 4.8% 95.9%;
  --muted-foreground: 260 3.8% 46.1%;
  --accent: 260 4.8% 95.9%;
  --accent-foreground: 260 5.9% 10%;
  --destructive: 0 84.2% 60.2%;
  --destructive-foreground: 0 0% 98%;
  --border: 260 5.9% 90%;
  --input: 260 5.9% 90%;
  --ring: 262 83% 58%;
  --radius: 0.75rem;
  --p: 222 47% 11%;
}

.dark {
  /* âœ¨ EL COLOR QUE BUSCAVES: Negre Apagat amb toc Lila */
  /* HSL: Hue 260 (Lila), Sat 8% (Apagat), Light 4% (Fosc casi negre) */
  /* CORREGIT: Afegit el '4%' que faltava */
  --background: 260 8% 4%; 
  --foreground: 260 10% 98%;

  /* Les targetes un pÃ¨l mÃ©s clares que el fons (Light 7%) per crear profunditat */
  --card: 260 14% 7%;
  --card-foreground: 260 10% 98%;

  /* Popovers encara mÃ©s foscos o igual que les cards */
  --popover: 260 14% 4%;
  --popover-foreground: 260 10% 98%;

  /* El morat de la marca (Vibrant) */
  --primary: 263 70% 50%;
  --primary-foreground: 0 0% 98%;

  /* Elements secundaris (Gris fosc lilos) */
  --secondary: 260 15% 12%;
  --secondary-foreground: 0 0% 98%;

  /* Gris "Muted" */
  --muted: 260 15% 12%;
  --muted-foreground: 260 10% 65%;

  --accent: 260 15% 12%;
  --accent-foreground: 0 0% 98%;

  --destructive: 0 62.8% 30.6%;
  --destructive-foreground: 0 0% 98%;

  /* Vores molt subtils */
  --border: 260 15% 12%;
  --input: 260 15% 12%;
  --ring: 263 70% 50%;

  /* P: Color addicional per grÃ fics o textos especÃ­fics */
  --p: 216 12% 84%; /* slate-300 */
}

/* =========================================
   2. CONFIGURACIÃ“ DEL TEMA (Tailwind v4)
   ========================================= */
@theme inline {
  --color-background: hsl(var(--background));
  --color-foreground: hsl(var(--foreground));
  --color-card: hsl(var(--card));
  --color-card-foreground: hsl(var(--card-foreground));
  --color-popover: hsl(var(--popover));
  --color-popover-foreground: hsl(var(--popover-foreground));
  --color-primary: hsl(var(--primary));
  --color-primary-foreground: hsl(var(--primary-foreground));
  --color-secondary: hsl(var(--secondary));
  --color-secondary-foreground: hsl(var(--secondary-foreground));
  --color-muted: hsl(var(--muted));
  --color-muted-foreground: hsl(var(--muted-foreground));
  --color-accent: hsl(var(--accent));
  --color-accent-foreground: hsl(var(--accent-foreground));
  --color-destructive: hsl(var(--destructive));
  --color-destructive-foreground: hsl(var(--destructive-foreground));
  --color-border: hsl(var(--border));
  --color-input: hsl(var(--input));
  --color-ring: hsl(var(--ring));

  --radius-xl: calc(var(--radius) + 4px);
  --radius-lg: var(--radius);
  --radius-md: calc(var(--radius) - 2px);
  --radius-sm: calc(var(--radius) - 4px);

  --animate-floating: floating 6s ease-in-out infinite;
  --animate-pulse-glow: pulse-glow 2s ease-in-out infinite alternate;

  @keyframes floating {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
  }
  @keyframes pulse-glow {
    from { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
    to { box-shadow: 0 0 40px rgba(168, 85, 247, 0.8); }
  }
}

/* =========================================
   3. BASE & COMPONENTS
   ========================================= */
@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground antialiased;
    font-feature-settings: "rlig" 1, "calt" 1;
  }
}

@layer components {
  
  /* ICONES MODERNS (Tal com sortien a les imatges) */
  .benefit-icon {
    @apply w-14 h-14 rounded-2xl flex items-center justify-center mb-6 transition-all duration-300;
    /* Degradat molt subtil sobre el fons fosc */
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(99, 102, 241, 0.15) 100%);
    border: 1px solid rgba(168, 85, 247, 0.2);
    box-shadow: 0 0 0 1px rgba(168, 85, 247, 0.05); /* Ring subtil */
  }

  /* Efecte Hover Glow */
  .group:hover .benefit-icon {
    @apply scale-110 border-primary/50;
    box-shadow: 0 0 25px rgba(168, 85, 247, 0.3);
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.25) 0%, rgba(99, 102, 241, 0.25) 100%);
  }

  /* Targetes Futuristes (MÃ©s netes, estil "Glass") */
  .solution-card-futuristic {
    @apply bg-white/[0.03] border border-white/[0.08] backdrop-blur-sm rounded-2xl p-8 transition-all duration-300;
  }
  
  .solution-card-futuristic:hover {
    @apply border-primary/40 bg-white/[0.06] -translate-y-1;
  }

  /* Inputs (Fons transparent o molt fosc) */
  .input-dark {
    @apply bg-white/[0.03] border border-white/10 text-white placeholder:text-muted-foreground focus:border-primary focus:ring-1 focus:ring-primary rounded-lg;
  }

  .testimonial-card {
    @apply bg-white/[0.03] border border-white/10 backdrop-blur-md rounded-2xl p-8 transition-all duration-300;
  }
}

@layer utilities {
  .gradient-text {
    @apply bg-gradient-to-r from-[#a855f7] to-[#6366f1] bg-clip-text text-transparent;
  }
  .gradient-bg {
    @apply bg-gradient-to-r from-[#a855f7] to-[#6366f1];
  }
  .section-divider {
     /* LÃ­nia divisÃ²ria molt subtil, quasi invisible */
     @apply h-[1px] w-full bg-gradient-to-r from-transparent via-white/10 to-transparent my-12;
  }
}

// =================== FILE: src/app/layout.tsx ===================

// src/app/layout.tsx
import { ReactNode } from 'react';

type Props = {
  children: ReactNode;
};

// Aquest component nomÃ©s existeix perquÃ¨ Next.js no es queixi.
// El middleware s'encarrega d'enviar l'usuari a /[locale]/..., 
// per tant, l'usuari mai veurÃ  aquest HTML "buit".
export default function RootLayout({ children }: Props) {
  return children;
}

// =================== FILE: src/app/manifest.ts ===================

import { MetadataRoute } from 'next';

export default function manifest(): MetadataRoute.Manifest {
  return {
    name: 'DigitAI Studios',
    short_name: 'DigitAI',
    description: 'AgÃ¨ncia de desenvolupament web, apps i automatitzaciÃ³ IA.',
    start_url: '/',
    display: 'standalone', // Fa que sembli una App real (sense barra de navegador)
    background_color: '#020817', // El color "Midnight Indigo" del teu dark mode
    theme_color: '#020817',
    orientation: 'portrait',
    icons: [
      {
        "src": "/web-app-manifest-192x192.png",
        "sizes": "192x192",
        "type": "image/png",
        "purpose": "maskable"
      },
      {
        "src": "/web-app-manifest-512x512.png",
        "sizes": "512x512",
        "type": "image/png",
        "purpose": "maskable"
      },
      {
        src: '/icons/apple-icon.png',
        sizes: '180x180',
        type: 'image/png',
        purpose: 'maskable', // Important per a Android modern
      },
    ],
  };
}

// =================== FILE: src/app/not-found.tsx ===================

'use client';
import Link from 'next/link';

// This handles 404s that happen outside of the [locale] structure
export default function GlobalNotFound() {
  return (
    <html lang="en">
      <body className="bg-white text-black dark:bg-black dark:text-white">
        <div className="flex min-h-screen flex-col items-center justify-center p-4 text-center font-sans">
          <h1 className="text-4xl font-bold mb-4">404</h1>
          <p className="mb-8">Page not found.</p>
          {/* Hard navigation to root to attempt recovery */}
          <Link href="/" className="underline hover:text-purple-500">
            Return Home
          </Link>
        </div>
      </body>
    </html>
  );
}

// =================== FILE: src/app/robots.ts ===================

import { MetadataRoute } from 'next';

export default function robots(): MetadataRoute.Robots {
  return {
    rules: {
      userAgent: '*',
      allow: '/',
      disallow: ['/admin/', '/dashboard/'], // ğŸ›¡ï¸ Protegim les zones privades
    },
    sitemap: 'https://digitaistudios.com/sitemap.xml', // URL final
  };
}

// =================== FILE: src/app/sitemap.ts ===================

import { MetadataRoute } from 'next';
import { postService } from '@/services/container';

// âš ï¸ IMPORTNAT: Canvia aixÃ² pel teu domini real quan despleguis
const BASE_URL = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const posts = await postService.getLatestPosts();
  const locales = ['es', 'ca', 'en']; // Els teus idiomes

  // 1. PÃ gines estÃ tiques (Home, Blog) per a cada idioma
  const staticPages = locales.flatMap((locale) => [
    {
      url: `${BASE_URL}/${locale}`,
      lastModified: new Date(),
      changeFrequency: 'weekly' as const,
      priority: 1,
    },
    {
      url: `${BASE_URL}/${locale}/blog`,
      lastModified: new Date(),
      changeFrequency: 'daily' as const,
      priority: 0.8,
    },
  ]);

  // 2. Entrades del Blog per a cada idioma
  const postEntries = posts.flatMap((post) => 
    locales.map((locale) => ({
      url: `${BASE_URL}/${locale}/blog/${post.slug}`,
      lastModified: post.date ? new Date(post.date) : new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.7,
    }))
  );

  return [...staticPages, ...postEntries];
}

// =================== FILE: src/app/[locale]/(marketing)/blog/page.tsx ===================

import { Link } from '@/routing';
import { postService } from '@/services/container';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { getTranslations, getLocale } from 'next-intl/server';
import { Calendar, Tag, ImageIcon, Cpu } from 'lucide-react'; // ğŸ‘ˆ Importat Heart
import Image from 'next/image';

export const revalidate = 3600;

export default async function BlogIndexPage() {
  const t = await getTranslations('BlogIndex');
  const locale = await getLocale();

  const posts = await postService.getLatestPosts();

  return (
    <div className="container mx-auto py-16 px-4">
      {/* CAPÃ‡ALERA */}
      <div className="text-center mb-16 space-y-4">
        <h1 className="text-4xl md:text-5xl font-extrabold tracking-tight text-foreground">
          {t('title')}
        </h1>
        <p className="text-muted-foreground text-lg md:text-xl max-w-2xl mx-auto leading-relaxed">
          {t('subtitle')}
        </p>
      </div>

      {/* GRID DE POSTS */}
      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {posts.map((post) => (
          <Link key={post.slug} href={`/blog/${post.slug}`} className="block group h-full">
            <Card className="h-full flex flex-col overflow-hidden border border-border bg-card dark:bg-[#0f111a] hover:border-primary/50 transition-all duration-300 shadow-sm hover:shadow-2xl hover:-translate-y-1">

              {/* ZONA IMATGE */}
              <div className="relative h-56 w-full bg-muted dark:bg-slate-800 overflow-hidden">

                {/* ğŸ”´ INSÃGNIA DE VALORACIONS (AixÃ² faltava al teu codi) */}
                {/* ğŸ‘‡ 2. BADGE TECNOLÃ’GIC RENOVAT */}
                {(post.totalReactions || 0) > 0 && (
                  <div className="absolute top-3 right-3 z-20 flex items-center gap-1.5 
                        bg-slate-900/80 backdrop-blur-md 
                        px-3 py-1 rounded-full 
                        text-cyan-400 text-xs font-bold font-mono
                        shadow-[0_0_15px_rgba(34,211,238,0.3)] 
                        border border-cyan-500/30 
                        animate-in fade-in zoom-in duration-300">

                    {/* Icona Tech */}
                    <Cpu className="w-3.5 h-3.5" />

                    {/* Separador vertical petit */}
                    <span className="h-3 w-px bg-cyan-500/30 mx-0.5"></span>

                    {post.totalReactions}
                  </div>
                )}

                {post.coverImage ? (
                  <Image
                    src={post.coverImage}
                    alt={post.title}
                    fill
                    className="object-cover transition-transform duration-700 group-hover:scale-105"
                    sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                  />
                ) : (
                  <div className="flex flex-col items-center justify-center h-full text-muted-foreground/50">
                    <ImageIcon className="w-10 h-10 mb-2 opacity-50" />
                    <span className="text-xs font-medium uppercase tracking-widest">{t('fallback_image')}</span>
                  </div>
                )}

                {/* Overlay fosc */}
                <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300 pointer-events-none" />
              </div>

              <CardHeader className="pb-2 pt-6">
                <div className="flex justify-between items-center mb-3">
                  <div className="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full bg-primary/10 text-primary text-[10px] font-bold uppercase tracking-wider">
                    <Tag className="w-3 h-3" />
                    {post.tags[0] ?? 'TECH'}
                  </div>
                  {post.date && (
                    <div className="flex items-center gap-1.5 text-xs text-muted-foreground font-medium">
                      <Calendar className="w-3 h-3" />
                      {new Intl.DateTimeFormat(locale, { dateStyle: 'medium' }).format(new Date(post.date))}
                    </div>
                  )}
                </div>

                <CardTitle className="text-xl font-bold text-foreground group-hover:text-primary transition-colors line-clamp-2 leading-tight">
                  {post.title}
                </CardTitle>
              </CardHeader>

              <CardContent className="flex-1 flex flex-col justify-between">
                <p className="text-muted-foreground text-sm leading-relaxed line-clamp-3 mb-6">
                  {post.description}
                </p>
                <div className="text-sm font-bold text-primary flex items-center gap-2 opacity-80 group-hover:opacity-100 transition-all group-hover:gap-3">
                  Llegir article <span className="text-lg leading-none">&rarr;</span>
                </div>
              </CardContent>
            </Card>
          </Link>
        ))}

        {posts.length === 0 && (
          <div className="col-span-full py-24 text-center bg-muted/20 rounded-3xl border border-dashed border-border flex flex-col items-center justify-center">
            <div className="w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4">
              <Tag className="w-8 h-8 text-muted-foreground" />
            </div>
            <h3 className="text-lg font-bold text-foreground mb-1">{t('no_posts')}</h3>
            <p className="text-muted-foreground text-sm">No s'han trobat publicacions per a aquesta organitzaciÃ³.</p>
          </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/blog/[slug]/page.tsx ===================

import { notFound } from 'next/navigation';
import { postService } from '@/services/container';
import { MDXContent } from '@/features/blog/ui/MDXContent';
import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Calendar, User } from 'lucide-react';
import { Metadata } from 'next';
import { getTranslations, getLocale } from 'next-intl/server'; // ğŸ‘ˆ
import { ReactionDock } from '@/features/blog/ui/ReactionDock';
import { postRepository } from '@/services/container'; // Importem el repo directament per carregar dades inicials

type Props = {
  params: Promise<{ slug: string; locale: string }>;
};

export const revalidate = 3600;

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  // Necessitem el slug per buscar el post, perÃ² no tenim accÃ©s a 't' aquÃ­ fÃ cilment
  // pel tÃ­tol, aixÃ­ que usem les dades del post directament.
  const { slug } = await params;
  const post = await postService.getPost(slug);

  if (!post) {
    return { title: '404 - Article no trobat' };
  }

  return {
    title: post.title,
    description: post.description,
    openGraph: {
      title: post.title,
      description: post.description || '',
      type: 'article',
      publishedTime: post.date || undefined,
      tags: post.tags,
      images: post.coverImage ? [{ url: post.coverImage }] : undefined,
    },
    twitter: {
      card: 'summary_large_image',
      title: post.title,
      description: post.description || '',
      images: post.coverImage ? [post.coverImage] : [],
    },
  };
}

export default async function BlogPostPage({ params }: Props) {
  const { slug } = await params;
  const post = await postService.getPost(slug);

  // Hooks de traducciÃ³
  const t = await getTranslations('BlogPost');
  const locale = await getLocale();

  if (!post) notFound();
  // 1. Carreguem les reaccions inicials des del servidor (Server Side Rendering)
  // AixÃ² fa que els nÃºmeros siguin correctes abans que el JS del client carregui
  const reactions = await postRepository.getPostReactions(slug);
  return (
    <div className="min-h-screen bg-background pb-20">

      {/* 1. HERO SECTION */}
      <div className="relative w-full flex items-end justify-center overflow-hidden min-h-[60vh] lg:min-h-[70vh] bg-slate-950">

        {/* Fons */}
        <div className="absolute inset-0 bg-slate-900">
          {post.coverImage ? (
            <div
              className="absolute inset-0 bg-cover bg-center opacity-50"
              style={{ backgroundImage: `url(${post.coverImage})` }}
            />
          ) : (
            <div className="absolute inset-0 bg-linear-to-br from-blue-900 via-indigo-900 to-slate-900 opacity-80" />
          )}
          <div className="absolute inset-0 bg-linear-to-t from-background via-background/60 to-transparent" />
        </div>

        {/* Contingut Hero */}
        <div className="relative z-10 container px-4 text-center max-w-4xl mx-auto pb-24 pt-32">

          <h1 className="text-3xl md:text-5xl lg:text-7xl font-extrabold tracking-tight text-foreground mb-6 leading-tight drop-shadow-xl animate-in fade-in slide-in-from-bottom-6 duration-1000">
            {post.title}
          </h1>

          <div className="flex flex-wrap justify-center items-center gap-4 md:gap-8 text-muted-foreground font-medium text-sm md:text-base animate-in fade-in slide-in-from-bottom-8 duration-1000 delay-100">
            {/* Tags */}
            <div className="flex flex-wrap justify-center gap-2 mb-6 w-full animate-in fade-in slide-in-from-bottom-4 duration-700">
              {post.tags.map(tag => (
                <span key={tag} className="px-3 py-1 rounded-full bg-foreground/10 text-foreground backdrop-blur-md border border-primary/30 text-[10px] md:text-xs font-bold uppercase tracking-wider">
                  {tag}
                </span>
              ))}
            </div>

            <div className="flex items-center gap-2">
              <div className="w-8 h-8 rounded-full bg-muted flex items-center justify-center border border-border">
                <User className="w-4 h-4" />
              </div>
              <span>{t('by_author')}</span>
            </div>

            <div className="flex items-center gap-2">
              <Calendar className="w-4 h-4 opacity-70" />
              <span>
                {post.date
                  ? new Intl.DateTimeFormat(locale, { dateStyle: 'long' }).format(new Date(post.date))
                  : 'Avui'
                }
              </span>
            </div>
          </div>
        </div>
      </div>

      {/* 2. CONTINGUT */}
      <div className="container px-4 -mt-12 relative z-20 max-w-4xl mx-auto">
        <div className="bg-card text-card-foreground rounded-3xl p-6 md:p-12 lg:p-16 shadow-2xl ring-1 ring-border/50">

          <p className="text-xl md:text-2xl lg:text-3xl font-serif text-muted-foreground leading-relaxed mb-8 md:mb-12 border-b border-border pb-8">
            {post.description}
          </p>

          <div className="prose prose-lg dark:prose-invert max-w-none prose-headings:font-bold prose-headings:tracking-tight prose-a:text-primary prose-img:rounded-xl prose-img:shadow-lg">
            <MDXContent source={post.content || ''} />
          </div>
          <ReactionDock slug={slug} initialCounts={reactions} />
          {/* Footer Card */}
          <div className="mt-16 p-6 md:p-10 rounded-2xl bg-muted/30 border border-border text-center">
            <h3 className="text-xl md:text-2xl font-bold mb-4">{t('share_title')}</h3>
            <p className="text-muted-foreground mb-6 max-w-md mx-auto text-sm md:text-base">
              {t('share_subtitle')}
            </p>

            <div className="flex flex-col sm:flex-row justify-center gap-4">
              <Link href="/blog">
                <Button variant="outline" className="w-full sm:w-auto">
                  <ArrowLeft className="mr-2 h-4 w-4" /> {t('back_button')}
                </Button>
              </Link>
              <Link href="/">
                <Button className="w-full sm:w-auto gradient-bg text-white border-0 shadow-lg hover:opacity-90">
                  {t('cta_audit')}
                </Button>
              </Link>
            </div>
          </div>

        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/layout.tsx ===================

import { Navbar } from '@/components/layout/Navbar';
import { Footer } from '@/components/layout/Footer';
import { createClient } from '@/lib/supabase/server';

export default async function MarketingLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // 1. Obtenim la sessiÃ³ al Layout (es comparteix per a totes les rutes marketing)
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  return (
    <div className="flex min-h-screen flex-col bg-background selection:bg-primary/30">
      {/* 2. Passem l'usuari al Navbar */}
      <Navbar user={user} />
      
      <main className="flex-1">
        {children}
      </main>

      <Footer />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/legal/avis-legal/page.tsx ===================

import LegalLayout from '@/components/layout/LegalLayout';
import { Building2, Mail, MapPin, Fingerprint, AlertTriangle, Gavel } from 'lucide-react';
import { getTranslations } from 'next-intl/server';
import { getLocale } from 'next-intl/server'; // Per la data

export const metadata = {
  title: 'AvÃ­s Legal | DigitAI Studios',
  description: 'InformaciÃ³ legal i condicions d\'Ãºs de DigitAI Studios.',
};

export default async function AvisLegalPage() {
  const t = await getTranslations('Legal.avis_legal');
  const tCommon = await getTranslations('Legal.common');
  const locale = await getLocale();

  return (
    <LegalLayout>
      <div className="border-b border-border pb-8 mb-8">
        <h1 className="text-3xl md:text-4xl font-extrabold mb-4">{t('title')}</h1>
        <p className="text-xl text-muted-foreground leading-relaxed">
          {tCommon('transparency_desc')}
        </p>
        <p className="text-sm text-muted-foreground mt-4">{t('last_update_prefix')} {new Date().toLocaleDateString(locale)}</p>
      </div>

      {/* SECCIÃ“ 1: DADES IDENTIFICATIVES (GRID VISUAL) */}
      <section className="mb-12">
        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
            {t('section1_title')}
        </h2>
        <p className="mb-6">
           {t('section1_desc')}
        </p>
        
        <div className="grid sm:grid-cols-2 gap-4 not-prose">
           <InfoCard 
              icon={Building2} 
              label={t('data_card_company_label')} 
              value="[EL TEU NOM EMPRESA]" 
           />
           <InfoCard 
              icon={Fingerprint} 
              label={t('data_card_nif_label')} 
              value="[EL TEU NIF]" 
           />
           <InfoCard 
              icon={MapPin} 
              label={t('data_card_address_label')} 
              value={t('data_card_address_value')} 
           />
           <InfoCard 
              icon={Mail} 
              label={t('data_card_contact_label')} 
              value="info@digitaistudios.com" 
           />
        </div>
      </section>

      {/* SECCIÃ“ 2: OBJECTE */}
      <section className="mb-12">
        <h2>{t('section2_title')}</h2>
        <p>
          {t.rich('section2_p1', {
            strong: (chunks) => <strong>{chunks}</strong>
          })}
        </p>
        <p>
          {t('section2_p2')}
        </p>
      </section>

      {/* SECCIÃ“ 3: PROPIETAT INTELÂ·LECTUAL */}
      <section className="mb-12">
        <h2>{t('section3_title')}</h2>
        <div className="bg-muted/30 p-6 rounded-xl border-l-4 border-primary not-prose">
            <p className="text-sm text-muted-foreground">
                {t.rich('section3_quote', {
                  strong: (chunks) => <strong>{chunks}</strong>
                })}
            </p>
        </div>
      </section>

      {/* SECCIÃ“ 4: RESPONSABILITAT */}
      <section className="mb-12">
         <h2 className="flex items-center gap-2">
            <AlertTriangle className="w-6 h-6 text-yellow-500" /> {t('section4_title')}
         </h2>
         <p>{t('section4_p1')}</p>
         <ul>
            <li>{t('section4_list_1')}</li>
            <li>{t('section4_list_2')}</li>
            <li>{t('section4_list_3')}</li>
         </ul>
      </section>

      {/* SECCIÃ“ 5: LLEI */}
      <section>
         <h2 className="flex items-center gap-2">
            <Gavel className="w-6 h-6 text-primary" /> {t('section5_title')}
         </h2>
         <p>
            {t('section5_p1')}
         </p>
      </section>

    </LegalLayout>
  );
}

// Nota: El component InfoCard es mantÃ© igual, ja que les dades que rep (label, value) ja venen traduÃ¯des d'aquÃ­.

// Component petit per a les targetes de dades
import { LucideIcon } from 'lucide-react';

interface InfoCardProps {
    icon: LucideIcon;
    label: string;
    value: string;
}

function InfoCard({ icon: Icon, label, value }: InfoCardProps) {
    return (
        <div className="bg-background border border-border p-4 rounded-lg flex items-start gap-4 shadow-sm hover:border-primary/30 transition-colors">
            <div className="p-2 bg-primary/10 rounded-md shrink-0">
                <Icon className="w-5 h-5 text-primary" />
            </div>
            <div>
                <p className="text-xs text-muted-foreground font-medium uppercase tracking-wider">{label}</p>
                <p className="text-sm font-bold text-foreground mt-1">{value}</p>
            </div>
        </div>
    )
}

// =================== FILE: src/app/[locale]/(marketing)/legal/cookies/page.tsx ===================

import LegalLayout from '@/components/layout/LegalLayout';
import { Cookie, Settings, BarChart3, XCircle } from 'lucide-react';
import { getTranslations } from 'next-intl/server';
import { Link } from '@/routing'; // Necessari per Link

export const metadata = {
  title: 'PolÃ­tica de Cookies | DigitAI Studios',
  description: 'InformaciÃ³ sobre l\'Ãºs de cookies a DigitAI Studios.',
};

export default async function CookiesPage() {
  const t = await getTranslations('Legal.cookies');

  return (
    <LegalLayout>
      <div className="border-b border-border pb-8 mb-8">
        <h1 className="text-3xl md:text-4xl font-extrabold mb-4">{t('title')}</h1>
        <p className="text-xl text-muted-foreground leading-relaxed">
          {t('subtitle')}
        </p>
      </div>

      <div className="space-y-12">

        {/* BLOC 1: DEFINICIÃ“ */}
        <section>
          <h2 className="text-2xl font-bold flex items-center gap-2 mb-4">
            <Cookie className="text-orange-500" /> {t('section1_title')}
          </h2>
          <div className="bg-muted/30 p-6 rounded-xl border border-border">
            <p className="m-0">
              {t('section1_quote')}
            </p>
          </div>
        </section>

        {/* BLOC 2: TIPUS DE COOKIES (GRID) */}
        <section>
          <h2>{t('section2_title')}</h2>
          <p>{t('section2_p1')}</p>
          
          <div className="grid md:grid-cols-2 gap-6 not-prose my-6">
             {/* Cookies TÃ¨cniques */}
             <div className="p-5 rounded-xl border border-border bg-card shadow-sm">
                <div className="flex items-center gap-3 mb-3">
                   <div className="p-2 bg-primary/10 rounded-lg text-primary">
                      <Settings className="w-5 h-5" />
                   </div>
                   <h4 className="font-bold text-lg">{t('tech_title')}</h4>
                </div>
                <p className="text-sm text-muted-foreground mb-4">
                   {t('tech_desc')}
                </p>
                <ul className="space-y-2 text-sm">
                   <li className="flex items-center gap-2">
                      <span className="w-1.5 h-1.5 bg-primary rounded-full"></span>
                      <strong>{t.rich('tech_1', { strong: (chunks) => <strong>{chunks}</strong> })}</strong>
                   </li>
                   <li className="flex items-center gap-2">
                      <span className="w-1.5 h-1.5 bg-primary rounded-full"></span>
                      <strong>{t.rich('tech_2', { strong: (chunks) => <strong>{chunks}</strong> })}</strong>
                   </li>
                </ul>
             </div>

             {/* Cookies AnalÃ­tiques */}
             <div className="p-5 rounded-xl border border-border bg-card shadow-sm">
                <div className="flex items-center gap-3 mb-3">
                   <div className="p-2 bg-blue-500/10 rounded-lg text-blue-500">
                      <BarChart3 className="w-5 h-5" />
                   </div>
                   <h4 className="font-bold text-lg">{t('analytics_title')}</h4>
                </div>
                <p className="text-sm text-muted-foreground mb-4">
                   {t('analytics_desc')}
                </p>
                <ul className="space-y-2 text-sm">
                   <li className="flex items-center gap-2">
                      <span className="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>
                      <strong>{t.rich('analytics_1', { strong: (chunks) => <strong>{chunks}</strong> })}</strong>
                   </li>
                </ul>
             </div>
          </div>
        </section>

        {/* BLOC 3: DESACTIVACIÃ“ */}
        <section>
           <h2 className="flex items-center gap-2">
              <XCircle className="text-red-500" /> {t('section3_title')}
           </h2>
           <p>
             {t('section3_p1')}
           </p>
           
           <div className="flex flex-wrap gap-4 not-prose mt-4">
              <a href="https://support.google.com/chrome/answer/95647" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Google Chrome
              </a>
              <a href="https://support.apple.com/es-es/guide/safari/sfri11471/mac" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Safari
              </a>
              <a href="https://support.mozilla.org/es/kb/habilitar-y-deshabilitar-cookies-sitios-web-rastrear-preferencias" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Firefox
              </a>
              <a href="https://support.microsoft.com/es-es/microsoft-edge/eliminar-las-cookies-en-microsoft-edge-63947406-40ac-c23d-37fd-6b7ac978ce4a" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Microsoft Edge
              </a>
           </div>
        </section>

      </div>
    </LegalLayout>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/legal/privacitat/page.tsx ===================

import LegalLayout from '@/components/layout/LegalLayout';
import { ShieldCheck, Server, Lock } from 'lucide-react';
import { getTranslations } from 'next-intl/server';
import { Link } from '@/routing'; // Assegurem l'import de Link

export const metadata = {
  title: 'PolÃ­tica de Privacitat | DigitAI Studios',
};

export default async function PrivacitatPage() {
  const t = await getTranslations('Legal.privacitat');
  const tLegal = await getTranslations('Legal.avis_legal'); // Per l'AvÃ­s Legal

  return (
    <LegalLayout>
      <div className="border-b border-border pb-8 mb-8">
        <h1 className="text-3xl md:text-4xl font-extrabold mb-4">{t('title')}</h1>
        <p className="text-xl text-muted-foreground leading-relaxed">
          {t('subtitle')}
        </p>
      </div>

      <div className="space-y-12">
          
          {/* BLOC 1: RESPONSABLE */}
          <section>
              <h2 className="text-2xl font-bold flex items-center gap-2 mb-4">
                  <ShieldCheck className="text-green-500" /> {t('section1_title')}
              </h2>
              <div className="bg-muted/30 p-6 rounded-xl border border-border">
                  <p className="m-0">
                      {t.rich('section1_text', {
                          strong: (chunks) => <strong>{chunks}</strong>,
                          link: (chunks) => <a href="mailto:dpd@digitaistudios.com">{chunks}</a>
                      })}
                  </p>
              </div>
          </section>

          {/* BLOC 2: QUINES DADES */}
          <section>
              <h2>{t('section2_title')}</h2>
              <p>{t('section2_desc')}</p>
              <div className="grid md:grid-cols-2 gap-6 not-prose my-6">
                  <div className="p-4 rounded-lg border border-border bg-card">
                      <h4 className="font-bold text-lg mb-2 flex items-center gap-2">ğŸ” {t('data_audit_title')}</h4>
                      <p className="text-sm text-muted-foreground">{t('data_audit_desc')}</p>
                  </div>
                  <div className="p-4 rounded-lg border border-border bg-card">
                      <h4 className="font-bold text-lg mb-2 flex items-center gap-2">ğŸ‘¤ {t('data_account_title')}</h4>
                      <p className="text-sm text-muted-foreground">{t('data_account_desc')}</p>
                  </div>
              </div>
          </section>

          {/* BLOC 3: TERCERS */}
          <section>
              <h2 className="flex items-center gap-2"><Server className="text-blue-500" /> {t('section3_title')}</h2>
              <p>{t('section3_desc')}</p>
              <ul className="not-prose space-y-2 mt-4">
                  <li className="flex items-center gap-3 p-2 rounded hover:bg-muted/50">
                      <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                      <span><strong>{t('provider_supabase')}</strong></span>
                  </li>
                  <li className="flex items-center gap-3 p-2 rounded hover:bg-muted/50">
                      <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                      <span><strong>{t('provider_resend')}</strong></span>
                  </li>
                  <li className="flex items-center gap-3 p-2 rounded hover:bg-muted/50">
                      <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                      <span><strong>{t('provider_google')}</strong></span>
                  </li>
              </ul>
          </section>

          {/* BLOC 4: DRETS */}
          <section>
              <h2 className="flex items-center gap-2"><Lock className="text-primary" /> {t('section4_title')}</h2>
              <p>{t('section4_p1')}</p>
              <ul>
                  <li>{t('rights_list_1')}</li>
                  <li>{t('rights_list_2')}</li>
                  <li>{t('rights_list_3')}</li>
                  <li>{t('rights_list_4')}</li>
              </ul>
              <p>{t.rich('rights_contact', { strong: (chunks) => <strong>{chunks}</strong> })}</p>
          </section>

      </div>
    </LegalLayout>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/page.tsx ===================

import { HeroSection } from '@/components/landing/HeroSection';
import { TechStackSection } from '@/components/landing/TechStackSection';
import { ProblemSolutionSection } from '@/components/landing/ProblemSolutionsSection';
import { ServicesGrid } from '@/components/landing/ServicesGrid';
import { ProductTeaser } from '@/components/landing/ProductTeaser';
import { AuditSection } from '@/components/landing/AuditSection'; // Component Client
import { TestimonialsSection } from '@/components/landing/TestimonialsSection';
import { ContactSection } from '@/components/landing/ContactSection';
import { LatestPostsSection } from '@/components/landing/LatestPostsSection';
import { SolutionsShowcase } from '@/components/landing/solutions/SolutionsShowcase';
import { TESTIMONIALS } from '@/lib/data';

// Importem Supabase per comprovar sessiÃ³
import { createClient } from '@/lib/supabase/server';

export const maxDuration = 60; 

export default async function MarketingPage() {
  // 1. Obtenim sessiÃ³ al servidor
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  return (
    <>
      <HeroSection />
      <TechStackSection />
      {/*<ProblemSolutionSection />*/}
      <SolutionsShowcase />
      <ServicesGrid />
      <ProductTeaser />
      
      {/* 2. Passem l'usuari com a prop al component */}
      <AuditSection currentUser={user} />
      
      <LatestPostsSection />
      <TestimonialsSection testimonials={TESTIMONIALS} />
      <ContactSection />
    </>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/projectes/page.tsx ===================

// ARA (Import net des de la feature):
import { ProjectsHero, ProjectsList, ProjectsCTA } from '@/features/projects';

export default function ProjectsPage() {
  return (
    <main className="min-h-screen flex flex-col bg-background selection:bg-primary/30 transition-colors duration-300">
      <ProjectsHero />
      <ProjectsList />
      <ProjectsCTA />
    </main>
  );
}

// =================== FILE: src/app/[locale]/admin/analytics/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { analyticsRepository } from '@/services/container';
import { TrafficChart } from '@/features/analytics/ui/TrafficChart';
import { TopPagesCard } from '@/features/analytics/ui/TopPagesCard';
import { DeviceChart } from '@/features/analytics/ui/DeviceChart';
import { BarListChart } from '@/features/analytics/ui/BarListChart';
import { VerticalBarChart } from '@/features/analytics/ui/VerticalBarChart';
import { UnifiedStatBar } from '@/features/analytics/ui/UnifiedStatBar';

export const revalidate = 60;

function formatDuration(seconds: number): string {
  if (!seconds || seconds === 0) return '0s';
  if (seconds < 60) return `${Math.round(seconds)}s`;
  const m = Math.floor(seconds / 60);
  const s = Math.round(seconds % 60);
  return `${m}m ${s}s`;
}

export default async function AdminAnalyticsPage() {
  await requireAdmin();

  const [dailyStats, adv] = await Promise.all([
    analyticsRepository.getLast7DaysStats(),
    analyticsRepository.getAdvancedStats()
  ]);

  const totalViews = dailyStats.reduce((acc, day) => acc + day.views, 0);
  const totalVisitors = dailyStats.reduce((acc, day) => acc + day.visitors, 0);
  const grandTotalDuration = dailyStats.reduce((acc, day) => acc + (day.totalDuration || 0), 0);
  const averageTimeSeconds = totalVisitors > 0 ? grandTotalDuration / totalVisitors : 0;

return (
    <div className="flex flex-col gap-4 h-[calc(100vh-2rem)] p-4 overflow-hidden bg-background text-foreground">
      
      {/* 1. KPI HEADER */}
      <div className="shrink-0">
         <UnifiedStatBar 
            views={totalViews} 
            visitors={totalVisitors} 
            events={totalViews} 
            avgTime={formatDuration(averageTimeSeconds)} 
         />
      </div>

      {/* 2. DASHBOARD GRID (Modificat per donar mÃ©s espai a la dreta) */}
      {/* Canviem a grid-cols-3: 2/3 esquerra, 1/3 dreta */}
      <div className="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-4 min-h-0">
         
         {/* --- ZONA PRINCIPAL (Columna Esquerra i Centre - 66%) --- */}
         <div className="lg:col-span-2 flex flex-col gap-4 h-full min-h-0">
            
            {/* A. GRÃ€FIC TRÃ€NSIT */}
            <div className="flex-[2] min-h-0 bg-card border border-border rounded-xl shadow-sm overflow-hidden">
                <TrafficChart data={dailyStats} />
            </div>

            {/* B. DETALLS */}
            <div className="flex-[3] grid grid-cols-1 md:grid-cols-2 gap-4 min-h-0">
                <div className="min-h-0 overflow-hidden">
                    <TopPagesCard data={adv.topPages} />
                </div>
                <div className="min-h-0 overflow-hidden">
                    <BarListChart title="Fonts de TrÃ nsit" data={adv.referrers} />
                </div>
            </div>
         </div>

         {/* --- SIDEBAR DRET (Columna Dreta - 33%) --- */}
         <div className="lg:col-span-1 flex flex-col gap-4 h-full min-h-0 overflow-y-auto custom-scrollbar pr-1">
            
            <div className="flex-1 min-h-[200px]"> {/* Augmentem una mica l'alÃ§ada mÃ­nima */}
               <DeviceChart data={adv.devices} />
            </div>

            <div className="flex-1 min-h-[200px]">
               <VerticalBarChart title="Top PaÃ¯sos" data={adv.countries} />
            </div>

            <div className="flex-1 min-h-[200px]">
               <BarListChart title="Navegadors" data={adv.browsers} />
            </div>
         </div>

      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/blog/page.tsx ===================

// src/app/[locale]/admin/blog/page.tsx
import { requireAdmin } from '@/lib/auth/admin-guard';
import { postRepository } from '@/services/container';
import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { Plus } from 'lucide-react';
// Importem el llistat client que ja tenim, perÃ² el refactoritzarem visualment si calia
// De moment, netegem el contenidor pare.
import { AdminPostList } from '@/features/blog/ui/AdminPostList';

export default async function AdminBlogPage() {
  await requireAdmin();
  const posts = await postRepository.getAllPosts();

  return (
    <div className="space-y-6">
      
      {/* CAPÃ‡ALERA */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-foreground tracking-tight">GestiÃ³ del Blog</h1>
          <p className="text-muted-foreground text-sm mt-1">
            Gestiona els articles, estats i publicacions ({posts.length} totals).
          </p>
        </div>
        
        <Link href="/admin/blog/new">
            <Button className="gradient-bg text-white shadow-lg border-0">
               <Plus className="w-4 h-4 mr-2" /> Nou Article
            </Button>
        </Link>
      </div>

      {/* LLISTAT (Component Client) */}
      <div className="border border-border rounded-xl overflow-hidden bg-card shadow-sm">
         <AdminPostList posts={posts} />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/blog/[slug]/edit/page.tsx ===================

// src/app/[locale]/admin/blog/[slug]/edit/page.tsx

import { requireAdmin } from '@/lib/auth/admin-guard';
import { postRepository } from '@/services/container';
import { notFound } from 'next/navigation';
import { EditPostForm } from '@/features/blog/ui/EditPostForm'; // ğŸ‘ˆ El component que acabem de fer

type Props = {
    params: Promise<{ slug: string }>;
};

export default async function EditPostPage({ params }: Props) {
    await requireAdmin();
    const { slug } = await params;

    // Busquem el post (incloent esborranys)
    const post = await postRepository.getAdminPostBySlug(slug);

    if (!post) {
        return notFound();
    }

    return (
        <div className="min-h-screen bg-background p-4 md:p-8">
            <EditPostForm post={post} />
        </div>
    );
}

// =================== FILE: src/app/[locale]/admin/blog/[slug]/page.tsx ===================

// src/app/[locale]/admin/blog/[slug]/page.tsx

import { requireAdmin } from '@/lib/auth/admin-guard';
import { postRepository } from '@/services/container';
import { notFound } from 'next/navigation';
import { MDXContent } from '@/features/blog/ui/MDXContent';
import { Link } from '@/routing';
import { ArrowLeft, Save, Trash2, ExternalLink, CheckCircle2 } from 'lucide-react'; // ğŸ‘ˆ Importem CheckCircle2
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import Image from 'next/image';
import { PostStatusToggle } from '@/features/blog/ui/PostStatusToggle';

type Props = {
    params: Promise<{ slug: string }>;
};

export default async function AdminPostDetailPage({ params }: Props) {
    await requireAdmin();
    const { slug } = await params;

    const post = await postRepository.getAdminPostBySlug(slug);

    if (!post) {
        return notFound();
    }

    return (
        <div className="p-4 md:p-8 max-w-6xl mx-auto space-y-8"> {/* Ampliat max-w a 6xl per mÃ©s espai */}

            {/* HEADER MILLORAT */}
            <div className="flex flex-col md:flex-row justify-between items-start gap-6 border-b border-border pb-6">
                
                {/* BLOC ESQUERRA: TÃ­tol i Estat */}
                <div className="flex items-start gap-4 flex-1 min-w-0">
                    <Link href="/admin/blog">
                        <Button variant="outline" size="icon" className="shrink-0 rounded-full border-muted-foreground/20 text-muted-foreground hover:text-foreground">
                            <ArrowLeft className="w-5 h-5" />
                        </Button>
                    </Link>
                    
                    <div className="space-y-1 min-w-0">
                        <div className="flex items-center gap-3 flex-wrap">
                            <h1 className="text-2xl md:text-3xl font-bold text-foreground truncate max-w-full leading-tight">
                                {post.title}
                            </h1>
                            {/* INDICADOR DE REVISAT */}
                            {post.reviewed && (
                                <div className="flex items-center gap-1 text-green-600 dark:text-green-400 bg-green-500/10 px-2 py-0.5 rounded-full text-xs font-medium border border-green-500/20" title="Aquest post ha estat revisat">
                                    <CheckCircle2 className="w-3.5 h-3.5" />
                                    <span>Revisat</span>
                                </div>
                            )}
                        </div>

                        <div className="flex items-center gap-3 text-sm text-muted-foreground">
                            <span className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md text-xs font-bold uppercase tracking-wider border ${
                                post.published 
                                    ? 'bg-primary/10 text-primary border-primary/20' 
                                    : 'bg-muted text-muted-foreground border-border'
                            }`}>
                                <div className={`w-1.5 h-1.5 rounded-full ${post.published ? 'bg-primary' : 'bg-muted-foreground'}`} />
                                {post.published ? 'Publicat' : 'Esborrany'}
                            </span>
                            <span className="font-mono text-xs opacity-60 hidden sm:inline-block">/ {post.slug}</span>
                        </div>
                    </div>
                </div>

                {/* BLOC DRETA: Accions */}
                <div className="flex flex-wrap items-center gap-3 w-full md:w-auto justify-end">
                    
                    {/* Grup Secundari */}
                    <div className="flex items-center gap-2">
                        <Button variant="ghost" size="icon" className="text-destructive hover:text-destructive hover:bg-destructive/10" title="Eliminar Post">
                            <Trash2 className="w-5 h-5" />
                        </Button>
                        
                        {post.published && (
                            <Link href={`/blog/${post.slug}`} target="_blank">
                                <Button variant="outline" size="icon" title="Veure Web PÃºblica">
                                    <ExternalLink className="w-5 h-5" />
                                </Button>
                            </Link>
                        )}
                    </div>

                    <div className="h-8 w-px bg-border hidden md:block mx-1" />

                    {/* Grup Principal */}
                    <PostStatusToggle postId={post.id || ''} isPublished={post.published} />

                    <Link href={`/admin/blog/${post.slug}/edit`}>
                        <Button className="bg-foreground text-background hover:bg-foreground/90 shadow-sm font-semibold px-6">
                            <Save className="w-4 h-4 mr-2" /> Editar
                        </Button>
                    </Link>
                </div>
            </div>

            {/* CONTINGUT (GRID) */}
            <div className="grid lg:grid-cols-3 gap-8">

                {/* COLUMNA PRINCIPAL */}
                <div className="lg:col-span-2 space-y-8">
                    
                    {/* Imatge de Portada (Millorada) */}
                    <div className="relative aspect-video rounded-2xl overflow-hidden bg-muted border border-border shadow-sm group">
                        {post.coverImage ? (
                            <>
                                <Image
                                    src={post.coverImage}
                                    alt="Cover"
                                    fill
                                    sizes="(max-width: 768px) 100vw, 66vw"
                                    className="object-cover transition-transform duration-700 group-hover:scale-105"
                                />
                                <div className="absolute inset-0 bg-linear-to-t from-black/20 to-transparent pointer-events-none" />
                            </>
                        ) : (
                            <div className="flex flex-col items-center justify-center h-full text-muted-foreground space-y-2">
                                <div className="p-4 bg-background/50 rounded-full">
                                    <Image className="w-8 h-8 opacity-50" src={''} alt={''} />
                                </div>
                                <span className="text-sm font-medium">Sense imatge de portada</span>
                            </div>
                        )}
                    </div>

                    {/* Contingut MDX */}
                    <Card className="border-border shadow-sm overflow-hidden">
                        <CardHeader className="bg-muted/30 border-b border-border py-4">
                            <CardTitle className="text-sm font-semibold flex items-center gap-2">
                                Contingut de l'Article
                            </CardTitle>
                        </CardHeader>
                        <CardContent className="p-8 prose prose-slate dark:prose-invert max-w-none">
                            <MDXContent source={post.content || ''} />
                        </CardContent>
                    </Card>
                </div>

                {/* SIDEBAR DRET */}
                <div className="space-y-6">
                    <Card className="border-border shadow-sm sticky top-6">
                        <CardHeader className="pb-3 border-b border-border bg-muted/10">
                            <CardTitle className="text-xs font-bold text-muted-foreground uppercase tracking-wider">
                                Metadades SEO
                            </CardTitle>
                        </CardHeader>
                        <CardContent className="p-5 space-y-6">
                            
                            <div>
                                <label className="text-xs font-bold text-muted-foreground block mb-2">Slug URL</label>
                                <div className="bg-muted/50 p-2.5 rounded-lg border border-border flex items-center gap-2 group cursor-pointer hover:border-primary/30 transition-colors">
                                    <span className="text-muted-foreground text-xs select-none">/blog/</span>
                                    <code className="text-sm text-foreground font-mono truncate">{post.slug}</code>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-muted-foreground block mb-2">Meta DescripciÃ³</label>
                                <div className="bg-muted/30 p-3 rounded-lg border border-border text-sm text-muted-foreground leading-relaxed italic">
                                    {post.description || "Sense descripciÃ³ definida."}
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-muted-foreground block mb-2">Etiquetes</label>
                                <div className="flex flex-wrap gap-2">
                                    {post.tags.length > 0 ? (
                                        post.tags.map(tag => (
                                            <span key={tag} className="text-xs font-medium bg-background border border-border px-2.5 py-1 rounded-md text-foreground shadow-sm">
                                                #{tag}
                                            </span>
                                        ))
                                    ) : (
                                        <span className="text-xs text-muted-foreground italic">Sense tags</span>
                                    )}
                                </div>
                            </div>

                        </CardContent>
                    </Card>
                </div>

            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/admin/debug/page.tsx ===================

'use client';

import { useState, useEffect } from 'react';
import { createClient } from '@/lib/supabase/client';

// Definim una interfÃ­cie simple per al resultat que esperem de Supabase
interface SupabaseCountResult {
  count: number | null;
  error: {
    message: string;
    code?: string;
  } | null;
}

export default function DebugAnalyticsPage() {
  const [logs, setLogs] = useState<string[]>([]);
  const [envStatus] = useState({
    url: !!process.env.NEXT_PUBLIC_SUPABASE_URL,
    key: !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
  });

  // 1. Comprovem variables nomÃ©s carregar
  // Eliminat useEffect perquÃ¨ la inicialitzaciÃ³ es fa directament a useState

  const addLog = (msg: string) => setLogs(prev => [...prev, `${new Date().toLocaleTimeString()} > ${msg}`]);

  const testConnection = async () => {
    addLog('ğŸš€ INICIANT TEST...');
    
    // ValidaciÃ³ prÃ¨via
    if (!process.env.NEXT_PUBLIC_SUPABASE_URL) {
      addLog('âŒ ERROR FATAL: Falta NEXT_PUBLIC_SUPABASE_URL');
      return;
    }

    try {
      addLog('1. Creant client Supabase...');
      const supabase = createClient();
      
      addLog('2. Enviant peticiÃ³ (SELECT)...');
      
      // Fem un timeout manual per si es queda penjat
      const timeoutPromise = new Promise<never>((_, reject) => 
        setTimeout(() => reject(new Error("Timeout: La xarxa estÃ  bloquejada (AdBlock?)")), 5000)
      );

      const dbPromise = supabase
        .from('analytics_events')
        .select('count', { count: 'exact', head: true });

      // Cursa entre la DB i el Timeout. Forcem el tipus a 'unknown' primer i desprÃ©s al nostre tipus.
      const result = await Promise.race([dbPromise, timeoutPromise]) as unknown as SupabaseCountResult;

      if (result.error) {
        addLog(`âŒ ERROR DB: ${result.error.message}`);
        console.error(result.error);
      } else {
        addLog(`âœ… CONNEXIÃ“ CORRECTA! Files a la taula: ${result.count}`);
      }

    } catch (err: unknown) { 
      // CANVI CLAU: Usem 'unknown' en lloc de 'any'
      let errorMessage = 'Error desconegut';
      
      if (err instanceof Error) {
        errorMessage = err.message;
      } else if (typeof err === 'string') {
        errorMessage = err;
      }

      addLog(`ğŸ’¥ EXCEPCIÃ“: ${errorMessage}`);
      console.error(err);
    }
  };

  return (
    <div className="p-8 text-white bg-slate-950 min-h-screen">
      <h1 className="text-3xl font-bold mb-6 text-red-500">ğŸš‘ DIAGNÃ’STIC D'URGÃˆNCIA</h1>
      
      {/* Estat Variables */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        <div className={`p-4 rounded border ${envStatus.url ? 'border-green-500 bg-green-900/20' : 'border-red-500 bg-red-900/20'}`}>
          <div className="font-bold">SUPABASE_URL</div>
          <div className="text-2xl">{envStatus.url ? 'âœ… OK' : 'âŒ MISSING'}</div>
        </div>
        <div className={`p-4 rounded border ${envStatus.key ? 'border-green-500 bg-green-900/20' : 'border-red-500 bg-red-900/20'}`}>
          <div className="font-bold">ANON_KEY</div>
          <div className="text-2xl">{envStatus.key ? 'âœ… OK' : 'âŒ MISSING'}</div>
        </div>
      </div>

      <button 
        onClick={testConnection}
        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg mb-6 transition-colors"
      >
        FORÃ‡AR PROVA DE CONNEXIÃ“
      </button>

      <div className="bg-black rounded-lg p-4 font-mono text-sm border border-slate-800 h-64 overflow-y-auto">
        {logs.length === 0 ? <span className="text-slate-500">Els logs apareixeran aquÃ­...</span> : logs.map((log, i) => (
          <div key={i} className="mb-1 border-b border-slate-900 pb-1">{log}</div>
        ))}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/layout.tsx ===================

// src/app/[locale]/admin/layout.tsx
import { requireAdmin } from '@/lib/auth/admin-guard';
import { AdminBottomNav } from '@/components/admin/AminMobileMenu'; // Assegura't del nom correcte (AminMobileMenu o AdminMobileMenu)
import { AdminSidebar } from '@/components/admin/AdminSidebar'; // ğŸ‘ˆ El nou component
import { ShieldAlert } from 'lucide-react';

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // 1. Bloqueig de seguretat (Server Side)
  await requireAdmin();

  return (
    // Usem classes semÃ ntiques (bg-background) per preparar el Pas 2 (Themes)
    <div className="flex h-screen overflow-hidden bg-background text-foreground">

      {/* SIDEBAR (Desktop) - Ara modularitzat */}
      <AdminSidebar />

      {/* CONTINGUT PRINCIPAL */}
      <div className="flex-1 flex flex-col min-w-0 relative">
        
        {/* Header MÃ²bil (NomÃ©s visible en pantalles petites) */}
        <header className="md:hidden h-14 border-b border-border flex items-center justify-center bg-card/80 backdrop-blur-sm shrink-0 sticky top-0 z-30">
          <span className="flex items-center gap-2 font-bold text-foreground text-sm">
            <ShieldAlert className="w-4 h-4 text-red-500" /> ADMIN PANEL
          </span>
        </header>

        {/* Zona de Contingut amb Scroll */}
        <main className="flex-1 overflow-y-auto p-4 md:p-8 mb-16 md:mb-0 scroll-smooth">
          {children}
        </main>

        {/* NavegaciÃ³ MÃ²bil (Bottom Bar) */}
        <AdminBottomNav />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/page.tsx ===================

import { redirect } from 'next/navigation'; // Use native Next.js redirect

type Props = {
  params: Promise<{ locale: string }>;
};

export default async function AdminDashboard({ params }: Props) {
  const { locale } = await params;
  
  // Explicitly construct the URL with the current locale
  redirect(`/${locale}/admin/analytics`);
}

// =================== FILE: src/app/[locale]/admin/projects/new/page.tsx ===================

import { NewProjectForm } from '@/features/projects/ui/NewProjectForm';
import { requireAdmin } from '@/lib/auth/admin-guard'; // La teva protecciÃ³ d'admin

export default async function CreateProjectPage() {
  // ğŸ›¡ï¸ Seguretat: NomÃ©s tu pots entrar aquÃ­
  await requireAdmin();

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-black py-12 px-4">
      <div className="container mx-auto">
        <h1 className="text-3xl font-bold text-center mb-8">Nou Client</h1>
        <NewProjectForm />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/projects/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { createClient } from '@/lib/supabase/server';
import { Link } from '@/routing';
import { Plus, Github, ExternalLink, Clock, CheckCircle, AlertCircle, LayoutGrid } from 'lucide-react';
import { Button } from '@/components/ui/button';

export default async function AdminProjectsPage() {
  await requireAdmin();
  const supabase = await createClient();

  // Obtenim projectes i la seva organitzaciÃ³ vinculada
  const { data: projects } = await supabase
    .from('projects')
    .select('*, organizations(plan)')
    .order('created_at', { ascending: false });

  return (
    <div className="min-h-screen bg-background p-8">
      <div className="max-w-6xl mx-auto">
        
        {/* Header */}
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
          <div>
            <h1 className="text-3xl font-bold text-foreground tracking-tight">Projectes Clients</h1>
            <p className="text-muted-foreground">GestiÃ³ de les PWA generades ({projects?.length || 0})</p>
          </div>
          <Link href="/admin/projects/new">
            <Button className="bg-primary text-primary-foreground hover:bg-primary/90 shadow-lg border-0 gap-2">
              <Plus className="w-5 h-5" /> Generar Nova Web
            </Button>
          </Link>
        </div>

        {/* Grid de Projectes */}
        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {projects?.map((project) => (
            <div key={project.id} className="bg-card border border-border rounded-xl p-6 shadow-sm hover:shadow-md hover:border-primary/30 transition-all flex flex-col h-full">
              
              {/* CapÃ§alera Card */}
              <div className="flex justify-between items-start mb-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-lg bg-linear-to-br from-primary/20 to-purple-500/20 border border-primary/10 flex items-center justify-center text-primary font-bold text-lg">
                    {project.name.charAt(0)}
                  </div>
                  <div className="overflow-hidden">
                    <h3 className="font-bold text-foreground truncate" title={project.name}>{project.name}</h3>
                    <p className="text-xs text-muted-foreground font-mono truncate">{project.domain}</p>
                  </div>
                </div>
                <StatusBadge status={project.status ?? 'pending'} />
              </div>

              {/* Detalls */}
              <div className="space-y-3 mb-6 flex-1">
                <div className="flex items-center justify-between text-sm py-1 border-b border-border/50">
                  <span className="text-muted-foreground">Pla:</span>
                  <span className="font-medium capitalize text-foreground">
                    {project.organizations?.plan || 'BÃ sic'}
                  </span>
                </div>
                <div className="flex items-center justify-between text-sm py-1">
                  <span className="text-muted-foreground">Creat:</span>
                  <span className="text-foreground">
                    {project.created_at ? new Date(project.created_at).toLocaleDateString() : 'Desconegut'}
                  </span>
                </div>
              </div>

              {/* Accions */}
              <div className="flex gap-2 pt-4 border-t border-border mt-auto">
                <a 
                  href={project.repository_url ?? '#'} 
                  target="_blank" 
                  className="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg border border-border text-muted-foreground hover:bg-muted hover:text-foreground text-sm font-medium transition-colors"
                >
                  <Github className="w-4 h-4" /> Codi
                </a>
                
                <Link 
                  href={`/admin/projects/${project.id}`}
                  className="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg bg-primary text-primary-foreground hover:opacity-90 text-sm font-bold transition-colors"
                >
                  <ExternalLink className="w-4 h-4" /> Gestionar
                </Link>
              </div>

            </div>
          ))}

          {projects?.length === 0 && (
            <div className="col-span-full py-24 text-center bg-muted/20 rounded-xl border-2 border-dashed border-border flex flex-col items-center justify-center">
              <div className="p-4 bg-muted rounded-full mb-4">
                 <LayoutGrid className="w-8 h-8 text-muted-foreground opacity-50" />
              </div>
              <h3 className="text-lg font-medium text-foreground">Sense projectes</h3>
              <p className="text-muted-foreground mt-1 mb-6">Encara no has creat cap projecte per a clients.</p>
              <Link href="/admin/projects/new">
                <Button variant="outline">Crear el primer</Button>
              </Link>
            </div>
          )}
        </div>

      </div>
    </div>
  );
}

// Component Status Badge - Adaptable al tema
function StatusBadge({ status }: { status: string }) {
  // Mapeig de colors semÃ ntics (amb opacitat per suportar dark mode)
  const styles = {
    active: "bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20",
    pending: "bg-yellow-500/10 text-yellow-600 dark:text-yellow-400 border-yellow-500/20",
    maintenance: "bg-orange-500/10 text-orange-600 dark:text-orange-400 border-orange-500/20",
    archived: "bg-slate-500/10 text-slate-600 dark:text-slate-400 border-slate-500/20"
  };
  
  const icons = {
    active: CheckCircle,
    pending: Clock,
    maintenance: AlertCircle,
    archived: AlertCircle
  };

  // Type-safe key access
  const normalizedStatus = status.toLowerCase() as keyof typeof styles;
  const Icon = icons[normalizedStatus] || Clock;
  const style = styles[normalizedStatus] || styles.pending;

  return (
    <span className={`flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold border uppercase tracking-wider ${style}`}>
      <Icon className="w-3 h-3" />
      {status}
    </span>
  );
}

// =================== FILE: src/app/[locale]/admin/projects/[id]/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { createClient } from '@/lib/supabase/server';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { notFound } from 'next/navigation';
import { Link } from '@/routing';
import { Github, Globe, Server, LayoutDashboard, FlaskConical, ArrowLeft } from 'lucide-react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ProjectCampaignsList } from '@/features/projects/ui/ProjectCampaignsList';
import { ProjectTeamManager } from '@/features/projects/ui/ProjectTeamManeger';
// ğŸ‘‡ 1. IMPORTEM EL TIPUS DEL REPOSITORI
import { SupabaseProjectRepository, ProjectMember } from '@/repositories/supabase/SupabaseProjectRepository';

// ğŸ‘‡ 2. DEFINIM EL TIPUS PER ALS CANDIDATS (CÃ²pia de l'estructura de 'profiles')
type Candidate = {
  id: string;
  email: string;
  full_name: string | null;
  avatar_url: string | null;
};

type Props = {
  params: Promise<{ id: string }>;
};

export default async function ProjectDetailPage({ params }: Props) {
  await requireAdmin();
  const { id } = await params;
  const supabase = await createClient();
  
  // Instanciem repositoris
  const testRepo = new SupabaseTestRepository();
  const projectRepo = new SupabaseProjectRepository();

  // 1. Dades del Projecte + Campanyes en paralÂ·lel
  const [projectRes, campaigns] = await Promise.all([
    supabase.from('projects').select('*, organizations(*)').eq('id', id).single(),
    testRepo.getCampaignsByProject(id)
  ]);

  const project = projectRes.data;
  if (!project) notFound();

  // 2. ğŸ”¥ CÃ€RREGA DE DADES D'EQUIP (CORREGIT SENSE 'any')
  // Inicialitzem amb arrays buits perÃ² TIPATS
  let members: ProjectMember[] = [];
  let candidates: Candidate[] = [];
  
  if (project.organization_id) {
      // Fem la crida
      const [fetchedMembers, fetchedCandidates] = await Promise.all([
          projectRepo.getMembers(id),
          projectRepo.getAvailableCandidates(id, project.organization_id)
      ]);

      // Assignem els resultats
      members = fetchedMembers;
      // Fem un cast segur perquÃ¨ sabem que la DB retorna aquesta estructura
      candidates = fetchedCandidates as Candidate[];
  }

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 p-6 md:p-10">
      <div className="max-w-6xl mx-auto">
        
        {/* Header de NavegaciÃ³ */}
        <Link href="/admin/projects" className="text-sm text-slate-500 hover:text-white mb-6 flex items-center gap-2 transition-colors">
            <ArrowLeft className="w-4 h-4" /> Tornar al llistat
        </Link>

        {/* Header Principal */}
        <div className="flex flex-col md:flex-row justify-between items-start mb-8 gap-4">
            <div>
                <h1 className="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
                    {project.name}
                    <span className="text-sm px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-mono border border-blue-200 dark:border-blue-800">
                        {project.status}
                    </span>
                </h1>
                <p className="text-slate-500 mt-2 font-mono text-sm">{project.domain || 'Sense domini assignat'}</p>
            </div>
            
            <div className="flex gap-2">
               <a 
                 href={project.repository_url || '#'} 
                 target="_blank" 
                 className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
               >
                 <Github className="w-4 h-4" /> Repo
               </a>
               {project.hosting_url && (
                  <a 
                   href={`https://${project.hosting_url}`} 
                   target="_blank" 
                   className="flex items-center gap-2 px-4 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-lg text-sm font-bold hover:opacity-90 transition-colors"
                 >
                   <Globe className="w-4 h-4" /> Web
                 </a>
               )}
            </div>
        </div>

        {/* ESTRUCTURA DE PESTANYES */}
        <Tabs defaultValue="overview" className="w-full">
            <TabsList className="bg-slate-200 dark:bg-slate-900 border border-slate-300 dark:border-slate-800 mb-8 w-full justify-start h-auto p-1">
                <TabsTrigger value="overview" className="px-6 py-2.5 data-[state=active]:bg-white dark:data-[state=active]:bg-slate-800">
                    <LayoutDashboard className="w-4 h-4 mr-2" /> Equip & ConfiguraciÃ³
                </TabsTrigger>
                <TabsTrigger value="qa" className="px-6 py-2.5 data-[state=active]:bg-white dark:data-[state=active]:bg-slate-800">
                    <FlaskConical className="w-4 h-4 mr-2" /> QA & Tests
                    <span className="ml-2 bg-slate-200 dark:bg-slate-700 px-1.5 py-0.5 rounded-full text-xs">{campaigns.length}</span>
                </TabsTrigger>
            </TabsList>

            {/* TAB 1: VISIÃ“ GENERAL */}
            <TabsContent value="overview">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    {/* âœ… Component de GestiÃ³ d'Equip (TIPAT CORRECTAMENT) */}
                    <div className="h-full min-h-[400px]">
                        <ProjectTeamManager 
                            projectId={id} 
                            members={members} 
                            candidates={candidates} 
                        />
                    </div>

                    {/* Targeta TÃ¨cnica */}
                    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 shadow-sm h-fit">
                        <h3 className="text-lg font-bold mb-6 flex items-center gap-2 text-slate-900 dark:text-white">
                            <Server className="w-5 h-5 text-blue-500" /> Infraestructura
                        </h3>
                        <div className="space-y-4">
                            <div className="flex justify-between py-3 border-b border-slate-100 dark:border-slate-800">
                                <span className="text-slate-500">Base de Dades ID</span>
                                <span className="font-mono text-sm">{project.organization_id}</span>
                            </div>
                            <div className="bg-slate-50 dark:bg-slate-800 p-4 rounded-lg mt-4">
                                <h4 className="font-bold text-xs uppercase text-slate-500 mb-2">ConfiguraciÃ³ Visual</h4>
                                <pre className="text-xs text-slate-700 dark:text-slate-300 overflow-x-auto">
                                    {JSON.stringify(project.branding_config, null, 2)}
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
            </TabsContent>

            {/* TAB 2: QA & TESTS */}
            <TabsContent value="qa">
                <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 shadow-sm min-h-[400px]">
                    <ProjectCampaignsList campaigns={campaigns} projectId={id} />
                </div>
            </TabsContent>

        </Tabs>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/tests/new/page.tsx ===================

// src/app/[locale]/admin/tests/new/page.tsx
import { requireAdmin } from '@/lib/auth/admin-guard';
import { createClient } from '@/lib/supabase/server';
import { Link } from '@/routing';
import { ArrowLeft } from 'lucide-react';

// ğŸ‘‡ IMPORT CRÃTIC: Ha de ser entre claus { }
import { CreateCampaignForm } from '@/features/tests/ui/CreateCampaignForm';

export default async function NewCampaignPage() {
  await requireAdmin();
  const supabase = await createClient();

  const { data: projects } = await supabase
    .from('projects')
    .select('id, name')
    .order('created_at', { ascending: false });

  return (
    <div className="max-w-2xl mx-auto p-8">
        <Link href="/admin/tests" className="text-slate-500 hover:text-white flex items-center gap-2 mb-6 transition-colors">
            <ArrowLeft className="w-4 h-4" /> CancelÂ·lar
        </Link>

        <h1 className="text-3xl font-bold text-white mb-8">Nova Campanya de Test</h1>

        <CreateCampaignForm projects={projects || []} />
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/tests/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { Plus, FlaskConical, ExternalLink } from 'lucide-react';

// Tipus local per a la vista (amb les dades ja processades pel repo)
type AdminCampaignView = {
  id: string;
  title: string;
  description: string | null;
  status: string;
  created_at: string;
  projects: { name: string } | null;
  stats: {
    total_tasks: number;
    total_results: number;
  };
};

export default async function AdminTestsPage() {
  await requireAdmin();
  const repo = new SupabaseTestRepository();
  
  // Fem servir el tipus nou
  const campaigns = (await repo.getAllCampaignsForAdmin()) as unknown as AdminCampaignView[];

  return (
    <div className="p-8">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-3xl font-bold text-white flex items-center gap-3">
            <FlaskConical className="w-8 h-8 text-purple-500" /> GestiÃ³ de QA
          </h1>
          <p className="text-slate-400 mt-1">Administra les campanyes de proves beta.</p>
        </div>
        <Link href="/admin/tests/new">
          <Button className="bg-purple-600 hover:bg-purple-700 text-white">
            <Plus className="w-4 h-4 mr-2" /> Nova Campanya
          </Button>
        </Link>
      </div>

      <div className="grid gap-4">
        {campaigns.map((camp) => (
          <div key={camp.id} className="bg-slate-900 border border-slate-800 rounded-xl p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:border-purple-500/30 transition-colors">
            
            {/* Info Principal */}
            <div>
              <div className="flex items-center gap-3 mb-1">
                <h3 className="text-lg font-bold text-white">{camp.title}</h3>
                <span className={`text-[10px] px-2 py-0.5 rounded font-bold uppercase ${camp.status === 'active' ? 'bg-green-900 text-green-300' : 'bg-slate-700 text-slate-300'}`}>
                    {camp.status}
                </span>
              </div>
              <p className="text-sm text-slate-400 mb-2">{camp.description || "Sense descripciÃ³"}</p>
              <div className="flex items-center gap-4 text-xs text-slate-500 font-mono">
                <span>ğŸ“‚ {camp.projects?.name || 'Projecte esborrat'}</span>
                <span>ğŸ“… {new Date(camp.created_at).toLocaleDateString()}</span>
              </div>
            </div>

            {/* EstadÃ­stiques (ARA MOLT MÃ‰S NET) */}
            <div className="flex items-center gap-6 md:pr-8 md:border-r border-slate-800">
                <div className="text-center">
                    <div className="text-2xl font-bold text-white">{camp.stats.total_tasks}</div>
                    <div className="text-[10px] text-slate-500 uppercase tracking-wider">Tasques</div>
                </div>
                <div className="text-center">
                    <div className="text-2xl font-bold text-blue-400">{camp.stats.total_results}</div>
                    <div className="text-[10px] text-slate-500 uppercase tracking-wider">Reports</div>
                </div>
            </div>

            {/* Accions */}
            <div className="flex gap-2 w-full md:w-auto">
                <Link href={`/admin/tests/${camp.id}`} className="w-full md:w-auto">
                    <Button variant="outline" className="w-full border-slate-700 text-slate-300 hover:text-white hover:bg-slate-800">
                        Gestionar <ExternalLink className="w-4 h-4 ml-2" />
                    </Button>
                </Link>
            </div>

          </div>
        ))}

        {campaigns.length === 0 && (
            <div className="text-center py-20 text-slate-600 bg-slate-900/50 rounded-xl border border-dashed border-slate-800">
                No hi ha campanyes actives. Crea la primera!
            </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/tests/[id]/page.tsx ===================

import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { requireAdmin } from '@/lib/auth/admin-guard';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { TesterManager } from '@/features/tests/ui/TesterManager';
import { VisualFlowBuilder } from '@/features/tests/ui/VisualFlowBuilder';
import { CampaignDetailsForm } from '@/features/tests/ui/CampaignDetailsForm';
import { createClient } from '@/lib/supabase/server';
// ğŸ‘‡ 1. Importem el nou component
import { BackButton } from '@/components/ui/back-button';
import { DeleteCampaignButton } from '@/features/tests/ui/DeleteCampaignButton';
import { CampaignAnalytics } from '@/features/tests/ui/CampaignAnalytics';


export default async function AdminTestDetailPage({ params }: { params: Promise<{ id: string }> }) {
  await requireAdmin();
  const { id } = await params;
  const repo = new SupabaseTestRepository();
  const supabase = await createClient();

  // 1. Context de la Campanya
  const ctx = await repo.getCampaignWithContext(id, 'admin');
  if (!ctx.campaign) return <div>Campanya no trobada</div>;

  // 2. Busquem el Projecte
  const { data: project } = await supabase
    .from('projects')
    .select('organization_id')
    .eq('id', ctx.campaign.projectId)
    .single();

  if (!project || !project.organization_id) return <div>Error d'integritat: Projecte sense organitzaciÃ³</div>;

  // 3. Carreguem les llistes
  const [assigned, available] = await Promise.all([
    repo.getAssignedTesters(id),
    repo.getProjectMembersForTest(id, ctx.campaign.projectId, project.organization_id)
  ]);
  const analyticsData = await repo.getCampaignResults(id);
  return (
    <div className="p-6 max-w-6xl mx-auto space-y-6">

      {/* Header Simple amb BotÃ³ Enrere IntelÂ·ligent */}
      <div className="flex flex-col gap-4">
        {/* ğŸ‘‡ 2. ColÂ·loquem el botÃ³ a dalt de tot. Passem el projectId per si cal. */}
        <div>
          <BackButton projectId={ctx.campaign.projectId} />
          {/* ğŸ‘‡ BOTÃ“ D'ELIMINAR A LA DRETA */}
          <DeleteCampaignButton
            campaignId={ctx.campaign.id}
            projectId={ctx.campaign.projectId}
          />
        </div>

        <div className="flex justify-between items-center">
          <div>
            <h1 className="text-3xl font-bold text-white flex items-center gap-3">
              {ctx.campaign.title}
            </h1>
            <p className="text-slate-400 mt-1">GestiÃ³ integral de la prova</p>
          </div>
          <div className="bg-purple-900/50 text-purple-300 px-3 py-1 rounded text-xs font-mono border border-purple-500/30">
            ID: {ctx.campaign.id.slice(0, 8)}
          </div>
        </div>
      </div>

      <Tabs defaultValue="results" className="w-full"> {/* Pots canviar el default a 'results' si vols veure aixÃ² primer */}
        <TabsList className="grid w-full grid-cols-4 bg-slate-900 border border-slate-800">
          <TabsTrigger value="results">ğŸ“Š Resultats</TabsTrigger> {/* Nova pestanya */}
          <TabsTrigger value="details">ğŸ“ Detalls</TabsTrigger>
          <TabsTrigger value="tasks">âœ… Checklist</TabsTrigger>
          <TabsTrigger value="team">ğŸ‘¥ Equip</TabsTrigger>
        </TabsList>

        {/* 0. RESULTATS (NOU) */}
        <TabsContent value="results" className="mt-6">
          <CampaignAnalytics data={analyticsData} />
        </TabsContent>

        <TabsContent value="details" className="mt-6">
          <CampaignDetailsForm campaign={ctx.campaign} />
        </TabsContent>

        <TabsContent value="tasks" className="mt-6">
          <VisualFlowBuilder campaignId={id} tasks={ctx.tasks} />
        </TabsContent>

        <TabsContent value="team" className="mt-6">
          <Card className="bg-slate-900 border-slate-800">
            <CardHeader><CardTitle className="text-white">Assignar Usuaris</CardTitle></CardHeader>
            <CardContent>
              <TesterManager
                campaignId={id}
                assignedTesters={assigned}
                availableTesters={available}
              />
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/users/page.tsx ===================

import { getAdminUsersList } from '@/app/actions/get-users';
import { getTranslations } from 'next-intl/server';
import { Mail, Download, User, Calendar, ShieldCheck, UserCheck, UserPlus } from 'lucide-react';
import { Button } from '@/components/ui/button';

export default async function AdminUsersPage() {
  const users = await getAdminUsersList();
  const t = await getTranslations('AdminDashboard');

  return (
    <div className="p-6 max-w-7xl mx-auto">
      {/* CAPÃ‡ALERA */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-bold text-foreground tracking-tight">Usuaris</h1>
          <p className="text-muted-foreground text-sm">
            Base de dades de clients i leads ({users.length} totals)
          </p>
        </div>
        <Button variant="outline" className="border-border bg-card hover:bg-muted text-foreground gap-2">
          <Download className="w-4 h-4" />
          Exportar CSV
        </Button>
      </div>

      {/* TAULA CARD */}
      <div className="border border-border rounded-xl overflow-hidden bg-card shadow-sm">
        <div className="overflow-x-auto">
          <table className="w-full text-sm text-left">
            {/* HEAD */}
            <thead className="bg-muted/50 text-muted-foreground border-b border-border text-xs uppercase tracking-wider font-semibold">
              <tr>
                <th className="px-4 py-3 pl-6">Usuari</th>
                <th className="px-4 py-3">Rol & Estat</th>
                <th className="px-4 py-3">Registre</th>
                <th className="px-4 py-3 text-right pr-6">Accions</th>
              </tr>
            </thead>

            {/* BODY */}
            <tbody className="divide-y divide-border">
              {users.map((user) => (
                <tr key={user.id} className="hover:bg-muted/30 transition-colors group">
                  
                  {/* COLUMNA 1: IDENTITAT (Compacta) */}
                  <td className="px-4 py-3 pl-6">
                    <div className="flex items-center gap-3">
                      {/* Avatar Generat */}
                      <div className="w-9 h-9 rounded-full bg-primary/10 border border-primary/20 flex items-center justify-center text-primary font-bold text-sm shrink-0">
                        {user.full_name ? user.full_name.charAt(0).toUpperCase() : <User className="w-4 h-4" />}
                      </div>
                      <div className="flex flex-col">
                        <span className="font-semibold text-foreground leading-none mb-1">
                          {user.full_name || 'Sense nom'}
                        </span>
                        <span className="text-xs text-muted-foreground font-mono">
                          {user.email}
                        </span>
                      </div>
                    </div>
                  </td>

                  {/* COLUMNA 2: ROL (Badge modern) */}
                  <td className="px-4 py-3">
                    <RoleBadge role={user.role} />
                  </td>

                  {/* COLUMNA 3: DATA (Compacta) */}
                  <td className="px-4 py-3 text-muted-foreground">
                    {user.created_at ? (
                      <div className="flex items-center gap-2 text-xs">
                        <Calendar className="w-3.5 h-3.5 opacity-70" />
                        <div className="flex flex-col">
                          <span className="font-medium text-foreground">
                            {new Date(user.created_at).toLocaleDateString('ca-ES', { day: '2-digit', month: 'short', year: '2-digit' })}
                          </span>
                          <span className="text-[10px] opacity-70">
                            {new Date(user.created_at).toLocaleTimeString('ca-ES', { hour: '2-digit', minute: '2-digit' })}
                          </span>
                        </div>
                      </div>
                    ) : (
                      <span className="text-muted-foreground">-</span>
                    )}
                  </td>

                  {/* COLUMNA 4: ACCIONS */}
                  <td className="px-4 py-3 text-right pr-6">
                    <a
                      href={`mailto:${user.email}`}
                      className="inline-flex items-center justify-center w-8 h-8 rounded-lg text-muted-foreground hover:text-primary hover:bg-primary/10 transition-all"
                      title="Enviar correu"
                    >
                      <Mail className="w-4 h-4" />
                    </a>
                  </td>
                </tr>
              ))}

              {users.length === 0 && (
                <tr>
                  <td colSpan={4} className="px-6 py-12 text-center text-muted-foreground">
                    <div className="flex flex-col items-center gap-2">
                        <User className="w-8 h-8 opacity-20" />
                        <span>Encara no hi ha usuaris registrats.</span>
                    </div>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// Helper component per als Badges de Rol
function RoleBadge({ role }: { role: string }) {
  const styles = {
    admin: "bg-purple-500/10 text-purple-600 dark:text-purple-400 border-purple-500/20",
    client: "bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20",
    lead: "bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-500/20",
    unknown: "bg-slate-500/10 text-slate-600 dark:text-slate-400 border-slate-500/20"
  };

  const icons = {
    admin: ShieldCheck,
    client: UserCheck,
    lead: UserPlus,
    unknown: User
  };

  const normalizedRole = (role || 'unknown').toLowerCase() as keyof typeof styles;
  const styleClass = styles[normalizedRole] || styles.unknown;
  const Icon = icons[normalizedRole] || icons.unknown;

  return (
    <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-bold border ${styleClass}`}>
      <Icon className="w-3 h-3" />
      {normalizedRole.toUpperCase()}
    </span>
  );
}

// =================== FILE: src/app/[locale]/auth/callback/route.ts ===================

import { NextResponse } from 'next/server'
// El client de servidor que hem creat abans
import { createClient } from '@/lib/supabase/server'

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  // si tenim un parÃ metre "next", el fem servir per redirigir
  const next = searchParams.get('next') ?? '/dashboard'

  if (code) {
    const supabase = await createClient()
    const { error } = await supabase.auth.exchangeCodeForSession(code)
    
    if (!error) {
      // Si tot ha anat bÃ©, redirigim a l'usuari cap al dashboard (o on volguÃ©s anar)
      // Afegim el locale per defecte si cal, o detectem.
      // Per ara hardcodegem 'ca', perÃ² l'ideal seria guardar-ho en cookie abans.
      return NextResponse.redirect(`${origin}/ca${next}`)
    }
  }

  // Si hi ha error, tornem al login amb un missatge
  return NextResponse.redirect(`${origin}/ca/auth/login?error=auth-code-error`)
}

// =================== FILE: src/app/[locale]/auth/forgot-password/page.tsx ===================

import { getTranslations } from 'next-intl/server';
import { Link } from '@/routing';
import { ForgotPasswordForm } from '@/features/auth/ui/ForgotPasswordForm';

export default async function ForgotPasswordPage() {
  const t = await getTranslations('AuthPages.forgot_password');

  return (
    <div className="flex min-h-screen items-center justify-center bg-muted/20 px-4 py-12">
      <div className="w-full max-w-md space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-bold tracking-tight">{t('title')}</h1>
          <p className="mt-2 text-sm text-muted-foreground">
            {t('subtitle')}
          </p>
        </div>

        <ForgotPasswordForm />

        <div className="text-center text-sm">
          <Link href="/auth/login" className="font-medium text-primary hover:underline">
            â† {t('back_login')}
          </Link>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/auth/login/page.tsx ===================

import { LoginForm } from '@/features/auth/ui/LoginForm';
import { Sparkles } from 'lucide-react';
import Link from 'next/link';
// ğŸ‘‡ CANVI IMPORTANT: Importem des de 'next-intl/server'
import { getTranslations } from 'next-intl/server'; 

type Props = {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
  params: Promise<{ locale: string }>; // Afegim params per consistÃ¨ncia
};

export default async function LoginPage({ searchParams }: Props) {
  // ğŸ‘‡ CORRECCIÃ“: Usem await getTranslations() en lloc de useTranslations()
  const t = await getTranslations('AuthPages.login');
  
  // Resolem la promesa dels parÃ metres
  const params = await searchParams;
  
  // Extraiem l'email de forma segura
  const emailParam = typeof params.email === 'string' ? params.email : undefined;

  return (
    <div className="min-h-screen w-full grid lg:grid-cols-2 bg-background overflow-hidden">
      
      {/* COLUMNA ESQUERRA (Visual / Marketing) */}
      <div className="hidden lg:flex relative flex-col justify-between p-12 bg-[#0f111a] border-r border-white/5">
         {/* Fons animat */}
         <div className="absolute inset-0 bg-[radial-gradient(circle_at_top_left,var(--tw-gradient-stops))] from-primary/20 via-background to-background opacity-50"></div>
         <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-10"></div> 
         
         {/* Logo */}
         <div className="relative z-10">
           <Link href="/" className="flex items-center gap-2 text-2xl font-bold text-white">
               DigitAI <span className="gradient-text">Studios</span>
            </Link>
         </div>

         {/* Text inspirador */}
         <div className="relative z-10 max-w-lg">
            <div className="mb-6 inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold">
               <Sparkles className="w-3 h-3" />
               DIGITAL INTELLIGENCE
            </div>
            <h2 className="text-4xl font-bold text-white mb-4 leading-tight">
               {t('marketing_title')}
            </h2>
            <p className="text-slate-400 text-lg">
               {t('marketing_subtitle')}
            </p>
         </div>

         {/* Footer petit */}
         <div className="relative z-10 text-sm text-slate-600">
            {t('footer')}
         </div>
      </div>

      {/* COLUMNA DRETA (Formulari) */}
      <div className="flex items-center justify-center p-8 relative">
         <Link href="/" className="absolute top-8 right-8 text-sm text-muted-foreground hover:text-foreground lg:hidden">
            {t('back_home')}
         </Link>

         {/* Passem l'email extret al component Client */}
         <LoginForm prefilledEmail={emailParam} />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/auth/register/page.tsx ===================

import { RegisterForm } from '@/features/auth/ui/RegisterForm';
import { Link } from '@/routing'; 
import { Sparkles, ArrowLeft } from 'lucide-react';
import { getTranslations } from 'next-intl/server';

type Props = {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
};

export default async function RegisterPage({ searchParams }: Props) {
  // 1. Obtenim les dades
  const params = await searchParams;
  const emailParam = typeof params.email === 'string' ? params.email : '';

  // 2. Traduccions
  const t = await getTranslations('AuthPages.register');

  return (
    <div className="min-h-screen w-full grid lg:grid-cols-2 bg-background overflow-hidden">
      
      {/* COLUMNA ESQUERRA */}
      <div className="hidden lg:flex relative flex-col justify-between p-12 bg-[#0f111a] border-r border-white/5">
         <div className="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,var(--tw-gradient-stops))] from-primary/20 via-background to-background opacity-50"></div>
         <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-10"></div>
         
         {/* Logo */}
         <div className="relative z-10">
            <Link href="/" className="flex items-center gap-2 text-2xl font-bold text-white no-underline">
               DigitAI <span className="gradient-text">Studios</span>
            </Link>
         </div>

         {/* Missatge de valor */}
         <div className="relative z-10 max-w-lg">
            <div className="mb-6 inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold">
               <Sparkles className="w-3 h-3" />
               {t('marketing_badge')}
            </div>
            <h2 className="text-4xl font-bold text-white mb-4 leading-tight">
               {t('marketing_title')}
            </h2>
            <div className="space-y-4 mt-8">
                <div className="flex items-center gap-4 text-slate-400">
                    <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white font-bold">1</div>
                    <p>{t('feature_1')}</p>
                </div>
                <div className="flex items-center gap-4 text-slate-400">
                    <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white font-bold">2</div>
                    <p>{t('feature_2')}</p>
                </div>
                <div className="flex items-center gap-4 text-slate-400">
                    <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white font-bold">3</div>
                    <p>{t('feature_3')}</p>
                </div>
            </div>
         </div>

         {/* Footer petit */}
         <div className="relative z-10 text-sm text-slate-600">
            Â© {new Date().getFullYear()} DigitAI Studios.
         </div>
      </div>

      {/* COLUMNA DRETA */}
      <div className="flex items-center justify-center p-8 relative">
         <Link href="/" className="absolute top-8 left-8 text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 lg:hidden">
            <ArrowLeft className="w-4 h-4" /> {t('back_home')}
         </Link>

         <RegisterForm prefilledEmail={emailParam} />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/auth/reset-password/page.tsx ===================

import { redirect } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';
import { getTranslations, getLocale } from 'next-intl/server';
import { ResetPasswordForm } from '@/features/auth/ui/ResetPasswordForm';

export default async function ResetPasswordPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  const t = await getTranslations('AuthPages.reset_password');
  const locale = await getLocale();

  // Si l'usuari no tÃ© sessiÃ³, vol dir que l'enllaÃ§ ha caducat o Ã©s invÃ lid.
  if (!user) {
    redirect(`/${locale}/auth/forgot-password`); 
  }

  return (
    <div className="flex min-h-screen items-center justify-center bg-muted/20 px-4 py-12">
      <div className="w-full max-w-md space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-bold tracking-tight">{t('title')}</h1>
          <p className="mt-2 text-sm text-muted-foreground">
            {t('subtitle')}
          </p>
        </div>

        <ResetPasswordForm />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/audits/page.tsx ===================

import { getTranslations, getLocale } from 'next-intl/server';
import { Link } from '@/routing';
import { redirect } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Plus, Globe, Calendar, ArrowRight, Activity } from 'lucide-react';
import { createClient } from '@/lib/supabase/server'; 
import { auditRepository } from '@/services/container';

export default async function AuditsListPage() {
  const t = await getTranslations('AuditList'); // Namespace AuditList
  const locale = await getLocale();
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();

  if (!user || !user.email) {
    redirect(`/${locale}/auth/login`); 
  }

  const audits = await auditRepository.getAuditsByUserEmail(user.email);

  // Helper per traduir estats dins del component server
  const getStatusLabel = (status: string) => {
      if (status === 'completed') return t('status.completed');
      if (status === 'failed') return t('status.failed');
      return t('status.processing');
  };

  return (
    <div className="space-y-8">
      
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-6 border-b border-border">
        <div>
          <h1 className="text-3xl font-bold text-foreground">{t('title')}</h1>
          <p className="text-muted-foreground mt-1">
            {t('subtitle')}
          </p>
        </div>
        <Link href="/dashboard/new-audit">
          <Button className="gradient-bg text-white border-0 shadow-lg shadow-primary/20 hover:opacity-90 transition-opacity">
            <Plus className="w-4 h-4 mr-2" /> {t('new_audit_button')}
          </Button>
        </Link>
      </div>

      {/* Grid */}
      <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {audits.map((audit) => (
          <Link key={audit.id} href={`/dashboard/audits/${audit.id}`} className="block group h-full">
            <div className="bg-card border border-border rounded-xl p-6 h-full hover:border-primary/50 transition-all duration-300 shadow-sm hover:shadow-md hover:-translate-y-1 relative overflow-hidden flex flex-col">
              
              {/* CapÃ§alera Targeta */}
              <div className="flex justify-between items-start mb-6">
                 <div className="p-3 bg-primary/10 rounded-lg text-primary border border-primary/20 group-hover:bg-primary/20 transition-colors">
                    <Globe className="w-6 h-6" />
                 </div>
                 <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide border ${
                   audit.status === 'completed' 
                     ? 'bg-green-500/10 text-green-500 border-green-500/20' 
                     : audit.status === 'failed'
                     ? 'bg-red-500/10 text-red-500 border-red-500/20'
                     : 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20'
                 }`}>
                    {getStatusLabel(audit.status)}
                 </span>
              </div>

              {/* Cos Targeta */}
              <div className="mb-6 grow">
                 <h3 className="text-lg font-bold text-foreground truncate mb-2" title={audit.url}>
                    {audit.url.replace(/^https?:\/\//, '').replace(/\/$/, '')}
                 </h3>
                 <div className="flex items-center gap-2 text-xs text-muted-foreground">
                    <Calendar className="w-3 h-3" />
                    {new Intl.DateTimeFormat(locale, { dateStyle: 'medium' }).format(audit.createdAt)}
                 </div>
              </div>

              {/* Peu Targeta */}
              {audit.status === 'completed' && (
                 <div className="grid grid-cols-2 gap-3 mt-auto pt-4 border-t border-border">
                    <div className="flex flex-col">
                       <span className="text-[10px] text-muted-foreground uppercase font-bold mb-1">SEO</span>
                       <div className="flex items-center gap-1.5">
                          <Activity className="w-3 h-3 text-muted-foreground" />
                          <span className={`text-lg font-bold ${getScoreColor(audit.seoScore || 0)}`}>
                             {audit.seoScore || '-'}
                          </span>
                       </div>
                    </div>
                    <div className="flex flex-col border-l border-border pl-3">
                       <span className="text-[10px] text-muted-foreground uppercase font-bold mb-1">{t('performance')}</span>
                       <div className="flex items-center gap-1.5">
                          <Activity className="w-3 h-3 text-muted-foreground" />
                          <span className={`text-lg font-bold ${getScoreColor(audit.performanceScore || 0)}`}>
                             {audit.performanceScore || '-'}
                          </span>
                       </div>
                    </div>
                 </div>
              )}

              {/* Fletxa Hover */}
              <div className="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
                 <ArrowRight className="w-5 h-5 text-primary" />
              </div>
            </div>
          </Link>
        ))}

        {/* Estat Buit */}
        {audits.length === 0 && (
          <div className="col-span-full py-16 flex flex-col items-center justify-center text-center border-2 border-dashed border-border rounded-2xl bg-card/30">
            <div className="w-16 h-16 bg-muted/50 rounded-full flex items-center justify-center mb-4">
               <Globe className="w-8 h-8 text-muted-foreground" />
            </div>
            <h3 className="text-lg font-medium text-foreground mb-2">{t('empty_title')}</h3>
            <p className="text-muted-foreground mb-6 max-w-sm">
              {t('empty_description')}
            </p>
            <Link href="/dashboard/new-audit">
               <Button variant="outline" className="border-border hover:bg-muted text-foreground">
                  {t('create_first_audit')}
               </Button>
            </Link>
          </div>
        )}
      </div>
    </div>
  );
}

function getScoreColor(score: number) {
   if (score >= 90) return 'text-green-500';
   if (score >= 50) return 'text-yellow-500';
   return 'text-red-500';
}

// =================== FILE: src/app/[locale]/dashboard/audits/[id]/page.tsx ===================

import { notFound } from 'next/navigation';
import { auditRepository } from '@/services/container';
import { AuditHeader } from '@/features/audit/ui/components/AuditHeader';
import { ScoreGrid } from '@/features/audit/ui/components/ScoreGrid';
import { CoreVitalsGrid, AuditMetric } from '@/features/audit/ui/components/CoreVitalsGrid';
import { IssuesList } from '@/features/audit/ui/components/IssuesList';
import { MobilePreview } from '@/features/audit/ui/components/MobilePreviw';
import { AuditIssue } from '@/adapters/IWebScanner';
import { getTranslations } from 'next-intl/server'; // Importem el hook de servidor

type LighthouseAudit = {
  id: string;
  title: string;
  description: string;
  score: number | null;
  displayValue?: string;
  numericValue?: number;
  details?: unknown; 
};

interface GoogleRawData {
  lighthouseResult?: { audits: Record<string, LighthouseAudit> };
  audits?: Record<string, LighthouseAudit>;
  issues?: AuditIssue[];
  screenshot?: string;
}

type Props = {
  params: Promise<{ id: string; locale: string }>;
};

export default async function AuditDetailsPage({ params }: Props) {
  const { id } = await params;
  const t = await getTranslations('AuditDetails'); // Namespace AuditDetails
  const audit = await auditRepository.getAuditById(id);

  if (!audit) notFound();

  if (audit.status === 'processing') {
    return <div className="p-12 text-center text-foreground">{t('processing_message')}</div>;
  }

  // 1. Recuperar dades
  const rawData = audit.reportData as unknown as GoogleRawData;
  const googleAudits = rawData?.lighthouseResult?.audits || rawData?.audits || {};

  // 2. Helper
  const extract = (key: string): AuditMetric => {
    const a = googleAudits[key];
    if (!a) return { score: null, value: 'N/A', description: '' };
    return {
      score: a.score,
      value: a.displayValue || (a.numericValue ? a.numericValue.toFixed(2) : 'N/A'),
      description: a.title
    };
  };

  // 3. MÃ¨triques
  const metrics = {
    fcp: extract('first-contentful-paint'),
    lcp: extract('largest-contentful-paint'),
    cls: extract('cumulative-layout-shift'),
    tbt: extract('total-blocking-time'),
    si: extract('speed-index')
  };

  // 4. Issues
  let displayIssues: AuditIssue[] = rawData?.issues || [];

  if (displayIssues.length === 0 && Object.keys(googleAudits).length > 0) {
    displayIssues = Object.entries(googleAudits)
      .filter(([, a]) => {
        const score = a.score ?? 1;
        return score < 0.9 && a.score !== null;
      })
      .map(([key, a]) => ({
        id: key, // IMPORTANT: Passem l'ID per traduir
        title: a.title || 'Problema detectat',
        description: a.description || '',
        score: a.score ?? 0,
        displayValue: a.displayValue,
        impact: (a.score === 0 ? 'high' : 'medium'),
        type: (a.score === 0 ? "error" : "warning") as "error" | "warning"
      }))
      .sort((a, b) => (a.score || 0) - (b.score || 0))
      .slice(0, 8);
  }

  // 5. Captura
  type ScreenshotDetails = { data?: string };
  const screenshotData = 
      rawData?.screenshot || 
      (googleAudits['final-screenshot']?.details as ScreenshotDetails)?.data || 
      '';

  const seoScore = audit.seoScore ?? 0;
  const perfScore = audit.performanceScore ?? 0;

  return (
    <div className="space-y-10 pb-20 max-w-7xl mx-auto">
      
      <AuditHeader 
        url={audit.url} 
        date={new Date(audit.createdAt)}
        pdfData={{
          url: audit.url,
          date: new Date(audit.createdAt).toLocaleDateString(),
          scores: { seo: seoScore, perf: perfScore, a11y: 85, best: 92 },
          screenshot: screenshotData,
          issues: displayIssues
        }}
      />

      <ScoreGrid seo={seoScore} perf={perfScore} />

      <div className="grid lg:grid-cols-3 gap-8 lg:gap-12">
         <div className="lg:col-span-2 space-y-10">
            <CoreVitalsGrid metrics={metrics} />
            <IssuesList issues={displayIssues} />
         </div>

         <div className="lg:col-span-1">
            <div className="sticky top-8">
                <MobilePreview screenshot={screenshotData} />
            </div>
         </div>
      </div>

    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/layout.tsx ===================

import { Sidebar } from '@/components/dashboard/Sidebar';
import { MobileBottomBar } from './MobilBottomBar';
import { DashboardHeader } from '@/components/dashboard/DashboardHeader';
import { createClient } from '@/lib/supabase/server';
import { redirect } from '@/routing';

type Props = {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
};

export default async function DashboardLayout({ children, params }: Props) {
  const supabase = await createClient();
  const { data: { user }, error } = await supabase.auth.getUser();
  const { locale } = await params;

  if (error || !user) {
    redirect({ href: '/auth/login', locale });
  }

  // ğŸ‘‡ CORRECCIÃ“: NO usem .single() perquÃ¨ pot tenir mÃºltiples perfils
  const { data: profiles } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user!.id);

  // Busquem si en ALGUN dels seus perfils Ã©s admin
  // TambÃ© pots afegir el "Super Admin Override" per email per seguretat extra
  const isAdmin = profiles?.some(p => p.role === 'admin') || user!.email === process.env.ADMIN_EMAIL;
  
  const userRole = isAdmin ? 'admin' : 'client';

  // (Opcional) Deixem un log net per confirmar que ara funciona
  console.log(`âœ… Rol calculat per ${user!.email}: ${userRole} (Perfils trobats: ${profiles?.length})`);

  return (
    <div className="min-h-screen bg-muted/10 flex font-sans text-foreground">
      
      {/* SIDEBAR */}
      <div className="hidden md:block w-64 shrink-0 z-40">
         <Sidebar userRole={userRole} />
      </div>

      {/* AREA PRINCIPAL */}
      <div className="flex-1 flex flex-col min-h-screen relative overflow-hidden">
         <div className="absolute top-0 left-0 w-full h-[500px] bg-primary/5 blur-[150px] pointer-events-none"></div>

         <DashboardHeader userEmail={user?.email ?? ''} />
         
         <main className="flex-1 p-4 md:p-8 overflow-y-auto relative z-10 pb-24 md:pb-8">
            {children}
         </main>

         <div className="md:hidden">
            <MobileBottomBar userRole={userRole} />
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/MobilBottomBar.tsx ===================

'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { LayoutDashboard, FileText, FolderKanban, Settings, ShieldAlert } from 'lucide-react';
import { cn } from '@/lib/utils';
import { useTranslations } from 'next-intl';

// 1. DEFINIM LA INTERFÃCIE
interface MobileBottomBarProps {
  userRole: 'admin' | 'client' | 'lead';
}

// 2. ACCEPTEM LA PROP
export function MobileBottomBar({ userRole }: MobileBottomBarProps) {
  console.log("ğŸ” [CLIENT MOBILE] Prop rebuda userRole:", userRole);
  const t = useTranslations('Sidebar');
  const pathname = usePathname();

  const cleanPath = pathname.replace(/^\/[a-z]{2}/, '') || '/';

  // 3. DEFINIM ELS ÃTEMS BÃ€SICS
  const MENU_ITEMS = [
    { icon: LayoutDashboard, label: t('summary'), href: '/dashboard' },
    { icon: FileText, label: t('audits'), href: '/dashboard/audits' },
    { icon: FolderKanban, label: 'Tests', href: '#proves' },
    { icon: Settings, label: t('settings'), href: '#ajustos' },
  ];

  // 4. AFEGIM L'ADMIN NOMÃ‰S SI TOCA
  if (userRole === 'admin') {
    MENU_ITEMS.push({ // 'push' ho posa al final (dreta)
      icon: ShieldAlert, 
      label: 'Admin', // O t('admin') si tens la traducciÃ³
      href: '/admin' 
    });
  }

  const handleClick = (e: React.MouseEvent, href: string, label: string) => {
    if (href.startsWith('#')) {
      e.preventDefault();
      alert(`${label} estarÃ  disponible properament! ğŸš€`);
    }
  };

  return (
    <div className="fixed bottom-0 left-0 w-full z-50 bg-background/95 backdrop-blur-xl border-t border-border pb-safe transition-colors duration-300">
        <div className="flex justify-around items-center h-16 px-2">
            {MENU_ITEMS.map((item) => {
                const Icon = item.icon;
                let isActive = false;
                
                // LÃ²gica activa
                if (!item.href.startsWith('#')) {
                   if (item.href === '/dashboard') {
                      isActive = cleanPath === '/dashboard';
                   } else {
                      isActive = cleanPath.startsWith(item.href);
                   }
                }

                // Detectem si Ã©s admin per donar-li color especial (opcional)
                const isAdminItem = item.href === '/admin';

                return (
                    <Link 
                        key={item.label} 
                        href={item.href}
                        onClick={(e) => handleClick(e, item.href, item.label)}
                        className={cn(
                            "flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform",
                            isActive 
                                ? "text-primary" 
                                : "text-muted-foreground hover:text-foreground",
                            // Color vermellÃ³s per a l'admin si vols que destaqui
                            (isAdminItem && !isActive) && "text-red-400 hover:text-red-500"
                        )}
                    >
                        <Icon 
                            className={cn("w-6 h-6 transition-all", isActive && "fill-current/20 scale-110")} 
                            strokeWidth={isActive ? 2.5 : 2} 
                        />
                        <span className={cn("text-[10px] font-medium", isActive ? "font-bold" : "")}>
                            {item.label}
                        </span>
                    </Link>
                );
            })}
        </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/new-audit/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { getLocale, getTranslations } from 'next-intl/server'; // Importem getTranslations
import { CreateAuditForm } from '@/features/audit/ui/components/CreateAuditForm';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

export default async function NewAuditPage() {
  const supabase = await createClient();
  const locale = await getLocale();
  const t = await getTranslations('NewAudit'); // Namespace NewAudit
  
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect(`/${locale}/auth/login`);
  }

  return (
    <div className="max-w-2xl mx-auto py-8 px-4">
      
      <Link 
        href="/dashboard/audits" 
        className="flex items-center text-sm text-muted-foreground hover:text-foreground mb-8 transition-colors w-fit"
      >
         <ArrowLeft className="w-4 h-4 mr-2" /> {t('back_to_list')}
      </Link>

      <div className="bg-card border border-border rounded-2xl p-8 md:p-12 shadow-2xl relative overflow-hidden">
         
         <div className="absolute top-0 right-0 w-64 h-64 bg-primary/10 blur-[80px] rounded-full pointer-events-none"></div>

         <div className="relative z-10">
            <h1 className="text-3xl font-bold text-foreground mb-4">{t('title')}</h1>
            <p className="text-muted-foreground mb-8 leading-relaxed">
               {t('description')}
            </p>

            <CreateAuditForm  />
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/page.tsx ===================

import { getTranslations } from 'next-intl/server';
import { redirect } from 'next/navigation';
import { Link } from '@/routing';
import { createClient } from '@/lib/supabase/server';
import { auditRepository } from '@/services/container';
import { Activity, BarChart3, Clock, Plus } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { AuditCard } from '@/components/dashboard/AuditCard';

export default async function DashboardPage() {
    const supabase = await createClient();
    // Use the namespace we created
    const t = await getTranslations('DashboardHome'); 
    
    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) {
        redirect('/');
    }

    const audits = await auditRepository.getAuditsByUserEmail(user.email);
    const totalAudits = audits.length;
    const validSeoScores = audits
        .filter(a => a.seoScore !== null && a.seoScore !== undefined)
        .map(a => a.seoScore as number);
    const avgSeo = validSeoScores.length > 0
        ? Math.round(validSeoScores.reduce((a, b) => a + b, 0) / validSeoScores.length)
        : 0;

    return (
        <div className="space-y-8 pb-24 md:pb-8"> 

            {/* HEADER */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 pb-6 border-b border-border">
                <div>
                    <h1 className="text-2xl md:text-3xl font-bold text-foreground">
                        {t('welcome', { name: user.email.split('@')[0] })}
                    </h1>
                    <p className="text-muted-foreground mt-1 text-sm md:text-base">{t('subtitle')}</p>
                </div>
                <Link href="/dashboard/new-audit" className="w-full md:w-auto">
                    <Button className="w-full md:w-auto gradient-bg text-white border-0 shadow-lg shadow-primary/20 hover:opacity-90">
                         <Plus className="w-4 h-4 mr-2" /> {t('new_audit')}
                    </Button>
                </Link>
            </div>

            {/* KPI CARDS */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                <KpiCard
                    label={t('kpi_audits')}
                    value={totalAudits.toString()}
                    icon={Activity}
                    color="text-blue-600 dark:text-blue-400"
                    bg="bg-blue-100 dark:bg-blue-500/10"
                />
                <KpiCard
                    label={t('kpi_seo')}
                    value={avgSeo > 0 ? `${avgSeo}/100` : '-'}
                    icon={BarChart3}
                    color="text-green-600 dark:text-green-400"
                    bg="bg-green-100 dark:bg-green-500/10"
                />
                <KpiCard
                    label={t('kpi_system')}
                    value={t('system_status')}
                    icon={Clock}
                    color="text-purple-600 dark:text-purple-400"
                    bg="bg-purple-100 dark:bg-purple-500/10"
                />
            </div>

            {/* LLISTAT AUDITORIA */}
            {audits.length > 0 ? (
                <div>
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold text-foreground">{t('recent_projects')}</h2>
                        <Link href="/dashboard/audits" className="text-sm text-primary hover:underline font-medium">
                           {t('view_all')}
                        </Link>
                    </div>

                    <div className="grid gap-4 md:gap-6 md:grid-cols-2 lg:grid-cols-3">
                        {audits.slice(0, 6).map((audit) => (
                            <AuditCard key={audit.id} audit={audit} />
                        ))}
                    </div>
                </div>
            ) : (
                /* EMPTY STATE */
                <div className="py-12 flex flex-col items-center justify-center text-center border-2 border-dashed border-border rounded-2xl bg-card/50">
                    <div className="w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4">
                        <Activity className="w-8 h-8 text-muted-foreground" />
                    </div>
                    <h3 className="text-lg font-bold text-foreground mb-2">{t('empty_title')}</h3>
                    <p className="text-muted-foreground mb-6 max-w-sm text-sm">
                        {t('empty_desc')}
                    </p>
                    <Link href="/dashboard/new-audit">
                        <Button variant="outline">{t('empty_button')}</Button>
                    </Link>
                </div>
            )}
        </div>
    );
}

// Helpers es mantenen igual...
type KpiCardProps = {
    label: string;
    value: string;
    icon: React.ComponentType<{ className?: string }>;
    color: string;
    bg: string;
};

function KpiCard({ label, value, icon: Icon, color, bg }: KpiCardProps) {
    return (
        <div className="bg-card dark:bg-[#0f111a]/50 border border-border dark:border-white/5 p-4 md:p-6 rounded-xl md:rounded-2xl shadow-sm flex flex-row md:flex-col items-center md:items-start gap-4 md:gap-0 justify-between md:justify-start transition-colors">
            <div className="flex md:block items-center gap-3 md:gap-0 md:w-full md:mb-4">
                <div className={`p-2.5 md:p-3 rounded-lg md:rounded-xl ${bg} shrink-0`}>
                    <Icon className={`w-5 h-5 md:w-6 md:h-6 ${color}`} />
                </div>
                <span className="text-sm text-muted-foreground md:hidden font-medium">{label}</span>
            </div>
            <div className="text-right md:text-left">
                <div className="text-2xl md:text-3xl font-bold text-foreground">{value}</div>
                <div className="text-sm text-muted-foreground hidden md:block font-medium">{label}</div>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/dashboard/projects/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { Link } from '@/routing';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { FolderGit2, ArrowRight, FlaskConical, Globe, Clock } from 'lucide-react';
import { redirect } from 'next/navigation';

export const metadata = {
  title: 'Els Meus Projectes | DigitAI Studios',
};

export default async function ProjectsListPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) redirect('/auth/login');

  // ğŸ”¥ CONSULTA CORREGIDA:
  // 1. Busquem IDs on Ã©s membre
  const { data: memberships } = await supabase
    .from('project_members')
    .select('project_id')
    .eq('user_id', user.id);

  const memberProjectIds = memberships?.map(m => m.project_id) || [];

  // 2. Busquem els projectes (On Ã©s Owner O on Ã©s Membre)
  // Usem la sintaxi 'or' de Supabase per combinar condicions
  const { data: projects } = await supabase
    .from('projects')
    .select(`
      *,
      test_campaigns(count)
    `)
    // Filtre: (client_id = user.id) OR (id IN memberProjectIds)
    // La sintaxi .or() Ã©s complexa amb arrays, aixÃ­ que fem un filtre mÃ©s simple:
    // Carreguem els projectes on l'ID estÃ  a la llista de membres OR client_id Ã©s ell.
    // NOTA: La manera mÃ©s neta en Supabase Ã©s fer servir una Policy RLS correcta (PAS 3),
    // i llavors aquÃ­ nomÃ©s fem un select sense filtres.

    // PerÃ² per ara, si no volem tocar SQL, fem aixÃ²:
    .or(`client_id.eq.${user.id},id.in.(${memberProjectIds.join(',') || '00000000-0000-0000-0000-000000000000'})`)
    .order('created_at', { ascending: false });

  return (
    <div className="space-y-8 p-6 md:p-8">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-foreground flex items-center gap-3">
            <FolderGit2 className="w-8 h-8 text-primary" /> Els Meus Projectes
          </h1>
          <p className="text-muted-foreground mt-1">
            Gestiona les teves aplicacions i participa en les fases de test.
          </p>
        </div>
      </div>

      {!projects || projects.length === 0 ? (
        <div className="py-20 text-center border-2 border-dashed border-border rounded-2xl bg-muted/10">
          <FolderGit2 className="w-16 h-16 mx-auto text-muted-foreground mb-4 opacity-50" />
          <h3 className="text-xl font-medium text-foreground">Encara no tens projectes</h3>
          <p className="text-muted-foreground mt-2 mb-6">Contacta amb nosaltres per comenÃ§ar el teu primer desenvolupament.</p>
          <Link href="/#contacte">
            <Button>SolÂ·licitar Projecte</Button>
          </Link>
        </div>
      ) : (
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {projects.map((project) => {
            // Comprovem si tÃ© tests actius (el count que hem demanat a la query)
            const hasActiveTests = project.test_campaigns?.[0]?.count > 0;

            return (
              <Link key={project.id} href={`/dashboard/projects/${project.id}`} className="group block h-full">
                <Card className="h-full border-border hover:border-primary/50 transition-all duration-300 hover:shadow-lg hover:-translate-y-1 relative overflow-hidden">

                  {/* Indicador Beta si hi ha tests */}
                  {hasActiveTests && (
                    <div className="absolute top-0 right-0 bg-purple-600 text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl shadow-sm z-10 flex items-center gap-1">
                      <FlaskConical className="w-3 h-3" /> BETA DISPONIBLE
                    </div>
                  )}

                  <CardHeader className="pb-4">
                    <div className="flex justify-between items-start mb-2">
                      <div className={`p-2.5 rounded-lg ${hasActiveTests ? 'bg-purple-100 dark:bg-purple-900/20 text-purple-600' : 'bg-blue-100 dark:bg-blue-900/20 text-blue-600'}`}>
                        <FolderGit2 className="w-6 h-6" />
                      </div>
                    </div>
                    <CardTitle className="text-xl font-bold group-hover:text-primary transition-colors">
                      {project.name}
                    </CardTitle>
                    <div className="flex items-center gap-2 text-xs text-muted-foreground font-mono mt-1">
                      <Globe className="w-3 h-3" /> {project.domain || 'configurant...'}
                    </div>
                  </CardHeader>

                  <CardContent>
                    <div className="flex items-center justify-between mt-4 pt-4 border-t border-border">
                      <span className={`px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider 
                            ${project.status === 'active' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' :
                          project.status === 'maintenance' ? 'bg-orange-100 text-orange-700' :
                            'bg-slate-100 text-slate-600'}
                        `}>
                        {project.status || 'PENDENT'}
                      </span>

                      <span className="text-xs text-muted-foreground flex items-center gap-1">
                        <Clock className="w-3 h-3" />
                        {new Date(project.created_at || new Date()).toLocaleDateString()}
                      </span>
                    </div>
                  </CardContent>
                </Card>
              </Link>
            );
          })}
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/projects/[id]/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { notFound, redirect } from 'next/navigation';
import { Layout, ArrowRight, Target, FlaskConical, Trophy } from 'lucide-react';
import { GamificationService } from '@/services/GamificationService';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { MissionCard } from '@/features/tests/ui/MissionCard';
import { Progress } from '@/components/ui/progress';

type Props = {
    params: Promise<{ id: string }>
}

// âœ… MAPA D'EMOJIS (En lloc de components Lucide)
const RANK_EMOJIS: Record<string, string> = {
    'Novell': 'ğŸ£',
    'Bug Hunter': 'ğŸ›',
    'Expert': 'ğŸ•µï¸',
    'Mestre': 'ğŸ‘‘',
};

export default async function ProjectDetailPage({ params }: Props) {
    const { id } = await params;
    const supabase = await createClient();

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) redirect('/auth/login');

    const gameService = new GamificationService();
    const testRepo = new SupabaseTestRepository();

    const [projectRes, stats, missions] = await Promise.all([
        supabase.from('projects').select('name, domain, repository_url').eq('id', id).single(),
        gameService.getUserStats(user.id),
        testRepo.getActiveMissionsForUser(user.id, id)
    ]);

    const project = projectRes.data;
    if (!project) return notFound();

    // Seleccionem l'emoji segons el nom del rang
    const currentEmoji = RANK_EMOJIS[stats.rankName] || 'ğŸŒ±';

    return (
        <div className="min-h-screen bg-slate-50/50 dark:bg-slate-950/50 pb-20 p-6 md:p-10">
            <div className="max-w-6xl mx-auto space-y-8">

                {/* 1. HEADER GAMIFICAT */}
                <div className="bg-linear-to-r from-indigo-900 to-purple-900 rounded-2xl p-8 text-white shadow-2xl relative overflow-hidden">
                    <div className="absolute top-0 right-0 opacity-10">
                        <Trophy className="w-64 h-64 -rotate-12 transform translate-x-10 -translate-y-10" />
                    </div>

                    <div className="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                        <div>
                            <div className="flex items-center gap-4 mb-2">
                                {/* ğŸŸ¢ AQUÃ VA L'EMOJI GRAN */}
                                <div className="">
                                    <span className="text-6xl filter drop-shadow-md">
                                        {currentEmoji}
                                    </span>
                                </div>
                                
                                <div>
                                    <h1 className="text-2xl font-bold">{stats.rankName}</h1>
                                    <p className="text-purple-200 text-sm">Nivell {stats.level}</p>
                                </div>
                            </div>
                            
                            <div className="max-w-md mt-4">
                                <div className="flex justify-between text-xs mb-1 uppercase font-bold tracking-wider opacity-70">
                                    <span>XP: {stats.xp}</span>
                                    <span>SegÃ¼ent: {stats.nextLevelXp}</span>
                                </div>
                                <Progress value={stats.progressToNext} className="h-3 bg-black/30" />
                            </div>
                        </div>

                        <div className="bg-white/10 backdrop-blur-md p-4 rounded-xl border border-white/20 min-w-[200px]">
                            <div className="flex items-center gap-2 text-purple-200 text-xs mb-1 uppercase tracking-wider font-bold">
                                <Layout className="w-3 h-3" /> Projecte Actual
                            </div>
                            <div className="text-xl font-bold text-white mb-1">{project.name}</div>
                            {project.domain && (
                                <a href={`https://${project.domain}`} target="_blank" className="text-xs text-purple-300 hover:text-white hover:underline flex items-center gap-1">
                                    {project.domain} <ArrowRight className="w-3 h-3" />
                                </a>
                            )}
                        </div>
                    </div>
                </div>

                {/* 2. LLISTA DE MISSIONS */}
                <div>
                    <h2 className="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800 dark:text-white">
                        <Target className="w-5 h-5 text-red-500" /> Missions Disponibles
                    </h2>

                    {missions.length === 0 ? (
                        <div className="text-center py-24 bg-white dark:bg-slate-900 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700">
                            <FlaskConical className="w-16 h-16 mx-auto text-slate-300 mb-4" />
                            <h3 className="text-xl font-bold text-slate-700 dark:text-slate-200">Cap missiÃ³ activa</h3>
                            <p className="text-slate-500 max-w-md mx-auto mt-2">
                                No tens proves assignades per a aquest projecte ara mateix.
                            </p>
                        </div>
                    ) : (
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {missions.map((mission) => (
                                <MissionCard
                                    key={mission.id}
                                    id={mission.id}
                                    projectId={id}
                                    title={mission.title}
                                    description={mission.description}
                                    stats={mission.stats}
                                />
                            ))}
                        </div>
                    )}
                </div>

            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/dashboard/projects/[id]/[testId]/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { notFound, redirect } from 'next/navigation';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { TaskRunner } from '@/features/tests/ui/TaskRunner';
import { BackButton } from '@/components/ui/back-button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { BookOpen, CheckCircle2, Trophy } from 'lucide-react';

type Props = {
  params: Promise<{ id: string; testId: string }>;
};

export default async function TestRunnerPage({ params }: Props) {
  const { id: projectId, testId } = await params;
  const supabase = await createClient();
  
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/auth/login');

  const repo = new SupabaseTestRepository();

  // 1. Carreguem el Test i el Context d'Usuari (Resultats previs)
  const ctx = await repo.getCampaignWithContext(testId, user.id);

  // 2. Validacions de Seguretat
  if (!ctx.campaign) return notFound();
  
  // Assegurem que el test pertany al projecte de la URL (evitar manipulaciÃ³ d'URL)
  if (ctx.campaign.projectId !== projectId) return notFound();

  // 3. CÃ lcul de GamificaciÃ³ (ProgrÃ©s)
  const totalTasks = ctx.tasks.length;
  // âœ… CORRECCIÃ“: Definim la variable correctament
  const completedTasks = ctx.results.filter(r => r.status === 'pass').length;
  
  // âœ… CORRECCIÃ“: Utilitzem 'completedTasks' aquÃ­
  const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

  // Missatge motivacional segons progrÃ©s
  let motivation = "Comencem la missiÃ³! ğŸš€";
  if (progress > 0) motivation = "Bon comenÃ§ament! Continua aixÃ­. ğŸ’ª";
  if (progress > 50) motivation = "Ja has passat la meitat! Ets un crack. ğŸ”¥";
  if (progress === 100) motivation = "MISSIÃ“ COMPLERTA! ğŸ‰ GrÃ cies pel teu temps.";

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 pb-20">
      
      {/* HEADER IMMERSIU */}
      <div className="bg-slate-900 border-b border-slate-800 sticky top-0 z-10 shadow-lg">
        <div className="max-w-6xl mx-auto px-4 py-4">
            
            <div className="flex items-center justify-between mb-4">
                {/* BotÃ³ enrere amb parÃ metre source=project per tornar a la llista correcta */}
                <BackButton projectId={projectId} />
                <Badge variant="outline" className="text-purple-400 border-purple-500/50">
                    Mode Tester Actiu
                </Badge>
            </div>

            <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                <div>
                    <h1 className="text-2xl font-bold text-white mb-1 flex items-center gap-2">
                        {ctx.campaign.title}
                    </h1>
                    <p className="text-slate-400 text-sm flex items-center gap-2">
                        {motivation}
                    </p>
                </div>

                {/* BARRA DE PROGRÃ‰S GRAN */}
                <div className="w-full md:w-1/3">
                    <div className="flex justify-between text-xs text-slate-400 mb-1 font-bold uppercase">
                        <span>ProgrÃ©s</span>
                        <span className={progress === 100 ? "text-green-400" : "text-white"}>{progress}%</span>
                    </div>
                    <div className="h-3 w-full bg-slate-800 rounded-full overflow-hidden border border-slate-700">
                        <div 
                            className={`h-full transition-all duration-1000 ease-out ${progress === 100 ? 'bg-green-500' : 'bg-purple-600'}`}
                            style={{ width: `${progress}%` }} 
                        />
                    </div>
                </div>
            </div>
        </div>
      </div>

      {/* CONTINGUT PRINCIPAL */}
      <div className="max-w-6xl mx-auto px-4 py-8 grid lg:grid-cols-12 gap-8">
        
        {/* COLUMNA ESQUERRA: Guia (Sticky) */}
        <div className="lg:col-span-5 space-y-6">
            <div className="lg:sticky lg:top-36 space-y-6">
                <Card className="border-l-4 border-l-blue-500 shadow-sm">
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2 text-lg">
                            <BookOpen className="w-5 h-5 text-blue-500" /> Instruccions
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="prose prose-sm dark:prose-invert max-w-none">
                        {ctx.campaign.instructions ? (
                            <div className="whitespace-pre-wrap font-sans text-slate-600 dark:text-slate-300">
                                {ctx.campaign.instructions}
                            </div>
                        ) : (
                            <p className="italic text-slate-400">Sense instruccions especials. Valida cada punt de la llista.</p>
                        )}
                    </CardContent>
                </Card>

                {progress === 100 && (
                    <div className="bg-green-500/10 border border-green-500/20 p-6 rounded-xl text-center animate-in zoom-in">
                        <Trophy className="w-12 h-12 text-green-500 mx-auto mb-2" />
                        <h3 className="text-lg font-bold text-green-600 dark:text-green-400">Felicitats!</h3>
                        <p className="text-sm text-green-700 dark:text-green-300">Has completat totes les tasques d'aquesta missiÃ³.</p>
                    </div>
                )}
            </div>
        </div>

        {/* COLUMNA DRETA: Tasques (Runner) */}
        <div className="lg:col-span-7 space-y-4">
            <h2 className="text-lg font-bold flex items-center gap-2 mb-4">
                <CheckCircle2 className="w-5 h-5 text-slate-400" />
                Llista de VerificaciÃ³ ({completedTasks}/{totalTasks})
            </h2>

            {ctx.tasks.map((task) => {
                const result = ctx.results.find(r => r.taskId === task.id);
                return (
                    <TaskRunner 
                        key={task.id}
                        task={task}
                        existingResult={result}
                    />
                );
            })}
        </div>

      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/tests/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { GamificationService } from '@/services/GamificationService';
import { Link } from '@/routing';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Trophy, Target, Zap } from 'lucide-react';

export default async function TesterDashboard() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if(!user) return <div>No user</div>;

    const repo = new SupabaseTestRepository();
    const gameService = new GamificationService();

    // ParalÂ·lelitzem les dades
    const [assignments, stats] = await Promise.all([
        repo.getMyAssignments(user.id),
        gameService.getUserStats(user.id)
    ]);

    return (
        <div className="p-6 space-y-8">
            
            {/* 1. HEADER GAMIFICAT */}
            <div className="bg-linear-to-r from-indigo-900 to-purple-900 rounded-2xl p-8 text-white shadow-2xl relative overflow-hidden">
                <div className="absolute top-0 right-0 opacity-10">
                    <Trophy className="w-64 h-64 -rotate-12 transform translate-x-10 -translate-y-10" />
                </div>
                
                <div className="relative z-10">
                    <div className="flex items-center gap-4 mb-2">
                        {/* âš ï¸ CORRECCIÃ“: stats.rankName en lloc de stats.rank */}
                        <span className="text-4xl">{stats.rankName.split(' ')[1]}</span>
                        <div>
                            {/* âš ï¸ CORRECCIÃ“: stats.rankName en lloc de stats.rank */}
                            <h1 className="text-2xl font-bold">{stats.rankName.split(' ')[0]}</h1>
                            <p className="text-purple-200 text-sm">Nivell {stats.level}</p>
                        </div>
                    </div>

                    <div className="max-w-md mt-4">
                        <div className="flex justify-between text-xs mb-1 uppercase font-bold tracking-wider opacity-70">
                            <span>XP: {stats.xp}</span>
                            <span>SegÃ¼ent Nivell: {stats.nextLevelXp}</span>
                        </div>
                        <Progress value={stats.progressToNext} className="h-3 bg-black/30" />
                        <p className="text-xs mt-2 text-purple-300">
                            Completa tasques per guanyar XP i pujar de rang!
                        </p>
                    </div>
                </div>
            </div>

            {/* 2. GRID DE MISSIONS */}
            <div>
                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                    <Target className="w-5 h-5 text-red-500" /> Missions Actives
                </h2>

                {assignments.length === 0 ? (
                    <div className="text-center py-12 border-2 border-dashed rounded-xl">
                        <p className="text-slate-500">No tens cap missiÃ³ assignada encara.</p>
                        <p className="text-xs text-slate-400">Demana al teu Project Manager que t'assigni!</p>
                    </div>
                ) : (
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {assignments.map(mission => (
                            <Link key={mission.assignmentId} href={`/dashboard/projects/${mission.campaignId}`} className="group block"> {/* âš ï¸ Nota: He corregit l'enllaÃ§ per apuntar a /projects/ que Ã©s on tenim el detall */}
                                <Card className="h-full hover:border-purple-500 transition-all hover:shadow-lg hover:-translate-y-1 bg-white dark:bg-slate-900">
                                    <CardHeader>
                                        <div className="flex justify-between items-start">
                                            <span className="text-xs font-mono text-purple-500 bg-purple-500/10 px-2 py-1 rounded">
                                                {mission.projectName}
                                            </span>
                                            {/* AquÃ­ podries posar el % completat si el calculÃ©ssim */}
                                        </div>
                                        <CardTitle className="mt-2 group-hover:text-purple-600 transition-colors">
                                            {mission.title}
                                        </CardTitle>
                                    </CardHeader>
                                    <CardContent>
                                        <p className="text-sm text-slate-500 line-clamp-2 mb-4">
                                            {mission.description || "Sense descripciÃ³..."}
                                        </p>
                                        <div className="flex items-center gap-2 text-xs font-bold text-slate-400">
                                            <Zap className="w-3 h-3 text-yellow-500" />
                                            {mission.totalTasks} Tasques
                                        </div>
                                    </CardContent>
                                </Card>
                            </Link>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/layout.tsx ===================

import { NextIntlClientProvider } from 'next-intl';
import { getMessages } from 'next-intl/server';
import { notFound } from 'next/navigation';
import { routing, type Locale } from '@/routing';
import { Inter } from 'next/font/google';
import { ThemeProvider } from "@/components/theme-provider";
import "@/app/globals.css";
import type { Metadata, Viewport } from 'next';
import { Toaster } from 'sonner';

// ğŸ‘‡ 1. IMPORTACIONS NOVES
import { Suspense } from 'react';
import { AnalyticsTracker } from '@/features/analytics/ui/AnalyticsTracker';

const inter = Inter({
  subsets: ['latin'],
  variable: '--font-inter',
  display: 'swap',
});

// 1. CONFIGURACIÃ“ DEL VIEWPORT
export const viewport: Viewport = {
  themeColor: [
    { media: '(prefers-color-scheme: light)', color: 'white' },
    { media: '(prefers-color-scheme: dark)', color: '#020817' },
  ],
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
};

// 2. METADADES GLOBALS
export const metadata: Metadata = {
  title: {
    default: 'DigitAI Studios | Desenvolupament Web & IA',
    template: '%s | DigitAI Studios'
  },
  description: 'Transformem negocis amb AppWebs, Apps Natives i AutomatitzaciÃ³ IA. Solucions digitals 360Â°.',
  keywords: ['Desenvolupament Web', 'App', 'React Native', 'Next.js', 'IA', 'AutomatitzaciÃ³', 'Girona'],
  authors: [{ name: 'DigitAI Studios' }],
  creator: 'DigitAI Studios',
  manifest: '/manifest.webmanifest',
  icons: {
    icon: '/icons/icon-192.png',
    shortcut: '/icons/icon-192.png',
    apple: '/icons/apple-icon.png',
    other: {
      rel: 'apple-touch-icon-precomposed',
      url: '/icons/apple-icon.png',
    },
  },
  openGraph: {
    type: 'website',
    locale: 'ca_ES',
    url: 'https://digitaistudios.com',
    title: 'DigitAI Studios | InnovaciÃ³ Digital',
    description: 'Apps, Webs i AutomatitzaciÃ³ IA per a empreses modernes.',
    siteName: 'DigitAI Studios',
    images: [
      {
        url: '/images/og-image.jpg', // Nota: Millor ruta pÃºblica directa que '@/assets'
        width: 1200,
        height: 630,
        alt: 'DigitAI Studios Cover',
      },
    ],
  },
};

export default async function LocaleLayout({
  children,
  params
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;

  if (!routing.locales.includes(locale as Locale)) {
    notFound();
  }

  const messages = await getMessages();

  return (
    <html lang={locale} className={inter.variable} suppressHydrationWarning>
      <body className="antialiased bg-background text-foreground overflow-x-hidden transition-colors duration-300">
        <NextIntlClientProvider messages={messages}>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            <Suspense fallback={null}>
              <AnalyticsTracker />
            </Suspense>

            {/* ğŸ”” SONNER GLOBAL */}
            <Toaster richColors closeButton />

            {children}
          </ThemeProvider>
        </NextIntlClientProvider>
      </body>
    </html>
  );
}

// =================== FILE: src/components/admin/AdminSidebar.tsx ===================

// src/components/admin/AdminSidebar.tsx
'use client';

import { Link, usePathname } from '@/routing';
import { cn } from '@/lib/utils';
import { ThemeToggle } from '@/components/ui/theme-toggle'; // ğŸ‘ˆ Importem el Toggle
import { 
  ShieldAlert, 
  BarChart3, 
  Users, 
  BookOpenCheck, 
  FlaskConical, 
  Home,
  Briefcase
} from 'lucide-react';

export function AdminSidebar() {
  const pathname = usePathname();

  const NAV_ITEMS = [
    { label: 'AnalÃ­tiques', href: '/admin/analytics', icon: BarChart3 },
    { label: 'Usuaris', href: '/admin/users', icon: Users },
    { label: 'Projectes', href: '/admin/projects', icon: Briefcase },
    { label: 'QA / Tests', href: '/admin/tests', icon: FlaskConical },
    { label: 'Blog', href: '/admin/blog', icon: BookOpenCheck },
  ];

  return (
    <aside className="hidden md:flex w-64 border-r border-border p-6 flex-col bg-card/50 backdrop-blur-xl h-full sticky top-0">
      
      {/* CAPÃ‡ALERA */}
      <div className="flex items-center gap-2 font-bold text-foreground mb-10 text-xl px-2">
        <ShieldAlert className="text-primary w-6 h-6" /> {/* Usem primary en lloc de red-500 fix */}
        <span>ADMIN</span>
      </div>

      {/* NAVEGACIÃ“ */}
      <nav className="flex flex-col gap-2 flex-1">
        {NAV_ITEMS.map((item) => {
          const isActive = pathname.startsWith(item.href);
          
          return (
            <Link 
              key={item.href} 
              href={item.href} 
              className={cn(
                "flex items-center gap-3 px-4 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium",
                isActive 
                  ? "bg-primary/10 text-primary border border-primary/10 shadow-sm" 
                  : "text-muted-foreground hover:bg-muted hover:text-foreground"
              )}
            >
              <item.icon className={cn("w-5 h-5", isActive ? "text-primary" : "opacity-70")} />
              <span>{item.label}</span>
            </Link>
          );
        })}
      </nav>

      {/* FOOTER AMB TOGGLE I RETORN */}
      <div className="mt-auto pt-6 border-t border-border space-y-4">
        
        {/* Selector de Tema */}
        <div className="flex items-center justify-between px-2">
            <span className="text-xs font-medium text-muted-foreground">Tema</span>
            <ThemeToggle />
        </div>

        <Link 
          href="/" 
          className="flex items-center gap-3 px-4 py-2.5 rounded-lg transition-colors text-muted-foreground hover:bg-muted hover:text-foreground text-sm"
        >
          <Home className="w-4 h-4 opacity-70" />
          <span>Tornar a la Web</span>
        </Link>
      </div>
    </aside>
  );
}

// =================== FILE: src/components/admin/AminMobileMenu.tsx ===================

'use client';

import { Link, usePathname } from '@/routing';
import { LayoutDashboard, BarChart3, Users, Home , BookOpenCheck, FlaskConical} from 'lucide-react';
import { cn } from '@/lib/utils';

export function AdminBottomNav() {
  const pathname = usePathname();

  const navLinks = [
    {
      href: '/admin',
      label: 'Inici',
      icon: LayoutDashboard
    },
    {
      href: '/admin/analytics',
      label: 'MÃ¨triques',
      icon: BarChart3
    },
    {
      href: '/admin/users',
      label: 'Usuaris',
      icon: Users
    },
    {
      href: '/admin/blog',
      label: 'Blog',
      icon: BookOpenCheck
    },
    {
      href: '/admin/tests',
      label: 'Tests',
      icon: FlaskConical // Icona de laboratori
    },
  ];

  return (
    <div className="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-slate-950 border-t border-slate-800 pb-safe">
      <nav className="flex items-center justify-around h-16">
        {navLinks.map((link) => {
          const Icon = link.icon;
          // Comprovem si la ruta coincideix exactament o si Ã©s una subruta
          const isActive = pathname === link.href;

          return (
            <Link
              key={link.href}
              href={link.href}
              className={cn(
                "flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors duration-200",
                isActive
                  ? "text-blue-400"
                  : "text-slate-500 hover:text-slate-300"
              )}
            >
              <Icon className={cn("w-6 h-6", isActive && "fill-current/20")} />
              <span className="text-[10px] font-medium">{link.label}</span>
            </Link>
          );
        })}

        {/* BotÃ³ separat per tornar a la web pÃºblica */}
        <Link
          href="/"
          className="flex flex-col items-center justify-center w-full h-full space-y-1 text-slate-600 hover:text-slate-400"
        >
          <Home className="w-6 h-6" />
          <span className="text-[10px] font-medium">Web</span>
        </Link>
      </nav>
    </div>
  );
}

// =================== FILE: src/components/charts/ScoreRing.tsx ===================

'use client';
import { RadialBarChart, RadialBar, PolarAngleAxis, ResponsiveContainer } from 'recharts';

export function ScoreRing({ score, label }: { score: number; label: string }) {
  // Color dinÃ mic
  const color = score >= 90 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
  
  const data = [{ name: 'Score', value: score, fill: color }];

  return (
    <div className="flex flex-col items-center justify-center w-full h-full">
        <div className="relative w-[120px] h-[120px]">
            <ResponsiveContainer width="100%" height="100%">
                <RadialBarChart 
                    innerRadius="80%" 
                    outerRadius="100%" 
                    barSize={10} 
                    data={data} 
                    startAngle={90} 
                    endAngle={-270}
                >
                    <PolarAngleAxis type="number" domain={[0, 100]} angleAxisId={0} tick={false} />
                    <RadialBar background dataKey="value" cornerRadius={10} />
                </RadialBarChart>
            </ResponsiveContainer>
            {/* Text al centre */}
            <div className="absolute inset-0 flex items-center justify-center">
                <span className="text-3xl font-bold" style={{ color }}>{score}</span>
            </div>
        </div>
        <p className="mt-2 text-sm font-medium text-slate-500 uppercase tracking-wider">{label}</p>
    </div>
  );
}

// =================== FILE: src/components/dashboard/AuditCard.tsx ===================

'use client';

import { Link } from '@/routing';
import { Card, CardContent } from '@/components/ui/card';
import { ArrowRight, Globe } from 'lucide-react';

type AuditProps = {
  id: string;
  url: string;
  status: 'processing' | 'completed' | 'failed';
  seoScore: number | null;
  createdAt: string | Date;
};

export function AuditCard({ audit }: { audit: AuditProps }) {
  return (
    <Link href={`/dashboard/audits/${audit.id}`} className="block group h-full">
      {/* Estil Fosc + Light Adaptable (bg-card en light, fons fosc en dark) */}
      <Card className="bg-card dark:bg-[#0f111a]/50 border border-border dark:border-white/5 hover:border-primary/50 transition-all h-full shadow-sm hover:shadow-md group-hover:-translate-y-1 backdrop-blur-sm">
        <CardContent className="p-6 flex flex-col h-full">
          
          {/* Header Card */}
          <div className="flex justify-between items-start mb-4">
            <div className="p-2.5 bg-muted dark:bg-white/5 rounded-lg text-muted-foreground group-hover:text-primary group-hover:bg-primary/10 transition-colors">
              <Globe className="w-5 h-5" />
            </div>
            <StatusBadge status={audit.status} />
          </div>

          {/* Body Card */}
          <div className="flex-grow">
            <h3 className="text-lg font-bold text-foreground dark:text-white truncate mb-1" title={audit.url}>
              {audit.url.replace(/^https?:\/\//, '').replace(/\/$/, '')}
            </h3>
            <p className="text-xs text-muted-foreground dark:text-slate-500 mb-6">
              {new Date(audit.createdAt).toLocaleDateString()}
            </p>
          </div>

          {/* Footer Card */}
          <div className="mt-auto flex items-center justify-between pt-4 border-t border-border dark:border-white/5">
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-wider text-muted-foreground font-bold">SEO SCORE</span>
              <span className={`text-xl font-bold ${getScoreColor(audit.seoScore ?? 0)}`}>
                {audit.seoScore ?? '-'}
              </span>
            </div>
            <div className="w-8 h-8 rounded-full bg-muted dark:bg-white/5 flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-all text-muted-foreground">
              <ArrowRight className="w-4 h-4" />
            </div>
          </div>
        </CardContent>
      </Card>
    </Link>
  );
}

// Helpers locals
function StatusBadge({ status }: { status: string }) {
  const styles = {
    completed: 'text-green-600 bg-green-100 border-green-200 dark:text-green-400 dark:bg-green-500/10 dark:border-green-500/20',
    processing: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-400 dark:bg-blue-500/10 dark:border-blue-500/20 animate-pulse',
    failed: 'text-red-600 bg-red-100 border-red-200 dark:text-red-400 dark:bg-red-500/10 dark:border-red-500/20'
  };
  const label = status === 'completed' ? 'Completada' : status === 'processing' ? 'Analitzant' : 'Error';

  return (
    <span className={`px-2.5 py-1 rounded-full text-[10px] uppercase font-bold tracking-wider border ${styles[status as keyof typeof styles] || 'text-muted-foreground bg-muted border-border'}`}>
      {label}
    </span>
  );
}

function getScoreColor(score: number) {
  if (score >= 90) return 'text-green-600 dark:text-green-400';
  if (score >= 50) return 'text-yellow-600 dark:text-yellow-400';
  return 'text-red-600 dark:text-red-400';
}

// =================== FILE: src/components/dashboard/DashboardHeader.tsx ===================

'use client';

import { Bell, Search } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { ThemeToggle } from '@/components/ui/theme-toggle';
import { useTranslations } from 'next-intl';
import { LanguageSwitcher } from '../layout/LanguageSwitcher'; // âš ï¸ OJO AQUÃ

export function DashboardHeader({ userEmail }: { userEmail?: string }) {
   const t = useTranslations('DashboardHeader');

   return (
      <header className="h-16 border-b border-border bg-background/80 backdrop-blur-xl sticky top-0 z-30 px-4 md:px-6 flex items-center justify-center md:justify-between transition-colors duration-300">

         <div className="flex items-center w-full max-w-xs md:max-w-md mr-4">
            <div className="relative w-full">
               <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
               <Input
                  placeholder={t('search_placeholder')}
                  className="pl-10 bg-muted/50 border-transparent focus:bg-background focus:border-primary transition-all h-9 rounded-full"
               />
            </div>
         </div>

         <div className="flex items-center gap-2 md:gap-4 shrink-0">
            <LanguageSwitcher />
            <ThemeToggle />

            <Button variant="ghost" size="icon" className="relative rounded-full text-muted-foreground hover:text-foreground hidden sm:flex">
               <Bell className="w-5 h-5" />
               <span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-background"></span>
            </Button>

            <div className="h-6 w-px bg-border mx-1 hidden sm:block"></div>

            <div className="flex items-center gap-3">
               <div className="text-right hidden md:block">
                  <p className="text-sm font-medium text-foreground leading-none">{t('account')}</p>
                  <p className="text-xs text-muted-foreground truncate max-w-[120px]">{userEmail}</p>
               </div>
               <div className="w-9 h-9 rounded-full bg-linear-to-br from-primary to-blue-500 flex items-center justify-center text-white font-bold shadow-lg ring-2 ring-background">
                  {userEmail ? userEmail.charAt(0).toUpperCase() : 'U'}
               </div>
            </div>
         </div>
      </header>
   );
}

// =================== FILE: src/components/dashboard/Sidebar.tsx ===================

'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { LayoutDashboard, FileText, FolderKanban, Settings, LogOut, Sparkles, ShieldAlert } from 'lucide-react';
import { cn } from '@/lib/utils';
// import { createClient } from '@/lib/supabase/client'; // âŒ Eliminem aixÃ²
// import { useRouter } from '@/routing'; // âŒ Eliminem aixÃ²
import { useTranslations } from 'next-intl';
import { useRouter } from '@/routing';
// ğŸ‘‡ 1. Importem l'acciÃ³ de servidor
import { signOutAction } from '@/features/auth/actions/auth';

interface SidebarProps {
  userRole: 'admin' | 'client' | 'lead';
}

export function Sidebar({ userRole }: SidebarProps) {
  const t = useTranslations('Sidebar');
  const pathname = usePathname();
  const router = useRouter(); // ğŸ‘ˆ RECUPEREM EL ROUTER
  // const router = useRouter(); // âŒ Eliminat
  // const supabase = createClient(); // âŒ Eliminat

  // âœ… LOGOUT HÃBRID AQUÃ TAMBÃ‰
  const handleSignOut = async () => {
    await signOutAction();
    router.refresh();
    router.push('/auth/login');
  };

  const handleClick = (e: React.MouseEvent, href: string, label: string) => {
    if (href.startsWith('#')) {
      e.preventDefault();
      alert(`${label} estarÃ  disponible properament! ğŸš€`);
    }
  };

  const cleanPath = pathname.replace(/^\/[a-z]{2}/, '') || '/';

  const MENU_ITEMS = [
    { icon: LayoutDashboard, label: t('summary'), href: '/dashboard' },
    { icon: FolderKanban, label: t('projects'), href: '/dashboard/projects' },
    { icon: FileText, label: t('audits'), href: '/dashboard/audits' },
    { icon: Settings, label: t('settings'), href: '#config' },
  ];

  if (userRole === 'admin') {
    MENU_ITEMS.unshift({
      icon: ShieldAlert,
      label: 'Admin Panel',
      href: '/admin'
    });
  }

  return (
    <aside className="w-64 h-screen bg-card border-r border-border flex flex-col sticky top-0 transition-colors duration-300">

      {/* LOGO AREA */}
      <div className="p-6 border-b border-border">
        <Link href="/" className="flex items-center gap-2 text-xl font-bold text-foreground">
          DigitAI <span className="text-primary">Hub</span>
        </Link>
      </div>

      {/* NAVIGATION */}
      <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
        <div className="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-4 px-2">
          {t('platform')}
        </div>

        {MENU_ITEMS.map((item) => {
          let isActive = false;

          if (!item.href.startsWith('#')) {
            if (item.href === '/dashboard') {
              isActive = cleanPath === '/dashboard';
            } else {
              isActive = cleanPath.startsWith(item.href);
            }
          }

          const isAdminItem = item.href === '/admin';

          return (
            <Link
              key={item.label}
              href={item.href}
              onClick={(e) => item.href.startsWith('#') && handleClick(e, item.href, item.label)}
              className={cn(
                "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200",
                isActive
                  ? "bg-primary/10 text-primary border border-primary/20 shadow-sm"
                  : "text-muted-foreground hover:text-foreground hover:bg-muted",
                (isAdminItem && !isActive) && "text-red-500 hover:text-red-600 hover:bg-red-500/10"
              )}
            >
              <item.icon className={cn("w-5 h-5", isActive ? "text-primary" : "text-current")} />
              {item.label}
            </Link>
          );
        })}

        {userRole !== 'admin' && (
          <div className="mt-8 p-4 rounded-xl bg-linear-to-br from-primary/10 to-blue-500/10 border border-primary/20 relative overflow-hidden">
            <div className="absolute top-0 right-0 w-20 h-20 bg-primary/20 blur-2xl rounded-full pointer-events-none"></div>
            <div className="flex items-center gap-2 text-foreground font-bold text-sm mb-2">
              <Sparkles className="w-4 h-4 text-primary" />
              {t('pro_badge')}
            </div>
            <p className="text-xs text-muted-foreground mb-3">{t('pro_text')}</p>
            <button className="w-full py-1.5 text-xs font-bold bg-primary text-primary-foreground rounded-lg hover:opacity-90 transition-opacity">
              {t('pro_button')}
            </button>
          </div>
        )}
      </nav>

      {/* FOOTER */}
      <div className="p-4 border-t border-border">
        {/* Utilitzem la nova funciÃ³ handleSignOut */}
        <button onClick={handleSignOut} className="flex items-center gap-3 w-full px-3 py-2.5 rounded-lg text-sm font-medium text-muted-foreground hover:text-red-500 hover:bg-red-500/10 transition-colors">
          <LogOut className="w-5 h-5" />
          {t('logout')}
        </button>
      </div>
    </aside>
  );
}

// =================== FILE: src/components/icons/GoogleIcon.tsx ===================

export const GoogleIcon = ({ className }: { className?: string }) => (
  <svg 
    xmlns="http://www.w3.org/2000/svg" 
    viewBox="0 0 24 24" 
    className={className}
  >
    <path
      d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
      fill="#4285F4"
    />
    <path
      d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
      fill="#34A853"
    />
    <path
      d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
      fill="#FBBC05"
    />
    <path
      d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
      fill="#EA4335"
    />
  </svg>
);

// =================== FILE: src/components/landing/AuditSection.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { AuditForm } from '@/features/audit/ui/AuditForm';
import { useTranslations } from 'next-intl';
import { User } from '@supabase/supabase-js';
import { Button } from '@/components/ui/button';
import { Link } from '@/routing'; // Usem el teu routing tipat
import { LayoutDashboard, ArrowRight } from 'lucide-react';

// Acceptem l'usuari com a prop opcional
interface Props {
  currentUser?: User | null;
}

export function AuditSection({ currentUser }: Props) {
  const t = useTranslations('AuditSection');

  return (
    <section id="audit" className="py-14 relative overflow-hidden bg-background transition-colors duration-300">
      
      {/* FONS DECORATIU */}
      <div className="absolute inset-0 bg-linear-to-b from-transparent via-primary/5 to-transparent pointer-events-none" />
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-blue-500/10 dark:bg-primary/10 blur-[120px] rounded-full pointer-events-none opacity-50" />

      <div className="container mx-auto px-4 relative z-10">
        
        <div className="max-w-3xl mx-auto text-center mb-12">
          <motion.div 
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
          >
            <h2 className="text-3xl lg:text-5xl font-bold mb-6 text-foreground leading-tight">
              {t('title_prefix')} <span className="text-red-500/80 line-through decoration-2">{t('title_cost')}</span> {t('title_connector')} <span className="gradient-text">{t('title_investment')}</span>?
            </h2>
            
            <p className="text-lg text-muted-foreground leading-relaxed">
              {t('description_stat')}
              <br className="hidden md:block" />
              {t('description_cta')}
            </p>
          </motion.div>
        </div>

        {/* LOGICA CONDICIONAL DE UI */}
        <motion.div 
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true }}
          transition={{ delay: 0.2 }}
          className="max-w-xl mx-auto transform hover:scale-[1.01] transition-transform duration-500"
        >
          {currentUser ? (
            // CAS 1: USUARI LOGUEJAT -> Targeta "Go to Dashboard"
            <div className="p-8 rounded-2xl bg-card border border-border shadow-2xl text-center space-y-6">
                <div className="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto text-primary mb-4">
                    <LayoutDashboard className="w-8 h-8" />
                </div>
                <div>
                    <h3 className="text-xl font-bold text-foreground">
                        Hola, {currentUser.email?.split('@')[0]}! ğŸ‘‹
                    </h3>
                    <p className="text-muted-foreground mt-2">
                        Ja tens accÃ©s complet a les eines d'auditoria avanÃ§ada. No cal que facis servir aquest formulari pÃºblic.
                    </p>
                </div>
                
                <Link href="/dashboard/new-audit">
                    <Button className="w-full h-12 text-lg font-bold rounded-xl gradient-bg text-white hover:opacity-90 shadow-lg">
                        Anar al Dashboard d'Auditoria <ArrowRight className="ml-2 w-5 h-5" />
                    </Button>
                </Link>
                
                <p className="text-xs text-muted-foreground">
                    El teu pla actual permet auditories ilÂ·limitades des del panell.
                </p>
            </div>
          ) : (
            // CAS 2: USUARI ANÃ’NIM -> Formulari PÃºblic
            <AuditForm />
          )}
        </motion.div>

      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/BenefitsSection.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { 
  Clock, 
  TrendingUp, 
  Zap, 
  Target, 
  Share2, 
  BrainCircuit 
} from 'lucide-react';

const BENEFITS = [
  {
    icon: Clock,
    title: 'Estalvi de temps',
    description: 'Automatitza tasques repetitives i allibera fins a 40 hores setmanals per centrar-te en el que realment importa.'
  },
  {
    icon: TrendingUp,
    title: 'Productivitat x3',
    description: "Incrementa l'eficiÃ¨ncia del teu equip amb processos intelÂ·ligents i fluxos de treball sense errors."
  },
  {
    icon: Zap,
    title: 'Respostes 24/7',
    description: 'Chatbots intelÂ·ligents que atenen els teus clients a qualsevol hora, sense descans i amb precisiÃ³.'
  },
  {
    icon: Target,
    title: 'AdaptaciÃ³ a mida',
    description: "No et donem una plantilla. La nostra IA s'entrena amb les dades especÃ­fiques del teu negoci."
  },
  {
    icon: Share2,
    title: 'MÃ rqueting Autopilot',
    description: 'GeneraciÃ³ i publicaciÃ³ de contingut a xarxes socials de forma autÃ²noma i estratÃ¨gica.'
  },
  {
    icon: BrainCircuit,
    title: 'Decisions amb Dades',
    description: 'AnalÃ­tica predictiva per anticipar-te a les tendÃ¨ncies del mercat i prendre millors decisions.'
  }
];

export function BenefitsSection() {
  return (
    <section id="beneficis" className="py-24 relative overflow-hidden">
      {/* Element decoratiu de fons */}
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-primary/5 rounded-full blur-3xl -z-10" />

      <div className="container mx-auto px-4">
        {/* CapÃ§alera de secciÃ³ */}
        <motion.div 
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true, margin: "-100px" }}
          className="text-center mb-16 max-w-3xl mx-auto"
        >
          <h2 className="text-4xl lg:text-5xl font-bold mb-6">
            Beneficis de la <span className="gradient-text">Nova Era</span>
          </h2>
          <p className="text-xl text-muted-foreground">
            La tecnologia no ha de ser complicada. Descobreix com simplifiquem el teu dia a dia.
          </p>
        </motion.div>
        
        {/* Graella de beneficis */}
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {BENEFITS.map((benefit, index) => (
            <motion.div
              key={index}
              initial={{ opacity: 0, y: 30 }}
              whileInView={{ opacity: 1, y: 0 }}
              viewport={{ once: true }}
              transition={{ delay: index * 0.1 }}
              whileHover={{ y: -5 }}
              className="solution-card-futuristic p-8 rounded-3xl flex flex-col items-center text-center group"
            >
              <div className="benefit-icon group-hover:scale-110 transition-transform duration-300">
                <benefit.icon className="h-8 w-8 text-white" />
              </div>
              <h3 className="text-xl font-bold mb-3">{benefit.title}</h3>
              <p className="text-muted-foreground leading-relaxed">
                {benefit.description}
              </p>
            </motion.div>
          ))}
        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/ContactSection.tsx ===================

'use client';

import { useActionState, useState } from 'react';
import { submitContactForm } from '@/actions/contact';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Checkbox } from '@/components/ui/checkbox';
import { Link } from '@/routing';
import { Loader2, Send, Bot, Code2, Rocket, Shield, Users } from 'lucide-react';
import { motion } from 'framer-motion';
import { useTranslations } from 'next-intl';

export function ContactSection() {
  const t = useTranslations('ContactSection');
  const [state, action, isPending] = useActionState(submitContactForm, { success: false });
  const [serviceType, setServiceType] = useState('ia'); // 'ia' o 'web'
  
  // Estat del checkbox
  const [termsAccepted, setTermsAccepted] = useState(false);

  return (
    <section id="contacte" className="py-24 bg-background relative overflow-hidden transition-colors duration-300">
      
      {/* Fons decoratiu */}
      <div className="absolute top-0 left-0 w-full h-full bg-linear-to-b from-transparent via-primary/5 to-transparent pointer-events-none" />

      <div className="container mx-auto px-4 grid lg:grid-cols-2 gap-16 items-start relative z-10">
        
        {/* COLUMNA ESQUERRA: Text i Punts */}
        <motion.div 
          initial={{ opacity: 0, x: -20 }} 
          whileInView={{ opacity: 1, x: 0 }} 
          viewport={{ once: true }}
          className="space-y-10"
        >
           <div>
             <h2 className="text-4xl lg:text-5xl font-bold mb-6 text-foreground leading-tight">
               {t('title_prefix')} <span className="gradient-text">{t('title_highlight')}</span>
             </h2>
             <p className="text-muted-foreground text-lg leading-relaxed max-w-lg">
               {t('description')}
             </p>
           </div>

           <div className="space-y-8">
              {[
                { icon: Rocket, title: t('features.agile.title'), desc: t('features.agile.desc') },
                { icon: Shield, title: t('features.tech.title'), desc: t('features.tech.desc') },
                { icon: Users, title: t('features.partners.title'), desc: t('features.partners.desc') }
              ].map((item, i) => (
                <div key={i} className="flex gap-5 items-start group">
                  <div className="mt-1 w-12 h-12 rounded-2xl bg-primary/10 border border-primary/20 flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform">
                    <item.icon className="w-6 h-6 text-primary" />
                  </div>
                  <div>
                    <h3 className="font-bold text-foreground text-xl mb-1">{item.title}</h3>
                    <p className="text-muted-foreground leading-relaxed">{item.desc}</p>
                  </div>
                </div>
              ))}
           </div>
        </motion.div>

        {/* COLUMNA DRETA: Formulari Adaptable */}
        <motion.div 
           initial={{ opacity: 0, x: 20 }} 
           whileInView={{ opacity: 1, x: 0 }} 
           viewport={{ once: true }}
           className="bg-card border border-border rounded-3xl p-8 lg:p-10 shadow-2xl relative overflow-hidden"
        >
          {/* Glow interior */}
          <div className="absolute top-0 right-0 w-64 h-64 bg-primary/10 blur-[80px] rounded-full pointer-events-none"></div>

          <form action={action} className="space-y-6 relative z-10">
            
            {/* SELECTOR TIPUS (TOGGLE) */}
            <div className="grid grid-cols-2 gap-4 mb-8">
               <button
                  type="button"
                  onClick={() => setServiceType('ia')}
                  className={`p-4 rounded-xl border transition-all flex flex-col items-center gap-3 ${
                    serviceType === 'ia' 
                      ? 'border-primary bg-primary/10 text-primary ring-1 ring-primary shadow-inner' 
                      : 'border-border bg-muted/30 text-muted-foreground hover:bg-muted/50 hover:border-primary/30'
                  }`}
               >
                  <Bot className="w-7 h-7" />
                  <span className="font-bold text-sm">{t('options.ia')}</span>
               </button>
               <button
                  type="button"
                  onClick={() => setServiceType('web')}
                  className={`p-4 rounded-xl border transition-all flex flex-col items-center gap-3 ${
                    serviceType === 'web' 
                      ? 'border-primary bg-primary/10 text-primary ring-1 ring-primary shadow-inner' 
                      : 'border-border bg-muted/30 text-muted-foreground hover:bg-muted/50 hover:border-primary/30'
                  }`}
               >
                  <Code2 className="w-7 h-7" />
                  <span className="font-bold text-sm">{t('options.web')}</span>
               </button>
               <input type="hidden" name="service" value={serviceType === 'ia' ? 'AutomatitzaciÃ³ i IA' : 'CreaciÃ³ Web'} />
            </div>

            {/* INPUTS */}
            <div className="space-y-5">
              <div className="space-y-2">
                <label className="text-sm font-bold text-foreground ml-1">{t('form.name_label')}</label>
                <Input 
                  name="fullName" 
                  placeholder={t('form.name_placeholder')} 
                  required 
                  className="bg-background border-input focus:border-primary h-12 text-foreground placeholder:text-muted-foreground/50" 
                />
              </div>
              
              <div className="space-y-2">
                 <label className="text-sm font-bold text-foreground ml-1">{t('form.email_label')}</label>
                 <Input 
                   name="email" 
                   type="email" 
                   placeholder={t('form.email_placeholder')} 
                   required 
                   className="bg-background border-input focus:border-primary h-12 text-foreground placeholder:text-muted-foreground/50" 
                 />
              </div>

              <div className="space-y-2">
                 <label className="text-sm font-bold text-foreground ml-1">{t('form.message_label')}</label>
                 <textarea 
                   name="message" 
                   rows={4} 
                   placeholder={t('form.message_placeholder')}
                   className="w-full rounded-lg border border-input bg-background px-4 py-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none placeholder:text-muted-foreground/50"
                 />
              </div>
            </div>

            {/* CHECKBOX LEGAL CONTROLAT */}
            <div className="flex items-start space-x-3 pt-2">
              <Checkbox 
                id="privacy-contact" 
                name="privacy" 
                value="on" 
                checked={termsAccepted}
                onCheckedChange={(checked) => setTermsAccepted(checked as boolean)}
                required 
                className="mt-1 border-muted-foreground/30 data-[state=checked]:bg-primary data-[state=checked]:border-primary" 
              />
              <label htmlFor="privacy-contact" className="text-sm text-muted-foreground leading-snug cursor-pointer select-none">
                {t.rich('privacy_text', {
                  link: (chunks) => <Link href="/legal/privacitat" target="_blank" className="underline hover:text-primary transition-colors">{chunks}</Link>
                })}
              </label>
            </div>

            {/* BOTÃ“ AMB ESTAT DISABLED I TOOLTIP */}
            <div className="relative group">
                <Button 
                  type="submit" 
                  // Desactivem si estÃ  enviant (isPending) O si NO ha acceptat termes
                  disabled={isPending || !termsAccepted} 
                  className={`w-full h-14 text-lg font-bold rounded-xl transition-all shadow-lg shadow-primary/25 flex items-center justify-center ${
                     termsAccepted 
                     ? 'gradient-bg text-white hover:opacity-90' 
                     : 'bg-muted text-muted-foreground cursor-not-allowed opacity-60'
                  }`}
                >
                  {isPending ? <Loader2 className="animate-spin mr-2" /> : <Send className="mr-2 w-5 h-5" />}
                  {t('form.submit_button')}
                </Button>
                
                {/* Tooltip flotant si intenten passar per sobre sense acceptar */}
                {!termsAccepted && (
                    <div className="absolute -top-10 left-1/2 -translate-x-1/2 bg-foreground text-background text-xs px-3 py-1.5 rounded-md shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap font-medium z-20">
                        {t('tooltip_privacy')}
                        <div className="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-foreground rotate-45"></div>
                    </div>
                )}
            </div>

            {state?.message && (
                <motion.div 
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    className={`text-center text-sm font-medium mt-4 p-3 rounded-lg border ${
                        state.success 
                        ? 'bg-green-500/10 border-green-500/20 text-green-600 dark:text-green-400' 
                        : 'bg-red-500/10 border-red-500/20 text-red-600 dark:text-red-400'
                    }`}
                >
                    {state.message}
                </motion.div>
            )}

          </form>
        </motion.div>

      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/diary/DiaryCard.tsx ===================

'use client';

import { useMotionValue, useTransform, motion, PanInfo, animate } from 'framer-motion';
import { useEffect, useState } from 'react';
import Image from 'next/image';
import { Cpu, ExternalLink, GripVertical, Heart } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Link } from '@/routing';
import { BlogPostDTO } from '@/types/models';

interface DiaryCardProps {
  post: BlogPostDTO;
  index: number; // L'Ã­ndex real (0, 1, 2, 3, 4...)
  isFront: boolean;
  totalCards: number;
  currentCardNumber: number;
  onRemove: () => void;
}

export function DiaryCard({ post, index, isFront, onRemove, currentCardNumber, totalCards }: DiaryCardProps) {
  const [exitX, setExitX] = useState<number | null>(null);

  const x = useMotionValue(0);
  const rotate = useTransform(x, [-200, 0, 200], [-10, 0, 10]);
  const opacity = useTransform(x, [-300, -100, 0, 100, 300], [0, 1, 1, 1, 0]);

  const deterministicExitX = post.title.length % 2 === 0 ? 500 : -500;

  // ğŸŒŸ FIX CLAU: Tot es basa en visualIndex, no en index real.
  // AixÃ­ les cartes 3, 4, 5... s'apilen exactament igual que la 2.
  const visualIndex = Math.min(index, 2);

  // Ara calculem la posiciÃ³ inicial usant visualIndex per evitar que surtin disparades
  const initialX = (index % 2 === 0 ? -1 : 1) * (20 + visualIndex * 10); // Molt mÃ©s subtil
  const initialY = visualIndex * 15; // Coincident amb la posiciÃ³ final
  const initialRotate = (index % 2 === 0 ? 2 : -2); // RotaciÃ³ subtil, no 15 graus

  useEffect(() => {
    if (isFront) {
      const controls = animate(x, [0, 25, 0], {
        delay: 1,
        duration: 0.6,
        ease: "backOut",
      });
      return () => controls.stop();
    }
  }, [isFront, x]);

  const handleDragEnd = (_: unknown, info: PanInfo) => {
    if (Math.abs(info.offset.x) > 100) {
      setExitX(info.offset.x > 0 ? 500 : -500);
      onRemove();
    }
  };

  return (
    <motion.div
      style={{
        x,
        rotate: isFront ? rotate : 0,
        zIndex: 100 - index,
        opacity: isFront ? opacity : 1
      }}
      // CORRECCIÃ“: Usem valors mÃ©s controlats per l'entrada
      initial={{
        x: initialX,
        y: initialY + 20, // Un petit offset per fer l'efecte de pujada
        opacity: 0,
        scale: 0.9
      }}
      whileInView={{
        x: 0,
        y: visualIndex * 15,
        scale: 1 - (visualIndex * 0.05),
        // NomÃ©s mostrem fins a la 3a carta (index 0, 1, 2). La resta opacitat 0.
        opacity: index > 2 ? 0 : 1,
        rotate: index % 2 === 0 ? 1 : -1,
        transition: { type: "spring", damping: 20, stiffness: 100, delay: Math.min(index, 3) * 0.1 }
      }}
      viewport={{ once: true }}
      exit={{
        x: exitX ?? deterministicExitX,
        opacity: 0,
        scale: 0.8,
        transition: { duration: 0.4 }
      }}
      drag={isFront ? "x" : false}
      dragConstraints={{ left: -1000, right: 1000 }}
      dragElastic={0.1}
      onDragEnd={handleDragEnd}
      whileTap={{ cursor: "grabbing", scale: 1.02 }}

      className={`
        absolute top-0 w-full h-[550px] md:h-[600px] 
        rounded-[2rem] border border-white/20 dark:border-white/10
        bg-card/95 backdrop-blur-xl shadow-2xl 
        overflow-hidden flex flex-col origin-bottom
        ${isFront ? 'cursor-grab hover:shadow-primary/20 hover:border-primary/40' : 'pointer-events-none brightness-95'}
        transition-colors duration-300
      `}
    >
      {/* ğŸ–¼ï¸ IMATGE */}
      <div className="h-[55%] relative bg-muted select-none pointer-events-none overflow-hidden">

        {/* ğŸ”´ INSÃGNIA DE VALORACIONS (AixÃ² faltava al teu codi) */}
        {/* ğŸ‘‡ 2. BADGE TECNOLÃ’GIC RENOVAT */}
        {(post.totalReactions || 0) > 0 && (
          <div className="absolute top-3 left-3 z-20 flex items-center gap-1.5 
                        bg-slate-900/80 backdrop-blur-md 
                        px-3 py-1 rounded-full 
                        text-cyan-400 text-xs font-bold font-mono
                        shadow-[0_0_15px_rgba(34,211,238,0.3)] 
                        border border-cyan-500/30 
                        animate-in fade-in zoom-in duration-300">

            {/* Icona Tech */}
            <Cpu className="w-3.5 h-3.5" />

            {/* Separador vertical petit */}
            <span className="h-3 w-px bg-cyan-500/30 mx-0.5"></span>

            {post.totalReactions}
          </div>
        )}

        {/* Data */}
        <div className="absolute top-4 right-4 z-20 bg-background/80 backdrop-blur text-foreground px-2.5 py-1 text-[10px] font-bold uppercase tracking-wider border border-border rounded-lg shadow-sm">
          {post.date ? new Date(post.date).toLocaleDateString() : 'AVUI'}
        </div>

        {post.coverImage ? (
          <Image
            src={post.coverImage}
            alt={post.title}
            fill
            className="object-cover transition-transform duration-700 hover:scale-105"
            draggable={false}
          />
        ) : (
          <div className="w-full h-full bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center">
            <span className="text-6xl font-black text-foreground/5 tracking-tighter">BLOG</span>
          </div>
        )}

        <div className="absolute inset-0 bg-gradient-to-t from-background via-transparent to-transparent opacity-80" />
      </div>

      {/* ğŸ“ CONTINGUT */}
      <div className="h-[45%] p-6 md:p-8 flex flex-col justify-between relative">
        <div className="space-y-3 relative z-10">
          <div className="flex justify-between items-start">
            <span className="inline-flex px-3 py-1 rounded-full bg-primary/10 text-primary text-[10px] font-extrabold uppercase tracking-widest border border-primary/20">
              {post.tags[0] || 'GENERAL'}
            </span>
            {isFront && <GripVertical className="text-muted-foreground/30 w-5 h-5 animate-pulse" />}
          </div>

          <h3 className="text-xl md:text-3xl font-bold text-foreground leading-tight line-clamp-2" title={post.title}>
            {post.title}
          </h3>

          <p className="text-muted-foreground text-xs md:text-sm line-clamp-2 leading-relaxed">
            {post.description}
          </p>
        </div>

        {/* BOTÃ“ */}
        <div className="pt-4 mt-auto">
          <Link href={`/blog/${post.slug}`} className="w-full block" onClick={(e) => e.stopPropagation()}>
            <Button
              className="w-full h-10 md:h-12 rounded-xl text-sm md:text-base font-bold shadow-lg bg-foreground text-background hover:bg-foreground/90 transition-all group relative overflow-hidden"
              tabIndex={isFront ? 0 : -1}
              disabled={!isFront}
            >
              <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000" />
              <span className="flex items-center gap-2">
                Llegir Article <ExternalLink className="w-4 h-4" />
              </span>
            </Button>
          </Link>

          <div className="flex justify-between items-center mt-3 px-1">
            <span className="text-[10px] text-muted-foreground uppercase tracking-widest font-mono">
              {currentCardNumber} / {totalCards}
            </span>
            <span className="text-[10px] md:text-xs text-muted-foreground italic">
              {isFront ? "Llisca per descartar" : "En cua..."}
            </span>
          </div>
        </div>
      </div>
    </motion.div>
  );
}

// =================== FILE: src/components/landing/diary/DiaryEmptyState.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { RotateCcw, ArrowRight } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Link } from '@/routing';

export function DiaryEmptyState({ onReset }: { onReset: () => void }) {
  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.9 }}
      animate={{ opacity: 1, scale: 1 }}
      className="absolute inset-0 flex flex-col items-center justify-center text-center p-8 bg-card/80 backdrop-blur-xl border border-border rounded-4xl shadow-2xl z-0"
    >
      <div className="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mb-6 animate-bounce">
        <span className="text-4xl">ğŸš€</span>
      </div>
      <h3 className="text-3xl font-bold text-foreground mb-3">EstÃ s al dia!</h3>
      <p className="text-muted-foreground mb-8 max-w-xs text-lg">
        Has vist els nostres articles destacats. Vols veure mÃ©s contingut?
      </p>
      <div className="flex flex-col sm:flex-row gap-4 w-full justify-center">
        <Button variant="outline" onClick={onReset} className="h-12 px-6 rounded-full border-2">
          <RotateCcw className="w-4 h-4 mr-2" /> Tornar a comenÃ§ar
        </Button>
        <Link href="/blog">
          <Button className="h-12 px-8 rounded-full shadow-lg shadow-primary/20">
            Veure Tot <ArrowRight className="w-4 h-4 ml-2" />
          </Button>
        </Link>
      </div>
    </motion.div>
  );
}

// =================== FILE: src/components/landing/diary/DiaryStack.tsx ===================

'use client';

import { useState } from 'react';
import { AnimatePresence } from 'framer-motion';
import { BlogPostDTO } from '@/types/models';
import { DiaryCard } from './DiaryCard';
import { DiaryEmptyState } from './DiaryEmptyState';

export function DiaryStack({ posts }: { posts: BlogPostDTO[] }) {
  const [currentIndex, setCurrentIndex] = useState(0);

  const removeCard = () => {
    setCurrentIndex((prev) => prev + 1);
  };

  const resetStack = () => setCurrentIndex(0);

  // Agafem els 4 segÃ¼ents per tenir buffer visual
  const visiblePosts = posts.slice(currentIndex, currentIndex + 4); 

  return (
    // overflow-visible Ã©s CRÃTIC perquÃ¨ les cartes puguin "volar" des de fora
    <div className="relative w-full h-[750px] flex items-center justify-center overflow-visible my-8">
      
   

      {/* CONTENIDOR DE LA PILA */}
      <div className="relative w-full max-w-lg h-[600px] z-10 perspective-1000">
        <AnimatePresence mode="popLayout">
          
          {currentIndex >= posts.length ? (
            <DiaryEmptyState key="empty" onReset={resetStack} />
          ) : (
            visiblePosts.map((post, i) => {
              const stackIndex = i; 
              
              return (
                <DiaryCard
                  key={post.slug}
                  post={post}
                  index={stackIndex}
                  isFront={stackIndex === 0}
                  totalCards={posts.length}
                  currentCardNumber={currentIndex + stackIndex + 1}
                  onRemove={removeCard}
                />
              );
            }).reverse() 
          )}
        </AnimatePresence>
      </div>
    </div>
  );
}

// =================== FILE: src/components/landing/HeroSection.tsx ===================

'use client';

import { useState, useRef, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { PlayCircle, Volume2, VolumeX, Pause, Play } from 'lucide-react';
import Image from 'next/image';
import Link from 'next/link';
// ğŸ‘‡ 1. IMPORTAR HOOK DE TRADUCCIÃ“
import { useTranslations } from 'next-intl';

export function HeroSection() {
  // ğŸ‘‡ 2. INICIALITZAR HOOK (Namespace 'Hero' del json)
  const t = useTranslations('Hero');
  const [showVideo, setShowVideo] = useState(true);
  const [isMuted, setIsMuted] = useState(true);
  const [isPlaying, setIsPlaying] = useState(true);
  const videoRef = useRef<HTMLVideoElement>(null);

  // Control de reproducciÃ³ en canviar de pestanya
  useEffect(() => {
    const videoElement = videoRef.current;
    if (!videoElement) return;

    const handleVisibilityChange = () => {
      if (document.hidden && !videoElement.paused) {
        videoElement.pause();
      } else if (!document.hidden && isPlaying) {
        videoElement.play();
      }
    };
    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
  }, [isPlaying]);

  const togglePlay = () => {
    if (!videoRef.current) return;
    if (videoRef.current.paused) {
      videoRef.current.play();
      setIsPlaying(true);
    } else {
      videoRef.current.pause();
      setIsPlaying(false);
    }
  }

  return (
    <section id="inici" className="pt-32 pb-20 min-h-screen flex items-center hero-pattern overflow-hidden relative">

      {/* Element de fons (opcional) */}
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-primary/5 rounded-full blur-[120px] -z-10" />

      <div className="container mx-auto px-4 grid lg:grid-cols-2 gap-16 items-center">

        {/* COLUMNA ESQUERRA: Text */}
        <motion.div
          initial={{ opacity: 0, x: -50 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.8 }}
        >


          {/* ğŸ‘‡ 3. SUBSTITUIR TEXT PLA PER CLAUS t('...') */}
          <h1 className="text-5xl lg:text-7xl font-bold mb-6 leading-tight">
            {t('title_start')} <span className="gradient-text">{t('title_highlight_1')}</span>.<br />
            {t('title_middle')} <span className="text-foreground">{t('title_highlight_2')}</span>.
          </h1>

          <p className="text-xl text-muted-foreground mb-8 leading-relaxed max-w-lg">
            {t('subtitle')}
          </p>
          <div className="flex flex-col sm:flex-row gap-4">
            <Link href="#contacte">
              <Button size="lg" className="...">
                {t('cta_primary')}
              </Button>
            </Link>
            <Link href="#audit">
              <Button variant="outline" size="lg" className="...">
                {t('cta_secondary')}
              </Button>
            </Link>
          </div>
        </motion.div>

        {/* COLUMNA DRETA: Marc del VÃ­deo */}
        <motion.div
          initial={{ opacity: 0, x: 50 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.8, delay: 0.2 }}
          className="relative"
        >
          {/* ğŸ› ï¸ FIX: Ãšs de variables semÃ ntiques (bg-card, border-border)
              AixÃ² farÃ  que agafi el color lila fosc del teu globals.css en Dark Mode
              i el color blanc en Light Mode automÃ ticament.
          */}
          <div className={`relative w-full aspect-video bg-card rounded-xl border border-border shadow-2xl overflow-hidden group transition-colors duration-300 ${!showVideo ? 'animate-floating' : ''}`}>

            {/* Barra superior estil navegador (Ara s'adapta al tema) */}
            <div className="h-8 border-b border-border bg-muted/50 flex items-center px-4 gap-2 z-20 relative transition-colors">
              <div className="w-2.5 h-2.5 rounded-full bg-red-500/50"></div>
              <div className="w-2.5 h-2.5 rounded-full bg-yellow-500/50"></div>
              <div className="w-2.5 h-2.5 rounded-full bg-green-500/50"></div>
              {/* URL Bar */}
              <div className="ml-4 px-3 py-0.5 rounded bg-background/50 text-[10px] text-muted-foreground font-mono border border-border hidden sm:block">
                digitai-studios.app
              </div>
            </div>

            {/* Contingut del VÃ­deo */}
            <div className="relative w-full h-[calc(100%-2rem)] bg-black"> {/* El fons del vÃ­deo sempre negre */}
              {showVideo ? (
                <div className="relative w-full h-full">
                  <video
                    ref={videoRef}
                    className="w-full h-full object-cover"
                    autoPlay
                    muted={isMuted}
                    loop
                    playsInline
                    // ğŸ‘‡ AixÃ² ens ajudarÃ  a saber si falla
                    onError={(e) => console.error("Error carregant vÃ­deo:", e)}
                  >
                    <source src="/videos/hero-video.mp4" type="video/mp4" />
                    {/* Fallback si el format falla */}
                    El teu navegador no suporta vÃ­deos.
                  </video>

                  {/* Controls Overlay */}
                  <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4 backdrop-blur-[2px]">
                    <button onClick={togglePlay} className="text-white hover:scale-110 transition-transform p-4 bg-white/10 rounded-full border border-white/20">
                      {isPlaying ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="currentColor" />}
                    </button>
                    <button onClick={() => setIsMuted(!isMuted)} className="absolute bottom-4 right-4 text-white p-2 bg-black/50 rounded-full hover:bg-black/70 transition-colors">
                      {isMuted ? <VolumeX size={20} /> : <Volume2 size={20} />}
                    </button>
                  </div>
                </div>
              ) : (
                <div className="relative w-full h-full cursor-pointer group-hover:opacity-90 transition-opacity" onClick={() => setShowVideo(true)}>
                  <Image
                    src="/images/hero.webp"
                    alt="Equip divers colÂ·laborant"
                    fill
                    className="object-cover"
                    priority
                  />
                  <div className="absolute inset-0 flex items-center justify-center bg-black/30">
                    <PlayCircle className="w-20 h-20 text-white/80 drop-shadow-lg" />
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Floating Cards (Decoratives) - Adaptades al tema */}
          <div className="absolute -bottom-6 -left-6 bg-card/90 backdrop-blur-md border border-border p-4 rounded-xl flex items-center gap-3 animate-pulse-glow shadow-xl z-30 transition-colors">
            <div className="relative">
              <div className="w-3 h-3 bg-green-500 rounded-full animate-ping absolute opacity-75"></div>
              <div className="w-3 h-3 bg-green-500 rounded-full relative"></div>
            </div>
            <div>
              <div className="text-[10px] text-muted-foreground uppercase font-bold tracking-wider">ESTAT</div>
              <span className="font-medium text-sm text-foreground">Sistemes Operatius</span>
            </div>
          </div>

        </motion.div>

      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/LatestPostsSection.tsx ===================

import { postService } from '@/services/container';
import { Link } from '@/routing';
import { ArrowRight, Sparkles } from 'lucide-react';
import { getTranslations } from 'next-intl/server';
import { DiaryStack } from './diary/DiaryStack';

export async function LatestPostsSection() {
  const posts = await postService.getLatestPosts();
  const latestPosts = posts.slice(0, 5); 
  const t = await getTranslations('LatestPosts');

  if (latestPosts.length === 0) return null;

  return (
    <section id="LatestPostsSection" className="py-24 bg-background relative overflow-hidden transition-colors duration-300">
      <div className="absolute top-1/2 left-0 -translate-y-1/2 w-[500px] h-[500px] bg-primary/10 blur-[100px] rounded-full pointer-events-none opacity-50" />
      <div className="absolute bottom-0 right-0 w-[400px] h-[400px] bg-blue-500/10 dark:bg-blue-500/20 blur-[120px] rounded-full pointer-events-none opacity-40" />
      <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] bg-[size:40px_40px] opacity-[0.03] dark:opacity-[0.05] pointer-events-none" />

      <div className="container mx-auto px-4 relative z-10">
        <div className="grid lg:grid-cols-2 gap-16 items-center">
          
          {/* TEXT */}
          <div className="text-left space-y-8">
            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/30 bg-primary/5 text-primary text-xs font-bold uppercase tracking-widest">
               <Sparkles className="w-3 h-3" />
               Diari de BitÃ cola
            </div>
            
            <h2 className="text-4xl md:text-6xl font-black text-foreground leading-tight tracking-tight">
              Pensaments <br />
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-primary to-blue-500">
                Digitals.
              </span>
            </h2>
            
            <p className="text-lg text-muted-foreground max-w-md leading-relaxed">
              Explora els nostres aprenentatges, tutorials tÃ¨cnics i reflexions sobre el futur de la tecnologia. Llisca les targetes per descobrir-ne mÃ©s.
            </p>

            <div className="flex items-center gap-4 pt-4">
               <div className="flex -space-x-4 rtl:space-x-reverse">
                  {[...Array(4)].map((_, i) => (
                     <div key={i} className="w-10 h-10 rounded-full border-2 border-background bg-muted flex items-center justify-center text-xs font-bold text-muted-foreground overflow-hidden relative">
                        <img src={`https://api.dicebear.com/7.x/notionists/svg?seed=${i}&backgroundColor=transparent`} alt="avatar" />
                     </div>
                  ))}
               </div>
               <div className="text-sm text-muted-foreground">
                  Llegit per <span className="font-bold text-foreground">2k+ developers</span>
               </div>
            </div>

            <div className="pt-8">
               <Link href="/blog" className="group inline-flex items-center gap-2 text-foreground font-bold hover:text-primary transition-colors border-b-2 border-transparent hover:border-primary pb-0.5">
                  Veure Ãndex Complet <ArrowRight className="w-4 h-4 transition-transform group-hover:translate-x-1" />
               </Link>
            </div>
          </div>

          {/* STACK */}
          <div className="relative">
             <div className="absolute inset-0 bg-gradient-to-tr from-primary/5 to-transparent rounded-full blur-3xl" />
             <DiaryStack posts={latestPosts} />
          </div>

        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/ProblemSolutionsSection.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { Calendar, BarChart3, Smartphone, X, Store, CheckCircle2 } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function ProblemSolutionSection() {
  const t = useTranslations('ProblemSolution');

  return (
    <section className="py-10 container mx-auto px-4 relative overflow-hidden transition-colors duration-300">
      
      <div className="grid lg:grid-cols-2 gap-16 items-center">
        
        {/* 1. TEXT NARRATIU */}
        <motion.div 
          initial={{ opacity: 0, x: -20 }}
          whileInView={{ opacity: 1, x: 0 }}
          viewport={{ once: true }}
        >
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold mb-6 uppercase tracking-wider">
             {t('badge')}
          </div>

          <h2 className="text-4xl lg:text-5xl font-bold mb-6 text-foreground leading-tight">
            {t('title_prefix')} <span className="gradient-text">{t('title_highlight')}</span>, <br />
            {t('title_suffix')}
          </h2>
          
          <p className="text-muted-foreground text-lg mb-8 leading-relaxed">
            {t('description_problem')}
            <br /><br />
            {t.rich('description_solution', {
              strong: (chunks) => <strong className="text-foreground font-semibold">{chunks}</strong>
            })}
          </p>

          <ul className="space-y-4 mb-8">
            {[
              t('benefits.appointments'),
              t('benefits.ecommerce'),
              t('benefits.pwa')
            ].map((item, i) => (
              <li key={i} className="flex items-center gap-3 text-slate-600 dark:text-slate-300 font-medium">
                <CheckCircle2 className="w-5 h-5 text-primary" /> {item}
              </li>
            ))}
          </ul>
        </motion.div>
        
        {/* 2. COMPARATIVA VISUAL */}
        <div className="relative h-[450px] lg:h-[500px] flex items-center justify-center perspective-1000">
          
          {/* --- CARD 1: EL PROBLEMA ("Web Aparador") --- */}
          <motion.div 
            // AnimaciÃ³ suau d'entrada
            initial={{ opacity: 0, rotate: -6, x: -20 }}
            whileInView={{ opacity: 1, rotate: -6, x: -35 }}
            viewport={{ once: true }}
            transition={{ duration: 0.8 }}
            // MIDES: 
            // - MÃ²bil: w-[260px] (lleugerament mÃ©s petit)
            // - Escriptori (md+): w-[280px] (Mida ORIGINAL)
            className="absolute left-4 md:left-0 w-[260px] md:w-[280px] p-6 rounded-2xl border border-slate-200 dark:border-white/5 bg-slate-100/80 dark:bg-[#0f111a]/80 backdrop-blur-sm z-0 grayscale opacity-70"
          >
             <div className="flex items-center gap-2 mb-4 text-slate-500">
                <Store className="w-5 h-5" />
                <span className="font-bold text-sm">{t('visual.problem_card.title')}</span>
             </div>
             <div className="space-y-3">
                <div className="flex items-center justify-between p-3 rounded bg-white dark:bg-white/5 border border-slate-200 dark:border-white/5 shadow-sm dark:shadow-none">
                   <span className="text-xs text-slate-500">{t('visual.problem_card.item1')}</span>
                   <X className="w-4 h-4 text-red-500" />
                </div>
                <div className="flex items-center justify-between p-3 rounded bg-white dark:bg-white/5 border border-slate-200 dark:border-white/5 shadow-sm dark:shadow-none">
                   <span className="text-xs text-slate-500">{t('visual.problem_card.item2')}</span>
                   <X className="w-4 h-4 text-red-500" />
                </div>
                <div className="flex items-center justify-between p-3 rounded bg-white dark:bg-white/5 border border-slate-200 dark:border-white/5 shadow-sm dark:shadow-none">
                   <span className="text-xs text-slate-500">{t('visual.problem_card.item3')}</span>
                   <X className="w-4 h-4 text-red-500" />
                </div>
             </div>
          </motion.div>

          {/* --- CARD 2: LA SOLUCIÃ“ (Ecosistema DigitAI) --- */}
          <motion.div
            // ANIMACIÃ“: Surt de darrere de l'altra targeta
            initial={{ opacity: 0, scale: 0.9, x: -40, rotate: -3 }}
            whileInView={{ opacity: 1, scale: 1, x: 20, rotate: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.8, delay: 0.2, type: "spring", bounce: 0.4 }}
            
            // MIDES:
            // - MÃ²bil: w-[300px] (Ajustat per pantalles petites)
            // - Escriptori (md+): w-[340px] (Mida ORIGINAL)
            className="relative z-20 w-[300px] md:w-[340px] bg-[#1a1d2d] border border-white/10 rounded-2xl shadow-2xl overflow-hidden"
          >
            <div className="h-2 w-full bg-linear-to-r from-[#06b6d4] via-[#3b82f6] to-[#a855f7]"></div>

            <div className="p-6">
              <h3 className="text-lg font-bold text-white mb-1">{t('visual.solution_card.title')}</h3>
              <p className="text-xs text-slate-400 mb-6">{t('visual.solution_card.subtitle')}</p>

              <div className="space-y-4">

                <div className="flex items-center gap-4 p-3 rounded-xl bg-primary/10 border border-primary/20">
                  <div className="p-2 bg-primary/20 rounded-lg text-primary">
                    <Calendar className="w-5 h-5" />
                  </div>
                  <div>
                    <div className="text-sm font-bold text-white">{t('visual.solution_card.widget1_title')}</div>
                    <div className="text-xs text-slate-400">{t('visual.solution_card.widget1_desc')}</div>
                  </div>
                </div>

                <div className="flex items-center gap-4 p-3 rounded-xl bg-blue-500/10 border border-blue-500/20">
                  <div className="p-2 bg-blue-500/20 rounded-lg text-blue-400">
                    <BarChart3 className="w-5 h-5" />
                  </div>
                  <div>
                    <div className="text-sm font-bold text-white">{t('visual.solution_card.widget2_title')}</div>
                    <div className="text-xs text-slate-400">{t('visual.solution_card.widget2_desc')}</div>
                  </div>
                </div>

                <div className="flex items-center gap-4 p-3 rounded-xl bg-cyan-500/10 border border-cyan-500/20">
                  <div className="p-2 bg-cyan-500/20 rounded-lg text-cyan-400">
                    <Smartphone className="w-5 h-5" />
                  </div>
                  <div>
                    <div className="text-sm font-bold text-white">{t('visual.solution_card.widget3_title')}</div>
                    <div className="text-xs text-slate-400">{t('visual.solution_card.widget3_desc')}</div>
                  </div>
                </div>

              </div>
            </div>

            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-linear-to-b from-primary/5 to-transparent pointer-events-none" />
          </motion.div>
        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/ProductTeaser.tsx ===================

'use client';

import { ArrowRight, ExternalLink } from 'lucide-react';
import Link from 'next/link';
import Image from 'next/image';
import { motion } from 'framer-motion';
import { useTranslations } from 'next-intl';

// âœ… IMPORTACIÃ“ ESTÃ€TICA
import ribotFlowImg from '@/assets/images/ribotflow.png';
import salutFlowImg from '@/assets/images/salutflow.png';

export function ProductTeaser() {
    const t = useTranslations('ProductTeaser');

    return (
        <section className="py-24 container mx-auto px-4">

            <div className="rounded-3xl bg-linear-to-br from-slate-50 via-white to-blue-50 dark:from-primary/10 dark:via-background dark:to-background border border-slate-200 dark:border-primary/20 p-8 md:p-12 overflow-hidden relative transition-colors duration-300 shadow-2xl shadow-slate-200/50 dark:shadow-none">

                <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-400/20 dark:bg-primary/20 blur-[100px] rounded-full opacity-40 pointer-events-none"></div>

                <div className="grid lg:grid-cols-2 gap-16 items-center relative z-10">

                    {/* TEXT CONTENT */}
                    <div>
                        <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-100 dark:bg-primary/10 border border-blue-200 dark:border-primary/20 text-blue-700 dark:text-primary text-xs font-bold mb-6">
                            ğŸš€ {t('badge')}
                        </div>

                        <h2 className="text-3xl md:text-5xl font-bold text-foreground mb-6 leading-tight">
                            {t('title_prefix')} <br />
                            <span className="gradient-text">{t('title_highlight')}</span>
                        </h2>

                        <p className="text-slate-600 dark:text-slate-400 text-lg mb-8 leading-relaxed">
                            {t.rich('description', {
                                // 1. GESTIÃ“ DE NEGRETA
                                strong: (chunks) => <strong>{chunks}</strong>,
                                // 2. GESTIÃ“ DEL SALT DE LÃNIA (Assumint que el JSON usa <br />)
                                br: (chunks) => <br />
                            })}
                        </p>

                        <Link href="/projectes" className="inline-flex items-center font-bold text-foreground hover:text-primary transition-colors group">
                            {t('cta')}
                            <ArrowRight className="ml-2 w-4 h-4 group-hover:translate-x-1 transition-transform" />
                        </Link>
                    </div>

                    {/* MOCKUP VISUAL - (Sense canvis) */}
                    <div className="relative h-[400px] w-full flex items-center justify-center perspective-1000">

                        {/* CARD 1: RIBOTFLOW */}
                        <motion.div
                            initial={{ opacity: 0, x: -20, rotate: -5 }}
                            whileInView={{ opacity: 1, x: 0, rotate: -6 }}
                            viewport={{ once: true }}
                            className="absolute left-4 top-10 w-3/4 h-64 bg-white dark:bg-[#0f111a] rounded-xl border border-slate-200 dark:border-white/10 shadow-xl z-10 overflow-hidden"
                        >
                            <div className="h-12 border-b border-slate-100 dark:border-white/5 flex items-center justify-between px-4 bg-slate-50/50 dark:bg-white/5">
                                <div className="relative h-12 w-34">
                                    <Image
                                        src={ribotFlowImg}
                                        alt="RibotFlow Logo"
                                        fill
                                        className="object-contain object-left"
                                        placeholder="blur"
                                    />
                                </div>
                                <div className="flex gap-1.5">
                                    <div className="w-2 h-2 rounded-full bg-slate-300 dark:bg-white/20"></div>
                                    <div className="w-2 h-2 rounded-full bg-slate-300 dark:bg-white/20"></div>
                                </div>
                            </div>
                            <div className="p-4 space-y-3 opacity-50 grayscale hover:grayscale-0 transition-all duration-500">
                                <div className="flex gap-4">
                                    <div className="w-1/3 h-20 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10"></div>
                                    <div className="w-2/3 h-20 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10"></div>
                                </div>
                                <div className="h-16 w-full rounded-lg bg-slate-50 dark:bg-white/5"></div>
                            </div>
                        </motion.div>

                        {/* CARD 2: SALUTFLOW */}
                        <motion.div
                            initial={{ opacity: 0, x: 20, rotate: 5, y: 20 }}
                            whileInView={{ opacity: 1, x: 20, rotate: 3, y: 40 }}
                            viewport={{ once: true }}
                            transition={{ delay: 0.2 }}
                            className="absolute right-4 top-24 w-3/4 h-64 bg-white dark:bg-[#0f111a] rounded-xl border border-slate-200 dark:border-white/10 shadow-2xl z-20 overflow-hidden backdrop-blur-sm"
                        >
                            <div className="h-12 border-b border-slate-100 dark:border-white/5 flex items-center justify-between px-4 bg-slate-50/50 dark:bg-white/5">
                                <div className="relative h-22 w-48">
                                    <Image
                                        src={salutFlowImg}
                                        alt="SalutFlow Logo"
                                        fill
                                        className="object-contain object-left"
                                        placeholder="blur"
                                    />
                                </div>
                                <ExternalLink className="w-4 h-4 text-slate-400" />
                            </div>
                            <div className="p-4 space-y-3">
                                <div className="flex justify-between items-center mb-2">
                                    <div className="h-4 w-1/3 bg-blue-100 dark:bg-primary/20 rounded"></div>
                                    <div className="h-8 w-8 rounded-full bg-slate-100 dark:bg-white/10"></div>
                                </div>
                                <div className="space-y-2">
                                    <div className="h-10 w-full rounded border-l-4 border-blue-500 bg-slate-50 dark:bg-white/5 flex items-center px-3">
                                        <div className="h-2 w-1/2 bg-slate-200 dark:bg-white/20 rounded"></div>
                                    </div>
                                    <div className="h-10 w-full rounded border-l-4 border-green-500 bg-slate-50 dark:bg-white/5 flex items-center px-3">
                                        <div className="h-2 w-2/3 bg-slate-200 dark:bg-white/20 rounded"></div>
                                    </div>
                                    <div className="h-10 w-full rounded border-l-4 border-purple-500 bg-slate-50 dark:bg-white/5 flex items-center px-3">
                                        <div className="h-2 w-1/3 bg-slate-200 dark:bg-white/20 rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </motion.div>
                    </div>
                </div>
            </div>
        </section>
    );
}

// =================== FILE: src/components/landing/services/mockups/AppMockup.tsx ===================

'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { useState, useEffect } from 'react';
import { Bell, Send, Download, CheckCircle2, MessageSquare } from 'lucide-react';

export function AppMockup() {
  const [step, setStep] = useState(0);

  // Cicle d'animaciÃ³: InstalÂ·laciÃ³ (3s) -> Xat (5s) -> Ãˆxit (3s)
  useEffect(() => {
    const times = [3000, 5000, 3000];
    let currentStep = 0;

    const cycle = () => {
      setTimeout(() => {
        currentStep = (currentStep + 1) % 3;
        setStep(currentStep);
        cycle();
      }, times[currentStep]);
    };

    cycle();
    return () => {}; // Cleanup si calguÃ©s
  }, []);

  return (
    <div className="grow relative flex justify-center mt-6 items-end h-[320px]">
      
      {/* ğŸ“± MARC DEL MÃ’BIL (MÃ©s gran: w-48) */}
      <div className="w-48 bg-slate-900 border-[6px] border-slate-800 rounded-[2.5rem] relative z-10 overflow-hidden shadow-2xl h-full flex flex-col">
        
        {/* Dynamic Island */}
        <div className="absolute top-2 left-1/2 -translate-x-1/2 w-16 h-5 bg-black rounded-full z-30 flex items-center justify-center gap-2">
            <div className="w-1.5 h-1.5 rounded-full bg-slate-800/50"></div>
            <div className="w-1.5 h-1.5 rounded-full bg-blue-500/50 animate-pulse"></div>
        </div>

        {/* Pantalla (Contingut Canviant) */}
        <div className="flex-1 bg-slate-50 dark:bg-[#0f111a] relative overflow-hidden flex flex-col">
            
            <AnimatePresence mode="wait">
                
                {/* --- FASE 1: INSTALÂ·LACIÃ“ PWA --- */}
                {step === 0 && (
                    <motion.div 
                        key="install"
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, y: -20 }}
                        className="h-full flex flex-col items-center justify-center p-4 text-center space-y-4"
                    >
                        <div className="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-2xl shadow-lg flex items-center justify-center mb-2">
                            <span className="text-2xl font-bold text-white">Go</span>
                        </div>
                        <div>
                            <h4 className="font-bold text-slate-800 dark:text-white text-sm">Gym App</h4>
                            <p className="text-[10px] text-slate-500">GestiÃ³ Esportiva</p>
                        </div>
                        
                        <motion.div 
                            initial={{ y: 20, opacity: 0 }}
                            animate={{ y: 0, opacity: 1 }}
                            transition={{ delay: 0.5 }}
                            className="w-full bg-blue-600 text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-blue-500/30 shadow-lg"
                        >
                            <Download className="w-3 h-3" /> InstalÂ·lar App
                        </motion.div>
                        
                        {/* Cursor simulat */}
                        <motion.div 
                            initial={{ x: 20, y: 20, opacity: 0 }}
                            animate={{ x: 0, y: -15, opacity: 1 }}
                            transition={{ delay: 1, duration: 0.8 }}
                            className="absolute pointer-events-none"
                        >
                            <div className="w-4 h-4 bg-slate-400/50 rounded-full border border-white shadow-sm"></div>
                        </motion.div>
                    </motion.div>
                )}

                {/* --- FASE 2: XAT INTERACTIU --- */}
                {step === 1 && (
                    <motion.div 
                        key="chat"
                        className="h-full flex flex-col"
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                    >
                        {/* Header Xat */}
                        <div className="h-14 bg-white dark:bg-slate-900 border-b border-slate-100 dark:border-slate-800 flex items-end pb-2 px-4 justify-between">
                            <div className="flex items-center gap-2">
                                <div className="w-6 h-6 rounded-full bg-cyan-100 flex items-center justify-center text-[10px]">ğŸ¤–</div>
                                <span className="text-xs font-bold">Assistent IA</span>
                            </div>
                        </div>

                        {/* Missatges */}
                        <div className="flex-1 p-3 space-y-3 overflow-hidden flex flex-col justify-end pb-12">
                            <motion.div 
                                initial={{ x: -20, opacity: 0 }}
                                animate={{ x: 0, opacity: 1 }}
                                className="bg-slate-200 dark:bg-slate-800 self-start rounded-2xl rounded-bl-none px-3 py-2 text-[10px] max-w-[85%]"
                            >
                                Hola! Vols reservar pista? ğŸ¾
                            </motion.div>

                            <motion.div 
                                initial={{ x: 20, opacity: 0 }}
                                animate={{ x: 0, opacity: 1 }}
                                transition={{ delay: 1 }}
                                className="bg-blue-600 text-white self-end rounded-2xl rounded-br-none px-3 py-2 text-[10px] max-w-[85%] shadow-md"
                            >
                                SÃ­, demÃ  a les 18h.
                            </motion.div>

                            <motion.div 
                                initial={{ x: -20, opacity: 0 }}
                                animate={{ x: 0, opacity: 1 }}
                                transition={{ delay: 2.5 }}
                                className="bg-slate-200 dark:bg-slate-800 self-start rounded-2xl rounded-bl-none px-3 py-2 text-[10px] max-w-[85%]"
                            >
                                <div className="flex gap-1">
                                    <span className="animate-bounce">.</span>
                                    <span className="animate-bounce delay-75">.</span>
                                    <span className="animate-bounce delay-150">.</span>
                                </div>
                            </motion.div>
                        </div>
                    </motion.div>
                )}

                {/* --- FASE 3: ÃˆXIT / CONFIRMACIÃ“ --- */}
                {step === 2 && (
                    <motion.div 
                        key="success"
                        initial={{ scale: 0.8, opacity: 0 }}
                        animate={{ scale: 1, opacity: 1 }}
                        className="h-full flex flex-col items-center justify-center bg-green-500 text-white p-6 text-center"
                    >
                        <motion.div 
                            initial={{ scale: 0 }}
                            animate={{ scale: 1 }}
                            transition={{ type: "spring" }}
                            className="w-16 h-16 bg-white text-green-500 rounded-full flex items-center justify-center mb-4 shadow-xl"
                        >
                            <CheckCircle2 className="w-8 h-8" strokeWidth={3} />
                        </motion.div>
                        <h4 className="font-bold text-lg mb-1">Reserva Confirmada!</h4>
                        <p className="text-xs opacity-90">T'hem enviat el tiquet al WhatsApp.</p>
                        
                        <div className="mt-6 bg-white/20 backdrop-blur-sm rounded-lg p-2 w-full flex items-center gap-2">
                            <MessageSquare className="w-4 h-4" />
                            <span className="text-[10px] font-mono">ID: #8392A</span>
                        </div>
                    </motion.div>
                )}

            </AnimatePresence>
        </div>

        {/* Navigation Bar (Fals) */}
        <div className="h-1 bg-black w-1/3 mx-auto rounded-full mb-2 opacity-50"></div>
      </div>

      {/* NOTIFICACIÃ“ FLOTANT (NomÃ©s en fase 2) */}
      <AnimatePresence>
        {step === 1 && (
            <motion.div 
                initial={{ x: 50, opacity: 0 }}
                animate={{ x: 0, opacity: 1 }}
                exit={{ x: 20, opacity: 0 }}
                className="absolute top-10 -right-12 bg-white dark:bg-slate-800 p-2 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 z-0 flex items-center gap-2"
            >
                <div className="bg-green-500 w-8 h-8 rounded-full flex items-center justify-center text-white">
                    <Send className="w-4 h-4" />
                </div>
                <div className="text-[10px] pr-2">
                    <div className="font-bold">WhatsApp API</div>
                    <div className="text-slate-500">Missatge enviat</div>
                </div>
            </motion.div>
        )}
      </AnimatePresence>

    </div>
  );
}

// =================== FILE: src/components/landing/services/mockups/AutomationFlow.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { MessageSquare, Zap, Database, Mail, Slack, BrainCircuit, CheckCircle2, LucideIcon } from 'lucide-react';

// 1. Definim els tipus per a les Props
interface NodeProps {
    icon: LucideIcon;
    color: 'blue' | 'purple' | 'indigo' | 'orange' | 'green';
    label: string;
    delay: number;
    cycle: number;
    pulse?: boolean;
    isFinal?: boolean;
}

export function AutomationFlow() {
  const cycle = 4; 

  return (
    // CONTENIDOR ADAPTABLE: 
    // Ajustem l'alÃ§ada: h-40 en mÃ²bil (mÃ©s baixet) i h-64 en escriptori.
    <div className="h-40 sm:h-56 md:h-64 w-full mt-4 relative bg-slate-50/80 dark:bg-[#0f111a] rounded-xl border border-slate-200 dark:border-white/10 overflow-hidden shadow-inner dark:shadow-2xl group flex items-center justify-center transition-colors duration-500">
      
      {/* FONS TÃˆCNIC (Grid adaptable) */}
      <div className="absolute inset-0 bg-[linear-gradient(to_right,#8080800a_1px,transparent_1px),linear-gradient(to_bottom,#8080800a_1px,transparent_1px)] bg-[size:24px_24px]"></div>
      <div className="absolute inset-0 bg-gradient-to-tr from-purple-500/0 via-transparent to-blue-500/0 dark:from-purple-500/5 dark:to-blue-500/5 pointer-events-none"></div>

      {/* ğŸ”´ TRUC MÃ€GIC RESPONSIVE: 
          Creem un contenidor de mida FIXA (500x200) que contÃ© tot el diagrama perfecte.
          DesprÃ©s, usem 'scale' per fer-lo petit en mÃ²bils sense trencar la posiciÃ³ dels elements.
      */}
      <div className="relative w-[500px] h-[200px] shrink-0 scale-[0.55] sm:scale-75 md:scale-90 lg:scale-100 transition-transform duration-500 origin-center flex items-center justify-center">

          {/* --- LAYER DE CONNEXIONS (SVG) --- */}
          {/* Ara l'SVG ocupa exactament l'espai del contenidor escalat */}
          <svg className="absolute inset-0 w-full h-full pointer-events-none overflow-visible z-0">
            <defs>
                <linearGradient id="flowGradient" x1="0" y1="0" x2="1" y2="0">
                    <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.5" />
                    <stop offset="100%" stopColor="#a855f7" stopOpacity="0.5" />
                </linearGradient>
            </defs>

            {/* LÃNIES ESTRUCTURALS ADAPTABLES */}
            <g className="stroke-slate-300 dark:stroke-slate-700 transition-colors duration-500">
                <path d="M 50 100 L 150 100" strokeWidth="2" /> {/* Start -> AI */}
                <path d="M 150 100 C 200 100, 200 50, 280 50" strokeWidth="2" fill="none" /> {/* AI -> Top */}
                <path d="M 150 100 C 200 100, 200 150, 280 150" strokeWidth="2" fill="none" /> {/* AI -> Bottom */}
                <path d="M 280 150 L 380 150" strokeWidth="2" /> {/* Slack -> Mail */}
            </g>

            {/* --- PARTÃCULES DE DADES --- */}
            
            {/* P1: Trigger -> AI */}
            <motion.circle r="4" fill="#3b82f6"
                animate={{ offsetDistance: ["0%", "100%"], opacity: [0, 1, 1, 0] }}
                transition={{ duration: cycle * 0.25, ease: "linear", repeat: Infinity, repeatDelay: cycle * 0.75 }}
                style={{ offsetPath: "path('M 50 100 L 150 100')" }}
            />

            {/* P2: AI -> Database */}
            <motion.circle r="4" fill="#a855f7"
                animate={{ offsetDistance: ["0%", "100%"], opacity: [0, 1, 1, 0] }}
                transition={{ duration: cycle * 0.25, ease: "linear", repeat: Infinity, delay: cycle * 0.25, repeatDelay: cycle * 0.75 }}
                style={{ offsetPath: "path('M 150 100 C 200 100, 200 50, 280 50')" }}
            />

            {/* P3: AI -> Slack */}
            <motion.circle r="4" fill="#a855f7"
                animate={{ offsetDistance: ["0%", "100%"], opacity: [0, 1, 1, 0] }}
                transition={{ duration: cycle * 0.25, ease: "linear", repeat: Infinity, delay: cycle * 0.25, repeatDelay: cycle * 0.75 }}
                style={{ offsetPath: "path('M 150 100 C 200 100, 200 150, 280 150')" }}
            />

            {/* P4: Slack -> Mail */}
            <motion.circle r="4" fill="#22c55e"
                animate={{ offsetDistance: ["0%", "100%"], opacity: [0, 1, 1, 0] }}
                transition={{ duration: cycle * 0.25, ease: "linear", repeat: Infinity, delay: cycle * 0.5, repeatDelay: cycle * 0.75 }}
                style={{ offsetPath: "path('M 280 150 L 380 150')" }}
            />
          </svg>


          {/* --- NODES (Posicionats en absolut dins del contenidor de 500x200) --- */}
          <div className="absolute inset-0">
            
            {/* NODE 1: TRIGGER (Webhook) */}
            <div className="absolute left-[30px] top-[80px]">
                <Node icon={MessageSquare} color="blue" label="Webhook" delay={0} cycle={cycle} />
            </div>

            {/* NODE 2: BRAIN (AI Processing) */}
            <div className="absolute left-[130px] top-[80px]">
                <Node icon={BrainCircuit} color="purple" label="AI Analyze" delay={cycle * 0.25} cycle={cycle} pulse />
            </div>

            {/* NODE 3: DATABASE (Storage) */}
            <div className="absolute left-[260px] top-[30px]">
                <Node icon={Database} color="indigo" label="Store Data" delay={cycle * 0.5} cycle={cycle} />
            </div>

            {/* NODE 4: SLACK (Notify Team) */}
            <div className="absolute left-[260px] top-[130px]">
                <Node icon={Slack} color="orange" label="Notify Team" delay={cycle * 0.5} cycle={cycle} />
            </div>

            {/* NODE 5: MAIL (Confirm Client) */}
            <div className="absolute left-[360px] top-[130px]">
                <Node icon={Mail} color="green" label="Send Email" delay={cycle * 0.75} cycle={cycle} isFinal />
            </div>

          </div>
      </div>
    </div>
  );
}

// --- COMPONENT AUXILIAR PER ALS NODES ---

function Node({ icon: Icon, color, label, delay, cycle, isFinal }: NodeProps) {
    const colors: Record<NodeProps['color'], string> = {
        blue:   "bg-white border-blue-200 text-blue-600 shadow-sm dark:bg-blue-950/50 dark:border-blue-500/50 dark:text-blue-400 dark:shadow-blue-500/20",
        purple: "bg-white border-purple-200 text-purple-600 shadow-sm dark:bg-purple-950/50 dark:border-purple-500/50 dark:text-purple-400 dark:shadow-purple-500/20",
        indigo: "bg-white border-indigo-200 text-indigo-600 shadow-sm dark:bg-indigo-950/50 dark:border-indigo-500/50 dark:text-indigo-400 dark:shadow-indigo-500/20",
        orange: "bg-white border-orange-200 text-orange-600 shadow-sm dark:bg-orange-950/50 dark:border-orange-500/50 dark:text-orange-400 dark:shadow-orange-500/20",
        green:  "bg-white border-emerald-200 text-emerald-600 shadow-sm dark:bg-emerald-950/50 dark:border-emerald-500/50 dark:text-emerald-400 dark:shadow-emerald-500/20",
    };

    return (
        <div className="flex flex-col items-center gap-2">
            <motion.div
                animate={{ 
                    scale: [1, 1.15, 1],
                    boxShadow: ["0 0 0px rgba(0,0,0,0)", "0 4px 12px rgba(0,0,0,0.1)", "0 0 0px rgba(0,0,0,0)"]
                }}
                transition={{ 
                    duration: 0.4, 
                    delay: delay, 
                    repeat: Infinity, 
                    repeatDelay: cycle - 0.4 
                }}
                className={`w-10 h-10 rounded-xl border flex items-center justify-center relative z-10 transition-colors duration-500 ${colors[color]}`}
            >
                <Icon className="w-5 h-5" />
                
                {/* Success Indicator */}
                {isFinal && (
                    <motion.div
                        animate={{ scale: [0, 1, 0] }}
                        transition={{ duration: 0.5, delay: delay + 0.2, repeat: Infinity, repeatDelay: cycle - 0.5 }}
                        className="absolute -top-2 -right-2 bg-green-500 text-white rounded-full p-0.5 border-2 border-white dark:border-slate-900 shadow-sm"
                    >
                        <CheckCircle2 className="w-3 h-3" />
                    </motion.div>
                )}
            </motion.div>

            <motion.span 
                animate={{ opacity: [0.6, 1, 0.6] }}
                transition={{ duration: 0.4, delay: delay, repeat: Infinity, repeatDelay: cycle - 0.4 }}
                className="text-[9px] font-mono font-bold uppercase tracking-wider px-1.5 py-0.5 rounded border transition-colors duration-500 whitespace-nowrap
                    text-slate-500 bg-slate-100 border-slate-200 
                    dark:text-slate-400 dark:bg-black/40 dark:border-white/5"
            >
                {label}
            </motion.span>
        </div>
    );
}

// =================== FILE: src/components/landing/services/mockups/TerminalMockup.tsx ===================

'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { useState, useEffect } from 'react';
import { Terminal, Play, CheckCircle2, Database, FileJson, FileCode, LucideIcon } from 'lucide-react';
import { cn } from '@/lib/utils';

// 1. DEFINIM EL TIPUS PER A UNA LÃNIA DE LOG
type LogEntry = {
  text: string;
  delay: number;
  color?: string;
};

// 2. DEFINIM EL TIPUS PER A UN ESCENARI
type ScenarioConfig = {
  id: string;
  label: string;
  icon: LucideIcon;
  color: string;
  borderColor: string;
  bgGlow: string;
  prompt: string;
  command: string;
  output: LogEntry[]; // Usem el tipus aquÃ­ tambÃ©
};

// --- CONFIGURACIÃ“ DELS ESCENARIS ---
// (Record<string, ScenarioConfig> assegura que l'objecte compleix el tipus)
const SCENARIOS: Record<string, ScenarioConfig> = {
  js: {
    id: 'js',
    label: 'Node.js',
    icon: FileJson,
    color: 'text-yellow-400',
    borderColor: 'border-yellow-500/50',
    bgGlow: 'bg-yellow-500/10',
    prompt: 'user@digitai:~/projects/api $',
    command: 'npm run deploy:production',
    output: [
      { text: '> building project...', delay: 500 },
      { text: '> optimizing chunks...', delay: 1200 },
      { text: 'âœ” Build completed in 840ms', color: 'text-green-400', delay: 2000 },
      { text: 'ğŸš€ Server running on port 3000', color: 'text-blue-400', delay: 2500 },
    ]
  },
  py: {
    id: 'py',
    label: 'Python',
    icon: FileCode,
    color: 'text-blue-400',
    borderColor: 'border-blue-500/50',
    bgGlow: 'bg-blue-500/10',
    prompt: '(env) main.py >',
    command: 'python3 train_model.py --epochs=10',
    output: [
      { text: 'TensorFlow: Loading GPU...', delay: 800 },
      { text: 'Epoch 1/10: loss: 0.4242 - acc: 0.8901', delay: 1600 },
      { text: 'Epoch 10/10: loss: 0.0123 - acc: 0.9998', delay: 2400 },
      { text: 'âœ¨ Model saved to /models/v1.h5', color: 'text-purple-400', delay: 3000 },
    ]
  },
  sql: {
    id: 'sql',
    label: 'SQL',
    icon: Database,
    color: 'text-pink-400',
    borderColor: 'border-pink-500/50',
    bgGlow: 'bg-pink-500/10',
    prompt: 'postgres@db:5432 #',
    command: 'SELECT * FROM leads WHERE status = "converted";',
    output: [
      { text: 'Querying table "leads"...', delay: 600 },
      { text: 'Index Scan using leads_pkey...', delay: 1400 },
      { text: '---------------------------------', delay: 1800 },
      { text: '(1,240 rows returned)', color: 'text-green-400', delay: 2200 },
    ]
  }
};

export function TerminalMockup() {
  const [activeTab, setActiveTab] = useState<string>('js');
  const [isTyping, setIsTyping] = useState(true);
  const [text, setText] = useState('');
  
  // 3. SOLUCIÃ“: SUBSTITUIM <any[]> PER <LogEntry[]>
  const [logs, setLogs] = useState<LogEntry[]>([]);
  
  const [completed, setCompleted] = useState(false);

  const scenario = SCENARIOS[activeTab];

  useEffect(() => {
    setText('');
    setLogs([]);
    setCompleted(false);
    setIsTyping(true);

    let currentText = '';
    const fullCommand = scenario.command;
    let charIndex = 0;

    const typeInterval = setInterval(() => {
      if (charIndex < fullCommand.length) {
        currentText += fullCommand.charAt(charIndex);
        setText(currentText);
        charIndex++;
      } else {
        clearInterval(typeInterval);
        setIsTyping(false);
        runExecution();
      }
    }, 50 + Math.random() * 50);

    return () => clearInterval(typeInterval);
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [activeTab]); // Afegim dependÃ¨ncia correcta

  const runExecution = () => {
    scenario.output.forEach((log, i) => {
      setTimeout(() => {
        // Ara TypeScript sap que 'log' Ã©s de tipus LogEntry
        setLogs(prev => [...prev, log]);
        if (i === scenario.output.length - 1) setCompleted(true);
      }, log.delay);
    });
  };

  return (
    <div className="w-full h-full p-4 md:p-6 flex items-center justify-center">
      
      <motion.div 
        layout
        className={cn(
            "w-full max-w-xl bg-[#09090b] rounded-xl border border-slate-800 shadow-2xl overflow-hidden flex flex-col relative transition-colors duration-500",
            "hover:shadow-primary/10 hover:border-slate-700"
        )}
      >
        <div className={`absolute inset-0 ${scenario.bgGlow} opacity-5 pointer-events-none transition-colors duration-700`}></div>

        {/* HEADER: TABS */}
        <div className="flex items-center bg-[#18181b] border-b border-slate-800 px-2 pt-2">
            <div className="flex gap-1.5 px-3 pb-2 mr-4">
                <div className="w-2.5 h-2.5 rounded-full bg-red-500/80"></div>
                <div className="w-2.5 h-2.5 rounded-full bg-yellow-500/80"></div>
                <div className="w-2.5 h-2.5 rounded-full bg-green-500/80"></div>
            </div>

            <div className="flex gap-1 overflow-x-auto scrollbar-hide">
                {Object.keys(SCENARIOS).map((key) => {
                    const tab = SCENARIOS[key];
                    return (
                        <button
                            key={key}
                            onClick={() => setActiveTab(key)}
                            className={cn(
                                "flex items-center gap-2 px-4 py-2 rounded-t-lg text-xs font-bold font-mono transition-all duration-300 relative",
                                activeTab === key 
                                    ? "bg-[#09090b] text-white border-t border-x border-slate-800" 
                                    : "text-slate-500 hover:text-slate-300 hover:bg-slate-800/50"
                            )}
                        >
                            {activeTab === key && (
                                <motion.div 
                                    layoutId="activeTabIndicator"
                                    className={`absolute top-0 left-0 right-0 h-0.5 ${tab.color.replace('text-', 'bg-')}`}
                                />
                            )}
                            <tab.icon className="w-3.5 h-3.5" />
                            {tab.label}
                        </button>
                    )
                })}
            </div>
            
            <div className="ml-auto px-3 pb-2 hidden sm:block">
                <div className={`w-6 h-6 rounded flex items-center justify-center transition-colors duration-300 ${completed ? 'text-green-500 bg-green-500/10' : 'text-slate-600'}`}>
                    {completed ? <CheckCircle2 className="w-3.5 h-3.5" /> : <Play className="w-3.5 h-3.5" />}
                </div>
            </div>
        </div>

        {/* CONSOLE BODY */}
        <div className="p-4 md:p-6 font-mono text-xs md:text-sm min-h-[220px] flex flex-col justify-end relative overflow-hidden">
            <div className="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:20px_20px]"></div>

            <div className="relative z-10 space-y-2">
                <div className="flex flex-wrap items-center gap-2 text-slate-300">
                    <span className={`font-bold ${scenario.color}`}>{scenario.prompt}</span>
                    <span className="text-white break-all">{text}</span>
                    {isTyping && (
                        <motion.span 
                            animate={{ opacity: [0, 1, 0] }}
                            transition={{ repeat: Infinity, duration: 0.8 }}
                            className="w-2 h-4 bg-slate-400 block"
                        />
                    )}
                </div>

                <div className="space-y-1 pl-2 border-l-2 border-slate-800">
                    <AnimatePresence mode='popLayout'>
                        {logs.map((log, i) => (
                            <motion.div 
                                key={i}
                                initial={{ opacity: 0, x: -10 }}
                                animate={{ opacity: 1, x: 0 }}
                                className={cn("flex items-center gap-2", log.color || "text-slate-400")}
                            >
                                <span>{log.text}</span>
                            </motion.div>
                        ))}
                    </AnimatePresence>
                </div>

                {!isTyping && completed && (
                    <motion.div 
                        initial={{ opacity: 0 }} 
                        animate={{ opacity: 1 }}
                        className="flex items-center gap-2 text-slate-300 mt-4"
                    >
                        <span className={`font-bold ${scenario.color}`}>{scenario.prompt}</span>
                        <motion.span 
                            animate={{ opacity: [0, 1, 0] }}
                            transition={{ repeat: Infinity, duration: 0.8 }}
                            className="w-2 h-4 bg-slate-400 block"
                        />
                    </motion.div>
                )}
            </div>
        </div>

        {/* STATUS BAR */}
        <div className="h-6 bg-[#18181b] border-t border-slate-800 flex items-center px-3 justify-between text-[10px] text-slate-500 font-mono">
            <div className="flex gap-4">
                <span>UTF-8</span>
                <span>Mem: {completed ? '42MB' : 'Processing...'}</span>
            </div>
            <div className="flex items-center gap-1.5">
                <Terminal className="w-3 h-3" />
                <span>bash</span>
            </div>
        </div>

      </motion.div>
    </div>
  );
}

// =================== FILE: src/components/landing/services/mockups/WebMockup.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { LayoutGrid, List, Search, MoreHorizontal, Plus, UserCircle } from 'lucide-react';

export function WebMockup() {
  return (
    // CONTENIDOR PRINCIPAL: Ocupa tot l'ample i s'enganxa a baix
    <div className="w-full mt-6 -mb-1 relative">
      
      {/* ğŸ–¥ï¸ FINESTRA NAVEGADOR (Full Width) */}
      <div className="w-full bg-slate-100 dark:bg-[#0b0d14] rounded-t-xl border-t border-x border-slate-200 dark:border-white/10 shadow-2xl overflow-hidden flex flex-col">
        
        {/* Browser Chrome (Barra Superior) */}
        <div className="h-9 bg-white dark:bg-[#151925] border-b border-slate-200 dark:border-white/5 flex items-center px-4 justify-between shrink-0">
          <div className="flex gap-1.5">
            <div className="w-2.5 h-2.5 rounded-full bg-red-400/80"></div>
            <div className="w-2.5 h-2.5 rounded-full bg-yellow-400/80"></div>
            <div className="w-2.5 h-2.5 rounded-full bg-green-400/80"></div>
          </div>
          
          {/* Fake URL Bar - Responsive */}
          <div className="hidden sm:flex flex-1 mx-4 h-6 bg-slate-100 dark:bg-white/5 rounded-md items-center px-3 max-w-sm border border-slate-200 dark:border-white/5">
            <div className="w-3 h-3 text-slate-400 mr-2"><Search className="w-3 h-3" /></div>
            <div className="h-1.5 w-24 bg-slate-300 dark:bg-white/10 rounded-full"></div>
          </div>

          <div className="flex items-center gap-2">
             <div className="h-2 w-8 bg-slate-200 dark:bg-white/10 rounded-full hidden sm:block"></div>
             <UserCircle className="w-5 h-5 text-slate-300 dark:text-slate-600" />
          </div>
        </div>

        {/* ğŸ§© UI DASHBOARD (App Layout) */}
        <div className="flex flex-1 min-h-[220px] bg-slate-50/50 dark:bg-transparent relative overflow-hidden">
            
            {/* Sidebar (Esquerra) */}
            <div className="w-14 border-r border-slate-200 dark:border-white/5 bg-white dark:bg-[#151925] flex flex-col items-center py-4 gap-4 z-10">
                <div className="p-2 bg-blue-600/10 text-blue-600 rounded-lg">
                    <LayoutGrid className="w-5 h-5" />
                </div>
                <div className="p-2 text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 rounded-lg transition-colors">
                    <List className="w-5 h-5" />
                </div>
                <div className="mt-auto p-2 bg-green-500 rounded-full text-white shadow-lg shadow-green-500/30">
                    <Plus className="w-4 h-4" />
                </div>
            </div>

            {/* Main Content (Grid Responsive) */}
            <div className="flex-1 p-4 md:p-6 overflow-hidden relative">
                
                {/* Header Content */}
                <div className="flex justify-between items-end mb-6">
                    <div>
                        <div className="h-2 w-16 bg-blue-500/20 rounded-full mb-2"></div>
                        <div className="h-5 w-32 bg-slate-800 dark:bg-white rounded-md"></div>
                    </div>
                    <div className="flex -space-x-2">
                        {[1,2,3].map(i => (
                            <div key={i} className="w-8 h-8 rounded-full border-2 border-white dark:border-[#0b0d14] bg-slate-200 dark:bg-slate-700"></div>
                        ))}
                    </div>
                </div>

                {/* KANBAN BOARD / GRID WIDGETS */}
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                    
                    {/* Column 1: To Do */}
                    <div className="space-y-3">
                        <div className="flex justify-between text-[10px] uppercase font-bold text-slate-400 mb-1">
                            <span>To Do</span>
                            <MoreHorizontal className="w-3 h-3" />
                        </div>
                        
                        {/* Task Card 1 */}
                        <motion.div 
                            initial={{ y: 20, opacity: 0 }}
                            whileInView={{ y: 0, opacity: 1 }}
                            transition={{ delay: 0.1 }}
                            className="bg-white dark:bg-[#1e2330] p-3 rounded-lg border border-slate-200 dark:border-white/5 shadow-sm hover:shadow-md hover:border-blue-500/30 transition-all cursor-default group"
                        >
                            <div className="flex gap-2 mb-2">
                                <span className="w-8 h-1.5 rounded-full bg-orange-400/20"></span>
                                <span className="w-4 h-1.5 rounded-full bg-blue-400/20"></span>
                            </div>
                            <div className="h-2 w-3/4 bg-slate-200 dark:bg-slate-600 rounded-full mb-1"></div>
                            <div className="h-2 w-1/2 bg-slate-200 dark:bg-slate-600 rounded-full"></div>
                            
                            {/* Hover Reveal Action */}
                            <div className="mt-3 flex justify-between items-center opacity-50 group-hover:opacity-100 transition-opacity">
                                <div className="w-4 h-4 rounded-full bg-slate-200 dark:bg-slate-700"></div>
                                <div className="text-[9px] text-slate-400">Dec 12</div>
                            </div>
                        </motion.div>

                        {/* Task Card 2 (Skeleton) */}
                        <div className="bg-slate-200/50 dark:bg-white/5 p-3 rounded-lg border border-transparent h-24 animate-pulse"></div>
                    </div>

                    {/* Column 2: In Progress (Mobile amagat si Ã©s molt estret, visible en tablet) */}
                    <div className="space-y-3">
                        <div className="flex justify-between text-[10px] uppercase font-bold text-slate-400 mb-1">
                            <span>In Progress</span>
                            <MoreHorizontal className="w-3 h-3" />
                        </div>

                        {/* Active Task Card */}
                        <motion.div 
                            initial={{ y: 20, opacity: 0 }}
                            whileInView={{ y: 0, opacity: 1 }}
                            transition={{ delay: 0.3 }}
                            className="bg-white dark:bg-[#1e2330] p-3 rounded-lg border-l-4 border-l-blue-500 border-y border-r border-slate-200 dark:border-r-white/5 dark:border-y-white/5 shadow-lg relative"
                        >
                            {/* Cursor Interactiu */}
                            <motion.div 
                                animate={{ x: [10, 40, 10], y: [10, 30, 10] }}
                                transition={{ duration: 4, repeat: Infinity, ease: "easeInOut" }}
                                className="absolute -right-2 -bottom-2 z-20 pointer-events-none drop-shadow-xl"
                            >
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5.65376 12.3673H5.46026L5.31717 12.4976L0.500002 16.8829L0.500002 1.19841L11.7841 12.3673H5.65376Z" fill="#3b82f6" stroke="white" />
                                </svg>
                                <div className="absolute top-4 left-2 bg-blue-600 text-white text-[9px] px-1.5 py-0.5 rounded shadow-sm">You</div>
                            </motion.div>

                            <div className="h-2 w-full bg-slate-800 dark:bg-slate-300 rounded-full mb-2"></div>
                            <div className="h-24 w-full bg-blue-50 dark:bg-blue-500/10 rounded border border-blue-100 dark:border-blue-500/20 mb-2 flex items-center justify-center">
                                <div className="text-[9px] text-blue-500 font-bold">LIVE PREVIEW</div>
                            </div>
                        </motion.div>
                    </div>

                    {/* Column 3: Done (NomÃ©s Desktop o Tablet gran) */}
                    <div className="hidden md:block space-y-3">
                        <div className="flex justify-between text-[10px] uppercase font-bold text-slate-400 mb-1">
                            <span>Done</span>
                            <div className="text-green-500 text-[10px]">98%</div>
                        </div>
                        
                        {[1, 2].map((i) => (
                            <motion.div 
                                key={i}
                                initial={{ opacity: 0, x: 10 }}
                                whileInView={{ opacity: 0.6, x: 0 }}
                                transition={{ delay: 0.4 + (i * 0.1) }}
                                className="bg-slate-50 dark:bg-white/5 p-3 rounded-lg border border-slate-100 dark:border-white/5 opacity-60 grayscale"
                            >
                                <div className="flex items-center gap-2 mb-2">
                                    <div className="w-3 h-3 rounded-full border border-slate-400 flex items-center justify-center">
                                        <div className="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                                    </div>
                                    <div className="h-1.5 w-20 bg-slate-300 dark:bg-slate-600 rounded-full"></div>
                                </div>
                            </motion.div>
                        ))}
                    </div>

                </div>
            </div>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/components/landing/services/ServiceCard.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { LucideIcon, ArrowUpRight } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ServiceCardProps {
  title: string;
  description: string;
  icon: LucideIcon;
  iconColorClass?: string; // Ex: "text-blue-600"
  wrapperClass?: string;   // Ex: "md:col-span-2"
  children?: React.ReactNode; // El Mockup visual
  cta?: string; // Text del botÃ³ opcional
  delay?: number;
}

export function ServiceCard({
  title,
  description,
  icon: Icon,
  iconColorClass = "text-primary",
  wrapperClass,
  children,
  cta,
  delay = 0
}: ServiceCardProps) {
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      whileInView={{ opacity: 1, y: 0 }}
      viewport={{ once: true }}
      transition={{ delay, duration: 0.5 }}
      className={cn(
        "group relative overflow-hidden rounded-2xl border border-border bg-card hover:border-primary/30 transition-all duration-500 flex flex-col",
        wrapperClass
      )}
    >
      <div className="p-6 flex-1 z-10 flex flex-col h-full">
        {/* Icona */}
        <div className={cn(
          "w-10 h-10 rounded-lg flex items-center justify-center mb-4 border transition-colors",
          "bg-muted/50 border-border group-hover:border-primary/20", 
          // AquÃ­ podrÃ­em fer servir classes dinÃ miques de Tailwind si calguÃ©s, 
          // perÃ² el bg-muted/50 Ã©s mÃ©s net per defecte.
        )}>
          <Icon className={cn("w-5 h-5", iconColorClass)} />
        </div>

        {/* Textos */}
        <h3 className="text-xl font-bold text-foreground mb-2">{title}</h3>
        <p className="text-sm text-muted-foreground leading-relaxed mb-4 flex-grow">
          {description}
        </p>

        {/* CTA Opcional */}
        {cta && (
          <button className={cn(
            "text-xs font-bold flex items-center gap-1 hover:gap-2 transition-all mt-auto",
            iconColorClass
          )}>
            {cta} <ArrowUpRight className="w-3 h-3" />
          </button>
        )}
      </div>

      {/* Ã€rea del Mockup Visual */}
      {children && (
        <div className="relative w-full mt-auto">
           {children}
        </div>
      )}
    </motion.div>
  );
}

// =================== FILE: src/components/landing/ServicesGrid.tsx ===================

'use client';

import { useTranslations } from 'next-intl';
import { Globe, Smartphone, BrainCircuit, Users } from 'lucide-react';
import { ServiceCard } from './services/ServiceCard'; // Importa els nous components
import { WebMockup } from './services/mockups/WebMockup';
import { AppMockup } from './services/mockups/AppMockup';
import { AutomationFlow } from './services/mockups/AutomationFlow';
import { TerminalMockup } from './services/mockups/TerminalMockup';

export function ServicesGrid() {
  const t = useTranslations('Services');

  return (
    <section id="serveis" className="bg-background relative overflow-hidden py-24 transition-colors duration-300">
      
      <div className="container mx-auto px-4">
        
        {/* CAPÃ‡ALERA */}
        <div className="text-center mb-16 max-w-3xl mx-auto">
           <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold mb-4 uppercase tracking-wider">
              {t('badge')}
           </div>
           <h2 className="text-4xl lg:text-5xl font-extrabold mb-6 text-foreground leading-tight tracking-tight">
             {t('title_prefix')} <span className="gradient-text">{t('title_highlight')}</span>
           </h2>
           <p className="text-lg text-muted-foreground max-w-2xl mx-auto">
             {t('subtitle')}
           </p>
        </div>

        {/* BENTO GRID */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
           
           {/* 1. APPWEBS (Ample) */}
           <ServiceCard
             title={t('cards.appwebs.title')}
             description={t('cards.appwebs.description')}
             icon={Globe}
             iconColorClass="text-blue-500"
             wrapperClass="md:col-span-2 flex-row md:flex-row" // Flex row per posar text i imatge costat a costat
           >
             <WebMockup />
           </ServiceCard>

           {/* 2. APPS (Vertical) */}
           <ServiceCard
             title={t('cards.apps.title')}
             description={t('cards.apps.description')}
             icon={Smartphone}
             iconColorClass="text-cyan-500"
             delay={0.1}
           >
             <AppMockup />
           </ServiceCard>

           {/* 3. AUTOMATITZACIÃ“ (Vertical) */}
           <ServiceCard
             title={t('cards.automation.title')}
             description={t('cards.automation.description')}
             icon={BrainCircuit}
             iconColorClass="text-purple-500"
             delay={0.2}
           >
             <AutomationFlow />
           </ServiceCard>

           {/* 4. FORMACIÃ“ (Ample + CTA) */}
           <ServiceCard
             title={t('cards.training.title')}
             description={t('cards.training.description')}
             icon={Users}
             iconColorClass="text-green-500"
             wrapperClass="md:col-span-2 flex-col md:flex-row"
             cta={t('cards.training.cta')}
             delay={0.3}
           >
             <TerminalMockup />
           </ServiceCard>

        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/SocialSection.tsx ===================

'use client';

import { Facebook, Linkedin, Instagram } from 'lucide-react';
import { motion } from 'framer-motion';

const SOCIALS = [
  {
    name: 'LinkedIn',
    icon: Linkedin,
    href: 'https://www.linkedin.com/in/digitai-studios-105a0136a/',
    color: 'hover:text-[#0077b5]', // Color oficial LinkedIn
  },
  {
    name: 'Instagram',
    icon: Instagram,
    href: 'https://www.instagram.com/digitaistudios/',
    color: 'hover:text-[#E1306C]', // Color oficial Instagram
  },
  {
    name: 'Facebook',
    icon: Facebook,
    href: 'https://www.facebook.com/profile.php?id=61576974390567',
    color: 'hover:text-[#1877F2]', // Color oficial Facebook
  },
];

export function SocialSection() {
  return (
    <section className="py-12 bg-muted/30 border-y border-border/40">
      <div className="container mx-auto px-4 text-center">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true }}
        >
          <p className="text-sm font-semibold uppercase tracking-widest text-muted-foreground mb-6">
            Segueix la revoluciÃ³
          </p>
          
          <div className="flex justify-center items-center gap-8 md:gap-12">
            {SOCIALS.map((social) => (
              <a
                key={social.name}
                href={social.href}
                target="_blank"
                rel="noopener noreferrer"
                aria-label={`Segueix-nos a ${social.name}`}
                className={`transform transition-all duration-300 hover:scale-110 text-muted-foreground ${social.color}`}
              >
                <social.icon className="w-8 h-8 md:w-10 md:h-10" />
              </a>
            ))}
          </div>
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/solutions/data.ts ===================

import {
    CreditCard, CalendarCheck, BarChart4,
    Wifi, LucideIcon
} from 'lucide-react';

export interface SolutionItem {
    id: string;
    icon: LucideIcon;
    color: string;
    // Guardem les claus dels tags, no el text final
    tagKeys: string[]; 
}

export const SOLUTIONS: SolutionItem[] = [
    {
        id: 'iot',
        icon: Wifi,
        color: 'from-cyan-500 to-blue-500',
        tagKeys: ['qr', 'domotics', 'sensors', 'remote']
    },
    {
        id: 'finance',
        icon: CreditCard,
        color: 'from-green-500 to-emerald-600',
        tagKeys: ['stripe', 'invoicing', 'ocr', 'signature']
    },
    {
        id: 'booking',
        icon: CalendarCheck,
        color: 'from-purple-500 to-pink-500',
        tagKeys: ['engine', 'whatsapp', 'wallet', 'crm']
    },
    {
        id: 'growth',
        icon: BarChart4,
        color: 'from-orange-500 to-red-500',
        tagKeys: ['social', 'bi', 'kpis', 'leads']
    }
];

// =================== FILE: src/components/landing/solutions/MobileSolutionsDock.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { cn } from '@/lib/utils';
import { SolutionItem } from './data';

interface Props {
  solutions: SolutionItem[];
  activeTab: string;
  setActiveTab: (id: string) => void;
}

export function MobileSolutionsDock({ solutions, activeTab, setActiveTab }: Props) {
  return (
    <div className="lg:hidden w-full flex justify-center mt-6">
      <div className="flex items-center gap-2 p-2 bg-slate-900/80 dark:bg-black/80 backdrop-blur-xl border border-white/10 rounded-full shadow-2xl relative z-20">
        {solutions.map((item) => {
          const isActive = activeTab === item.id;

          return (
            <button
              key={item.id}
              onClick={() => setActiveTab(item.id)}
              className="relative flex flex-col items-center justify-center w-14 h-14 rounded-full transition-all duration-300"
            >
              {/* Fons actiu (PÃ­ndola brillant) */}
              {isActive && (
                <motion.div
                  layoutId="activeDock"
                  className={`absolute inset-0 rounded-full bg-linear-to-br ${item.color} opacity-20`}
                  transition={{ type: "spring", bounce: 0.2, duration: 0.6 }}
                />
              )}

              {/* Icona */}
              <div className={cn(
                "relative z-10 transition-all duration-300",
                isActive 
                  ? "text-white scale-110 drop-shadow-[0_0_8px_rgba(255,255,255,0.5)]" 
                  : "text-slate-400 hover:text-slate-200"
              )}>
                <item.icon className="w-6 h-6" />
              </div>

              {/* Punt indicador sota la icona */}
              {isActive && (
                <motion.div
                  layoutId="activeDot"
                  className={`absolute bottom-2 w-1 h-1 rounded-full bg-white shadow-[0_0_5px_white]`}
                />
              )}
            </button>
          );
        })}
      </div>
    </div>
  );
}

// =================== FILE: src/components/landing/solutions/mockups/MockupBooking.tsx ===================

'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { CalendarCheck, MessageSquare, Clock, ChevronRight, CheckCircle2, Loader2, User, Bot, Sparkles } from 'lucide-react';
import { useTranslations } from 'next-intl';
import { useState, useEffect } from 'react';

export function MockupBooking() {
  const t = useTranslations('Solutions.booking');
  const [step, setStep] = useState(0);

  useEffect(() => {
    const cycle = async () => {
      setStep(0);
      setTimeout(() => setStep(1), 1000); // Pas 1: SolÂ·licitud (Surt el xat en PC / Card en MÃ²bil)
      setTimeout(() => setStep(2), 3000); // Pas 2: Processant (IA en MÃ²bil / Res en PC encara)
      setTimeout(() => setStep(3), 5000); // Pas 3: Ãˆxit (Ticket en MÃ²bil / NotificaciÃ³ i Calendari en PC)
      setTimeout(() => setStep(0), 8000); // Reset
    };
    cycle();
    const interval = setInterval(cycle, 10000);
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="relative w-full h-full min-h-[300px] flex flex-col items-center justify-center p-6 overflow-visible">
       
       {/* Fons Ambient */}
       <div className="absolute top-0 left-0 w-64 h-64 bg-purple-500/20 rounded-full blur-[80px]" />
       <div className="absolute bottom-0 right-0 w-64 h-64 bg-pink-500/20 rounded-full blur-[80px]" />

       {/* =================================================================================
           ğŸ“± VERSIÃ“ MÃ’BIL: WIDGET D'ESTAT (El que t'ha agradat)
           md:hidden
       ================================================================================= */}
       <div className="md:hidden w-full max-w-[280px] h-[220px] flex flex-col items-center justify-center relative">
          <AnimatePresence mode="wait">
             
             {/* ESTAT 0: IDLE */}
             {step === 0 && (
                <motion.div
                   key="idle"
                   initial={{ scale: 0.8, opacity: 0 }}
                   animate={{ scale: 1, opacity: 1 }}
                   exit={{ scale: 0.8, opacity: 0 }}
                   className="flex flex-col items-center gap-3 text-center"
                >
                   <div className="w-16 h-16 bg-slate-800/50 backdrop-blur-md border border-white/10 rounded-full flex items-center justify-center shadow-lg relative">
                      <CalendarCheck className="w-8 h-8 text-slate-400" />
                      <div className="absolute top-0 right-0 w-4 h-4 bg-green-500 rounded-full animate-pulse" />
                   </div>
                   <p className="text-sm text-slate-400 font-medium">Waiting for requests...</p>
                </motion.div>
             )}

             {/* ESTAT 1: SOLÂ·LICITUD */}
             {step === 1 && (
                <motion.div
                   key="request"
                   initial={{ y: 20, opacity: 0 }}
                   animate={{ y: 0, opacity: 1 }}
                   exit={{ y: -20, opacity: 0 }}
                   className="w-full bg-slate-900 border border-slate-700 p-5 rounded-2xl shadow-xl"
                >
                   <div className="flex items-center gap-3 mb-3">
                      <div className="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
                         <User className="w-5 h-5 text-white" />
                      </div>
                      <div>
                         <div className="text-xs text-slate-400 uppercase font-bold">New Message</div>
                         <div className="text-sm font-bold text-white">Joan Garcia</div>
                      </div>
                   </div>
                   <div className="bg-slate-800/50 p-3 rounded-lg text-xs text-slate-200 italic">
                      "{t('chat_user_1')}"
                   </div>
                </motion.div>
             )}

             {/* ESTAT 2: IA */}
             {step === 2 && (
                <motion.div
                   key="ai"
                   initial={{ scale: 0.9, opacity: 0 }}
                   animate={{ scale: 1, opacity: 1 }}
                   exit={{ scale: 1.1, opacity: 0 }}
                   className="w-full bg-gradient-to-br from-purple-900 to-slate-900 border border-purple-500/30 p-5 rounded-2xl shadow-xl flex flex-col items-center text-center"
                >
                   <div className="relative mb-3">
                      <div className="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center z-10 relative">
                         <Bot className="w-6 h-6 text-white" />
                      </div>
                      <motion.div 
                        animate={{ rotate: 360 }}
                        transition={{ repeat: Infinity, duration: 3, ease: "linear" }}
                        className="absolute inset-[-4px] border-2 border-dashed border-purple-400/50 rounded-xl z-0"
                      />
                   </div>
                   <h4 className="text-white font-bold text-sm">DigitAI Agent</h4>
                   <p className="text-xs text-purple-300 mt-1">Finding best slot...</p>
                </motion.div>
             )}

             {/* ESTAT 3: ÃˆXIT */}
             {step === 3 && (
                <motion.div
                   key="done"
                   initial={{ y: 20, opacity: 0 }}
                   animate={{ y: 0, opacity: 1 }}
                   className="w-full bg-white dark:bg-slate-900 border border-green-500/50 p-0 rounded-2xl shadow-2xl overflow-hidden"
                >
                   <div className="bg-green-500 p-3 flex justify-between items-center">
                      <span className="text-xs font-black text-white uppercase tracking-wider flex items-center gap-2">
                         <CheckCircle2 className="w-4 h-4" /> Confirmed
                      </span>
                      <span className="text-[10px] text-green-100 bg-green-600 px-2 py-0.5 rounded-full">AUTO</span>
                   </div>
                   <div className="p-5 flex items-center gap-4">
                      <div className="flex flex-col items-center justify-center bg-slate-100 dark:bg-slate-800 rounded-lg w-14 h-14 border border-slate-200 dark:border-slate-700">
                         <span className="text-[10px] text-slate-400 uppercase font-bold">JAN</span>
                         <span className="text-2xl font-black text-slate-800 dark:text-white leading-none">15</span>
                      </div>
                      <div>
                         <div className="text-sm font-bold text-slate-800 dark:text-white">Joan Garcia</div>
                         <div className="text-xs text-slate-500 flex items-center gap-1 mt-1">
                            <Clock className="w-3 h-3" /> 10:00 AM
                         </div>
                      </div>
                   </div>
                </motion.div>
             )}

          </AnimatePresence>
       </div>

       {/* =================================================================================
           ğŸ’» VERSIÃ“ ESCRIPTORI: CALENDARI + XAT BUBBLE (Recuperat i arreglat)
           hidden md:flex
       ================================================================================= */}
       <div className="hidden md:flex relative w-full h-full items-center justify-center perspective-1000">
          
          {/* 1. Calendari Central */}
          <motion.div 
            initial={{ rotateX: 10, scale: 0.95 }}
            whileInView={{ rotateX: 0, scale: 1 }}
            transition={{ duration: 0.8 }}
            className="absolute w-[500px] h-[320px] bg-white/80 dark:bg-slate-900/90 backdrop-blur-xl border border-white/50 dark:border-white/10 rounded-2xl shadow-2xl p-6 flex flex-col z-0 overflow-hidden"
          >
             <div className="flex justify-between items-center mb-6">
                <div className="flex items-center gap-3">
                   <div className="p-2 bg-purple-500/10 rounded-lg">
                      <CalendarCheck className="w-6 h-6 text-purple-600 dark:text-purple-400" />
                   </div>
                   <div className="font-bold text-lg text-foreground">January 2025</div>
                </div>
                <div className="flex gap-1">
                   <div className="w-8 h-8 rounded-full border border-border flex items-center justify-center"><ChevronRight className="w-4 h-4 rotate-180" /></div>
                   <div className="w-8 h-8 rounded-full border border-border flex items-center justify-center"><ChevronRight className="w-4 h-4" /></div>
                </div>
             </div>

             <div className="grid grid-cols-7 gap-2 flex-1">
                {['M','T','W','T','F','S','S'].map((d, i) => (
                   <div key={`h-${i}`} className="text-center text-xs font-bold text-muted-foreground py-2">{d}</div>
                ))}
                {[...Array(31)].map((_, i) => {
                   const day = i + 1;
                   const isSelected = day === 15;
                   const isPast = day < 15;
                   
                   return (
                      <div key={`d-${day}`} className="relative group">
                         <div className={`
                            h-8 w-8 mx-auto rounded-full flex items-center justify-center text-xs font-medium transition-all
                            ${isSelected && step >= 3 ? 'bg-purple-600 text-white shadow-lg shadow-purple-500/30 scale-110' : 
                              isPast ? 'text-muted-foreground opacity-50' : 'text-foreground hover:bg-muted'}
                         `}>
                            {day}
                         </div>
                      </div>
                   )
                })}
             </div>
          </motion.div>

          {/* 2. Targeta NotificaciÃ³ (Dreta) - Surt al pas 3 */}
          <motion.div 
             initial={{ y: 20, opacity: 0, x: 50 }}
             animate={{ 
                y: step >= 3 ? 0 : 20, 
                opacity: step >= 3 ? 1 : 0,
                x: step >= 3 ? 0 : 50
             }}
             transition={{ type: "spring", stiffness: 50 }}
             className="absolute bottom-10 right-0 z-20 w-72 bg-slate-950/90 backdrop-blur-md border border-purple-500/30 rounded-xl p-4 shadow-[0_20px_50px_-10px_rgba(168,85,247,0.4)] flex items-start gap-4"
          >
             <div className="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center shrink-0 shadow-lg shadow-green-500/20">
                <CheckCircle2 className="w-6 h-6 text-white" />
             </div>
             <div>
                <div className="text-xs font-bold text-purple-400 uppercase tracking-wider mb-1">{t('new_booking')}</div>
                <div className="text-sm font-bold text-white">Joan Garcia</div>
                <div className="text-xs text-slate-400 flex items-center gap-1 mt-1">
                   <Clock className="w-3 h-3" /> Friday, 15th - 10:00 AM
                </div>
             </div>
          </motion.div>

          {/* 3. MISSATGE FLOTANT (Esquerra) - RESTAURAT âœ… */}
          {/* Apareix al pas 1 i es queda fins al final del cicle */}
          <motion.div
             initial={{ opacity: 0, scale: 0.8, x: -100, y: -20 }}
             animate={{ 
                opacity: step >= 1 ? 1 : 0, 
                scale: step >= 1 ? 1 : 0.8, 
                x: step >= 1 ? -140 : -100, 
                y: step >= 1 ? -30 : -20 
             }}
             transition={{ type: "spring", stiffness: 100, damping: 15 }}
             className="absolute left-1/2 bottom-1/2 z-30 bg-white dark:bg-slate-800 p-4 rounded-2xl rounded-br-none shadow-2xl border border-border max-w-[220px]"
          >
             <div className="flex items-center gap-2 mb-2 opacity-50">
                <MessageSquare className="w-3 h-3" /> <span className="text-[10px] uppercase font-bold">WhatsApp</span>
             </div>
             <p className="text-sm text-foreground italic">"{t('chat_user_1')}"</p>
          </motion.div>

       </div>

    </div>
  )
}

// =================== FILE: src/components/landing/solutions/mockups/MockupFinance.tsx ===================

'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { Wifi, TrendingUp, ArrowDownLeft, ArrowUpRight, CreditCard, Layers, DollarSign, Wallet, Bell } from 'lucide-react';
import { useTranslations } from 'next-intl';
import { useState, useEffect } from 'react';

export function MockupFinance() {
  const t = useTranslations('Solutions.finance');
  const graphPath = "M0 80 C 40 80, 50 110, 90 60 S 150 40, 200 20 S 260 50, 320 10";

  // Estat per l'animaciÃ³ del MÃ²bil
  const [step, setStep] = useState(0); 

  useEffect(() => {
    const cycle = async () => {
      setStep(0);
      setTimeout(() => setStep(1), 1000); // 1. NotificaciÃ³
      setTimeout(() => setStep(2), 3500); // 2. Expanded (Detall)
      setTimeout(() => setStep(3), 6500); // 3. Total Balance
      setTimeout(() => setStep(0), 10000); // Reset
    };
    cycle();
    const interval = setInterval(cycle, 11000);
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="relative w-full h-full min-h-[250px] flex flex-col items-center justify-center p-4 overflow-visible">
       
       <div className="absolute top-0 right-0 w-64 h-64 bg-emerald-500/10 rounded-full blur-[80px]" />
       <div className="absolute bottom-0 left-0 w-64 h-64 bg-blue-500/10 rounded-full blur-[80px]" />

       {/* =================================================================================
           ğŸ“± VERSIÃ“ MÃ’BIL: LIVE TRANSACTION (Compacte)
           (md:hidden)
       ================================================================================= */}
       <div className="md:hidden w-full max-w-[260px] flex flex-col items-center gap-4">
          <AnimatePresence mode="wait">
             
             {/* ESTAT 0: ICONA FLOTANT (Wallet) */}
             {step === 0 && (
                <motion.div
                   key="idle"
                   initial={{ scale: 0.8, opacity: 0 }}
                   animate={{ scale: 1, opacity: 1 }}
                   exit={{ scale: 0.5, opacity: 0 }}
                   className="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center border border-white/10 shadow-xl"
                >
                   <Wallet className="w-8 h-8 text-emerald-400" />
                </motion.div>
             )}

             {/* ESTAT 1: NOTIFICACIÃ“ REBUDA */}
             {step === 1 && (
                <motion.div
                   key="notification"
                   initial={{ y: -20, opacity: 0 }}
                   animate={{ y: 0, opacity: 1 }}
                   exit={{ y: 20, opacity: 0 }}
                   className="w-full bg-slate-900/90 backdrop-blur-md border border-white/10 p-3 rounded-2xl shadow-xl flex items-center gap-3"
                >
                   <div className="w-10 h-10 bg-emerald-500/20 rounded-full flex items-center justify-center text-emerald-400 shrink-0">
                      <DollarSign className="w-5 h-5" />
                   </div>
                   <div>
                      <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Pagament Rebut</div>
                      <div className="text-sm font-bold text-white">Stripe Inc.</div>
                   </div>
                   <div className="ml-auto text-emerald-400 font-mono font-bold">+$125</div>
                </motion.div>
             )}

             {/* ESTAT 2: DETALL EXPANDIT (Ticket) */}
             {step === 2 && (
                <motion.div
                   key="detail"
                   initial={{ scale: 0.9, opacity: 0 }}
                   animate={{ scale: 1, opacity: 1 }}
                   exit={{ scale: 1.1, opacity: 0 }}
                   className="w-full bg-gradient-to-b from-slate-800 to-slate-900 border border-white/10 p-5 rounded-2xl shadow-2xl"
                >
                   <div className="text-center mb-4">
                      <div className="text-3xl font-black text-white mb-1">$1,250.00</div>
                      <div className="text-xs text-emerald-400 font-bold bg-emerald-500/10 px-2 py-1 rounded-full inline-block">
                         Completed
                      </div>
                   </div>
                   
                   <div className="space-y-3">
                      <div className="flex justify-between text-xs border-b border-white/5 pb-2">
                         <span className="text-slate-400">Client</span>
                         <span className="text-white font-medium">Acme Corp</span>
                      </div>
                      <div className="flex justify-between text-xs border-b border-white/5 pb-2">
                         <span className="text-slate-400">MÃ¨tode</span>
                         <span className="text-white font-medium flex items-center gap-1">
                            <CreditCard className="w-3 h-3" /> â€¢â€¢â€¢â€¢ 4242
                         </span>
                      </div>
                      <div className="flex justify-between text-xs">
                         <span className="text-slate-400">Data</span>
                         <span className="text-white font-medium">15 Gen, 10:42</span>
                      </div>
                   </div>
                </motion.div>
             )}

             {/* ESTAT 3: BALANÃ‡ TOTAL (Dashboard Mini) */}
             {step === 3 && (
                <motion.div
                   key="balance"
                   initial={{ y: 20, opacity: 0 }}
                   animate={{ y: 0, opacity: 1 }}
                   className="w-full bg-black border border-slate-800 p-4 rounded-2xl shadow-xl flex items-center justify-between"
                >
                   <div>
                      <div className="text-[10px] text-slate-500 font-bold uppercase">{t('total_balance')}</div>
                      <div className="text-xl font-bold text-white">$24,500</div>
                   </div>
                   <div className="h-10 w-24">
                      {/* Mini Sparkline */}
                      <svg className="w-full h-full overflow-visible" viewBox="0 0 100 40">
                         <path d="M0 40 L20 30 L40 35 L60 10 L80 20 L100 5" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" />
                      </svg>
                   </div>
                </motion.div>
             )}

          </AnimatePresence>
       </div>

       {/* --- ESCRIPTORI (Mantiguda Igual) --- */}
       <div className="hidden md:flex relative w-full h-full items-center justify-center perspective-1000">
          <motion.div 
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.2, duration: 0.5 }}
            className="absolute w-[85%] h-[75%] top-[15%] bg-white/50 dark:bg-slate-900/80 backdrop-blur-xl border border-white/40 dark:border-white/10 rounded-3xl shadow-2xl p-6 flex flex-col justify-end z-0"
          >
             <div className="absolute top-6 left-6 right-6 flex justify-between items-center">
                <div>
                   <div className="text-[10px] text-muted-foreground font-bold uppercase tracking-wider">{t('total_balance')}</div>
                   <div className="text-3xl font-black text-foreground flex items-center gap-2">
                      $24,500
                      <span className="text-[10px] bg-green-500/20 text-green-600 px-2 py-0.5 rounded-full flex items-center">
                         <TrendingUp className="w-3 h-3 mr-1" /> +12%
                      </span>
                   </div>
                </div>
                <div className="w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center border border-border">
                   <Layers className="w-5 h-5 text-muted-foreground" />
                </div>
             </div>

             <div className="relative h-24 w-full mb-6 mt-16">
                <svg className="w-full h-full overflow-visible" preserveAspectRatio="none" viewBox="0 0 320 100">
                   <defs>
                      <linearGradient id="gradientGraph" x1="0" y1="0" x2="0" y2="1">
                         <stop offset="0%" stopColor="#10b981" stopOpacity="0.3" />
                         <stop offset="100%" stopColor="#10b981" stopOpacity="0" />
                      </linearGradient>
                   </defs>
                   <motion.path 
                      d={`${graphPath} V 120 H 0 Z`} 
                      fill="url(#gradientGraph)" 
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      transition={{ delay: 1, duration: 1 }}
                   />
                   <motion.path
                      d={graphPath}
                      fill="none"
                      stroke="#10b981"
                      strokeWidth="3"
                      strokeLinecap="round"
                      initial={{ pathLength: 0 }}
                      animate={{ pathLength: 1 }}
                      transition={{ duration: 2, ease: "easeInOut", delay: 0.5 }}
                   />
                </svg>
             </div>

             <div className="space-y-3">
                {[1, 2].map((i) => (
                   <div key={i} className="flex items-center justify-between p-3 rounded-xl bg-white/40 dark:bg-white/5 border border-white/20">
                      <div className="flex items-center gap-3">
                         <div className={`w-8 h-8 rounded-full flex items-center justify-center ${i === 1 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                            {i === 1 ? <ArrowDownLeft className="w-4 h-4" /> : <ArrowUpRight className="w-4 h-4" />}
                         </div>
                         <div className="flex flex-col">
                            <span className="text-xs font-bold text-foreground">{i === 1 ? 'Stripe Inc.' : 'AWS EMEA'}</span>
                         </div>
                      </div>
                      <span className={`text-xs font-bold ${i === 1 ? 'text-green-600' : 'text-foreground'}`}>
                         {i === 1 ? '+$1,250.00' : '-$64.00'}
                      </span>
                   </div>
                ))}
             </div>
          </motion.div>

          <motion.div 
            initial={{ y: 0, opacity: 0, rotateX: 10 }}
            animate={{ y: -40, opacity: 1, rotateX: 0 }}
            transition={{ type: "spring", stiffness: 60, damping: 20 }}
            whileHover={{ scale: 1.05, rotateY: 5, y: -50 }}
            className="absolute z-20 w-80 h-48 bg-gradient-to-br from-[#1a1a1a] via-[#0f0f0f] to-black rounded-2xl p-6 shadow-[0_20px_50px_-12px_rgba(0,0,0,0.5)] border border-slate-700/50 flex flex-col justify-between group overflow-hidden"
          >
             <div className="absolute inset-0 opacity-20 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] mix-blend-overlay"></div>
             
             <motion.div 
                animate={{ x: ['-200%', '200%'] }}
                transition={{ repeat: Infinity, duration: 4, ease: "linear", repeatDelay: 1 }}
                className="absolute top-0 bottom-0 w-32 bg-gradient-to-r from-transparent via-white/5 to-transparent skew-x-12 pointer-events-none"
             />

             <div className="flex justify-between items-start relative z-10">
                <div className="text-white/90 font-bold text-lg tracking-wider flex items-center gap-2">
                   <CreditCard className="w-5 h-5" /> DigitAI
                </div>
                <Wifi className="w-6 h-6 text-white/50 rotate-90" />
             </div>

             <div className="relative z-10">
                <div className="w-10 h-8 bg-gradient-to-br from-yellow-200 to-yellow-500 rounded-md mb-3 relative overflow-hidden shadow-inner border border-yellow-600/50">
                   <div className="absolute top-1/2 w-full h-px bg-yellow-700/50"></div>
                   <div className="absolute left-1/2 h-full w-px bg-yellow-700/50"></div>
                </div>
                <div className="text-white/90 font-mono text-lg tracking-widest shadow-black drop-shadow-md whitespace-nowrap">
                   â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 4242
                </div>
             </div>

             <div className="flex justify-between items-end relative z-10">
                <div className="flex flex-col">
                   <span className="text-[8px] text-white/50 uppercase tracking-wider">{t('card_holder')}</span>
                   <span className="text-xs text-white font-medium tracking-wide">J. DOE</span>
                </div>
                <div className="flex flex-col items-end">
                   <span className="text-[8px] text-white/50 uppercase tracking-wider">EXP</span>
                   <span className="text-xs text-white font-medium tracking-wide">09/29</span>
                </div>
             </div>
          </motion.div>
       </div>

    </div>
  )
}

// =================== FILE: src/components/landing/solutions/mockups/MockupGrowth.tsx ===================

'use client';
import { motion } from 'framer-motion';

export function MockupGrowth() {
   return (
      <div className="flex items-end justify-center gap-4 h-48 w-full px-10">
         {[40, 70, 50, 90, 65, 85].map((height, i) => (
            <motion.div
               key={i}
               initial={{ height: 0 }}
               animate={{ height: `${height}%` }}
               transition={{ delay: i * 0.1, duration: 0.5, type: "spring" }}
               className="w-12 bg-gradient-to-t from-orange-500 to-red-500 rounded-t-lg relative group shadow-lg"
            >
               <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-white dark:bg-slate-800 text-xs font-bold px-2 py-1 rounded shadow opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap border border-border">
                  {height}% ROI
               </div>
            </motion.div>
         ))}
         
         <svg className="absolute inset-0 w-full h-full pointer-events-none overflow-visible">
            <motion.path
               d="M 40 140 L 100 80 L 160 110 L 220 50 L 280 90 L 340 60"
               fill="none"
               stroke="#10b981"
               strokeWidth="4"
               strokeLinecap="round"
               initial={{ pathLength: 0 }}
               animate={{ pathLength: 1 }}
               transition={{ duration: 1.5, delay: 0.5 }}
               style={{ filter: 'drop-shadow(0 0 10px rgba(16, 185, 129, 0.5))' }}
            />
         </svg>
      </div>
   )
}

// =================== FILE: src/components/landing/solutions/mockups/MockupIoT.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { QrCode, Lock, Unlock, ScanLine } from 'lucide-react';
import { useState, useEffect } from 'react';

export function MockupIoT() {
  const [isOpen, setIsOpen] = useState(false);

  useEffect(() => {
    const cycle = async () => {
      setIsOpen(false);
      const openTimer = setTimeout(() => setIsOpen(true), 2000);
      const closeTimer = setTimeout(() => setIsOpen(false), 6000);
      return () => {
        clearTimeout(openTimer);
        clearTimeout(closeTimer);
      };
    };
    cycle();
    const interval = setInterval(cycle, 7000);
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="relative w-full h-full flex flex-col items-center justify-end overflow-hidden bg-slate-900/50 rounded-2xl">
       
       {/* --- FONS --- */}
       <div className="absolute inset-0 flex items-center justify-center">
          <div className="w-full h-full bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-blue-900/40 via-slate-900 to-slate-950 flex flex-col items-center justify-center perspective-500">
             {/* Text reduÃ¯t en mÃ²bil */}
             <div className="text-[60px] md:text-[100px] font-black text-white/5 tracking-tighter animate-pulse">
                OFFICE
             </div>
             <div className={`w-32 h-1 bg-cyan-500 shadow-[0_0_20px_cyan] transition-opacity duration-500 ${isOpen ? 'opacity-100' : 'opacity-20'}`} />
          </div>
       </div>

       {/* --- PORTES --- */}
       <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
          <div className="absolute top-[15%] w-[90%] h-3 md:h-4 bg-slate-700 rounded-full border-b border-slate-500 z-20 shadow-lg" />

          {/* Ajustem el desplaÃ§ament x segons la pantalla */}
          <motion.div
            animate={{ x: isOpen ? '-85%' : 0 }}
            transition={{ type: "spring", stiffness: 50, damping: 15 }}
            className="w-[35%] h-[60%] bg-blue-50/5 backdrop-blur-md border-l border-t border-b border-white/20 shadow-xl relative z-10 flex items-center justify-end"
          >
             <div className="w-1 h-12 md:h-16 bg-slate-400/50 rounded-full mr-2" />
             <div className="absolute top-0 right-0 w-full h-full bg-gradient-to-br from-white/10 to-transparent pointer-events-none" />
          </motion.div>

          <motion.div
            animate={{ x: isOpen ? '85%' : 0 }}
            transition={{ type: "spring", stiffness: 50, damping: 15 }}
            className="w-[35%] h-[60%] bg-blue-50/5 backdrop-blur-md border-r border-t border-b border-white/20 shadow-xl relative z-10 flex items-center justify-start"
          >
             <div className="w-1 h-12 md:h-16 bg-slate-400/50 rounded-full ml-2" />
             <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-bl from-white/10 to-transparent pointer-events-none" />
          </motion.div>
       </div>

       {/* --- LECTOR (MÃ©s petit en mÃ²bil) --- */}
       <div className="absolute right-[5%] top-[40%] w-6 h-10 md:w-10 md:h-16 bg-slate-800 rounded-md border border-slate-600 flex flex-col items-center justify-center shadow-lg z-0">
          <motion.div 
            animate={{ backgroundColor: isOpen ? '#22c55e' : '#ef4444' }}
            className="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full mb-1 shadow-[0_0_5px_currentColor]" 
          />
          <div className="w-3 h-4 md:w-4 md:h-6 bg-black/50 rounded-[2px]" />
       </div>

       {/* --- MÃ’BIL --- */}
       <motion.div 
         animate={{ 
            y: isOpen ? 100 : 0,
            opacity: isOpen ? 0 : 1,
            scale: isOpen ? 0.8 : 1
         }}
         transition={{ duration: 0.5 }}
         // Mida mÃ©s continguda en mÃ²bil
         className="absolute bottom-4 z-30"
       >
          <div className="relative w-24 h-40 md:w-32 md:h-56 bg-slate-900 rounded-[1.5rem] md:rounded-[2rem] border-4 border-slate-700 shadow-2xl flex flex-col items-center overflow-hidden">
             
             <div className="w-full h-full bg-slate-950 flex flex-col items-center justify-center relative">
                <div className="absolute top-4 text-[6px] md:text-[8px] text-slate-400 uppercase tracking-widest font-bold">DigitAI Access</div>

                <div className="bg-white p-1.5 md:p-2 rounded-lg relative overflow-hidden">
                   <QrCode className="w-12 h-12 md:w-16 md:h-16 text-black" />
                   <motion.div 
                      animate={{ top: ['0%', '100%', '0%'] }}
                      transition={{ repeat: Infinity, duration: 1.5, ease: "linear" }}
                      className="absolute left-0 w-full h-0.5 bg-green-500 shadow-[0_0_10px_#22c55e] opacity-80"
                   />
                </div>

                <div className="mt-2 md:mt-4 flex items-center gap-1 md:gap-2 px-2 md:px-3 py-1 rounded-full bg-slate-800 border border-slate-700">
                   <motion.div animate={{ opacity: [0.5, 1, 0.5] }} transition={{ repeat: Infinity, duration: 1 }}>
                      <ScanLine className="w-2.5 h-2.5 md:w-3 md:h-3 text-cyan-400" />
                   </motion.div>
                   <span className="text-[6px] md:text-[8px] font-mono text-cyan-400">CONNECTING...</span>
                </div>
             </div>

             <div className="absolute top-2 w-8 md:w-10 h-2 md:h-3 bg-black rounded-full z-40" />
          </div>
       </motion.div>

       {/* --- ESTAT --- */}
       <motion.div
          animate={{ opacity: isOpen ? 1 : 0, y: isOpen ? 0 : 10 }}
          className="absolute bottom-10 z-20 bg-green-500/20 backdrop-blur-md border border-green-500/50 text-green-400 px-3 py-1.5 md:px-4 md:py-2 rounded-full font-bold text-[10px] md:text-sm flex items-center gap-2 shadow-[0_0_20px_rgba(34,197,94,0.2)]"
       >
          <Unlock className="w-3 h-3 md:w-4 md:h-4" /> ACCÃ‰S AUTORITZAT
       </motion.div>

    </div>
  )
}

// =================== FILE: src/components/landing/solutions/SolutionsDisplay.tsx ===================

'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { SolutionItem } from './data';
import { MockupIoT } from './mockups/MockupIoT';
import { MockupFinance } from './mockups/MockupFinance';
import { MockupBooking } from './mockups/MockupBooking';
import { MockupGrowth } from './mockups/MockupGrowth';
import { useTranslations } from 'next-intl';
export function SolutionsDisplay({ solution }: { solution: SolutionItem }) {
  const t = useTranslations('Solutions');
  return (
    <div className="w-full h-full relative flex flex-col"> {/* Afegit flex flex-col */}
      <div className="absolute inset-0 bg-linear-to-br from-white/40 to-white/10 dark:from-slate-900/80 dark:to-slate-900/40 backdrop-blur-xl border border-white/20 dark:border-white/10 rounded-4xl shadow-2xl overflow-hidden">

        <AnimatePresence mode="wait">
          <motion.div
            key={solution.id}
            initial={{ opacity: 0, scale: 0.98 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 1.02 }}
            transition={{ duration: 0.3 }}
            className="w-full h-full p-6 md:p-12 flex flex-col"
          >
            {/* Header Text - MÃ©s compacte en mÃ²bil */}
            <div className="mb-4 md:mb-8 shrink-0">
              <h3 className="text-2xl md:text-3xl font-bold text-foreground mb-2 md:mb-4 flex items-center gap-2 md:gap-3">
                <solution.icon className={`w-6 h-6 md:w-8 md:h-8 text-transparent bg-clip-text bg-linear-to-r ${solution.color}`} />
                {t(`${solution.id}.title`)}
              </h3>
              <p className="text-sm md:text-lg text-muted-foreground leading-relaxed md:max-w-2xl line-clamp-3 md:line-clamp-none">
                {t(`${solution.id}.description`)}
              </p>
            </div>

            {/* Mockup Area - Ocupa l'espai restant */}
            <div className="flex-1 relative flex items-center justify-center bg-slate-50/50 dark:bg-black/20 rounded-2xl border border-dashed border-border/50 overflow-hidden min-h-0">
              <div className="w-full h-full relative scale-90 md:scale-100">
                {solution.id === 'iot' && <MockupIoT />}
                {solution.id === 'finance' && <MockupFinance />}
                {solution.id === 'booking' && <MockupBooking />}
                {solution.id === 'growth' && <MockupGrowth />}
              </div>
            </div>

            {/* Tags Footer - Amagats en mÃ²bil si no hi caben, o scrollable */}
            <div className="mt-4 md:mt-8 flex flex-wrap gap-2 ...">
              {/* 4. Mapegem els tags traduint cada clau */}
              {solution.tagKeys.map(tagKey => (
                <span key={tagKey} className="...">
                  {t(`tags.${tagKey}`)}
                </span>
              ))}
            </div>

          </motion.div>
        </AnimatePresence>

      </div>
    </div>
  );
}

// =================== FILE: src/components/landing/solutions/SolutionsNavigation.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { ArrowRight } from 'lucide-react';
import { cn } from '@/lib/utils';
import { SolutionItem } from './data';
// ğŸ‘‡ 1. Importem el hook de traducciÃ³
import { useTranslations } from 'next-intl';

interface Props {
  solutions: SolutionItem[];
  activeTab: string;
  setActiveTab: (id: string) => void;
}

export function SolutionsNavigation({ solutions, activeTab, setActiveTab }: Props) {
  // ğŸ‘‡ 2. Inicialitzem el hook amb el namespace 'SolutionsSection'
  const t = useTranslations('Solutions');

  return (
    <div className="hidden lg:flex col-span-4 flex-col gap-4">
      {solutions.map((item) => {
        const isActive = activeTab === item.id;
        
        return (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={cn(
              "relative group flex items-center gap-4 p-6 rounded-2xl text-left transition-all duration-300 border border-transparent outline-none focus:ring-2 focus:ring-primary/20",
              isActive 
                ? "bg-white dark:bg-slate-900 shadow-xl border-primary/20 scale-[1.02]" 
                : "hover:bg-white/50 dark:hover:bg-white/5 hover:border-border"
            )}
          >
            {isActive && (
              <motion.div
                layoutId="activeGlow"
                className={`absolute inset-0 rounded-2xl bg-linear-to-r ${item.color} opacity-5 dark:opacity-10`}
              />
            )}

            <div className={cn(
              "w-12 h-12 rounded-xl flex items-center justify-center transition-colors duration-300 shrink-0",
              isActive 
                ? `bg-linear-to-br ${item.color} text-white shadow-lg` 
                : "bg-muted text-muted-foreground group-hover:text-foreground"
            )}>
              <item.icon className="w-6 h-6" />
            </div>
            
            <div className="flex-1">
              <h3 className={cn("font-bold text-lg", isActive ? "text-foreground" : "text-muted-foreground group-hover:text-foreground")}>
                {/* ğŸ‘‡ 3. TraduÃ¯m el tÃ­tol dinÃ micament */}
                {t(`${item.id}.title`)}
              </h3>
              {isActive && (
                <motion.p 
                  initial={{ opacity: 0, height: 0 }}
                  animate={{ opacity: 1, height: 'auto' }}
                  className="text-xs text-muted-foreground mt-1"
                >
                  {/* ğŸ‘‡ 4. TraduÃ¯m i unim els tags utilitzant 'tagKeys' */}
                  {item.tagKeys.map(key => t(`tags.${key}`)).join(' â€¢ ')}
                </motion.p>
              )}
            </div>
            
            {isActive && (
                <ArrowRight className="w-5 h-5 text-primary animate-pulse shrink-0" />
            )}
          </button>
        );
      })}
    </div>
  );
}

// =================== FILE: src/components/landing/solutions/SolutionsShowcase.tsx ===================

'use client';

import { useState } from 'react';
import { SOLUTIONS } from './data';
import { SolutionsNavigation } from './SolutionsNavigation';
import { SolutionsDisplay } from './SolutionsDisplay';
// ğŸ‘‡ Importem el nou Dock
import { MobileSolutionsDock } from './MobileSolutionsDock';

export function SolutionsShowcase() {
  const [activeTab, setActiveTab] = useState(SOLUTIONS[0].id);
  const activeSolution = SOLUTIONS.find(s => s.id === activeTab)!;

  return (
    <section className="py-16 md:py-24 bg-slate-50 dark:bg-black/50 relative overflow-hidden transition-colors duration-500">
      
      {/* Fons Ambient */}
      <div className={`absolute inset-0 opacity-10 bg-linear-to-br ${activeSolution.color} blur-[150px] transition-all duration-700`} />

      <div className="container mx-auto px-4 relative z-10">
        
        <div className="text-center max-w-3xl mx-auto mb-8 md:mb-16">
          <h2 className="text-3xl md:text-5xl font-black text-foreground mb-4">
            MÃ©s enllÃ  d'una <span className="text-transparent bg-clip-text bg-linear-to-r from-primary to-purple-400">Simple Web</span>.
          </h2>
          <p className="text-lg md:text-xl text-muted-foreground">
            Creem ecosistemes digitals que connecten programari, maquinari i intelÂ·ligÃ¨ncia artificial.
          </p>
        </div>

        {/* --- ESTRUCTURA RESPONSIVE --- */}
        <div className="flex flex-col lg:grid lg:grid-cols-12 gap-8 items-stretch lg:h-[600px]">
          
          {/* 1. NAVEGACIÃ“ D'ESCRIPTORI (s'amaga en mÃ²bil) */}
          <SolutionsNavigation 
            solutions={SOLUTIONS} 
            activeTab={activeTab} 
            setActiveTab={setActiveTab} 
          />
          
          {/* 2. VISUALITZACIÃ“ (Ocupa tot en mÃ²bil, 8 columnes en PC) */}
          <div className="lg:col-span-8 flex flex-col h-[550px] md:h-auto">
             <SolutionsDisplay solution={activeSolution} />
             
             {/* 3. DOCK MÃ’BIL (S'amaga en escriptori) */}
             <MobileSolutionsDock 
                solutions={SOLUTIONS} 
                activeTab={activeTab} 
                setActiveTab={setActiveTab} 
             />
          </div>

        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/SolutionsShowcase.tsx ===================

'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  QrCode, 
  CreditCard, 
  CalendarCheck, 
  BarChart4, 
  Smartphone, 
  Wifi, 
  Zap, 
  Share2,
  Lock,
  ArrowRight
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils';

// --- DEFINICIÃ“ DELS MÃ’DULS ---
const SOLUTIONS = [
  {
    id: 'iot',
    title: 'Smart Spaces & IoT',
    icon: Wifi,
    description: 'Controla el mÃ³n fÃ­sic des del digital. Obre portes, encÃ©n llums i monitoritza espais.',
    tags: ['AccÃ©s QR', 'Shelly/DomÃ²tica', 'Sensors', 'Control Remot'],
    color: 'from-cyan-500 to-blue-500'
  },
  {
    id: 'finance',
    title: 'Finances Automatitzades',
    icon: CreditCard,
    description: 'Deixa que la IA gestioni els diners. FacturaciÃ³, cobraments i control de despeses sense errors.',
    tags: ['Stripe Payments', 'Auto-FacturaciÃ³', 'Rebuts OCR', 'Signatura Digital'],
    color: 'from-green-500 to-emerald-600'
  },
  {
    id: 'booking',
    title: 'GestiÃ³ de Clients & Cites',
    icon: CalendarCheck,
    description: 'La teva agenda s\'omple sola. Sistema de reserves, recordatoris i fidelitzaciÃ³.',
    tags: ['Booking Engine', 'Recordatoris WhatsApp', 'Digital Wallet', 'Chatbots IA'],
    color: 'from-purple-500 to-pink-500'
  },
  {
    id: 'growth',
    title: 'Growth & AnalÃ­tica',
    icon: BarChart4,
    description: 'Pren decisions basades en dades, no en intuÃ¯cions. MÃ rqueting automÃ tic i dashboards.',
    tags: ['Social Auto-Post', 'Business Intelligence', 'KPIs en viu', 'CRM'],
    color: 'from-orange-500 to-red-500'
  }
];

export function SolutionsShowcase() {
  const [activeTab, setActiveTab] = useState(SOLUTIONS[0].id);
  const activeSolution = SOLUTIONS.find(s => s.id === activeTab)!;

  return (
    <section className="py-24 bg-slate-50 dark:bg-black/50 relative overflow-hidden transition-colors duration-500">
      
      {/* Fons Ambient */}
      <div className={`absolute inset-0 opacity-10 bg-gradient-to-br ${activeSolution.color} blur-[150px] transition-all duration-700`} />

      <div className="container mx-auto px-4 relative z-10">
        
        <div className="text-center max-w-3xl mx-auto mb-16">
          <h2 className="text-4xl md:text-5xl font-black text-foreground mb-4">
            MÃ©s enllÃ  d'una <span className="text-transparent bg-clip-text bg-gradient-to-r from-primary to-purple-400">Simple Web</span>.
          </h2>
          <p className="text-xl text-muted-foreground">
            Creem ecosistemes digitals que connecten programari, maquinari i intelÂ·ligÃ¨ncia artificial.
          </p>
        </div>

        <div className="grid lg:grid-cols-12 gap-8 items-stretch h-full min-h-[600px]">
          
          {/* --- COLUMNA ESQUERRA: NAVEGACIÃ“ --- */}
          <div className="lg:col-span-4 flex flex-col gap-4">
            {SOLUTIONS.map((item) => (
              <button
                key={item.id}
                onClick={() => setActiveTab(item.id)}
                className={cn(
                  "relative group flex items-center gap-4 p-6 rounded-2xl text-left transition-all duration-300 border border-transparent",
                  activeTab === item.id 
                    ? "bg-white dark:bg-slate-900 shadow-xl border-primary/20 scale-[1.02]" 
                    : "hover:bg-white/50 dark:hover:bg-white/5 hover:border-border"
                )}
              >
                {/* Indicador actiu animat */}
                {activeTab === item.id && (
                  <motion.div
                    layoutId="activeGlow"
                    className={`absolute inset-0 rounded-2xl bg-gradient-to-r ${item.color} opacity-5 dark:opacity-10`}
                  />
                )}

                <div className={cn(
                  "w-12 h-12 rounded-xl flex items-center justify-center transition-colors duration-300",
                  activeTab === item.id 
                    ? `bg-gradient-to-br ${item.color} text-white shadow-lg` 
                    : "bg-muted text-muted-foreground group-hover:text-foreground"
                )}>
                  <item.icon className="w-6 h-6" />
                </div>
                
                <div className="flex-1">
                  <h3 className={cn("font-bold text-lg", activeTab === item.id ? "text-foreground" : "text-muted-foreground group-hover:text-foreground")}>
                    {item.title}
                  </h3>
                  {activeTab === item.id && (
                    <motion.p 
                      initial={{ opacity: 0, height: 0 }}
                      animate={{ opacity: 1, height: 'auto' }}
                      className="text-xs text-muted-foreground mt-1"
                    >
                      {item.tags.join(' â€¢ ')}
                    </motion.p>
                  )}
                </div>
                
                {activeTab === item.id && (
                    <ArrowRight className="w-5 h-5 text-primary animate-pulse" />
                )}
              </button>
            ))}
          </div>

          {/* --- COLUMNA DRETA: FINESTRA HOLOGRÃ€FICA --- */}
          <div className="lg:col-span-8 relative">
            <div className="absolute inset-0 bg-gradient-to-br from-white/40 to-white/10 dark:from-slate-900/80 dark:to-slate-900/40 backdrop-blur-xl border border-white/20 dark:border-white/10 rounded-[32px] shadow-2xl overflow-hidden">
              
              <AnimatePresence mode="wait">
                <motion.div
                  key={activeTab}
                  initial={{ opacity: 0, y: 20, scale: 0.95 }}
                  animate={{ opacity: 1, y: 0, scale: 1 }}
                  exit={{ opacity: 0, y: -20, scale: 1.05 }}
                  transition={{ duration: 0.4, ease: "easeOut" }}
                  className="w-full h-full p-8 md:p-12 flex flex-col"
                >
                  {/* Contingut Textual */}
                  <div className="mb-8">
                    <h3 className="text-3xl font-bold text-foreground mb-4 flex items-center gap-3">
                       <activeSolution.icon className={`w-8 h-8 text-transparent bg-clip-text bg-gradient-to-r ${activeSolution.color}`} /> 
                       {activeSolution.title}
                    </h3>
                    <p className="text-lg text-muted-foreground leading-relaxed max-w-2xl">
                      {activeSolution.description}
                    </p>
                  </div>

                  {/* VISUALITZACIÃ“ DINÃ€MICA (MOCKUPS) */}
                  <div className="flex-1 relative flex items-center justify-center bg-slate-50/50 dark:bg-black/20 rounded-2xl border border-dashed border-border/50 overflow-hidden">
                     {activeTab === 'iot' && <MockupIoT />}
                     {activeTab === 'finance' && <MockupFinance />}
                     {activeTab === 'booking' && <MockupBooking />}
                     {activeTab === 'growth' && <MockupGrowth />}
                  </div>

                  {/* Footer Tags */}
                  <div className="mt-8 flex flex-wrap gap-2">
                    {activeSolution.tags.map(tag => (
                      <span key={tag} className="px-3 py-1 rounded-full bg-background border border-border text-xs font-bold uppercase tracking-wider text-muted-foreground shadow-sm">
                        {tag}
                      </span>
                    ))}
                  </div>

                </motion.div>
              </AnimatePresence>

            </div>
          </div>

        </div>
      </div>
    </section>
  );
}

// ----------------------------------------------------------------------
// SUB-COMPONENTS VISUALS (MOCKUPS ANIMATS)
// ----------------------------------------------------------------------

function MockupIoT() {
  return (
    <div className="relative w-full h-full flex items-center justify-center p-10">
       {/* TELÃˆFON ESCANEJANT */}
       <motion.div 
         initial={{ y: 20, opacity: 0 }}
         animate={{ y: 0, opacity: 1 }}
         transition={{ delay: 0.2 }}
         className="absolute left-10 bottom-10 w-40 h-64 bg-slate-900 rounded-3xl border-4 border-slate-700 shadow-2xl flex flex-col items-center justify-center z-20"
       >
          <div className="w-20 h-20 bg-white rounded-lg p-2 mb-4">
             <QrCode className="w-full h-full text-black" />
          </div>
          <span className="text-xs text-green-400 font-mono animate-pulse">Scanning...</span>
       </motion.div>

       {/* ONES DE SENYAL */}
       <motion.div 
          animate={{ scale: [1, 2], opacity: [0.5, 0] }}
          transition={{ repeat: Infinity, duration: 2 }}
          className="absolute left-[110px] bottom-[150px] w-20 h-20 border-2 border-cyan-500 rounded-full z-10"
       />

       {/* PORTA INTELÂ·LIGENT / SHELLY */}
       <motion.div 
         initial={{ opacity: 0, x: 20 }}
         animate={{ opacity: 1, x: 0 }}
         className="w-64 h-80 bg-slate-100 dark:bg-slate-800 rounded-t-full border-8 border-slate-300 dark:border-slate-700 relative flex items-center justify-center shadow-inner"
       >
          <div className="absolute top-1/2 left-4 w-4 h-4 bg-red-500 rounded-full shadow-[0_0_10px_red]" />
          <motion.div 
             animate={{ rotateY: -100 }}
             transition={{ delay: 1.5, duration: 1, type: "spring" }}
             className="w-full h-full bg-white dark:bg-slate-600 rounded-t-full origin-left border-r border-slate-200 dark:border-slate-500 flex items-center justify-center"
          >
             <div className="w-4 h-4 bg-slate-400 rounded-full absolute right-4 top-1/2" />
             <div className="bg-green-500/20 text-green-600 px-4 py-2 rounded-lg font-bold border border-green-500 flex items-center gap-2">
                <Lock className="w-4 h-4" /> UNLOCKED
             </div>
          </motion.div>
       </motion.div>
    </div>
  )
}

function MockupFinance() {
  return (
    <div className="w-full max-w-md space-y-4">
       {/* TARGETA STRIPE */}
       <motion.div 
         initial={{ y: -50, opacity: 0 }}
         animate={{ y: 0, opacity: 1 }}
         className="bg-gradient-to-r from-slate-900 to-slate-800 text-white p-6 rounded-2xl shadow-xl border border-slate-700 relative overflow-hidden"
       >
          <div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full blur-3xl" />
          <div className="flex justify-between items-start mb-8">
             <div className="text-xl font-bold">Stripe</div>
             <Wifi className="w-6 h-6 rotate-90" />
          </div>
          <div className="text-lg font-mono tracking-widest mb-4">**** **** **** 4242</div>
          <div className="flex justify-between text-xs opacity-70">
             <span>Card Holder</span>
             <span>Expires</span>
          </div>
       </motion.div>

       {/* FLUX DE FACTURACIÃ“ */}
       <div className="flex gap-3">
          {[1, 2, 3].map((i) => (
             <motion.div
               key={i}
               initial={{ scale: 0, opacity: 0 }}
               animate={{ scale: 1, opacity: 1 }}
               transition={{ delay: i * 0.3 }}
               className="flex-1 bg-white dark:bg-slate-800 p-3 rounded-xl border border-border shadow-sm flex flex-col items-center gap-2"
             >
                <div className="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600">â‚¬</div>
                <div className="h-2 w-12 bg-slate-200 dark:bg-slate-700 rounded-full" />
                <div className="h-2 w-8 bg-slate-200 dark:bg-slate-700 rounded-full" />
             </motion.div>
          ))}
       </div>
    </div>
  )
}

function MockupBooking() {
   return (
     <div className="relative w-full h-full p-6 flex flex-col items-center">
        {/* CALENDARI */}
        <div className="w-full max-w-sm bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-border overflow-hidden">
           <div className="bg-primary/10 p-4 flex justify-between items-center border-b border-primary/10">
              <span className="font-bold text-primary">Gener 2025</span>
              <div className="flex gap-1">
                 <div className="w-2 h-2 rounded-full bg-red-400" />
                 <div className="w-2 h-2 rounded-full bg-yellow-400" />
                 <div className="w-2 h-2 rounded-full bg-green-400" />
              </div>
           </div>
           <div className="p-4 grid grid-cols-7 gap-2">
              {[...Array(14)].map((_, i) => (
                 <div key={i} className="aspect-square rounded-md bg-slate-100 dark:bg-slate-700/50 flex items-center justify-center text-xs text-muted-foreground">
                    {i + 1}
                 </div>
              ))}
              <motion.div 
                 initial={{ scale: 0 }}
                 animate={{ scale: 1 }}
                 transition={{ delay: 0.5, type: "spring" }}
                 className="aspect-square rounded-md bg-primary text-primary-foreground flex items-center justify-center text-xs font-bold shadow-lg shadow-primary/30 col-span-2 w-full"
              >
                 RESERVAT
              </motion.div>
           </div>
        </div>

        {/* NOTIFICACIÃ“ MÃ’BIL */}
        <motion.div 
           initial={{ y: 50, opacity: 0 }}
           animate={{ y: -20, opacity: 1 }}
           transition={{ delay: 1 }}
           className="absolute bottom-4 bg-black/80 backdrop-blur-md text-white p-3 rounded-xl shadow-2xl flex items-center gap-3 w-64 border border-white/10"
        >
           <div className="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
              <Smartphone className="w-4 h-4" />
           </div>
           <div className="text-xs">
              <div className="font-bold">Nova Reserva</div>
              <div className="opacity-80">Joan ha reservat per demÃ .</div>
           </div>
        </motion.div>
     </div>
   )
}

function MockupGrowth() {
   return (
      <div className="flex items-end justify-center gap-4 h-40 w-full px-10">
         {[40, 70, 50, 90, 65, 85].map((height, i) => (
            <motion.div
               key={i}
               initial={{ height: 0 }}
               animate={{ height: `${height}%` }}
               transition={{ delay: i * 0.1, duration: 0.5, type: "spring" }}
               className="w-12 bg-gradient-to-t from-orange-500 to-red-500 rounded-t-lg relative group"
            >
               <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-white dark:bg-slate-800 text-xs font-bold px-2 py-1 rounded shadow opacity-0 group-hover:opacity-100 transition-opacity">
                  {height}%
               </div>
            </motion.div>
         ))}
         
         {/* LÃNIA DE TENDÃˆNCIA */}
         <svg className="absolute inset-0 w-full h-full pointer-events-none overflow-visible">
            <motion.path
               d="M 40 120 L 100 60 L 160 90 L 220 30 L 280 70 L 340 40"
               fill="none"
               stroke="#10b981"
               strokeWidth="4"
               initial={{ pathLength: 0 }}
               animate={{ pathLength: 1 }}
               transition={{ duration: 1.5, delay: 0.5 }}
            />
         </svg>
      </div>
   )
}

// =================== FILE: src/components/landing/TechStackSection.tsx ===================

'use client';

import { motion, useAnimationControls } from 'framer-motion';
import { useState, useEffect } from 'react';
import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils';

const TECHNOLOGIES = [
  {
    name: "Next.js",
    color: "#000000", // En mode fosc es veurÃ  blanc pel svg, perÃ² el text el volem visible
    darkModeColor: "#ffffff",
    icon: (
      <svg viewBox="0 0 180 180" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <mask id="mask0" mask-type="alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="180" height="180">
          <circle cx="90" cy="90" r="90" className="fill-black dark:fill-white" />
        </mask>
        <g mask="url(#mask0)">
          <circle cx="90" cy="90" r="87" className="stroke-black dark:stroke-white" strokeWidth="6" />
          <path d="M149.508 157.52L69.142 54H54V125.97H66.1136V69.3836L139.999 164.845C143.333 162.614 146.509 160.165 149.508 157.52Z" className="fill-black dark:fill-white" />
          <rect x="115" y="54" width="12" height="72" className="fill-black dark:fill-white" />
        </g>
      </svg>
    )
  },
  {
    name: "Supabase",
    color: "#3ECF8E",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M11.5286 0.179546C11.8331 -0.0812412 12.2919 -0.0533377 12.5643 0.24243L23.6622 12.2932C23.9326 12.5868 23.8877 13.048 23.5614 13.2813L13.3359 20.5925L15.9762 23.1152C16.2584 23.3849 16.0599 23.8673 15.6692 23.8673H11.5286C11.2241 24.1281 10.7653 24.1002 10.4929 23.8044L-0.605008 11.7537C-0.875401 11.46 -0.830532 10.9989 -0.504224 10.7655L9.72131 3.45435L7.08095 0.931661C6.79877 0.661952 6.99727 0.179546 7.38795 0.179546H11.5286Z" fill="#3ECF8E" />
      </svg>
    )
  },
  {
    name: "n8n",
    color: "#EA4B71",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M12.9 8.25h2.2v2.2h-2.2v-2.2zm-2.2 0h-2.2v2.2h2.2v-2.2zm-4.4 0H4.1v2.2h2.2v-2.2zm0 4.4H4.1v2.2h2.2v-2.2zm4.4 0h-2.2v2.2h2.2v-2.2zm2.2 0h2.2v2.2h-2.2v-2.2z" fill="#EA4B71" />
        <path fillRule="evenodd" clipRule="evenodd" d="M14 0H2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2zM2 2h12v12H2V2z" fill="#EA4B71" transform="translate(4 4)" />
      </svg>
    )
  },
  {
    name: "Airtable",
    color: "#F82B60",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M3 10v8l7 -3v-2.6z" fill="#F8D800" />
        <path d="M3 6l9 3l9 -3l-9 -3z" fill="#2D7FF9" />
        <path d="M14 12.3v8.7l7 -3v-8z" fill="#F82B60" />
      </svg>
    )
  },
  {
    name: "React Native",
    color: "#61DAFB",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M12 22.5C17.799 22.5 22.5 17.799 22.5 12C22.5 6.20101 17.799 1.5 12 1.5C6.20101 1.5 1.5 6.20101 1.5 12C1.5 17.799 6.20101 22.5 12 22.5Z" fill="none" />
        <circle cx="12" cy="12" r="2" fill="#61DAFB" />
        <g stroke="#61DAFB" strokeWidth="1.5" fill="none">
           <ellipse cx="12" cy="12" rx="10" ry="4" />
           <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(60 12 12)" />
           <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(120 12 12)" />
        </g>
      </svg>
    )
  },
  {
    name: "OpenAI",
    color: "#10A37F",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1 .6765 8.1643l-.142-.0805-4.7784-2.7581a.7616.7616 0 0 0-.3927-.6765v-6.7369l.0048-.0048z" className="fill-black dark:fill-white" />
      </svg>
    )
  },
  {
    name: "Gemini",
    color: "#4E75F6",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <defs>
          <linearGradient id="gemini-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#4E75F6" />
            <stop offset="100%" stopColor="#E96C7C" />
          </linearGradient>
        </defs>
        <path d="M12 22C12 16.4772 16.4772 12 22 12C16.4772 12 12 7.52285 12 2C12 7.52285 7.52285 12 2 12C7.52285 12 12 16.4772 12 22Z" fill="url(#gemini-gradient)" />
      </svg>
    )
  },
  {
    name: "TypeScript",
    color: "#3178C6",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M2 0h20c1.1 0 2 0.9 2 2v20c0 1.1-0.9 2-2 2H2c-1.1 0-2-0.9-2-2V2c0-1.1 0.9-2 2-2zm13.5 17.9c1.3 0 2.2-0.7 2.6-1.7h-1.7c-0.2 0.4-0.5 0.6-0.9 0.6-0.7 0-1-0.6-1-1.7v-3.3h2.9v-1.4h-2.9v-2.1h-1.7v2.1h-1.4v1.4h1.4v3.6c0 1.6 0.9 2.5 2.7 2.5zm-6.7 0c1.5 0 2.6-0.8 2.8-2h-1.7c-0.2 0.5-0.6 0.8-1.1 0.8-0.8 0-1.2-0.6-1.2-1.6v-3.2h2.8v-1.4h-2.8v-2.1h-1.7v2.1h-1.6v1.4h1.6v3.5c0 1.7 1.1 2.5 2.9 2.5z" fill="#3178C6"/>
      </svg>
    )
  },
  {
    name: "GitHub",
    color: "#000000",
    darkModeColor: "#ffffff",
    icon: (
      <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.65.72.26.98.19 1.12.08.14-.55.28-.94.55-1.15-2.2-.23-4.51-1.1-4.51-4.9 0-1.08.38-1.97 1.01-2.66-.1-.25-.44-1.26.1-2.62 0 0 .84-.27 2.75 1.02.8-.22 1.65-.33 2.5-.33.85 0 1.7.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.36.2 2.37.1 2.62.63.69 1.01 1.58 1.01 2.66 0 3.8-2.32 4.67-4.53 4.89.29.25.55.74.55 1.49 0 1.08-.01 1.95-.01 2.21 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" className="fill-black dark:fill-white"/>
      </svg>
    )
  },
  {
    name: "Vercel",
    color: "#000000",
    darkModeColor: "#ffffff",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M12 1L24 22H0L12 1Z" className="fill-black dark:fill-white"/>
      </svg>
    )
  },
];

export function TechStackSection() {
  const t = useTranslations('TechStack');
  const controls = useAnimationControls();
  const [activeTech, setActiveTech] = useState<string | null>(null);

  // Dupliquem la llista per l'efecte infinit
  const infiniteTechnologies = [...TECHNOLOGIES, ...TECHNOLOGIES];

  useEffect(() => {
    controls.start({
      x: "-50%",
      transition: {
        duration: 30, 
        ease: "linear",
        repeat: Infinity,
      }
    });
  }, [controls]);

  const handleInteractionStart = (name: string) => {
    setActiveTech(name);
    controls.stop(); 
  };

  const handleInteractionEnd = () => {
    setActiveTech(null);
    controls.start({
      x: "-50%",
      transition: {
        duration: 20,
        ease: "linear",
        repeat: Infinity,
      }
    });
  };

  return (
    <section className="py-6 border-y border-slate-200 dark:border-white/5 bg-slate-50 dark:bg-white/1 overflow-hidden relative">
      
      {/* 3. MÃ€SCARES DE DEGRADAT (FADE EDGES) */}
      <div className="absolute inset-y-0 left-0 w-24 bg-linear-to-r from-slate-50 dark:from-[#0a0a0a] to-transparent z-10 pointer-events-none" />
      <div className="absolute inset-y-0 right-0 w-24 bg-linear-to-l from-slate-50 dark:from-[#0a0a0a] to-transparent z-10 pointer-events-none" />

      <div className="container mx-auto px-4 mb-4">
        <p className="text-center text-xs font-bold text-slate-500 uppercase tracking-[0.2em]">
          {t('subtitle')}
        </p>
      </div>
      
      {/* CORRECCIÃ“ CLAU: AFEGIT 'py-10' PER DONAR ESPAI VERTICAL AL TEXT ABSOLUT */}
      <div className="flex w-full overflow-hidden py-10">
        <motion.div 
          className="flex items-center gap-12 md:gap-24 px-12"
          animate={controls}
          initial={{ x: 0 }}
        >
          {infiniteTechnologies.map((tech, i) => (
            <div
              key={`${tech.name}-${i}`} 
              // 'items-center' i 'relative' sÃ³n clau aquÃ­
              className="relative group flex flex-col items-center justify-center min-w-20"
              onMouseEnter={() => handleInteractionStart(tech.name)}
              onMouseLeave={handleInteractionEnd}
              onTouchStart={() => handleInteractionStart(tech.name)}
              onTouchEnd={handleInteractionEnd}
              onClick={() => handleInteractionStart(tech.name)}
            >
              <motion.div 
                className={cn(
                  "w-16 h-16 md:w-20 md:h-20 transition-all duration-300 z-40",
                  activeTech && activeTech !== tech.name ? "opacity-30 grayscale scale-90" : "opacity-70 grayscale",
                  activeTech === tech.name && "opacity-100 grayscale-0 scale-110 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]"
                )}
              >
                {tech.icon}
              </motion.div>
              
              {/* Text: el 'top-full mt-4' el posa a sota, i com que el pare tÃ© 'py-10', no es talla */}
              <motion.span 
                initial={{ opacity: 0, y: -10 }}
                animate={{ 
                  opacity: activeTech === tech.name ? 1 : 0, 
                  y: activeTech === tech.name ? 0 : -10 
                }}
                className="absolute top-full mt-4 text-xs font-bold whitespace-nowrap px-3 py-1 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-lg z-20 pointer-events-none"
                // Utilitzem un color de fallback si no hi Ã©s
                style={{ color: activeTech === tech.name ? tech.color : 'inherit' }}
              >
                {tech.name}
              </motion.span>
            </div>
          ))}
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/TestimonialsSection.tsx ===================

'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Star, Quote, ChevronLeft, ChevronRight, Globe, Smartphone, Zap, Users, Code, ExternalLink } from 'lucide-react';
import Image, { StaticImageData } from 'next/image';
import Link from 'next/link';
import type { Testimonial } from '@/lib/data';

type Props = {
  testimonials: Testimonial[];
};

export function TestimonialsSection({ testimonials }: Props) {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [itemsToShow, setItemsToShow] = useState(3); // Per defecte 3 (escriptori)

  // Detectem la mida de la pantalla per ajustar itemsToShow
  useEffect(() => {
    const handleResize = () => {
      if (window.innerWidth < 768) {
        setItemsToShow(1); // MÃ²bil: 1 Ã­tem
      } else {
        setItemsToShow(3); // Escriptori: 3 Ã­tems
      }
    };

    // Executem al principi
    handleResize();

    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  const nextSlide = () => {
    setCurrentIndex((prev) => (prev + 1) % testimonials.length);
  };

  const prevSlide = () => {
    setCurrentIndex((prev) => (prev - 1 + testimonials.length) % testimonials.length);
  };

  const getVisibleItems = () => {
    const items = [];
    for (let i = 0; i < itemsToShow; i++) {
      items.push(testimonials[(currentIndex + i) % testimonials.length]);
    }
    return items;
  };

  return (
    <section id="testimonis" className="py-16 bg-muted/30 relative overflow-hidden">
      <div className="container mx-auto px-4 relative z-10">
        
        {/* CAPÃ‡ALERA */}
        <div className="flex flex-col md:flex-row justify-between items-end  md:mb-16 gap-6">
           <div className="max-w-2xl">
              <h2 className="text-3xl lg:text-5xl font-bold text-foreground leading-tight">
                No ens creguis a nosaltres. <br/>
                Mira el que hem <span className="gradient-text">ConstruÃ¯t</span>.
              </h2>
           </div>

           {/* CONTROLS */}
           <div className="flex gap-3">
              <button onClick={prevSlide} className="p-3 rounded-full border border-border bg-card hover:bg-primary hover:text-white transition-all shadow-sm">
                 <ChevronLeft className="w-6 h-6" />
              </button>
              <button onClick={nextSlide} className="p-3 rounded-full border border-border bg-card hover:bg-primary hover:text-white transition-all shadow-sm">
                 <ChevronRight className="w-6 h-6" />
              </button>
           </div>
        </div>

        {/* GRID */}
        {/* Canviem grid-cols per adaptar-se al itemsToShow dinÃ micament */}
        <div className={`grid gap-8 py-6 ${itemsToShow === 1 ? 'grid-cols-1' : 'grid-cols-3'}`}>
          <AnimatePresence mode='popLayout'>
            {getVisibleItems().map((item, i) => (
              <motion.div
                key={`${item.id}-${currentIndex + i}`} // Clau Ãºnica composta per forÃ§ar re-render correcte
                initial={{ opacity: 0, x: 50 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -50 }}
                transition={{ duration: 0.4, ease: "easeInOut" }}
                className="h-[450px] perspective-1000"
              >
                 <TestimonialCard item={item} />
              </motion.div>
            ))}
          </AnimatePresence>
        </div>

      </div>
    </section>
  );
}

// --- TARGETA INDIVIDUAL (EFECTE CARPETA/FITXER) ---

function TestimonialCard({ item }: { item: Testimonial }) {
   return (
      <div className="relative w-full h-full group">
         
         {/* CAPA 1: EL PROJECTE (FITXER) */}
         <div className="absolute inset-x-4 top-4 bottom-20 transition-all duration-500 cubic-bezier(0.25, 0.8, 0.25, 1) group-hover:-translate-y-20 ">
            <div className="w-full h-full rounded-t-xl overflow-hidden border border-primary/20 bg-slate-900 dark:bg-black shadow-2xl group-hover:shadow-primary/20">
               {item.projectType === 'web' && <MockupWeb url={item.projectUrl} image={item.image} title={item.company} />}
               {item.projectType === 'app' && <MockupApp image={item.image} title={item.company} />}
               {item.projectType === 'automation' && <MockupAutomation />}
            </div>
         </div>

         {/* CAPA 2: EL TESTIMONI (CARPETA) */}
         <div className="absolute bottom-0 left-0 right-0 h-[280px] bg-card border border-border rounded-2xl p-8 shadow-xl z-10 transition-transform duration-500 group-hover:translate-y-6 flex flex-col">
            
            <Quote className="absolute top-6 right-6 text-primary/10 w-12 h-12 rotate-180" />

            <div className="flex items-center gap-3 mb-4">
               <div className="w-12 h-12 rounded-full bg-linear-to-br from-primary/20 to-blue-500/20 border border-primary/30 flex items-center justify-center text-lg font-bold text-primary shrink-0">
                  {item.name.charAt(0)}
               </div>
               <div>
                  <div className="font-bold text-foreground text-sm md:text-base">{item.name}</div>
                  <div className="text-xs text-muted-foreground">{item.company}</div>
               </div>
            </div>

            <div className="flex gap-1 mb-4">
               {[...Array(5)].map((_, i) => (
                  <Star key={i} className={`w-4 h-4 ${i < item.rating ? 'fill-yellow-400 text-yellow-400' : 'text-slate-300 dark:text-slate-700'}`} />
               ))}
            </div>

            <p className="text-sm md:text-base text-muted-foreground leading-relaxed overflow-hidden text-ellipsis line-clamp-4">
               "{item.text}"
            </p>
            
            <div className="mt-auto pt-4 border-t border-border flex justify-between items-center opacity-50">
               <span className="text-[10px] uppercase tracking-widest font-bold">Projecte Realitzat</span>
               <div className="w-16 h-1 bg-foreground/10 rounded-full"></div>
            </div>
         </div>
      </div>
   )
}

// --- MOCKUPS VISUALS ---

function MockupWeb({ url, image, title }: { url?: string, image?: string | StaticImageData, title: string }) {
   const Wrapper = url ? Link : 'div';
   return (
      <Wrapper href={url || '#'} target={url ? "_blank" : undefined} className="block w-full h-full cursor-pointer group/mockup">
         <div className="w-full h-full bg-slate-50 dark:bg-[#0f111a] flex flex-col relative">
            
            {url && (
               <div className="absolute inset-0 z-30 bg-black/60 backdrop-blur-[2px] flex items-center justify-center opacity-0 group-hover/mockup:opacity-100 transition-opacity duration-300">
                  <span className="bg-white text-black px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-lg transform scale-90 group-hover/mockup:scale-100 transition-transform">
                     Visitar Web <ExternalLink className="w-3 h-3" />
                  </span>
               </div>
            )}

            <div className="h-6 bg-slate-200 dark:bg-white/10 flex items-center px-3 gap-1.5 z-10">
               <div className="w-2 h-2 rounded-full bg-red-400/80"></div>
               <div className="w-2 h-2 rounded-full bg-yellow-400/80"></div>
               <div className="w-2 h-2 rounded-full bg-green-400/80"></div>
            </div>
            
            <div className="flex-1 relative w-full">
                {image ? (
                   <Image src={image} alt={title} fill className="object-cover object-top" />
                ) : (
                   <div className="flex flex-col items-center justify-center h-full gap-2 bg-white dark:bg-black/50">
                      <Globe className="w-8 h-8 text-blue-500/20" />
                      <span className="text-xs text-muted-foreground font-bold">{title} Web</span>
                   </div>
                )}
            </div>
         </div>
      </Wrapper>
   )
}

function MockupApp({ image, title }: { image?: string | StaticImageData, title: string }) {
   return (
      <div className="w-full h-full bg-slate-800 dark:bg-black flex items-end justify-center p-4 pb-0 group/mockup relative">
         
         <div className="absolute inset-0 z-30 bg-black/60 backdrop-blur-[2px] flex items-center justify-center opacity-0 group-hover/mockup:opacity-100 transition-opacity duration-300 rounded-t-xl">
             <span className="bg-white text-black px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-lg">
                Veure App <ExternalLink className="w-3 h-3" />
             </span>
         </div>

         <div className="w-32 h-full bg-black border-2 border-slate-700 rounded-t-xl overflow-hidden relative">
            {image ? (
                <Image src={image} alt={title} fill className="object-cover" />
            ) : (
               <div className="w-full h-full bg-slate-900 flex flex-col items-center justify-center">
                   <Smartphone className="w-6 h-6 text-primary" />
                   <span className="text-[10px] text-slate-400 mt-2">{title} App</span>
                </div>
            )}
         </div>
      </div>
   )
}

function MockupAutomation() {
   return (
      <div className="w-full h-full bg-[#1a1d2d] relative overflow-hidden group/mockup">
         <div className="absolute inset-0 z-30 bg-black/60 backdrop-blur-[2px] flex items-center justify-center opacity-0 group-hover/mockup:opacity-100 transition-opacity duration-300">
             <span className="bg-white text-black px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-lg">
                Veure Flux <Zap className="w-3 h-3" />
             </span>
         </div>

         <div className="absolute inset-0 bg-[radial-gradient(#ffffff10_1px,transparent_1px)] bg-size-[12px_12px]"></div>
         
         <svg className="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 100 100" preserveAspectRatio="none">
            <defs>
               <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#a855f7" stopOpacity="0.5" />
                  <stop offset="100%" stopColor="#22c55e" stopOpacity="0.5" />
               </linearGradient>
            </defs>
            <path 
               d="M 20 30 C 50 30, 50 70, 80 70" 
               stroke="url(#lineGradient)" 
               strokeWidth="1.5" 
               fill="none" 
               vectorEffect="non-scaling-stroke" 
            />
            <motion.circle 
               r="3" 
               fill="#a855f7"
               animate={{ offsetDistance: ["0%", "100%"] }}
               transition={{ duration: 2, repeat: Infinity, ease: "linear" }}
               style={{ offsetPath: "path('M 20 30 C 50 30, 50 70, 80 70')" }}
            />
         </svg>

         <div className="absolute left-[20%] top-[30%] -translate-x-1/2 -translate-y-1/2 w-10 h-10 rounded-lg bg-purple-500/20 border border-purple-500 flex items-center justify-center z-10 shadow-[0_0_15px_rgba(168,85,247,0.4)] backdrop-blur-sm">
            <Users className="w-5 h-5 text-purple-400" />
         </div>
         
         <div className="absolute left-[80%] top-[50%] -translate-x-1/2 -translate-y-1/2 w-10 h-10 rounded-lg bg-green-500/20 border border-green-500 flex items-center justify-center z-10 shadow-[0_0_15px_rgba(34,197,94,0.4)] backdrop-blur-sm">
            <Code className="w-5 h-5 text-green-400" />
         </div>
      </div>
   )
}

// =================== FILE: src/components/layout/Footer.tsx ===================

'use client';

import Link from 'next/link';
import { Facebook, Instagram, Linkedin, Mail, MapPin} from 'lucide-react';
import { useTranslations } from 'next-intl';

const SOCIALS = [
  { icon: Linkedin, href: "https://www.linkedin.com/in/digitai-studios-105a0136a/" , label: 'LinkedIn' },
  { icon: Instagram, href: "https://www.instagram.com/digitaistudios/", label: 'Instagram' },
  { icon: Facebook, href: "https://www.facebook.com/profile.php?id=61576974390567" , label: 'Facebook' },
];

export function Footer() {
  const t = useTranslations('Footer'); // Namespace 'Footer'
  const tNav = useTranslations('Navbar'); // Reutilitzem traduccions de Navbar
  const currentYear = new Date().getFullYear();

  // Definim links DINS del component
  const FOOTER_LINKS = [
    {
      title: t('services_title'),
      links: [
        { label: 'AppWebs & SaaS', href: '#serveis' },
        { label: 'Apps MÃ²bils', href: '#serveis' },
        { label: 'AutomatitzaciÃ³ IA', href: '#serveis' },
        { label: 'FormaciÃ³ In-Company', href: '#serveis' },
      ],
    },
    {
      title: t('company_title'),
      links: [
        { label: t('about'), href: '#hero' },
        { label: tNav('projects'), href: '/projectes' },
        { label: tNav('blog'), href: '/blog' },
        { label: t('contact'), href: '#contacte' },
      ],
    },
    {
      title: t('legal_title'),
      links: [
        { label: t('legal_notice'), href: '/legal/avis-legal' },
        { label: t('privacy'), href: '/legal/privacitat' },
        { label: t('cookies'), href: '/legal/cookies' },
      ],
    },
  ];

  return (
    <footer className="bg-background border-t border-border pt-16 pb-8 transition-colors duration-300">
      <div className="container mx-auto px-4">
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-12 mb-16">
          
          {/* COLUMNA 1: MARCA & INFO */}
          <div className="lg:col-span-2 space-y-6">
            <Link href="/" className="inline-block">
              <span className="text-2xl font-bold tracking-tight text-foreground">
                DigitAI <span className="gradient-text">Studios</span>
              </span>
            </Link>
            <p className="text-muted-foreground leading-relaxed max-w-sm">
              {t('description')}
            </p>
            
            <div className="flex gap-4">
              {SOCIALS.map((social, i) => (
                <a 
                  key={i}
                  href={social.href}
                  target="_blank"
                  rel="noopener noreferrer"
                  aria-label={social.label}
                  className="w-10 h-10 rounded-full bg-muted/50 flex items-center justify-center text-muted-foreground hover:bg-primary/10 hover:text-primary transition-all border border-transparent hover:border-primary/20"
                >
                  <social.icon className="w-5 h-5" />
                </a>
              ))}
            </div>

            <div className="space-y-2 pt-4">
                <div className="flex items-center gap-3 text-sm text-muted-foreground">
                    <Mail className="w-4 h-4 text-primary" />
                    <a href="mailto:info@digitaistudios.com" className="hover:text-foreground transition-colors">
                        info@digitaistudios.com
                    </a>
                </div>
                <div className="flex items-center gap-3 text-sm text-muted-foreground">
                    <MapPin className="w-4 h-4 text-primary" />
                    <span>Girona, Catalunya</span>
                </div>
            </div>
          </div>

          {/* COLUMNS DINÃ€MIQUES DE LINKS */}
          {FOOTER_LINKS.map((section) => (
            <div key={section.title} className="space-y-6">
              <h4 className="font-bold text-foreground">{section.title}</h4>
              <ul className="space-y-3">
                {section.links.map((link) => (
                  <li key={link.label}>
                    <Link 
                      href={link.href} 
                      className="text-sm text-muted-foreground hover:text-primary transition-colors flex items-center gap-2 group"
                    >
                      <span className="w-1.5 h-1.5 rounded-full bg-primary/0 group-hover:bg-primary transition-all duration-300"></span>
                      {link.label}
                    </Link>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>

        {/* COPYRIGHT */}
        <div className="border-t border-border pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-muted-foreground">
          <p>Â© {currentYear} DigitAI Studios. {t('rights_reserved')}</p>
          <div className="flex items-center gap-6">
             <span>{t('made_with_love')}</span>
          </div>
        </div>

      </div>
    </footer>
  );
}

// =================== FILE: src/components/layout/LanguageSwitcher.tsx ===================

'use client';

import { useLocale, useTranslations } from 'next-intl';
import { usePathname, useRouter } from '@/routing'; // ğŸ‘ˆ IMPORTANT: Importar del teu routing tipat
import { Button } from '@/components/ui/button';
import { 
  DropdownMenu, 
  DropdownMenuContent, 
  DropdownMenuItem, 
  DropdownMenuTrigger 
} from '@/components/ui/dropdown-menu'; // Assumint que tens shadcn/ui, sinÃ³ un <select> natiu
import { Globe } from 'lucide-react';
import { startTransition } from 'react';

export function LanguageSwitcher() {
  const t = useTranslations('Common.languages');
  const locale = useLocale();
  const router = useRouter();
  const pathname = usePathname();

  const handleLanguageChange = (nextLocale: 'ca' | 'es' | 'en') => {
    startTransition(() => {
      // AixÃ² substitueix el segment d'idioma de la URL actual
      router.replace(pathname, { locale: nextLocale });
    });
  };

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="icon" className="rounded-full hover:bg-muted">
          <Globe className="w-5 h-5 text-muted-foreground" />
          <span className="sr-only">Canviar idioma</span>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuItem 
          onClick={() => handleLanguageChange('ca')}
          className={locale === 'ca' ? 'bg-primary/10 font-bold' : ''}
        >
          ğŸ‡¦ğŸ‡© {t('ca')}
        </DropdownMenuItem>
        <DropdownMenuItem 
          onClick={() => handleLanguageChange('es')}
          className={locale === 'es' ? 'bg-primary/10 font-bold' : ''}
        >
          ğŸ‡ªğŸ‡¸ {t('es')}
        </DropdownMenuItem>
        <DropdownMenuItem 
          onClick={() => handleLanguageChange('en')}
          className={locale === 'en' ? 'bg-primary/10 font-bold' : ''}
        >
          ğŸ‡ºğŸ‡¸ {t('en')}
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

// =================== FILE: src/components/layout/LegalLayout.tsx ===================

'use client';

import { Navbar } from "@/components/layout/Navbar";
import { Footer } from "@/components/layout/Footer";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { cn } from "@/lib/utils";
import { Scale, Shield, Cookie, FileText } from "lucide-react";
import { createClient } from '@/lib/supabase/client';
import { useEffect, useState } from "react";
import type { User } from '@supabase/supabase-js';
import { useTranslations } from 'next-intl'; // Importem el hook

export default function LegalLayout({ children }: { children: React.ReactNode }) {
  const t = useTranslations('LegalLayout'); // Namespace LegalLayout
  const pathname = usePathname();
  const [user, setUser] = useState<User | null>(null);
  
  useEffect(() => {
    const supabase = createClient();
    supabase.auth.getUser().then(({ data }) => setUser(data.user));
  }, []);

  // Definim els links a dins per traduir-los
  const LEGAL_NAV = [
    { name: t('links.notice'), href: '/legal/avis-legal', icon: Scale },
    { name: t('links.privacy'), href: '/legal/privacitat', icon: Shield },
    { name: t('links.cookies'), href: '/legal/cookies', icon: Cookie },
  ];

  const cleanPath = pathname.replace(/^\/[a-z]{2}\//, '/').replace(/^\/[a-z]{2}$/, '');

  return (
    <div className="min-h-screen flex flex-col bg-background text-foreground">
      <Navbar user={user} />
      
      <main className="flex-1 container mx-auto px-4 py-32">
        <div className="grid lg:grid-cols-4 gap-10">
          
          {/* SIDEBAR NAVEGACIÃ“ */}
          <aside className="lg:col-span-1 hidden lg:block">
             <div className="sticky top-32 space-y-4">
                <div className="px-4">
                    <h3 className="font-bold text-lg flex items-center gap-2 text-foreground">
                        <FileText className="w-5 h-5 text-primary" /> 
                        {t('sidebar_title')}
                    </h3>
                    <p className="text-xs text-muted-foreground mt-1">
                        {t('sidebar_desc')}
                    </p>
                </div>

                <nav className="flex flex-col space-y-1">
                   {LEGAL_NAV.map((item) => {
                      const isActive = cleanPath === item.href || pathname.endsWith(item.href);

                      return (
                        <Link 
                           key={item.href} 
                           href={item.href}
                           className={cn(
                             "flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200",
                             isActive 
                               ? "bg-primary/10 text-primary border border-primary/20 shadow-sm font-bold" 
                               : "text-muted-foreground hover:bg-muted hover:text-foreground border border-transparent"
                           )}
                        >
                           <item.icon className={cn("w-4 h-4", isActive && "text-primary")} />
                           {item.name}
                        </Link>
                      )
                   })}
                </nav>
             </div>
          </aside>

          {/* MENU MÃ’BIL */}
          <div className="lg:hidden col-span-1 mb-6 overflow-x-auto pb-2 scrollbar-hide">
             <div className="flex gap-2 w-max">
                {LEGAL_NAV.map((item) => {
                    const isActive = cleanPath === item.href || pathname.endsWith(item.href);
                    return (
                        <Link 
                           key={item.href} 
                           href={item.href}
                           className={cn(
                             "flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium border transition-colors whitespace-nowrap",
                             isActive 
                               ? "bg-primary text-primary-foreground border-primary" 
                               : "bg-background border-border text-muted-foreground"
                           )}
                        >
                           <item.icon className="w-4 h-4" />
                           {item.name}
                        </Link>
                    )
                })}
             </div>
          </div>

          {/* CONTINGUT PRINCIPAL */}
          <div className="lg:col-span-3">
             <div className="bg-card border border-border rounded-3xl p-8 md:p-12 shadow-sm animate-in fade-in slide-in-from-bottom-4 duration-500">
                <article className="prose prose-slate dark:prose-invert max-w-none prose-headings:font-bold prose-a:text-primary hover:prose-a:underline prose-img:rounded-xl">
                   {children}
                </article>
             </div>
          </div>

        </div>
      </main>
      <Footer />
    </div>
  );
}

// =================== FILE: src/components/layout/Navbar.tsx ===================

'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link'; // âœ… Importem Link
import { usePathname } from 'next/navigation';

import { Button } from '@/components/ui/button';
import {
  LogOut,
  LayoutDashboard,
  Home,
  Zap,
  FolderGit2,
  BookOpen,

  ShieldAlert,
  ChevronDown
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { createClient } from '@/lib/supabase/client';
import { useRouter } from 'next/navigation';
import { ThemeToggle } from "@/components/ui/theme-toggle";
import type { User as SupabaseUser } from '@supabase/supabase-js';
import { LanguageSwitcher } from './LanguageSwitcher';
import { useTranslations } from 'next-intl';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { signOutAction } from '@/features/auth/actions/auth';

type Props = {
  user: SupabaseUser | null;
};

export function Navbar({ user }: Props) {
  const t = useTranslations('Navbar');
  const [isScrolled, setIsScrolled] = useState(false);
  const router = useRouter();
  const pathname = usePathname();

  useEffect(() => {
    const handleScroll = () => setIsScrolled(window.scrollY > 20);
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // âœ… LOGOUT HÃBRID (MÃ©s estable)
  const handleSignOut = async () => {
    // 1. Esperem que el servidor netegi cookies
    await signOutAction();

    // 2. Refresquem la ruta (per netejar dades en cachÃ© del client)
    router.refresh();

    // 3. Redirigim al login
    router.push('/auth/login');
  };
  
  // FunciÃ³ per gestionar l'scroll suau
  // Canviem el tipus d'event a un genÃ¨ric o HTMLAnchorElement ja que Link renderitza un <a>
  const handleScrollToSection = (e: React.MouseEvent<HTMLAnchorElement>, href: string) => {
    // Si estem a la home, fem scroll suau
    if (pathname === '/' && href.startsWith('/#')) {
      e.preventDefault();
      const id = href.replace('/#', '');
      const element = document.getElementById(id);
      if (element) {
        const headerOffset = 80;
        const elementPosition = element.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

        window.scrollTo({
          top: offsetPosition,
          behavior: "smooth"
        });
      }
    }
    // Si no estem a la home, el Link de Next.js ja gestionarÃ  la navegaciÃ³ cap a la ruta correcta
  };

  const isAdmin = user?.email === 'digitaistudios.developer@gmail.com';

  return (
    <>
      <header
        className={cn(
          "fixed top-0 w-full z-50 transition-all duration-300 border-b border-transparent",
          isScrolled
            ? "bg-background/80 backdrop-blur-md shadow-sm border-border py-3"
            : "bg-transparent py-4 md:py-6"
        )}
      >
        <div className="container mx-auto px-4 flex items-center justify-between">

          {/* LOGO */}
          <Link href="/" className="text-xl md:text-2xl font-bold tracking-tight z-50 flex items-center gap-2">
            <span className="bg-primary/10 p-1.5 rounded-lg md:hidden">
              <Zap className="w-5 h-5 text-primary" />
            </span>
            <span>DigitAI <span className="gradient-text">Studios</span></span>
          </Link>

          {/* DESKTOP NAV */}
          <nav className="hidden md:flex items-center gap-8">

            {/* INICI */}
            <Link href="/" className={cn("text-sm font-medium transition-colors hover:text-primary", pathname === '/' ? "text-primary" : "text-muted-foreground")}>
              {t('home')}
            </Link>

            {/* DESPLEGABLE SOLUCIONS */}
            <DropdownMenu>
              <DropdownMenuTrigger className="flex items-center gap-1 text-sm font-medium text-muted-foreground hover:text-primary transition-colors outline-none">
                {t('solutions')} <ChevronDown className="w-4 h-4" />
              </DropdownMenuTrigger>

              <DropdownMenuContent align="start" className="w-48">
                {/* CORRECCIÃ“: Usem <Link> en lloc de <a>.
                    Com que DropdownMenuItem tÃ© asChild, passarÃ  els props i refs al Link.
                */}
                <DropdownMenuItem asChild>
                  <Link
                    href="/#serveis"
                    onClick={(e) => handleScrollToSection(e, '/#serveis')}
                    className="cursor-pointer w-full block"
                  >
                    Serveis Generals
                  </Link>
                </DropdownMenuItem>
                <DropdownMenuItem asChild>
                  <Link
                    href="/#LatestPostsSection"
                    onClick={(e) => handleScrollToSection(e, '/#LatestPostsSection')}
                    className="cursor-pointer w-full block"
                  >
                    Ãšltims Articles
                  </Link>
                </DropdownMenuItem>
                <DropdownMenuItem asChild>
                  <Link
                    href="/#audit"
                    onClick={(e) => handleScrollToSection(e, '/#audit')}
                    className="cursor-pointer w-full block"
                  >
                    Auditoria
                  </Link>
                </DropdownMenuItem>

                <DropdownMenuItem asChild>
                  <Link
                    href="/#testimonis"
                    onClick={(e) => handleScrollToSection(e, '/#testimonis')}
                    className="cursor-pointer w-full block"
                  >
                    Testimonis
                  </Link>
                </DropdownMenuItem>

                <DropdownMenuItem asChild>
                  <Link
                    href="/#contacte"
                    onClick={(e) => handleScrollToSection(e, '/#contacte')}
                    className="cursor-pointer w-full block"
                  >
                    Contacte
                  </Link>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>

            {/* ALTRES LINKS */}
            <Link href="/projectes" className={cn("text-sm font-medium transition-colors hover:text-primary", pathname === '/projectes' ? "text-primary" : "text-muted-foreground")}>
              {t('projects')}
            </Link>
            <Link href="/blog" className={cn("text-sm font-medium transition-colors hover:text-primary", pathname === '/blog' ? "text-primary" : "text-muted-foreground")}>
              {t('blog')}
            </Link>

            <div className="h-6 w-px bg-border mx-2"></div>
            <ThemeToggle />
            <LanguageSwitcher />

            {isAdmin && (
              <Link
                href="/admin"
                className={cn(
                  "flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform",
                  pathname.startsWith('/admin') ? "text-red-500" : "text-muted-foreground hover:text-red-500"
                )}
              >
                <ShieldAlert className="w-6 h-6" strokeWidth={2} />
                <span className="text-[10px] font-bold">Admin</span>
              </Link>
            )}

            {user ? (
              <div className="flex items-center gap-4">
                <Link href="/dashboard">
                  <Button className="gradient-bg text-white border-0 shadow-lg shadow-primary/20">
                    <LayoutDashboard className="w-4 h-4 mr-2" /> {t('dashboard')}
                  </Button>
                </Link>
                <Button variant="ghost" size="icon" onClick={handleSignOut} title={t('logout')}>
                  <LogOut className="w-5 h-5 text-muted-foreground hover:text-red-500 transition-colors" />
                </Button>
              </div>
            ) : (
              <div className="flex items-center gap-4">
                <Link href="/auth/login" className="text-sm font-medium hover:text-primary transition-colors">
                  {t('login')}
                </Link>
                <Link href="/auth/register">
                  <Button className="gradient-bg text-white border-0 shadow-lg shadow-primary/20">
                    {t('register')}
                  </Button>
                </Link>
              </div>
            )}
          </nav>

          {/* MOBILE TOGGLES */}
          <div className="flex items-center gap-2 md:hidden">
            <LanguageSwitcher />
            <ThemeToggle />
            {user && (
              <Link href="/dashboard">
                <Button size="icon" variant="ghost" className="rounded-full">
                  <img
                    src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`}
                    alt="Avatar"
                    className="w-8 h-8 rounded-full border border-border"
                  />
                </Button>
              </Link>
            )}
          </div>
        </div>
      </header>

      {/* MOBILE BOTTOM BAR */}
      <div className="md:hidden fixed bottom-0 left-0 w-full z-50 bg-background/90 backdrop-blur-xl border-t border-border pb-safe">
        <div className="flex justify-around items-center h-16 px-2">
          <Link href="/" className={cn("flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform", pathname === '/' ? "text-primary" : "text-muted-foreground hover:text-foreground")}>
            <Home className="w-6 h-6" strokeWidth={pathname === '/' ? 2.5 : 2} />
            <span className="text-[10px] font-medium">{t('home')}</span>
          </Link>

          {/* EnllaÃ§ directe a serveis pel mÃ²bil per simplificar, o podries posar un Drawer */}
          <Link href="/#serveis" onClick={(e) => handleScrollToSection(e, '/#serveis')} className="flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform text-muted-foreground hover:text-foreground">
            <Zap className="w-6 h-6" strokeWidth={2} />
            <span className="text-[10px] font-medium">{t('solutions')}</span>
          </Link>

          <Link href="/projectes" className={cn("flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform", pathname === '/projectes' ? "text-primary" : "text-muted-foreground hover:text-foreground")}>
            <FolderGit2 className="w-6 h-6" strokeWidth={pathname === '/projectes' ? 2.5 : 2} />
            <span className="text-[10px] font-medium">{t('projects')}</span>
          </Link>
          <Link href="/blog" className={cn("flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform", pathname === '/blog' ? "text-primary" : "text-muted-foreground hover:text-foreground")}>
            <BookOpen className="w-6 h-6" strokeWidth={pathname === '/blog' ? 2.5 : 2} />
            <span className="text-[10px] font-medium">{t('blog')}</span>
          </Link>
        </div>
      </div>
    </>
  );
}

// =================== FILE: src/components/theme-provider.tsx ===================

"use client"

import * as React from "react"
import { ThemeProvider as NextThemesProvider } from "next-themes"

export function ThemeProvider({
  children,
  ...props
}: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}

// =================== FILE: src/components/ui/avatar.tsx ===================

"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }


// =================== FILE: src/components/ui/back-button.tsx ===================

'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';

interface BackButtonProps {
  projectId?: string; // Opcional: Si el sabem, podem forÃ§ar tornar al projecte
}

export function BackButton({ projectId }: BackButtonProps) {
  const router = useRouter();
  const searchParams = useSearchParams();
  
  // Mirem si venim amb un parÃ metre ?source=project
  const source = searchParams.get('source');

  const handleBack = () => {
    if (source === 'project' && projectId) {
      // Si venim explÃ­citament del projecte, tornem al projecte
      router.push(`/admin/projects/${projectId}`);
    } else {
      // Comportament per defecte (historial enrere o llista de tests)
      // Si no hi ha historial, router.back() a vegades no fa res, 
      // aixÃ­ que podrÃ­em forÃ§ar /admin/tests com a fallback segur.
      router.back();
    }
  };

  return (
    <Button 
      variant="ghost" 
      size="sm" 
      onClick={handleBack}
      className="text-slate-400 hover:text-white hover:bg-white/10 gap-2 pl-0"
    >
      <ArrowLeft className="w-4 h-4" />
      <span className="hidden sm:inline">Tornar enrere</span>
      <span className="sm:hidden">Tornar</span>
    </Button>
  );
}

// =================== FILE: src/components/ui/badge.tsx ===================

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }


// =================== FILE: src/components/ui/button.tsx ===================

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

// DefiniciÃ³ de les variants de disseny
const buttonVariants = cva(
  "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline: "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, ...props }, ref) => {
    return (
      <button
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }

// =================== FILE: src/components/ui/card.tsx ===================

import * as React from "react"
import { cn } from "@/lib/utils"

const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("rounded-lg border bg-card text-card-foreground shadow-sm", className)} {...props} />
  )
)
Card.displayName = "Card"

const CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("flex flex-col space-y-1.5 p-6", className)} {...props} />
  )
)
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(
  ({ className, ...props }, ref) => (
    <h3 ref={ref} className={cn("text-2xl font-semibold leading-none tracking-tight", className)} {...props} />
  )
)
CardTitle.displayName = "CardTitle"

const CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
  )
)
CardContent.displayName = "CardContent"

export { Card, CardHeader, CardTitle, CardContent }

// =================== FILE: src/components/ui/checkbox.tsx ===================

"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="grid place-content-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }


// =================== FILE: src/components/ui/dropdown-menu.tsx ===================

'use client';

import * as React from 'react';
import { Slot } from '@radix-ui/react-slot';
import { cn } from '@/lib/utils';

// Contexto para gestionar el estado abierto/cerrado
const DropdownContext = React.createContext<{
  open: boolean;
  setOpen: (open: boolean) => void;
} | null>(null);

export const DropdownMenu = ({ children }: { children: React.ReactNode }) => {
  const [open, setOpen] = React.useState(false);
  const containerRef = React.useRef<HTMLDivElement>(null);

  // Cerrar si se clica fuera
  React.useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  return (
    <DropdownContext.Provider value={{ open, setOpen }}>
      <div ref={containerRef} className="relative inline-block text-left">
        {children}
      </div>
    </DropdownContext.Provider>
  );
};

export const DropdownMenuTrigger = React.forwardRef<
  HTMLButtonElement,
  React.ButtonHTMLAttributes<HTMLButtonElement> & { asChild?: boolean }
>(({ className, children, asChild = false, ...props }, ref) => { // ğŸ‘ˆ Desestructurem asChild aquÃ­
  const context = React.useContext(DropdownContext);
  if (!context) throw new Error("DropdownMenuTrigger must be used within DropdownMenu");

  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      ref={ref}
      onClick={(e) => {
        // Si hi ha un onClick original, l'executem
        if (props.onClick) props.onClick(e);
        context.setOpen(!context.open);
      }}
      className={className}
      {...props} // Ara props ja no tÃ© asChild
    >
      {children}
    </Comp>
  );
});
DropdownMenuTrigger.displayName = "DropdownMenuTrigger";

export const DropdownMenuContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & { align?: 'start' | 'end' | 'center' }
>(({ className, align = 'center', children, ...props }, ref) => {
  const context = React.useContext(DropdownContext);
  if (!context) throw new Error("DropdownMenuContent must be used within DropdownMenu");

  if (!context.open) return null;

  const alignmentClasses = {
    start: 'left-0',
    end: 'right-0',
    center: 'left-1/2 -translate-x-1/2',
  };

  return (
    <div
      ref={ref}
      className={cn(
        "absolute z-50 mt-2 min-w-48 overflow-hidden rounded-md border border-border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95",
        alignmentClasses[align],
        className
      )}
      {...props}
    >
      {children}
    </div>
  );
});
DropdownMenuContent.displayName = "DropdownMenuContent";

export interface DropdownMenuItemProps extends React.HTMLAttributes<HTMLDivElement> {
  inset?: boolean;
  asChild?: boolean;
}

export const DropdownMenuItem = React.forwardRef<HTMLDivElement, DropdownMenuItemProps>(
  ({ className, inset, asChild = false, onClick, ...props }, ref) => { // ğŸ‘ˆ Desestructurem asChild aquÃ­ tambÃ©
    const context = React.useContext(DropdownContext);
    
    const handleClick = (e: React.MouseEvent<HTMLDivElement>) => {
      if (onClick) onClick(e);
      context?.setOpen(false); 
    };

    const Comp = asChild ? Slot : "div";

    return (
      <Comp
        ref={ref}
        onClick={handleClick}
        className={cn(
          "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors hover:bg-accent hover:text-accent-foreground data-disabled:pointer-events-none data-disabled:opacity-50",
          inset && "pl-8",
          className
        )}
        {...props} // Props netes sense asChild
      />
    );
  }
);
DropdownMenuItem.displayName = "DropdownMenuItem";

// =================== FILE: src/components/ui/input.tsx ===================

import * as React from "react"
import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.InputHTMLAttributes<HTMLInputElement>>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }

// =================== FILE: src/components/ui/progress.tsx ===================

"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }


// =================== FILE: src/components/ui/select.tsx ===================

"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default"
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  align = "center",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        position={position}
        align={align}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}


// =================== FILE: src/components/ui/tabs.tsx ===================

"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  )
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",
        className
      )}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }


// =================== FILE: src/components/ui/textarea.tsx ===================

import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }


// =================== FILE: src/components/ui/theme-toggle.tsx ===================

"use client"

import * as React from "react"
import { Moon, Sun } from "lucide-react"
import { useTheme } from "next-themes"
import { Button } from "@/components/ui/button"

export function ThemeToggle() {
  const { setTheme, theme } = useTheme()

  return (
    <Button
      variant="ghost"
      size="icon"
      onClick={() => setTheme(theme === "light" ? "dark" : "light")}
      className="relative rounded-full hover:bg-muted transition-colors"
      aria-label="Canviar tema"
    >
      <Sun className="h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0 text-orange-500" />
      <Moon className="absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100 text-blue-400" />
    </Button>
  )
}

// =================== FILE: src/features/analytics/actions.ts ===================

'use server';

import { headers } from 'next/headers';
import { analyticsRepository } from '@/services/container';
import { AnalyticsEventDTO } from '@/types/models';
import { UAParser } from 'ua-parser-js';

type AnalyticsPayload = {
  event_name: string;
  path: string;
  session_id: string;
  referrer?: string;
  duration?: number;
  meta?: Record<string, unknown>;
};

// ğŸ‘‡ 1. DEFINIM EL TIPUS DE RETORN EXPLÃCITAMENT
type TrackEventResponse = {
  success: boolean;
  eventId: number | null; // Pot ser un nÃºmero o null si falla
};

// ğŸ‘‡ 2. APLIQUEM EL TIPUS A LA PROMESA DE LA FUNCIÃ“
export async function trackEventAction(data: AnalyticsPayload): Promise<TrackEventResponse> {
  try {
    const headersList = await headers();
    const userAgent = headersList.get('user-agent') || '';

    // Parseig del User Agent
    const parser = new UAParser(userAgent);
    const result = parser.getResult();

    const isDev = process.env.NODE_ENV === 'development';

    const country = headersList.get('x-vercel-ip-country') || (isDev ? 'ES' : null);
    const city = headersList.get('x-vercel-ip-city') || (isDev ? 'Girona' : null);

    const eventDTO: AnalyticsEventDTO = {
      event_name: data.event_name,
      path: data.path,
      session_id: data.session_id,
      referrer: data.referrer,
      duration: data.duration,
      meta: {
        ...data.meta,
        raw_ua: userAgent,
        screen_resolution: data.meta?.screen_width
      },
      geo: { country, city },
      device: {
        type: result.device.type || 'desktop',
        browser: result.browser.name || 'Unknown',
        os: result.os.name || 'Unknown'
      }
    };

    // Deleguem al repositori
    const eventId = await analyticsRepository.trackEvent(eventDTO);

    // ğŸ‘‡ 3. RETORNEM L'OBJECTE AMB LA FORMA CORRECTA
    return { success: true, eventId };

  } catch (err) {
    console.error("ğŸ’¥ Error en analytics action:", err);
    // ğŸ‘‡ 4. RETORNEM UN FALLBACK SEGUR EN CAS D'ERROR
    return { success: false, eventId: null };
  }
}

// L'acciÃ³ d'actualitzar durada es mantÃ© igual
export async function updateSessionDurationAction(eventId: number, duration: number) {
  try {
    await analyticsRepository.updateDuration(eventId, duration);
    return { success: true };
  } catch (err) {
    console.error("ğŸ’¥ Error en analytics action:", err)
    return { success: false };
  }
}

// =================== FILE: src/features/analytics/ui/AnalyticsTracker.tsx ===================

'use client';

import { useEffect, useRef } from 'react';
import { usePathname, useSearchParams } from 'next/navigation';
import { trackEventAction, updateSessionDurationAction } from '../actions';

export function AnalyticsTracker() {
  const pathname = usePathname();
  const searchParams = useSearchParams();
  
  // âœ… SOLUCIÃ“ 1: Inicialitzem a 0 per evitar l'error "Impure function"
  const startTime = useRef<number>(0); 
  const currentEventId = useRef<number | null>(null);
  const lastPath = useRef<string | null>(null);

  useEffect(() => {
    // 1. GestiÃ³ SessiÃ³
    let sessionId = localStorage.getItem('digitai_session_id');
    if (!sessionId) {
        sessionId = `sess_${Math.random().toString(36).slice(2)}_${Date.now()}`;
        localStorage.setItem('digitai_session_id', sessionId);
    }

    const rawPath = pathname || '/';
    
    // Evitem duplicats en React Strict Mode
    if (lastPath.current === rawPath) return;
    
    // ğŸ›‘ SORTIDA DE PÃ€GINA ANTERIOR
    if (currentEventId.current && startTime.current > 0) {
        const duration = Math.round((Date.now() - startTime.current) / 1000);
        updateSessionDurationAction(currentEventId.current, duration);
    }

    // ğŸš€ ENTRADA A NOVA PÃ€GINA
    lastPath.current = rawPath;
    startTime.current = Date.now(); // âœ… AquÃ­ Ã©s segur cridar Date.now() (dins useEffect)
    
    const track = async () => {
      const response = await trackEventAction({
        event_name: 'page_view',
        path: rawPath,
        session_id: sessionId as string,
        referrer: document.referrer,
        meta: {
           screen_width: window.innerWidth,
           language: navigator.language
        }
      });

      // âœ… SOLUCIÃ“ 2: TypeScript ja no es queixarÃ  perquÃ¨ hem tipat l'acciÃ³ al pas segÃ¼ent
      if (response.success && response.eventId) {
        currentEventId.current = response.eventId;
      }
    };

    track();

    // ğŸ§¹ NETEJA FINAL (Tancar pestanya)
    return () => {
      if (currentEventId.current && startTime.current > 0) {
        const duration = Math.round((Date.now() - startTime.current) / 1000);
        updateSessionDurationAction(currentEventId.current, duration);
      }
    };

  }, [pathname, searchParams]);

  return null;
}

// =================== FILE: src/features/analytics/ui/BarListChart.tsx ===================

'use client';

import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  title: string;
  data: { name: string; value: number; color?: string }[];
};

export function BarListChart({ title, data }: Props) {
  return (
    <Card className="bg-card border-border text-card-foreground h-full flex flex-col shadow-sm">      
      <CardHeader className="py-2 px-3 shrink-0 border-b border-border/30">
        <CardTitle className="text-xs font-bold text-muted-foreground uppercase tracking-wider">{title}</CardTitle>
      </CardHeader>
      <CardContent className="flex-1 min-h-0 px-2 pb-0 pt-2">
        <ResponsiveContainer width="100%" height="100%">
          <BarChart 
            layout="vertical" 
            data={data} 
            margin={{ left: 0, right: 10, bottom: 0, top: 0 }} 
            barCategoryGap={8} // Espai entre barres
          >
            <XAxis type="number" hide />
            <YAxis
              dataKey="name"
              type="category"
              width={75} // Amplada reservada pel text esquerre
              tick={{ fill: 'hsl(var(--muted-foreground))', fontSize: 10, fontWeight: 500 }}
              tickLine={false}
              axisLine={false}
              tickFormatter={(val) => val.length > 9 ? `${val.substring(0, 9)}..` : val}
            />
            <Tooltip 
                cursor={{ fill: 'hsl(var(--muted))', opacity: 0.2 }} 
                contentStyle={{ backgroundColor: 'hsl(var(--popover))', borderColor: 'hsl(var(--border))', fontSize: '11px', color: 'hsl(var(--popover-foreground))', borderRadius: '6px' }} 
            />
            <Bar dataKey="value" radius={[0, 4, 4, 0]} barSize={10} animationDuration={1000}>
              {data.map((entry, index) => (
                <Cell key={`cell-${index}`} fill={entry.color || '#6366f1'} />
              ))}
            </Bar>
          </BarChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/analytics/ui/DeviceChart.tsx ===================

'use client';

import { PieChart, Pie, Cell, Tooltip, ResponsiveContainer, Legend } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  data: { name: string; value: number; fill: string }[];
};

export function DeviceChart({ data }: Props) {
  if (!data || data.length === 0) {
      return (
        <Card className="bg-card border-border h-full flex items-center justify-center text-muted-foreground text-xs p-4">
            Sense dades
        </Card>
      )
  }

  return (
    <Card className="bg-card border-border text-card-foreground h-full flex flex-col shadow-sm">
      <CardHeader className="py-2 px-3 shrink-0 border-b border-border/30">
        <CardTitle className="text-xs font-bold text-muted-foreground uppercase tracking-wider">Dispositius</CardTitle>
      </CardHeader>
      <CardContent className="flex-1 min-h-0 p-0 relative">
        <ResponsiveContainer width="100%" height="100%">
            {/* âœ… CORRECCIÃ“: Afegim 'left' i 'right' a 0 */}
            <PieChart margin={{ top: 0, bottom: 0, left: 0, right: 0 }}>
              <Pie
                data={data}
                cx="50%"
                cy="50%"
                innerRadius="40%" 
                outerRadius="65%"
                paddingAngle={3}
                dataKey="value"
                stroke="hsl(var(--card))"
                strokeWidth={2}
              >
                {data.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.fill} />
                ))}
              </Pie>
              <Tooltip 
                 contentStyle={{ backgroundColor: 'hsl(var(--popover))', borderColor: 'hsl(var(--border))', borderRadius: '6px', color: 'hsl(var(--popover-foreground))', fontSize: '11px' }}
                 itemStyle={{ color: 'hsl(var(--popover-foreground))' }}
              />
              <Legend 
                verticalAlign="bottom" 
                height={28} 
                iconType="circle" 
                iconSize={6}
                wrapperStyle={{ fontSize: '10px', paddingTop: '0px' }}
              />
            </PieChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/analytics/ui/TopPagesCard.tsx ===================

'use client';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  data: { path: string; views: number }[];
};

export function TopPagesCard({ data }: Props) {
  // Ordenar i limitar
  const sortedData = [...data].sort((a, b) => b.views - a.views);
  const maxViews = sortedData[0]?.views || 0;

  return (
    <Card className="bg-card border-border text-card-foreground h-full flex flex-col shadow-sm overflow-hidden">
      <CardHeader className="py-3 px-4 shrink-0 border-b border-border/40 bg-muted/10">
        <div className="flex justify-between items-center">
             <CardTitle className="text-sm font-bold">PÃ gines MÃ©s Visitades</CardTitle>
             <span className="text-[10px] text-muted-foreground uppercase tracking-wider font-bold">Vistes</span>
        </div>
      </CardHeader>
      
      {/* Scrollable Area */}
      <CardContent className="flex-1 overflow-y-auto p-0 min-h-0 custom-scrollbar">
        <div className="flex flex-col">
           {sortedData.length === 0 ? (
                <div className="p-4 text-center text-xs text-muted-foreground">Sense dades</div>
           ) : (
               sortedData.map((page, index) => {
                    const percentage = maxViews > 0 ? (page.views / maxViews) * 100 : 0;
                    return (
                      <div key={index} className="group px-4 py-2.5 border-b border-border/20 last:border-0 hover:bg-muted/30 transition-colors relative">
                        {/* Contingut Text */}
                        <div className="flex justify-between text-xs mb-1.5 relative z-10 font-medium">
                          <span className="truncate pr-4 w-[85%]" title={page.path}>
                            {page.path}
                          </span>
                          <span className="text-foreground font-mono tabular-nums w-[15%] text-right">
                            {page.views}
                          </span>
                        </div>
                        
                        {/* Barra de ProgrÃ©s (Background) */}
                        <div className="h-1.5 w-full bg-muted rounded-full overflow-hidden">
                          <div 
                             className="h-full bg-primary/70 group-hover:bg-primary transition-all duration-500 rounded-full"
                             style={{ width: `${percentage}%` }}
                          />
                        </div>
                      </div>
                    );
               })
           )}
        </div>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/analytics/ui/TrafficChart.tsx ===================

'use client';

import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  data: { date: string; visitors: number; views: number }[];
};

export function TrafficChart({ data }: Props) {
  return (
    // NOTA: Eliminem el <Card> pare si ja l'hem posat al layout, 
    // perÃ² si el deixem, li traiem la vora per no duplicar.
    <div className="h-full w-full flex flex-col">      
      <div className="py-3 px-4 shrink-0 border-b border-border/40">
        <h3 className="text-sm font-bold text-foreground">TrÃ nsit (Ãšltims 7 dies)</h3>
      </div>
      <div className="flex-1 min-h-0 w-full">
        <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={data} margin={{ top: 10, right: 0, left: 0, bottom: 0 }}>
              <defs>
                <linearGradient id="colorViews" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#8884d8" stopOpacity={0.3} />
                  <stop offset="95%" stopColor="#8884d8" stopOpacity={0} />
                </linearGradient>
                <linearGradient id="colorVisitors" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#82ca9d" stopOpacity={0.3} />
                  <stop offset="95%" stopColor="#82ca9d" stopOpacity={0} />
                </linearGradient>
              </defs>
              
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="hsl(var(--border))" opacity={0.4} />
              
              <XAxis 
                dataKey="date" 
                axisLine={false} 
                tickLine={false} 
                tick={{ fontSize: 10, fill: 'hsl(var(--muted-foreground))' }} 
                dy={10}
                interval="preserveStartEnd"
              />
              
              <Tooltip
                contentStyle={{ 
                    backgroundColor: 'hsl(var(--card))', 
                    borderColor: 'hsl(var(--border))', 
                    color: 'hsl(var(--foreground))',
                    borderRadius: '8px',
                    fontSize: '12px',
                    boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'
                }}
              />
              
              <Area type="monotone" dataKey="views" stroke="#8884d8" strokeWidth={2} fillOpacity={1} fill="url(#colorViews)" name="Vistes" />
              <Area type="monotone" dataKey="visitors" stroke="#82ca9d" strokeWidth={2} fillOpacity={1} fill="url(#colorVisitors)" name="Usuaris" />
            </AreaChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
}

// =================== FILE: src/features/analytics/ui/UnifiedStatBar.tsx ===================

import { Card } from '@/components/ui/card';
import { Users, Eye, MousePointerClick, Clock, TrendingUp } from 'lucide-react';

interface UnifiedStatBarProps {
  views: number;
  visitors: number;
  events: number;
  avgTime: string;
}

interface StatItemProps {
  label: string;
  value: number | string;
  icon: React.ReactNode;
}

export function UnifiedStatBar({ views, visitors, events, avgTime }: UnifiedStatBarProps) {
  return (
    // CANVI: bg-card i border-border (s'adapten automÃ ticament)
    <Card className="bg-card border-border text-card-foreground p-4 shadow-sm">
        <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
        
            {/* TÃ­tol */}
            <div className="flex items-center gap-3 lg:pr-8 lg:border-r border-border pb-4 lg:pb-0 border-b lg:border-b-0">
                <div className="p-2 bg-primary/10 rounded-lg">
                    <TrendingUp className="text-primary h-6 w-6" />
                </div>
                <div>
                    <h1 className="text-lg font-bold leading-tight">Dashboard</h1>
                    <p className="text-xs text-muted-foreground">Temps real</p>
                </div>
            </div>

            {/* MÃ¨triques */}
            <div className="flex-1 grid grid-cols-2 gap-y-6 lg:flex lg:justify-around lg:items-center">
                <StatItem label="Vistes (7d)" value={views} icon={<Eye className="h-4 w-4 text-blue-500" />} />
                
                <div className="hidden lg:block h-8 w-px bg-border" />
                
                <StatItem label="Usuaris" value={visitors} icon={<Users className="h-4 w-4 text-green-500" />} />
                
                <div className="hidden lg:block h-8 w-px bg-border" />
                
                <StatItem label="Events" value={events} icon={<MousePointerClick className="h-4 w-4 text-purple-500" />} />
                
                <div className="hidden lg:block h-8 w-px bg-border" />
                
                <StatItem label="Temps MitjÃ " value={avgTime} icon={<Clock className="h-4 w-4 text-orange-500" />} />
            </div>
        </div>
    </Card>
  );
}

function StatItem({ label, value, icon }: StatItemProps) {
    return (
        <div className="flex flex-col items-center gap-1 min-w-[100px]">
            <span className="text-[10px] uppercase tracking-wider text-muted-foreground font-bold flex items-center gap-2">
                {icon} {label}
            </span>
            <span className="text-2xl font-bold leading-none">
                 {value}
            </span>
        </div>
    )
}

// =================== FILE: src/features/analytics/ui/VerticalBarChart.tsx ===================

'use client';

import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, CartesianGrid } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  title: string;
  data: { name: string; value: number; color?: string }[];
};

export function VerticalBarChart({ title, data }: Props) {
  return (
    // 1. Treiem 'col-span-2' perquÃ¨ s'adapti a la columna del sidebar
    <Card className="bg-card border-border text-card-foreground h-full flex flex-col min-h-0 shadow-sm">
      <CardHeader className="py-2 px-3 shrink-0 border-b border-border/30">
        <CardTitle className="text-xs font-bold text-muted-foreground uppercase tracking-wider">{title}</CardTitle>
      </CardHeader>
      <CardContent className="flex-1 min-h-0 p-0 relative">
        <div className="absolute inset-0 pt-2 pb-1 pr-2 pl-0">
            <ResponsiveContainer width="100%" height="100%">
            <BarChart 
                data={data} 
                // 2. Ajustem marges: 'left: -20' era el problema. Posem 0 i deixem que YAxis gestioni l'ample.
                margin={{ top: 10, right: 0, left: 0, bottom: 0 }}
            >
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="hsl(var(--border))" opacity={0.4} />
                
                <XAxis 
                    dataKey="name" 
                    stroke="hsl(var(--muted-foreground))"
                    fontSize={10} 
                    tickLine={false}
                    axisLine={false}
                    interval={0}
                    // Trunquem a 3 lletres (codi paÃ­s) o pocs carÃ cters per evitar solapament
                    tickFormatter={(value) => value.substring(0, 3).toUpperCase()}
                    dy={5}
                />
                
                <YAxis 
                    stroke="hsl(var(--muted-foreground))"
                    fontSize={10} 
                    tickLine={false} 
                    axisLine={false} 
                    width={30} // Espai fix petit per als nÃºmeros de l'esquerra
                />
                
                <Tooltip 
                    cursor={{ fill: 'hsl(var(--muted))', opacity: 0.2 }}
                    contentStyle={{ 
                        backgroundColor: 'hsl(var(--popover))', 
                        borderColor: 'hsl(var(--border))', 
                        color: 'hsl(var(--popover-foreground))', 
                        borderRadius: '6px', 
                        fontSize: '11px',
                        padding: '8px'
                    }}
                    itemStyle={{ color: 'hsl(var(--popover-foreground))' }}
                />
                
                <Bar dataKey="value" radius={[4, 4, 0, 0]} animationDuration={1000}>
                    {data.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color || '#10b981'} />
                    ))}
                </Bar>
            </BarChart>
            </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/audit/actions.ts ===================

'use server';

import { auditService } from '@/services/container';
import { z } from 'zod';
import { redirect } from 'next/navigation';
import { getLocale } from 'next-intl/server';
import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/server'; // Necessitem client admin per comprovar usuaris
// --- 1. SCHEMAS DE VALIDACIÃ“ ---

const PublicAuditSchema = z.object({
  url: z.string().url({ message: "La URL ha de ser vÃ lida (https://...)" }),
  email: z.string().email({ message: "L'email no Ã©s correcte" }),
});

const PrivateAuditSchema = z.string().url();

// --- 2. TIPUS PER A ELS FORMULARIS ---

export type FormState = {
  success?: boolean;
  message?: string;
  errors?: {
    url?: string[];
    email?: string[];
  };
};







export async function processWebAudit(
  prevState: FormState, 
  formData: FormData
): Promise<FormState> {
  const locale = await getLocale();

  const rawData = {
    url: formData.get('url'),
    email: formData.get('email'),
  };

  const validation = PublicAuditSchema.safeParse(rawData);
  if (!validation.success) {
    return {
      success: false,
      errors: validation.error.flatten().fieldErrors,
      message: "Revisa les dades del formulari.",
    };
  }

  const email = validation.data.email.toLowerCase().trim();
  const url = validation.data.url;

  try {
    // 1. Executar Auditoria
    await auditService.performPublicAudit(url, email, locale);
    
    // 2. âœ¨ LÃ’GICA MILLORADA: DETECCIÃ“ PER ORG_ID âœ¨
    const supabaseAdmin = createAdminClient();
    
    // Aquest Ã©s l'ID de la teva organitzaciÃ³ principal (DigitAI Studios)
    // IDEALMENT: Posa aixÃ² al .env com NEXT_PUBLIC_MAIN_ORG_ID
    const MAIN_ORG_ID = '2f1e89dd-0b95-4f7b-ab31-14a9916d374f';

    // Busquem si aquest email tÃ© un perfil DINS de la teva organitzaciÃ³
    const { data: existingProfile } = await supabaseAdmin
      .from('profiles')
      .select('id')
      .ilike('email', email)
      .eq('organization_id', MAIN_ORG_ID) // ğŸ‘ˆ EL FILTRE CLAU
      .maybeSingle();

    const encodedEmail = encodeURIComponent(email);

    if (existingProfile) {
      console.log(`âœ… Client existent detectat a l'Org (${email}). Redirigint a Login.`);
      // Si existeix a LA TEVA org -> Login
      redirect(`/${locale}/auth/login?email=${encodedEmail}&next=/dashboard`);
    } else {
      console.log(`ğŸ†• Nou Lead per a l'Org (${email}). Redirigint a Registre.`);
      // Si no existeix a la teva org (encara que tingui compte a altres),
      // l'enviem al registre perquÃ¨ es creÃ¯ el perfil a la teva org.
      redirect(`/${locale}/auth/register?email=${encodedEmail}`);
    }

  } catch (err) {
    if ((err as Error).message === 'NEXT_REDIRECT') {
        throw err;
    }

    console.error("Error processWebAudit:", err);
    return { success: false, message: "Error tÃ¨cnic durant l'anÃ lisi. Torna-ho a provar." };
  }
  
  return { success: true }; 
}

// --- 4. ACTION PRIVADA (Dashboard) ---
// Aquesta Ã©s la que crida el CreateAuditForm del panell
export async function createAuditAction(url: string) {
  const locale = await getLocale();
  let auditId = null;

  // 1. Validem nomÃ©s URL
  const validation = PrivateAuditSchema.safeParse(url);
  if (!validation.success) {
    return { success: false, message: 'URL invÃ lida.' };
  }

  // 2. Comprovem sessiÃ³
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user || !user.email) {
    return { success: false, message: 'No estÃ s autenticat.' };
  }

  try {
    // 3. Cridem al servei per fer l'auditoria PRIVADA (ja tenim user.id)
    auditId = await auditService.performUserAudit(url, user.id, user.email, locale);

  } catch (e) {
    console.error(e);
    return { success: false, message: 'Error al processar l\'auditoria.' };
  }

  // 4. RedirecciÃ³ al detall de l'informe
  if (auditId) {
    redirect(`/${locale}/dashboard/audits/${auditId}`);
  }
  
  return { success: false, message: 'Error desconegut al crear.' };
}


// =================== FILE: src/features/audit/ui/AuditForm.tsx ===================

'use client';

import { useActionState } from 'react';
import { processWebAudit } from '../actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Search, Loader2, AlertCircle } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function AuditForm() {
  const [state, action, isPending] = useActionState(processWebAudit, { message: '', errors: {} });
  const t = useTranslations('AuditForm');

  return (
    <div className="w-full">
      <div className="border border-border rounded-2xl p-8 bg-white/50 dark:bg-white/2 backdrop-blur-xl shadow-xl dark:shadow-2xl transition-all duration-300">
        
        <h3 className="text-xl font-bold text-center text-foreground mb-6 flex items-center justify-center gap-2">
          <Search className="w-5 h-5 text-primary" />
          {t('title')}
        </h3>
        
        <form action={action} className="space-y-4">
          <div className="space-y-1">
            <Input 
              name="url" 
              placeholder={t('placeholder_url')} 
              className="bg-white dark:bg-white/5 border-slate-200 dark:border-white/10 text-foreground h-12 focus:border-primary/50 placeholder:text-muted-foreground transition-all"
            />
            {state.errors?.url && (
              <p className="text-red-500 text-xs flex items-center gap-1 mt-1 ml-1">
                <AlertCircle className="w-3 h-3" /> {state.errors.url[0]}
              </p>
            )}
          </div>

          <div className="space-y-1">
            <Input 
              name="email" 
              placeholder={t('placeholder_email')} 
              className="bg-white dark:bg-white/5 border-slate-200 dark:border-white/10 text-foreground h-12 focus:border-primary/50 placeholder:text-muted-foreground transition-all"
            />
            {state.errors?.email && (
              <p className="text-red-500 text-xs flex items-center gap-1 mt-1 ml-1">
                <AlertCircle className="w-3 h-3" /> {state.errors.email[0]}
              </p>
            )}
          </div>

          <Button 
            type="submit" 
            disabled={isPending} 
            className="w-full h-12 mt-2 text-base font-semibold rounded-lg gradient-bg text-white border-0 hover:opacity-90 shadow-lg shadow-primary/20 transition-all"
          >
            {isPending ? (
              <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> {t('cta_loading')}</>
            ) : (
              t('cta_button')
            )}
          </Button>
          
          {state.message && (
            <p className="text-center text-muted-foreground text-sm mt-4 bg-muted/50 p-2 rounded-lg border border-border/50">
              {state.message}
            </p>
          )}
        </form>
      </div>
      
      <p className="text-center text-xs text-muted-foreground mt-4 opacity-60">
        {t('privacy_note')}
      </p>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/AuditHeader.tsx ===================

import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Share2 } from 'lucide-react';
// ğŸ‘‡ Importem el botÃ³ real
import { DownloadAuditButton } from './DownloadAuditButton';
// ğŸ‘‡ 1. Importem el tipus correcte per als issues
import { AuditIssue } from '@/adapters/IWebScanner';

type Props = { 
  url: string; 
  date: Date;
  pdfData: {
    url: string;
    date: string;
    scores: { seo: number; perf: number; a11y: number; best: number };
    screenshot?: string;
    // ğŸ‘‡ 2. Corregim 'any[]' per 'AuditIssue[]'
    issues: AuditIssue[];
    
  }
};

export function AuditHeader({ url, date, pdfData }: Props) {
  return (
    <div className="flex flex-col md:flex-row md:items-center justify-between gap-6 border-b border-white/5 pb-6">
      <div>
        <Link href="/dashboard" className="text-xs font-medium text-slate-400 hover:text-primary flex items-center gap-1 mb-3 transition-colors uppercase tracking-wider">
          <ArrowLeft className="w-3 h-3" /> Tornar al Dashboard
        </Link>
        <h1 className="text-3xl md:text-4xl font-bold text-white tracking-tight truncate max-w-2xl">
          Informe: <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-primary">{url}</span>
        </h1>
        <p className="text-sm text-slate-500 mt-2 font-mono">
          ID: {date.getTime().toString(36).toUpperCase()} â€¢ Generat el {date.toLocaleDateString()}
        </p>
      </div>
      
      <div className="flex gap-3">
        <Button variant="outline" className="border-slate-700 text-slate-300 hover:bg-slate-800 hover:text-white">
            <Share2 className="w-4 h-4 mr-2" /> Compartir
        </Button>
        
        {/* BotÃ³ de descarrega */}
        <DownloadAuditButton data={pdfData} />
      </div>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/CoreVitalsGrid.tsx ===================

import { Zap, LayoutTemplate, MoveHorizontal, Clock, Gauge } from 'lucide-react';

// Tipus locals per la UI (no cal importar el Zod schema aquÃ­, per mantenir desacoblament)
export type AuditMetric = {
  score?: number | null;
  value?: string;
  description?: string;
};

type LighthouseAuditUI = {
  id: string;
  title?: string;
  description?: string;
  score?: number | null;
  displayValue?: string;
};

type CoreVitalsGridProps = {
  metrics?: {
    fcp?: AuditMetric;
    lcp?: AuditMetric;
    cls?: AuditMetric;
    tbt?: AuditMetric;
    si?: AuditMetric;
  };
  googleAudits?: Record<string, LighthouseAuditUI>;
};

export function CoreVitalsGrid({ metrics, googleAudits }: CoreVitalsGridProps) {
  
  const getMetric = (key: string, googleKey: string): AuditMetric => {
    // 1. Prioritat: Dades netes processades
    if (metrics && metrics[key as keyof typeof metrics]) {
      return metrics[key as keyof typeof metrics]!;
    }
    
    // 2. Fallback: Dades crues
    if (googleAudits && googleAudits[googleKey]) {
      const audit = googleAudits[googleKey];
      return {
        score: audit.score,
        value: audit.displayValue,
        description: audit.title
      };
    }

    return { score: null, value: 'N/A', description: 'No disponible' };
  };

  const fcp = getMetric('fcp', 'first-contentful-paint');
  const lcp = getMetric('lcp', 'largest-contentful-paint');
  const cls = getMetric('cls', 'cumulative-layout-shift');
  const tbt = getMetric('tbt', 'total-blocking-time');
  const si = getMetric('si', 'speed-index');

  // Si no hi ha dades, no pintem res
  if (fcp.value === 'N/A' && lcp.value === 'N/A') return null;

  return (
    <div className="mb-8">
      <h2 className="text-xl font-bold text-foreground mb-4 flex items-center gap-2">
        <span className="w-1.5 h-6 bg-primary rounded-full"></span>
        MÃ¨triques de Rendiment (Core Web Vitals)
      </h2>
      
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
        <MetricCard title="FCP" subtitle="First Contentful Paint" value={fcp.value || "N/A"} score={fcp.score} icon={Zap} tooltip="Temps fins primer contingut." />
        <MetricCard title="LCP" subtitle="Largest Contentful Paint" value={lcp.value || "N/A"} score={lcp.score} icon={LayoutTemplate} tooltip="Temps element mÃ©s gran." />
        <MetricCard title="CLS" subtitle="Cumulative Layout Shift" value={cls.value || "N/A"} score={cls.score} icon={MoveHorizontal} tooltip="Estabilitat visual." />
        <MetricCard title="TBT" subtitle="Total Blocking Time" value={tbt.value || "N/A"} score={tbt.score} icon={Clock} tooltip="Temps de bloqueig." />
        <MetricCard title="SI" subtitle="Speed Index" value={si.value || "N/A"} score={si.score} icon={Gauge} tooltip="Ãndex de velocitat." />
      </div>
    </div>
  );
}

// ... (El component MetricCard es queda igual que al teu codi original)
type MetricCardProps = {
    title: string;
    subtitle: string;
    value: string;
    score?: number | null;
    icon: React.ElementType;
    tooltip?: string;
};
  
function MetricCard({ title, subtitle, value, score, icon: Icon, tooltip }: MetricCardProps) {
    let colorClass = 'text-slate-500 dark:text-slate-400';
    let bgClass = 'bg-slate-100 border-slate-200 dark:bg-slate-800/50 dark:border-slate-700';
    let iconColor = 'text-slate-400';

    if (typeof score === 'number') {
        if (score >= 0.9) {
            colorClass = 'text-green-600 dark:text-green-400';
            bgClass = 'bg-green-50 border-green-200 dark:bg-green-500/10 dark:border-green-500/20';
            iconColor = 'text-green-500';
        } else if (score >= 0.5) {
            colorClass = 'text-yellow-600 dark:text-yellow-400';
            bgClass = 'bg-yellow-50 border-yellow-200 dark:bg-yellow-500/10 dark:border-yellow-500/20';
            iconColor = 'text-yellow-500';
        } else {
            colorClass = 'text-red-600 dark:text-red-400';
            bgClass = 'bg-red-50 border-red-200 dark:bg-red-500/10 dark:border-red-500/20';
            iconColor = 'text-red-500';
        }
    }

    return (
        <div className={`p-4 rounded-xl border ${bgClass} flex flex-col items-center text-center transition-all hover:scale-[1.02] h-full justify-between`} title={tooltip}>
            <div className="flex flex-col items-center">
                <div className={`mb-3 p-2.5 rounded-full bg-background/50 ${iconColor}`}>
                    <Icon className="w-5 h-5" />
                </div>
                <span className="text-sm font-bold text-foreground mb-1">{title}</span>
                <span className="text-[10px] text-muted-foreground uppercase tracking-wide mb-2 px-2 line-clamp-1">{subtitle}</span>
            </div>
            <span className={`text-2xl font-extrabold ${colorClass}`}>{value}</span>
        </div>
    )
}

// =================== FILE: src/features/audit/ui/components/CreateAuditForm.tsx ===================

'use client';

import { useState } from 'react';
// Ja no necessitem useRouter ni router.push!
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Loader2, Search, Globe } from 'lucide-react';
import { createAuditAction } from '../../actions';

export function CreateAuditForm() {
  const [url, setUrl] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError('');

    // Cridem a l'acciÃ³.
    // Si tÃ© Ã¨xit, l'acciÃ³ farÃ  redirect i aquesta funciÃ³ s'aturarÃ  aquÃ­.
    // Si falla, ens retornarÃ  l'objecte amb l'error.
    const result = await createAuditAction(url);
    
    // Si arribem a aquesta lÃ­nia, vol dir que NO ha redirigit (per tant, hi ha hagut error)
    if (result && !result.success) {
        setError(result.message || 'Error desconegut');
        setIsLoading(false); // NomÃ©s parem loading si hi ha error
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="space-y-2">
         <label className="text-sm font-medium text-slate-300 ml-1">URL del Lloc Web</label>
         <div className="relative">
            <Globe className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500" />
            <Input 
               type="url" 
               placeholder="https://exemple.com" 
               value={url}
               onChange={(e) => setUrl(e.target.value)}
               required
               disabled={isLoading} // Desactivem mentre carrega
               className="pl-10 bg-white/5 border-white/10 text-white h-12 focus:border-primary focus:ring-primary placeholder:text-slate-600"
            />
         </div>
      </div>

      {error && (
         <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm">
            {error}
         </div>
      )}

      <Button 
         type="submit" 
         disabled={isLoading || !url} 
         className="w-full h-12 gradient-bg text-white font-bold rounded-xl hover:opacity-90 transition-all shadow-lg shadow-primary/20"
      >
         {isLoading ? (
            <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Analitzant Web...</>
         ) : (
            <><Search className="w-4 h-4 mr-2" /> ComenÃ§ar AnÃ lisi</>
         )}
      </Button>
      
      <p className="text-xs text-center text-slate-500">
         L'anÃ lisi pot trigar entre 10 i 30 segons. Si us plau, no tanquis la pÃ gina.
      </p>
    </form>
  );
}

// =================== FILE: src/features/audit/ui/components/DownloadAuditButton.tsx ===================

'use client';

import React from 'react';
import dynamic from 'next/dynamic';
import { Button } from '@/components/ui/button';
import { Download, Loader2 } from 'lucide-react';
// Assegura't que el nom del fitxer coincideix exactament (MajÃºscules/minÃºscules)
import { AuditPDFDocument } from '@/features/audit/ui/pdf/AuditPdfDocument'; 
import { AuditIssue } from '@/adapters/IWebScanner';

const PDFDownloadLink = dynamic(
  () => import('@react-pdf/renderer').then((mod) => mod.PDFDownloadLink),
  { 
    ssr: false,
    loading: () => (
      <Button variant="outline" disabled className="bg-background text-muted-foreground border-border">
         <Loader2 className="w-4 h-4 mr-2 animate-spin" /> Preparant PDF...
      </Button>
    )
  }
);

type Props = {
  data: {
    url: string;
    date: string;
    scores: { seo: number; perf: number; a11y: number; best: number };
    screenshot?: string;
    issues: AuditIssue[]; 
  }
};

export function DownloadAuditButton({ data }: Props) {
  return (
    <PDFDownloadLink
      document={
        <AuditPDFDocument 
            url={data.url}
            date={data.date}
            scores={data.scores}
            screenshot={data.screenshot}
            issues={data.issues}
        />
      }
      fileName={`audit-${data.url.replace(/[^a-z0-9]/gi, '_')}.pdf`}
    >
      {({ loading }) => (
        <Button 
            // Canviem l'estil perquÃ¨ sigui consistent amb el tema
            className="bg-primary text-primary-foreground hover:bg-primary/90 shadow-sm"
            disabled={loading}
        >
          {loading ? (
            <>
               <Loader2 className="w-4 h-4 mr-2 animate-spin" /> Generant...
            </>
          ) : (
            <>
               <Download className="w-4 h-4 mr-2" /> Descarregar PDF
            </>
          )}
        </Button>
      )}
    </PDFDownloadLink>
  );
}

// =================== FILE: src/features/audit/ui/components/IssuesList.tsx ===================

'use client'; // Important: useTranslations funciona en Client Components o Server Components, perÃ² aquÃ­ ja Ã©s client.

import { Card, CardContent } from '@/components/ui/card';
import { AlertTriangle, CheckCircle } from 'lucide-react';
import { AuditIssue } from '@/adapters/IWebScanner';
import { useTranslations } from 'next-intl';

type Props = { issues: AuditIssue[] };

export function IssuesList({ issues }: Props) {
  const t = useTranslations('AuditIssues'); // namespace 'AuditIssues'

  return (
    <div className="mt-12">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-foreground flex items-center gap-2">
           <AlertTriangle className="text-yellow-500" />
           {/* Pots traduir tambÃ© aquest tÃ­tol si vols */}
           Accions Recomanades
        </h2>
        <span className="bg-red-500/10 text-red-600 dark:text-red-400 text-xs font-bold px-3 py-1 rounded-full border border-red-500/20">
           {issues?.length || 0} Errors CrÃ­tics
        </span>
      </div>
      
      <div className="grid gap-4">
        {issues?.map((issue, index) => {
           // LÃ’GICA DE TRADUCCIÃ“ INTELÂ·LIGENT
           // 1. Mirem si tenim traducciÃ³ per aquest ID especÃ­fic (ex: 'server-response-time.title')
           // 2. Si no, fem servir el text original que ve de Google (fallback)
           
           const hasTranslation = t.has(`${issue.id}.title`);
           const title = hasTranslation ? t(`${issue.id}.title`) : issue.title;
           const description = hasTranslation ? t(`${issue.id}.description`) : issue.description;

           return (
             <Card key={index} className="bg-card border border-border hover:border-primary/50 transition-colors group shadow-sm">
                <CardContent className="p-5 flex gap-4">
                   <div className="shrink-0 mt-1">
                      <div className="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
                   </div>
                   <div className="flex-1">
                      <h3 className="font-bold text-foreground group-hover:text-primary transition-colors text-lg mb-1">
                          {title}
                      </h3>
                      <p className="text-sm text-muted-foreground leading-relaxed mb-3">
                          {description}
                      </p>
                      {issue.displayValue && (
                          <div className="inline-flex items-center gap-2 px-3 py-1 rounded bg-red-500/5 border border-red-500/10 text-xs font-mono text-red-600 dark:text-red-400">
                              <span>Dada:</span>
                              <span className="font-bold">{issue.displayValue}</span>
                          </div>
                      )}
                   </div>
                </CardContent>
             </Card>
           );
        })}
        
        {(!issues || issues.length === 0) && (
            <div className="text-center py-12 bg-muted/30 rounded-xl border border-dashed border-border">
                <CheckCircle className="w-12 h-12 text-green-500 mx-auto mb-4 opacity-50" />
                <p className="text-muted-foreground">IncreÃ¯ble! No hem trobat errors crÃ­tics.</p>
            </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/MobilePreviw.tsx ===================

import Image from 'next/image';

export function MobilePreview({ screenshot }: { screenshot: string }) {
  if (!screenshot) return null;
  
  return (
    <div className="mt-8 flex flex-col items-center">
      <h2 className="text-xl font-bold text-white mb-6">Vista PrÃ¨via MÃ²bil</h2>
      {/* Mockup Minimalista Fosc */}
      <div className="relative border-slate-800 bg-slate-900 border-[10px] rounded-[2.5rem] h-[600px] w-[300px] shadow-2xl shadow-black">
         <div className="h-[32px] w-[3px] bg-slate-800 absolute -start-[13px] top-[72px] rounded-s-lg"></div>
         <div className="h-[46px] w-[3px] bg-slate-800 absolute -start-[13px] top-[124px] rounded-s-lg"></div>
         <div className="h-[46px] w-[3px] bg-slate-800 absolute -start-[13px] top-[178px] rounded-s-lg"></div>
         <div className="h-[64px] w-[3px] bg-slate-800 absolute -end-[13px] top-[142px] rounded-e-lg"></div>
         <div className="rounded-[2rem] overflow-hidden w-[280px] h-[580px] bg-black">
            <Image
                src={screenshot}
                alt="Mobile Screenshot"
                width={280}
                height={580}
                className="w-full h-full object-cover opacity-90 hover:opacity-100 transition-opacity"
                unoptimized
            />
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/ScoreGrid.tsx ===================

import { Card, CardContent } from '@/components/ui/card';
import { ScoreRing } from '@/components/charts/ScoreRing';

type Props = { seo: number; perf: number };

export function ScoreGrid({ seo, perf }: Props) {
  return (
    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
      <ScoreCard score={seo} label="SEO" />
      <ScoreCard score={perf} label="Rendiment" />
      <ScoreCard score={85} label="Accessibilitat" />
      <ScoreCard score={92} label="Best Practices" />
    </div>
  );
}

function ScoreCard({ score, label }: { score: number; label: string }) {
  return (
    // Canviem bg-[#0f111a]/50 per bg-background/40 o bg-card
    <Card className="bg-background/40 border border-border hover:border-primary/20 transition-colors backdrop-blur-md shadow-sm">
      <CardContent className="pt-6 pb-6 flex justify-center">
        <ScoreRing score={score} label={label} />
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/audit/ui/pdf/AuditPdfDocument.tsx ===================

import React from 'react';
import { Page, Text, View, Document, StyleSheet, Image } from '@react-pdf/renderer';

// Definim els tipus de dades que necessitem
type Issue = {
  title: string;
  description: string;
};

type Props = {
  url: string;
  date: string;
  scores: { seo: number; perf: number; a11y: number; best: number };
  screenshot?: string;
  issues: Issue[];
};

// ESTILS DEL PDF (Semblant a CSS perÃ² en objecte JS)
const styles = StyleSheet.create({
  page: {
    flexDirection: 'column',
    backgroundColor: '#0f111a', // Fons fosc
    color: '#ffffff',
    padding: 30,
    fontFamily: 'Helvetica',
  },
  header: {
    marginBottom: 20,
    borderBottomWidth: 1,
    borderBottomColor: '#334155',
    paddingBottom: 10,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  title: { fontSize: 24, fontWeight: 'bold', color: '#ffffff' },
  subtitle: { fontSize: 10, color: '#94a3b8', marginTop: 4 },
  brand: { fontSize: 10, color: '#7c3aed', textTransform: 'uppercase' }, // Lila de marca
  
  // Grid de Puntuacions
  scoresContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 30,
    backgroundColor: '#1e293b',
    padding: 15,
    borderRadius: 8,
  },
  scoreItem: { alignItems: 'center', width: '25%' },
  scoreValue: { fontSize: 28, fontWeight: 'bold' },
  scoreLabel: { fontSize: 10, color: '#94a3b8', marginTop: 4, textTransform: 'uppercase' },

  // SecciÃ³ MÃ²bil
  sectionTitle: { fontSize: 16, marginBottom: 10, color: '#ffffff', marginTop: 10 },
  imageContainer: {
    alignItems: 'center',
    marginBottom: 20,
    padding: 10,
    backgroundColor: '#1e293b',
    borderRadius: 8,
  },
  screenshot: { width: 200, height: 400, borderRadius: 4, objectFit: 'contain' },

  // Llista d'Errors
  issueCard: {
    marginBottom: 8,
    padding: 10,
    backgroundColor: '#ffffff', // Targetes blanques per contrast de lectura
    borderRadius: 4,
    borderLeftWidth: 4,
    borderLeftColor: '#ef4444', // Vermell error
  },
  issueTitle: { fontSize: 12, color: '#0f111a', fontWeight: 'bold' },
  issueDesc: { fontSize: 10, color: '#475569', marginTop: 2 },
  
  footer: {
    position: 'absolute',
    bottom: 30,
    left: 30,
    right: 30,
    textAlign: 'center',
    fontSize: 8,
    color: '#64748b',
    borderTopWidth: 1,
    borderTopColor: '#334155',
    paddingTop: 10,
  }
});

// Helper per colors
const getScoreColor = (score: number) => {
  if (score >= 90) return '#4ade80'; // Verd
  if (score >= 50) return '#facc15'; // Groc
  return '#f87171'; // Vermell
};

export const AuditPDFDocument = ({ url, date, scores, screenshot, issues }: Props) => (
  <Document>
    <Page size="A4" style={styles.page}>
      
      {/* 1. HEADER */}
      <View style={styles.header}>
        <View>
            <Text style={styles.brand}>DigitAI Studios Audit</Text>
            <Text style={styles.title}>Informe d'Auditoria</Text>
            <Text style={styles.subtitle}>{url}</Text>
        </View>
        <View>
            <Text style={styles.subtitle}>{date}</Text>
        </View>
      </View>

      {/* 2. PUNTUACIONS */}
      <View style={styles.scoresContainer}>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.seo) }]}>{scores.seo}</Text>
            <Text style={styles.scoreLabel}>SEO</Text>
        </View>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.perf) }]}>{scores.perf}</Text>
            <Text style={styles.scoreLabel}>Rendiment</Text>
        </View>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.a11y) }]}>{scores.a11y}</Text>
            <Text style={styles.scoreLabel}>Accessibilitat</Text>
        </View>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.best) }]}>{scores.best}</Text>
            <Text style={styles.scoreLabel}>Best Practices</Text>
        </View>
      </View>

      {/* 3. CAPTURA DE PANTALLA (Si n'hi ha) */}
      {screenshot && (
        <View style={styles.imageContainer}>
            <Text style={[styles.subtitle, { marginBottom: 10 }]}>Vista PrÃ¨via Dispositiu MÃ²bil</Text>
            <Image src={screenshot} style={styles.screenshot} />
        </View>
      )}

      {/* 4. LLISTA D'ERRORS */}
      <Text style={styles.sectionTitle}>Accions Recomanades ({issues.length})</Text>
      {issues.slice(0, 8).map((issue, index) => ( // Limitem a 8 per no fer 50 pÃ gines de cop
        <View key={index} style={styles.issueCard}>
            <Text style={styles.issueTitle}>{issue.title}</Text>
            <Text style={styles.issueDesc}>{issue.description}</Text>
        </View>
      ))}

      {/* 5. FOOTER */}
      <Text style={styles.footer}>
        Generat automÃ ticament per DigitAI Studios. Aquest informe Ã©s privat i confidencial.
        Visita'ns a https://digitaistudios.com per a mÃ©s serveis.
      </Text>

    </Page>
  </Document>
);

// =================== FILE: src/features/auth/actions/auth.ts ===================

'use server';

import { createClient } from '@/lib/supabase/server';

export async function signOutAction() {
  const supabase = await createClient();
  
  // 1. Tanquem sessiÃ³ al servidor (neteja cookies)
  await supabase.auth.signOut();
return { success: true };
}

// =================== FILE: src/features/auth/actions/reset-password.ts ===================

// =================== FILE: src/features/auth/actions/reset-password.ts ===================

'use server'

import { z } from 'zod';
import { createClient } from '@/lib/supabase/server';
import { getLocale } from 'next-intl/server';
import { redirect } from '@/routing'; // Usem el teu routing tipat

// Esquema per solÂ·licitar el reset
const ForgotPasswordSchema = z.object({
  email: z.string().email({ message: "L'email no Ã©s vÃ lid." }),
});

// Esquema per actualitzar la contrasenya
const ResetPasswordSchema = z.object({
  password: z.string().min(6, { message: "La contrasenya ha de tenir mÃ­nim 6 carÃ cters." }),
  confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
  message: "Les contrasenyes no coincideixen",
  path: ["confirmPassword"],
});

export type AuthState = {
  message?: string;
  success?: boolean;
  errors?: Record<string, string[]>;
};

/**
 * 1. L'usuari demana restablir la contrasenya via email
 */
export async function requestPasswordReset(prevState: AuthState, formData: FormData): Promise<AuthState> {
  const email = formData.get('email') as string;
  const locale = await getLocale();

  const validated = ForgotPasswordSchema.safeParse({ email });

  if (!validated.success) {
    return { errors: validated.error.flatten().fieldErrors };
  }

  const supabase = await createClient();
  
  // Aquest URL Ã©s on anirÃ  l'usuari desprÃ©s de fer clic al correu.
  // IMPORTANT: Redirigim al callback, que intercanviarÃ  el codi per sessiÃ³,
  // i desprÃ©s el callback redirigirÃ  a /auth/reset-password
  const redirectUrl = `${process.env.NEXT_PUBLIC_BASE_URL}/${locale}/auth/callback?next=/auth/reset-password`;

  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: redirectUrl,
  });

  if (error) {
    // Per seguretat, a vegades Ã©s millor no dir si l'email existeix o no, 
    // perÃ² per UX aquÃ­ mostrem l'error si Ã©s genÃ¨ric.
    return { message: error.message, success: false };
  }

  return { 
    success: true, 
    message: "Si l'email existeix, rebrÃ s un enllaÃ§ per restablir la contrasenya." 
  };
}

/**
 * 2. L'usuari (ja autenticat via link mÃ gic) posa la nova contrasenya
 */
export async function updatePassword(prevState: AuthState, formData: FormData): Promise<AuthState> {
  const password = formData.get('password') as string;
  const confirmPassword = formData.get('confirmPassword') as string;

  const validated = ResetPasswordSchema.safeParse({ password, confirmPassword });

  if (!validated.success) {
    return { errors: validated.error.flatten().fieldErrors };
  }

  const supabase = await createClient();

  const { error } = await supabase.auth.updateUser({
    password: validated.data.password
  });

  if (error) {
    return { message: "Error actualitzant la contrasenya.", success: false };
  }

  // Si tot va bÃ©, redirigim al dashboard
  const locale = await getLocale();
  redirect({ href: '/dashboard', locale });
  return { success: true }; // Codi mort per la redirecciÃ³, perÃ² necessari per TS
}

// =================== FILE: src/features/auth/ui/ForgotPasswordForm.tsx ===================

// =================== FILE: src/features/auth/ui/ForgotPasswordForm.tsx ===================

'use client'

import { useActionState } from 'react';
import { useTranslations } from 'next-intl';
import { requestPasswordReset } from '../actions/reset-password';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent } from '@/components/ui/card';
import { Loader2, CheckCircle2 } from 'lucide-react';

export function ForgotPasswordForm() {
  const t = useTranslations('Auth'); // Assegura't de tenir les traduccions
  
  const [state, action, isPending] = useActionState(requestPasswordReset, {
    message: '',
    errors: {}
  });

  if (state.success) {
    return (
      <Card className="border-green-200 bg-green-50">
        <CardContent className="pt-6 text-center space-y-4">
          <CheckCircle2 className="w-12 h-12 text-green-600 mx-auto" />
          <p className="text-green-800 font-medium">{state.message}</p>
          <p className="text-sm text-green-700">Revisa la teva safata d'entrada.</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardContent className="pt-6">
        <form action={action} className="space-y-4">
          <div className="space-y-2">
            <label htmlFor="email" className="text-sm font-medium">Email</label>
            <Input 
              id="email" 
              name="email" 
              type="email" 
              placeholder="tu@exemple.com"
              className={state.errors?.email ? "border-red-500" : ""}
            />
            {state.errors?.email && (
              <p className="text-sm text-red-500">{state.errors.email[0]}</p>
            )}
          </div>

          {state.message && !state.success && (
            <p className="text-sm text-red-500 text-center bg-red-50 p-2 rounded">{state.message}</p>
          )}

          <Button type="submit" className="w-full" disabled={isPending}>
            {isPending ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : "Enviar enllaÃ§ de recuperaciÃ³"}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/auth/ui/LoginForm.tsx ===================

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { createClient } from '@/lib/supabase/client';
import { Loader2, LogIn } from 'lucide-react';
import { useRouter } from '@/routing';
import Link from 'next/link';
import { useTranslations } from 'next-intl';
import { GoogleIcon } from '@/components/icons/GoogleIcon';
import { toast } from 'sonner';

// Props tipats
interface LoginFormProps {
  prefilledEmail?: string;
}

export function LoginForm({ prefilledEmail }: LoginFormProps) {
  const t = useTranslations('Auth');
  // Inicialitzem l'estat amb la prop si existeix
  const [email, setEmail] = useState(prefilledEmail || '');
  const [password, setPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isGoogleLoading, setIsGoogleLoading] = useState(false);
  
  const router = useRouter();
  const supabase = createClient();

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    const { error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      toast.error(error.message);
      setIsLoading(false);
    } else {
      router.refresh();
      // Si venim d'una auditoria, potser voldrÃ­em anar al dashboard directament
      // (Supabase gestionarÃ  la sessiÃ³)
      router.push('/dashboard');
    }
  };

  const handleGoogleLogin = async () => {
    setIsGoogleLoading(true);
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: `${window.location.origin}/auth/callback`,
        queryParams: { access_type: 'offline', prompt: 'consent' },
      },
    });
    if (error) {
        toast.error(error.message);
        setIsGoogleLoading(false);
    }
  };

  return (
    <div className="w-full max-w-md mx-auto space-y-6">
      <div className="text-center space-y-2">
        <h1 className="text-3xl font-bold text-foreground">{t('login_title')}</h1>
        <p className="text-muted-foreground">{t('login_subtitle')}</p>
      </div>

      {/* Social Login */}
      <div className="grid grid-cols-1 gap-4">
        <Button 
          variant="outline" 
          onClick={handleGoogleLogin} 
          disabled={isGoogleLoading || isLoading}
          className="w-full h-12 border-border bg-card hover:bg-muted text-foreground gap-3 font-medium"
        >
          {isGoogleLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <GoogleIcon className="w-5 h-5" />}
          {t('social_google', { defaultMessage: 'Continuar amb Google' })}
        </Button>
      </div>

      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <span className="w-full border-t border-border" />
        </div>
        <div className="relative flex justify-center text-xs uppercase">
          <span className="bg-background px-2 text-muted-foreground">{t('or_email')}</span>
        </div>
      </div>

      <form onSubmit={handleLogin} className="space-y-4">
        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">{t('label_email')}</label>
          <Input
            type="email"
            name="email"
            placeholder="nom@empresa.com"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="bg-card border-border text-foreground h-12 focus:border-primary"
            required
            // Si ja tenim email, no cal autofocus aquÃ­
            autoFocus={!prefilledEmail}
          />
        </div>
        <div className="space-y-2">
          <div className="flex justify-between">
            <label className="text-sm font-medium text-foreground ml-1">{t('label_password')}</label>
            <Link href="/auth/forgot-password" className="text-sm text-primary hover:underline">
              {t('forgot_password')}
            </Link>
          </div>
          <Input
            type="password"
            name="password"
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="bg-card border-border text-foreground h-12 focus:border-primary"
            required
            // Si tenim email, posem el focus directament al password per escriure rÃ pid
            autoFocus={!!prefilledEmail}
          />
        </div>

        <Button type="submit" disabled={isLoading || isGoogleLoading} className="w-full h-12 gradient-bg text-white font-bold rounded-lg hover:opacity-90 shadow-lg">
          {isLoading 
            ? <Loader2 className="animate-spin" /> 
            : <><LogIn className="w-4 h-4 mr-2" /> {t('cta_login')}</>
          }
        </Button>
      </form>

      <p className="text-center text-sm text-muted-foreground">
        {t('no_account_prefix')}{' '}
        <Link href="/auth/register" className="text-primary hover:underline font-medium">
          {t('register_link')}
        </Link>
      </p>
    </div>
  );
}

// =================== FILE: src/features/auth/ui/RegisterForm.tsx ===================

'use client';

import { useState } from 'react';
import { useTranslations } from 'next-intl';
import { useRouter, Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Checkbox } from '@/components/ui/checkbox';
import { createClient } from '@/lib/supabase/client';
import { Loader2, UserPlus, Info } from 'lucide-react';
import { GoogleIcon } from '@/components/icons/GoogleIcon'; // ğŸ‘ˆ Importem la icona
import { toast } from 'sonner';

export function RegisterForm({ prefilledEmail }: { prefilledEmail: string }) {
  const t = useTranslations('Auth');
  const router = useRouter();
  const supabase = createClient();

  const [isLoading, setIsLoading] = useState(false);
  const [isGoogleLoading, setIsGoogleLoading] = useState(false);
  const [email, setEmail] = useState(prefilledEmail);
  const [password, setPassword] = useState('');
  const [fullName, setFullName] = useState('');
  const [termsAccepted, setTermsAccepted] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!termsAccepted) {
      setError("Has d'acceptar la polÃ­tica de privacitat per crear el compte.");
      return;
    }

    setIsLoading(true);
    setError(null);

    const { error: authError } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          full_name: fullName,
        }
      }
    });

    if (authError) {
      setError(authError.message);
      setIsLoading(false);
      return;
    }

    router.refresh();
    router.push('/dashboard');
  };

  // âœ… LÃ’GICA GOOGLE (Register funciona igual que Login amb OAuth)
  const handleGoogleRegister = async () => {
    // Si vols, pots obligar a acceptar els termes abans de Google, 
    // tot i que normalment en OAuth s'accepten implÃ­citament.
    if (!termsAccepted) {
        setError("Si us plau, accepta la polÃ­tica de privacitat abans de continuar.");
        return;
    }

    setIsGoogleLoading(true);
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: `${window.location.origin}/auth/callback`,
        queryParams: {
          access_type: 'offline',
          prompt: 'consent',
        },
      },
    });

    if (error) {
        toast.error(error.message);
        setIsGoogleLoading(false);
    }
  };

  return (
    <div className="w-full max-w-md mx-auto space-y-6">
      <div className="text-center space-y-2">
        <h1 className="text-3xl font-bold text-foreground">{t('register_title', { defaultMessage: "Crea el teu compte" })}</h1>
        <p className="text-muted-foreground">{t('register_subtitle', { defaultMessage: "ComenÃ§a a automatitzar el teu negoci avui." })}</p>
      </div>

      {/* Social Register */}
      <div className="grid grid-cols-1 gap-4">
        <Button
          variant="outline"
          onClick={handleGoogleRegister}
          disabled={isLoading || isGoogleLoading}
          className="w-full h-12 border-border bg-card hover:bg-muted text-foreground gap-3 font-medium transition-transform active:scale-[0.98]"
        >
          {isGoogleLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <GoogleIcon className="w-5 h-5" />}
          {t('social_google_register', { defaultMessage: "Registrar-se amb Google" })}
        </Button>
      </div>

      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <span className="w-full border-t border-border" />
        </div>
        <div className="relative flex justify-center text-xs uppercase">
          <span className="bg-background px-2 text-muted-foreground">O amb email</span>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-4">
        {/* ... INPUTS IGUALS (Full Name, Email, Password) ... */}
        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">Nom Complet</label>
          <Input
            id="fullName"
            type="text"
            placeholder="Joan Garcia"
            value={fullName}
            onChange={(e) => setFullName(e.target.value)}
            className="bg-card border-border text-foreground h-12 focus:border-primary"
            required
          />
        </div>

        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">Email</label>
          <Input
            id="email"
            type="email"
            placeholder="nom@empresa.com"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="bg-card border-border text-foreground h-12 focus:border-primary"
            required
          />
        </div>

        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">Contrasenya</label>
          <Input
            id="password"
            type="password"
            placeholder="Crear contrasenya"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="bg-card border-border text-foreground h-12 focus:border-primary"
            required
            minLength={6}
          />
        </div>

        {/* Checkbox Legal */}
        <div className="flex items-start space-x-3 pt-2">
          <Checkbox
            id="privacy"
            checked={termsAccepted}
            onCheckedChange={(checked) => {
              setTermsAccepted(checked as boolean);
              if (checked) setError(null);
            }}
            className="mt-1 border-muted-foreground/30 data-[state=checked]:bg-primary data-[state=checked]:border-primary"
          />
          <div className="grid gap-1.5 leading-none">
            <label
              htmlFor="privacy"
              className="text-sm text-muted-foreground leading-snug cursor-pointer select-none"
            >
              He llegit i accepto la <Link href="/legal/privacitat" target="_blank" className="underline hover:text-primary transition-colors">polÃ­tica de privacitat</Link> i les <Link href="/legal/avis-legal" target="_blank" className="underline hover:text-primary transition-colors">condicions d'Ãºs</Link>.
            </label>
          </div>
        </div>

        {error && (
          <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-500 text-sm flex items-center gap-2 animate-in fade-in slide-in-from-top-2">
            <Info className="w-4 h-4 shrink-0" />
            <span>{error}</span>
          </div>
        )}

        <Button
          type="submit"
          disabled={isLoading || isGoogleLoading}
          className={`w-full h-12 font-bold rounded-lg transition-all shadow-lg shadow-primary/20 flex items-center justify-center gap-2 ${termsAccepted
              ? 'gradient-bg text-white hover:opacity-90'
              : 'bg-muted text-muted-foreground cursor-not-allowed opacity-70'
            }`}
        >
          {isLoading ? <Loader2 className="animate-spin" /> : <><UserPlus className="w-4 h-4" /> Crear Compte</>}
        </Button>
      </form>

      <p className="text-center text-sm text-muted-foreground">
        {t('already_have_account', { defaultMessage: "Ja tens compte?" })}{' '}
        <Link href="/auth/login" className="text-primary hover:underline font-medium">
          {t('login_link', { defaultMessage: "Inicia sessiÃ³" })}
        </Link>
      </p>
    </div>
  );
}

// =================== FILE: src/features/auth/ui/ResetPasswordForm.tsx ===================

// =================== FILE: src/features/auth/ui/ResetPasswordForm.tsx ===================

'use client'

import { useActionState } from 'react';
import { updatePassword } from '../actions/reset-password';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent } from '@/components/ui/card';
import { Loader2 } from 'lucide-react';

export function ResetPasswordForm() {
  const [state, action, isPending] = useActionState(updatePassword, {
    message: '',
    errors: {}
  });

  return (
    <Card>
      <CardContent className="pt-6">
        <form action={action} className="space-y-4">
          <div className="space-y-2">
            <label htmlFor="password" className="text-sm font-medium">Nova Contrasenya</label>
            <Input 
              id="password" 
              name="password" 
              type="password" 
              className={state.errors?.password ? "border-red-500" : ""}
            />
            {state.errors?.password && (
              <p className="text-sm text-red-500">{state.errors.password[0]}</p>
            )}
          </div>

          <div className="space-y-2">
            <label htmlFor="confirmPassword" className="text-sm font-medium">Confirmar Contrasenya</label>
            <Input 
              id="confirmPassword" 
              name="confirmPassword" 
              type="password" 
              className={state.errors?.confirmPassword ? "border-red-500" : ""}
            />
            {state.errors?.confirmPassword && (
              <p className="text-sm text-red-500">{state.errors.confirmPassword[0]}</p>
            )}
          </div>

          {state.message && (
            <p className="text-sm text-red-500 text-center">{state.message}</p>
          )}

          <Button type="submit" className="w-full" disabled={isPending}>
            {isPending ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : "Guardar nova contrasenya"}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/blog/actions/admin-actions.ts ===================

'use server';

import { postService } from '@/services/container';
import { requireAdmin } from '@/lib/auth/admin-guard';
import { revalidatePath } from 'next/cache';


// ğŸ‘‡ 1. Definim el tipus de retorn
export type ActionState = {
  success: boolean;
  message: string;
};

export async function togglePostStatusAction(slug: string, currentStatus: boolean): Promise<ActionState> {
  await requireAdmin(); // ğŸ›¡ï¸ Seguretat
  
  try {
    await postService.updatePost(slug, {
      published: !currentStatus
    });
    revalidatePath('/admin/blog');
    return { success: true, message: 'Estat actualitzat correctament.' };
  } catch (e) {
    console.error(e);
    return { success: false, message: 'Error actualitzant l\'estat.' };
  }
}

export async function deletePostAction(slug: string): Promise<ActionState> {
  await requireAdmin();
  
  try {
    await postService.deletePost(slug);
    revalidatePath('/admin/blog');
    return { success: true, message: 'Post eliminat.' };
  } catch (e) {
    console.error(e);
    return { success: false, message: 'Error eliminant el post.' };
  }
}

// ğŸ‘‡ 2. Tipem el prevState correctament en lloc de 'any'
export async function updatePostDetailsAction(prevState: ActionState, formData: FormData): Promise<ActionState> {
  // 1. Logs inicials
  console.log("ğŸš€ [Server Action] updatePostDetailsAction INICIAT");
  
  try {
    await requireAdmin();
    console.log("âœ… [Server Action] Admin verificat");

    // 2. ExtracciÃ³ de dades
    const slug = formData.get('slug') as string;
    const title = formData.get('title') as string;
    const description = formData.get('description') as string;
    const date = formData.get('date') as string;
    const content = formData.get('content') as string;
    const reviewed = formData.get('reviewed') === 'on';

    // 3. Log de dades rebudes (Important per debug)
    console.log("ğŸ“¦ [Server Action] Dades rebudes:", {
        slug,
        title,
        descriptionLength: description?.length,
        contentLength: content?.length, // Veurem si arriba text o estÃ  buit
        contentPreview: content?.substring(0, 20) + '...',
        reviewed,
        date
    });

    if (!slug) {
        console.error("âŒ [Server Action] Error: Falta l'slug");
        return { success: false, message: "Error: No s'ha trobat l'identificador del post." };
    }

    // 4. Crida al servei
    console.log("ğŸ”„ [Server Action] Cridant a postService.updatePost...");
    await postService.updatePost(slug, {
      title,
      description,
      content, 
      reviewed,
      date: date ? new Date(date).toISOString() : undefined,
    });
    console.log("âœ… [Server Action] postService.updatePost FINALITZAT sense errors");

    // 5. RevalidaciÃ³
    revalidatePath('/admin/blog');
    revalidatePath(`/admin/blog/${slug}`);
    revalidatePath(`/admin/blog/${slug}/edit`); // Important revalidar la prÃ²pia pÃ gina
    
    // âŒ HEM TRET EL REDIRECT PERQUÃˆ ET QUEDIS AQUÃ
    
    return { success: true, message: 'Canvis guardats correctament.' };

  } catch (e) {
    console.error("ğŸ’¥ [Server Action] EXCEPCIÃ“ CAPTURADA:", e);
    // Si l'error fos un redirect, el deixem passar, perÃ² com l'hem tret, aixÃ² serÃ  un error real.
    if ((e as Error).message === 'NEXT_REDIRECT') throw e;
    
    return { success: false, message: `Error guardant: ${(e as Error).message}` };
  }
}

// =================== FILE: src/features/blog/actions.ts ===================

'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';
import { postRepository } from '@/services/container';
export async function togglePostStatus(id: string, currentStatus: boolean) {
  const supabase = await createClient();
  
  // 1. Verificar sessiÃ³ (per seguretat)
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("No autoritzat");

  // 2. Actualitzar estat
  // Si estava true -> false. Si estava false -> true.
  // TambÃ© actualitzem 'status' (l'enum) per coherÃ¨ncia.
  const newStatus = !currentStatus;
  const newStatusEnum = newStatus ? 'published' : 'published';

  const { error } = await supabase
    .from('posts')
    .update({ 
        published: newStatus,
        status: newStatusEnum,
        published_at: newStatus ? new Date().toISOString() : null // Guardem data si publiquem
    })
    .eq('id', id);

  if (error) {
    console.error("Error toggling post:", error);
    return { success: false, message: error.message };
  }

  // 3. Refrescar la pÃ gina perquÃ¨ el botÃ³ canviÃ¯ de color sol
  revalidatePath('/admin/blog');
  revalidatePath(`/admin/blog/[slug]`, 'page'); // Refresca totes les subrutes dinÃ miques si cal
  
  return { success: true };
}

export async function toggleReactionAction(slug: string, reaction: string, visitorId: string) {
  try {
    if (!visitorId) return { success: false, message: "No visitor ID" };

    const result = await postRepository.toggleReaction(slug, reaction, visitorId);
    
    // Revalidem la pÃ gina del blog perquÃ¨ es recalculin els totals al servidor si cal
    revalidatePath(`/blog/${slug}`);
    
    return { success: true, action: result };
  } catch (error) {
    console.error("Error reaction:", error);
    return { success: false };
  }
}

// =================== FILE: src/features/blog/types.ts ===================

export type BlogPost = {
  slug: string;
  title: string;
  date: string;
  description: string;
  content: string; // El cos en Markdown
  tags: string[];
};

// =================== FILE: src/features/blog/ui/AdminPostList.tsx ===================

// src/features/blog/ui/AdminPostList.tsx
'use client';

import { BlogPostDTO } from '@/types/models';
import { Button } from '@/components/ui/button';
import { Edit, Trash2, Eye, EyeOff, Calendar, CheckCircle2 } from 'lucide-react'; // ğŸ‘ˆ Importat CheckCircle2
import { togglePostStatusAction, deletePostAction } from '../actions/admin-actions';
import { useTransition } from 'react';
import { Link } from '@/routing';

export function AdminPostList({ posts }: { posts: BlogPostDTO[] }) {
  const [isPending, startTransition] = useTransition();

  const handleToggle = (slug: string, currentStatus: boolean) => {
    if (confirm(`Vols canviar l'estat a ${!currentStatus ? 'PUBLICAT' : 'ESBORRANY'}?`)) {
      startTransition(async () => {
         await togglePostStatusAction(slug, currentStatus);
      });
    }
  };

  const handleDelete = (slug: string) => {
    if (confirm('EstÃ s segur?')) {
      startTransition(async () => {
         await deletePostAction(slug);
      });
    }
  };

  return (
    <div className="overflow-x-auto">
      <table className="w-full text-sm text-left">
        {/* CapÃ§alera amb colors semÃ ntics */}
        <thead className="bg-muted text-muted-foreground font-medium border-b border-border uppercase text-xs">
          <tr>
            <th className="px-6 py-4">TÃ­tol</th>
            <th className="px-6 py-4">Estat</th>
            <th className="px-6 py-4">Data</th>
            <th className="px-6 py-4 text-right">Accions</th>
          </tr>
        </thead>
        
        <tbody className="divide-y divide-border">
          {posts.map((post) => (
            <tr key={post.slug} className="hover:bg-muted/50 transition-colors group">
              
              <td className="px-6 py-4">
                <div className="flex items-center gap-2">
                    <div className="font-bold text-foreground line-clamp-1">{post.title}</div>
                    
                    {/* INDICADOR REVISAT A LA LLISTA */}
                    {post.reviewed && (
                        <div className="text-green-500" title="Revisat i aprovat">
                            <CheckCircle2 className="w-4 h-4 fill-green-500/10" />
                        </div>
                    )}
                </div>
                <div className="text-xs text-muted-foreground font-mono">{post.slug}</div>
              </td>
              
              <td className="px-6 py-4">
                <span 
                  className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border
                    ${post.published 
                      ? 'bg-green-500/10 text-green-600 border-green-500/20 dark:text-green-400' 
                      : 'bg-yellow-500/10 text-yellow-600 border-yellow-500/20 dark:text-yellow-400'
                    }`}
                >
                  {post.published ? 'Publicat' : 'Esborrany'}
                </span>
              </td>

              <td className="px-6 py-4 text-muted-foreground">
                <div className="flex items-center gap-2">
                  <Calendar className="w-3.5 h-3.5 opacity-70" />
                  {post.date ? new Date(post.date).toLocaleDateString() : '-'}
                </div>
              </td>

              <td className="px-6 py-4 text-right">
                <div className="flex items-center justify-end gap-1 opacity-80 group-hover:opacity-100 transition-opacity">
                  
                  <Button 
                    size="icon" 
                    variant="ghost" 
                    onClick={() => handleToggle(post.slug, post.published)}
                    disabled={isPending}
                    className="hover:bg-background hover:text-foreground"
                    title={post.published ? "Despublicar" : "Publicar"}
                  >
                    {post.published 
                      ? <Eye className="w-4 h-4 text-green-500" /> 
                      : <EyeOff className="w-4 h-4 text-muted-foreground" />
                    }
                  </Button>

                  <Link href={`/admin/blog/${post.slug}`}>
                      <Button size="icon" variant="ghost" className="hover:bg-background hover:text-blue-500" title="Editar">
                        <Edit className="w-4 h-4" />
                      </Button>
                  </Link>

                  <Button 
                    size="icon" 
                    variant="ghost" 
                    onClick={() => handleDelete(post.slug)}
                    disabled={isPending}
                    className="hover:bg-red-500/10 hover:text-red-500"
                    title="Eliminar"
                  >
                    <Trash2 className="w-4 h-4" />
                  </Button>
                
                </div>
              </td>
            </tr>
          ))}
          
          {posts.length === 0 && (
              <tr>
                  <td colSpan={4} className="text-center py-12 text-muted-foreground">
                    No s'han trobat articles.
                  </td>
              </tr>
          )}
        </tbody>
      </table>
    </div>
  );
}

// =================== FILE: src/features/blog/ui/EditPostForm.tsx ===================

'use client';

import { useActionState, useState, useEffect } from 'react';
import { BlogPostDTO } from '@/types/models';
import { updatePostDetailsAction, ActionState } from '@/features/blog/actions/admin-actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent } from '@/components/ui/card';
import { Save, Eye, PenTool, ExternalLink, Loader2, CheckCircle2, ArrowLeft } from 'lucide-react';
import { Link } from '@/routing';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Checkbox } from '@/components/ui/checkbox';
import { toast } from 'sonner';

const initialState: ActionState = {
    success: false,
    message: '',
};

export function EditPostForm({ post }: { post: BlogPostDTO }) {
    const [state, formAction, isPending] = useActionState(updatePostDetailsAction, initialState);
    
    // Estats locals
    const [content, setContent] = useState(post.content || '');
    const [title, setTitle] = useState(post.title);
    
    // GestiÃ³ simplificada de l'estat "Reviewed"
    // NomÃ©s ens interessa per mostrar/amagar el check visual i l'input hidden
    const [isReviewed, setIsReviewed] = useState<boolean>(!!post.reviewed);

    useEffect(() => {
        if (state.message) {
            state.success ? toast.success(state.message) : toast.error(state.message);
        }
    }, [state]);

    return (
        <form action={formAction} className="max-w-5xl mx-auto pb-20">
            <input type="hidden" name="slug" value={post.slug} />
            
            {/* Input Hidden MANUAL: Aquest Ã©s el que realment llegeix el servidor */}
            <input type="hidden" name="reviewed" value={isReviewed ? "on" : "off"} />

            {/* HEADER */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 pb-6 border-b border-border">
                <div className="flex items-center gap-3 w-full md:w-auto">
                    <Link href={`/admin/blog/${post.slug}`}>
                        <Button variant="ghost" size="icon" type="button" className="hover:bg-muted text-muted-foreground hover:text-foreground shrink-0">
                            <ArrowLeft className="w-5 h-5" />
                        </Button>
                    </Link>
                    <div>
                        <h1 className="text-2xl font-bold text-foreground leading-tight">Editar Article</h1>
                        <p className="text-muted-foreground text-xs md:text-sm truncate max-w-[200px] md:max-w-md">
                            {post.title}
                        </p>
                    </div>
                </div>

                <div className="flex flex-wrap items-center gap-2 w-full md:w-auto justify-end">
                    {post.published && (
                        <Link href={`/blog/${post.slug}`} target="_blank" className="w-full sm:w-auto">
                            <Button variant="outline" size="sm" type="button" className="w-full gap-2">
                                <ExternalLink className="w-4 h-4" /> 
                                <span className="hidden sm:inline">Veure Web</span>
                                <span className="sm:hidden">Web</span>
                            </Button>
                        </Link>
                    )}
                    
                    <Button type="submit" disabled={isPending} className="w-full sm:w-auto bg-primary text-primary-foreground hover:bg-primary/90 gap-2 min-w-[140px]">
                        {isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4" />}
                        {isPending ? 'Guardant...' : 'Guardar Canvis'}
                    </Button>
                </div>
            </div>

            <Tabs defaultValue="edit" className="w-full space-y-6">
                <div className="flex items-center justify-between border-b border-border pb-px">
                    <TabsList className="bg-muted/50 p-1 w-full sm:w-auto grid grid-cols-2 sm:flex">
                        <TabsTrigger value="edit" className="gap-2 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm">
                            <PenTool className="w-4 h-4" /> EdiciÃ³
                        </TabsTrigger>
                        <TabsTrigger value="preview" className="gap-2 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm">
                            <Eye className="w-4 h-4" /> Vista PrÃ¨via
                        </TabsTrigger>
                    </TabsList>
                </div>

                <TabsContent value="edit" className="space-y-8 animate-in fade-in-50 duration-300">
                    <Card className="bg-card border-border shadow-sm">
                        <CardContent className="p-4 md:p-6 space-y-6">
                            
                            {/* Checkbox SAFE MODE */}
                            <div 
                                className="flex items-center space-x-3 p-4 bg-muted/30 hover:bg-muted/50 transition-colors rounded-lg border border-border cursor-pointer select-none" 
                                onClick={() => setIsReviewed(!isReviewed)}
                            >
                                <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${isReviewed ? 'bg-green-600 border-green-600' : 'bg-background border-input'}`}>
                                    {isReviewed && <CheckCircle2 className="w-3.5 h-3.5 text-white" />}
                                </div>
                                
                                <div className="grid gap-1 leading-none">
                                    <label className="text-sm font-medium flex items-center gap-2 cursor-pointer pointer-events-none">
                                        <span className={isReviewed ? 'text-green-600 font-bold' : 'text-muted-foreground'}>Marcar com a Revisat</span>
                                    </label>
                                    <p className="text-xs text-muted-foreground hidden sm:block">Aquest article compleix els estÃ ndards de qualitat.</p>
                                </div>
                            </div>

                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <label className="text-sm font-medium text-foreground">TÃ­tol Principal</label>
                                    <Input
                                        name="title"
                                        value={title}
                                        onChange={(e) => setTitle(e.target.value)}
                                        required
                                        className="text-base md:text-lg font-bold h-12 bg-background border-input focus:ring-primary/20"
                                    />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-sm font-medium text-foreground">Data de PublicaciÃ³</label>
                                    <Input
                                        type="datetime-local"
                                        name="date"
                                        defaultValue={post.date ? new Date(post.date).toISOString().slice(0, 16) : ''}
                                        className="h-12 bg-background border-input focus:ring-primary/20"
                                    />
                                </div>
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-medium text-foreground">DescripciÃ³ SEO</label>
                                <Textarea
                                    name="description"
                                    defaultValue={post.description || ''}
                                    rows={3}
                                    className="resize-none bg-background border-input focus:ring-primary/20"
                                />
                            </div>
                        </CardContent>
                    </Card>

                    <div className="space-y-2">
                        <label className="text-sm font-medium text-foreground ml-1">Contingut (Markdown / MDX)</label>
                        <div className="relative rounded-xl border border-input shadow-sm bg-background focus-within:ring-2 focus-within:ring-primary/20 transition-all">
                            <Textarea
                                name="content"
                                value={content}
                                onChange={(e) => setContent(e.target.value)}
                                className="min-h-[500px] w-full p-4 md:p-6 font-mono text-sm leading-relaxed border-0 focus-visible:ring-0 resize-y bg-transparent"
                                placeholder="# Escriu el teu article aquÃ­..."
                            />
                        </div>
                    </div>
                </TabsContent>

                <TabsContent value="preview" className="animate-in fade-in-50 duration-300">
                    <div className="border border-border rounded-xl bg-background shadow-lg overflow-hidden min-h-[500px]">
                        <div className="bg-muted/50 border-b border-border p-3 flex items-center gap-2">
                            <div className="flex gap-1.5">
                                <div className="w-2.5 h-2.5 rounded-full bg-red-400/80"></div>
                                <div className="w-2.5 h-2.5 rounded-full bg-yellow-400/80"></div>
                                <div className="w-2.5 h-2.5 rounded-full bg-green-400/80"></div>
                            </div>
                            <div className="mx-auto text-[10px] text-muted-foreground font-mono bg-background px-3 py-1 rounded border border-border opacity-70">
                                preview mode
                            </div>
                        </div>

                        <div className="p-6 md:p-12 max-w-3xl mx-auto">
                            <h1 className="text-3xl md:text-5xl font-extrabold mb-6 text-foreground tracking-tight">{title}</h1>
                            <div className="prose prose-slate dark:prose-invert max-w-none">
                                <pre className="whitespace-pre-wrap font-sans text-base leading-relaxed">
                                    {content || <span className="text-muted-foreground italic">ComenÃ§a a escriure per veure el resultat...</span>}
                                </pre>
                            </div>
                        </div>
                    </div>
                </TabsContent>
            </Tabs>
        </form>
    );
}

// =================== FILE: src/features/blog/ui/MDXContent.tsx ===================

import { MDXRemote } from 'next-mdx-remote/rsc';
import { Button } from '@/components/ui/button';
import React, { ComponentPropsWithoutRef } from 'react';
import { CheckCircle2 } from 'lucide-react';
import remarkGfm from 'remark-gfm'; // ğŸ‘ˆ 1. IMPORTA EL PLUGIN
// Tipus per als components HTML estÃ ndard
type HeadingProps = ComponentPropsWithoutRef<'h1'>;
type ParagraphProps = ComponentPropsWithoutRef<'p'>;
type ListProps = ComponentPropsWithoutRef<'ul'>;
type CalloutProps = { children: React.ReactNode };
// Tipus per a taules
type TableProps = ComponentPropsWithoutRef<'table'>;
type ThProps = ComponentPropsWithoutRef<'th'>;
type TdProps = ComponentPropsWithoutRef<'td'>;

// Component de VÃ­deo (YouTube)
const Video = ({ id }: { id: string }) => (
  <div className="my-12 rounded-xl overflow-hidden shadow-2xl ring-1 ring-slate-900/10 aspect-video bg-slate-900 mx-auto w-full">
    <iframe
      className="w-full h-full"
      src={`https://www.youtube.com/embed/${id}`}
      title="YouTube video player"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowFullScreen
    />
  </div>
);

const components = {
  // ENCAPÃ‡ALAMENTS: Usem 'text-foreground' per adaptar-se perfectament (Negre/Blanc)
  h1: (props: HeadingProps) => (
    <h1 {...props} className="text-3xl md:text-5xl font-extrabold mt-12 mb-6 text-foreground tracking-tight leading-tight" />
  ),
  h2: (props: HeadingProps) => (
    <h2 {...props} className="text-2xl md:text-3xl font-bold mt-12 mb-6 text-foreground border-b border-border/50 pb-2" />
  ),
  h3: (props: HeadingProps) => (
    <h3 {...props} className="text-xl md:text-2xl font-bold mt-8 mb-4 text-foreground" />
  ),

  // PARÃ€GRAFS: CORRECCIÃ“ DE CONTRAST
  // Light: text-slate-900 (Negre intens per llegibilitat)
  // Dark: text-slate-200 (Blanc suau per no cremar els ulls)
  p: (props: ParagraphProps) => (
    <p {...props} className="text-xl leading-8 text-slate-900 dark:text-slate-400 mb-8 font-sans" />
  ),

  // ELEMENTS INLINE
  strong: (props: ComponentPropsWithoutRef<'strong'>) => <strong {...props} className="font-bold text-foreground" />,
  a: (props: ComponentPropsWithoutRef<'a'>) => <a {...props} className="text-primary underline underline-offset-4 hover:text-primary/80 font-medium transition-colors" />,

  // LLISTES
  ul: (props: ListProps) => (
    <ul {...props} className="list-disc list-outside ml-6 space-y-3 mb-8 text-xl text-slate-900 dark:text-slate-500" />
  ),
  li: (props: ComponentPropsWithoutRef<'li'>) => <li {...props} className="pl-2" />,

  // CITES (Blockquote)
  blockquote: (props: ComponentPropsWithoutRef<'blockquote'>) => (
    <blockquote {...props} className="border-l-4 border-primary pl-6 py-4 my-10 italic text-2xl text-slate-800 dark:text-slate-100 bg-muted/30 rounded-r-lg" />


  ),
  // âœ¨ ESTILS DE TAULA (NOU)
  table: (props: TableProps) => (
    <div className="my-12 w-full overflow-x-auto rounded-xl border border-border shadow-sm">
      <table {...props} className="w-full text-left text-sm" />
    </div>
  ),
  thead: (props: ComponentPropsWithoutRef<'thead'>) => (
    <thead {...props} className="bg-muted/50 text-foreground border-b border-border" />
  ),
  tbody: (props: ComponentPropsWithoutRef<'tbody'>) => (
    <tbody {...props} className="divide-y divide-border bg-card" />
  ),
  tr: (props: ComponentPropsWithoutRef<'tr'>) => (
    <tr {...props} className="transition-colors hover:bg-muted/20" />
  ),
  th: (props: ThProps) => (
    <th {...props} className="px-6 py-4 font-bold text-foreground uppercase tracking-wider text-xs align-middle" />
  ),
  td: (props: TdProps) => (
    <td {...props} className="px-6 py-4 text-slate-600 dark:text-slate-300 align-middle leading-relaxed" />
  ),

  // COMPONENTS PERSONALITZATS (Botons i Callouts)
  Button: (props: React.ComponentProps<typeof Button>) => (
    <div className="my-12 flex justify-center">
      <Button size="lg" className="px-8 py-6 text-lg shadow-lg hover:scale-105 transition-transform" {...props} />
    </div>
  ),

  Callout: ({ children }: CalloutProps) => (
    <div className="flex gap-4 bg-primary/5 border border-primary/20 text-foreground p-6 my-10 rounded-xl shadow-sm">
      <div className="shrink-0 mt-1">
        <CheckCircle2 className="h-6 w-6 text-primary" />
      </div>
      <div className="text-lg leading-relaxed text-slate-900 dark:text-slate-100">
        {children}
      </div>
    </div>
  ),

  Video,
};

export function MDXContent({ source }: { source: string }) {
  if (!source) return null;

  return (
    <article className="max-w-none w-full">
      <MDXRemote 
        source={source} 
        components={components} 
        // ğŸ‘‡ 2. AFEGEIX AQUESTA CONFIGURACIÃ“
        options={{
          mdxOptions: {
            remarkPlugins: [remarkGfm],
          },
        }}
      />
    </article>
  );
}

// =================== FILE: src/features/blog/ui/PostStatusToggle.tsx ===================

// src/features/blog/ui/PostStatusToggle.tsx

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Loader2, Eye, EyeOff } from 'lucide-react'; // Canvi icones mÃ©s clares
import { togglePostStatus } from '../actions';
import { useRouter } from 'next/navigation';

type Props = {
  postId: string;
  isPublished: boolean;
};

export function PostStatusToggle({ postId, isPublished }: Props) {
  const [isLoading, setIsLoading] = useState(false);
  const router = useRouter();

  const handleToggle = async () => {
    setIsLoading(true);
    try {
      await togglePostStatus(postId, isPublished);
      router.refresh();
    } catch (error) {
      console.error(error);
      alert("Error canviant l'estat");
    } finally {
      setIsLoading(false);
    }
  };

  if (isPublished) {
    return (
      <Button 
        variant="outline" 
        onClick={handleToggle} 
        disabled={isLoading}
        className="border-yellow-500/30 text-yellow-600 dark:text-yellow-500 hover:bg-yellow-500/10 hover:border-yellow-500/50"
      >
        {isLoading ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <EyeOff className="w-4 h-4 mr-2" />}
        Despublicar
      </Button>
    );
  }

  return (
    <Button 
      variant="outline"
      onClick={handleToggle} 
      disabled={isLoading}
      className="border-primary/30 text-primary hover:bg-primary/5 hover:border-primary/60"
    >
      {isLoading ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Eye className="w-4 h-4 mr-2" />}
      Publicar
    </Button>
  );
}

// =================== FILE: src/features/blog/ui/ReactionDock.tsx ===================

'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { toggleReactionAction } from '../actions';
import { cn } from '@/lib/utils';
import { Plus, Heart } from 'lucide-react'; // Icones del Trigger

// 1. DEFINICIÃ“ DE TIPUS (Per arreglar l'error 'any')
type ReactionItem = {
    id: string;
    emoji: string;
    label: string;
};

interface ReactionButtonProps {
    reaction: ReactionItem;
    count: number;
    isActive: boolean;
    onReact: (id: string) => void;
}

const REACTIONS: ReactionItem[] = [
    { id: 'like', emoji: 'â¤ï¸', label: 'Love' },
    { id: 'mindblown', emoji: 'ğŸ¤¯', label: 'Wow' },
    { id: 'rocket', emoji: 'ğŸš€', label: 'Boost' },
    { id: 'party', emoji: 'ğŸ‰', label: 'Party' },
];

type Props = {
    slug: string;
    initialCounts: Record<string, number>;
};

export function ReactionDock({ slug, initialCounts }: Props) {
    const [counts, setCounts] = useState(initialCounts);
    const [myReactions, setMyReactions] = useState<Set<string>>(new Set());
    const [visitorId, setVisitorId] = useState<string>('');
    const [isMounted, setIsMounted] = useState(false);
    
    // Estat per obrir/tancar el menÃº (Unificat MÃ²bil/PC)
    const [isOpen, setIsOpen] = useState(false);

    // 1. INITIAL SETUP
    useEffect(() => {
        const timer = setTimeout(() => {
            setIsMounted(true);
            let vid = localStorage.getItem('digitai_visitor_id');
            if (!vid) {
                vid = Math.random().toString(36).substring(2) + Date.now().toString(36);
                localStorage.setItem('digitai_visitor_id', vid);
            }
            setVisitorId(vid);
        }, 0);
        return () => clearTimeout(timer);
    }, []);

    // 2. LOAD STATE
    useEffect(() => {
        if (!isMounted) return;
        const timer = setTimeout(() => {
            const stored = localStorage.getItem(`react_${slug}`);
            if (stored) {
                try { setMyReactions(new Set(JSON.parse(stored))); } catch { setMyReactions(new Set()); }
            } else {
                setMyReactions(new Set());
            }
        }, 0);
        return () => clearTimeout(timer);
    }, [slug, isMounted]);

    // 3. HANDLER
    const handleReact = async (reactionId: string) => {
        if (!visitorId) return;
        
        // HÃ ptic Feedback
        if (typeof navigator !== 'undefined' && navigator.vibrate) {
            try { navigator.vibrate(50); } catch {}
        }

        const isActive = myReactions.has(reactionId);

        setMyReactions(prev => {
            const next = new Set(prev);
            if (isActive) next.delete(reactionId); else next.add(reactionId);
            localStorage.setItem(`react_${slug}`, JSON.stringify(Array.from(next)));
            return next;
        });

        setCounts(prev => ({
            ...prev,
            [reactionId]: Math.max(0, (prev[reactionId] || 0) + (isActive ? -1 : 1))
        }));

        await toggleReactionAction(slug, reactionId, visitorId);
    };

    if (!isMounted) return null;

    return (
        // CONTENIDOR FIX (POSICIÃ“ RESPONSIVE)
        // MÃ²bil: bottom-24 (sobre navbar). Escriptori: bottom-8 (cantonada)
        <div className="fixed bottom-24 right-4 md:bottom-8 md:right-8 z-50 flex flex-col-reverse items-end gap-4">
            
            {/* 1. BOTÃ“ TRIGGER PRINCIPAL (FAB) */}
            <button 
                onClick={() => setIsOpen(!isOpen)}
                className={cn(
                    "w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center shadow-2xl border border-white/20 backdrop-blur-xl transition-all duration-500 ease-out z-50",
                    isOpen 
                        ? "bg-slate-900 text-white rotate-[135deg] border-red-500/50" 
                        : "bg-slate-900/80 hover:bg-slate-800 text-cyan-400 hover:scale-110"
                )}
            >
                <Plus className="w-6 h-6 md:w-7 md:h-7" />
            </button>

            {/* 2. LLISTA DESPLEGABLE (Vertical) */}
            <AnimatePresence>
                {isOpen && (
                    <div className="flex flex-col gap-3 pb-2 items-end">
                        {REACTIONS.map((r, i) => (
                            <motion.div
                                key={r.id}
                                initial={{ opacity: 0, y: 20, scale: 0.5, x: 20 }}
                                animate={{ opacity: 1, y: 0, scale: 1, x: 0 }}
                                exit={{ opacity: 0, y: 20, scale: 0.5, transition: { duration: 0.2 } }}
                                transition={{ 
                                    delay: i * 0.05, 
                                    type: "spring", 
                                    stiffness: 300, 
                                    damping: 20 
                                }}
                                className="flex items-center gap-3 justify-end group"
                            >
                                {/* Etiqueta (Tooltip) */}
                                <span className="text-[10px] md:text-xs font-bold text-white bg-black/60 px-2 py-1 rounded-md backdrop-blur-sm border border-white/5 opacity-0 group-hover:opacity-100 transition-opacity translate-x-2 group-hover:translate-x-0">
                                    {r.label}
                                </span>
                                
                                {/* BotÃ³ de ReacciÃ³ */}
                                <ReactionButton 
                                    reaction={r} 
                                    count={counts[r.id]} 
                                    isActive={myReactions.has(r.id)} 
                                    onReact={handleReact}
                                />
                            </motion.div>
                        ))}
                    </div>
                )}
            </AnimatePresence>
        </div>
    );
}

// ==========================================
// SUB-COMPONENT BOTÃ“ (Tipat Correctament)
// ==========================================
function ReactionButton({ reaction: r, count, isActive, onReact }: ReactionButtonProps) {
    return (
        <div className="relative">
            {/* Comptador (Badge) */}
            <AnimatePresence>
                {(count || 0) > 0 && (
                    <motion.div
                        key="count"
                        initial={{ opacity: 0, scale: 0 }}
                        animate={{ opacity: 1, scale: 1 }}
                        exit={{ opacity: 0, scale: 0 }}
                        className="absolute -top-2 -left-2 z-20 font-bold text-white bg-cyan-600 px-1.5 py-0.5 min-w-[20px] text-center rounded-full text-[10px] border border-cyan-400 shadow-lg pointer-events-none"
                    >
                        {count}
                    </motion.div>
                )}
            </AnimatePresence>

            {/* El BotÃ³ en si */}
            <motion.button
                whileHover={{ scale: 1.1 }}
                whileTap={{ scale: 0.9 }}
                onClick={() => onReact(r.id)}
                className={cn(
                    "w-10 h-10 md:w-12 md:h-12 flex items-center justify-center text-xl md:text-2xl rounded-full shadow-lg border backdrop-blur-md transition-all duration-300 relative overflow-hidden",
                    isActive 
                        ? "bg-slate-800 border-cyan-500/50 shadow-cyan-500/20" 
                        : "bg-slate-900/90 border-slate-700 hover:bg-slate-800"
                )}
            >
                <span className="filter drop-shadow-md select-none relative z-10">{r.emoji}</span>
                
                {isActive && (
                    <motion.div
                        layoutId={`glow-${r.id}`}
                        className="absolute inset-0 bg-cyan-500/20 blur-md"
                    />
                )}
            </motion.button>
        </div>
    );
}

// =================== FILE: src/features/email/templates/AuditReadyEmail.tsx ===================

import * as React from 'react';
import {
  Body,
  Container,
  Head,
  Heading,
  Html,
  Preview,
  Section,
  Text,
  Button,
  Hr,
  Row,
  Column,
} from '@react-email/components';

interface AuditReadyEmailProps {
  url: string;
  seoScore: number;
  perfScore: number;
  auditId: string;
}

// Estils base (Els correus necessiten estils en lÃ­nia antics)
const main = {
  backgroundColor: '#f6f9fc',
  fontFamily: '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Ubuntu,sans-serif',
};

const container = {
  backgroundColor: '#ffffff',
  margin: '0 auto',
  padding: '20px 0 48px',
  marginBottom: '64px',
  borderRadius: '8px',
  boxShadow: '0 4px 12px rgba(0,0,0,0.05)',
};

const box = {
  padding: '0 48px',
};

const hr = {
  borderColor: '#e6ebf1',
  margin: '20px 0',
};

const scoreBox = {
  textAlign: 'center' as const,
  padding: '20px',
  borderRadius: '8px',
  backgroundColor: '#f0fdf4', // Verd molt suau
  border: '1px solid #bbf7d0',
};

const scoreNumber = {
  fontSize: '32px',
  fontWeight: 'bold',
  color: '#15803d', // Verd fort
  margin: '0',
};

const scoreLabel = {
  color: '#64748b',
  fontSize: '12px',
  textTransform: 'uppercase' as const,
  letterSpacing: '1px',
  marginTop: '8px',
};

const button = {
  backgroundColor: '#7c3aed', // El teu lila de marca (primary)
  borderRadius: '5px',
  color: '#fff',
  fontSize: '16px',
  fontWeight: 'bold',
  textDecoration: 'none',
  textAlign: 'center' as const,
  display: 'block',
  width: '100%',
  padding: '12px',
  marginTop: '20px',
};

export const AuditReadyEmail = ({
  url,
  seoScore,
  perfScore,
  auditId,
}: AuditReadyEmailProps) => (
  <Html>
    <Head />
    <Preview>L'informe de {url} ja estÃ  llest - DigitAI Studios</Preview>
    <Body style={main}>
      <Container style={container}>
        <Section style={box}>
          <Heading as="h2" style={{ color: '#1e293b', textAlign: 'center' }}>
            DigitAI Studios
          </Heading>
          <Hr style={hr} />
          
          <Text style={{ fontSize: '16px', lineHeight: '24px', color: '#334155' }}>
            Hola! ğŸ‘‹
          </Text>
          <Text style={{ fontSize: '16px', lineHeight: '24px', color: '#334155' }}>
            La nostra IntelÂ·ligÃ¨ncia Artificial ha acabat d'analitzar la teva web <strong>{url}</strong>. AquÃ­ tens un resum rÃ pid dels resultats:
          </Text>

          {/* GRID DE PUNTUACIONS */}
          <Section style={{ marginTop: '24px', marginBottom: '24px' }}>
            <Row>
              <Column>
                <div style={scoreBox}>
                    <p style={scoreNumber}>{seoScore}/100</p>
                    <p style={scoreLabel}>SEO</p>
                </div>
              </Column>
              <Column style={{ width: '20px' }} />
              <Column>
                <div style={{ ...scoreBox, backgroundColor: '#eff6ff', borderColor: '#bfdbfe' }}>
                    <p style={{ ...scoreNumber, color: '#1d4ed8' }}>{perfScore}/100</p>
                    <p style={scoreLabel}>Rendiment</p>
                </div>
              </Column>
            </Row>
          </Section>

          <Text style={{ fontSize: '16px', lineHeight: '24px', color: '#334155' }}>
            Hem detectat algunes Ã rees de millora crÃ­tiques que podrien estar afectant les teves vendes.
          </Text>

          <Button 
            style={button} 
            href={`https://la-teva-web.com/dashboard/audits/${auditId}`}
          >
            Veure Informe Complet
          </Button>
          
          <Hr style={hr} />
          <Text style={{ fontSize: '12px', color: '#94a3b8', textAlign: 'center' }}>
            Â© 2024 DigitAI Studios. AutomatitzaciÃ³ i IA per a empreses.
          </Text>
        </Section>
      </Container>
    </Body>
  </Html>
);

export default AuditReadyEmail;

// =================== FILE: src/features/projects/actions/project-actions.ts ===================

'use server';

import { SupabaseProjectRepository } from '@/repositories/supabase/SupabaseProjectRepository';
import { requireAdmin } from '@/lib/auth/admin-guard';
import { revalidatePath } from 'next/cache';

const repo = new SupabaseProjectRepository();

export async function addProjectMemberAction(projectId: string, userId: string) {
    await requireAdmin();
    const { error } = await repo.addMember(projectId, userId);
    
    if (error) {
        // Codi 23505 Ã©s "Unique violation" (ja existeix)
        if (error.code === '23505') return { success: false, message: 'Usuari ja vinculat.' };
        return { success: false, message: error.message };
    }

    revalidatePath(`/admin/projects/${projectId}`);
    return { success: true, message: 'Membre afegit al projecte.' };
}

export async function removeProjectMemberAction(projectId: string, userId: string) {
    await requireAdmin();
    const { error } = await repo.removeMember(projectId, userId);
    
    if (error) return { success: false, message: error.message };

    revalidatePath(`/admin/projects/${projectId}`);
    return { success: true, message: 'Membre eliminat del projecte.' };
}

// =================== FILE: src/features/projects/actions.ts ===================

'use server';

import { FactoryService } from '@/services/FactoryService';
import { AIService } from '@/services/AIService';
import { MasterConfig } from '@/types/config';
import { createClient, createAdminClient } from '@/lib/supabase/server';
import { ActionResult } from '@/types/actions';
import { Json } from '@/types/database.types';

const factory = new FactoryService();
const ai = new AIService();

const wait = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

// FunciÃ³ robusta per esperar que el repo existeixi
async function waitForRepoReady(slug: string, attempts = 20): Promise<boolean> {
    for (let i = 0; i < attempts; i++) {
        try {
            // Intentem llegir el package.json per veure si ja s'ha copiat el template
            await factory.getFileSha(slug, 'package.json');
            return true;
        } catch (e) {
            console.log(`â³ [Factory] Esperant inicialitzaciÃ³... (${i + 1}/${attempts})`);
            await wait(3000); // 3 segons entre intents
        }
    }
    return false;
}

export async function createProjectAction(prevState: unknown, formData: FormData): Promise<ActionResult> {
    try {
        const businessName = formData.get('businessName') as string;
        const slug = formData.get('slug') as string;
        const description = formData.get('description') as string;
        const primaryColor = formData.get('primaryColor') as string;
        const logoFile = formData.get('logo') as File;

        if (!businessName || !slug) {
            return {
                error: "Falten dades.",
                fields: { 
                    businessName, 
                    slug, 
                    description, 
                    primaryColor 
                }
            };
        }

        // 1. IA
        console.log(`ğŸ¤– [IA] Generant textos per: ${businessName}`);
        const aiContent = await ai.generateSiteContent(businessName, description);

        // 2. GITHUB: Crear Repo
        const repoData = await factory.createRepository(slug, `Web de ${businessName}`);

        // ESPERA ACTIVA: No seguim fins que el repo estigui llest
        console.log("â³ [Factory] Verificant estat del repositori...");
        const isReady = await waitForRepoReady(slug);
        
        if (!isReady) {
            throw new Error("Timeout: GitHub ha trigat massa a crear els fitxers.");
        }

        // 3. GITHUB: Pujar Logo
        await factory.uploadLogo(slug, logoFile);

        // 4. PREPARAR CONFIG
        const config: MasterConfig = {
            identity: {
                name: businessName,
                description: aiContent.hero.subtitle || description,
                logoUrl: "/branding/logo.png",
                faviconUrl: "/favicon.ico",
                contactEmail: "info@client.com"
            },
            branding: {
                colors: {
                    primary: primaryColor,
                    secondary: "#10b981",
                    background: "#ffffff",
                    foreground: "#0f172a"
                },
                radius: 0.5
            },
            modules: {
                landing: { active: true, sections: ['hero', 'services', 'contact'] },
                auth: true,
                dashboard: true,
                booking: formData.get('module_booking') === 'on',
                blog: formData.get('module_blog') === 'on',
                inventory: formData.get('module_inventory') === 'on',
                ecommerce: false,
                accessControl: false
            },
            i18n: { locales: ['ca', 'es'], defaultLocale: 'ca' }
        };

        // 5. GITHUB: Injectar Config
        await factory.injectConfiguration(slug, config);

        // 6. DB LOCAL: Guardar (Admin Client)
        const supabaseAdmin = createAdminClient();
        const supabaseUser = await createClient();
        const { data: { user } } = await supabaseUser.auth.getUser();

        // 6.1 Crear OrganitzaciÃ³
        const { data: newOrg, error: orgError } = await supabaseAdmin
            .from('organizations')
            .insert({
                name: businessName,
                slug: slug,
                domain: `${slug}.vercel.app`,
                plan: 'basic',
                branding_config: config.branding as unknown as Json
            })
            .select()
            .single();

        if (orgError) throw new Error(`Error DB Org: ${orgError.message}`);

        // 6.2 Crear Projecte
        const { error: projectError } = await supabaseAdmin
            .from('projects')
            .insert({
                name: businessName,
                domain: slug,
                repository_url: repoData.html_url,
                status: 'pending',
                client_id: user?.id || newOrg.id,
                organization_id: newOrg.id
            });

        if (projectError) console.error("âŒ Error DB Projecte:", projectError);

        return { success: true, repoUrl: repoData.html_url };

    } catch (error: unknown) {
        // GestiÃ³ d'errors segura (Type-Safe)
        let errorMessage = "Error desconegut al procÃ©s de fÃ brica.";
        if (error instanceof Error) {
            errorMessage = error.message;
        } else if (typeof error === 'object' && error !== null && 'message' in error) {
            errorMessage = String((error as Record<string, unknown>).message);
        }

        console.error("âŒ FACTORY ERROR:", errorMessage);
        
        return { 
            error: errorMessage,
            fields: {
                businessName: formData.get('businessName') as string,
                slug: formData.get('slug') as string,
                description: formData.get('description') as string,
                primaryColor: formData.get('primaryColor') as string
            }
        };
    }
}


// 1. Definim el tipus aquÃ­ (o a /types) per assegurar coherÃ¨ncia
export type InviteState = {
    success: boolean;
    error: string | null;
    message: string | null;
};




export async function inviteClientAction(
    prevState: InviteState,
    formData: FormData
): Promise<InviteState> {

    const supabaseAdmin = createAdminClient();
    const email = formData.get('email') as string;
    const projectId = formData.get('projectId') as string;
    const orgId = formData.get('orgId') as string;

    console.log("ğŸ” [INVITE] Iniciant per:", email);

    if (!email || !orgId) {
        return { success: false, error: "Falten dades obligatÃ²ries.", message: null };
    }

    try {
        let userIdToLink = '';

        // 1. Busquem a la taula PROFILES
        // Usem maybeSingle() per evitar errors si no en troba cap
        const { data: existingProfile } = await supabaseAdmin
            .from('profiles')
            .select('id')
            .eq('email', email)
            .maybeSingle();

        if (existingProfile) {
            console.log("âœ… [INVITE] Usuari trobat a Profiles. ID:", existingProfile.id);
            userIdToLink = existingProfile.id;

            // Assegurem que tingui accÃ©s a aquesta organitzaciÃ³
            // Usem UPSERT aquÃ­ tambÃ© per si de cas
            await supabaseAdmin
                .from('profiles')
                .upsert({ 
                    id: userIdToLink,
                    email: email,
                    organization_id: orgId, 
                    role: 'client' 
                });

        } else {
            console.log("âš ï¸ [INVITE] No trobat a profiles. Provant invitaciÃ³ Auth...");
            
            const { data: inviteData, error: inviteError } = await supabaseAdmin.auth.admin.inviteUserByEmail(email, {
                data: { org_id: orgId, role: 'client', full_name: 'Client' },
                redirectTo: `${process.env.NEXT_PUBLIC_BASE_URL}/auth/update-password`
            });

            if (inviteError) {
                // CAS: L'email existeix a Auth (perÃ² ha fallat el pas 1 per algun motiu)
                if (inviteError.code === 'email_exists' || inviteError.message.includes('already been registered')) {
                    console.log("ğŸ§Ÿ [INVITE] Usuari existent a Auth. Recuperant ID...");
                    
                    const { data: authUsers } = await supabaseAdmin.auth.admin.listUsers();
                    const zombieUser = authUsers.users.find(u => u.email === email);

                    if (zombieUser) {
                        userIdToLink = zombieUser.id;
                        console.log("âœ… [INVITE] ID recuperat:", userIdToLink);

                        // ğŸ”¥ CORRECCIÃ“ CLAU: Usem UPSERT en lloc d'INSERT
                        // AixÃ² arregla tant si falta el perfil com si ja existeix
                        const { error: upsertError } = await supabaseAdmin
                            .from('profiles')
                            .upsert({
                                id: userIdToLink,
                                email: email,
                                organization_id: orgId,
                                role: 'client',
                                full_name: zombieUser.user_metadata?.full_name || 'Client Recuperat'
                            }, { onConflict: 'id, organization_id' }); // Especifiquem la clau de conflicte

                        if (upsertError) {
                            console.error("âŒ [INVITE] Error al Upsert:", upsertError);
                            return { success: false, error: "Error de base de dades: " + upsertError.message, message: null };
                        }
                        console.log("âœ… [INVITE] Perfil sincronitzat correctament.");

                    } else {
                        return { success: false, error: "Error crÃ­tic: L'email consta com a registrat perÃ² no es troba.", message: null };
                    }
                } else {
                    return { success: false, error: "Error invitaciÃ³: " + inviteError.message, message: null };
                }
            } else {
                console.log("âœ¨ [INVITE] Nova invitaciÃ³ enviada.");
                userIdToLink = inviteData.user.id;
            }
        }

        // 2. VINCULACIÃ“ FINAL DEL PROJECTE
        console.log(`ğŸ”— [INVITE] Vinculant projecte a ${userIdToLink}...`);
        
        const { error: updateError } = await supabaseAdmin
            .from('projects')
            .update({ 
                status: 'active',
                client_id: userIdToLink 
            })
            .eq('id', projectId);

        if (updateError) {
            console.error("âŒ [INVITE] Error update project:", updateError);
            return { success: false, error: "Error vinculant el projecte.", message: null };
        }

        return { 
            success: true, 
            message: "Client vinculat i activat correctament!", 
            error: null 
        };

    } catch (error: unknown) {
        console.error("ğŸ’¥ [INVITE] ExcepciÃ³:", error);
        return { success: false, error: "Error inesperat al servidor", message: null };
    }
}

// =================== FILE: src/features/projects/data/projects-data.ts ===================

import { StaticImageData } from 'next/image';
// Importa les teves imatges reals aquÃ­
import ribotFlowImg from '@/assets/images/pantalla-ribotflow.jpg'; 
import salutFlowImg from '@/assets/images/pantalla-salutflow.jpg';

export interface Project {
  id: string;
  title: string;
  tagline: string;
  description: string;
  stats: string[];
  tags: string[];
  color: string;
  image: StaticImageData | null;
  link: string;
  imageAlt: string; // ğŸ‘ˆ NOU CAMP AFEGIT
}

export const PROJECTS: Project[] = [
  {
    id: 'ribotflow',
    title: 'RibotFlow',
    tagline: 'El Sistema Operatiu Integral',
    description: '...',
    stats: ['CRM + FacturaciÃ³', 'AutomatitzaciÃ³ IA', 'Control Financer'],
    tags: ['ERP', 'Business', 'IA', 'Supabase'],
    color: 'from-purple-500 to-pink-500',
    image: ribotFlowImg,
    // ğŸ‘‡ DESCRIU LA IMATGE REALMENT
    imageAlt: "Panell de control fosc de RibotFlow mostrant grÃ fiques de rendiment i llistat de clients", 
    link: 'https://ribotflow.com'
  },
  {
    id: 'salutflow',
    title: 'SalutFlow',
    tagline: 'El teu Centre Esportiu, Digitalitzat',
    description: '...',
    stats: ['App PWA', 'Pagaments Stripe', 'Llistes d\'Espera'],
    tags: ['SaaS', 'Sport', 'PWA', 'Stripe'],
    color: 'from-cyan-400 to-blue-600',
    image: salutFlowImg,
    // ğŸ‘‡ DESCRIU LA IMATGE REALMENT
    imageAlt: "Captura de l'aplicaciÃ³ mÃ²bil SalutFlow amb el calendari de reserves de classes",
    link: 'https://getsalutflow.com'
  }
];

// =================== FILE: src/features/projects/index.ts ===================

// Exportem nomÃ©s el que volem que la resta de l'app pugui utilitzar
export * from './ui/ProjectsHero';
export * from './ui/ProjectList';
export * from './ui/ProjectsCTA';
export * from './data/projects-data'; // Opcional, si necessites els tipus a fora

// =================== FILE: src/features/projects/ui/InviteClientForm.tsx ===================

'use client';

import { useActionState } from 'react';
// Importem l'acciÃ³ i EL TIPUS que acabem de crear
import { inviteClientAction, InviteState } from '@/features/projects/actions';
import { Mail, Send, Loader2 } from 'lucide-react';

// âœ… L'estat inicial ha de coincidir EXACTAMENT amb InviteState
const initialState: InviteState = { 
  success: false, 
  error: null, 
  message: null 
};

export function InviteClientForm({ projectId, orgId }: { projectId: string, orgId: string }) {
  const [state, action, isPending] = useActionState(inviteClientAction, initialState);

  if (state.success) {
      return (
          <div className="p-4 bg-green-50 border border-green-200 rounded-lg text-green-800 text-center animate-in zoom-in">
              âœ… <strong>{state.message}</strong><br/>
              El client rebrÃ  un correu per activar el seu compte.
          </div>
      );
  }

  return (
    <form action={action} className="flex flex-col gap-3">
        <input type="hidden" name="projectId" value={projectId} />
        <input type="hidden" name="orgId" value={orgId} />
        
        <div className="flex gap-2">
            <div className="relative flex-1">
                <Mail className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                <input 
                    name="email" 
                    type="email" 
                    required 
                    placeholder="email@client.com" 
                    className="w-full pl-9 p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                />
            </div>
            <button 
                type="submit" 
                disabled={isPending}
                className="bg-black text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-800 disabled:opacity-50 flex items-center gap-2"
            >
                {isPending ? <Loader2 className="animate-spin w-4 h-4" /> : <><Send className="w-4 h-4" /> Convidar</>}
            </button>
        </div>
        
        {state.error && (
            <p className="text-xs text-red-500 font-medium ml-1">âŒ {state.error}</p>
        )}
    </form>
  );
}

// =================== FILE: src/features/projects/ui/NewProjectForm.tsx ===================

'use client';

import { useActionState, useRef } from 'react';
import { createProjectAction } from '@/features/projects/actions';
import { Loader2, Wand2, Github, LayoutTemplate } from 'lucide-react';
import { ActionResult } from '@/types/actions';

const initialState: ActionResult = {
  success: false,
  error: '',
  fields: {} 
};

export function NewProjectForm() {
  const [state, formAction, isPending] = useActionState(createProjectAction, initialState);
  
  // âœ… SOLUCIÃ“: Usem refs en lloc de state per evitar re-renders innecessaris i conflictes
  const slugInputRef = useRef<HTMLInputElement>(null);

  const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const name = e.target.value;
    
    // LÃ²gica automÃ tica: Si l'usuari escriu el nom, actualitzem l'slug
    // nomÃ©s si l'slug estÃ  buit o comenÃ§a per 'client-' (per no matxacar canvis manuals)
    if (slugInputRef.current) {
        const currentSlug = slugInputRef.current.value;
        if (!currentSlug || currentSlug.startsWith('client-')) {
            const generated = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            slugInputRef.current.value = generated ? `client-${generated}` : '';
        }
    }
  };

  return (
    <div className="max-w-3xl mx-auto">
      <div className="bg-white dark:bg-slate-900 p-8 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800">
        
        {/* Header */}
        <div className="flex items-center gap-3 mb-8 border-b border-slate-100 dark:border-slate-800 pb-6">
          <div className="p-3 bg-blue-600 rounded-lg text-white shadow-lg shadow-blue-500/30">
            <LayoutTemplate className="w-6 h-6" />
          </div>
          <div>
            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Generador de PWA</h2>
            <p className="text-slate-500 text-sm">Crea una nova web a partir del Master Template</p>
          </div>
        </div>
      
      <form action={formAction} className="space-y-8">
        
        {/* SECCIÃ“ 1: IDENTITAT */}
        <section className="space-y-4">
            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">1. Identitat del Negoci</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label className="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Nom del Negoci</label>
                    <input 
                        name="businessName" 
                        required 
                        // PersistÃ¨ncia via defaultValue
                        defaultValue={state.fields?.businessName} 
                        onChange={handleNameChange}
                        // ğŸ¨ Estils per evitar text transparent
                        className="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all text-slate-900 dark:text-white placeholder:text-gray-400" 
                        placeholder="Ex: Restaurant Can Roca" 
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Identificador (Repo Slug)</label>
                    <div className="relative">
                        <Github className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                        <input 
                            name="slug" 
                            required 
                            ref={slugInputRef}
                            // âœ… TRUC MESTRE: 'key' forÃ§a el component a refrescar-se si el servidor torna un valor nou
                            key={state.fields?.slug || 'slug-input'} 
                            defaultValue={state.fields?.slug}
                            className="w-full pl-10 p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none text-slate-900 dark:text-white placeholder:text-gray-400" 
                            placeholder="client-nom-negoci" 
                        />
                    </div>
                </div>
            </div>

            <div>
                <label className="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Logotip (Imatge)</label>
                <input 
                    type="file" 
                    name="logo" 
                    // NomÃ©s obligatori si no hi ha errors previs (per no haver de tornar a pujar)
                    required={!state.fields}
                    accept="image/png, image/jpeg, image/webp"
                    className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-all cursor-pointer" 
                />
            </div>
        </section>

        <hr className="border-slate-100 dark:border-slate-800" />

        {/* SECCIÃ“ 2: IA */}
        <section className="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-6 rounded-xl border border-blue-100 dark:border-blue-800">
            <div className="flex items-center gap-2 mb-3">
                <Wand2 className="w-5 h-5 text-blue-600 dark:text-blue-400" />
                <span className="font-bold text-blue-800 dark:text-blue-200">GeneraciÃ³ de Contingut (IA)</span>
            </div>
            <label className="block text-sm text-blue-700 dark:text-blue-300 mb-2">
                Descriu el negoci. Gemini escriurÃ  el Hero, el "Sobre Nosaltres" i els Serveis automÃ ticament.
            </label>
            <textarea 
                name="description" 
                rows={4} 
                defaultValue={state.fields?.description}
                className="w-full p-3 border border-blue-200 dark:border-blue-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-400" 
                placeholder="Ex: Som un gimnÃ s de barri especialitzat en CrossFit i Yoga..." 
                required
            />
        </section>

        <hr className="border-slate-100 dark:border-slate-800" />

        {/* SECCIÃ“ 3: CONFIGURACIÃ“ */}
        <section className="space-y-4">
            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">3. ConfiguraciÃ³</h3>
            
            <div>
                <label className="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">Color Corporatiu</label>
                <div className="flex items-center gap-3">
                    <input 
                        type="color" 
                        name="primaryColor" 
                        defaultValue={state.fields?.primaryColor || "#7c3aed"} 
                        className="h-12 w-20 rounded cursor-pointer border border-gray-200 p-1 bg-white" 
                    />
                </div>
            </div>

            <div>
                <label className="block text-sm font-medium mb-3 text-slate-700 dark:text-slate-300">MÃ²duls</label>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    {['booking', 'blog', 'inventory'].map((mod) => (
                        <label key={mod} className="flex items-center gap-3 p-4 border border-slate-200 dark:border-slate-700 rounded-xl cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all group">
                            <input type="checkbox" name={`module_${mod}`} className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500" />
                            <span className="font-medium text-slate-700 dark:text-slate-300 capitalize">{mod}</span>
                        </label>
                    ))}
                </div>
            </div>
        </section>

        <button 
            type="submit" 
            disabled={isPending}
            className="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-4 rounded-xl font-bold text-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center gap-3 shadow-xl transition-all"
        >
            {isPending ? (
                <>
                    <Loader2 className="animate-spin w-6 h-6" /> Creant Projecte...
                </>
            ) : (
                'ğŸš€ INICIAR CONSTRUCCIÃ“'
            )}
        </button>

        {/* FEEDBACK */}
        {state?.error && (
            <div className="p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800 rounded-lg text-center animate-in fade-in slide-in-from-top-2">
                âŒ <strong>Error:</strong> {state.error}
            </div>
        )}
        
        {state?.success && state.repoUrl && (
            <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-300 p-6 rounded-xl text-center animate-in zoom-in duration-300">
                <h3 className="text-xl font-bold mb-2">ğŸ‰ Projecte Generat!</h3>
                <p className="mb-6">El repositori s'ha creat correctament.</p>
                <a 
                    href={state.repoUrl} 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-full font-bold hover:bg-green-700 transition-colors shadow-lg"
                >
                    <Github className="w-5 h-5" /> Veure Codi a GitHub
                </a>
            </div>
        )}
      </form>
      </div>
    </div>
  );
}

// =================== FILE: src/features/projects/ui/ProjectCampaignsList.tsx ===================

'use client';

import { Link } from '@/routing';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { FlaskConical, Users, ListChecks, ArrowRight, Plus } from 'lucide-react';

// âœ… 1. CORRECCIÃ“: Acceptem 'null' perquÃ¨ Supabase pot retornar nulls
type CampaignSummary = {
    id: string;
    title: string;
    status: string | null;
    testerCount: number;
    taskCount: number;
    createdAt: string | null;
};

export function ProjectCampaignsList({ campaigns, projectId }: { campaigns: CampaignSummary[], projectId: string }) {
    
    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <h3 className="text-lg font-bold text-slate-200 flex items-center gap-2">
                    <FlaskConical className="w-5 h-5 text-purple-500" />
                    Campanyes de Test ({campaigns.length})
                </h3>
                <Link href={`/admin/tests/new?projectId=${projectId}`}>
                    <Button size="sm" className="bg-purple-600 hover:bg-purple-700 text-white">
                        <Plus className="w-4 h-4 mr-2" /> Nova Campanya
                    </Button>
                </Link>
            </div>

            {campaigns.length === 0 ? (
                <div className="border-2 border-dashed border-slate-800 rounded-xl p-10 text-center">
                    <p className="text-slate-500 mb-4">Aquest projecte no tÃ© cap prova activa.</p>
                    <Link href={`/admin/tests/new?projectId=${projectId}`}>
                        <Button variant="outline">Crear primera prova</Button>
                    </Link>
                </div>
            ) : (
                <div className="grid gap-4 md:grid-cols-2">
                    {campaigns.map((camp) => (
                        <Link key={camp.id} href={`/admin/tests/${camp.id}?source=project`} className="block group">
                            <Card className="bg-slate-900 border-slate-800 group-hover:border-purple-500/50 transition-all h-full">
                                <CardHeader className="pb-2">
                                    <div className="flex justify-between items-start">
                                        <CardTitle className="text-base text-white truncate pr-2">
                                            {camp.title}
                                        </CardTitle>
                                        {/* Passem l'estat, assegurant-nos que sigui un string o undefined */}
                                        <StatusBadge status={camp.status || 'unknown'} />
                                    </div>
                                </CardHeader>
                                <CardContent>
                                    <div className="flex items-center gap-6 text-sm text-slate-400 mt-2">
                                        <div className="flex items-center gap-1.5">
                                            <Users className="w-4 h-4 text-blue-400" />
                                            <span className="font-mono font-bold text-slate-200">{camp.testerCount}</span> testers
                                        </div>
                                        <div className="flex items-center gap-1.5">
                                            <ListChecks className="w-4 h-4 text-green-400" />
                                            <span className="font-mono font-bold text-slate-200">{camp.taskCount}</span> tasques
                                        </div>
                                    </div>
                                    <div className="mt-4 flex items-center text-xs text-purple-400 font-bold opacity-0 group-hover:opacity-100 transition-opacity">
                                        Gestionar Equip i Tasques <ArrowRight className="w-3 h-3 ml-1" />
                                    </div>
                                </CardContent>
                            </Card>
                        </Link>
                    ))}
                </div>
            )}
        </div>
    );
}

// âœ… 2. CORRECCIÃ“: Tipatge robust per a l'Ã­ndex de l'objecte
function StatusBadge({ status }: { status: string }) {
    // Definim explÃ­citament que Ã©s un Record de string -> string
    // AixÃ­ TS permet indexar amb qualsevol string
    const styles: Record<string, string> = {
        active: 'bg-green-500/10 text-green-400 border-green-500/20',
        draft: 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20',
        completed: 'bg-slate-500/10 text-slate-400 border-slate-500/20',
        unknown: 'bg-slate-500/10 text-slate-500 border-slate-500/20' // Fallback visual
    };
  
    // Si l'status no existeix al mapa, fem servir 'completed' o 'unknown' per defecte
    const style = styles[status] || styles.completed;

    return (
        <span className={`px-2 py-0.5 rounded text-[10px] uppercase font-bold border ${style}`}>
            {status}
        </span>
    )
}

// =================== FILE: src/features/projects/ui/ProjectCard.tsx ===================

'use client';

import Image from 'next/image';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { ExternalLink, Layers } from 'lucide-react';
import type { Project } from '../data/projects-data';
import { useTranslations } from 'next-intl';

interface Props {
    project: Project;
    index: number;
}

export function ProjectCard({ project, index }: Props) {
    const isReversed = index % 2 !== 0;
    const t = useTranslations('ProjectCard'); // Namespace base

    return (
        <div className={`flex flex-col lg:flex-row gap-8 md:gap-16 items-center ${isReversed ? 'lg:flex-row-reverse' : ''}`}>

            {/* --- COLUMNA VISUAL (Mockup) --- */}
            <motion.div
                initial={{ opacity: 0, y: 30 }}
                whileInView={{ opacity: 1, y: 0 }}
                viewport={{ once: true }}
                transition={{ duration: 0.8 }}
                className="w-full lg:flex-1 relative group"
            >
                {/* Glow */}
                <div className={`absolute inset-0 bg-linear-to-r ${project.color} opacity-20 blur-[60px] group-hover:opacity-30 transition-opacity duration-500 pointer-events-none`}></div>

                {/* Marc Navegador */}
                <div className="relative rounded-xl border border-border bg-card shadow-2xl overflow-hidden transform transition-transform duration-500 group-hover:scale-[1.02] md:group-hover:-translate-y-2">
                    <div className="h-6 md:h-8 border-b border-border bg-muted/30 flex items-center px-3 gap-1.5 md:gap-2">
                        <div className="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full bg-red-500/50"></div>
                        <div className="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full bg-yellow-500/50"></div>
                        <div className="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full bg-green-500/50"></div>
                        <div className="ml-2 md:ml-4 px-2 py-0.5 rounded bg-background/50 text-[8px] md:text-[10px] text-muted-foreground font-mono border border-border w-full max-w-[150px] md:max-w-[200px] opacity-50 truncate">
                            https://{project.id}.com
                        </div>
                    </div>

                    {/* Imatge */}
                    <div className="aspect-4/3 md:aspect-video relative bg-muted/20 overflow-hidden group-hover:shadow-inner transition-all">
                        {project.image ? (
                            <Image
                                src={project.image}
                                alt={project.imageAlt}
                                fill
                                className="object-cover object-top transition-transform duration-700 group-hover:scale-105"
                                sizes="(max-width: 768px) 100vw, 50vw"
                                placeholder="blur"
                            />
                        ) : (
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-muted-foreground/30">
                                <Layers className="w-12 h-12 md:w-16 md:h-16 mb-4" />
                                <span className="text-xs md:text-sm font-bold uppercase tracking-widest">Captura de {project.title}</span>
                            </div>
                        )}
                    </div>
                </div>
            </motion.div>

            {/* --- COLUMNA TEXT --- */}
            <motion.div
                initial={{ opacity: 0, y: 30 }}
                whileInView={{ opacity: 1, y: 0 }}
                viewport={{ once: true }}
                transition={{ duration: 0.8, delay: 0.2 }}
                className="w-full lg:flex-1 space-y-6 md:space-y-8"
            >
                <div>
                    <div className={`inline-block px-3 py-1 rounded-lg bg-linear-to-r ${project.color} bg-opacity-10 text-[10px] md:text-xs font-bold text-white mb-4 shadow-sm`}>
                        {project.tags[0]}
                    </div>
                    <h2 className="text-3xl md:text-4xl font-bold text-foreground mb-2">{project.title}</h2>
                    <p className={`text-lg md:text-xl font-medium bg-linear-to-r ${project.color} bg-clip-text text-transparent`}>
                        {/* TRADUCCIÃ“ TAGLINE: 'ProjectCard.ribotflow.tagline' */}
                        {t(`${project.id}.tagline`)}
                    </p>
                </div>

                <p className="text-base md:text-lg text-muted-foreground leading-relaxed">
                    {/* TRADUCCIÃ“ DESCRIPCIÃ“: 'ProjectCard.ribotflow.description' */}
                    {t(`${project.id}.description`)}
                </p>

                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
                    {/* Per les stats, com que sÃ³n una llista, les traduÃ¯m per Ã­ndex */}
                    {[0, 1, 2].map((i) => (
                        <div key={i} className="flex items-center gap-3 text-sm text-foreground font-medium">
                            <div className={`w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-linear-to-r ${project.color}`}></div>
                            {/* TRADUCCIÃ“ STAT: 'ProjectCard.ribotflow.stats.0' */}
                            {t(`${project.id}.stats.${i}`)}
                        </div>
                    ))}
                </div>

                <div className="flex flex-wrap gap-2 pt-2">
                    {project.tags.map((tag) => (
                        <span key={tag} className="px-2.5 py-0.5 md:px-3 md:py-1 rounded-full border border-border bg-muted/20 text-[10px] md:text-xs font-medium text-muted-foreground">
                            {tag}
                        </span>
                    ))}
                </div>

                <div className="flex gap-4 pt-4">
                    <a href={project.link} target="_blank" rel="noreferrer" className="w-full sm:w-auto">
                        <Button className="w-full sm:w-auto gradient-bg text-white border-0 shadow-lg hover:opacity-90 transition-transform hover:-translate-y-1">
                            {t('view_web')} <ExternalLink className="ml-2 w-4 h-4" />
                        </Button>
                    </a>
                </div>
            </motion.div>

        </div>
    );
}

// =================== FILE: src/features/projects/ui/ProjectList.tsx ===================

import { PROJECTS } from '../data/projects-data';
import { ProjectCard } from './ProjectCard';

export function ProjectsList() {
  return (
    <section className="py-10 pb-20 md:pb-32">
      <div className="container mx-auto px-4 space-y-20 md:space-y-32">
         {PROJECTS.map((project, index) => (
            <ProjectCard key={project.id} project={project} index={index} />
         ))}
      </div>
    </section>
  );
}

// =================== FILE: src/features/projects/ui/ProjectsCTA.tsx ===================

'use client';

import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { ArrowRight } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function ProjectsCTA() {
  const t = useTranslations('ProjectsCTA');

  return (
    <section className="py-16 md:py-24 border-t border-border bg-muted/10">
       <div className="container mx-auto px-4 text-center">
          <h2 className="text-2xl md:text-3xl font-bold text-foreground mb-4 md:mb-6">
             {t('title_prefix')} <span className="gradient-text">{t('title_highlight')}</span>{t('title_suffix')}
          </h2>
          <p className="text-sm md:text-base text-muted-foreground mb-8 md:mb-10 max-w-xl mx-auto px-4">
             {t('description')}
          </p>
          <Link href="/#contacte">
             <Button size="lg" className="h-12 md:h-14 px-6 md:px-8 text-base md:text-lg rounded-full gradient-bg text-white hover:opacity-90 shadow-xl w-full sm:w-auto transition-transform hover:scale-105">
                {t('button')} <ArrowRight className="ml-2 w-5 h-5" />
             </Button>
          </Link>
       </div>
    </section>
  );
}

// =================== FILE: src/features/projects/ui/ProjectsHero.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { Sparkles } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function ProjectsHero() {
  const t = useTranslations('ProjectsHero');

  return (
    <section className="pt-32 pb-16 md:pt-48 md:pb-24 relative overflow-hidden">
      {/* Fons decoratiu */}
      <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] md:w-[1000px] h-[300px] md:h-[500px] bg-primary/10 blur-[80px] md:blur-[120px] rounded-full pointer-events-none opacity-50" />
      
      <div className="container mx-auto px-4 text-center relative z-10">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8 }}
        >
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-[10px] md:text-xs font-bold mb-6 uppercase tracking-widest">
            <Sparkles className="w-3 h-3" />
            {t('badge')}
          </div>
          <h1 className="text-4xl md:text-6xl lg:text-7xl font-bold mb-6 text-foreground leading-tight">
            {t('title_prefix')} <br className="hidden md:block" />
            <span className="gradient-text">{t('title_highlight')}</span>
          </h1>
          <p className="text-base md:text-xl text-muted-foreground max-w-2xl mx-auto leading-relaxed px-4">
            {t('description')}
          </p>
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/features/projects/ui/ProjectTeamManeger.tsx ===================

'use client';

import { useState } from 'react';
import { ProjectMember } from '@/repositories/supabase/SupabaseProjectRepository'; // Importa el tipus
import { addProjectMemberAction, removeProjectMemberAction } from '../actions/project-actions';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Trash2, UserPlus, Shield } from 'lucide-react';
import { toast } from 'sonner';

type Candidate = {
    id: string;
    email: string;
    full_name: string | null;
};

interface Props {
    projectId: string;
    members: ProjectMember[];
    candidates: Candidate[];
}

export function ProjectTeamManager({ projectId, members, candidates }: Props) {
    const [selectedUserId, setSelectedUserId] = useState<string>('');
    const [isPending, setIsPending] = useState(false);

    const handleAdd = async () => {
        if (!selectedUserId) return;
        setIsPending(true);
        const res = await addProjectMemberAction(projectId, selectedUserId);
        
        if (res.success) {
            toast.success(res.message);
            setSelectedUserId(''); // Reset
        } else {
            toast.error(res.message);
        }
        setIsPending(false);
    };

    const handleRemove = async (userId: string) => {
        if (!confirm("Segur que vols eliminar aquest membre del projecte?")) return;
        setIsPending(true);
        const res = await removeProjectMemberAction(projectId, userId);
        
        if (res.success) toast.success(res.message);
        else toast.error(res.message);
        setIsPending(false);
    };

    return (
        <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 shadow-sm h-full flex flex-col">
            <h3 className="text-lg font-bold mb-6 flex items-center gap-2 text-slate-900 dark:text-white">
                <Shield className="w-5 h-5 text-blue-500" /> Equip del Projecte
            </h3>

            {/* AFEGIR MEMBRE */}
            <div className="flex gap-2 mb-6">
                <Select value={selectedUserId} onValueChange={setSelectedUserId}>
                    <SelectTrigger className="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700">
                        <SelectValue placeholder="Seleccionar usuari..." />
                    </SelectTrigger>
                    <SelectContent>
                        {candidates.length === 0 ? (
                            <SelectItem value="none" disabled>No hi ha mÃ©s candidats</SelectItem>
                        ) : (
                            candidates.map(c => (
                                <SelectItem key={c.id} value={c.id}>
                                    {c.full_name || 'Sense nom'} ({c.email})
                                </SelectItem>
                            ))
                        )}
                    </SelectContent>
                </Select>
                <Button onClick={handleAdd} disabled={isPending || !selectedUserId} className="bg-blue-600 text-white">
                    <UserPlus className="w-4 h-4" />
                </Button>
            </div>

            {/* LLISTA DE MEMBRES */}
            <div className="space-y-3 flex-1 overflow-y-auto max-h-[300px] pr-1">
                {members.map((m) => (
                    <div key={m.user_id} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-700 group">
                        <div className="flex items-center gap-3">
                            <Avatar className="h-9 w-9 border border-slate-200 dark:border-slate-700">
                                <AvatarImage src={m.profile.avatar_url || ''} />
                                <AvatarFallback>{m.profile.email[0].toUpperCase()}</AvatarFallback>
                            </Avatar>
                            <div>
                                <p className="text-sm font-bold text-slate-900 dark:text-slate-200">
                                    {m.profile.full_name || 'Usuari'}
                                </p>
                                <p className="text-xs text-slate-500">{m.profile.email}</p>
                            </div>
                        </div>
                        
                        <Button 
                            variant="ghost" 
                            size="icon" 
                            onClick={() => handleRemove(m.user_id)}
                            disabled={isPending}
                            className="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 transition-opacity"
                        >
                            <Trash2 className="w-4 h-4" />
                        </Button>
                    </div>
                ))}

                {members.length === 0 && (
                    <div className="text-center py-8 text-slate-400 text-sm italic">
                        No hi ha ningÃº vinculat. Afegeix el primer membre.
                    </div>
                )}
            </div>
        </div>
    );
}

// =================== FILE: src/features/tests/actions/admin-actions.ts ===================

'use server';

import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { requireAdmin } from '@/lib/auth/admin-guard'; // La teva funciÃ³ de seguretat
import { revalidatePath } from 'next/cache';
import { redirect } from 'next/navigation';
import { postService } from '@/services/container'; // Soluciona "No se encuentra postService"
  
const repo = new SupabaseTestRepository();
// 1. Definim el tipus d'estat (State)
export type ActionState = {
  success: boolean;
  message: string;
};
export async function addTesterAction(campaignId: string, userId: string) {
  await requireAdmin(); // ğŸ›¡ï¸ Seguretat crÃ­tica

  const { error } = await repo.assignTester(campaignId, userId);

  if (error) {
    // Codi d'error de Postgres per duplicats (si ja estava assignat)
    if (error.code === '23505') return { success: false, message: 'Aquest usuari ja estÃ  assignat.' };
    return { success: false, message: error.message };
  }

  revalidatePath('/admin/tests/[id]', 'page');
  return { success: true, message: 'Tester assignat correctament.' };
}

export async function removeTesterAction(campaignId: string, userId: string) {
  await requireAdmin();

  const { error } = await repo.removeTester(campaignId, userId);
  if (error) return { success: false, message: error.message };

  revalidatePath('/admin/tests/[id]', 'page');
  return { success: true, message: 'Tester eliminat.' };
}


// 2. Apliquem el tipus a 'prevState' i al retorn
export async function createCampaignAction(
  prevState: ActionState,
  formData: FormData
): Promise<ActionState> {

  await requireAdmin();

  const projectId = formData.get('projectId') as string;
  const title = formData.get('title') as string;
  const description = formData.get('description') as string;
  const instructions = formData.get('instructions') as string;

  if (!projectId || !title) {
    return { success: false, message: 'Falten camps obligatoris' };
  }

  try {
    const { data, error } = await repo.createCampaign({
      projectId, title, description, instructions
    });

    if (error) {
      return { success: false, message: error.message };
    }

    // Si tot va bÃ©, redirigim (aixÃ² interromp l'execuciÃ³, Ã©s normal)
    redirect(`/admin/tests/${data.id}`);

  } catch (error) {
    // Si l'error Ã©s la redirecciÃ³ de Next.js, la deixem passar
    if ((error as Error).message === 'NEXT_REDIRECT') {
      throw error;
    }
    return { success: false, message: 'Error creant la campanya' };
  }
}

export async function updatePostDetailsAction(prevState: ActionState, formData: FormData): Promise<ActionState> {
  await requireAdmin();

  const slug = formData.get('slug') as string;
  const title = formData.get('title') as string;
  const description = formData.get('description') as string;
  const date = formData.get('date') as string;

  // âœ… RECUPEREM EL CONTINGUT (AixÃ² faltava o fallava)
  const content = formData.get('content') as string;

  // âœ… RECUPEREM EL CHECKBOX (Si estÃ  marcat envia 'on', si no null)
  const reviewed = formData.get('reviewed') === 'on';

  try {
    await postService.updatePost(slug, {
      title,
      description,
      content, // ğŸ‘ˆ Passem el contingut
      reviewed, // ğŸ‘ˆ Passem l'estat revisat
      date: date ? new Date(date).toISOString() : undefined,
    });

    revalidatePath('/admin/blog');

    // Opcional: Si vols que es quedi a la pÃ gina d'ediciÃ³ per seguir escrivint,
    // comenta la lÃ­nia del redirect o fes un revalidatePath de la pÃ gina actual.
    // redirect({ href: '/admin/blog', locale }); 

    return { success: true, message: 'Canvis guardats correctament.' };
  } catch (e) {
    if ((e as Error).message === 'NEXT_REDIRECT') throw e;
    console.error(e);
    return { success: false, message: 'Error guardant els canvis.' };
  }
}
// ... imports existents

export async function updateCampaignAction(
  prevState: ActionState, 
  formData: FormData
): Promise<ActionState> {
  await requireAdmin();

  const id = formData.get('id') as string;
  if (!id) return { success: false, message: "Falta l'ID de la campanya" };

  // âœ… CORRECCIÃ“: Definim el tipus exacte en lloc de 'any'
  // AixÃ² diu: "updates Ã©s un objecte on les claus sÃ³n strings opcionals"
  const updates: {
    title?: string;
    description?: string;
    status?: string;
    instructions?: string;
  } = {};
  
  // Ara TypeScript estÃ  content perquÃ¨ sap quÃ¨ esperar
  if (formData.has('title')) updates.title = formData.get('title') as string;
  if (formData.has('description')) updates.description = formData.get('description') as string;
  if (formData.has('status')) updates.status = formData.get('status') as string;
  if (formData.has('instructions')) updates.instructions = formData.get('instructions') as string;

  const { error } = await repo.updateCampaign(id, updates);

  if (error) return { success: false, message: error.message };

  revalidatePath(`/admin/tests/${id}`);
  return { success: true, message: 'Guardat correctament!' };
}

export async function deleteCampaignAction(campaignId: string, projectId: string) {
  await requireAdmin();

  const { error } = await repo.deleteCampaign(campaignId);

  if (error) {
    // Si falla, no podem fer gaire cosa mÃ©s que llenÃ§ar error o retornar-lo
    throw new Error(error.message);
  }

  // Refresquem la pÃ gina del projecte perquÃ¨ desaparegui de la llista
  revalidatePath(`/admin/projects/${projectId}`);
  
  // Redirigim a la fitxa del projecte
  redirect(`/admin/projects/${projectId}`);
}

// =================== FILE: src/features/tests/actions/task-actions.ts ===================

// fitxer: src/features/tests/actions/task-actions.ts

'use server';

import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { requireAdmin } from '@/lib/auth/admin-guard';
import { revalidatePath } from 'next/cache';
import { z } from 'zod';

const repo = new SupabaseTestRepository();

// 1. Definim el tipus per a l'estat de l'acciÃ³
export type TaskActionState = {
  success: boolean;
  message: string;
};

// ValidaciÃ³ Zod
const TaskSchema = z.object({
  campaignId: z.string().uuid(),
  title: z.string().min(3, "El tÃ­tol Ã©s massa curt"),
  description: z.string().optional(),
});

// 2. Tipem 'prevState' correctament
export async function addTaskAction(prevState: TaskActionState, formData: FormData): Promise<TaskActionState> {
  await requireAdmin();

  const rawData = {
    campaignId: formData.get('campaignId'),
    title: formData.get('title'),
    description: formData.get('description'),
  };

  const validated = TaskSchema.safeParse(rawData);

  if (!validated.success) {
    // 3. CORRECCIÃ“ ZOD: Usem .issues[0] per assegurar el tipatge correcte
    return { success: false, message: validated.error.issues[0].message };
  }

  const { error } = await repo.createTask({
      campaignId: validated.data.campaignId as string,
      title: validated.data.title as string,
      description: validated.data.description as string,
      orderIndex: 999 
  });

  if (error) return { success: false, message: error.message };

  revalidatePath(`/admin/tests/${rawData.campaignId}`);
  return { success: true, message: 'Tasca afegida correctament' };
}

export async function deleteTaskAction(taskId: string, campaignId: string): Promise<TaskActionState> {
    await requireAdmin();
    const { error } = await repo.deleteTask(taskId);
    if(error) return { success: false, message: error.message };
    
    revalidatePath(`/admin/tests/${campaignId}`);
    return { success: true, message: 'Tasca eliminada' };
}

// =================== FILE: src/features/tests/actions.ts ===================

'use server';

import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';

const repo = new SupabaseTestRepository();

export async function submitTestFeedback(taskId: string, status: 'pass' | 'fail' | 'blocked', comment: string) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) return { success: false, message: 'No autenticat' };

  const { error } = await repo.saveResult(user.id, taskId, status, comment);

  if (error) return { success: false, message: error.message };
  
  // Refresquem el dashboard per veure el canvi d'estat
  revalidatePath('/dashboard/projects/[id]', 'page'); 
  return { success: true };
}

// =================== FILE: src/features/tests/ui/CampaignAnalytics.tsx ===================

'use client';

import { Card, CardContent } from '@/components/ui/card'; // âŒ Treu CardTitle, CardHeader
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
// âŒ Treu Badge (no es fa servir)
import { Progress } from '@/components/ui/progress';
import { CheckCircle2, XCircle, AlertTriangle, MessageSquare, Activity } from 'lucide-react';

// âœ… Definim tipus per a les dades que rebem (COINCIDENT AMB EL REPOSITORI)
type TestResult = {
    id: string;
    status: 'pass' | 'fail' | 'blocked'; // AquÃ­ Ã©s on fallava
    comment?: string | null;
    updated_at: string;
    taskTitle: string;
    user_id: string;
    tester: {
        id?: string; // Opcional perquÃ¨ a vegades ve del map
        full_name: string | null;
        email: string;
        avatar_url: string | null;
    };
};

type AnalyticsData = {
    results: TestResult[];
    totalTasks: number;
};

// Tipus auxiliar per a les estadÃ­stiques d'usuari
type UserStat = {
    user: TestResult['tester'];
    completed: number;
    passed: number;
    failed: number;
};

export function CampaignAnalytics({ data }: { data: AnalyticsData }) {
    const { results, totalTasks } = data;

    // 1. CÃ lculs KPI Globals
    const totalExecutions = results.length;
    const passed = results.filter(r => r.status === 'pass').length;
    const failed = results.filter(r => r.status === 'fail').length;
    // const blocked = results.filter(r => r.status === 'blocked').length; // No l'usem al KPI card, perÃ² existeix
    
    const successRate = totalExecutions > 0 ? Math.round((passed / totalExecutions) * 100) : 0;

    // 2. Agrupar per Usuari (Leaderboard)
    const userStats = new Map<string, UserStat>();
    
    results.forEach(r => {
        if (!userStats.has(r.user_id)) {
            userStats.set(r.user_id, { 
                user: r.tester, 
                completed: 0, 
                passed: 0, 
                failed: 0 
            });
        }
        const stats = userStats.get(r.user_id)!;
        stats.completed++;
        if (r.status === 'pass') stats.passed++;
        if (r.status === 'fail') stats.failed++;
    });

    const leaderboard = Array.from(userStats.values());

    // 3. Filtrar IncidÃ¨ncies (Fails, Blocked o amb Comentaris)
    const issues = results.filter(r => r.status === 'fail' || r.status === 'blocked' || r.comment);

    return (
        <div className="space-y-8">
            
            {/* KPI CARDS */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <Card className="bg-slate-900 border-slate-800">
                    <CardContent className="p-6">
                        <div className="text-slate-400 text-xs uppercase font-bold mb-1">Total Validacions</div>
                        <div className="text-3xl font-bold text-white">{totalExecutions}</div>
                    </CardContent>
                </Card>
                <Card className="bg-slate-900 border-slate-800">
                    <CardContent className="p-6">
                        <div className="text-slate-400 text-xs uppercase font-bold mb-1">Taxa d'Ãˆxit</div>
                        <div className={`text-3xl font-bold ${successRate > 80 ? 'text-green-400' : 'text-yellow-400'}`}>
                            {successRate}%
                        </div>
                    </CardContent>
                </Card>
                <Card className="bg-red-900/10 border-red-900/20">
                    <CardContent className="p-6">
                        <div className="text-red-400 text-xs uppercase font-bold mb-1">Errors CrÃ­tics</div>
                        <div className="text-3xl font-bold text-red-500">{failed}</div>
                    </CardContent>
                </Card>
                <Card className="bg-slate-900 border-slate-800">
                    <CardContent className="p-6">
                        <div className="text-slate-400 text-xs uppercase font-bold mb-1">Testers Actius</div>
                        <div className="text-3xl font-bold text-blue-400">{leaderboard.length}</div>
                    </CardContent>
                </Card>
            </div>

            <div className="grid lg:grid-cols-3 gap-8">
                
                {/* FEEDBACK & INCIDÃˆNCIES (2 cols) */}
                <div className="lg:col-span-2 space-y-4">
                    <h3 className="font-bold text-white flex items-center gap-2">
                        <MessageSquare className="w-5 h-5 text-orange-400" />
                        Feedback i IncidÃ¨ncies Recents
                    </h3>
                    
                    {issues.length === 0 ? (
                        <div className="p-8 border border-slate-800 rounded-xl text-center text-slate-500 bg-slate-900/50">
                            Tot net! No hi ha comentaris ni errors reportats.
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {issues.map((issue) => (
                                <div key={issue.id} className="bg-slate-900 border border-slate-800 p-4 rounded-xl flex gap-4 items-start">
                                    <div className="mt-1">
                                        {issue.status === 'fail' && <XCircle className="w-5 h-5 text-red-500" />}
                                        {issue.status === 'blocked' && <AlertTriangle className="w-5 h-5 text-orange-500" />}
                                        {issue.status === 'pass' && <CheckCircle2 className="w-5 h-5 text-green-500" />}
                                    </div>
                                    <div className="flex-1">
                                        <div className="flex justify-between items-start mb-1">
                                            <h4 className="font-bold text-slate-200 text-sm">{issue.taskTitle}</h4>
                                            <span className="text-xs text-slate-500">
                                                {new Date(issue.updated_at).toLocaleDateString()}
                                            </span>
                                        </div>
                                        {issue.comment && (
                                            <p className="text-sm text-slate-400 bg-black/20 p-2 rounded mb-2">
                                                "{issue.comment}"
                                            </p>
                                        )}
                                        <div className="flex items-center gap-2">
                                            <Avatar className="w-5 h-5">
                                                <AvatarImage src={issue.tester.avatar_url || ''} />
                                                <AvatarFallback className="text-[9px]">{issue.tester.email[0].toUpperCase()}</AvatarFallback>
                                            </Avatar>
                                            <span className="text-xs text-slate-500">{issue.tester.full_name || issue.tester.email}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* LEADERBOARD / PROGRÃ‰S USUARIS (1 col) */}
                <div className="space-y-4">
                    <h3 className="font-bold text-white flex items-center gap-2">
                        <Activity className="w-5 h-5 text-blue-400" />
                        ProgrÃ©s de l'Equip
                    </h3>
                    
                    <div className="bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-6">
                        {leaderboard.length === 0 ? (
                            <p className="text-sm text-slate-500 text-center">Encara ningÃº ha comenÃ§at.</p>
                        ) : (
                            leaderboard.map((stat, index) => {
                                // Evitem divisiÃ³ per zero
                                const progress = totalTasks > 0 ? Math.round((stat.completed / totalTasks) * 100) : 0;
                                
                                return (
                                    // Afegim index a la clau per seguretat extra
                                    <div key={`${stat.user.email}-${index}`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <div className="flex items-center gap-2">
                                                <Avatar className="w-6 h-6">
                                                    <AvatarImage src={stat.user.avatar_url || ''} />
                                                    <AvatarFallback className="text-[10px]">{stat.user.email[0].toUpperCase()}</AvatarFallback>
                                                </Avatar>
                                                <span className="text-sm font-medium text-slate-300 truncate max-w-[100px]">
                                                    {stat.user.full_name || 'Usuari'}
                                                </span>
                                            </div>
                                            <span className="text-xs font-bold text-white">{progress}%</span>
                                        </div>
                                        <Progress value={progress} className="h-1.5 bg-slate-800" />
                                        <div className="flex gap-2 mt-1 justify-end">
                                            <span className="text-[10px] text-green-500">{stat.passed} OK</span>
                                            <span className="text-[10px] text-red-500">{stat.failed} KO</span>
                                        </div>
                                    </div>
                                )
                            })
                        )}
                    </div>
                </div>

            </div>
        </div>
    );
}

// =================== FILE: src/features/tests/ui/CampaignDetailsForm.tsx ===================

'use client';

import { useActionState } from 'react';
import { TestCampaignDTO } from '@/types/models';
import { updateCampaignAction, ActionState } from '@/features/tests/actions/admin-actions'; // Importa l'acciÃ³ nova
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Save, Loader2, CheckCircle2 } from 'lucide-react';
import { toast } from 'sonner';
import { useEffect } from 'react';

const initialState: ActionState = { success: false, message: '' };

export function CampaignDetailsForm({ campaign }: { campaign: TestCampaignDTO }) {
    // Creem dos estats separats per evitar que un formulari bloquegi l'altre
    const [stateGeneral, actionGeneral, isPendingGeneral] = useActionState(updateCampaignAction, initialState);
    const [stateDocs, actionDocs, isPendingDocs] = useActionState(updateCampaignAction, initialState);

    // Efecte per mostrar Toast quan es guarda correctament
    useEffect(() => {
        if (stateGeneral.success) toast.success(stateGeneral.message);
        else if (stateGeneral.message) toast.error(stateGeneral.message);
    }, [stateGeneral]);

    useEffect(() => {
        if (stateDocs.success) toast.success(stateDocs.message);
        else if (stateDocs.message) toast.error(stateDocs.message);
    }, [stateDocs]);

    return (
        <div className="grid lg:grid-cols-2 gap-8">
            
            {/* --- FORMULARI 1: CONFIGURACIÃ“ GENERAL --- */}
            <Card className="bg-slate-900 border-slate-800">
                <CardContent className="p-6">
                    <form action={actionGeneral} className="space-y-4">
                        <input type="hidden" name="id" value={campaign.id} />
                        
                        <h3 className="text-lg font-bold text-white mb-4">ConfiguraciÃ³ General</h3>
                        
                        <div className="space-y-2">
                            <label className="text-sm text-slate-400">TÃ­tol de la Campanya</label>
                            <Input 
                                name="title"
                                defaultValue={campaign.title} 
                                className="bg-black border-slate-700 text-white" 
                            />
                        </div>
                        
                        <div className="space-y-2">
                            <label className="text-sm text-slate-400">Estat</label>
                            <select 
                                name="status"
                                className="w-full h-10 px-3 py-2 rounded-md border border-slate-700 bg-black text-white text-sm focus:outline-none focus:ring-2 focus:ring-slate-400 focus:border-transparent"
                                defaultValue={campaign.status}
                            >
                                <option value="active">Activa (Visible)</option>
                                <option value="draft">Esborrany (Oculta)</option>
                                <option value="completed">Tancada</option>
                            </select>
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm text-slate-400">DescripciÃ³ Curta</label>
                            <Input 
                                name="description"
                                defaultValue={campaign.description || ''} 
                                className="bg-black border-slate-700 text-white" 
                            />
                        </div>

                        <Button disabled={isPendingGeneral} className="w-full mt-4 bg-slate-800 hover:bg-slate-700 text-white">
                            {isPendingGeneral ? <Loader2 className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4 mr-2" />}
                            Guardar ConfiguraciÃ³
                        </Button>
                    </form>
                </CardContent>
            </Card>

            {/* --- FORMULARI 2: DOCUMENTACIÃ“ --- */}
            <Card className="bg-slate-900 border-slate-800 flex flex-col">
                <CardContent className="p-6 flex-1 flex flex-col h-full">
                    <form action={actionDocs} className="contents">
                        <input type="hidden" name="id" value={campaign.id} />

                        <div className="mb-2">
                            <h3 className="text-lg font-bold text-white">DocumentaciÃ³ per al Tester</h3>
                            <p className="text-xs text-slate-500 mt-1">
                                Aquest text apareixerÃ  a la part esquerra de la pantalla del tester.
                            </p>
                        </div>
                        
                        <Textarea 
                            name="instructions"
                            className="bg-black border-slate-700 text-white font-mono text-sm flex-1 min-h-[300px] resize-none leading-relaxed p-4 mb-4" 
                            defaultValue={campaign.instructions || ''}
                            placeholder="# Guia de Proves..."
                        />
                        
                        <Button disabled={isPendingDocs} className="w-full bg-blue-600 hover:bg-blue-700 text-white">
                            {isPendingDocs ? <Loader2 className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4 mr-2" />}
                            Guardar DocumentaciÃ³
                        </Button>
                    </form>
                </CardContent>
            </Card>
        </div>
    )
}

// =================== FILE: src/features/tests/ui/CreateCampaignForm.tsx ===================

// src/features/tests/ui/CreateCampaignForm.tsx
'use client';

import { useActionState } from 'react';
// IMPORT CRÃTIC: Assegura't que la ruta Ã©s correcta
import { createCampaignAction, ActionState } from '@/features/tests/actions/admin-actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Save, Loader2, AlertCircle } from 'lucide-react';

const initialState: ActionState = {
  success: false,
  message: '',
};

type ProjectSummary = {
    id: string;
    name: string;
};

// ğŸ‘‡ ASSEGURA'T QUE POSA 'export function', NO 'export default function'
export function CreateCampaignForm({ projects }: { projects: ProjectSummary[] }) {
  const [state, action, isPending] = useActionState(createCampaignAction, initialState);

  return (
    <form action={action} className="space-y-6">
        {/* ... (el teu codi del formulari) ... */}
        {/* Si no tens el codi a mÃ , copia'l del pas anterior, perÃ² la clau Ã©s la lÃ­nia de l'export */}
        <div className="space-y-2">
            <label className="text-sm font-medium text-slate-300">Projecte</label>
            <select name="projectId" required className="w-full p-3 rounded-lg bg-slate-900 border border-slate-700 text-white">
                <option value="">Selecciona...</option>
                {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
            </select>
        </div>
        <div className="space-y-2">
            <label className="text-sm font-medium text-slate-300">TÃ­tol</label>
            <Input name="title" required className="bg-slate-900 border-slate-700 text-white" />
        </div>
        <div className="space-y-2">
            <label className="text-sm font-medium text-slate-300">DescripciÃ³</label>
            <Input name="description" className="bg-slate-900 border-slate-700 text-white" />
        </div>
        <div className="space-y-2">
            <label className="text-sm font-medium text-slate-300">Instruccions Inicials</label>
            <textarea name="instructions" rows={4} className="w-full p-3 rounded-lg bg-slate-900 border-slate-700 text-white" />
        </div>
        
        {state.message && !state.success && (
            <div className="text-red-400 text-sm flex gap-2"><AlertCircle className="w-4 h-4"/> {state.message}</div>
        )}

        <Button type="submit" disabled={isPending} className="w-full">
            {isPending ? <Loader2 className="animate-spin" /> : <><Save className="w-4 h-4 mr-2" /> Crear</>}
        </Button>
    </form>
  );
}

// =================== FILE: src/features/tests/ui/DeleteCampaignButton.tsx ===================

'use client';

import { useState } from 'react';
import { deleteCampaignAction } from '@/features/tests/actions/admin-actions';
import { Button } from '@/components/ui/button';
import { Trash2, Loader2 } from 'lucide-react';
import { toast } from 'sonner';

interface Props {
  campaignId: string;
  projectId: string;
}

export function DeleteCampaignButton({ campaignId, projectId }: Props) {
  const [isDeleting, setIsDeleting] = useState(false);

  const handleDelete = async () => {
    if (!confirm("âš ï¸ ATENCIÃ“: EstÃ s segur que vols eliminar aquesta campanya?\n\nS'esborraran totes les tasques, resultats i assignacions de forma permanent.")) {
      return;
    }

    setIsDeleting(true);
    try {
      await deleteCampaignAction(campaignId, projectId);
      // Nota: Si l'acciÃ³ fa redirect, el codi d'aquÃ­ sota potser no s'arriba a executar, 
      // perÃ² el toast ajuda si hi ha retard.
      toast.success("Campanya eliminada");
    } catch (error) {
      console.error(error);
      toast.error("Error eliminant la campanya");
      setIsDeleting(false);
    }
  };

  return (
    <Button 
      variant="destructive" 
      size="sm" 
      onClick={handleDelete} 
      disabled={isDeleting}
      className="bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white border border-red-500/50 transition-colors"
    >
      {isDeleting ? <Loader2 className="w-4 h-4 animate-spin" /> : <Trash2 className="w-4 h-4 mr-2" />}
      Eliminar Test
    </Button>
  );
}

// =================== FILE: src/features/tests/ui/MissionCard.tsx ===================

'use client';

import { Link } from '@/routing';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { ArrowRight, CheckCircle2, XCircle, Zap } from 'lucide-react';
// ğŸ‘‡ Importem el tipus correcte
import type { MissionStats } from '@/services/GamificationService';

interface Props {
    id: string; 
    projectId: string;
    title: string;
    description: string | null;
    stats: MissionStats; // Ara sÃ­ que coincidirÃ  amb el que retorna el servei
}

export function MissionCard({ id, projectId, title, description, stats }: Props) {
    // Determinem el color de la vora segons l'estat
    let borderClass = "hover:border-purple-500/50";
    if (stats.failed > 0) borderClass = "border-red-500/30 hover:border-red-500";
    else if (stats.progress === 100) borderClass = "border-green-500/50 hover:border-green-500";

    return (
        <Link href={`/dashboard/projects/${projectId}/${id}`} className="group block h-full">
            <Card className={`h-full transition-all duration-300 hover:shadow-xl hover:-translate-y-1 bg-white dark:bg-slate-900 border ${borderClass}`}>
                <CardHeader className="pb-3">
                    <div className="flex justify-between items-start mb-2">
                        <Badge variant="outline" className="bg-purple-500/10 text-purple-500 border-purple-500/20 font-mono text-[10px]">
                            {stats.xpReward} XP
                        </Badge>
                        {stats.progress === 100 && (
                            <Badge className="bg-green-500 text-white hover:bg-green-600">COMPLETAT</Badge>
                        )}
                    </div>
                    <CardTitle className="text-lg font-bold group-hover:text-purple-400 transition-colors line-clamp-1 text-foreground">
                        {title}
                    </CardTitle>
                </CardHeader>
                
                <CardContent>
                    <p className="text-sm text-muted-foreground line-clamp-2 mb-6 h-10">
                        {description || "Sense descripciÃ³ disponible..."}
                    </p>

                    {/* BARRA DE PROGRÃ‰S */}
                    <div className="mb-4">
                        <div className="flex justify-between text-xs font-bold mb-1.5">
                            <span className="text-muted-foreground">ProgrÃ©s</span>
                            <span className={stats.progress === 100 ? "text-green-500" : "text-foreground"}>{stats.progress}%</span>
                        </div>
                        <Progress value={stats.progress} className="h-2 bg-slate-100 dark:bg-slate-800" />
                    </div>

                    {/* GRID D'ESTADÃSTIQUES */}
                    <div className="grid grid-cols-3 gap-2 py-3 border-t border-border">
                        <div className="flex flex-col items-center p-2 rounded bg-green-500/5 border border-green-500/10">
                            <CheckCircle2 className="w-4 h-4 text-green-500 mb-1" />
                            <span className="text-xs font-bold text-green-600 dark:text-green-400">{stats.passed}</span>
                            <span className="text-[10px] text-muted-foreground uppercase">Fets</span>
                        </div>
                        <div className="flex flex-col items-center p-2 rounded bg-red-500/5 border border-red-500/10">
                            <XCircle className="w-4 h-4 text-red-500 mb-1" />
                            <span className="text-xs font-bold text-red-600 dark:text-red-400">{stats.failed}</span>
                            <span className="text-[10px] text-muted-foreground uppercase">Errors</span>
                        </div>
                        <div className="flex flex-col items-center p-2 rounded bg-muted border border-border">
                            <Zap className="w-4 h-4 text-yellow-500 mb-1" />
                            <span className="text-xs font-bold text-foreground">{stats.pending}</span>
                            <span className="text-[10px] text-muted-foreground uppercase">Queden</span>
                        </div>
                    </div>

                    <div className="mt-4 flex items-center justify-end text-xs font-bold text-purple-600 dark:text-purple-400 group-hover:text-purple-500 transition-colors">
                        Continuar MissiÃ³ <ArrowRight className="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" />
                    </div>
                </CardContent>
            </Card>
        </Link>
    );
}

// =================== FILE: src/features/tests/ui/TaskManager.tsx ===================

// fitxer: src/features/tests/ui/TaskManager.tsx

'use client';

import { useActionState, useRef } from 'react';
import { TestTaskDTO } from '@/types/models';
// Importem el tipus que hem definit abans
import { addTaskAction, deleteTaskAction, TaskActionState } from '../actions/task-actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
// 1. CORRECCIÃ“: Eliminem CardContent que no es feia servir
import { Plus, Trash2, ListChecks } from 'lucide-react';
import { toast } from 'sonner';

const initialState: TaskActionState = { success: false, message: '' };

export function TaskManager({ campaignId, tasks }: { campaignId: string, tasks: TestTaskDTO[] }) {
    const formRef = useRef<HTMLFormElement>(null);

    // 2. CORRECCIÃ“: Tipem 'prev' i usem '_' per 'state' si no el pintem a la UI
    // (O millor, fem servir state.message si volem mostrar errors en text vermell)
    // De moment, per treure l'error de "unused", el renomenem a "_state"
    const [_state, action, isPending] = useActionState(async (prev: TaskActionState, formData: FormData) => {
        const result = await addTaskAction(prev, formData);
        if (result.success) {
            formRef.current?.reset();
            toast.success("Tasca afegida!");
        } else {
            toast.error(result.message);
        }
        return result;
    }, initialState);

    const handleDelete = async (taskId: string) => {
        if(!confirm("Segur que vols esborrar aquesta tasca?")) return;
        const res = await deleteTaskAction(taskId, campaignId);
        if(res.success) toast.success("Esborrada");
        else toast.error(res.message);
    }

    return (
        <div className="grid lg:grid-cols-3 gap-8">
            
            {/* COLUMNA 1: LLISTAT DE TASQUES EXISTENTS */}
            <div className="lg:col-span-2 space-y-4">
                <h3 className="text-lg font-bold text-white flex items-center gap-2">
                    <ListChecks className="w-5 h-5 text-blue-500" /> 
                    Llista de VerificaciÃ³ ({tasks.length})
                </h3>
                
                {tasks.length === 0 && (
                    <div className="p-8 border-2 border-dashed border-slate-800 rounded-xl text-center text-slate-500">
                        No hi ha tasques definides. Afegeix la primera a la dreta ğŸ‘‰
                    </div>
                )}

                <div className="space-y-2">
                    {tasks.map((task, index) => (
                        <div key={task.id} className="bg-slate-900 border border-slate-800 p-4 rounded-lg flex items-start justify-between group hover:border-slate-700 transition-colors">
                            <div className="flex gap-3">
                                <span className="bg-slate-800 text-slate-400 w-6 h-6 flex items-center justify-center rounded text-xs font-mono mt-0.5">
                                    {index + 1}
                                </span>
                                <div>
                                    <p className="font-medium text-slate-200">{task.title}</p>
                                    {task.description && (
                                        <p className="text-sm text-slate-500 mt-1">{task.description}</p>
                                    )}
                                </div>
                            </div>
                            <Button 
                                size="icon" 
                                variant="ghost" 
                                className="text-slate-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                onClick={() => handleDelete(task.id)}
                            >
                                <Trash2 className="w-4 h-4" />
                            </Button>
                        </div>
                    ))}
                </div>
            </div>

            {/* COLUMNA 2: FORMULARI PER AFEGIR (Sticky) */}
            <div className="lg:col-span-1">
                <div className="bg-slate-900 border border-slate-800 p-6 rounded-xl sticky top-6">
                    <h3 className="font-bold text-white mb-4">Nova Tasca</h3>
                    <form ref={formRef} action={action} className="space-y-4">
                        <input type="hidden" name="campaignId" value={campaignId} />
                        
                        <div>
                            <label className="text-xs text-slate-400 uppercase font-bold">TÃ­tol (AcciÃ³)</label>
                            <Input 
                                name="title" 
                                placeholder="Ex: Verificar registre..." 
                                className="bg-black border-slate-700 text-white mt-1" 
                                required
                            />
                        </div>

                        <div>
                            <label className="text-xs text-slate-400 uppercase font-bold">Detalls (Opcional)</label>
                            <Textarea 
                                name="description" 
                                placeholder="Ex: L'usuari hauria de rebre un correu..." 
                                className="bg-black border-slate-700 text-white mt-1 resize-none" 
                                rows={3}
                            />
                        </div>

                        <Button type="submit" disabled={isPending} className="w-full bg-blue-600 hover:bg-blue-700 text-white">
                            <Plus className="w-4 h-4 mr-2" /> Afegir a la Llista
                        </Button>
                    </form>
                </div>
            </div>

        </div>
    );
}

// =================== FILE: src/features/tests/ui/TaskRunner.tsx ===================

'use client';

import { useState } from 'react';
import { TestTaskDTO, TestResultDTO } from '@/types/models';
import { CheckCircle, XCircle, AlertTriangle, ChevronDown, ChevronUp } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { submitTestFeedback } from '../actions';

// Simple toast casolÃ  o usa 'sonner'/'react-hot-toast' si en tens
const notify = (msg: string) => alert(msg); 

export function TaskRunner({ task, existingResult }: { task: TestTaskDTO, existingResult?: TestResultDTO }) {
  const [isOpen, setIsOpen] = useState(!existingResult); 
  const [status, setStatus] = useState<string | null>(existingResult?.status || null);
  const [comment, setComment] = useState(existingResult?.comment || '');
  const [isSaving, setIsSaving] = useState(false);

  const handleSubmit = async (newStatus: 'pass' | 'fail' | 'blocked') => {
    setIsSaving(true);
    setStatus(newStatus); 
    
    const res = await submitTestFeedback(task.id, newStatus, comment);
    
    if (res.success) {
      setIsOpen(false); 
    } else {
      notify('Error guardant.');
    }
    setIsSaving(false);
  };

  return (
    <div className={`border rounded-xl mb-4 transition-all bg-white dark:bg-slate-900 ${
        status === 'pass' ? 'border-green-500/30 bg-green-50/10' : 
        status === 'fail' ? 'border-red-500/30 bg-red-50/10' : 
        'border-border'
    }`}>
      
      {/* Header */}
      <div 
        className="p-4 flex items-center justify-between cursor-pointer select-none"
        onClick={() => setIsOpen(!isOpen)}
      >
        <div className="flex items-center gap-3">
          {status === 'pass' && <CheckCircle className="text-green-500 w-5 h-5" />}
          {status === 'fail' && <XCircle className="text-red-500 w-5 h-5" />}
          {status === 'blocked' && <AlertTriangle className="text-orange-500 w-5 h-5" />}
          {!status && <div className="w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600" />}
          
          <span className={`font-medium ${status ? 'text-slate-500' : 'text-foreground'}`}>
            {task.title}
          </span>
        </div>
        {isOpen ? <ChevronUp className="w-4 h-4 text-slate-400" /> : <ChevronDown className="w-4 h-4 text-slate-400" />}
      </div>

      {/* Cos */}
      {isOpen && (
        <div className="px-4 pb-4 pt-0 border-t border-border mt-2">
          <p className="text-sm text-muted-foreground my-4 leading-relaxed bg-muted/30 p-3 rounded-lg border border-border">
            ğŸ“ <strong>InstrucciÃ³:</strong> {task.description}
          </p>

          <textarea 
            placeholder="Afegeix comentaris..." 
            value={comment || ''}
            onChange={(e) => setComment(e.target.value)}
            className="w-full p-2 mb-4 text-sm bg-background border border-input rounded-md min-h-[80px]"
          />

          <div className="flex gap-2 justify-end">
            <Button 
                size="sm" variant="outline" 
                className="border-red-200 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"
                onClick={() => handleSubmit('fail')} disabled={isSaving}
            >
              <XCircle className="w-4 h-4 mr-2" /> Falla
            </Button>
            <Button 
                size="sm" 
                className="bg-green-600 hover:bg-green-700 text-white"
                onClick={() => handleSubmit('pass')} disabled={isSaving}
            >
              <CheckCircle className="w-4 h-4 mr-2" /> Funciona
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/features/tests/ui/TesterManager.tsx ===================

'use client';

import { useState, useMemo } from 'react';
import { TesterProfile } from '@/types/models';
import { addTesterAction, removeTesterAction } from '@/features/tests/actions/admin-actions';
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Trash2, UserPlus, Search, Check } from 'lucide-react';
import { toast } from 'sonner'; 

interface Props {
  campaignId: string;
  assignedTesters: TesterProfile[];
  availableTesters: TesterProfile[];
}

export function TesterManager({ campaignId, assignedTesters, availableTesters }: Props) {
  const [searchTerm, setSearchTerm] = useState('');
  const [isPending, setIsPending] = useState(false);

  const filteredCandidates = useMemo(() => {
    const assignedIds = new Set(assignedTesters.map(t => t.id));
    const uniqueCandidates = new Map();

    availableTesters.forEach(u => {
        if (assignedIds.has(u.id)) return;
        if (searchTerm && !u.email.toLowerCase().includes(searchTerm.toLowerCase())) return;
        
        // Evitem duplicats a la llista de candidats tambÃ©
        if (!uniqueCandidates.has(u.id)) {
            uniqueCandidates.set(u.id, u);
        }
    });

    return Array.from(uniqueCandidates.values());
  }, [assignedTesters, availableTesters, searchTerm]);

  const handleAdd = async (userId: string) => {
    setIsPending(true);
    const res = await addTesterAction(campaignId, userId);
    if (res.success) toast.success(res.message);
    else toast.error(res.message);
    setIsPending(false);
  };

  const handleRemove = async (userId: string) => {
    if(!confirm("Segur que vols treure l'accÃ©s a aquest usuari?")) return;
    setIsPending(true);
    const res = await removeTesterAction(campaignId, userId);
    if (res.success) toast.success(res.message);
    else toast.error(res.message);
    setIsPending(false);
  };

  return (
    <div className="grid lg:grid-cols-2 gap-8">
        
        {/* LLISTA ACTUAL (ASSIGNATS) */}
        <div className="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-6 shadow-sm">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                <Check className="w-5 h-5 text-green-500" /> Testers Actius ({assignedTesters.length})
            </h3>
            
            <div className="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                {assignedTesters.length === 0 && (
                    <p className="text-sm text-slate-500 italic">No hi ha ningÃº assignat encara.</p>
                )}
                
                {assignedTesters.map((tester, index) => (
                    // âœ… CORRECCIÃ“: Afegim l'index a la clau per fer-la Ãºnica segur
                    <div key={`assigned-${tester.id}-${index}`} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-700">
                        <div className="flex items-center gap-3">
                            <Avatar className="h-8 w-8">
                                <AvatarImage src={tester.avatar_url || ''} />
                                <AvatarFallback>{tester.email?.[0]?.toUpperCase() || 'U'}</AvatarFallback>
                            </Avatar>
                            <div className="overflow-hidden">
                                <p className="text-sm font-medium truncate">{tester.full_name || 'Sense nom'}</p>
                                <p className="text-xs text-slate-500 truncate">{tester.email}</p>
                            </div>
                        </div>
                        <Button 
                            size="icon" 
                            variant="ghost" 
                            onClick={() => handleRemove(tester.id)}
                            disabled={isPending}
                            className="text-slate-400 hover:text-red-500 hover:bg-red-50"
                        >
                            <Trash2 className="w-4 h-4" />
                        </Button>
                    </div>
                ))}
            </div>
        </div>

        {/* LLISTA CANDIDATS (DISPONIBLES) */}
        <div className="bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-800 p-6">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-700 dark:text-slate-300">
                <UserPlus className="w-5 h-5" /> Afegir Testers
            </h3>

            <div className="relative mb-4">
                <Search className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                <input 
                    type="text" 
                    placeholder="Buscar per email..." 
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full pl-9 p-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                />
            </div>

            <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                {filteredCandidates.length === 0 ? (
                    <p className="text-sm text-slate-400 text-center py-4">
                        {searchTerm ? 'Cap resultat trobat.' : 'No hi ha candidats disponibles.'}
                    </p>
                ) : (
                    filteredCandidates.map((user, index) => (
                        // âœ… CORRECCIÃ“: Afegim l'index a la clau aquÃ­ tambÃ©
                        <div key={`candidate-${user.id}-${index}`} className="flex items-center justify-between p-2 hover:bg-white dark:hover:bg-slate-800 rounded-lg transition-colors group cursor-pointer border border-transparent hover:border-slate-200 dark:hover:border-slate-700" onClick={() => handleAdd(user.id)}>
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 flex items-center justify-center text-xs font-bold">
                                    {user.email?.[0]?.toUpperCase() || 'U'}
                                </div>
                                <div>
                                    <p className="text-sm text-slate-700 dark:text-slate-300 font-medium">{user.email}</p>
                                </div>
                            </div>
                            <Button size="sm" variant="ghost" className="opacity-0 group-hover:opacity-100 text-blue-600 font-bold" disabled={isPending}>
                                Assignar
                            </Button>
                        </div>
                    ))
                )}
            </div>
        </div>
    </div>
  );
}

// =================== FILE: src/features/tests/ui/VisualFlowBuilder.tsx ===================

'use client';

import { useActionState, useRef, useEffect } from 'react';
import { TestTaskDTO } from '@/types/models';
import { addTaskAction, deleteTaskAction, TaskActionState } from '../actions/task-actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Plus, Trash2, ArrowDown, GripVertical, CheckSquare } from 'lucide-react';
import { toast } from 'sonner';
import { motion, AnimatePresence } from 'framer-motion';

const initialState: TaskActionState = { success: false, message: '' };

export function VisualFlowBuilder({ campaignId, tasks }: { campaignId: string, tasks: TestTaskDTO[] }) {
    const formRef = useRef<HTMLFormElement>(null);
    
    // Hook per gestionar l'acciÃ³ de crear
    const [state, action, isPending] = useActionState(async (prev: TaskActionState, formData: FormData) => {
        const result = await addTaskAction(prev, formData);
        if (result.success) {
            formRef.current?.reset();
            toast.success("Pas afegit al flux!");
            // Fem scroll automÃ tic al final per veure el nou pas
            setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 300);
        } else {
            toast.error(result.message);
        }
        return result;
    }, initialState);

    const handleDelete = async (taskId: string) => {
        if(!confirm("Segur que vols eliminar aquest pas del flux?")) return;
        const res = await deleteTaskAction(taskId, campaignId);
        if(res.success) toast.success("Pas eliminat");
        else toast.error(res.message);
    }

    return (
        <div className="max-w-3xl mx-auto py-8">
            
            {/* CAPÃ‡ALERA DEL DIAGRAMA */}
            <div className="text-center mb-10">
                <h3 className="text-2xl font-bold text-white mb-2">Flux de NavegaciÃ³ (User Journey)</h3>
                <p className="text-slate-400 text-sm">Defineix el camÃ­ exacte que ha de seguir el tester.</p>
            </div>

            <div className="relative space-y-0">
                {/* LÃNIA CENTRAL CONNECTORA */}
                {tasks.length > 0 && (
                    <div className="absolute left-1/2 top-4 bottom-20 w-0.5 bg-slate-800 -translate-x-1/2 z-0"></div>
                )}

                {/* --- LLISTAT DE PASSOS (NODES) --- */}
                <AnimatePresence>
                    {tasks.map((task, index) => (
                        <motion.div 
                            key={task.id}
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            exit={{ opacity: 0, scale: 0.9 }}
                            className="relative z-10 flex flex-col items-center"
                        >
                            {/* Targeta del Pas */}
                            <div className="bg-slate-900 border border-slate-700 w-full max-w-md rounded-xl p-5 shadow-xl hover:border-purple-500/50 transition-colors group relative">
                                
                                {/* NÃºmero de Pas (Badge) */}
                                <div className="absolute -left-4 -top-4 w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg border-2 border-slate-950">
                                    {index + 1}
                                </div>

                                <div className="flex justify-between items-start mb-2">
                                    <h4 className="font-bold text-white text-lg flex items-center gap-2">
                                        <CheckSquare className="w-5 h-5 text-green-500" />
                                        {task.title}
                                    </h4>
                                    <button 
                                        onClick={() => handleDelete(task.id)}
                                        className="text-slate-500 hover:text-red-500 transition-colors p-1"
                                    >
                                        <Trash2 className="w-4 h-4" />
                                    </button>
                                </div>
                                
                                {task.description && (
                                    <p className="text-slate-400 text-sm bg-black/20 p-3 rounded-lg border border-white/5">
                                        {task.description}
                                    </p>
                                )}
                            </div>

                            {/* Fletxa Connectora (Excepte l'Ãºltim si estem editant) */}
                            <div className="h-12 flex items-center justify-center">
                                <ArrowDown className="text-slate-600 w-6 h-6 animate-pulse" />
                            </div>
                        </motion.div>
                    ))}
                </AnimatePresence>

                {/* --- FORMULARI PER AFEGIR (NODE FINAL) --- */}
                <div className="relative z-10 flex flex-col items-center">
                    <div className="bg-slate-950 border-2 border-dashed border-slate-700 w-full max-w-md rounded-xl p-6 shadow-inner">
                        <h4 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 text-center">
                            Afegir SegÃ¼ent Pas
                        </h4>
                        
                        <form ref={formRef} action={action} className="space-y-4">
                            <input type="hidden" name="campaignId" value={campaignId} />
                            
                            <div>
                                <Input 
                                    name="title" 
                                    placeholder="Ex: Clicar al botÃ³ 'Registrar-se'" 
                                    className="bg-slate-900 border-slate-700 text-white focus:ring-purple-500" 
                                    required
                                    autoComplete="off"
                                />
                            </div>

                            <div>
                                <Textarea 
                                    name="description" 
                                    placeholder="Detalls: L'usuari hauria de veure un modal de confirmaciÃ³..." 
                                    className="bg-slate-900 border-slate-700 text-white resize-none text-xs" 
                                    rows={2}
                                />
                            </div>

                            <Button 
                                type="submit" 
                                disabled={isPending} 
                                className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold"
                            >
                                {isPending ? 'Afegint...' : <><Plus className="w-4 h-4 mr-2" /> Afegir Pas al Diagrama</>}
                            </Button>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    );
}

// =================== FILE: src/i18n/request.ts ===================

import { getRequestConfig } from 'next-intl/server';
import { notFound } from 'next/navigation';
import { routing, type Locale } from '@/routing'; // ğŸ‘ˆ IMPORTEM DE LA FONT ÃšNICA

export default getRequestConfig(async ({ requestLocale }) => {
  const locale = await requestLocale;

  // Ara validem contra la configuraciÃ³ centralitzada
  // AixÃ­ no hem de mantenir dues llistes d'idiomes
  if (!locale || !routing.locales.includes(locale as Locale)) {
    notFound();
  }

  return {
    locale,
    messages: (await import(`../../messages/${locale}.json`)).default
  };
});

// =================== FILE: src/lib/audit-dictionary.ts ===================

// src/lib/audit-dictionary.ts

export const AUDIT_TRANSLATIONS: Record<
  string, // id de l'auditoria
  Record<
    string, // locale, p.ex. 'ca', 'es', 'en'
    { title: string; description: string }
  >
> = {
  // AQUESTA Ã‰S L'ESTRUCTURA CORRECTA AMB KEY DE LOCALE:
  'is-on-https': {
    ca: {
      title: 'El lloc web no utilitza HTTPS segur',
      description: 'La teva web no Ã©s segura. AixÃ² espanta els clients i Google et penalitza greument.'
    },
    es: {
      title: 'El sitio web no usa HTTPS seguro',
      description: 'Tu web no es segura. Esto asusta a los clientes y Google te penaliza.'
    },
    en: {
      title: 'Website is not using secure HTTPS',
      description: 'Your website is not secure. This scares users and Google may penalize you.'
    }
  },
  // âš ï¸ CORRECCIÃ“: ESTRUCTURA DE FALLBACK SIMPLE REQUEREIX CLAU 'ca' EXPLÃCITA
  'meta-description': {
    ca: { 
        title: 'Manca la Meta DescripciÃ³',
        description: 'Google no sap de quÃ¨ tracta la teva web. Necessites un resum atractiu per aparÃ¨ixer als resultats de cerca.'
    }
  },
  'document-title': {
    ca: {
        title: 'La pÃ gina no tÃ© tÃ­tol',
        description: 'El tÃ­tol Ã©s l\'element mÃ©s important per al SEO. Sense ell, Ã©s invisible.'
    }
  },
  'image-alt': {
    ca: {
        title: 'Imatges sense text alternatiu',
        description: 'Les imatges necessiten una descripciÃ³ perquÃ¨ Google les pugui "veure" i indexar.'
    }
  },
  'viewport': {
    ca: {
        title: 'No estÃ  adaptada a mÃ²bils',
        description: 'La web no tÃ© l\'etiqueta viewport correcta, fent que es vegi malament en dispositius mÃ²bils.'
    }
  },
  'server-response-time': {
    ca: {
        title: 'El servidor Ã©s massa lent',
        description: 'El temps de resposta inicial Ã©s alt. Considera canviar de hosting o optimitzar el backend.'
    }
  },
  'render-blocking-resources': {
    ca: {
        title: 'Recursos que bloquegen la visualitzaciÃ³',
        description: 'Hi ha CSS o JS que impedeixen que la web es mostri rÃ pidament. S\'han de diferir.'
    }
  },
  'unminified-css': {
    ca: {
        title: 'CSS no optimitzat',
        description: 'Els fitxers d\'estil sÃ³n massa grans. Minificar-los milloraria la velocitat.'
    }
  },
  'unminified-javascript': {
    ca: {
        title: 'JavaScript no optimitzat',
        description: 'El codi script Ã©s massa pesat. Cal comprimir-lo per accelerar la cÃ rrega.'
    }
  },
  'uses-optimized-images': {
    ca: {
        title: 'Imatges massa pesades',
        description: 'Les imatges no estan optimitzades. Utilitza formats moderns com WebP per estalviar dades.'
    }
  },
  'largest-contentful-paint': {
    ca: {
        title: 'CÃ rrega del contingut principal (LCP) lenta',
        description: 'L\'element mÃ©s gran de la web triga massa a aparÃ¨ixer. AixÃ² frustra els usuaris.'
    }
  },
  'cumulative-layout-shift': {
    ca: {
        title: 'La web es "mou" mentre carrega (CLS)',
        description: 'Els elements canvien de lloc sobtadament, causant una mala experiÃ¨ncia d\'usuari.'
    }
  }
};

export function translateIssue(
  id: string,
  defaultTitle: string,
  defaultDesc: string,
  locale: string = 'ca'
) {
  const translationForId = AUDIT_TRANSLATIONS[id];
  if (translationForId) {
    const translationForLocale = translationForId[locale];
    if (translationForLocale) return translationForLocale;
  }

  // Si no troba la traducciÃ³, torna al text per defecte (en anglÃ¨s de Google)
  return {
    title: defaultTitle,
    description: (defaultDesc || '').split('[')[0].replace(/\.$/, '')
  };
}

// =================== FILE: src/lib/auth/admin-guard.ts ===================

import { createClient } from '@/lib/supabase/server';
import { notFound, redirect } from 'next/navigation';

/**
 * Aquesta funciÃ³ actua com un tallafocs.
 * Si l'usuari no Ã©s l'Admin, atura l'execuciÃ³ i llanÃ§a un 404.
 */
export async function requireAdmin() {
  const supabase = await createClient();
  
  // 1. Obtenim l'usuari
  const { data: { user }, error } = await supabase.auth.getUser();

  // 2. Si no estÃ  loguejat -> Al login
  if (error || !user) {
    redirect('/auth/login');
  }

  // 3. VERIFICACIÃ“ MESTRA
  // Comparem l'email de l'usuari amb la variable d'entorn
  const adminEmail = process.env.ADMIN_EMAIL;

  if (!adminEmail) {
    console.error("âŒ ERROR CRÃTIC: No s'ha configurat ADMIN_EMAIL al .env");
    // Per seguretat, si no hi ha config, bloquegem tothom
    notFound(); 
  }

  if (user.email !== adminEmail) {
    console.warn(`âš ï¸ ALERTA DE SEGURETAT: L'usuari ${user.email} ha intentat accedir a l'admin.`);
    // 4. Si no Ã©s l'admin, mostrem un 404 (Not Found).
    // AixÃ­ ni tan sols saben que la pÃ gina existeix.
    notFound();
  }

  // Si arriba aquÃ­, ets tu. Benvingut, cap.
  return user;
}

// =================== FILE: src/lib/data.ts ===================

// src/lib/data.ts
import { StaticImageData } from 'next/image'; // ğŸ‘ˆ Necessari pel tipatge

import bioshopImg from '@/assets/images/testimoni-garatgeestacio.jpg';
import salutFlow from '@/assets/images/salutflow.png';

export type Testimonial = {
  id: number | string;
  name: string;
  company: string;
  text: string;
  rating: number;
  projectType: 'web' | 'app' | 'automation';
  projectUrl?: string;
  image?: string | StaticImageData;
};

export const TESTIMONIALS: Testimonial[] = [
  {
    id: 1,
    name: "Marc Vila",
    company: "Gestoria Vila",
    text: "Hem estalviat 20h setmanals grÃ cies al bot de WhatsApp.",
    rating: 5,
    projectType: 'automation'
  },
  {
    id: 2,
    name: "Anna Soler",
    company: "Garatge EstaciÃ³", // He vist el nom al fitxer jpg
    text: "La web carrega instantÃ niament. Les vendes han pujat un 40%.",
    rating: 5,
    projectType: 'web',
    projectUrl: 'https://garatgeestacio.com',
    // âœ… 3. USEM LA VARIABLE IMPORTADA
    image: bioshopImg
  },
  {
    id: 3,
    name: "Jordi P.",
    company: "Tech Solutions",
    text: "Han entÃ¨s la nostra idea d'App a la primera.",
    rating: 5,
    projectType: 'app',
    image: salutFlow
  },

  // Nous exemples per al carrousel
  {
    id: 4,
    name: "Laura M.",
    company: "ClÃ­nica Dental",
    text: "El sistema de cites prÃ¨vies ha eliminat les trucades perdudes.",
    rating: 5,
    projectType: 'web'
  },
  {
    id: 5,
    name: "Pere Roig",
    company: "LogÃ­stica RÃ pida",
    text: "L'App per als repartidors funciona fins i tot sense cobertura.",
    rating: 5,
    projectType: 'app'
  }
];

// =================== FILE: src/lib/factory/config-generator.ts ===================

import { MasterConfig } from '@/types/config';

export function generateConfigFileContent(config: MasterConfig): string {
  // Convertim l'objecte a JSON bonic amb indentaciÃ³ de 2 espais
  const jsonString = JSON.stringify(config, null, 2);

  // Retornem el contingut exacte del fitxer .ts
  return `
import { MasterConfig } from "@/types/config";

export const CONFIG: MasterConfig = ${jsonString};
`;
}

// =================== FILE: src/lib/mock-audit.ts ===================

// Dades falses per poder dissenyar la UI de l'informe
export const MOCK_REPORT = {
  scores: {
    seo: 85,
    performance: 62,
    accessibility: 90,
    best_practices: 75
  },
  issues: [
    { type: 'error', message: 'Falta l\'etiqueta H1 a la pÃ gina principal', impact: 'high' },
    { type: 'warning', message: 'Imatges sense atribut ALT detectades', impact: 'medium' },
    { type: 'success', message: 'Certificat SSL vÃ lid i actiu', impact: 'none' }
  ],
  technologies: ['Next.js', 'Tailwind CSS', 'Vercel']
};

// =================== FILE: src/lib/supabase/client.ts ===================

import { createBrowserClient } from '@supabase/ssr'
// ğŸ‘‡ Importa els tipus
import { Database } from '@/types/database.types' 

export function createClient() {
  // ğŸ‘‡ Afegeix el genÃ¨ric <Database> aquÃ­
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}

// =================== FILE: src/lib/supabase/middleware.ts ===================

import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'
import { Database } from '@/types/database.types'

// ğŸ‘‡ Afegeix el genÃ¨ric <Database> aquÃ­
export async function updateSession(
  request: NextRequest, 
  response: NextResponse // âœ… Rebem la resposta del i18n
) {
  const supabase = createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => {
            request.cookies.set(name, value)
            response.cookies.set(name, value, options)
          })
        },
      },
    }
  )

  // AixÃ² refresca el token si Ã©s necessari
  const { data: { user } } = await supabase.auth.getUser()

  // ğŸ›¡ï¸ PROTECCIÃ“ DE RUTES
  // Si intenta accedir a /dashboard sense usuari -> Login
  if (request.nextUrl.pathname.includes('/dashboard') && !user) {
    // Detectem el locale actual de la URL per redirigir al login correcte
    const locale = request.nextUrl.pathname.split('/')[1] || 'ca';
    const loginUrl = request.nextUrl.clone()
    loginUrl.pathname = `/${locale}/auth/login`
    return NextResponse.redirect(loginUrl)
  }

  return response
}

// =================== FILE: src/lib/supabase/server.ts ===================

import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
// ğŸ‘‡ Importem el client bÃ sic tambÃ©
import { createClient as createSupabaseClient } from '@supabase/supabase-js'
import { Database } from '@/types/database.types'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch { }
        },
      },
    }
  )
}

// ğŸ‘‡ NOVA FUNCIÃ“: Client Admin (Bypass RLS)
// Aquest client NO fa servir cookies, fa servir la clau secreta
export function createAdminClient() {
  return createSupabaseClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!, // <--- Aquesta clau Ã©s CRÃTICA
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    }
  )
}

// =================== FILE: src/lib/utils.ts ===================

import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}


// =================== FILE: src/proxy.ts ===================

// =================== FILE: src/proxy.ts ===================

import createMiddleware from 'next-intl/middleware';
import { routing } from '@/routing';
import { updateSession } from '@/lib/supabase/middleware';
import { NextRequest } from 'next/server';

const intlMiddleware = createMiddleware(routing);

export async function proxy(request: NextRequest) {
  const response = intlMiddleware(request);
  return await updateSession(request, response);
}

export const config = {
  matcher: [
    // ğŸ‘‡ HE AFEGIT 'webmanifest' i 'mp4' A L'EXCEPCIÃ“ DEL REGEX
    // AixÃ² diu: "Executa el middleware a tot ARREU EXCEPTE api, next, imatges, manifest i videos"
    '/((?!api|_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp|webmanifest|mp4)$).*)',
  ],
};

// =================== FILE: src/repositories/interfaces/IAnalyticsRepository.ts ===================

import { AnalyticsEventDTO } from '@/types/models';
export type StatItem = { name: string; value: number; color?: string }; // Tipus genÃ¨ric per grÃ fics

export type DailyStats = {
  date: string;
  visitors: number;
  views: number;
  totalDuration: number; // ğŸ‘ˆ AFEGIT: Durada total en segons per aquell dia
};

// ğŸ‘‡ NOUS TIPUS
export type PageStat = { path: string; views: number };
export type DeviceStat = { name: string; value: number; fill: string }; // 'fill' Ã©s pel color del grÃ fic
export type CountryStat = { country: string; visitors: number };

export interface IAnalyticsRepository {
  // ğŸŸ¢ ARA (CorrecciÃ³): Ha de retornar Promise<number | null>
  trackEvent(event: AnalyticsEventDTO): Promise<number | null>;
  getLast7DaysStats(): Promise<DailyStats[]>;
  // ğŸ‘‡ NOU MÃˆTODE AGREGAT
  getAdvancedStats(): Promise<{
    topPages: PageStat[];
    devices: DeviceStat[];
    countries: StatItem[]; // Ara usem StatItem (mÃ©s flexible)
    referrers: StatItem[]; // Nou
    browsers: StatItem[];  // Nou
    os: StatItem[];        // Nou
  }>;

  // 2. Nou mÃ¨tode per actualitzar nomÃ©s la durada
  updateDuration(eventId: number, duration: number): Promise<void>;

}

// =================== FILE: src/repositories/interfaces/IAuditRepository.ts ===================

import { AuditDTO } from '@/types/models';

export interface IAuditRepository {
  getAuditsByUserEmail(email: string): Promise<AuditDTO[]>;
  getAuditById(id: string): Promise<AuditDTO | null>;
  createAudit(url: string, email: string): Promise<AuditDTO>;
  updateStatus(id: string, status: AuditDTO['status'], data?: Record<string, unknown>): Promise<void>;
  // Canvia la signatura de updateStatus per ser mÃ©s flexible o especÃ­fica
  updateStatus(
    id: string,
    status: AuditDTO['status'],
    results?: { seoScore?: number; performanceScore?: number; reportData?: unknown }
  ): Promise<void>;
  getAuditsByUserEmail(email: string): Promise<AuditDTO[]>; // Aquest ja el tenies, assegura't d'usar-lo!
  getAuditsByUserId(userId: string): Promise<AuditDTO[]>; // ğŸ‘ˆ MÃ¨tode nou

  createAuditForUser(url: string, userId: string, email: string): Promise<AuditDTO>; // ğŸ‘ˆ MÃ¨tode nou
  createPublicAudit(url: string, email: string): Promise<AuditDTO>; // ğŸ‘ˆ MÃ¨tode nou
}

// =================== FILE: src/repositories/interfaces/IPostRepository.ts ===================

import { BlogPostDTO } from '@/types/models';

export interface IPostRepository {
  getPostBySlug(slug: string): Promise<BlogPostDTO | null>;
  getAllPublishedPosts(): Promise<BlogPostDTO[]>;
  
  // ğŸ‘‡ NOUS MÃˆTODES D'ADMINISTRACIÃ“
  getAllPosts(): Promise<BlogPostDTO[]>; // Inclou esborranys i arxivats
  updatePost(slug: string, data: Partial<BlogPostDTO>): Promise<void>;
  deletePost(slug: string): Promise<void>;
  getAdminPostBySlug(slug: string): Promise<BlogPostDTO | null>;
}

// =================== FILE: src/repositories/supabase/SupabaseAnalyticsRepository.ts ===================

import { createClient, createAdminClient } from '@/lib/supabase/server'; // ğŸ‘ˆ Afegim createAdminClient
import { AnalyticsEventDTO } from '@/types/models';
import { Database, Json } from '@/types/database.types';
import {
  IAnalyticsRepository,
  DailyStats,
  PageStat,
  DeviceStat,

  StatItem // ğŸ‘ˆ Assegura't d'importar aquest tipus nou que vam crear
} from '../interfaces/IAnalyticsRepository';

type AnalyticsInsert = Database['public']['Tables']['analytics_events']['Insert'];

export class SupabaseAnalyticsRepository implements IAnalyticsRepository {

  // ğŸŸ¢ CORRECCIÃ“: Ara prometem retornar un nÃºmero (ID) o null
  async trackEvent(event: AnalyticsEventDTO): Promise<number | null> {
    const supabaseAdmin = createAdminClient();

    const payload: AnalyticsInsert = {
      event_name: event.event_name,
      path: event.path,
      session_id: event.session_id,
      meta: (event.meta as unknown as Json) || null,
      duration_seconds: event.duration || 0,
      referrer: event.referrer || null,
      country: event.geo?.country || null,
      city: event.geo?.city || null,
      device_type: event.device?.type || 'unknown',
      browser: event.device?.browser || 'unknown',
      os: event.device?.os || 'unknown'
    };

    const { data, error } = await supabaseAdmin
      .from('analytics_events')
      .insert(payload)
      .select('id')
      .single();

    if (error) {
      console.error("Error al Repositori:", error.message);
      return null; // âœ… Ara aixÃ² Ã©s vÃ lid
    }

    return data.id; // âœ… Ara aixÃ² Ã©s vÃ lid
  }
  // ğŸ‘‡ NOU MÃˆTODE
  async updateDuration(eventId: number, duration: number): Promise<void> {
    const supabaseAdmin = createAdminClient();

    // Evitem actualitzacions absurdes (ex: 0 segons o negatius)
    if (duration <= 0) return;

    await supabaseAdmin
      .from('analytics_events')
      .update({ duration_seconds: duration })
      .eq('id', eventId);
  }
  async getLast7DaysStats(): Promise<DailyStats[]> {
    const supabase = await createClient();

    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    // 1. AFEGIM duration_seconds A LA QUERY
    const { data, error } = await supabase
      .from('analytics_events')
      .select('created_at, session_id, duration_seconds')
      .gte('created_at', sevenDaysAgo.toISOString())
      .order('created_at', { ascending: true });

    if (error || !data) return [];

    // Map per agrupar per dia
    const statsMap = new Map<string, { views: number; sessions: Set<string>; duration: number }>();

    // Inicialitzem els Ãºltims 7 dies a 0
    for (let i = 6; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const key = d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
      statsMap.set(key, { views: 0, sessions: new Set(), duration: 0 });
    }

    data.forEach((row) => {
      if (row.created_at) {
        const date = new Date(row.created_at);
        const key = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });

        if (statsMap.has(key)) {
          const entry = statsMap.get(key)!;
          entry.views++;
          if (row.session_id) entry.sessions.add(row.session_id);
          // 2. ACUMULEM LA DURADA
          entry.duration += row.duration_seconds || 0;
        }
      }
    });

    return Array.from(statsMap.entries()).map(([date, val]) => ({
      date,
      views: val.views,
      visitors: val.sessions.size,
      totalDuration: val.duration // ğŸ‘ˆ Retornem la suma
    }));
  }

  // ğŸ› ï¸ MÃˆTODE CORREGIT AMB TOTS ELS TIPUS DE RETORN
  async getAdvancedStats(): Promise<{
    topPages: PageStat[];
    devices: DeviceStat[];
    countries: StatItem[];
    referrers: StatItem[];
    browsers: StatItem[];
    os: StatItem[];
  }> {
    const supabase = await createClient();

    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    // 1. Seleccionem TOTS els camps necessaris
    // IMPORTANT: Assegura't que aquests camps existeixen a la DB i als tipus generats
    // Si 'referrer' no existeix, regenera els tipus (npx supabase gen types...)
    const { data, error } = await supabase
      .from('analytics_events')
      .select('path, device_type, country, session_id, referrer, browser, os')
      .gte('created_at', thirtyDaysAgo.toISOString());

    if (error || !data) {
      return { topPages: [], devices: [], countries: [], referrers: [], browsers: [], os: [] };
    }

    // 2. Inicialitzem els Maps
    const pagesMap = new Map<string, number>();
    const devicesMap = new Map<string, number>();
    const countryMap = new Map<string, Set<string>>(); // Set per usuaris Ãºnics
    const referrerMap = new Map<string, number>();
    const browserMap = new Map<string, number>();
    const osMap = new Map<string, number>();

    // 3. Processem les dades
    data.forEach(row => {
      // Pages
      const cleanPath = row.path || '/';
      pagesMap.set(cleanPath, (pagesMap.get(cleanPath) || 0) + 1);

      // Devices
      const dev = row.device_type === 'mobile' ? 'MÃ²bil' : row.device_type === 'tablet' ? 'Tauleta' : 'PC';
      devicesMap.set(dev, (devicesMap.get(dev) || 0) + 1);

      // Countries (Set)
      const country = row.country === 'Unknown' ? 'Desconegut' : row.country;
      if (country) {
        if (!countryMap.has(country)) countryMap.set(country, new Set());
        if (row.session_id) countryMap.get(country)!.add(row.session_id);
      }

      // Referrers
      let ref = row.referrer || 'Directe';
      try {
        if (ref.startsWith('http')) ref = new URL(ref).hostname.replace('www.', '');
      } catch { }
      referrerMap.set(ref, (referrerMap.get(ref) || 0) + 1);

      // Browsers
      const browser = row.browser || 'Altres';
      browserMap.set(browser, (browserMap.get(browser) || 0) + 1);

      // OS
      const os = row.os || 'Altres';
      osMap.set(os, (osMap.get(os) || 0) + 1);
    });

    // 4. Funcions auxiliars per formatar a StatItem[]
    const toStatArray = (map: Map<string, number>, colors: string[]): StatItem[] =>
      Array.from(map.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([name, value], i) => ({ name, value, color: colors[i % colors.length] }));

    // 5. Generem els arrays finals
    const referrers = toStatArray(referrerMap, ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe']);
    const browsers = toStatArray(browserMap, ['#f59e0b', '#fbbf24', '#fcd34d', '#fde68a', '#fef3c7']);
    const os = toStatArray(osMap, ['#ec4899', '#f472b6', '#fbcfe8', '#fce7f3', '#fdf2f8']);

    const countries: StatItem[] = Array.from(countryMap.entries())
      .map(([name, set]) => ({
        name: name === 'Unknown' ? 'ğŸŒ Desconegut' : name,
        value: set.size,
        color: '#10b981'
      }))
      .sort((a, b) => b.value - a.value)
      .slice(0, 5);

    const topPages: PageStat[] = Array.from(pagesMap.entries())
      .map(([path, views]) => ({ path, views }))
      .sort((a, b) => b.views - a.views)
      .slice(0, 15);

    const deviceColors = ['#8884d8', '#00C49F', '#FFBB28'];
    const devices: DeviceStat[] = Array.from(devicesMap.entries())
      .map(([name, value], index) => ({
        name,
        value,
        fill: deviceColors[index % deviceColors.length]
      }));

    // âœ… CORRECCIÃ“ FINAL: Retornem TOTS els camps que la interfÃ­cie espera
    return {
      topPages,
      devices,
      countries,
      referrers,
      browsers,
      os
    };
  }
}

// =================== FILE: src/repositories/supabase/SupabaseAuditRepository.ts ===================

import { createClient, createAdminClient } from '@/lib/supabase/server';
import { IAuditRepository } from '../interfaces/IAuditRepository';
import { AuditDTO } from '@/types/models';
import { Database } from '@/types/database.types';

// Tipus directe de la fila de la DB
type AuditRow = Database['public']['Tables']['web_audits']['Row'];

export class SupabaseAuditRepository implements IAuditRepository {

  private mapToDTO(row: AuditRow): AuditDTO {
    return {
      id: row.id,
      url: row.url,
      status: row.status as AuditDTO['status'],
      seoScore: row.seo_score,
      performanceScore: row.performance_score,
      createdAt: row.created_at ? new Date(row.created_at) : new Date(),
      // Fem un cast segur cap a un objecte genÃ¨ric o unknown
      reportData: row.report_data as Record<string, unknown>,
    };
  }

  async getAuditsByUserEmail(email: string): Promise<AuditDTO[]> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('web_audits')
      .select('*')
      .eq('email', email)
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);
    return data.map(this.mapToDTO);
  }

  async getAuditById(id: string): Promise<AuditDTO | null> {
    const supabase = await createClient();
    const { data } = await supabase.from('web_audits').select('*').eq('id', id).single();
    return data ? this.mapToDTO(data) : null;
  }

  async createAudit(url: string, email: string): Promise<AuditDTO> {
    console.log(`[Repo] Creant auditoria per: ${email} - URL: ${url}`);

    const supabaseAdmin = createAdminClient();

    const { data, error } = await supabaseAdmin
      .from('web_audits')
      .insert({
        url,
        email,
        status: 'processing'
      })
      .select()
      .single();

    if (error) {
      console.error('[Repo] Error Supabase:', error);
      throw new Error(`Error creating audit: ${error.message}`);
    }

    console.log('[Repo] Auditoria creada OK:', data.id);
    return this.mapToDTO(data);
  }

  async updateStatus(
    id: string,
    status: AuditDTO['status'],
    results?: { 
      seoScore?: number; 
      performanceScore?: number; 
      reportData?: Record<string, unknown> 
    }
  ): Promise<void> {
    const supabaseAdmin = createAdminClient();

    // Utilitzem Partial<AuditRow> per assegurar que els camps coincideixen amb la DB
    // Omitim 'id' i 'created_at' perquÃ¨ no els tocarem
    const updatePayload: Partial<AuditRow> = { status };

    if (results) {
      if (results.seoScore !== undefined) updatePayload.seo_score = results.seoScore;
      if (results.performanceScore !== undefined) updatePayload.performance_score = results.performanceScore;
      
      if (results.reportData !== undefined) {
        // âœ… CORRECCIÃ“ CLAU:
        // En lloc de 'as any', fem un cast al tipus especÃ­fic que Supabase espera per aquesta columna.
        // AixÃ² satisfÃ  l'Eslint i mantÃ© la seguretat de tipus relativa a la DB.
        updatePayload.report_data = results.reportData as AuditRow['report_data'];
      }
    }

    const { error } = await supabaseAdmin
      .from('web_audits')
      .update(updatePayload)
      .eq('id', id);

    if (error) throw new Error(error.message);
  }
  async getAuditsByUserId(userId: string): Promise<AuditDTO[]> {
      const supabase = await createClient();
      const { data, error } = await supabase
        .from('web_audits')
        .select('*')
        .eq('user_id', userId) // ğŸ‘ˆ Filtrem per ID, molt mÃ©s robust
        .order('created_at', { ascending: false });
      
      if (error) throw new Error(error.message);
      return data.map(this.mapToDTO);
  }

  // CAS 1: Des del Dashboard (Tenim ID segur)
  async createAuditForUser(url: string, userId: string, email: string): Promise<AuditDTO> {
    const supabaseAdmin = createAdminClient();
    const { data, error } = await supabaseAdmin
      .from('web_audits')
      .insert({
        url,
        user_id: userId, // âœ… Clau
        email: email,
        status: 'processing'
      })
      .select()
      .single();

    if (error) throw new Error(error.message);
    return this.mapToDTO(data);
  }

  // CAS 2: Des de la Landing (NomÃ©s tenim Email)
  async createPublicAudit(url: string, email: string): Promise<AuditDTO> {
    const supabaseAdmin = createAdminClient();
    
    // Opcional: Buscar si ja existeix un usuari amb aquest email per lligar-ho?
    // Per ara, ho guardem sense user_id (o amb un user_id temporal si la taula ho requereix)
    // NOTA: Si la taula 'web_audits' tÃ© 'user_id' com NOT NULL, necessitem una estratÃ¨gia aquÃ­.
    // L'estratÃ¨gia habitual Ã©s crear un usuari "fantasma" o deixar el camp nullable.
    // Assumint que user_id pot ser null o gestionem el registre desprÃ©s.
    
    const { data, error } = await supabaseAdmin
      .from('web_audits')
      .insert({
        url,
        email: email,
        status: 'processing'
        // user_id: null (si la DB ho permet)
      })
      .select()
      .single();

    if (error) throw new Error(error.message);
    return this.mapToDTO(data);
  }
}

// =================== FILE: src/repositories/supabase/SupabasePostRepository.ts ===================

import { createClient, createAdminClient } from '@/lib/supabase/server';
import { IPostRepository } from '@/repositories/interfaces/IPostRepository';
import { BlogPostDTO } from '@/types/models';
import { Database } from '@/types/database.types';

// 1. Tipus estrictes de la base de dades
type PostRow = Database['public']['Tables']['posts']['Row'];
type PostUpdate = Database['public']['Tables']['posts']['Update']; // ğŸ‘ˆ AdÃ©u 'any'

// âš ï¸ CONSTANT D'ORGANITZACIÃ“ (Posa-ho al .env en producciÃ³)
const MY_ORG_ID = process.env.NEXT_PUBLIC_MAIN_ORG_ID || '2f1e89dd-0b95-4f7b-ab31-14a9916d374f';

export class SupabasePostRepository implements IPostRepository {

  // ğŸ”„ Mapper: DB -> App
  private mapToDTO(row: PostRow): BlogPostDTO {
    return {
      id: row.id,
      slug: row.slug,
      title: row.title,
      date: row.published_at ?? row.created_at,
      description: row.description,
      content: row.content_mdx,
      tags: row.tags ? (row.tags as string[]) : [],
      coverImage: row.cover_image,
      published: row.published ?? false,
      reviewed: row.reviewed ?? false
    };
  }

  // --- LECTURA PÃšBLICA (WEB) ---

  async getPostBySlug(slug: string): Promise<BlogPostDTO | null> {
    const supabase = await createClient();

    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .eq('slug', slug)
      .eq('status', 'published')      // NomÃ©s publicats
      .eq('published', true)          // Doble check
      .eq('organization_id', MY_ORG_ID) // ğŸ”’ SEGURETAT: NomÃ©s la teva org
      .single();

    if (error || !data) return null;
    return this.mapToDTO(data);
  }

  async getAllPublishedPosts(): Promise<BlogPostDTO[]> {
    const supabase = await createClient();

    // 1. Posts de la teva ORG i publicats
    const { data: posts } = await supabase
      .from('posts')
      .select('*')
      .eq('status', 'published')
      .eq('published', true)
      .eq('organization_id', MY_ORG_ID) // ğŸ”’ SEGURETAT
      .order('published_at', { ascending: false });

    if (!posts || posts.length === 0) return [];

    // 2. Reaccions (Bulk query eficient)
    const slugs = posts.map(p => p.slug);
    const { data: reactions } = await supabase
      .from('post_reactions')
      .select('post_slug')
      .in('post_slug', slugs);

    // 3. Recompte en memÃ²ria
    const reactionCounts = new Map<string, number>();
    reactions?.forEach(r => {
      reactionCounts.set(r.post_slug, (reactionCounts.get(r.post_slug) || 0) + 1);
    });

    // 4. Injectar dades al DTO
    return posts.map(row => ({
      ...this.mapToDTO(row),
      totalReactions: reactionCounts.get(row.slug) || 0
    }));
  }

  // --- GESTIÃ“ ADMIN (DASHBOARD) ---

  async getAllPosts(): Promise<BlogPostDTO[]> {
    const supabase = createAdminClient(); 
    // Fins i tot a l'admin filtrem per ORG per no barrejar dades si fos multi-tenant
    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .eq('organization_id', MY_ORG_ID) 
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);
    return data.map(row => this.mapToDTO(row));
  }

  async updatePost(slug: string, data: Partial<BlogPostDTO>): Promise<void> {
    const supabase = createAdminClient();

    // âœ… ÃšS DEL TIPUS 'PostUpdate' (Typescript estricte)
    const updateData: PostUpdate = {};

    if (data.title !== undefined) updateData.title = data.title;
    if (data.description !== undefined) updateData.description = data.description;
    if (data.content !== undefined) updateData.content_mdx = data.content;
    if (data.tags !== undefined) updateData.tags = data.tags;
    if (data.coverImage !== undefined) updateData.cover_image = data.coverImage;
    if (data.reviewed !== undefined) updateData.reviewed = data.reviewed;

    if (data.published !== undefined) {
      updateData.published = data.published;
      updateData.status = data.published ? 'published' : 'draft';
      // Si publiquem, actualitzem la data si no n'hi ha una de manual
      if (data.published) {
         updateData.published_at = data.date || new Date().toISOString();
      }
    } else if (data.date) {
      updateData.published_at = data.date;
    }

    const { error } = await supabase
      .from('posts')
      .update(updateData)
      .eq('slug', slug)
      .eq('organization_id', MY_ORG_ID); // ğŸ”’

    if (error) throw new Error(error.message);
  }

  async deletePost(slug: string): Promise<void> {
    const supabase = createAdminClient();
    const { error } = await supabase
      .from('posts')
      .delete()
      .eq('slug', slug)
      .eq('organization_id', MY_ORG_ID); // ğŸ”’

    if (error) throw new Error(error.message);
  }

  async getAdminPostBySlug(slug: string): Promise<BlogPostDTO | null> {
    const supabase = createAdminClient();
    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .eq('slug', slug)
      .eq('organization_id', MY_ORG_ID) // ğŸ”’
      .single();

    if (error || !data) return null;
    return this.mapToDTO(data);
  }

  // --- REACCIONS ---

  async getPostReactions(slug: string): Promise<Record<string, number>> {
    const supabase = await createClient();
    const { data } = await supabase.from('post_reactions').select('reaction_type').eq('post_slug', slug);
    
    const counts: Record<string, number> = {};
    data?.forEach(r => counts[r.reaction_type] = (counts[r.reaction_type] || 0) + 1);
    return counts;
  }

  async toggleReaction(slug: string, reaction: string, visitorId: string) {
    const supabase = createAdminClient();
    
    // Validem que el post existeix a la nostra ORG
    const { data: post } = await supabase
        .from('posts')
        .select('id')
        .eq('slug', slug)
        .eq('organization_id', MY_ORG_ID)
        .single();
        
    if(!post) throw new Error("Post not found in organization");

    const { data: existing } = await supabase
        .from('post_reactions')
        .select('id')
        .eq('post_slug', slug)
        .eq('reaction_type', reaction)
        .eq('visitor_id', visitorId)
        .maybeSingle();

    if (existing) {
      await supabase.from('post_reactions').delete().eq('id', existing.id);
      return 'removed';
    } else {
      await supabase.from('post_reactions').insert({ 
          post_slug: slug, 
          reaction_type: reaction, 
          visitor_id: visitorId 
      });
      return 'added';
    }
  }
  
  // (MÃ¨tode auxiliar no utilitzat actualment perÃ² necessari per la interfÃ­cie si hi fos)
  async getUserReactions(slug: string, visitorId: string): Promise<string[]> {
     const supabase = await createClient();
     const { data } = await supabase.from('post_reactions').select('reaction_type').eq('post_slug', slug).eq('visitor_id', visitorId);
     return data?.map(r => r.reaction_type) || [];
  }
}

// =================== FILE: src/repositories/supabase/SupabaseProjectRepository.ts ===================

import { createClient, createAdminClient } from '@/lib/supabase/server';

export type ProjectMember = {
    user_id: string;
    role: string;
    profile: {
        full_name: string | null;
        email: string;
        avatar_url: string | null;
    };
};
// 1. Definim el tipus exacte que esperem de la consulta SQL
type ProjectMemberRow = {
    user_id: string;
    role: string;
    // Supabase retorna l'objecte relacionat aquÃ­
    profiles: {
        full_name: string | null;
        email: string;
        avatar_url: string | null;
    } | null; // Pot ser null si l'usuari s'ha esborrat perÃ² la relaciÃ³ encara existeix (rar, perÃ² possible)
};
export class SupabaseProjectRepository {

    // A. Afegir membre al projecte
    async addMember(projectId: string, userId: string, role: string = 'member') {
        const supabase = createAdminClient(); // Admin powers
        return supabase
            .from('project_members')
            .insert({ project_id: projectId, user_id: userId, role })
            .select()
            .single();
    }

    // B. Eliminar membre
    async removeMember(projectId: string, userId: string) {
        const supabase = createAdminClient();
        return supabase
            .from('project_members')
            .delete()
            .eq('project_id', projectId)
            .eq('user_id', userId);
    }


    // D. Obtenir candidats
    async getAvailableCandidates(projectId: string, organizationId: string) {
        // ğŸ”¥ CANVI CLAU: AdminClient per poder llistar TOTS els perfils de l'org
        const supabase = createAdminClient();

        // 1. Tots els de l'organitzaciÃ³
        const { data: orgUsers } = await supabase
            .from('profiles')
            .select('*')
            .eq('organization_id', organizationId);

        // 2. Els que ja sÃ³n al projecte
        const { data: currentMembers } = await supabase
            .from('project_members')
            .select('user_id')
            .eq('project_id', projectId);

        if (!orgUsers) return [];

        const memberIds = new Set(currentMembers?.map(m => m.user_id));

        // Retornem nomÃ©s els que NO sÃ³n membres encara
        return orgUsers.filter(u => !memberIds.has(u.id));
    }
    // C. Obtenir membres del projecte
   // C. Obtenir membres del projecte
  async getMembers(projectId: string): Promise<ProjectMember[]> {
    const supabase = createAdminClient();

    // 1. Obtenim la relaciÃ³ projecte-usuari
    const { data: members, error } = await supabase
      .from('project_members')
      .select('user_id, role')
      .eq('project_id', projectId);

    if (error || !members) return [];

    // 2. Obtenim els detalls dels perfils
    const userIds = members.map(m => m.user_id);
    if (userIds.length === 0) return [];

    const { data: userDetails } = await supabase
      .from('profiles')
      .select('id, full_name, email, avatar_url')
      .in('id', userIds);

    // 3. Unim les dades i assegurem el tipatge (Evitem errors TS)
    return members.map(m => {
      const profileData = userDetails?.find(u => u.id === m.user_id);

      return {
        user_id: m.user_id,
        // âœ… CORRECCIÃ“ 1: Si role Ã©s null, posem 'member' per defecte
        role: m.role || 'member', 
        
        // âœ… CORRECCIÃ“ 2: ConstruÃ¯m l'objecte profile netament
        profile: {
          full_name: profileData?.full_name || 'Usuari Desconegut',
          email: profileData?.email || 'Sense email',
          avatar_url: profileData?.avatar_url || null
        }
      };
    });
  }
}

// =================== FILE: src/repositories/supabase/SupabaseTestRepository.ts ===================

import { createClient, createAdminClient } from '@/lib/supabase/server';
import { Database } from '@/types/database.types';
import { CampaignContext, TestCampaignDTO, TestTaskDTO, TestResultDTO, TesterProfile } from '@/types/models';
import type { MissionStats } from '@/services/GamificationService'; // ğŸ‘ˆ Importamos el tipo para asegurar que cumplimos el contrato
type TestCampaignRow = Database['public']['Tables']['test_campaigns']['Row'];

type CampaignQueryResponse = TestCampaignRow & {
  projects: { name: string; domain: string | null } | null;
  test_tasks: {
    id: string;
    test_results: { count: number }[];
  }[];
};
// 1. Tipus per a la resposta "bruta" de Supabase (Raw Data)
// AixÃ² ens evita usar 'any' quan fem el cast
type CampaignResponse = {
  id: string;
  campaign: {
    id: string;
    title: string;
    description: string | null;
    status: string | null;
    project_id: string;
    test_tasks: { id: string }[]; // Array d'objectes amb id
  } | null;
};

// 2. Tipus per al resultat d'usuari
type UserResultRow = {
  task_id: string;
  status: string;
};
export class SupabaseTestRepository {

  // A. Context del Test (Admin o User)
  async getCampaignWithContext(campaignId: string, userId: string): Promise<CampaignContext> {
    const supabase = createAdminClient();

    // 1. Campanya
    const { data: campaignData } = await supabase
      .from('test_campaigns')
      .select('*')
      .eq('id', campaignId)
      .single();

    if (!campaignData) return { campaign: null, tasks: [], results: [] };

    // 2. Tasques
    const { data: tasksData } = await supabase
      .from('test_tasks')
      .select('*')
      .eq('campaign_id', campaignId)
      .order('order_index', { ascending: true });

    // 3. Resultats
    const taskIds = tasksData?.map(t => t.id) || [];
    const { data: resultsData } = await supabase
      .from('test_results')
      .select('*')
      .in('task_id', taskIds)
      .eq('user_id', userId);

    // Mapeig
    const campaign: TestCampaignDTO = {
      id: campaignData.id,
      projectId: campaignData.project_id,
      title: campaignData.title,
      description: campaignData.description,
      instructions: campaignData.instructions,
      status: campaignData.status || 'active',
      createdAt: new Date(campaignData.created_at || Date.now())
    };

    const tasks: TestTaskDTO[] = (tasksData || []).map(t => ({
      id: t.id,
      campaignId: t.campaign_id,
      title: t.title,
      description: t.description,
      orderIndex: t.order_index ?? 0
    }));

    const results: TestResultDTO[] = (resultsData || []).map(r => ({
      id: r.id,
      taskId: r.task_id,
      userId: r.user_id,
      status: (r.status as 'pass' | 'fail' | 'blocked') || 'blocked',
      comment: r.comment,
      updatedAt: new Date(r.updated_at || Date.now())
    }));

    return { campaign, tasks, results };
  }

  // --- MÃˆTODES D'ESCRIPTURA ---

  async saveResult(userId: string, taskId: string, status: string, comment: string) {
    const supabase = await createClient(); // Usuari normal
    return supabase.from('test_results').upsert({
      user_id: userId,
      task_id: taskId,
      status,
      comment,
      updated_at: new Date().toISOString()
    }, { onConflict: 'task_id, user_id' });
  }

  async createTask(data: { campaignId: string; title: string; description?: string; orderIndex: number }) {
    const supabase = createAdminClient();
    return supabase.from('test_tasks').insert({
      campaign_id: data.campaignId,
      title: data.title,
      description: data.description,
      order_index: data.orderIndex
    }).select().single();
  }

  async deleteTask(taskId: string) {
    const supabase = createAdminClient();
    return supabase.from('test_tasks').delete().eq('id', taskId);
  }

  async reorderTasks(tasks: { id: string; order_index: number }[]) {
    const supabase = createAdminClient();
    for (const t of tasks) {
      await supabase.from('test_tasks').update({ order_index: t.order_index }).eq('id', t.id);
    }
  }

  async assignTester(campaignId: string, userId: string) {
    const supabase = createAdminClient();
    return supabase.from('test_assignments').insert({
      campaign_id: campaignId,
      user_id: userId
    });
  }

  async removeTester(campaignId: string, userId: string) {
    const supabase = createAdminClient();
    return supabase.from('test_assignments').delete()
      .eq('campaign_id', campaignId)
      .eq('user_id', userId);
  }

  async createCampaign(data: { projectId: string; title: string; description: string; instructions: string }) {
    const supabase = createAdminClient();
    return supabase.from('test_campaigns').insert({
      project_id: data.projectId,
      title: data.title,
      description: data.description,
      instructions: data.instructions,
      status: 'active'
    }).select().single();
  }

  async updateCampaign(id: string, data: { title?: string; description?: string; instructions?: string; status?: string }) {
    const supabase = createAdminClient();
    return supabase.from('test_campaigns').update(data).eq('id', id);
  }

  // --- MÃˆTODES DE LECTURA (Corregits amb Manual Join) ---

  async getAllCampaignsForAdmin() {
    const supabase = createAdminClient();
    const { data, error } = await supabase
      .from('test_campaigns')
      .select(`
        *,
        projects(name, domain),
        test_tasks ( id, test_results (count) )
      `)
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);

    const typedData = data as unknown as CampaignQueryResponse[];

    return typedData.map((camp) => {
      const totalResults = camp.test_tasks?.reduce((acc, task) => {
        const count = task.test_results?.[0]?.count || 0;
        return acc + count;
      }, 0) || 0;

      return {
        ...camp,
        stats: {
          total_tasks: camp.test_tasks?.length || 0,
          total_results: totalResults
        }
      };
    });
  }

  async getCampaignsByProject(projectId: string) {
    const supabase = createAdminClient();
    const { data, error } = await supabase
      .from('test_campaigns')
      .select(`
        *,
        test_assignments (count),
        test_tasks (count)
      `)
      .eq('project_id', projectId)
      .order('created_at', { ascending: false });

    if (error) return [];

    return data.map(camp => ({
      id: camp.id,
      title: camp.title,
      status: camp.status,
      testerCount: camp.test_assignments?.[0]?.count || 0,
      taskCount: camp.test_tasks?.[0]?.count || 0,
      createdAt: camp.created_at
    }));
  }

  // A. Llistar tots els usuaris (Legacy - potser ja no s'usa)
  async getAvailableTesters(): Promise<TesterProfile[]> {
    const supabase = createAdminClient();
    const { data } = await supabase
      .from('profiles')
      .select('id, email, full_name, avatar_url')
      .neq('role', 'admin')
      .order('email');
    return data || [];
  }


  // B. Llistar testers assignats (i filtrar duplicats per OrgID implÃ­citament agafant el primer)
  async getAssignedTesters(campaignId: string): Promise<TesterProfile[]> {
    const supabase = createAdminClient();

    const { data: assignments } = await supabase
      .from('test_assignments')
      .select('user_id')
      .eq('campaign_id', campaignId);

    if (!assignments || assignments.length === 0) return [];

    const userIds = assignments.map(a => a.user_id);
    const { data: profiles } = await supabase
      .from('profiles')
      .select('id, email, full_name, avatar_url')
      .in('id', userIds);

    // Netejar duplicats en JS (el mÃ¨tode rÃ pid)
    const uniqueMap = new Map();
    profiles?.forEach(p => {
      if (!uniqueMap.has(p.id)) uniqueMap.set(p.id, p);
    });

    return Array.from(uniqueMap.values());
  }

  // D. Obtenir candidats vÃ lids per a un test
  async getProjectMembersForTest(campaignId: string, projectId: string, organizationId: string): Promise<TesterProfile[]> {
    const supabase = createAdminClient();

    // 1. Membres del Projecte (IDs)
    const { data: projectMembers } = await supabase
      .from('project_members')
      .select('user_id')
      .eq('project_id', projectId);

    if (!projectMembers || projectMembers.length === 0) return [];

    // 2. Membres del Test (per excloure)
    const { data: testMembers } = await supabase
      .from('test_assignments')
      .select('user_id')
      .eq('campaign_id', campaignId);

    const assignedIds = new Set(testMembers?.map(t => t.user_id));

    // 3. Filtrar IDs
    const candidateIds = projectMembers
      .map(pm => pm.user_id)
      .filter(uid => !assignedIds.has(uid));

    if (candidateIds.length === 0) return [];

    // 4. Obtenir perfils (FILTRANT PER ORGANITZACIÃ“)
    const { data: profiles } = await supabase
      .from('profiles')
      .select('id, email, full_name, avatar_url')
      .in('id', candidateIds)
      .eq('organization_id', organizationId); // ğŸ‘ˆ Filtre clau

    return profiles || [];
  }
  // I. Eliminar Campanya (Admin)
  async deleteCampaign(campaignId: string) {
    const supabase = createAdminClient(); // Admin per saltar restriccions
    return supabase
      .from('test_campaigns')
      .delete()
      .eq('id', campaignId);
  }
  // J. Obtenir les meves missions (Tester Dashboard)
  async getMyAssignments(userId: string) {
    const supabase = await createClient(); // Client normal (RLS aplicat)

    const { data, error } = await supabase
      .from('test_assignments')
      .select(`
        id, 
        assigned_at,
        campaign:test_campaigns (
            id, title, description, status, project_id,
            project:projects ( name, domain ),
            test_tasks ( count )
        )
      `) // ğŸ‘† He afegit 'id' al principi perquÃ¨ el necessites abaix
      .eq('user_id', userId)
      .order('assigned_at', { ascending: false });

    if (error || !data) return [];

    // 1. Definim el tipus del resultat del Join per treure l'any
    type AssignmentRow = {
      id: string;
      assigned_at: string | null;
      campaign: {
        id: string;
        title: string;
        description: string | null;
        status: string | null;
        project: { name: string; domain: string | null } | null;
        test_tasks: { count: number }[];
      } | null;
    };

    // 2. Fem el cast segur
    const rows = data as unknown as AssignmentRow[];

    // 3. Mapegem
    return rows.map((row) => {
      const campaign = row.campaign;

      // Si per algun motiu la campanya s'ha esborrat perÃ² l'assignaciÃ³ no, evitem error
      if (!campaign) return null;

      return {
        assignmentId: row.id,
        campaignId: campaign.id,
        title: campaign.title,
        description: campaign.description,
        projectName: campaign.project?.name,
        projectDomain: campaign.project?.domain,
        // Supabase torna el count dins d'un array d'objectes
        totalTasks: campaign.test_tasks?.[0]?.count || 0,
        status: campaign.status,
        assignedAt: row.assigned_at
      };
    })
      // Filtrem els nuls (campanyes esborrades) i nomÃ©s les actives
      // Aquest "predicate" (item is ...) ajuda a TS a saber que ja no hi ha nulls
      .filter((item): item is NonNullable<typeof item> => item !== null && item.status === 'active');
  }

  async getActiveMissionsForUser(userId: string, projectId: string) {
    const supabase = await createClient();

    // 1. QUERY
    const { data: assignmentsData } = await supabase
      .from('test_assignments')
      .select(`
            id,
            campaign:test_campaigns (
                id, title, description, status, project_id,
                test_tasks ( id ) 
            )
        `)
      .eq('user_id', userId)
      .not('campaign', 'is', null);

    const assignments = (assignmentsData || []) as unknown as CampaignResponse[];

    // 2. FILTRATGE
    const activeAssignments = assignments.filter(a =>
      a.campaign &&
      a.campaign.status === 'active' &&
      a.campaign.project_id === projectId
    );

    // 3. OBTENIR RESULTATS
    const allTaskIds = activeAssignments.flatMap(a =>
      a.campaign ? a.campaign.test_tasks.map(t => t.id) : []
    );

    let userResults: UserResultRow[] = [];

    if (allTaskIds.length > 0) {
      const { data: res } = await supabase
        .from('test_results')
        .select('task_id, status')
        .eq('user_id', userId)
        .in('task_id', allTaskIds);

      if (res) {
        userResults = res as UserResultRow[];
      }
    }

    // 4. MAPATGE FINAL (DTO)
    return activeAssignments.map(assign => {
      const campaign = assign.campaign!;

      const campaignTaskIds = new Set(campaign.test_tasks.map(t => t.id));
      const relevantResults = userResults.filter(r => campaignTaskIds.has(r.task_id));

      // --- ğŸ§® CÃ€LCULS COMPLETES PER A MISSIONSTATS ---
      const totalTasks = campaign.test_tasks.length;

      // Comptem per estat
      const passed = relevantResults.filter(r => r.status === 'pass').length;
      const failed = relevantResults.filter(r => r.status === 'fail').length;
      const blocked = relevantResults.filter(r => r.status === 'blocked').length;

      // Pendents sÃ³n els que no tenen cap resultat registrat
      const pending = totalTasks - (passed + failed + blocked);

      // ProgrÃ©s basat en TASQUES PASSADES (Ãˆxit)
      const progress = totalTasks > 0 ? Math.round((passed / totalTasks) * 100) : 0;

      // XP Reward (LÃ²gica de negoci: 100 XP per tasca)
      const xpReward = totalTasks * 100;

      // ConstruÃ¯m l'objecte que compleix amb MissionStats
      const stats: MissionStats = {
        total: totalTasks,
        passed,
        failed,
        blocked,
        pending,
        progress,
        xpReward
      };

      return {
        id: campaign.id,
        title: campaign.title,
        description: campaign.description,
        stats: stats // âœ… Ara sÃ­ que tÃ© totes les propietats requerides
      };
    });
  }
  // K. Obtenir resultats detallats d'una campanya (Analytics)
  async getCampaignResults(campaignId: string) {
    const supabase = createAdminClient();

    // 1. Obtenim totes les tasques de la campanya (per saber el total)
    const { data: tasks } = await supabase
      .from('test_tasks')
      .select('id, title')
      .eq('campaign_id', campaignId);

    if (!tasks) return { results: [], totalTasks: 0 };

    const taskIds = tasks.map(t => t.id);
    const taskMap = new Map(tasks.map(t => [t.id, t.title]));

    // 2. Obtenim tots els resultats d'aquestes tasques
    const { data: results } = await supabase
      .from('test_results')
      .select(`
        id, status, comment, updated_at, task_id, user_id
      `)
      .in('task_id', taskIds)
      .order('updated_at', { ascending: false });

    // 3. Obtenim els usuaris involucrats (per mostrar noms)
    const userIds = Array.from(new Set(results?.map(r => r.user_id) || []));
    const { data: profiles } = await supabase
      .from('profiles')
      .select('id, full_name, email, avatar_url')
      .in('id', userIds);

    const profileMap = new Map(profiles?.map(p => [p.id, p]));

    // 4. Combinem les dades en un objecte fÃ cil de consumir per la UI
    const enrichedResults = results?.map(r => ({
      id: r.id,
      // âœ… CORRECCIÃ“: Fem un cast explÃ­cit a l'estat
      status: (r.status as 'pass' | 'fail' | 'blocked') || 'blocked',
      comment: r.comment,
      updated_at: r.updated_at || new Date().toISOString(), // Assegurem data
      task_id: r.task_id,
      user_id: r.user_id,
      taskTitle: taskMap.get(r.task_id) || 'Tasca desconeguda',
      tester: profileMap.get(r.user_id) || { id: 'unknown', full_name: 'Desconegut', email: '...', avatar_url: null }
    })) || [];

    return {
      results: enrichedResults,
      totalTasks: tasks.length,
      tasks: tasks // Retornem tambÃ© l'estructura per si cal
    };
  }
}




// =================== FILE: src/routing.ts ===================

import { defineRouting } from 'next-intl/routing';
import { createNavigation } from 'next-intl/navigation';

export const routing = defineRouting({
  locales: ['ca', 'es', 'en'],
  defaultLocale: 'ca',
  localePrefix: 'as-needed' // Opcional: per si vols /ca o no
});

// Exportem tipus per a reutilitzar
export type Locale = (typeof routing.locales)[number];

export const { Link, redirect, usePathname, useRouter, getPathname } =
  createNavigation(routing);

// =================== FILE: src/services/AIService.ts ===================

import { GoogleGenerativeAI } from "@google/generative-ai";

export class AIService {
  private genAI: GoogleGenerativeAI;

  constructor() {
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) throw new Error("âŒ Manca GEMINI_API_KEY a .env.local");
    this.genAI = new GoogleGenerativeAI(apiKey);
  }

  async generateSiteContent(businessName: string, description: string, language: string = 'ca') {
    const model = this.genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

    const prompt = `
      Ets un expert en copywriting web. Genera contingut per a una Landing Page.
      Negoci: "${businessName}". DescripciÃ³: "${description}". Idioma: "${language}".

      Retorna EXCLUSIVAMENT un objecte JSON (sense markdown) amb aquesta estructura:
      {
        "hero": {
          "title": "TÃ­tol curt i impactant",
          "subtitle": "SubtÃ­tol persuasiu",
          "cta": "Text del botÃ³"
        },
        "about": {
          "title": "Sobre Nosaltres",
          "description": "DescripciÃ³ professional breu"
        },
        "services_intro": {
          "title": "Serveis",
          "subtitle": "Frase ganxo"
        }
      }
    `;

    try {
      const result = await model.generateContent(prompt);
      const text = result.response.text();
      // Neteja per si la IA torna markdown ```json ... ```
      const cleanJson = text.replace(/```json|```/g, '').trim();
      return JSON.parse(cleanJson);
    } catch (error) {
      console.error("AI Error:", error);
      // Fallback per si falla
      return {
        hero: { title: businessName, subtitle: description, cta: "Contactar" },
        about: { title: "Sobre Nosaltres", description: "" },
        services_intro: { title: "Serveis", subtitle: "" }
      };
    }
  }
}

// =================== FILE: src/services/AuditService.ts ===================

import { IAuditRepository } from '@/repositories/interfaces/IAuditRepository';
import { IWebScanner } from '@/adapters/IWebScanner';
import { ResendEmailService } from '@/services/email/ResendEmailService';

export class AuditService {
  constructor(
    private auditRepo: IAuditRepository,
    private scanner: IWebScanner,
    private emailService: ResendEmailService
  ) { }

  // 1. MÃ¨tode Landing (PÃºblic) - Afegim locale
  async performPublicAudit(url: string, email: string, locale: string) {
    return this.performFullAudit(url, { email }, locale);
  }

  // 2. MÃ¨tode Dashboard (Privat) - Afegim locale
  async performUserAudit(url: string, userId: string, userEmail: string, locale: string) {
    return this.performFullAudit(url, { userId, email: userEmail }, locale);
  }

  // LÃ²gica Central - Afegim locale
  private async performFullAudit(url: string, user: { userId?: string, email: string }, locale: string) {
    console.log(`ğŸš€ [AuditService] Iniciant auditoria per: ${url}`);

    let newAudit;
    if (user.userId) {
      newAudit = await this.auditRepo.createAuditForUser(url, user.userId, user.email);
    } else {
      newAudit = await this.auditRepo.createPublicAudit(url, user.email);
    }

    try {
      const scanResult = await this.scanner.scanUrl(url);

      await this.auditRepo.updateStatus(newAudit.id, 'completed', {
        seoScore: scanResult.seoScore,
        performanceScore: scanResult.performanceScore,
        reportData: {
          screenshot: scanResult.screenshot,
          issues: scanResult.issues,
          metrics: scanResult.metrics,
          raw: scanResult.reportData
        }
      });

      // ENVIAR EMAIL AMB LOCALE
      try {
        await this.emailService.sendAuditResult(user.email, {
          url: url,
          seo: scanResult.seoScore,
          perf: scanResult.performanceScore,
          id: newAudit.id
        }, locale); // ğŸ‘ˆ Passem l'idioma aquÃ­
      } catch (emailErr) {
        console.error("Error enviant email:", emailErr);
      }

      return newAudit.id;

    } catch (error) {
      console.error("Error audit service (LOG PRIVAT):", error);

      await this.auditRepo.updateStatus(newAudit.id, 'failed');

      // âš ï¸ MAI re-llencis l'error original al client si no estÃ s segur de quÃ¨ contÃ©.
      // LlanÃ§a un error genÃ¨ric.
      throw new Error("No s'ha pogut completar l'auditoria. Verifica la URL o prova mÃ©s tard.");
    }
  }
}

// =================== FILE: src/services/container.ts ===================

// 1. Importem les Classes (els plÃ nols)
import { SupabaseAuditRepository } from '@/repositories/supabase/SupabaseAuditRepository';
import { SupabasePostRepository } from '@/repositories/supabase/SupabasePostRepository';
import { SupabaseAnalyticsRepository } from '@/repositories/supabase/SupabaseAnalyticsRepository';

import { ResendEmailService } from '@/services/email/ResendEmailService';
import { AuditService } from '@/services/AuditService';
import { PostService } from '@/services/PostService';

import { GooglePageSpeedAdapter } from '@/adapters/GooglePageSpeedAdapter'; // ğŸ‘ˆ El nou adaptador
// ---------------------------------------------------------------------------
// 2. Instanciem els Repositoris (Capa de Dades)
// ---------------------------------------------------------------------------
export const auditRepository = new SupabaseAuditRepository();
export const postRepository = new SupabasePostRepository(); // ğŸ‘ˆ AquÃ­ neix la instÃ ncia
// ğŸ‘‡ Instanciem Analytics
export const analyticsRepository = new SupabaseAnalyticsRepository();
// ---------------------------------------------------------------------------
// 3. Instanciem els Adaptadors (Capa Externa)
// ---------------------------------------------------------------------------
const googleKey = process.env.GOOGLE_PAGESPEED_API_KEY || '';
const webScanner = new GooglePageSpeedAdapter(googleKey);

// ğŸ‘‡ 2. INSTANCIEM EL SERVEI D'EMAIL
export const emailService = new ResendEmailService();
// ---------------------------------------------------------------------------
// 4. Instanciem els Serveis (Capa de Negoci)
//    AquÃ­ fem la InjecciÃ³ de DependÃ¨ncies
// ---------------------------------------------------------------------------
// ğŸ‘‡ 3. ARA LI PASSEM ELS 3 ARGUMENTS QUE DEMANA
export const auditService = new AuditService(
  auditRepository,
  webScanner,
  emailService // <--- AQUEST ERA EL QUE FALTAVA
);
// El PostService necessita el postRepository per funcionar
export const postService = new PostService(postRepository);


// =================== FILE: src/services/email/ResendEmailService.ts ===================

import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export class ResendEmailService {
  // Afegim 'locale' als arguments
  async sendAuditResult(to: string, data: { url: string, seo: number, perf: number, id: string }, locale: string) {
    try {
      // Assegurem-nos que locale tÃ© valor (per defecte 'ca')
      const lang = locale || 'ca';
      
      await resend.emails.send({
        from: 'DigitAI Studios <info@digitaistudios.com>',
        to: [to],
        subject: `Resultats de l'Auditoria: ${data.url}`,
        html: `
          <div style="font-family: sans-serif; color: #333; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #6366f1;">L'informe de ${data.url} estÃ  llest</h1>
            <p>Hem analitzat la teva web i aquests sÃ³n els resultats preliminars:</p>
            <ul style="background: #f3f4f6; padding: 20px; border-radius: 10px;">
              <li style="margin-bottom: 10px;"><strong>SEO:</strong> ${data.seo}/100</li>
              <li><strong>Rendiment:</strong> ${data.perf}/100</li>
            </ul>
            <p style="margin-top: 30px;">
              <a href="https://digitaistudios.com/${lang}/dashboard/audits/${data.id}" style="background: #6366f1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block;">
                Veure Informe Complet
              </a>
            </p>
            <p style="font-size: 12px; color: #666; margin-top: 40px;">
              Â© DigitAI Studios. Si no has demanat aixÃ², ignora aquest correu.
            </p>
          </div>
        `
      });
    } catch (error) {
      console.error("Resend Error:", error);
    }
  }
}

// =================== FILE: src/services/FactoryService.ts ===================

import { Octokit } from 'octokit';
import { generateConfigFileContent } from '@/lib/factory/config-generator';
import { MasterConfig } from '@/types/config';

type OctokitError = {
  status: number;
  message: string;
  response?: { data: unknown };
};

export class FactoryService {
  private octokit: Octokit;
  private templateOwner: string;
  private templateRepo: string;
  private targetOrg: string;

  constructor() {
    const token = process.env.GITHUB_ACCESS_TOKEN;
    if (!token) throw new Error("âŒ Error CrÃ­tic: Manca GITHUB_ACCESS_TOKEN.");
    
    this.octokit = new Octokit({ auth: token });
    this.templateOwner = process.env.GITHUB_TEMPLATE_OWNER!;
    this.templateRepo = process.env.GITHUB_TEMPLATE_REPO!;
    this.targetOrg = process.env.GITHUB_TARGET_ORG || this.templateOwner;

    if (!this.templateOwner || !this.templateRepo) {
        throw new Error("âŒ Error CrÃ­tic: Falten les variables d'entorn del Template.");
    }
  }

  // 1. Crear Repositori
  async createRepository(repoName: string, description: string) {
    console.log(`ğŸ­ [Factory] Creant repo a ${this.targetOrg}/${repoName}...`);
    try {
      const { data } = await this.octokit.rest.repos.createUsingTemplate({
        template_owner: this.templateOwner,
        template_repo: this.templateRepo,
        name: repoName,
        description: description,
        owner: this.targetOrg,
        private: true,
        include_all_branches: false
      });
      console.log(`âœ… [Factory] Repo creat: ${data.html_url}`);
      return data;
    } catch (error: unknown) {
      const err = error as OctokitError;
      console.error("âŒ [Factory] Error creant repo:", err.response?.data || err.message);
      if (err.status === 422) throw new Error(`El repositori '${repoName}' ja existeix.`);
      throw new Error(`Error API GitHub: ${err.message}`);
    }
  }

  // 2. Helper per obtenir el SHA
  async getFileSha(repoName: string, path: string): Promise<string | undefined> {
    try {
        const { data } = await this.octokit.rest.repos.getContent({
            owner: this.targetOrg,
            repo: repoName,
            path: path,
        });
        
        if (!Array.isArray(data) && 'sha' in data) {
            return data.sha;
        }
    } catch (error: unknown) {
        const err = error as OctokitError;
        if (err.status !== 404) throw err;
    }
    return undefined;
  }

  // 3. Injectar ConfiguraciÃ³ (AMB RETRY ROBUST)
  async injectConfiguration(repoName: string, configData: MasterConfig) {
    console.log(`ğŸ’‰ [Factory] Injectant config a ${this.targetOrg}/${repoName}...`);

    const fileContent = generateConfigFileContent(configData);
    const contentEncoded = Buffer.from(fileContent).toString('base64');
    const path = 'src/config/digitai.config.ts';

    try {
      // ğŸ”„ LÃ’GICA DE REINTENT PER OBTENIR EL SHA
      // Sabem que el fitxer existeix (ve del template). Si l'API diu 404, Ã©s lag.
      // Insistim fins a 5 vegades (5 segons) per aconseguir el SHA.
      let sha: string | undefined;
      
      for (let i = 0; i < 5; i++) {
          sha = await this.getFileSha(repoName, path);
          
          if (sha) {
              console.log(`ğŸ”¹ SHA trobat a l'intent ${i + 1}: ${sha.substring(0, 7)}`);
              break; 
          }
          
          console.log(`â³ Esperant indexaciÃ³ de GitHub per al config... (${i + 1}/5)`);
          await new Promise(resolve => setTimeout(resolve, 1500)); // Esperem 1.5s
      }

      if (!sha) {
          throw new Error("Impossible obtenir el SHA del fitxer de configuraciÃ³ original. GitHub va massa lent.");
      }

      // Ara que tenim el SHA segur, fem l'update
      await this.octokit.rest.repos.createOrUpdateFileContents({
        owner: this.targetOrg,
        repo: repoName,
        path: path,
        message: 'chore(setup): inject client configuration',
        content: contentEncoded,
        sha: sha, // AQUI SEMPRE HI HAURÃ€ VALOR
        committer: { name: 'DigitAI Bot', email: 'bot@digitaistudios.com' }
      });

      console.log("âœ… [Factory] ConfiguraciÃ³ injectada.");
    } catch (error: unknown) {
        const err = error as Error;
        console.error("âŒ [Factory] Error injectant config:", err.message);
        throw new Error(`Error injectant config: ${err.message}`);
    }
  }

  // 4. Pujar Logo (TambÃ© podem aplicar un petit retry si calguÃ©s, perÃ² normalment falla menys)
  async uploadLogo(repoName: string, logoFile: File) {
    console.log(`ğŸ–¼ï¸ [Factory] Pujant logo a ${this.targetOrg}/${repoName}...`);
    try {
        const arrayBuffer = await logoFile.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);
        const contentEncoded = buffer.toString('base64');
        const path = 'public/branding/logo.png'; 

        const sha = await this.getFileSha(repoName, path);

        await this.octokit.rest.repos.createOrUpdateFileContents({
            owner: this.targetOrg,
            repo: repoName,
            path,
            message: 'chore(branding): upload brand logo',
            content: contentEncoded,
            sha,
            committer: { name: 'DigitAI Bot', email: 'bot@digitaistudios.com' }
        });
        
        console.log("âœ… [Factory] Logo pujat.");
        return "/branding/logo.png"; 
    } catch (error: unknown) {
        const err = error as Error;
        console.error("âŒ [Factory] Error pujant logo:", err.message);
        return "/logo.png"; 
    }
  }
}

// =================== FILE: src/services/GamificationService.ts ===================

import { createClient } from '@/lib/supabase/server';

export type MissionStats = {
    total: number;
    passed: number;
    failed: number;
    blocked: number;
    pending: number;
    progress: number;
    xpReward: number;
};

// Tipus de retorn per a les estadÃ­stiques d'usuari
export type UserGamificationStats = {
    xp: number;
    level: number;
    completedTasks: number;
    nextLevelXp: number;
    progressToNext: number;
    rankName: string; // NomÃ©s el text (ex: "Novell")
};

export class GamificationService {
    
    async getUserStats(userId: string): Promise<UserGamificationStats> {
        const supabase = await createClient();
        
        const { count } = await supabase
            .from('test_results')
            .select('*', { count: 'exact', head: true })
            .eq('user_id', userId)
            .eq('status', 'pass');

        const completedTasks = count || 0;
        const xp = completedTasks * 100;
        const level = Math.floor(xp / 1000) + 1;
        const nextLevelXp = level * 1000;
        
        // Evitem divisiÃ³ per zero si estem al nivell 1 amb 0 XP
        const progressToNext = nextLevelXp > 0 
            ? ((xp % 1000) / 1000) * 100 
            : 0;

        return {
            xp,
            level,
            completedTasks,
            nextLevelXp,
            progressToNext,
            rankName: this.getRankName(level)
        };
    }

    calculateMissionStats(totalTasks: number, userResults: { status: string }[]): MissionStats {
        const passed = userResults.filter(r => r.status === 'pass').length;
        const failed = userResults.filter(r => r.status === 'fail').length;
        const blocked = userResults.filter(r => r.status === 'blocked').length;
        const pending = totalTasks - (passed + failed + blocked);
        
        const progress = totalTasks > 0 ? Math.round((passed / totalTasks) * 100) : 0;
        const xpReward = totalTasks * 100;

        return { total: totalTasks, passed, failed, blocked, pending, progress, xpReward };
    }

    // Retornem nomÃ©s la CLAU del rang, les icones les posarÃ  el Frontend
    private getRankName(level: number): string {
        if (level < 2) return "Novell";
        if (level < 5) return "Bug Hunter";
        if (level < 10) return "Expert";
        return "Mestre";
    }
}

// =================== FILE: src/services/PostService.ts ===================

import { IPostRepository } from '@/repositories/interfaces/IPostRepository';
import { BlogPostDTO } from '@/types/models';
import { cache } from 'react'; // ğŸ‘ˆ IMPORT IMPORTANT

export class PostService {
  constructor(private postRepo: IPostRepository) {
    // Envoltem el mÃ¨tode original amb la cache de React
    this.getPost = cache(this.getPost.bind(this)); 
  }

  async getPost(slug: string): Promise<BlogPostDTO | null> {
    return this.postRepo.getPostBySlug(slug);
  }

  async getLatestPosts(): Promise<BlogPostDTO[]> {
    return this.postRepo.getAllPublishedPosts();
  }

  // ğŸ‘‡ MÃ¨todes Admin
  async getAllPostsForAdmin(): Promise<BlogPostDTO[]> {
    return this.postRepo.getAllPosts();
  }

  async updatePost(slug: string, data: Partial<BlogPostDTO>): Promise<void> {
    return this.postRepo.updatePost(slug, data);
  }

  async deletePost(slug: string): Promise<void> {
    return this.postRepo.deletePost(slug);
  }

  async getAdminPost(slug: string): Promise<BlogPostDTO | null> {
    // Sense cache, volem dades fresques a l'admin
    return this.postRepo.getAdminPostBySlug(slug);
  }
}

// =================== FILE: src/types/actions.ts ===================

export type ActionResult = {
  success?: boolean;
  error?: string;
  repoUrl?: string;
  // ğŸ‘‡ Afegim aixÃ² per retornar les dades si falla
  fields?: {
    businessName?: string;
    slug?: string;
    description?: string;
    primaryColor?: string;
  };
};

// =================== FILE: src/types/config.ts ===================

// Tipus bÃ sics
export type ModuleStatus = boolean;

export interface SiteIdentity {
  name: string;
  description: string;
  logoUrl: string;
  faviconUrl: string;
  contactEmail: string;
}

export interface SiteBranding {
  colors: {
    primary: string;
    secondary: string;
    background: string;
    foreground: string;
  };
  radius: number;
}

export interface SiteModules {
  landing: {
    active: boolean;
    sections: ('hero' | 'features' | 'services' | 'contact' | 'testimonials')[];
  };
  auth: ModuleStatus;
  dashboard: ModuleStatus;
  booking: ModuleStatus;
  ecommerce: ModuleStatus;
  blog: ModuleStatus;
  inventory: ModuleStatus;
  accessControl: ModuleStatus;
}

export interface I18nConfig {
  locales: string[];
  defaultLocale: string;
}

// ğŸ§  CONFIGURACIÃ“ MESTRA
export interface MasterConfig {
  identity: SiteIdentity;
  branding: SiteBranding;
  modules: SiteModules;
  i18n: I18nConfig;
}

// =================== FILE: src/types/database.types.ts ===================

export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "13.0.5"
  }
  graphql_public: {
    Tables: {
      [_ in never]: never
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      graphql: {
        Args: {
          extensions?: Json
          operationName?: string
          query?: string
          variables?: Json
        }
        Returns: Json
      }
    }
    Enums: {
      [_ in never]: never
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
  public: {
    Tables: {
      analytics_events: {
        Row: {
          browser: string | null
          city: string | null
          country: string | null
          created_at: string | null
          device_type: string | null
          duration_seconds: number | null
          event_name: string
          id: number
          meta: Json | null
          os: string | null
          path: string | null
          referrer: string | null
          session_id: string
        }
        Insert: {
          browser?: string | null
          city?: string | null
          country?: string | null
          created_at?: string | null
          device_type?: string | null
          duration_seconds?: number | null
          event_name: string
          id?: never
          meta?: Json | null
          os?: string | null
          path?: string | null
          referrer?: string | null
          session_id: string
        }
        Update: {
          browser?: string | null
          city?: string | null
          country?: string | null
          created_at?: string | null
          device_type?: string | null
          duration_seconds?: number | null
          event_name?: string
          id?: never
          meta?: Json | null
          os?: string | null
          path?: string | null
          referrer?: string | null
          session_id?: string
        }
        Relationships: []
      }
      analytics_visitors: {
        Row: {
          country: string | null
          device_type: string | null
          first_seen_at: string | null
          last_seen_at: string | null
          referrer: string | null
          visitor_id: string
        }
        Insert: {
          country?: string | null
          device_type?: string | null
          first_seen_at?: string | null
          last_seen_at?: string | null
          referrer?: string | null
          visitor_id: string
        }
        Update: {
          country?: string | null
          device_type?: string | null
          first_seen_at?: string | null
          last_seen_at?: string | null
          referrer?: string | null
          visitor_id?: string
        }
        Relationships: []
      }
      blocked_dates: {
        Row: {
          created_at: string | null
          date: string
          id: string
          organization_id: string
          reason: string | null
        }
        Insert: {
          created_at?: string | null
          date: string
          id?: string
          organization_id: string
          reason?: string | null
        }
        Update: {
          created_at?: string | null
          date?: string
          id?: string
          organization_id?: string
          reason?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "blocked_dates_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      bookings: {
        Row: {
          created_at: string | null
          customer_email: string
          customer_name: string
          end_time: string
          form_data: Json | null
          id: string
          organization_id: string
          service_id: string
          start_time: string
          status: string | null
          user_id: string | null
        }
        Insert: {
          created_at?: string | null
          customer_email: string
          customer_name: string
          end_time: string
          form_data?: Json | null
          id?: string
          organization_id: string
          service_id: string
          start_time: string
          status?: string | null
          user_id?: string | null
        }
        Update: {
          created_at?: string | null
          customer_email?: string
          customer_name?: string
          end_time?: string
          form_data?: Json | null
          id?: string
          organization_id?: string
          service_id?: string
          start_time?: string
          status?: string | null
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "bookings_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "bookings_service_id_fkey"
            columns: ["service_id"]
            isOneToOne: false
            referencedRelation: "services"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "bookings_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
      contact_leads: {
        Row: {
          created_at: string
          email: string
          full_name: string
          id: string
          message: string
          service: string
          source: string | null
        }
        Insert: {
          created_at?: string
          email: string
          full_name: string
          id?: string
          message: string
          service: string
          source?: string | null
        }
        Update: {
          created_at?: string
          email?: string
          full_name?: string
          id?: string
          message?: string
          service?: string
          source?: string | null
        }
        Relationships: []
      }
      content_queue: {
        Row: {
          created_at: string | null
          generated_mdx: string | null
          id: string
          image_prompt: string | null
          organization_id: string
          prompt_context: string | null
          status: Database["public"]["Enums"]["content_status"] | null
          target_keywords: string[] | null
          topic: string
        }
        Insert: {
          created_at?: string | null
          generated_mdx?: string | null
          id?: string
          image_prompt?: string | null
          organization_id: string
          prompt_context?: string | null
          status?: Database["public"]["Enums"]["content_status"] | null
          target_keywords?: string[] | null
          topic: string
        }
        Update: {
          created_at?: string | null
          generated_mdx?: string | null
          id?: string
          image_prompt?: string | null
          organization_id?: string
          prompt_context?: string | null
          status?: Database["public"]["Enums"]["content_status"] | null
          target_keywords?: string[] | null
          topic?: string
        }
        Relationships: [
          {
            foreignKeyName: "content_queue_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      order_items: {
        Row: {
          id: string
          order_id: string
          product_id: string | null
          product_name: string
          quantity: number
          unit_price: number
        }
        Insert: {
          id?: string
          order_id: string
          product_id?: string | null
          product_name: string
          quantity: number
          unit_price: number
        }
        Update: {
          id?: string
          order_id?: string
          product_id?: string | null
          product_name?: string
          quantity?: number
          unit_price?: number
        }
        Relationships: [
          {
            foreignKeyName: "order_items_order_id_fkey"
            columns: ["order_id"]
            isOneToOne: false
            referencedRelation: "orders"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "order_items_product_id_fkey"
            columns: ["product_id"]
            isOneToOne: false
            referencedRelation: "products"
            referencedColumns: ["id"]
          },
        ]
      }
      orders: {
        Row: {
          created_at: string | null
          customer_details: Json | null
          customer_email: string
          id: string
          organization_id: string
          payment_id: string | null
          payment_method: string | null
          status: string | null
          total_amount: number
          user_id: string | null
        }
        Insert: {
          created_at?: string | null
          customer_details?: Json | null
          customer_email: string
          id?: string
          organization_id: string
          payment_id?: string | null
          payment_method?: string | null
          status?: string | null
          total_amount: number
          user_id?: string | null
        }
        Update: {
          created_at?: string | null
          customer_details?: Json | null
          customer_email?: string
          id?: string
          organization_id?: string
          payment_id?: string | null
          payment_method?: string | null
          status?: string | null
          total_amount?: number
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "orders_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "orders_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
      organizations: {
        Row: {
          branding_config: Json | null
          created_at: string | null
          domain: string | null
          id: string
          name: string
          plan: string | null
          slug: string
        }
        Insert: {
          branding_config?: Json | null
          created_at?: string | null
          domain?: string | null
          id?: string
          name: string
          plan?: string | null
          slug: string
        }
        Update: {
          branding_config?: Json | null
          created_at?: string | null
          domain?: string | null
          id?: string
          name?: string
          plan?: string | null
          slug?: string
        }
        Relationships: []
      }
      post_reactions: {
        Row: {
          created_at: string | null
          id: string
          post_slug: string
          reaction_type: string
          visitor_id: string
        }
        Insert: {
          created_at?: string | null
          id?: string
          post_slug: string
          reaction_type: string
          visitor_id: string
        }
        Update: {
          created_at?: string | null
          id?: string
          post_slug?: string
          reaction_type?: string
          visitor_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "post_reactions_post_slug_fkey"
            columns: ["post_slug"]
            isOneToOne: false
            referencedRelation: "posts"
            referencedColumns: ["slug"]
          },
        ]
      }
      posts: {
        Row: {
          content_mdx: string | null
          cover_image: string | null
          created_at: string | null
          description: string | null
          id: string
          organization_id: string
          published: boolean | null
          published_at: string | null
          reviewed: boolean | null
          slug: string
          status: Database["public"]["Enums"]["post_status"] | null
          tags: string[] | null
          title: string
          updated_at: string | null
        }
        Insert: {
          content_mdx?: string | null
          cover_image?: string | null
          created_at?: string | null
          description?: string | null
          id?: string
          organization_id: string
          published?: boolean | null
          published_at?: string | null
          reviewed?: boolean | null
          slug: string
          status?: Database["public"]["Enums"]["post_status"] | null
          tags?: string[] | null
          title: string
          updated_at?: string | null
        }
        Update: {
          content_mdx?: string | null
          cover_image?: string | null
          created_at?: string | null
          description?: string | null
          id?: string
          organization_id?: string
          published?: boolean | null
          published_at?: string | null
          reviewed?: boolean | null
          slug?: string
          status?: Database["public"]["Enums"]["post_status"] | null
          tags?: string[] | null
          title?: string
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "posts_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      products: {
        Row: {
          active: boolean | null
          created_at: string | null
          currency: string | null
          description: string | null
          id: string
          images: string[] | null
          metadata: Json | null
          name: string
          organization_id: string
          price: number
          slug: string
          stock: number | null
        }
        Insert: {
          active?: boolean | null
          created_at?: string | null
          currency?: string | null
          description?: string | null
          id?: string
          images?: string[] | null
          metadata?: Json | null
          name: string
          organization_id: string
          price?: number
          slug: string
          stock?: number | null
        }
        Update: {
          active?: boolean | null
          created_at?: string | null
          currency?: string | null
          description?: string | null
          id?: string
          images?: string[] | null
          metadata?: Json | null
          name?: string
          organization_id?: string
          price?: number
          slug?: string
          stock?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "products_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      profiles: {
        Row: {
          avatar_url: string | null
          created_at: string | null
          email: string
          full_name: string | null
          id: string
          organization_id: string
          role: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id: string | null
          updated_at: string | null
        }
        Insert: {
          avatar_url?: string | null
          created_at?: string | null
          email: string
          full_name?: string | null
          id: string
          organization_id: string
          role?: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id?: string | null
          updated_at?: string | null
        }
        Update: {
          avatar_url?: string | null
          created_at?: string | null
          email?: string
          full_name?: string | null
          id?: string
          organization_id?: string
          role?: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id?: string | null
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "profiles_id_fkey"
            columns: ["id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "profiles_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      project_members: {
        Row: {
          added_at: string | null
          project_id: string
          role: string | null
          user_id: string
        }
        Insert: {
          added_at?: string | null
          project_id: string
          role?: string | null
          user_id: string
        }
        Update: {
          added_at?: string | null
          project_id?: string
          role?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "fk_project_members_users"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "project_members_project_id_fkey"
            columns: ["project_id"]
            isOneToOne: false
            referencedRelation: "projects"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "project_members_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
      projects: {
        Row: {
          branding_config: Json | null
          client_id: string
          created_at: string | null
          domain: string | null
          features_config: Json | null
          features_enabled: Json | null
          github_repo_url: string | null
          hosting_url: string | null
          id: string
          name: string
          organization_id: string | null
          repository_url: string | null
          status: Database["public"]["Enums"]["project_status"] | null
        }
        Insert: {
          branding_config?: Json | null
          client_id: string
          created_at?: string | null
          domain?: string | null
          features_config?: Json | null
          features_enabled?: Json | null
          github_repo_url?: string | null
          hosting_url?: string | null
          id?: string
          name: string
          organization_id?: string | null
          repository_url?: string | null
          status?: Database["public"]["Enums"]["project_status"] | null
        }
        Update: {
          branding_config?: Json | null
          client_id?: string
          created_at?: string | null
          domain?: string | null
          features_config?: Json | null
          features_enabled?: Json | null
          github_repo_url?: string | null
          hosting_url?: string | null
          id?: string
          name?: string
          organization_id?: string | null
          repository_url?: string | null
          status?: Database["public"]["Enums"]["project_status"] | null
        }
        Relationships: [
          {
            foreignKeyName: "projects_client_id_fkey"
            columns: ["client_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "projects_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      schedules: {
        Row: {
          created_at: string | null
          day_of_week: number
          end_time: string
          id: string
          is_active: boolean | null
          organization_id: string
          start_time: string
        }
        Insert: {
          created_at?: string | null
          day_of_week: number
          end_time: string
          id?: string
          is_active?: boolean | null
          organization_id: string
          start_time: string
        }
        Update: {
          created_at?: string | null
          day_of_week?: number
          end_time?: string
          id?: string
          is_active?: boolean | null
          organization_id?: string
          start_time?: string
        }
        Relationships: [
          {
            foreignKeyName: "schedules_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      services: {
        Row: {
          active: boolean | null
          created_at: string | null
          description: string | null
          duration_minutes: number | null
          form_schema: Json | null
          id: string
          organization_id: string
          price: number | null
          title: string
        }
        Insert: {
          active?: boolean | null
          created_at?: string | null
          description?: string | null
          duration_minutes?: number | null
          form_schema?: Json | null
          id?: string
          organization_id: string
          price?: number | null
          title: string
        }
        Update: {
          active?: boolean | null
          created_at?: string | null
          description?: string | null
          duration_minutes?: number | null
          form_schema?: Json | null
          id?: string
          organization_id?: string
          price?: number | null
          title?: string
        }
        Relationships: [
          {
            foreignKeyName: "services_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      test_assignments: {
        Row: {
          assigned_at: string | null
          campaign_id: string
          id: string
          user_id: string
        }
        Insert: {
          assigned_at?: string | null
          campaign_id: string
          id?: string
          user_id: string
        }
        Update: {
          assigned_at?: string | null
          campaign_id?: string
          id?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_assignments_campaign_id_fkey"
            columns: ["campaign_id"]
            isOneToOne: false
            referencedRelation: "test_campaigns"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "test_assignments_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
      test_campaigns: {
        Row: {
          created_at: string | null
          description: string | null
          id: string
          instructions: string | null
          project_id: string
          status: string | null
          title: string
        }
        Insert: {
          created_at?: string | null
          description?: string | null
          id?: string
          instructions?: string | null
          project_id: string
          status?: string | null
          title: string
        }
        Update: {
          created_at?: string | null
          description?: string | null
          id?: string
          instructions?: string | null
          project_id?: string
          status?: string | null
          title?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_campaigns_project_id_fkey"
            columns: ["project_id"]
            isOneToOne: false
            referencedRelation: "projects"
            referencedColumns: ["id"]
          },
        ]
      }
      test_results: {
        Row: {
          comment: string | null
          created_at: string | null
          device_info: string | null
          id: string
          status: string
          task_id: string
          updated_at: string | null
          user_id: string
        }
        Insert: {
          comment?: string | null
          created_at?: string | null
          device_info?: string | null
          id?: string
          status: string
          task_id: string
          updated_at?: string | null
          user_id: string
        }
        Update: {
          comment?: string | null
          created_at?: string | null
          device_info?: string | null
          id?: string
          status?: string
          task_id?: string
          updated_at?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_results_task_id_fkey"
            columns: ["task_id"]
            isOneToOne: false
            referencedRelation: "test_tasks"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "test_results_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
      test_tasks: {
        Row: {
          campaign_id: string
          description: string | null
          expected_result: string | null
          id: string
          order_index: number | null
          title: string
        }
        Insert: {
          campaign_id: string
          description?: string | null
          expected_result?: string | null
          id?: string
          order_index?: number | null
          title: string
        }
        Update: {
          campaign_id?: string
          description?: string | null
          expected_result?: string | null
          id?: string
          order_index?: number | null
          title?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_tasks_campaign_id_fkey"
            columns: ["campaign_id"]
            isOneToOne: false
            referencedRelation: "test_campaigns"
            referencedColumns: ["id"]
          },
        ]
      }
      web_audits: {
        Row: {
          created_at: string | null
          email: string | null
          id: string
          organization_id: string | null
          performance_score: number | null
          report_data: Json | null
          seo_score: number | null
          status: Database["public"]["Enums"]["audit_status"] | null
          url: string
          user_id: string | null
          visitor_id: string | null
        }
        Insert: {
          created_at?: string | null
          email?: string | null
          id?: string
          organization_id?: string | null
          performance_score?: number | null
          report_data?: Json | null
          seo_score?: number | null
          status?: Database["public"]["Enums"]["audit_status"] | null
          url: string
          user_id?: string | null
          visitor_id?: string | null
        }
        Update: {
          created_at?: string | null
          email?: string | null
          id?: string
          organization_id?: string | null
          performance_score?: number | null
          report_data?: Json | null
          seo_score?: number | null
          status?: Database["public"]["Enums"]["audit_status"] | null
          url?: string
          user_id?: string | null
          visitor_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "web_audits_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "web_audits_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users_summary"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Views: {
      users_summary: {
        Row: {
          avatar_url: string | null
          email: string | null
          full_name: string | null
          id: string | null
        }
        Insert: {
          avatar_url?: never
          email?: string | null
          full_name?: never
          id?: string | null
        }
        Update: {
          avatar_url?: never
          email?: string | null
          full_name?: never
          id?: string | null
        }
        Relationships: []
      }
    }
    Functions: {
      decrement_stock: {
        Args: { p_product_id: string; p_quantity: number }
        Returns: undefined
      }
      get_my_org_id: { Args: never; Returns: string }
      get_my_org_ids: { Args: never; Returns: string[] }
      is_admin: { Args: never; Returns: boolean }
    }
    Enums: {
      audit_status: "processing" | "completed" | "failed"
      content_status: "queued" | "generating" | "review" | "published"
      post_status: "draft" | "published" | "archived"
      project_status: "pending" | "active" | "maintenance" | "archived"
      user_role: "admin" | "client" | "lead" | "staff"
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  graphql_public: {
    Enums: {},
  },
  public: {
    Enums: {
      audit_status: ["processing", "completed", "failed"],
      content_status: ["queued", "generating", "review", "published"],
      post_status: ["draft", "published", "archived"],
      project_status: ["pending", "active", "maintenance", "archived"],
      user_role: ["admin", "client", "lead", "staff"],
    },
  },
} as const


// =================== FILE: src/types/index.ts ===================

import { Database } from './database.types';

// Exportem el tipus base per als clients de Supabase
export type { Database };

// Helpers per tenir tipus nets als components
// En lloc d'escriure la ruta llarga, farÃ s servir 'Audit' o 'Profile'
export type Audit = Database['public']['Tables']['web_audits']['Row'];
export type NewAudit = Database['public']['Tables']['web_audits']['Insert']; // Per formularis
export type Profile = Database['public']['Tables']['profiles']['Row'];
export type Project = Database['public']['Tables']['projects']['Row'];

// Tipus per als Enums (molt Ãºtil per dropdowns)
export type UserRole = Database['public']['Enums']['user_role'];
export type AuditStatus = Database['public']['Enums']['audit_status'];
export type ContactLead = Database['public']['Tables']['contact_leads']['Row'];
export type BlogPost = Database['public']['Tables']['posts']['Row'];

// =================== FILE: src/types/joins.ts ===================

// src/types/models.ts (AmpliaciÃ³)

import { Database } from './database.types';

// Tipus base de les taules
type TestCampaign = Database['public']['Tables']['test_campaigns']['Row'];
type TestTask = Database['public']['Tables']['test_tasks']['Row'];
type TestResult = Database['public']['Tables']['test_results']['Row'];

// 1. Tipus per a la Campanya amb les Tasques (Nested)
export type CampaignWithTasks = TestCampaign & {
  test_tasks: TestTask[]; // La relaciÃ³ es diu com la taula normalment
};

// 2. Tipus per al Repositori (Campaign + Context)
export type CampaignContext = {
  campaign: TestCampaign | null;
  tasks: TestTask[];
  results: TestResult[];
};

// =================== FILE: src/types/models.ts ===================

// 1. DTO - AixÃ­ Ã©s com la nostra UI vol veure una auditoria (Tipatge net)
export type AuditDTO = {
  id: string;
  url: string;
  status: 'processing' | 'completed' | 'failed';
  seoScore: number | null; // CamelCase per JS
  performanceScore: number | null;
  createdAt: Date; // Objecte Date real, no string
  reportData: Record<string, unknown> | null;
};


export interface IAuditRepository {
  getAuditsByUserEmail(email: string): Promise<AuditDTO[]>;
  getAuditById(id: string): Promise<AuditDTO | null>;
  createAudit(url: string, email: string): Promise<AuditDTO>;
  
  updateStatus(
    id: string, 
    status: AuditDTO['status'], 
    results?: { 
      seoScore?: number; 
      performanceScore?: number; 
      // âœ… CoherÃ¨ncia de tipus
      reportData?: Record<string, unknown> 
    }
  ): Promise<void>;
}


// 1. DTO (Data Transfer Object): Com la teva UI vol veure les dades (camelCase, net)
export type BlogPostDTO = {
  id: string; // ğŸ‘ˆ AFEGEIX AQUESTA LÃNIA
  slug: string;
  title: string;
  date: string | null;     // Mapejat des de published_at
  description: string | null;
  content: string | null;  // Mapejat des de content_mdx
  tags: string[];
  coverImage: string | null; // Mapejat des de cover_image
  published: boolean;
  reviewed: boolean; // ğŸ‘ˆ NOU CAMP
  totalReactions?: number;
};



// PROJECTE: digitAIStudios
// FITXER: src/types/config.ts

export type ModuleStatus = boolean;

export interface SiteIdentity {
  name: string;
  description: string;
  logoUrl: string;
  faviconUrl: string;
  contactEmail: string;
}

export interface SiteBranding {
  colors: {
    primary: string;
    secondary: string;
    background: string;
    foreground: string;
  };
  radius: number;
}

export interface SiteModules {
  landing: {
    active: boolean;
    sections: ('hero' | 'features' | 'services' | 'contact' | 'testimonials')[];
  };
  auth: ModuleStatus;
  dashboard: ModuleStatus;
  booking: ModuleStatus;
  ecommerce: ModuleStatus;
  blog: ModuleStatus;
  inventory: ModuleStatus;
  accessControl: ModuleStatus;
}

export interface I18nConfig {
  locales: string[];
  defaultLocale: string;
}

export interface MasterConfig {
  identity: SiteIdentity;
  branding: SiteBranding;
  modules: SiteModules;
  i18n: I18nConfig;
}

export type TestCampaignDTO = {
  id: string;
  projectId: string;
  title: string;
  description: string | null;
  instructions: string | null;
  status: string;
  createdAt: Date;
};

export type TestTaskDTO = {
  id: string;
  campaignId: string;
  title: string;
  description: string | null;
  orderIndex: number;
};

export type TestResultDTO = {
  id: string;
  taskId: string;
  userId: string;
  status: 'pass' | 'fail' | 'blocked';
  comment: string | null;
  updatedAt: Date;
};

// Tipus per al retorn combinat del repositori
export type CampaignContext = {
  campaign: TestCampaignDTO | null;
  tasks: TestTaskDTO[];
  results: TestResultDTO[];
};

export type TesterProfile = {
  id: string;
  email: string;
  full_name: string | null;
  avatar_url: string | null;
};

export type AnalyticsEventDTO = {
  event_name: string;
  path: string;
  session_id: string;
  duration?: number;
  referrer?: string;
  
  // Metadades tÃ¨cniques (JSON pur)
  meta?: Record<string, unknown>;
  
  // Dades processades (Columnes reals a DB)
  geo?: {
    country: string | null;
    city: string | null;
  };
  device?: {
    type: string;    // 'mobile', 'tablet', 'desktop'
    browser: string; // 'Chrome', 'Safari'
    os: string;      // 'iOS', 'Windows'
  };
};
