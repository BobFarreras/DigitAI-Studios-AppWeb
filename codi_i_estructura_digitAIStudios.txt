ESTRUCTURA DEL PROJECTE (./src)

â”œâ”€â”€ actions
â”‚   â””â”€â”€ contact.ts
â”œâ”€â”€ adapters
â”‚   â”œâ”€â”€ google
â”‚   â”‚   â”œâ”€â”€ PageSpeedAdapter.ts
â”‚   â”‚   â””â”€â”€ schemas.ts
â”‚   â”œâ”€â”€ GooglePageSpeedAdapter.ts
â”‚   â”œâ”€â”€ interfaces
â”‚   â””â”€â”€ IWebScanner.ts
â”œâ”€â”€ app
â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â””â”€â”€ get-users.ts
â”‚   â”œâ”€â”€ api
â”‚   â”‚   â”œâ”€â”€ track
â”‚   â”‚   â””â”€â”€ web-audit
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â”œâ”€â”€ globals.css
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ manifest.ts
â”‚   â”œâ”€â”€ robots.ts
â”‚   â”œâ”€â”€ sitemap.ts
â”‚   â””â”€â”€ [locale]
â”‚       â”œâ”€â”€ (marketing)
â”‚       â”‚   â”œâ”€â”€ blog
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [slug]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ legal
â”‚       â”‚   â”‚   â”œâ”€â”€ avis-legal
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ cookies
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ privacitat
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ projectes
â”‚       â”‚       â””â”€â”€ page.tsx
â”‚       â”œâ”€â”€ admin
â”‚       â”‚   â”œâ”€â”€ analytics
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ blog
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [slug]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ debug
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ projects
â”‚       â”‚   â”‚   â”œâ”€â”€ new
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ tests
â”‚       â”‚   â”‚   â”œâ”€â”€ new
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ users
â”‚       â”‚       â””â”€â”€ page.tsx
â”‚       â”œâ”€â”€ auth
â”‚       â”‚   â”œâ”€â”€ callback
â”‚       â”‚   â”‚   â””â”€â”€ route.ts
â”‚       â”‚   â”œâ”€â”€ forgot-password
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ login
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ register
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ reset-password
â”‚       â”‚       â””â”€â”€ page.tsx
â”‚       â”œâ”€â”€ dashboard
â”‚       â”‚   â”œâ”€â”€ audits
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ [id]
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ MobilBottomBar.tsx
â”‚       â”‚   â”œâ”€â”€ new-audit
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ projects
â”‚       â”‚       â”œâ”€â”€ page.tsx
â”‚       â”‚       â””â”€â”€ [id]
â”‚       â”‚           â””â”€â”€ page.tsx
â”‚       â””â”€â”€ layout.tsx
â”œâ”€â”€ assets
â”‚   â””â”€â”€ images
â”‚       â”œâ”€â”€ hero.webp
â”‚       â”œâ”€â”€ og-image.jpg
â”‚       â”œâ”€â”€ pantalla-ribotflow.jpg
â”‚       â”œâ”€â”€ pantalla-salutflow.jpg
â”‚       â”œâ”€â”€ ribotflow.png
â”‚       â”œâ”€â”€ salutflow.png
â”‚       â””â”€â”€ testimoni-garatgeestacio.jpg
â”œâ”€â”€ components
â”‚   â”œâ”€â”€ admin
â”‚   â”‚   â””â”€â”€ AminMobileMenu.tsx
â”‚   â”œâ”€â”€ charts
â”‚   â”‚   â””â”€â”€ ScoreRing.tsx
â”‚   â”œâ”€â”€ dashboard
â”‚   â”‚   â”œâ”€â”€ AuditCard.tsx
â”‚   â”‚   â”œâ”€â”€ DashboardHeader.tsx
â”‚   â”‚   â””â”€â”€ Sidebar.tsx
â”‚   â”œâ”€â”€ landing
â”‚   â”‚   â”œâ”€â”€ AuditSection.tsx
â”‚   â”‚   â”œâ”€â”€ BenefitsSection.tsx
â”‚   â”‚   â”œâ”€â”€ ContactSection.tsx
â”‚   â”‚   â”œâ”€â”€ HeroSection.tsx
â”‚   â”‚   â”œâ”€â”€ ProblemSolutionsSection.tsx
â”‚   â”‚   â”œâ”€â”€ ProductTeaser.tsx
â”‚   â”‚   â”œâ”€â”€ ServicesGrid.tsx
â”‚   â”‚   â”œâ”€â”€ SocialSection.tsx
â”‚   â”‚   â”œâ”€â”€ TechStackSection.tsx
â”‚   â”‚   â””â”€â”€ TestimonialsSection.tsx
â”‚   â”œâ”€â”€ layout
â”‚   â”‚   â”œâ”€â”€ Footer.tsx
â”‚   â”‚   â”œâ”€â”€ LanguageSwitcher.tsx
â”‚   â”‚   â”œâ”€â”€ LegalLayout.tsx
â”‚   â”‚   â””â”€â”€ Navbar.tsx
â”‚   â”œâ”€â”€ theme-provider.tsx
â”‚   â””â”€â”€ ui
â”‚       â”œâ”€â”€ avatar.tsx
â”‚       â”œâ”€â”€ button.tsx
â”‚       â”œâ”€â”€ card.tsx
â”‚       â”œâ”€â”€ checkbox.tsx
â”‚       â”œâ”€â”€ dropdown-menu.tsx
â”‚       â”œâ”€â”€ input.tsx
â”‚       â”œâ”€â”€ tabs.tsx
â”‚       â”œâ”€â”€ textarea.tsx
â”‚       â””â”€â”€ theme-toggle.tsx
â”œâ”€â”€ features
â”‚   â”œâ”€â”€ analytics
â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ AnalyticsTracker.tsx
â”‚   â”‚       â”œâ”€â”€ BarListChart.tsx
â”‚   â”‚       â”œâ”€â”€ DeviceChart.tsx
â”‚   â”‚       â”œâ”€â”€ TopPagesCard.tsx
â”‚   â”‚       â”œâ”€â”€ TrafficChart.tsx
â”‚   â”‚       â”œâ”€â”€ UnifiedStatBar.tsx
â”‚   â”‚       â””â”€â”€ VerticalBarChart.tsx
â”‚   â”œâ”€â”€ audit
â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ AuditForm.tsx
â”‚   â”‚       â”œâ”€â”€ components
â”‚   â”‚       â”‚   â”œâ”€â”€ AuditHeader.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ CoreVitalsGrid.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ CreateAuditForm.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadAuditButton.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ IssuesList.tsx
â”‚   â”‚       â”‚   â”œâ”€â”€ MobilePreviw.tsx
â”‚   â”‚       â”‚   â””â”€â”€ ScoreGrid.tsx
â”‚   â”‚       â””â”€â”€ pdf
â”‚   â”‚           â””â”€â”€ AuditPdfDocument.tsx
â”‚   â”œâ”€â”€ auth
â”‚   â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â”‚   â””â”€â”€ reset-password.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ ForgotPasswordForm.tsx
â”‚   â”‚       â”œâ”€â”€ LoginForm.tsx
â”‚   â”‚       â”œâ”€â”€ RegisterForm.tsx
â”‚   â”‚       â””â”€â”€ ResetPasswordForm.tsx
â”‚   â”œâ”€â”€ blog
â”‚   â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â”‚   â””â”€â”€ admin-actions.ts
â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ AdminPostList.tsx
â”‚   â”‚       â”œâ”€â”€ EditPostForm.tsx
â”‚   â”‚       â”œâ”€â”€ MDXContent.tsx
â”‚   â”‚       â””â”€â”€ PostStatusToggle.tsx
â”‚   â”œâ”€â”€ email
â”‚   â”‚   â””â”€â”€ templates
â”‚   â”‚       â””â”€â”€ AuditReadyEmail.tsx
â”‚   â”œâ”€â”€ projects
â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚   â”‚   â”œâ”€â”€ data
â”‚   â”‚   â”‚   â””â”€â”€ projects-data.ts
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ ui
â”‚   â”‚       â”œâ”€â”€ InviteClientForm.tsx
â”‚   â”‚       â”œâ”€â”€ NewProjectForm.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectCard.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectList.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectsCTA.tsx
â”‚   â”‚       â””â”€â”€ ProjectsHero.tsx
â”‚   â””â”€â”€ tests
â”‚       â”œâ”€â”€ actions
â”‚       â”‚   â””â”€â”€ admin-actions.ts
â”‚       â”œâ”€â”€ actions.ts
â”‚       â””â”€â”€ ui
â”‚           â”œâ”€â”€ CreateCampaignForm.tsx
â”‚           â”œâ”€â”€ TaskRunner.tsx
â”‚           â””â”€â”€ TesterManager.tsx
â”œâ”€â”€ i18n
â”‚   â””â”€â”€ request.ts
â”œâ”€â”€ lib
â”‚   â”œâ”€â”€ audit-dictionary.ts
â”‚   â”œâ”€â”€ auth
â”‚   â”‚   â””â”€â”€ admin-guard.ts
â”‚   â”œâ”€â”€ data.ts
â”‚   â”œâ”€â”€ factory
â”‚   â”‚   â””â”€â”€ config-generator.ts
â”‚   â”œâ”€â”€ mock-audit.ts
â”‚   â”œâ”€â”€ supabase
â”‚   â”‚   â”œâ”€â”€ client.ts
â”‚   â”‚   â”œâ”€â”€ middleware.ts
â”‚   â”‚   â””â”€â”€ server.ts
â”‚   â”œâ”€â”€ utils.ts
â”‚   â””â”€â”€ validations
â”œâ”€â”€ proxy.ts
â”œâ”€â”€ repositories
â”‚   â”œâ”€â”€ interfaces
â”‚   â”‚   â”œâ”€â”€ IAnalyticsRepository.ts
â”‚   â”‚   â”œâ”€â”€ IAuditRepository.ts
â”‚   â”‚   â””â”€â”€ IPostRepository.ts
â”‚   â””â”€â”€ supabase
â”‚       â”œâ”€â”€ SupabaseAnalyticsRepository.ts
â”‚       â”œâ”€â”€ SupabaseAuditRepository.ts
â”‚       â”œâ”€â”€ SupabasePostRepository.ts
â”‚       â””â”€â”€ SupabaseTestRepository.ts
â”œâ”€â”€ routing.ts
â”œâ”€â”€ services
â”‚   â”œâ”€â”€ AIService.ts
â”‚   â”œâ”€â”€ AuditService.ts
â”‚   â”œâ”€â”€ container.ts
â”‚   â”œâ”€â”€ email
â”‚   â”‚   â””â”€â”€ ResendEmailService.ts
â”‚   â”œâ”€â”€ FactoryService.ts
â”‚   â””â”€â”€ PostService.ts
â””â”€â”€ types
    â”œâ”€â”€ actions.ts
    â”œâ”€â”€ config.ts
    â”œâ”€â”€ database.types.ts
    â”œâ”€â”€ index.ts
    â”œâ”€â”€ joins.ts
    â””â”€â”€ models.ts


CONTINGUT DELS FITXERS


// =================== FILE: src/actions/contact.ts ===================

'use server';

import { z } from 'zod';
import { createClient } from '@/lib/supabase/server';
// 1. Definim el tipus per al 'prevState' per evitar l'error d'ESLint


export type FormState = {
  success: boolean;
  message?: string;
  errors?: {
    fullName?: string[];
    email?: string[];
    service?: string[];
    message?: string[];
    privacy?: string[];
  };
};

// 2. Corregim l'schema de Zod
const ContactSchema = z.object({
  fullName: z.string().min(2, "Nom massa curt"),
  email: z.string().email("Email invÃ lid"),
  service: z.string().min(1, "Selecciona un servei"),
  message: z.string().min(10, "Explica'ns una mica mÃ©s"),
  // SOLUCIÃ“ ZOD: Usem errorMap aquÃ­ o simplement 'message'
  privacy: z.literal("on", { 
    message: "Has d'acceptar la polÃ­tica de privacitat" 
  }),
});

export async function submitContactForm(
  prevState: FormState, // Tipatge correcte
  formData: FormData
): Promise<FormState> {
  const rawData = Object.fromEntries(formData.entries());
  
  // Validar dades
  const validated = ContactSchema.safeParse(rawData);
  if (!validated.success) {
    return { 
      success: false, 
      errors: validated.error.flatten().fieldErrors 
    };
  }

  try {
   // 1. Creem el client tipat
  const supabase = await createClient(); 
  
  // 2. InserciÃ³ TIPADA i CORRECTA
  // NO facis: .from('contact_leads' as ContactLead) <- AixÃ² dÃ³na l'error que tenies
  // Has de fer servir l'string literal tal qual:
  const { error } = await supabase
    .from('contact_leads') 
    .insert({
      full_name: validated.data.fullName,
      email: validated.data.email,
      service: validated.data.service,
      message: validated.data.message,
      source: 'landing_contact_form'
    });

  if (error) {
    console.error("Error saving lead:", error);
    return { success: false, message: "Error tÃ¨cnic. Torna-ho a provar." };
  }

  return { success: true, message: "Missatge enviat! Et contactarem aviat." };
}
catch (err) {
    console.error("Unexpected error:", err);
    return { success: false, message: "Error inesperat. Torna-ho a provar." };
    }
  }

// =================== FILE: src/adapters/google/PageSpeedAdapter.ts ===================

import { IWebScanner, ScanResult, AuditIssue } from '@/adapters/IWebScanner';

export class PageSpeedAdapter implements IWebScanner {
  private apiKey: string;
  private apiUrl = 'https://www.googleapis.com/pagespeedonline/v5/runPagespeed';

  constructor(apiKey: string) {
    this.apiKey = apiKey;
  }

  async scanUrl(url: string): Promise<ScanResult> {
    // Demanem categories: PERFORMANCE, SEO, BEST_PRACTICES, ACCESSIBILITY
    const endpoint = `${this.apiUrl}?url=${encodeURIComponent(url)}&key=${this.apiKey}&category=PERFORMANCE&category=SEO&category=ACCESSIBILITY&strategy=mobile`;

    const response = await fetch(endpoint);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Google API Error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    const lighthouse = data.lighthouseResult;

    // 1. Extraure Puntuacions
    const performanceScore = Math.round((lighthouse.categories.performance?.score || 0) * 100);
    const seoScore = Math.round((lighthouse.categories.seo?.score || 0) * 100);

    // 2. Extraure la Captura de Pantalla (Base64)
    // Google la torna a 'lighthouse.audits["final-screenshot"].details.data'
    const screenshot = lighthouse.audits['final-screenshot']?.details?.data;

    // 3. Extraure Problemes (Issues)
    // Busquem audits que tinguin un score baix (< 0.9) i que siguin rellevants
    const issues: AuditIssue[] = [];
    const auditsObj = lighthouse.audits;

    // Llista d'IDs d'auditoria que ens interessen (Google en tÃ© molts)
    const criticalAudits = [
        'first-contentful-paint',
        'largest-contentful-paint',
        'cumulative-layout-shift',
        'server-response-time',
        'render-blocking-resources',
        'uses-optimized-images',
        'meta-description',
        'document-title',
        'link-text'
    ];

    criticalAudits.forEach((key) => {
        const audit = auditsObj[key];
        // Si existeix i la puntuaciÃ³ no Ã©s perfecta (< 0.9) o Ã©s informativa
        if (audit && typeof audit.score === 'number' && audit.score < 0.9) {
            issues.push({
                id: key,
                title: audit.title,
                description: audit.description,
                score: audit.score,
                displayValue: audit.displayValue
            });
        }
    });

    return {
      seoScore,
      performanceScore,
      screenshot, // Ara tenim la foto!
      issues,     // Ara tenim la llista de problemes!
      reportData: data // Guardem l'original per si de cas
    };
  }
}

// =================== FILE: src/adapters/google/schemas.ts ===================

import { z } from 'zod';

// 1. Esquema per a una mÃ¨trica individual (Audit)
export const LighthouseAuditSchema = z.object({
  id: z.string(),
  title: z.string().optional(),
  description: z.string().optional(),
  score: z.number().nullable().optional(),
  displayValue: z.string().optional(),
  numericValue: z.number().optional(),
  // Utilitzem .catch() o .optional() per evitar trencaments si ve alguna cosa rara
  details: z.record(z.string(), z.unknown()).optional(), 
});

// 2. Esquema per a les Categories
const CategorySchema = z.object({
  score: z.number().nullable().optional(),
});

// 3. Esquema Principal de la Resposta de Google
export const PageSpeedResponseSchema = z.object({
  lighthouseResult: z.object({
    categories: z.object({
      performance: CategorySchema.optional(),
      seo: CategorySchema.optional(),
      accessibility: CategorySchema.optional(),
      'best-practices': CategorySchema.optional(),
    }),
    // âš ï¸ CORRECCIÃ“ CRÃTICA AQUÃ ğŸ‘‡
    // Definim explÃ­citament que la CLAU Ã©s un string
    audits: z.record(z.string(), LighthouseAuditSchema),
  }),
});

// Exportem el tipus inferit
export type PageSpeedResponse = z.infer<typeof PageSpeedResponseSchema>;

// =================== FILE: src/adapters/GooglePageSpeedAdapter.ts ===================

import { IWebScanner, ScanResult, AuditIssue } from './IWebScanner';
import { translateIssue } from '@/lib/audit-dictionary';
// Assegura't que la ruta d'importaciÃ³ Ã©s correcta
import { PageSpeedResponseSchema } from './google/schemas';

export const AUDIT_TRANSLATIONS: Record<
    string, // id de l'auditoria
    Record<
        string, // locale, p.ex. 'ca', 'es', 'en'
        { title: string; description: string }
    >
> = {
    'is-on-https': {
        ca: {
            title: 'El lloc web no utilitza HTTPS segur',
            description: 'La teva web no Ã©s segura. AixÃ² espanta els clients i Google et penalitza greument.'
        },
        es: {
            title: 'El sitio web no usa HTTPS seguro',
            description: 'Tu web no es segura. Esto asusta a los clientes y Google te penaliza.'
        },
        en: {
            title: 'Website is not using secure HTTPS',
            description: 'Your website is not secure. This scares users and Google may penalize you.'
        }
    },
    // ... altres auditories
};

export class GooglePageSpeedAdapter implements IWebScanner {
    private apiKey?: string;
    private apiUrl = 'https://www.googleapis.com/pagespeedonline/v5/runPagespeed';

    constructor(apiKey?: string) {
        this.apiKey = apiKey;
    }

    async scanUrl(url: string, locale: string = 'ca'): Promise<ScanResult> {
        const params = new URLSearchParams({
            url,
            strategy: 'mobile',
            locale, // ara ve de fora
        });
        try {
            const check = await fetch(url, { method: 'HEAD' });
            if (check.status >= 400) {
                throw new Error(`La web retorna un error ${check.status}.`);
            }
        } catch (e) {
            console.error("Error connectant amb la web:", e);
            throw new Error(`No s'ha pogut accedir a la web: ${url}`);
        }



        ['PERFORMANCE', 'SEO', 'ACCESSIBILITY', 'BEST_PRACTICES'].forEach(cat => {
            params.append('category', cat);
        });
        if (this.apiKey) {
            params.append('key', this.apiKey);
        }

        // 3. CRIDA A GOOGLE
        const response = await fetch(`${this.apiUrl}?${params.toString()}`);

        if (!response.ok) {
            const errText = await response.text();
            throw new Error(`Google API Error (${response.status}): ${errText}`);
        }

        const rawJson = await response.json();

        // ğŸ›¡ï¸ VALIDACIÃ“ ZOD
        const validation = PageSpeedResponseSchema.safeParse(rawJson);

        if (!validation.success) {
            console.error("âŒ Dades invÃ lides de Google API:", validation.error);
            throw new Error("Error processant l'auditoria: L'estructura de dades de Google no Ã©s correcta.");
        }

        // Ara TypeScript sap perfectament quÃ¨ Ã©s 'data'
        const data = validation.data;
        const lh = data.lighthouseResult;

        // 4. EXTRACCIÃ“ DE PUNTUACIONS
        const scores = {
            performance: Math.round((lh.categories.performance?.score || 0) * 100),
            seo: Math.round((lh.categories.seo?.score || 0) * 100),
        };

        const audits = lh.audits;

        // 5. EXTRACCIÃ“ DE CORE WEB VITALS
        const getMetric = (key: string, desc: string) => {
            const audit = audits[key];
            return {
                value: audit?.displayValue,
                score: audit?.score ?? 0,
                description: desc
            };
        };

        const metrics = {
            fcp: getMetric('first-contentful-paint', "Temps fins al primer contingut visible."),
            lcp: getMetric('largest-contentful-paint', "Temps de cÃ rrega de l'element mÃ©s gran."),
            cls: getMetric('cumulative-layout-shift', "Estabilitat visual."),
            tbt: getMetric('total-blocking-time', "Temps de bloqueig del navegador."),
            si: getMetric('speed-index', "Ãndex de velocitat visual.")
        };

        // 6. PROCESSAMENT D'ERRORS (ISSUES)
        const issues: AuditIssue[] = Object.values(audits)
            .filter(a => typeof a.score === 'number' && a.score < 0.9)
            .map(a => {
                const cleanDescription = a.description?.split('[')[0].replace(/\.$/, '') || '';
                const translated = translateIssue(
                    a.id,
                    a.title || 'Unknown Issue',
                    a.description || '',
                    locale
                ); return {
                    id: a.id,
                    title: translated.title || a.title || 'Unknown Issue',
                    description: translated.description || cleanDescription,
                    score: a.score || 0,
                    displayValue: a.displayValue
                };
            })
            .sort((a, b) => a.score - b.score)
            .slice(0, 8);

        // 7. EXTRACCIÃ“ DE CAPTURA (Amb Type Guard)
        const screenshotAudit = audits['final-screenshot'];
        let screenshotData: string | undefined;

        // Verifiquem que 'details' existeixi i tingui la propietat 'data'
        if (screenshotAudit?.details && typeof screenshotAudit.details === 'object') {
            // Fem un cast segur perquÃ¨ sabem que Google torna { type: 'screenshot', data: 'base64...' }
            const details = screenshotAudit.details as { data?: string };
            if (details.data) {
                screenshotData = details.data;
            }
        }

        return {
            seoScore: scores.seo,
            performanceScore: scores.performance,
            screenshot: screenshotData,
            issues: issues,
            metrics: metrics,
            reportData: data
        };
    }
}

// =================== FILE: src/adapters/IWebScanner.ts ===================

import { AuditMetric } from '@/features/audit/ui/components/CoreVitalsGrid';

export type AuditIssue = {
  id: string;          // ğŸ‘ˆ AFEGIT: Necessari per traduir a la UI
  title: string;
  description: string;
  score: number;       
  displayValue?: string;
  impact?: string;     
  type?: 'error' | 'warning' | 'success';
};

export type ScanResult = {
  seoScore: number;
  performanceScore: number;
  screenshot?: string; 
  issues: AuditIssue[]; 
  reportData: unknown; 
  metrics?: {
    fcp?: AuditMetric;
    lcp?: AuditMetric;
    cls?: AuditMetric;
    tbt?: AuditMetric;
    si?: AuditMetric;
  };
};

export interface IWebScanner {
  scanUrl(url: string): Promise<ScanResult>;
}

// =================== FILE: src/app/actions/get-users.ts ===================

'use server'

import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';

export type UserProfile = {
  id: string;
  email: string;
  role: 'admin' | 'client' | 'lead';
  created_at: string;
  full_name: string | null;
};

export async function getAdminUsersList(): Promise<UserProfile[]> {
  const supabase = await createClient();
 
  // 1. Verificar sessiÃ³ actual
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) redirect('/auth/login');

  // 2. ğŸ›¡ï¸ SUPER ADMIN CHECK
  // Si el correu Ã©s el de la variable d'entorn, ets admin SI o SI.
  const isSuperAdmin = user.email === process.env.ADMIN_EMAIL;

  if (!isSuperAdmin) {
    // Si no ets el Super Admin per variable, comprovem la base de dades
    const { data: currentUserProfile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single();

    if (currentUserProfile?.role !== 'admin') {
      redirect('/'); // Fora d'aquÃ­
    }
  }

  // 3. Obtenir dades
  // NOTA IMPORTANT: Encara que el codi et deixi passar, el RLS (Row Level Security) 
  // de Supabase et pot bloquejar les dades si el teu rol a la DB no Ã©s 'admin'.
  const { data: profiles, error } = await supabase
    .from('profiles')
    .select('*')
    .order('created_at', { ascending: false });

  if (error) {
    console.error('Error fetching users:', error);
    return [];
  }

  return profiles as UserProfile[];
}

// =================== FILE: src/app/globals.css ===================

@import "tailwindcss";
@plugin "tailwindcss-animate";
/* ğŸ‘‡ AQUESTA Ã‰S LA LÃNIA MÃ€GICA ğŸ‘‡ */
@custom-variant dark (&:is(.dark *));
/* =========================================
   1. VARIABLES DE COLOR
   ========================================= */
:root {
  /* Mode Clar (EstÃ ndard) */
  --background: 0 0% 100%;
  --foreground: 260 10% 3.9%; /* Lleugerament tintat */
  --card: 0 0% 100%;
  --card-foreground: 260 10% 3.9%;
  --popover: 0 0% 100%;
  --popover-foreground: 260 10% 3.9%;
  --primary: 262 83% 58%;
  --primary-foreground: 0 0% 98%;
  --secondary: 260 4.8% 95.9%;
  --secondary-foreground: 260 5.9% 10%;
  --muted: 260 4.8% 95.9%;
  --muted-foreground: 260 3.8% 46.1%;
  --accent: 260 4.8% 95.9%;
  --accent-foreground: 260 5.9% 10%;
  --destructive: 0 84.2% 60.2%;
  --destructive-foreground: 0 0% 98%;
  --border: 260 5.9% 90%;
  --input: 260 5.9% 90%;
  --ring: 262 83% 58%;
  --radius: 0.75rem;
  --p: 222 47% 11%;
}

.dark {
  /* âœ¨ EL COLOR QUE BUSCAVES: Negre Apagat amb toc Lila */
  /* HSL: Hue 260 (Lila), Sat 8% (Apagat), Light 4% (Fosc casi negre) */
  /* CORREGIT: Afegit el '4%' que faltava */
  --background: 260 8% 4%; 
  --foreground: 260 10% 98%;

  /* Les targetes un pÃ¨l mÃ©s clares que el fons (Light 7%) per crear profunditat */
  --card: 260 14% 7%;
  --card-foreground: 260 10% 98%;

  /* Popovers encara mÃ©s foscos o igual que les cards */
  --popover: 260 14% 4%;
  --popover-foreground: 260 10% 98%;

  /* El morat de la marca (Vibrant) */
  --primary: 263 70% 50%;
  --primary-foreground: 0 0% 98%;

  /* Elements secundaris (Gris fosc lilos) */
  --secondary: 260 15% 12%;
  --secondary-foreground: 0 0% 98%;

  /* Gris "Muted" */
  --muted: 260 15% 12%;
  --muted-foreground: 260 10% 65%;

  --accent: 260 15% 12%;
  --accent-foreground: 0 0% 98%;

  --destructive: 0 62.8% 30.6%;
  --destructive-foreground: 0 0% 98%;

  /* Vores molt subtils */
  --border: 260 15% 12%;
  --input: 260 15% 12%;
  --ring: 263 70% 50%;

  /* P: Color addicional per grÃ fics o textos especÃ­fics */
  --p: 216 12% 84%; /* slate-300 */
}

/* =========================================
   2. CONFIGURACIÃ“ DEL TEMA (Tailwind v4)
   ========================================= */
@theme inline {
  --color-background: hsl(var(--background));
  --color-foreground: hsl(var(--foreground));
  --color-card: hsl(var(--card));
  --color-card-foreground: hsl(var(--card-foreground));
  --color-popover: hsl(var(--popover));
  --color-popover-foreground: hsl(var(--popover-foreground));
  --color-primary: hsl(var(--primary));
  --color-primary-foreground: hsl(var(--primary-foreground));
  --color-secondary: hsl(var(--secondary));
  --color-secondary-foreground: hsl(var(--secondary-foreground));
  --color-muted: hsl(var(--muted));
  --color-muted-foreground: hsl(var(--muted-foreground));
  --color-accent: hsl(var(--accent));
  --color-accent-foreground: hsl(var(--accent-foreground));
  --color-destructive: hsl(var(--destructive));
  --color-destructive-foreground: hsl(var(--destructive-foreground));
  --color-border: hsl(var(--border));
  --color-input: hsl(var(--input));
  --color-ring: hsl(var(--ring));

  --radius-xl: calc(var(--radius) + 4px);
  --radius-lg: var(--radius);
  --radius-md: calc(var(--radius) - 2px);
  --radius-sm: calc(var(--radius) - 4px);

  --animate-floating: floating 6s ease-in-out infinite;
  --animate-pulse-glow: pulse-glow 2s ease-in-out infinite alternate;

  @keyframes floating {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
  }
  @keyframes pulse-glow {
    from { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
    to { box-shadow: 0 0 40px rgba(168, 85, 247, 0.8); }
  }
}

/* =========================================
   3. BASE & COMPONENTS
   ========================================= */
@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground antialiased;
    font-feature-settings: "rlig" 1, "calt" 1;
  }
}

@layer components {
  
  /* ICONES MODERNS (Tal com sortien a les imatges) */
  .benefit-icon {
    @apply w-14 h-14 rounded-2xl flex items-center justify-center mb-6 transition-all duration-300;
    /* Degradat molt subtil sobre el fons fosc */
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(99, 102, 241, 0.15) 100%);
    border: 1px solid rgba(168, 85, 247, 0.2);
    box-shadow: 0 0 0 1px rgba(168, 85, 247, 0.05); /* Ring subtil */
  }

  /* Efecte Hover Glow */
  .group:hover .benefit-icon {
    @apply scale-110 border-primary/50;
    box-shadow: 0 0 25px rgba(168, 85, 247, 0.3);
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.25) 0%, rgba(99, 102, 241, 0.25) 100%);
  }

  /* Targetes Futuristes (MÃ©s netes, estil "Glass") */
  .solution-card-futuristic {
    @apply bg-white/[0.03] border border-white/[0.08] backdrop-blur-sm rounded-2xl p-8 transition-all duration-300;
  }
  
  .solution-card-futuristic:hover {
    @apply border-primary/40 bg-white/[0.06] -translate-y-1;
  }

  /* Inputs (Fons transparent o molt fosc) */
  .input-dark {
    @apply bg-white/[0.03] border border-white/10 text-white placeholder:text-muted-foreground focus:border-primary focus:ring-1 focus:ring-primary rounded-lg;
  }

  .testimonial-card {
    @apply bg-white/[0.03] border border-white/10 backdrop-blur-md rounded-2xl p-8 transition-all duration-300;
  }
}

@layer utilities {
  .gradient-text {
    @apply bg-gradient-to-r from-[#a855f7] to-[#6366f1] bg-clip-text text-transparent;
  }
  .gradient-bg {
    @apply bg-gradient-to-r from-[#a855f7] to-[#6366f1];
  }
  .section-divider {
     /* LÃ­nia divisÃ²ria molt subtil, quasi invisible */
     @apply h-[1px] w-full bg-gradient-to-r from-transparent via-white/10 to-transparent my-12;
  }
}

// =================== FILE: src/app/layout.tsx ===================

// src/app/layout.tsx
import { ReactNode } from 'react';

type Props = {
  children: ReactNode;
};

// Aquest component nomÃ©s existeix perquÃ¨ Next.js no es queixi.
// El middleware s'encarrega d'enviar l'usuari a /[locale]/..., 
// per tant, l'usuari mai veurÃ  aquest HTML "buit".
export default function RootLayout({ children }: Props) {
  return children;
}

// =================== FILE: src/app/manifest.ts ===================

import { MetadataRoute } from 'next';

export default function manifest(): MetadataRoute.Manifest {
  return {
    name: 'DigitAI Studios',
    short_name: 'DigitAI',
    description: 'AgÃ¨ncia de desenvolupament web, apps i automatitzaciÃ³ IA.',
    start_url: '/',
    display: 'standalone', // Fa que sembli una App real (sense barra de navegador)
    background_color: '#020817', // El color "Midnight Indigo" del teu dark mode
    theme_color: '#020817',
    orientation: 'portrait',
    icons: [
      {
        "src": "/web-app-manifest-192x192.png",
        "sizes": "192x192",
        "type": "image/png",
        "purpose": "maskable"
      },
      {
        "src": "/web-app-manifest-512x512.png",
        "sizes": "512x512",
        "type": "image/png",
        "purpose": "maskable"
      },
      {
        src: '/icons/apple-icon.png',
        sizes: '180x180',
        type: 'image/png',
        purpose: 'maskable', // Important per a Android modern
      },
    ],
  };
}

// =================== FILE: src/app/robots.ts ===================

import { MetadataRoute } from 'next';

export default function robots(): MetadataRoute.Robots {
  return {
    rules: {
      userAgent: '*',
      allow: '/',
      disallow: ['/admin/', '/dashboard/'], // ğŸ›¡ï¸ Protegim les zones privades
    },
    sitemap: 'https://digitaistudios.com/sitemap.xml', // URL final
  };
}

// =================== FILE: src/app/sitemap.ts ===================

import { MetadataRoute } from 'next';
import { postService } from '@/services/container';

// âš ï¸ IMPORTNAT: Canvia aixÃ² pel teu domini real quan despleguis
const BASE_URL = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const posts = await postService.getLatestPosts();
  const locales = ['es', 'ca', 'en']; // Els teus idiomes

  // 1. PÃ gines estÃ tiques (Home, Blog) per a cada idioma
  const staticPages = locales.flatMap((locale) => [
    {
      url: `${BASE_URL}/${locale}`,
      lastModified: new Date(),
      changeFrequency: 'weekly' as const,
      priority: 1,
    },
    {
      url: `${BASE_URL}/${locale}/blog`,
      lastModified: new Date(),
      changeFrequency: 'daily' as const,
      priority: 0.8,
    },
  ]);

  // 2. Entrades del Blog per a cada idioma
  const postEntries = posts.flatMap((post) => 
    locales.map((locale) => ({
      url: `${BASE_URL}/${locale}/blog/${post.slug}`,
      lastModified: post.date ? new Date(post.date) : new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.7,
    }))
  );

  return [...staticPages, ...postEntries];
}

// =================== FILE: src/app/[locale]/(marketing)/blog/page.tsx ===================

import { Link } from '@/routing';
import { postService } from '@/services/container';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { getTranslations, getLocale } from 'next-intl/server';
import { Calendar, Tag, ImageIcon } from 'lucide-react';
import Image from 'next/image'; // ğŸ‘ˆ IMPORT IMPORTANT

// ISR: Refresca el llistat cada hora
export const revalidate = 3600;

export default async function BlogIndexPage() {
  const t = await getTranslations('BlogIndex');
  const locale = await getLocale();

  const posts = await postService.getLatestPosts();

  return (
    <div className="container mx-auto py-16 px-4">
      {/* CAPÃ‡ALERA */}
      <div className="text-center mb-16 space-y-4">
        <h1 className="text-4xl md:text-5xl font-extrabold tracking-tight text-foreground">
          {t('title')}
        </h1>
        <p className="text-muted-foreground text-lg md:text-xl max-w-2xl mx-auto leading-relaxed">
          {t('subtitle')}
        </p>
      </div>

      {/* GRID DE POSTS */}
      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {posts.map((post) => (
          <Link key={post.slug} href={`/blog/${post.slug}`} className="block group h-full">
            <Card className="h-full flex flex-col overflow-hidden border border-border bg-card dark:bg-[#0f111a] hover:border-primary/50 transition-all duration-300 shadow-sm hover:shadow-2xl hover:-translate-y-1">
              
              {/* ZONA IMATGE (CORREGIT AMB NEXT/IMAGE) */}
              <div className="relative h-56 w-full bg-muted dark:bg-slate-800 overflow-hidden">
                {post.coverImage ? (
                  <Image
                    src={post.coverImage}
                    alt={post.title}
                    fill // Ocupa tot el contenidor pare (h-56)
                    className="object-cover transition-transform duration-700 group-hover:scale-105"
                    sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                  />
                ) : (
                  // Fallback si no hi ha imatge
                  <div className="flex flex-col items-center justify-center h-full text-muted-foreground/50">
                    <ImageIcon className="w-10 h-10 mb-2 opacity-50" />
                    <span className="text-xs font-medium uppercase tracking-widest">{t('fallback_image')}</span>
                  </div>
                )}
                
                {/* Overlay fosc suau al fer hover per destacar el text */}
                <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300 pointer-events-none" />
              </div>

              <CardHeader className="pb-2 pt-6">
                {/* TAG & DATA */}
                <div className="flex justify-between items-center mb-3">
                    <div className="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full bg-primary/10 text-primary text-[10px] font-bold uppercase tracking-wider">
                        <Tag className="w-3 h-3" />
                        {post.tags[0] ?? 'TECH'}
                    </div>
                    {post.date && (
                        <div className="flex items-center gap-1.5 text-xs text-muted-foreground font-medium">
                            <Calendar className="w-3 h-3" />
                            {new Intl.DateTimeFormat(locale, { dateStyle: 'medium' }).format(new Date(post.date))}
                        </div>
                    )}
                </div>

                <CardTitle className="text-xl font-bold text-foreground group-hover:text-primary transition-colors line-clamp-2 leading-tight">
                  {post.title}
                </CardTitle>
              </CardHeader>
              
              <CardContent className="flex-1 flex flex-col justify-between">
                <p className="text-muted-foreground text-sm leading-relaxed line-clamp-3 mb-6">
                  {post.description}
                </p>
                
                {/* Link "Llegir mÃ©s" animat */}
                <div className="text-sm font-bold text-primary flex items-center gap-2 opacity-80 group-hover:opacity-100 transition-all group-hover:gap-3">
                    Llegir article <span className="text-lg leading-none">&rarr;</span>
                </div>
              </CardContent>
            </Card>
          </Link>
        ))}

        {posts.length === 0 && (
          <div className="col-span-full py-24 text-center bg-muted/20 rounded-3xl border border-dashed border-border flex flex-col items-center justify-center">
            <div className="w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4">
                <Tag className="w-8 h-8 text-muted-foreground" />
            </div>
            <h3 className="text-lg font-bold text-foreground mb-1">{t('no_posts')}</h3>
            <p className="text-muted-foreground text-sm">Torna mÃ©s tard per veure novetats.</p>
          </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/blog/[slug]/page.tsx ===================

import { notFound } from 'next/navigation';
import { postService } from '@/services/container';
import { MDXContent } from '@/features/blog/ui/MDXContent';
import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Calendar, User } from 'lucide-react';
import { Metadata } from 'next';
import { getTranslations, getLocale } from 'next-intl/server'; // ğŸ‘ˆ

type Props = {
  params: Promise<{ slug: string; locale: string }>;
};

export const revalidate = 3600;

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  // Necessitem el slug per buscar el post, perÃ² no tenim accÃ©s a 't' aquÃ­ fÃ cilment
  // pel tÃ­tol, aixÃ­ que usem les dades del post directament.
  const { slug } = await params;
  const post = await postService.getPost(slug);

  if (!post) {
    return { title: '404 - Article no trobat' };
  }

  return {
    title: post.title,
    description: post.description,
    openGraph: {
      title: post.title,
      description: post.description || '',
      type: 'article',
      publishedTime: post.date || undefined,
      tags: post.tags,
      images: post.coverImage ? [{ url: post.coverImage }] : undefined,
    },
    twitter: {
      card: 'summary_large_image',
      title: post.title,
      description: post.description || '',
      images: post.coverImage ? [post.coverImage] : [],
    },
  };
}

export default async function BlogPostPage({ params }: Props) {
  const { slug } = await params;
  const post = await postService.getPost(slug);
  
  // Hooks de traducciÃ³
  const t = await getTranslations('BlogPost');
  const locale = await getLocale();

  if (!post) notFound();

  return (
    <div className="min-h-screen bg-background pb-20">

      {/* 1. HERO SECTION */}
      <div className="relative w-full flex items-end justify-center overflow-hidden min-h-[60vh] lg:min-h-[70vh] bg-slate-950">

        {/* Fons */}
        <div className="absolute inset-0 bg-slate-900">
          {post.coverImage ? (
            <div
              className="absolute inset-0 bg-cover bg-center opacity-50"
              style={{ backgroundImage: `url(${post.coverImage})` }}
            />
          ) : (
            <div className="absolute inset-0 bg-linear-to-br from-blue-900 via-indigo-900 to-slate-900 opacity-80" />
          )}
          <div className="absolute inset-0 bg-linear-to-t from-background via-background/60 to-transparent" />
        </div>

        {/* Contingut Hero */}
        <div className="relative z-10 container px-4 text-center max-w-4xl mx-auto pb-24 pt-32">

          <h1 className="text-3xl md:text-5xl lg:text-7xl font-extrabold tracking-tight text-foreground mb-6 leading-tight drop-shadow-xl animate-in fade-in slide-in-from-bottom-6 duration-1000">
            {post.title}
          </h1>

          <div className="flex flex-wrap justify-center items-center gap-4 md:gap-8 text-muted-foreground font-medium text-sm md:text-base animate-in fade-in slide-in-from-bottom-8 duration-1000 delay-100">
            {/* Tags */}
            <div className="flex flex-wrap justify-center gap-2 mb-6 w-full animate-in fade-in slide-in-from-bottom-4 duration-700">
              {post.tags.map(tag => (
                <span key={tag} className="px-3 py-1 rounded-full bg-foreground/10 text-foreground backdrop-blur-md border border-primary/30 text-[10px] md:text-xs font-bold uppercase tracking-wider">
                  {tag}
                </span>
              ))}
            </div>
            
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 rounded-full bg-muted flex items-center justify-center border border-border">
                <User className="w-4 h-4" />
              </div>
              <span>{t('by_author')}</span>
            </div>

            <div className="flex items-center gap-2">
              <Calendar className="w-4 h-4 opacity-70" />
              <span>
                {post.date 
                  ? new Intl.DateTimeFormat(locale, { dateStyle: 'long' }).format(new Date(post.date))
                  : 'Avui'
                }
              </span>
            </div>
          </div>
        </div>
      </div>

      {/* 2. CONTINGUT */}
      <div className="container px-4 -mt-12 relative z-20 max-w-4xl mx-auto">
        <div className="bg-card text-card-foreground rounded-3xl p-6 md:p-12 lg:p-16 shadow-2xl ring-1 ring-border/50">

          <p className="text-xl md:text-2xl lg:text-3xl font-serif text-muted-foreground leading-relaxed mb-8 md:mb-12 border-b border-border pb-8">
            {post.description}
          </p>

          <div className="prose prose-lg dark:prose-invert max-w-none prose-headings:font-bold prose-headings:tracking-tight prose-a:text-primary prose-img:rounded-xl prose-img:shadow-lg">
            <MDXContent source={post.content || ''} />
          </div>

          {/* Footer Card */}
          <div className="mt-16 p-6 md:p-10 rounded-2xl bg-muted/30 border border-border text-center">
            <h3 className="text-xl md:text-2xl font-bold mb-4">{t('share_title')}</h3>
            <p className="text-muted-foreground mb-6 max-w-md mx-auto text-sm md:text-base">
                {t('share_subtitle')}
            </p>

            <div className="flex flex-col sm:flex-row justify-center gap-4">
              <Link href="/blog">
                <Button variant="outline" className="w-full sm:w-auto">
                  <ArrowLeft className="mr-2 h-4 w-4" /> {t('back_button')}
                </Button>
              </Link>
              <Link href="/">
                <Button className="w-full sm:w-auto gradient-bg text-white border-0 shadow-lg hover:opacity-90">
                  {t('cta_audit')}
                </Button>
              </Link>
            </div>
          </div>

        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/layout.tsx ===================

import { Navbar } from '@/components/layout/Navbar';
import { Footer } from '@/components/layout/Footer';
import { createClient } from '@/lib/supabase/server';

export default async function MarketingLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // 1. Obtenim la sessiÃ³ al Layout (es comparteix per a totes les rutes marketing)
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  return (
    <div className="flex min-h-screen flex-col bg-background selection:bg-primary/30">
      {/* 2. Passem l'usuari al Navbar */}
      <Navbar user={user} />
      
      <main className="flex-1">
        {children}
      </main>

      <Footer />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/legal/avis-legal/page.tsx ===================

import LegalLayout from '@/components/layout/LegalLayout';
import { Building2, Mail, MapPin, Fingerprint, AlertTriangle, Gavel } from 'lucide-react';
import { getTranslations } from 'next-intl/server';
import { getLocale } from 'next-intl/server'; // Per la data

export const metadata = {
  title: 'AvÃ­s Legal | DigitAI Studios',
  description: 'InformaciÃ³ legal i condicions d\'Ãºs de DigitAI Studios.',
};

export default async function AvisLegalPage() {
  const t = await getTranslations('Legal.avis_legal');
  const tCommon = await getTranslations('Legal.common');
  const locale = await getLocale();

  return (
    <LegalLayout>
      <div className="border-b border-border pb-8 mb-8">
        <h1 className="text-3xl md:text-4xl font-extrabold mb-4">{t('title')}</h1>
        <p className="text-xl text-muted-foreground leading-relaxed">
          {tCommon('transparency_desc')}
        </p>
        <p className="text-sm text-muted-foreground mt-4">{t('last_update_prefix')} {new Date().toLocaleDateString(locale)}</p>
      </div>

      {/* SECCIÃ“ 1: DADES IDENTIFICATIVES (GRID VISUAL) */}
      <section className="mb-12">
        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
            {t('section1_title')}
        </h2>
        <p className="mb-6">
           {t('section1_desc')}
        </p>
        
        <div className="grid sm:grid-cols-2 gap-4 not-prose">
           <InfoCard 
              icon={Building2} 
              label={t('data_card_company_label')} 
              value="[EL TEU NOM EMPRESA]" 
           />
           <InfoCard 
              icon={Fingerprint} 
              label={t('data_card_nif_label')} 
              value="[EL TEU NIF]" 
           />
           <InfoCard 
              icon={MapPin} 
              label={t('data_card_address_label')} 
              value={t('data_card_address_value')} 
           />
           <InfoCard 
              icon={Mail} 
              label={t('data_card_contact_label')} 
              value="info@digitaistudios.com" 
           />
        </div>
      </section>

      {/* SECCIÃ“ 2: OBJECTE */}
      <section className="mb-12">
        <h2>{t('section2_title')}</h2>
        <p>
          {t.rich('section2_p1', {
            strong: (chunks) => <strong>{chunks}</strong>
          })}
        </p>
        <p>
          {t('section2_p2')}
        </p>
      </section>

      {/* SECCIÃ“ 3: PROPIETAT INTELÂ·LECTUAL */}
      <section className="mb-12">
        <h2>{t('section3_title')}</h2>
        <div className="bg-muted/30 p-6 rounded-xl border-l-4 border-primary not-prose">
            <p className="text-sm text-muted-foreground">
                {t.rich('section3_quote', {
                  strong: (chunks) => <strong>{chunks}</strong>
                })}
            </p>
        </div>
      </section>

      {/* SECCIÃ“ 4: RESPONSABILITAT */}
      <section className="mb-12">
         <h2 className="flex items-center gap-2">
            <AlertTriangle className="w-6 h-6 text-yellow-500" /> {t('section4_title')}
         </h2>
         <p>{t('section4_p1')}</p>
         <ul>
            <li>{t('section4_list_1')}</li>
            <li>{t('section4_list_2')}</li>
            <li>{t('section4_list_3')}</li>
         </ul>
      </section>

      {/* SECCIÃ“ 5: LLEI */}
      <section>
         <h2 className="flex items-center gap-2">
            <Gavel className="w-6 h-6 text-primary" /> {t('section5_title')}
         </h2>
         <p>
            {t('section5_p1')}
         </p>
      </section>

    </LegalLayout>
  );
}

// Nota: El component InfoCard es mantÃ© igual, ja que les dades que rep (label, value) ja venen traduÃ¯des d'aquÃ­.

// Component petit per a les targetes de dades
import { LucideIcon } from 'lucide-react';

interface InfoCardProps {
    icon: LucideIcon;
    label: string;
    value: string;
}

function InfoCard({ icon: Icon, label, value }: InfoCardProps) {
    return (
        <div className="bg-background border border-border p-4 rounded-lg flex items-start gap-4 shadow-sm hover:border-primary/30 transition-colors">
            <div className="p-2 bg-primary/10 rounded-md shrink-0">
                <Icon className="w-5 h-5 text-primary" />
            </div>
            <div>
                <p className="text-xs text-muted-foreground font-medium uppercase tracking-wider">{label}</p>
                <p className="text-sm font-bold text-foreground mt-1">{value}</p>
            </div>
        </div>
    )
}

// =================== FILE: src/app/[locale]/(marketing)/legal/cookies/page.tsx ===================

import LegalLayout from '@/components/layout/LegalLayout';
import { Cookie, Settings, BarChart3, XCircle } from 'lucide-react';
import { getTranslations } from 'next-intl/server';
import { Link } from '@/routing'; // Necessari per Link

export const metadata = {
  title: 'PolÃ­tica de Cookies | DigitAI Studios',
  description: 'InformaciÃ³ sobre l\'Ãºs de cookies a DigitAI Studios.',
};

export default async function CookiesPage() {
  const t = await getTranslations('Legal.cookies');

  return (
    <LegalLayout>
      <div className="border-b border-border pb-8 mb-8">
        <h1 className="text-3xl md:text-4xl font-extrabold mb-4">{t('title')}</h1>
        <p className="text-xl text-muted-foreground leading-relaxed">
          {t('subtitle')}
        </p>
      </div>

      <div className="space-y-12">

        {/* BLOC 1: DEFINICIÃ“ */}
        <section>
          <h2 className="text-2xl font-bold flex items-center gap-2 mb-4">
            <Cookie className="text-orange-500" /> {t('section1_title')}
          </h2>
          <div className="bg-muted/30 p-6 rounded-xl border border-border">
            <p className="m-0">
              {t('section1_quote')}
            </p>
          </div>
        </section>

        {/* BLOC 2: TIPUS DE COOKIES (GRID) */}
        <section>
          <h2>{t('section2_title')}</h2>
          <p>{t('section2_p1')}</p>
          
          <div className="grid md:grid-cols-2 gap-6 not-prose my-6">
             {/* Cookies TÃ¨cniques */}
             <div className="p-5 rounded-xl border border-border bg-card shadow-sm">
                <div className="flex items-center gap-3 mb-3">
                   <div className="p-2 bg-primary/10 rounded-lg text-primary">
                      <Settings className="w-5 h-5" />
                   </div>
                   <h4 className="font-bold text-lg">{t('tech_title')}</h4>
                </div>
                <p className="text-sm text-muted-foreground mb-4">
                   {t('tech_desc')}
                </p>
                <ul className="space-y-2 text-sm">
                   <li className="flex items-center gap-2">
                      <span className="w-1.5 h-1.5 bg-primary rounded-full"></span>
                      <strong>{t.rich('tech_1', { strong: (chunks) => <strong>{chunks}</strong> })}</strong>
                   </li>
                   <li className="flex items-center gap-2">
                      <span className="w-1.5 h-1.5 bg-primary rounded-full"></span>
                      <strong>{t.rich('tech_2', { strong: (chunks) => <strong>{chunks}</strong> })}</strong>
                   </li>
                </ul>
             </div>

             {/* Cookies AnalÃ­tiques */}
             <div className="p-5 rounded-xl border border-border bg-card shadow-sm">
                <div className="flex items-center gap-3 mb-3">
                   <div className="p-2 bg-blue-500/10 rounded-lg text-blue-500">
                      <BarChart3 className="w-5 h-5" />
                   </div>
                   <h4 className="font-bold text-lg">{t('analytics_title')}</h4>
                </div>
                <p className="text-sm text-muted-foreground mb-4">
                   {t('analytics_desc')}
                </p>
                <ul className="space-y-2 text-sm">
                   <li className="flex items-center gap-2">
                      <span className="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>
                      <strong>{t.rich('analytics_1', { strong: (chunks) => <strong>{chunks}</strong> })}</strong>
                   </li>
                </ul>
             </div>
          </div>
        </section>

        {/* BLOC 3: DESACTIVACIÃ“ */}
        <section>
           <h2 className="flex items-center gap-2">
              <XCircle className="text-red-500" /> {t('section3_title')}
           </h2>
           <p>
             {t('section3_p1')}
           </p>
           
           <div className="flex flex-wrap gap-4 not-prose mt-4">
              <a href="https://support.google.com/chrome/answer/95647" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Google Chrome
              </a>
              <a href="https://support.apple.com/es-es/guide/safari/sfri11471/mac" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Safari
              </a>
              <a href="https://support.mozilla.org/es/kb/habilitar-y-deshabilitar-cookies-sitios-web-rastrear-preferencias" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Firefox
              </a>
              <a href="https://support.microsoft.com/es-es/microsoft-edge/eliminar-las-cookies-en-microsoft-edge-63947406-40ac-c23d-37fd-6b7ac978ce4a" target="_blank" rel="noopener" className="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:border-primary transition-colors">
                 Microsoft Edge
              </a>
           </div>
        </section>

      </div>
    </LegalLayout>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/legal/privacitat/page.tsx ===================

import LegalLayout from '@/components/layout/LegalLayout';
import { ShieldCheck, Server, Lock } from 'lucide-react';
import { getTranslations } from 'next-intl/server';
import { Link } from '@/routing'; // Assegurem l'import de Link

export const metadata = {
  title: 'PolÃ­tica de Privacitat | DigitAI Studios',
};

export default async function PrivacitatPage() {
  const t = await getTranslations('Legal.privacitat');
  const tLegal = await getTranslations('Legal.avis_legal'); // Per l'AvÃ­s Legal

  return (
    <LegalLayout>
      <div className="border-b border-border pb-8 mb-8">
        <h1 className="text-3xl md:text-4xl font-extrabold mb-4">{t('title')}</h1>
        <p className="text-xl text-muted-foreground leading-relaxed">
          {t('subtitle')}
        </p>
      </div>

      <div className="space-y-12">
          
          {/* BLOC 1: RESPONSABLE */}
          <section>
              <h2 className="text-2xl font-bold flex items-center gap-2 mb-4">
                  <ShieldCheck className="text-green-500" /> {t('section1_title')}
              </h2>
              <div className="bg-muted/30 p-6 rounded-xl border border-border">
                  <p className="m-0">
                      {t.rich('section1_text', {
                          strong: (chunks) => <strong>{chunks}</strong>,
                          link: (chunks) => <a href="mailto:dpd@digitaistudios.com">{chunks}</a>
                      })}
                  </p>
              </div>
          </section>

          {/* BLOC 2: QUINES DADES */}
          <section>
              <h2>{t('section2_title')}</h2>
              <p>{t('section2_desc')}</p>
              <div className="grid md:grid-cols-2 gap-6 not-prose my-6">
                  <div className="p-4 rounded-lg border border-border bg-card">
                      <h4 className="font-bold text-lg mb-2 flex items-center gap-2">ğŸ” {t('data_audit_title')}</h4>
                      <p className="text-sm text-muted-foreground">{t('data_audit_desc')}</p>
                  </div>
                  <div className="p-4 rounded-lg border border-border bg-card">
                      <h4 className="font-bold text-lg mb-2 flex items-center gap-2">ğŸ‘¤ {t('data_account_title')}</h4>
                      <p className="text-sm text-muted-foreground">{t('data_account_desc')}</p>
                  </div>
              </div>
          </section>

          {/* BLOC 3: TERCERS */}
          <section>
              <h2 className="flex items-center gap-2"><Server className="text-blue-500" /> {t('section3_title')}</h2>
              <p>{t('section3_desc')}</p>
              <ul className="not-prose space-y-2 mt-4">
                  <li className="flex items-center gap-3 p-2 rounded hover:bg-muted/50">
                      <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                      <span><strong>{t('provider_supabase')}</strong></span>
                  </li>
                  <li className="flex items-center gap-3 p-2 rounded hover:bg-muted/50">
                      <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                      <span><strong>{t('provider_resend')}</strong></span>
                  </li>
                  <li className="flex items-center gap-3 p-2 rounded hover:bg-muted/50">
                      <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                      <span><strong>{t('provider_google')}</strong></span>
                  </li>
              </ul>
          </section>

          {/* BLOC 4: DRETS */}
          <section>
              <h2 className="flex items-center gap-2"><Lock className="text-primary" /> {t('section4_title')}</h2>
              <p>{t('section4_p1')}</p>
              <ul>
                  <li>{t('rights_list_1')}</li>
                  <li>{t('rights_list_2')}</li>
                  <li>{t('rights_list_3')}</li>
                  <li>{t('rights_list_4')}</li>
              </ul>
              <p>{t.rich('rights_contact', { strong: (chunks) => <strong>{chunks}</strong> })}</p>
          </section>

      </div>
    </LegalLayout>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/page.tsx ===================

import { HeroSection } from '@/components/landing/HeroSection';
import { TechStackSection } from '@/components/landing/TechStackSection';
import { ProblemSolutionSection } from '@/components/landing/ProblemSolutionsSection';
import { ServicesGrid } from '@/components/landing/ServicesGrid';
import { ProductTeaser } from '@/components/landing/ProductTeaser';
import { AuditSection } from '@/components/landing/AuditSection';
import { TestimonialsSection } from '@/components/landing/TestimonialsSection';
import { ContactSection } from '@/components/landing/ContactSection';

// Importem les dades des del fitxer net
import { TESTIMONIALS } from '@/lib/data';

// ConfiguraciÃ³ de Vercel (si la necessites)
export const maxDuration = 60; 

export default function MarketingPage() {
  return (
    <>
      <HeroSection />
      <TechStackSection />
      <ProblemSolutionSection />
      <ServicesGrid />
      <ProductTeaser />
      <AuditSection />
      
      {/* Passem les dades netes */}
      <TestimonialsSection testimonials={TESTIMONIALS} />
      
      <ContactSection />
    </>
  );
}

// =================== FILE: src/app/[locale]/(marketing)/projectes/page.tsx ===================

// ARA (Import net des de la feature):
import { ProjectsHero, ProjectsList, ProjectsCTA } from '@/features/projects';

export default function ProjectsPage() {
  return (
    <main className="min-h-screen flex flex-col bg-background selection:bg-primary/30 transition-colors duration-300">
      <ProjectsHero />
      <ProjectsList />
      <ProjectsCTA />
    </main>
  );
}

// =================== FILE: src/app/[locale]/admin/analytics/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { analyticsRepository } from '@/services/container';
import { TrafficChart } from '@/features/analytics/ui/TrafficChart';
import { TopPagesCard } from '@/features/analytics/ui/TopPagesCard';
import { DeviceChart } from '@/features/analytics/ui/DeviceChart';
import { BarListChart } from '@/features/analytics/ui/BarListChart';
import { VerticalBarChart } from '@/features/analytics/ui/VerticalBarChart';
import { UnifiedStatBar } from '@/features/analytics/ui/UnifiedStatBar';


export const revalidate = 60;

export default async function AdminAnalyticsPage() {
  await requireAdmin();

  const [dailyStats, adv] = await Promise.all([
    analyticsRepository.getLast7DaysStats(),
    analyticsRepository.getAdvancedStats()
  ]);

  const totalViews = dailyStats.reduce((acc, day) => acc + day.views, 0);
  const totalVisitors = dailyStats.reduce((acc, day) => acc + day.visitors, 0);

  return (
    // CANVI CLAU:
    // MÃ²bil: h-auto (alÃ§ada automÃ tica) + overflow-y-auto (scroll vertical)
    // Escriptori (lg): h-[calc(100vh-2rem)] (alÃ§ada fixa) + overflow-hidden (sense scroll global)
    <div className="flex flex-col gap-4 pb-4 h-auto overflow-y-auto lg:h-[calc(100vh-2rem)] lg:overflow-hidden">
      
      {/* 1. BARRA D'ESTAT UNIFICADA */}
      <div className="shrink-0">
         <UnifiedStatBar 
            views={totalViews} 
            visitors={totalVisitors} 
            events={totalViews} 
            avgTime="~45s" 
         />
      </div>

      {/* 2. GRAELLA PRINCIPAL */}
      {/* MÃ²bil: flex-col (un sota l'altre). Escriptori: grid (graella original) */}
      <div className="flex-1 flex flex-col lg:grid lg:grid-cols-3 gap-4 min-h-0">
         
         {/* --- COLUMNA ESQUERRA --- */}
         <div className="lg:col-span-2 flex flex-col gap-4 lg:h-full lg:min-h-0">
            
            {/* A. TrÃ nsit */}
            {/* MÃ²bil: AlÃ§ada fixa 300px. Escriptori: 50% de l'espai */}
            <div className="h-[300px] lg:h-1/2 lg:min-h-0">
                <TrafficChart data={dailyStats} />
            </div>

            {/* B. Detalls Importants */}
            {/* MÃ²bil: flex-col (stack). Escriptori: grid-cols-2 */}
            <div className="flex flex-col lg:grid lg:grid-cols-2 gap-4 lg:h-1/2 lg:min-h-0">
                <div className="h-[300px] lg:h-full lg:min-h-0">
                    <TopPagesCard data={adv.topPages} />
                </div>
                <div className="h-[300px] lg:h-full lg:min-h-0">
                    <BarListChart title="Fonts de TrÃ nsit" data={adv.referrers} />
                </div>
            </div>
         </div>

         {/* --- COLUMNA DRETA --- */}
         <div className="lg:col-span-1 flex flex-col gap-4 lg:h-full lg:min-h-0">
            
            {/* C. Dispositius */}
            <div className="h-[300px] lg:flex-1 lg:min-h-0">
               <DeviceChart data={adv.devices} />
            </div>

            {/* D. PaÃ¯sos */}
            <div className="h-[300px] lg:flex-1 lg:min-h-0">
               <VerticalBarChart title="Top PaÃ¯sos" data={adv.countries} />
            </div>

            {/* E. Navegadors */}
            <div className="h-[300px] lg:flex-1 lg:min-h-0">
               <BarListChart title="Navegadors" data={adv.browsers} />
            </div>
         </div>

      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/blog/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { postRepository } from '@/services/container';
import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { Plus, FileText, Eye, Pencil } from 'lucide-react';

export default async function AdminBlogPage() {
  await requireAdmin();
  const posts = await postRepository.getAllPosts();

  return (
    // 1. SAFEGUARD: overflow-x-hidden al contenidor principal per evitar scroll horitzontal global
    <div className="w-full max-w-[100vw] overflow-x-hidden p-3 sm:p-6 md:p-8">
      
      <div className="max-w-6xl mx-auto w-full">
        {/* CAPÃ‡ALERA */}
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <div className="w-full sm:w-auto">
            <h1 className="text-2xl md:text-3xl font-bold text-white break-words">GestiÃ³ del Blog</h1>
            <p className="text-slate-400 text-sm">
              Total: <span className="text-white font-medium">{posts.length}</span> articles.
            </p>
          </div>
          
          <Link href="/admin/blog/new" className="w-full sm:w-auto">
              <Button className="gradient-bg text-white border-0 w-full">
                  <Plus className="w-4 h-4 mr-2" /> Nou Article
              </Button>
          </Link>
        </div>

        {/* LLISTAT */}
        <div className="flex flex-col gap-3">
          {posts.map((post) => (
            // 2. TARGETA: w-full i max-w-full sÃ³n crÃ­tics aquÃ­
            <div 
              key={post.slug} 
              className="w-full max-w-full flex flex-col md:flex-row md:items-center justify-between p-4 bg-slate-900/50 border border-slate-800 rounded-xl gap-4"
            >
              
              {/* ZONA INFO: min-w-0 Ã©s la mÃ gia que evita el desbordament en Flexbox */}
              <div className="flex items-start gap-3 min-w-0 w-full">
                  {/* Icona */}
                  <div className="shrink-0 p-2 bg-slate-800 rounded-lg text-blue-400">
                      <FileText className="w-5 h-5" />
                  </div>

                  {/* Text: overflow-hidden necessari pel truncate */}
                  <div className="flex-1 min-w-0 overflow-hidden">
                      {/* TÃ­tol: truncate talla el text amb punts suspensius (...) */}
                      <h3 className="font-semibold text-slate-200 text-base truncate block w-full">
                          {post.title}
                      </h3>
                      
                      {/* Metadades */}
                      <div className="flex flex-wrap items-center gap-2 text-xs text-slate-500 mt-1">
                          <span className={`px-2 py-0.5 rounded-full font-bold shrink-0 ${
                              post.published 
                                  ? 'bg-green-500/10 text-green-400' 
                                  : 'bg-yellow-500/10 text-yellow-400'
                          }`}>
                              {post.published ? 'PUB' : 'DRAFT'}
                          </span>
                          <span className="truncate">
                            {new Date(post.date || new Date()).toLocaleDateString()}
                          </span>
                      </div>
                  </div>
              </div>
              
              {/* ZONA ACCIONS: Grid en mÃ²bil per assegurar que els botons ocupen l'ample correcte */}
              <div className="grid grid-cols-[1fr,auto] gap-2 w-full md:w-auto md:flex border-t border-slate-800 pt-3 md:border-0 md:pt-0">
                  <Link href={`/admin/blog/${post.slug}`} className="w-full md:w-auto">
                      <Button variant="secondary" size="sm" className="w-full bg-slate-800 text-slate-300 hover:text-white">
                          <Pencil className="w-3.5 h-3.5 mr-2" /> Editar
                      </Button>
                  </Link>
                  
                  {post.published && (
                      <Link href={`/blog/${post.slug}`} target="_blank">
                          <Button variant="ghost" size="icon" className="text-slate-500 hover:text-blue-400">
                              <Eye className="w-4 h-4" />
                          </Button>
                      </Link>
                  )}
              </div>

            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/blog/[slug]/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { postRepository } from '@/services/container';
import { notFound } from 'next/navigation';
import { MDXContent } from '@/features/blog/ui/MDXContent';
import { Link } from '@/routing';
import { ArrowLeft, Save, Trash2,ExternalLink  } from 'lucide-react';
import { Button } from '@/components/ui/button';
import Image from 'next/image';
import { PostStatusToggle } from '@/features/blog/ui/PostStatusToggle';


type Props = {
    params: Promise<{ slug: string }>;
};

export default async function AdminPostDetailPage({ params }: Props) {
    await requireAdmin();
    const { slug } = await params;

    // âš ï¸ USEM EL NOU MÃˆTODE QUE INCLOU ESBORRANYS
    const post = await postRepository.getAdminPostBySlug(slug);

    if (!post) {
        return notFound();
    }

    return (
        <div className="p-4 md:p-8 max-w-5xl mx-auto text-slate-200">

            {/* CORRECCIÃ“ HEADER: Eliminat 'sticky top-0' i afegit padding/marges nets */}
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 border-b border-slate-800 pb-6">
                <div className="flex items-center gap-4">
                    <Link href="/admin/blog" className="text-slate-500 hover:text-white transition-colors p-2 hover:bg-slate-800 rounded-lg">
                        <ArrowLeft className="w-6 h-6" />
                    </Link>
                    <div className="min-w-0"> {/* min-w-0 ajuda a truncar text en flex */}
                        <h1 className="text-xl md:text-2xl font-bold truncate">{post.title}</h1>
                        <div className="flex items-center gap-2 mt-1">
                            <span className={`text-xs font-mono px-2 py-0.5 rounded ${post.published ? 'bg-green-900 text-green-300' : 'bg-yellow-900 text-yellow-300'}`}>
                                {post.published ? 'PUBLICAT' : 'ESBORRANY'}
                            </span>
                            <span className="text-xs text-slate-500 hidden md:inline-block">/ {post.slug}</span>
                        </div>
                    </div>
                </div>

                {/* Dins del HEADER, a la secciÃ³ de botons a la dreta */}
                <div className="flex flex-wrap gap-2 w-full md:w-auto mt-4 md:mt-0">
                    {/* BotÃ³ Esborrar (existent) */}
                    <Button variant="destructive" size="sm">
                        <Trash2 className="w-4 h-4 md:mr-2" /> <span className="hidden md:inline">Eliminar</span>
                    </Button>

                    {/* EnllaÃ§ veure (existent) */}
                    <Link href={`/blog/${post.slug}`} target="_blank">
                        <Button variant="outline" size="sm" className="border-slate-700">
                            <ExternalLink className="w-4 h-4 md:mr-2" /> <span className="hidden md:inline">Veure Web</span>
                        </Button>
                    </Link>

                    {/* ğŸ‘‡ NOU BOTÃ“ PUBLICAR/DESPUBLICAR */}
                    {/* Nota: el postRepository ha de retornar l'ID del post, assegura't que el DTO el tÃ©. 
                Si no el tens al DTO, afegeix-lo al SupabasePostRepository.ts mapToDTO */}
                    <PostStatusToggle postId={post.id || ''} isPublished={post.published} />

                    <Button className="bg-blue-600 hover:bg-blue-700 text-white">
                        <Save className="w-4 h-4 md:mr-2" /> <span className="hidden md:inline">Guardar</span>
                    </Button>
                </div>
            </div>

            {/* CONTINGUT PREVIEW */}
            <div className="grid lg:grid-cols-3 gap-8">

                {/* COLUMNA PRINCIPAL (PREVIEW MDX) */}
                <div className="lg:col-span-2 space-y-6">
                    <div className="aspect-video relative rounded-xl overflow-hidden bg-slate-800 border border-slate-700">
                        {post.coverImage ? (
                            <Image
                                src={post.coverImage}
                                alt="Cover"
                                fill
                                sizes="100vw"
                                className="object-cover"
                            />
                        ) : (
                            <div className="flex items-center justify-center h-full text-slate-600">Sense Imatge</div>
                        )}
                    </div>

                    <div className="prose prose-invert max-w-none p-6 bg-slate-900 rounded-xl border border-slate-800">
                        <MDXContent source={post.content || ''} />
                    </div>
                </div>

                {/* SIDEBAR METADADES */}
                <div className="space-y-6">
                    <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 space-y-4">
                        <h3 className="font-bold text-slate-400 uppercase text-xs tracking-wider">Detalls SEO</h3>

                        <div>
                            <label className="text-xs text-slate-500 block mb-1">Slug</label>
                            <code className="text-sm bg-black p-2 rounded block w-full text-blue-300 overflow-hidden">{post.slug}</code>
                        </div>

                        <div>
                            <label className="text-xs text-slate-500 block mb-1">DescripciÃ³</label>
                            <p className="text-sm text-slate-300 leading-relaxed">{post.description}</p>
                        </div>

                        <div>
                            <label className="text-xs text-slate-500 block mb-1">Tags</label>
                            <div className="flex flex-wrap gap-2">
                                {post.tags.map(tag => (
                                    <span key={tag} className="text-xs bg-slate-800 px-2 py-1 rounded border border-slate-700">{tag}</span>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/admin/debug/page.tsx ===================

'use client';

import { useState, useEffect } from 'react';
import { createClient } from '@/lib/supabase/client';

// Definim una interfÃ­cie simple per al resultat que esperem de Supabase
interface SupabaseCountResult {
  count: number | null;
  error: {
    message: string;
    code?: string;
  } | null;
}

export default function DebugAnalyticsPage() {
  const [logs, setLogs] = useState<string[]>([]);
  const [envStatus] = useState({
    url: !!process.env.NEXT_PUBLIC_SUPABASE_URL,
    key: !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
  });

  // 1. Comprovem variables nomÃ©s carregar
  // Eliminat useEffect perquÃ¨ la inicialitzaciÃ³ es fa directament a useState

  const addLog = (msg: string) => setLogs(prev => [...prev, `${new Date().toLocaleTimeString()} > ${msg}`]);

  const testConnection = async () => {
    addLog('ğŸš€ INICIANT TEST...');
    
    // ValidaciÃ³ prÃ¨via
    if (!process.env.NEXT_PUBLIC_SUPABASE_URL) {
      addLog('âŒ ERROR FATAL: Falta NEXT_PUBLIC_SUPABASE_URL');
      return;
    }

    try {
      addLog('1. Creant client Supabase...');
      const supabase = createClient();
      
      addLog('2. Enviant peticiÃ³ (SELECT)...');
      
      // Fem un timeout manual per si es queda penjat
      const timeoutPromise = new Promise<never>((_, reject) => 
        setTimeout(() => reject(new Error("Timeout: La xarxa estÃ  bloquejada (AdBlock?)")), 5000)
      );

      const dbPromise = supabase
        .from('analytics_events')
        .select('count', { count: 'exact', head: true });

      // Cursa entre la DB i el Timeout. Forcem el tipus a 'unknown' primer i desprÃ©s al nostre tipus.
      const result = await Promise.race([dbPromise, timeoutPromise]) as unknown as SupabaseCountResult;

      if (result.error) {
        addLog(`âŒ ERROR DB: ${result.error.message}`);
        console.error(result.error);
      } else {
        addLog(`âœ… CONNEXIÃ“ CORRECTA! Files a la taula: ${result.count}`);
      }

    } catch (err: unknown) { 
      // CANVI CLAU: Usem 'unknown' en lloc de 'any'
      let errorMessage = 'Error desconegut';
      
      if (err instanceof Error) {
        errorMessage = err.message;
      } else if (typeof err === 'string') {
        errorMessage = err;
      }

      addLog(`ğŸ’¥ EXCEPCIÃ“: ${errorMessage}`);
      console.error(err);
    }
  };

  return (
    <div className="p-8 text-white bg-slate-950 min-h-screen">
      <h1 className="text-3xl font-bold mb-6 text-red-500">ğŸš‘ DIAGNÃ’STIC D'URGÃˆNCIA</h1>
      
      {/* Estat Variables */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        <div className={`p-4 rounded border ${envStatus.url ? 'border-green-500 bg-green-900/20' : 'border-red-500 bg-red-900/20'}`}>
          <div className="font-bold">SUPABASE_URL</div>
          <div className="text-2xl">{envStatus.url ? 'âœ… OK' : 'âŒ MISSING'}</div>
        </div>
        <div className={`p-4 rounded border ${envStatus.key ? 'border-green-500 bg-green-900/20' : 'border-red-500 bg-red-900/20'}`}>
          <div className="font-bold">ANON_KEY</div>
          <div className="text-2xl">{envStatus.key ? 'âœ… OK' : 'âŒ MISSING'}</div>
        </div>
      </div>

      <button 
        onClick={testConnection}
        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg mb-6 transition-colors"
      >
        FORÃ‡AR PROVA DE CONNEXIÃ“
      </button>

      <div className="bg-black rounded-lg p-4 font-mono text-sm border border-slate-800 h-64 overflow-y-auto">
        {logs.length === 0 ? <span className="text-slate-500">Els logs apareixeran aquÃ­...</span> : logs.map((log, i) => (
          <div key={i} className="mb-1 border-b border-slate-900 pb-1">{log}</div>
        ))}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/layout.tsx ===================

// src/app/[locale]/admin/layout.tsx

import { requireAdmin } from '@/lib/auth/admin-guard';
import { Link } from '@/routing'; // ğŸ‘ˆ Assegura't que ve d'aquÃ­
import { ShieldAlert, LayoutDashboard, BarChart3, Users, Home, BookOpenCheck, FlaskConical } from 'lucide-react';
import { AdminBottomNav } from '@/components/admin/AminMobileMenu';

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  await requireAdmin();

  return (
    <div className="flex h-screen overflow-hidden bg-slate-950 text-slate-200">

      {/* SIDEBAR */}
      <aside className="hidden md:flex w-64 border-r border-slate-800 p-6 flex-col bg-slate-950">
        <div className="flex items-center gap-2 font-bold text-white mb-10 text-xl">
          <ShieldAlert className="text-red-500" />
          TORRE DE CONTROL
        </div>

        {/* CORRECCIÃ“ HIDRATACIÃ“: Assegurem-nos que l'estructura Ã©s neta */}
        <nav className="flex flex-col gap-2">
          <Link href="/admin" className="flex items-center gap-3 px-4 py-2 rounded hover:bg-slate-900 transition-colors text-slate-300 hover:text-white">
            <LayoutDashboard className="w-5 h-5" />
            <span>Dashboard</span>
          </Link>
          <Link href="/admin/analytics" className="flex items-center gap-3 px-4 py-2 rounded hover:bg-slate-900 transition-colors text-blue-400 font-medium">
            <BarChart3 className="w-5 h-5" />
            <span>AnalÃ­tiques</span>
          </Link>
          <Link href="/admin/users" className="flex items-center gap-3 px-4 py-2 rounded hover:bg-slate-900 transition-colors text-blue-400 font-medium">
            <Users className="w-5 h-5" />
            <span>Usuaris</span>
          </Link>
          <Link href="/admin/projects" className="flex items-center gap-3 px-4 py-2 rounded hover:bg-slate-900 transition-colors text-blue-400 font-medium">
            <Users className="w-5 h-5" />
            <span>Projectes</span>
          </Link>
          {/* ğŸ‘‡ NOU ENLLAÃ‡ DE TESTS */}
          <Link href="/admin/tests" className="flex items-center gap-3 px-4 py-2 rounded hover:bg-slate-900 transition-colors text-blue-400 font-medium">
            <FlaskConical className="w-5 h-5" />
            <span>QA / Tests</span>
          </Link>
          <Link href="/admin/blog" className="flex items-center gap-3 px-4 py-2 rounded hover:bg-slate-900 transition-colors text-blue-400 font-medium">
            <BookOpenCheck className="w-5 h-5" />
            <span>Blog</span>
          </Link>
          

          <div className="mt-auto pt-4 border-t border-slate-800">
            <Link href="/" className="flex items-center gap-3 px-4 py-2 rounded hover:bg-slate-900 transition-colors text-slate-500 text-sm">
              <Home className="w-4 h-4" />
              <span>Tornar a la Web</span>
            </Link>
          </div>
        </nav>
      </aside>

      {/* CONTINGUT */}
      <div className="flex-1 flex flex-col min-w-0 relative">
        <header className="md:hidden h-14 border-b border-slate-800 flex items-center justify-center bg-slate-950 shrink-0">
          <span className="flex items-center gap-2 font-bold text-white text-sm">
            <ShieldAlert className="w-4 h-4 text-red-500" /> ADMIN PANEL
          </span>
        </header>

        <main className="flex-1 overflow-y-auto p-4 md:p-8 mb-16 md:mb-0">
          {children}
        </main>

        <AdminBottomNav />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/page.tsx ===================

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

export default function AdminDashboard() {
  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold text-white">Benvingut, Arquitecte.</h1>
      
      <div className="grid gap-4 md:grid-cols-3">
        <Card className="bg-slate-900 border-slate-800 text-slate-200">
           <CardHeader>
             <CardTitle className="text-sm font-medium text-slate-400">Estat del Sistema</CardTitle>
           </CardHeader>
           <CardContent>
             <div className="text-2xl font-bold text-green-500">OPERATIU ğŸŸ¢</div>
           </CardContent>
        </Card>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/projects/new/page.tsx ===================

import { NewProjectForm } from '@/features/projects/ui/NewProjectForm';
import { requireAdmin } from '@/lib/auth/admin-guard'; // La teva protecciÃ³ d'admin

export default async function CreateProjectPage() {
  // ğŸ›¡ï¸ Seguretat: NomÃ©s tu pots entrar aquÃ­
  await requireAdmin();

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-black py-12 px-4">
      <div className="container mx-auto">
        <h1 className="text-3xl font-bold text-center mb-8">Nou Client</h1>
        <NewProjectForm />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/projects/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { createClient } from '@/lib/supabase/server';
import { Link } from '@/routing';
import { Plus, Github, ExternalLink, Clock, CheckCircle, AlertCircle } from 'lucide-react';

export default async function AdminProjectsPage() {
  await requireAdmin();
  const supabase = await createClient();

  // Obtenim projectes i la seva organitzaciÃ³ vinculada
  const { data: projects } = await supabase
    .from('projects')
    .select('*, organizations(plan)')
    .order('created_at', { ascending: false });

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-black p-8">
      <div className="max-w-6xl mx-auto">
        
        {/* Header */}
        <div className="flex justify-between items-center mb-8">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 dark:text-white">Projectes Clients</h1>
            <p className="text-slate-500">GestiÃ³ de les PWA generades</p>
          </div>
          <Link href="/admin/projects/new">
            <button className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-lg">
              <Plus className="w-5 h-5" /> Generar Nova Web
            </button>
          </Link>
        </div>

        {/* Grid de Projectes */}
        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {projects?.map((project) => (
            <div key={project.id} className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 shadow-sm hover:shadow-md transition-all">
              
              {/* CapÃ§alera Card */}
              <div className="flex justify-between items-start mb-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-lg bg-linear-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg">
                    {project.name.charAt(0)}
                  </div>
                  <div>
                    <h3 className="font-bold text-slate-900 dark:text-white">{project.name}</h3>
                    <p className="text-xs text-slate-500 font-mono">{project.domain}</p>
                  </div>
                </div>
                <StatusBadge status={project.status ?? 'pending'} />
              </div>

              {/* Detalls */}
              <div className="space-y-3 mb-6">
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-500">Pla:</span>
                  <span className="font-medium capitalize text-slate-700 dark:text-slate-300">
                    {project.organizations?.plan || 'BÃ sic'}
                  </span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-500">Creat:</span>
                  <span className="text-slate-700 dark:text-slate-300">
                    {project.created_at ? new Date(project.created_at).toLocaleDateString() : 'Desconegut'}
                  </span>
                </div>
              </div>

              {/* Accions */}
              <div className="flex gap-2 pt-4 border-t border-slate-100 dark:border-slate-800">
                <a 
                  href={project.repository_url ?? ''} 
                  target="_blank" 
                  className="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 text-sm font-medium transition-colors"
                >
                  <Github className="w-4 h-4" /> Codi
                </a>
                
                {/* BotÃ³ de "Deploy" o "Manage" futur */}
                <Link 
                  href={`/admin/projects/${project.id}`}
                  className="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg bg-slate-900 dark:bg-white text-white dark:text-slate-900 hover:opacity-90 text-sm font-bold transition-colors"
                >
                  <ExternalLink className="w-4 h-4" /> Gestionar
                </Link>
              </div>

            </div>
          ))}

          {projects?.length === 0 && (
            <div className="col-span-full py-20 text-center bg-slate-100 dark:bg-slate-800/50 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700">
              <p className="text-slate-500">Encara no has creat cap projecte.</p>
            </div>
          )}
        </div>

      </div>
    </div>
  );
}

// Component petit per l'estat
function StatusBadge({ status }: { status: string }) {
  const styles = {
    active: "bg-green-100 text-green-700 border-green-200",
    pending: "bg-yellow-100 text-yellow-700 border-yellow-200",
    maintenance: "bg-orange-100 text-orange-700 border-orange-200",
    archived: "bg-gray-100 text-gray-700 border-gray-200"
  };
  
  const icons = {
    active: CheckCircle,
    pending: Clock,
    maintenance: AlertCircle,
    archived:  AlertCircle
  };

  const Icon = icons[status as keyof typeof icons] || Clock;
  const style = styles[status as keyof typeof styles] || styles.pending;

  return (
    <span className={`flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-bold border ${style}`}>
      <Icon className="w-3 h-3" />
      {status.toUpperCase()}
    </span>
  );
}

// =================== FILE: src/app/[locale]/admin/projects/[id]/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { createClient } from '@/lib/supabase/server';
import { notFound } from 'next/navigation';
import { InviteClientForm } from '@/features/projects/ui/InviteClientForm';
// ğŸ—‘ï¸ CORRECCIÃ“: Eliminem 'CheckCircle' que no es feia servir (Error ts:6133)
import { Github, Globe, Server, User } from 'lucide-react'; 
import Link from 'next/link';

type Props = {
  params: Promise<{ id: string; locale: string }>;
};

export default async function ProjectDetailPage({ params }: Props) {
  await requireAdmin();
  const { id } = await params;
  const supabase = await createClient();

  const { data: project } = await supabase
    .from('projects')
    .select('*, organizations(*)')
    .eq('id', id)
    .single();

  if (!project) notFound();

  // ğŸ›¡ï¸ CORRECCIÃ“ DE NULLS:
  // Si organization_id Ã©s null, no podem continuar amb la lÃ²gica de permisos.
  if (!project.organization_id) {
      return <div>Error d'integritat: Aquest projecte no tÃ© organitzaciÃ³ vinculada.</div>;
  }

  const { data: team } = await supabase
    .from('profiles')
    .select('*')
    .eq('organization_id', project.organization_id);

  const owner = team?.find(u => u.role === 'client');

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-black p-8">
      <div className="max-w-5xl mx-auto">
        
        {/* Header */}
        <div className="mb-8">
          <Link href="/admin/projects" className="text-sm text-slate-500 hover:text-slate-900 mb-4 block">â† Tornar al llistat</Link>
          <div className="flex justify-between items-start">
            <h1 className="text-4xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
              {project.name}
              <span className="text-sm px-3 py-1 rounded-full bg-blue-100 text-blue-700 font-mono">
                {project.organizations?.slug}
              </span>
            </h1>
            <div className="flex gap-3">
               {/* ğŸ›¡ï¸ CORRECCIÃ“: Fallback segur per repository_url */}
               <a 
                 href={project.repository_url || '#'} 
                 target="_blank" 
                 className="flex items-center gap-2 px-4 py-2 border border-slate-300 rounded-lg text-sm font-bold hover:bg-slate-100 transition-colors"
               >
                 <Github className="w-4 h-4" /> GitHub
               </a>
               {/* ğŸ›¡ï¸ CORRECCIÃ“: Condicional per hosting_url */}
               {project.hosting_url && (
                 <a 
                   href={`https://${project.hosting_url}`} 
                   target="_blank" 
                   className="flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-lg text-sm font-bold hover:opacity-90 transition-colors"
                 >
                   <Globe className="w-4 h-4" /> Veure Web
                 </a>
               )}
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          <div className="lg:col-span-2 space-y-6">
            <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 shadow-sm">
                <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                    <Server className="w-5 h-5 text-blue-500" /> Infraestructura
                </h3>
                <div className="grid grid-cols-2 gap-4 text-sm">
                    {/* ... (resta igual) ... */}
                    <div className="p-3 bg-slate-50 rounded-lg">
                        <span className="text-slate-500 block text-xs uppercase font-bold">Base de Dades</span>
                        {/* AquÃ­ project.organization_id ja sabem que no Ã©s null pel check de dalt */}
                        <span className="font-mono text-xs">{project.organization_id}</span>
                    </div>
                    {/* ... (resta igual) ... */}
                </div>
            </div>

            <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 shadow-sm">
                <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                    <User className="w-5 h-5 text-green-500" /> Equip & Propietat
                </h3>
                
                {owner ? (
                    // ... (bloc owner igual)
                    <div className="flex items-center gap-4 p-4 bg-green-50 border border-green-100 rounded-lg">
                        <div className="w-10 h-10 bg-green-200 rounded-full flex items-center justify-center text-green-700 font-bold">
                            {owner.email.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <p className="font-bold text-green-900">{owner.full_name || 'Client'}</p>
                            <p className="text-sm text-green-700">{owner.email}</p>
                        </div>
                        <span className="ml-auto px-2 py-1 bg-white text-xs font-bold rounded text-green-600 border border-green-200">
                            PROPIETARI
                        </span>
                    </div>
                ) : (
                    <div className="space-y-4">
                        <div className="p-4 bg-yellow-50 border border-yellow-100 rounded-lg text-yellow-800 text-sm">
                            âš ï¸ Aquest projecte encara no tÃ© cap client assignat.
                        </div>
                        {/* ğŸ›¡ï¸ CORRECCIÃ“: Passem l'ID netejat */}
                        <InviteClientForm projectId={project.id} orgId={project.organization_id} />
                    </div>
                )}
            </div>
          </div>

          <div className="space-y-6">
             <div className="bg-slate-100 p-6 rounded-xl border border-slate-200">
                <h4 className="font-bold text-slate-700 mb-2 text-sm uppercase">ConfiguraciÃ³ Visual</h4>
                <pre className="text-xs bg-white p-3 rounded border overflow-auto max-h-40">
                    {JSON.stringify(project.organizations?.branding_config, null, 2)}
                </pre>
             </div>
          </div>

        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/tests/new/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { createClient } from '@/lib/supabase/server';
import { Link } from '@/routing';
import { ArrowLeft } from 'lucide-react';
// ğŸ‘‡ Importem el component client que acabem de crear
import { CreateCampaignForm } from '@/features/tests/ui/CreateCampaignForm';

export default async function NewCampaignPage() {
  await requireAdmin();
  const supabase = await createClient();
  
  // Obtenim els projectes al servidor
  const { data: projects } = await supabase
    .from('projects')
    .select('id, name')
    .order('created_at', { ascending: false });

  return (
    <div className="max-w-2xl mx-auto p-8">
        <Link href="/admin/tests" className="text-slate-500 hover:text-white flex items-center gap-2 mb-6 transition-colors">
            <ArrowLeft className="w-4 h-4" /> CancelÂ·lar
        </Link>

        <h1 className="text-3xl font-bold text-white mb-8">Nova Campanya de Test</h1>

        {/* Passem les dades al component client */}
        <CreateCampaignForm projects={projects || []} />
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/tests/page.tsx ===================

import { requireAdmin } from '@/lib/auth/admin-guard';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { Plus, FlaskConical, ExternalLink } from 'lucide-react';

// Tipus local per a la vista (amb les dades ja processades pel repo)
type AdminCampaignView = {
  id: string;
  title: string;
  description: string | null;
  status: string;
  created_at: string;
  projects: { name: string } | null;
  stats: {
    total_tasks: number;
    total_results: number;
  };
};

export default async function AdminTestsPage() {
  await requireAdmin();
  const repo = new SupabaseTestRepository();
  
  // Fem servir el tipus nou
  const campaigns = (await repo.getAllCampaignsForAdmin()) as unknown as AdminCampaignView[];

  return (
    <div className="p-8">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-3xl font-bold text-white flex items-center gap-3">
            <FlaskConical className="w-8 h-8 text-purple-500" /> GestiÃ³ de QA
          </h1>
          <p className="text-slate-400 mt-1">Administra les campanyes de proves beta.</p>
        </div>
        <Link href="/admin/tests/new">
          <Button className="bg-purple-600 hover:bg-purple-700 text-white">
            <Plus className="w-4 h-4 mr-2" /> Nova Campanya
          </Button>
        </Link>
      </div>

      <div className="grid gap-4">
        {campaigns.map((camp) => (
          <div key={camp.id} className="bg-slate-900 border border-slate-800 rounded-xl p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:border-purple-500/30 transition-colors">
            
            {/* Info Principal */}
            <div>
              <div className="flex items-center gap-3 mb-1">
                <h3 className="text-lg font-bold text-white">{camp.title}</h3>
                <span className={`text-[10px] px-2 py-0.5 rounded font-bold uppercase ${camp.status === 'active' ? 'bg-green-900 text-green-300' : 'bg-slate-700 text-slate-300'}`}>
                    {camp.status}
                </span>
              </div>
              <p className="text-sm text-slate-400 mb-2">{camp.description || "Sense descripciÃ³"}</p>
              <div className="flex items-center gap-4 text-xs text-slate-500 font-mono">
                <span>ğŸ“‚ {camp.projects?.name || 'Projecte esborrat'}</span>
                <span>ğŸ“… {new Date(camp.created_at).toLocaleDateString()}</span>
              </div>
            </div>

            {/* EstadÃ­stiques (ARA MOLT MÃ‰S NET) */}
            <div className="flex items-center gap-6 md:pr-8 md:border-r border-slate-800">
                <div className="text-center">
                    <div className="text-2xl font-bold text-white">{camp.stats.total_tasks}</div>
                    <div className="text-[10px] text-slate-500 uppercase tracking-wider">Tasques</div>
                </div>
                <div className="text-center">
                    <div className="text-2xl font-bold text-blue-400">{camp.stats.total_results}</div>
                    <div className="text-[10px] text-slate-500 uppercase tracking-wider">Reports</div>
                </div>
            </div>

            {/* Accions */}
            <div className="flex gap-2 w-full md:w-auto">
                <Link href={`/admin/tests/${camp.id}`} className="w-full md:w-auto">
                    <Button variant="outline" className="w-full border-slate-700 text-slate-300 hover:text-white hover:bg-slate-800">
                        Gestionar <ExternalLink className="w-4 h-4 ml-2" />
                    </Button>
                </Link>
            </div>

          </div>
        ))}

        {campaigns.length === 0 && (
            <div className="text-center py-20 text-slate-600 bg-slate-900/50 rounded-xl border border-dashed border-slate-800">
                No hi ha campanyes actives. Crea la primera!
            </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/tests/[id]/page.tsx ===================

// src/app/[locale]/admin/tests/[id]/page.tsx

import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { TesterManager } from '@/features/tests/ui/TesterManager';
import { requireAdmin } from '@/lib/auth/admin-guard';

export default async function AdminTestDetailPage({ params }: { params: Promise<{ id: string }> }) {
  await requireAdmin();
  const { id } = await params;
  
  const repo = new SupabaseTestRepository();
  
  // 1. Dades en paralÂ·lel
  const [assigned, available, campaignData] = await Promise.all([
    repo.getAssignedTesters(id),
    repo.getAvailableTesters(),
    // Assumeixo que tens un mÃ¨tode getCampaignById, sinÃ³ usa getCampaignWithContext
    repo.getCampaignWithContext(id, 'admin') 
  ]);

  if (!campaignData.campaign) return <div>Test no trobat</div>;

  return (
    <div className="p-8 max-w-6xl mx-auto">
        <h1 className="text-3xl font-bold mb-2">{campaignData.campaign.title}</h1>
        <p className="text-slate-500 mb-8">GestiÃ³ de la campanya de proves</p>

        {/* ZONA DE GESTIÃ“ D'EQUIP */}
        <section className="mb-12">
            <h2 className="text-xl font-bold mb-6 border-b pb-2">ğŸ‘¥ Equip de Testing</h2>
            <TesterManager 
                campaignId={id} 
                assignedTesters={assigned} 
                availableTesters={available} 
            />
        </section>

        {/* AQUI POTS AFEGIR ZONA DE RESULTATS, TASQUES, ETC. */}
    </div>
  );
}

// =================== FILE: src/app/[locale]/admin/users/page.tsx ===================

import { getAdminUsersList } from '@/app/actions/get-users';
import { getTranslations } from 'next-intl/server';
import { Mail, Download, User, Calendar, ShieldCheck, UserCheck, UserPlus } from 'lucide-react';
import { Button } from '@/components/ui/button';

export default async function AdminUsersPage() {
  const users = await getAdminUsersList();
  const t = await getTranslations('AdminDashboard');

  return (
    <div className="p-6 max-w-7xl mx-auto">
      {/* CAPÃ‡ALERA */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-bold text-foreground tracking-tight">Usuaris</h1>
          <p className="text-muted-foreground text-sm">
            Base de dades de clients i leads ({users.length} totals)
          </p>
        </div>
        <Button variant="outline" className="border-border bg-card hover:bg-muted text-foreground gap-2">
          <Download className="w-4 h-4" />
          Exportar CSV
        </Button>
      </div>

      {/* TAULA CARD */}
      <div className="border border-border rounded-xl overflow-hidden bg-card shadow-sm">
        <div className="overflow-x-auto">
          <table className="w-full text-sm text-left">
            {/* HEAD */}
            <thead className="bg-muted/50 text-muted-foreground border-b border-border text-xs uppercase tracking-wider font-semibold">
              <tr>
                <th className="px-4 py-3 pl-6">Usuari</th>
                <th className="px-4 py-3">Rol & Estat</th>
                <th className="px-4 py-3">Registre</th>
                <th className="px-4 py-3 text-right pr-6">Accions</th>
              </tr>
            </thead>

            {/* BODY */}
            <tbody className="divide-y divide-border">
              {users.map((user) => (
                <tr key={user.id} className="hover:bg-muted/30 transition-colors group">
                  
                  {/* COLUMNA 1: IDENTITAT (Compacta) */}
                  <td className="px-4 py-3 pl-6">
                    <div className="flex items-center gap-3">
                      {/* Avatar Generat */}
                      <div className="w-9 h-9 rounded-full bg-primary/10 border border-primary/20 flex items-center justify-center text-primary font-bold text-sm shrink-0">
                        {user.full_name ? user.full_name.charAt(0).toUpperCase() : <User className="w-4 h-4" />}
                      </div>
                      <div className="flex flex-col">
                        <span className="font-semibold text-foreground leading-none mb-1">
                          {user.full_name || 'Sense nom'}
                        </span>
                        <span className="text-xs text-muted-foreground font-mono">
                          {user.email}
                        </span>
                      </div>
                    </div>
                  </td>

                  {/* COLUMNA 2: ROL (Badge modern) */}
                  <td className="px-4 py-3">
                    <RoleBadge role={user.role} />
                  </td>

                  {/* COLUMNA 3: DATA (Compacta) */}
                  <td className="px-4 py-3 text-muted-foreground">
                    {user.created_at ? (
                      <div className="flex items-center gap-2 text-xs">
                        <Calendar className="w-3.5 h-3.5 opacity-70" />
                        <div className="flex flex-col">
                          <span className="font-medium text-foreground">
                            {new Date(user.created_at).toLocaleDateString('ca-ES', { day: '2-digit', month: 'short', year: '2-digit' })}
                          </span>
                          <span className="text-[10px] opacity-70">
                            {new Date(user.created_at).toLocaleTimeString('ca-ES', { hour: '2-digit', minute: '2-digit' })}
                          </span>
                        </div>
                      </div>
                    ) : (
                      <span className="text-muted-foreground">-</span>
                    )}
                  </td>

                  {/* COLUMNA 4: ACCIONS */}
                  <td className="px-4 py-3 text-right pr-6">
                    <a
                      href={`mailto:${user.email}`}
                      className="inline-flex items-center justify-center w-8 h-8 rounded-lg text-muted-foreground hover:text-primary hover:bg-primary/10 transition-all"
                      title="Enviar correu"
                    >
                      <Mail className="w-4 h-4" />
                    </a>
                  </td>
                </tr>
              ))}

              {users.length === 0 && (
                <tr>
                  <td colSpan={4} className="px-6 py-12 text-center text-muted-foreground">
                    <div className="flex flex-col items-center gap-2">
                        <User className="w-8 h-8 opacity-20" />
                        <span>Encara no hi ha usuaris registrats.</span>
                    </div>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// Helper component per als Badges de Rol
function RoleBadge({ role }: { role: string }) {
  const styles = {
    admin: "bg-purple-500/10 text-purple-600 dark:text-purple-400 border-purple-500/20",
    client: "bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/20",
    lead: "bg-blue-500/10 text-blue-600 dark:text-blue-400 border-blue-500/20",
    unknown: "bg-slate-500/10 text-slate-600 dark:text-slate-400 border-slate-500/20"
  };

  const icons = {
    admin: ShieldCheck,
    client: UserCheck,
    lead: UserPlus,
    unknown: User
  };

  const normalizedRole = (role || 'unknown').toLowerCase() as keyof typeof styles;
  const styleClass = styles[normalizedRole] || styles.unknown;
  const Icon = icons[normalizedRole] || icons.unknown;

  return (
    <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-bold border ${styleClass}`}>
      <Icon className="w-3 h-3" />
      {normalizedRole.toUpperCase()}
    </span>
  );
}

// =================== FILE: src/app/[locale]/auth/callback/route.ts ===================

import { NextResponse } from 'next/server'
// El client de servidor que hem creat abans
import { createClient } from '@/lib/supabase/server'

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  // si tenim un parÃ metre "next", el fem servir per redirigir
  const next = searchParams.get('next') ?? '/dashboard'

  if (code) {
    const supabase = await createClient()
    const { error } = await supabase.auth.exchangeCodeForSession(code)
    
    if (!error) {
      // Si tot ha anat bÃ©, redirigim a l'usuari cap al dashboard (o on volguÃ©s anar)
      // Afegim el locale per defecte si cal, o detectem.
      // Per ara hardcodegem 'ca', perÃ² l'ideal seria guardar-ho en cookie abans.
      return NextResponse.redirect(`${origin}/ca${next}`)
    }
  }

  // Si hi ha error, tornem al login amb un missatge
  return NextResponse.redirect(`${origin}/ca/auth/login?error=auth-code-error`)
}

// =================== FILE: src/app/[locale]/auth/forgot-password/page.tsx ===================

import { getTranslations } from 'next-intl/server';
import { Link } from '@/routing';
import { ForgotPasswordForm } from '@/features/auth/ui/ForgotPasswordForm';

export default async function ForgotPasswordPage() {
  const t = await getTranslations('AuthPages.forgot_password');

  return (
    <div className="flex min-h-screen items-center justify-center bg-muted/20 px-4 py-12">
      <div className="w-full max-w-md space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-bold tracking-tight">{t('title')}</h1>
          <p className="mt-2 text-sm text-muted-foreground">
            {t('subtitle')}
          </p>
        </div>

        <ForgotPasswordForm />

        <div className="text-center text-sm">
          <Link href="/auth/login" className="font-medium text-primary hover:underline">
            â† {t('back_login')}
          </Link>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/auth/login/page.tsx ===================

import { LoginForm } from '@/features/auth/ui/LoginForm';
import { Sparkles } from 'lucide-react';
import Link from 'next/link';
import { useTranslations } from 'next-intl';

export default function LoginPage() {
  const t = useTranslations('AuthPages.login');

  return (
    <div className="min-h-screen w-full grid lg:grid-cols-2 bg-background overflow-hidden">
      
      {/* COLUMNA ESQUERRA (Visual / Marketing) */}
      <div className="hidden lg:flex relative flex-col justify-between p-12 bg-[#0f111a] border-r border-white/5">
         {/* Fons animat */}
         <div className="absolute inset-0 bg-[radial-gradient(circle_at_top_left,var(--tw-gradient-stops))] from-primary/20 via-background to-background opacity-50"></div>
         <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-10"></div> 
         
         {/* Logo */}
         <div className="relative z-10">
            <Link href="/" className="flex items-center gap-2 text-2xl font-bold text-white">
               DigitAI <span className="gradient-text">Studios</span>
            </Link>
         </div>

         {/* Testimoni o Text inspirador */}
         <div className="relative z-10 max-w-lg">
            <div className="mb-6 inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold">
               <Sparkles className="w-3 h-3" />
               DIGITAL INTELLIGENCE
            </div>
            <h2 className="text-4xl font-bold text-white mb-4 leading-tight">
               {t('marketing_title')}
            </h2>
            <p className="text-slate-400 text-lg">
               {t('marketing_subtitle')}
            </p>
         </div>

         {/* Footer petit */}
         <div className="relative z-10 text-sm text-slate-600">
            {t('footer')}
         </div>
      </div>

      {/* COLUMNA DRETA (Formulari) */}
      <div className="flex items-center justify-center p-8 relative">
         {/* BotÃ³ tornar enrere mÃ²bil */}
         <Link href="/" className="absolute top-8 right-8 text-sm text-muted-foreground hover:text-foreground lg:hidden">
            {t('back_home')}
         </Link>

         <LoginForm />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/auth/register/page.tsx ===================

import { RegisterForm } from '@/features/auth/ui/RegisterForm';
import { Link } from '@/routing'; 
import { Sparkles, ArrowLeft } from 'lucide-react';
import { getTranslations } from 'next-intl/server';

type Props = {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
};

export default async function RegisterPage({ searchParams }: Props) {
  // 1. Obtenim les dades
  const params = await searchParams;
  const emailParam = typeof params.email === 'string' ? params.email : '';

  // 2. Traduccions
  const t = await getTranslations('AuthPages.register');

  return (
    <div className="min-h-screen w-full grid lg:grid-cols-2 bg-background overflow-hidden">
      
      {/* COLUMNA ESQUERRA */}
      <div className="hidden lg:flex relative flex-col justify-between p-12 bg-[#0f111a] border-r border-white/5">
         <div className="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,var(--tw-gradient-stops))] from-primary/20 via-background to-background opacity-50"></div>
         <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-10"></div>
         
         {/* Logo */}
         <div className="relative z-10">
            <Link href="/" className="flex items-center gap-2 text-2xl font-bold text-white no-underline">
               DigitAI <span className="gradient-text">Studios</span>
            </Link>
         </div>

         {/* Missatge de valor */}
         <div className="relative z-10 max-w-lg">
            <div className="mb-6 inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold">
               <Sparkles className="w-3 h-3" />
               {t('marketing_badge')}
            </div>
            <h2 className="text-4xl font-bold text-white mb-4 leading-tight">
               {t('marketing_title')}
            </h2>
            <div className="space-y-4 mt-8">
                <div className="flex items-center gap-4 text-slate-400">
                    <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white font-bold">1</div>
                    <p>{t('feature_1')}</p>
                </div>
                <div className="flex items-center gap-4 text-slate-400">
                    <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white font-bold">2</div>
                    <p>{t('feature_2')}</p>
                </div>
                <div className="flex items-center gap-4 text-slate-400">
                    <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white font-bold">3</div>
                    <p>{t('feature_3')}</p>
                </div>
            </div>
         </div>

         {/* Footer petit */}
         <div className="relative z-10 text-sm text-slate-600">
            Â© {new Date().getFullYear()} DigitAI Studios.
         </div>
      </div>

      {/* COLUMNA DRETA */}
      <div className="flex items-center justify-center p-8 relative">
         <Link href="/" className="absolute top-8 left-8 text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 lg:hidden">
            <ArrowLeft className="w-4 h-4" /> {t('back_home')}
         </Link>

         <RegisterForm prefilledEmail={emailParam} />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/auth/reset-password/page.tsx ===================

import { redirect } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';
import { getTranslations, getLocale } from 'next-intl/server';
import { ResetPasswordForm } from '@/features/auth/ui/ResetPasswordForm';

export default async function ResetPasswordPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  const t = await getTranslations('AuthPages.reset_password');
  const locale = await getLocale();

  // Si l'usuari no tÃ© sessiÃ³, vol dir que l'enllaÃ§ ha caducat o Ã©s invÃ lid.
  if (!user) {
    redirect(`/${locale}/auth/forgot-password`); 
  }

  return (
    <div className="flex min-h-screen items-center justify-center bg-muted/20 px-4 py-12">
      <div className="w-full max-w-md space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-bold tracking-tight">{t('title')}</h1>
          <p className="mt-2 text-sm text-muted-foreground">
            {t('subtitle')}
          </p>
        </div>

        <ResetPasswordForm />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/audits/page.tsx ===================

import { getTranslations, getLocale } from 'next-intl/server';
import { Link } from '@/routing';
import { redirect } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Plus, Globe, Calendar, ArrowRight, Activity } from 'lucide-react';
import { createClient } from '@/lib/supabase/server'; 
import { auditRepository } from '@/services/container';

export default async function AuditsListPage() {
  const t = await getTranslations('AuditList'); // Namespace AuditList
  const locale = await getLocale();
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();

  if (!user || !user.email) {
    redirect(`/${locale}/auth/login`); 
  }

  const audits = await auditRepository.getAuditsByUserEmail(user.email);

  // Helper per traduir estats dins del component server
  const getStatusLabel = (status: string) => {
      if (status === 'completed') return t('status.completed');
      if (status === 'failed') return t('status.failed');
      return t('status.processing');
  };

  return (
    <div className="space-y-8">
      
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-6 border-b border-border">
        <div>
          <h1 className="text-3xl font-bold text-foreground">{t('title')}</h1>
          <p className="text-muted-foreground mt-1">
            {t('subtitle')}
          </p>
        </div>
        <Link href="/dashboard/new-audit">
          <Button className="gradient-bg text-white border-0 shadow-lg shadow-primary/20 hover:opacity-90 transition-opacity">
            <Plus className="w-4 h-4 mr-2" /> {t('new_audit_button')}
          </Button>
        </Link>
      </div>

      {/* Grid */}
      <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {audits.map((audit) => (
          <Link key={audit.id} href={`/dashboard/audits/${audit.id}`} className="block group h-full">
            <div className="bg-card border border-border rounded-xl p-6 h-full hover:border-primary/50 transition-all duration-300 shadow-sm hover:shadow-md hover:-translate-y-1 relative overflow-hidden flex flex-col">
              
              {/* CapÃ§alera Targeta */}
              <div className="flex justify-between items-start mb-6">
                 <div className="p-3 bg-primary/10 rounded-lg text-primary border border-primary/20 group-hover:bg-primary/20 transition-colors">
                    <Globe className="w-6 h-6" />
                 </div>
                 <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide border ${
                   audit.status === 'completed' 
                     ? 'bg-green-500/10 text-green-500 border-green-500/20' 
                     : audit.status === 'failed'
                     ? 'bg-red-500/10 text-red-500 border-red-500/20'
                     : 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20'
                 }`}>
                    {getStatusLabel(audit.status)}
                 </span>
              </div>

              {/* Cos Targeta */}
              <div className="mb-6 grow">
                 <h3 className="text-lg font-bold text-foreground truncate mb-2" title={audit.url}>
                    {audit.url.replace(/^https?:\/\//, '').replace(/\/$/, '')}
                 </h3>
                 <div className="flex items-center gap-2 text-xs text-muted-foreground">
                    <Calendar className="w-3 h-3" />
                    {new Intl.DateTimeFormat(locale, { dateStyle: 'medium' }).format(audit.createdAt)}
                 </div>
              </div>

              {/* Peu Targeta */}
              {audit.status === 'completed' && (
                 <div className="grid grid-cols-2 gap-3 mt-auto pt-4 border-t border-border">
                    <div className="flex flex-col">
                       <span className="text-[10px] text-muted-foreground uppercase font-bold mb-1">SEO</span>
                       <div className="flex items-center gap-1.5">
                          <Activity className="w-3 h-3 text-muted-foreground" />
                          <span className={`text-lg font-bold ${getScoreColor(audit.seoScore || 0)}`}>
                             {audit.seoScore || '-'}
                          </span>
                       </div>
                    </div>
                    <div className="flex flex-col border-l border-border pl-3">
                       <span className="text-[10px] text-muted-foreground uppercase font-bold mb-1">{t('performance')}</span>
                       <div className="flex items-center gap-1.5">
                          <Activity className="w-3 h-3 text-muted-foreground" />
                          <span className={`text-lg font-bold ${getScoreColor(audit.performanceScore || 0)}`}>
                             {audit.performanceScore || '-'}
                          </span>
                       </div>
                    </div>
                 </div>
              )}

              {/* Fletxa Hover */}
              <div className="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
                 <ArrowRight className="w-5 h-5 text-primary" />
              </div>
            </div>
          </Link>
        ))}

        {/* Estat Buit */}
        {audits.length === 0 && (
          <div className="col-span-full py-16 flex flex-col items-center justify-center text-center border-2 border-dashed border-border rounded-2xl bg-card/30">
            <div className="w-16 h-16 bg-muted/50 rounded-full flex items-center justify-center mb-4">
               <Globe className="w-8 h-8 text-muted-foreground" />
            </div>
            <h3 className="text-lg font-medium text-foreground mb-2">{t('empty_title')}</h3>
            <p className="text-muted-foreground mb-6 max-w-sm">
              {t('empty_description')}
            </p>
            <Link href="/dashboard/new-audit">
               <Button variant="outline" className="border-border hover:bg-muted text-foreground">
                  {t('create_first_audit')}
               </Button>
            </Link>
          </div>
        )}
      </div>
    </div>
  );
}

function getScoreColor(score: number) {
   if (score >= 90) return 'text-green-500';
   if (score >= 50) return 'text-yellow-500';
   return 'text-red-500';
}

// =================== FILE: src/app/[locale]/dashboard/audits/[id]/page.tsx ===================

import { notFound } from 'next/navigation';
import { auditRepository } from '@/services/container';
import { AuditHeader } from '@/features/audit/ui/components/AuditHeader';
import { ScoreGrid } from '@/features/audit/ui/components/ScoreGrid';
import { CoreVitalsGrid, AuditMetric } from '@/features/audit/ui/components/CoreVitalsGrid';
import { IssuesList } from '@/features/audit/ui/components/IssuesList';
import { MobilePreview } from '@/features/audit/ui/components/MobilePreviw';
import { AuditIssue } from '@/adapters/IWebScanner';
import { getTranslations } from 'next-intl/server'; // Importem el hook de servidor

type LighthouseAudit = {
  id: string;
  title: string;
  description: string;
  score: number | null;
  displayValue?: string;
  numericValue?: number;
  details?: unknown; 
};

interface GoogleRawData {
  lighthouseResult?: { audits: Record<string, LighthouseAudit> };
  audits?: Record<string, LighthouseAudit>;
  issues?: AuditIssue[];
  screenshot?: string;
}

type Props = {
  params: Promise<{ id: string; locale: string }>;
};

export default async function AuditDetailsPage({ params }: Props) {
  const { id } = await params;
  const t = await getTranslations('AuditDetails'); // Namespace AuditDetails
  const audit = await auditRepository.getAuditById(id);

  if (!audit) notFound();

  if (audit.status === 'processing') {
    return <div className="p-12 text-center text-foreground">{t('processing_message')}</div>;
  }

  // 1. Recuperar dades
  const rawData = audit.reportData as unknown as GoogleRawData;
  const googleAudits = rawData?.lighthouseResult?.audits || rawData?.audits || {};

  // 2. Helper
  const extract = (key: string): AuditMetric => {
    const a = googleAudits[key];
    if (!a) return { score: null, value: 'N/A', description: '' };
    return {
      score: a.score,
      value: a.displayValue || (a.numericValue ? a.numericValue.toFixed(2) : 'N/A'),
      description: a.title
    };
  };

  // 3. MÃ¨triques
  const metrics = {
    fcp: extract('first-contentful-paint'),
    lcp: extract('largest-contentful-paint'),
    cls: extract('cumulative-layout-shift'),
    tbt: extract('total-blocking-time'),
    si: extract('speed-index')
  };

  // 4. Issues
  let displayIssues: AuditIssue[] = rawData?.issues || [];

  if (displayIssues.length === 0 && Object.keys(googleAudits).length > 0) {
    displayIssues = Object.entries(googleAudits)
      .filter(([, a]) => {
        const score = a.score ?? 1;
        return score < 0.9 && a.score !== null;
      })
      .map(([key, a]) => ({
        id: key, // IMPORTANT: Passem l'ID per traduir
        title: a.title || 'Problema detectat',
        description: a.description || '',
        score: a.score ?? 0,
        displayValue: a.displayValue,
        impact: (a.score === 0 ? 'high' : 'medium'),
        type: (a.score === 0 ? "error" : "warning") as "error" | "warning"
      }))
      .sort((a, b) => (a.score || 0) - (b.score || 0))
      .slice(0, 8);
  }

  // 5. Captura
  type ScreenshotDetails = { data?: string };
  const screenshotData = 
      rawData?.screenshot || 
      (googleAudits['final-screenshot']?.details as ScreenshotDetails)?.data || 
      '';

  const seoScore = audit.seoScore ?? 0;
  const perfScore = audit.performanceScore ?? 0;

  return (
    <div className="space-y-10 pb-20 max-w-7xl mx-auto">
      
      <AuditHeader 
        url={audit.url} 
        date={new Date(audit.createdAt)}
        pdfData={{
          url: audit.url,
          date: new Date(audit.createdAt).toLocaleDateString(),
          scores: { seo: seoScore, perf: perfScore, a11y: 85, best: 92 },
          screenshot: screenshotData,
          issues: displayIssues
        }}
      />

      <ScoreGrid seo={seoScore} perf={perfScore} />

      <div className="grid lg:grid-cols-3 gap-8 lg:gap-12">
         <div className="lg:col-span-2 space-y-10">
            <CoreVitalsGrid metrics={metrics} />
            <IssuesList issues={displayIssues} />
         </div>

         <div className="lg:col-span-1">
            <div className="sticky top-8">
                <MobilePreview screenshot={screenshotData} />
            </div>
         </div>
      </div>

    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/layout.tsx ===================

import { Sidebar } from '@/components/dashboard/Sidebar';
import { MobileBottomBar } from './MobilBottomBar';
import { DashboardHeader } from '@/components/dashboard/DashboardHeader';
import { createClient } from '@/lib/supabase/server';
import { redirect } from '@/routing';

type Props = {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
};

export default async function DashboardLayout({ children, params }: Props) {
  const supabase = await createClient();
  const { data: { user }, error } = await supabase.auth.getUser();
  const { locale } = await params;

  if (error || !user) {
    redirect({ href: '/auth/login', locale });
  }

  // ğŸ‘‡ CORRECCIÃ“: NO usem .single() perquÃ¨ pot tenir mÃºltiples perfils
  const { data: profiles } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user!.id);

  // Busquem si en ALGUN dels seus perfils Ã©s admin
  // TambÃ© pots afegir el "Super Admin Override" per email per seguretat extra
  const isAdmin = profiles?.some(p => p.role === 'admin') || user!.email === process.env.ADMIN_EMAIL;
  
  const userRole = isAdmin ? 'admin' : 'client';

  // (Opcional) Deixem un log net per confirmar que ara funciona
  console.log(`âœ… Rol calculat per ${user!.email}: ${userRole} (Perfils trobats: ${profiles?.length})`);

  return (
    <div className="min-h-screen bg-muted/10 flex font-sans text-foreground">
      
      {/* SIDEBAR */}
      <div className="hidden md:block w-64 shrink-0 z-40">
         <Sidebar userRole={userRole} />
      </div>

      {/* AREA PRINCIPAL */}
      <div className="flex-1 flex flex-col min-h-screen relative overflow-hidden">
         <div className="absolute top-0 left-0 w-full h-[500px] bg-primary/5 blur-[150px] pointer-events-none"></div>

         <DashboardHeader userEmail={user?.email ?? ''} />
         
         <main className="flex-1 p-4 md:p-8 overflow-y-auto relative z-10 pb-24 md:pb-8">
            {children}
         </main>

         <div className="md:hidden">
            <MobileBottomBar userRole={userRole} />
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/MobilBottomBar.tsx ===================

'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { LayoutDashboard, FileText, FolderKanban, Settings, ShieldAlert } from 'lucide-react';
import { cn } from '@/lib/utils';
import { useTranslations } from 'next-intl';

// 1. DEFINIM LA INTERFÃCIE
interface MobileBottomBarProps {
  userRole: 'admin' | 'client' | 'lead';
}

// 2. ACCEPTEM LA PROP
export function MobileBottomBar({ userRole }: MobileBottomBarProps) {
  console.log("ğŸ” [CLIENT MOBILE] Prop rebuda userRole:", userRole);
  const t = useTranslations('Sidebar');
  const pathname = usePathname();

  const cleanPath = pathname.replace(/^\/[a-z]{2}/, '') || '/';

  // 3. DEFINIM ELS ÃTEMS BÃ€SICS
  const MENU_ITEMS = [
    { icon: LayoutDashboard, label: t('summary'), href: '/dashboard' },
    { icon: FileText, label: t('audits'), href: '/dashboard/audits' },
    { icon: FolderKanban, label: 'Tests', href: '#proves' },
    { icon: Settings, label: t('settings'), href: '#ajustos' },
  ];

  // 4. AFEGIM L'ADMIN NOMÃ‰S SI TOCA
  if (userRole === 'admin') {
    MENU_ITEMS.push({ // 'push' ho posa al final (dreta)
      icon: ShieldAlert, 
      label: 'Admin', // O t('admin') si tens la traducciÃ³
      href: '/admin' 
    });
  }

  const handleClick = (e: React.MouseEvent, href: string, label: string) => {
    if (href.startsWith('#')) {
      e.preventDefault();
      alert(`${label} estarÃ  disponible properament! ğŸš€`);
    }
  };

  return (
    <div className="fixed bottom-0 left-0 w-full z-50 bg-background/95 backdrop-blur-xl border-t border-border pb-safe transition-colors duration-300">
        <div className="flex justify-around items-center h-16 px-2">
            {MENU_ITEMS.map((item) => {
                const Icon = item.icon;
                let isActive = false;
                
                // LÃ²gica activa
                if (!item.href.startsWith('#')) {
                   if (item.href === '/dashboard') {
                      isActive = cleanPath === '/dashboard';
                   } else {
                      isActive = cleanPath.startsWith(item.href);
                   }
                }

                // Detectem si Ã©s admin per donar-li color especial (opcional)
                const isAdminItem = item.href === '/admin';

                return (
                    <Link 
                        key={item.label} 
                        href={item.href}
                        onClick={(e) => handleClick(e, item.href, item.label)}
                        className={cn(
                            "flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform",
                            isActive 
                                ? "text-primary" 
                                : "text-muted-foreground hover:text-foreground",
                            // Color vermellÃ³s per a l'admin si vols que destaqui
                            (isAdminItem && !isActive) && "text-red-400 hover:text-red-500"
                        )}
                    >
                        <Icon 
                            className={cn("w-6 h-6 transition-all", isActive && "fill-current/20 scale-110")} 
                            strokeWidth={isActive ? 2.5 : 2} 
                        />
                        <span className={cn("text-[10px] font-medium", isActive ? "font-bold" : "")}>
                            {item.label}
                        </span>
                    </Link>
                );
            })}
        </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/new-audit/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { getLocale, getTranslations } from 'next-intl/server'; // Importem getTranslations
import { CreateAuditForm } from '@/features/audit/ui/components/CreateAuditForm';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

export default async function NewAuditPage() {
  const supabase = await createClient();
  const locale = await getLocale();
  const t = await getTranslations('NewAudit'); // Namespace NewAudit
  
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect(`/${locale}/auth/login`);
  }

  return (
    <div className="max-w-2xl mx-auto py-8 px-4">
      
      <Link 
        href="/dashboard/audits" 
        className="flex items-center text-sm text-muted-foreground hover:text-foreground mb-8 transition-colors w-fit"
      >
         <ArrowLeft className="w-4 h-4 mr-2" /> {t('back_to_list')}
      </Link>

      <div className="bg-card border border-border rounded-2xl p-8 md:p-12 shadow-2xl relative overflow-hidden">
         
         <div className="absolute top-0 right-0 w-64 h-64 bg-primary/10 blur-[80px] rounded-full pointer-events-none"></div>

         <div className="relative z-10">
            <h1 className="text-3xl font-bold text-foreground mb-4">{t('title')}</h1>
            <p className="text-muted-foreground mb-8 leading-relaxed">
               {t('description')}
            </p>

            <CreateAuditForm  />
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/page.tsx ===================

import { getTranslations } from 'next-intl/server';
import { redirect } from 'next/navigation';
import { Link } from '@/routing';
import { createClient } from '@/lib/supabase/server';
import { auditRepository } from '@/services/container';
import { Activity, BarChart3, Clock, Plus } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { AuditCard } from '@/components/dashboard/AuditCard';

export default async function DashboardPage() {
    const supabase = await createClient();
    // Use the namespace we created
    const t = await getTranslations('DashboardHome'); 
    
    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !user.email) {
        redirect('/');
    }

    const audits = await auditRepository.getAuditsByUserEmail(user.email);
    const totalAudits = audits.length;
    const validSeoScores = audits
        .filter(a => a.seoScore !== null && a.seoScore !== undefined)
        .map(a => a.seoScore as number);
    const avgSeo = validSeoScores.length > 0
        ? Math.round(validSeoScores.reduce((a, b) => a + b, 0) / validSeoScores.length)
        : 0;

    return (
        <div className="space-y-8 pb-24 md:pb-8"> 

            {/* HEADER */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 pb-6 border-b border-border">
                <div>
                    <h1 className="text-2xl md:text-3xl font-bold text-foreground">
                        {t('welcome', { name: user.email.split('@')[0] })}
                    </h1>
                    <p className="text-muted-foreground mt-1 text-sm md:text-base">{t('subtitle')}</p>
                </div>
                <Link href="/dashboard/new-audit" className="w-full md:w-auto">
                    <Button className="w-full md:w-auto gradient-bg text-white border-0 shadow-lg shadow-primary/20 hover:opacity-90">
                         <Plus className="w-4 h-4 mr-2" /> {t('new_audit')}
                    </Button>
                </Link>
            </div>

            {/* KPI CARDS */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                <KpiCard
                    label={t('kpi_audits')}
                    value={totalAudits.toString()}
                    icon={Activity}
                    color="text-blue-600 dark:text-blue-400"
                    bg="bg-blue-100 dark:bg-blue-500/10"
                />
                <KpiCard
                    label={t('kpi_seo')}
                    value={avgSeo > 0 ? `${avgSeo}/100` : '-'}
                    icon={BarChart3}
                    color="text-green-600 dark:text-green-400"
                    bg="bg-green-100 dark:bg-green-500/10"
                />
                <KpiCard
                    label={t('kpi_system')}
                    value={t('system_status')}
                    icon={Clock}
                    color="text-purple-600 dark:text-purple-400"
                    bg="bg-purple-100 dark:bg-purple-500/10"
                />
            </div>

            {/* LLISTAT AUDITORIA */}
            {audits.length > 0 ? (
                <div>
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-xl font-bold text-foreground">{t('recent_projects')}</h2>
                        <Link href="/dashboard/audits" className="text-sm text-primary hover:underline font-medium">
                           {t('view_all')}
                        </Link>
                    </div>

                    <div className="grid gap-4 md:gap-6 md:grid-cols-2 lg:grid-cols-3">
                        {audits.slice(0, 6).map((audit) => (
                            <AuditCard key={audit.id} audit={audit} />
                        ))}
                    </div>
                </div>
            ) : (
                /* EMPTY STATE */
                <div className="py-12 flex flex-col items-center justify-center text-center border-2 border-dashed border-border rounded-2xl bg-card/50">
                    <div className="w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4">
                        <Activity className="w-8 h-8 text-muted-foreground" />
                    </div>
                    <h3 className="text-lg font-bold text-foreground mb-2">{t('empty_title')}</h3>
                    <p className="text-muted-foreground mb-6 max-w-sm text-sm">
                        {t('empty_desc')}
                    </p>
                    <Link href="/dashboard/new-audit">
                        <Button variant="outline">{t('empty_button')}</Button>
                    </Link>
                </div>
            )}
        </div>
    );
}

// Helpers es mantenen igual...
type KpiCardProps = {
    label: string;
    value: string;
    icon: React.ComponentType<{ className?: string }>;
    color: string;
    bg: string;
};

function KpiCard({ label, value, icon: Icon, color, bg }: KpiCardProps) {
    return (
        <div className="bg-card dark:bg-[#0f111a]/50 border border-border dark:border-white/5 p-4 md:p-6 rounded-xl md:rounded-2xl shadow-sm flex flex-row md:flex-col items-center md:items-start gap-4 md:gap-0 justify-between md:justify-start transition-colors">
            <div className="flex md:block items-center gap-3 md:gap-0 md:w-full md:mb-4">
                <div className={`p-2.5 md:p-3 rounded-lg md:rounded-xl ${bg} shrink-0`}>
                    <Icon className={`w-5 h-5 md:w-6 md:h-6 ${color}`} />
                </div>
                <span className="text-sm text-muted-foreground md:hidden font-medium">{label}</span>
            </div>
            <div className="text-right md:text-left">
                <div className="text-2xl md:text-3xl font-bold text-foreground">{value}</div>
                <div className="text-sm text-muted-foreground hidden md:block font-medium">{label}</div>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/dashboard/projects/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { Link } from '@/routing';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { FolderGit2, ArrowRight, FlaskConical, Globe, Clock } from 'lucide-react';
import { redirect } from 'next/navigation';

export const metadata = {
  title: 'Els Meus Projectes | DigitAI Studios',
};

export default async function ProjectsListPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) redirect('/auth/login');

  // 1. Obtenim projectes i mirem si tenen tests actius (count)
  const { data: projects } = await supabase
    .from('projects')
    .select(`
      *,
      test_campaigns(count)
    `)
    .eq('client_id', user.id) // O la lÃ²gica de la teva organitzaciÃ³
    .order('created_at', { ascending: false });

  return (
    <div className="space-y-8 p-6 md:p-8">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-foreground flex items-center gap-3">
            <FolderGit2 className="w-8 h-8 text-primary" /> Els Meus Projectes
          </h1>
          <p className="text-muted-foreground mt-1">
            Gestiona les teves aplicacions i participa en les fases de test.
          </p>
        </div>
      </div>

      {!projects || projects.length === 0 ? (
        <div className="py-20 text-center border-2 border-dashed border-border rounded-2xl bg-muted/10">
            <FolderGit2 className="w-16 h-16 mx-auto text-muted-foreground mb-4 opacity-50" />
            <h3 className="text-xl font-medium text-foreground">Encara no tens projectes</h3>
            <p className="text-muted-foreground mt-2 mb-6">Contacta amb nosaltres per comenÃ§ar el teu primer desenvolupament.</p>
            <Link href="/#contacte">
                <Button>SolÂ·licitar Projecte</Button>
            </Link>
        </div>
      ) : (
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {projects.map((project) => {
            // Comprovem si tÃ© tests actius (el count que hem demanat a la query)
            const hasActiveTests = project.test_campaigns?.[0]?.count > 0;

            return (
              <Link key={project.id} href={`/dashboard/projects/${project.id}`} className="group block h-full">
                <Card className="h-full border-border hover:border-primary/50 transition-all duration-300 hover:shadow-lg hover:-translate-y-1 relative overflow-hidden">
                  
                  {/* Indicador Beta si hi ha tests */}
                  {hasActiveTests && (
                    <div className="absolute top-0 right-0 bg-purple-600 text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl shadow-sm z-10 flex items-center gap-1">
                        <FlaskConical className="w-3 h-3" /> BETA DISPONIBLE
                    </div>
                  )}

                  <CardHeader className="pb-4">
                    <div className="flex justify-between items-start mb-2">
                        <div className={`p-2.5 rounded-lg ${hasActiveTests ? 'bg-purple-100 dark:bg-purple-900/20 text-purple-600' : 'bg-blue-100 dark:bg-blue-900/20 text-blue-600'}`}>
                            <FolderGit2 className="w-6 h-6" />
                        </div>
                    </div>
                    <CardTitle className="text-xl font-bold group-hover:text-primary transition-colors">
                        {project.name}
                    </CardTitle>
                    <div className="flex items-center gap-2 text-xs text-muted-foreground font-mono mt-1">
                        <Globe className="w-3 h-3" /> {project.domain || 'configurant...'}
                    </div>
                  </CardHeader>

                  <CardContent>
                    <div className="flex items-center justify-between mt-4 pt-4 border-t border-border">
                        <span className={`px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider 
                            ${project.status === 'active' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 
                              project.status === 'maintenance' ? 'bg-orange-100 text-orange-700' : 
                              'bg-slate-100 text-slate-600'}
                        `}>
                            {project.status || 'PENDENT'}
                        </span>
                        
                        <span className="text-xs text-muted-foreground flex items-center gap-1">
                            <Clock className="w-3 h-3" /> 
                            {new Date(project.created_at || new Date()).toLocaleDateString()}
                        </span>
                    </div>
                  </CardContent>
                </Card>
              </Link>
            );
          })}
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/app/[locale]/dashboard/projects/[id]/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { notFound, redirect } from 'next/navigation';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { TaskRunner } from '@/features/tests/ui/TaskRunner';
import { FlaskConical, LayoutDashboard, Info, Github, Globe } from 'lucide-react';

type Props = {
  params: Promise<{ id: string }>
}

export default async function ProjectDetailPage({ params }: Props) {
  const { id } = await params;
  const supabase = await createClient();
  
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/auth/login');

  // 1. INFO DEL PROJECTE
  const { data: project } = await supabase
    .from('projects')
    .select('*')
    .eq('id', id)
    .single();

  if (!project) return notFound();

  // 2. INFO DELS TESTS (TestFlow)
  // Busquem la primera campanya activa
  const { data: campaign } = await supabase
    .from('test_campaigns')
    .select('id')
    .eq('project_id', id)
    .eq('status', 'active')
    .single();

  // Carreguem dades del test si n'hi ha
  const repo = new SupabaseTestRepository();
  const { tasks, results, campaign: campDetails } = campaign 
    ? await repo.getCampaignWithContext(campaign.id, user.id)
    : { tasks: [], results: [], campaign: null };

  // MÃ¨triques de test
  const completed = results.filter(r => r.status === 'pass').length;
  const totalTasks = tasks.length;
  const percent = totalTasks > 0 ? Math.round((completed / totalTasks) * 100) : 0;

  return (
    <div className="space-y-6 pb-20 p-6 md:p-8">
      
      {/* CAPÃ‡ALERA */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-2">
        <div>
            <h1 className="text-3xl font-bold text-foreground">{project.name}</h1>
            <a href={`https://${project.domain}`} target="_blank" className="text-muted-foreground text-sm hover:text-primary transition-colors flex items-center gap-1">
                <Globe className="w-3 h-3" /> {project.domain}
            </a>
        </div>
        <div className="bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">
            {project.status || 'Active'}
        </div>
      </div>

      {/* PESTANYES */}
      <Tabs defaultValue="qa" className="w-full">
        <TabsList className="w-full justify-start border-b border-border bg-transparent p-0 h-auto rounded-none mb-6">
          <TabsTrigger 
            value="qa" 
            className="data-[state=active]:border-b-2 data-[state=active]:border-primary data-[state=active]:shadow-none rounded-none px-4 py-3 text-sm"
          >
            <FlaskConical className="w-4 h-4 mr-2" /> QA & Testing
            {campDetails && (
                <span className="ml-2 bg-muted text-[10px] px-1.5 py-0.5 rounded-full font-mono">
                    {percent}%
                </span>
            )}
          </TabsTrigger>
          <TabsTrigger 
            value="info" 
            className="data-[state=active]:border-b-2 data-[state=active]:border-primary data-[state=active]:shadow-none rounded-none px-4 py-3 text-sm"
          >
            <LayoutDashboard className="w-4 h-4 mr-2" /> Detalls TÃ¨cnics
          </TabsTrigger>
        </TabsList>

        {/* --- PESTANYA QA (Testing) --- */}
        <TabsContent value="qa" className="animate-in fade-in slide-in-from-bottom-2 duration-500">
            {!campDetails ? (
                <div className="text-center py-16 bg-muted/10 rounded-xl border border-dashed border-border">
                    <Info className="w-12 h-12 mx-auto text-muted-foreground mb-4 opacity-50" />
                    <h3 className="font-medium text-foreground text-lg">No hi ha proves actives</h3>
                    <p className="text-sm text-muted-foreground mt-2 max-w-sm mx-auto">
                        Actualment no hi ha cap fase de beta testing oberta per a aquest projecte. RebrÃ s una notificaciÃ³ quan n'hi hagi.
                    </p>
                </div>
            ) : (
                <div className="max-w-4xl">
                    {/* Test Info Card */}
                    <div className="mb-8 bg-card border border-border p-6 rounded-xl shadow-sm">
                        <div className="flex justify-between items-start mb-4">
                            <h2 className="text-xl font-bold text-foreground">{campDetails.title}</h2>
                            <span className="text-xs font-mono text-muted-foreground bg-muted px-2 py-1 rounded">BETA</span>
                        </div>
                        
                        {/* Progress Bar */}
                        <div className="flex items-center gap-4 text-xs font-medium mb-4 text-muted-foreground">
                            <div className="flex-1 bg-muted rounded-full h-2 overflow-hidden">
                                <div className="bg-primary h-full transition-all duration-700 ease-out" style={{ width: `${percent}%` }}></div>
                            </div>
                            <span>{completed} de {totalTasks} tasques</span>
                        </div>
                        
                        {/* Instruccions */}
                        {campDetails.instructions && (
                            <div className="bg-blue-50/50 dark:bg-blue-900/10 p-4 rounded-lg text-sm text-blue-800 dark:text-blue-200 leading-relaxed border border-blue-100 dark:border-blue-800/50 flex gap-3 items-start">
                                <Info className="w-5 h-5 shrink-0 mt-0.5 text-blue-600 dark:text-blue-400" />
                                <div>
                                    <strong className="block mb-1 font-semibold">Instruccions de la prova:</strong>
                                    <p className="whitespace-pre-wrap opacity-90">{campDetails.instructions}</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Task List */}
                    <div className="space-y-4">
                        <h3 className="text-sm font-bold text-muted-foreground uppercase tracking-wider px-1 mb-4">
                            Llista de VerificaciÃ³
                        </h3>
                        {tasks.map((task) => {
                            const result = results.find(r => r.taskId === task.id);
                            return (
                                <TaskRunner 
                                    key={task.id}
                                    task={task}
                                    existingResult={result}
                                />
                            );
                        })}
                        {tasks.length === 0 && (
                            <p className="text-muted-foreground text-center py-8">No s'han trobat tasques.</p>
                        )}
                    </div>
                </div>
            )}
        </TabsContent>

        {/* --- PESTANYA INFO (General) --- */}
        <TabsContent value="info" className="space-y-6">
            <div className="grid md:grid-cols-2 gap-6">
                <Card>
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                            <Github className="w-5 h-5" /> Repositori
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="text-sm">
                        {project.repository_url ? (
                            <a href={project.repository_url} target="_blank" className="text-primary hover:underline break-all">
                                {project.repository_url}
                            </a>
                        ) : (
                            <span className="text-muted-foreground">No connectat</span>
                        )}
                    </CardContent>
                </Card>
                
                <Card>
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                            <Globe className="w-5 h-5" /> Allotjament
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="text-sm">
                        <div className="flex justify-between py-2 border-b border-border/50">
                            <span className="text-muted-foreground">Provider</span>
                            <span>Vercel</span>
                        </div>
                        <div className="flex justify-between py-2">
                            <span className="text-muted-foreground">Status</span>
                            <span className="text-green-500 font-bold">â— Online</span>
                        </div>
                    </CardContent>
                </Card>
            </div>
        </TabsContent>
      </Tabs>
    </div>
  );
}

// =================== FILE: src/app/[locale]/layout.tsx ===================

import { NextIntlClientProvider } from 'next-intl';
import { getMessages } from 'next-intl/server';
import { notFound } from 'next/navigation';
import { routing, type Locale } from '@/routing';
import { Inter } from 'next/font/google';
import { ThemeProvider } from "@/components/theme-provider";
import "@/app/globals.css";
import type { Metadata, Viewport } from 'next';
import { Toaster } from 'sonner';

// ğŸ‘‡ 1. IMPORTACIONS NOVES
import { Suspense } from 'react';
import { AnalyticsTracker } from '@/features/analytics/ui/AnalyticsTracker';

const inter = Inter({
  subsets: ['latin'],
  variable: '--font-inter',
  display: 'swap',
});

// 1. CONFIGURACIÃ“ DEL VIEWPORT
export const viewport: Viewport = {
  themeColor: [
    { media: '(prefers-color-scheme: light)', color: 'white' },
    { media: '(prefers-color-scheme: dark)', color: '#020817' },
  ],
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
};

// 2. METADADES GLOBALS
export const metadata: Metadata = {
  title: {
    default: 'DigitAI Studios | Desenvolupament Web & IA',
    template: '%s | DigitAI Studios'
  },
  description: 'Transformem negocis amb AppWebs, Apps Natives i AutomatitzaciÃ³ IA. Solucions digitals 360Â°.',
  keywords: ['Desenvolupament Web', 'App', 'React Native', 'Next.js', 'IA', 'AutomatitzaciÃ³', 'Girona'],
  authors: [{ name: 'DigitAI Studios' }],
  creator: 'DigitAI Studios',
  manifest: '/manifest.webmanifest',
  icons: {
    icon: '/icons/icon-192.png',
    shortcut: '/icons/icon-192.png',
    apple: '/icons/apple-icon.png',
    other: {
      rel: 'apple-touch-icon-precomposed',
      url: '/icons/apple-icon.png',
    },
  },
  openGraph: {
    type: 'website',
    locale: 'ca_ES',
    url: 'https://digitaistudios.com',
    title: 'DigitAI Studios | InnovaciÃ³ Digital',
    description: 'Apps, Webs i AutomatitzaciÃ³ IA per a empreses modernes.',
    siteName: 'DigitAI Studios',
    images: [
      {
        url: '/images/og-image.jpg', // Nota: Millor ruta pÃºblica directa que '@/assets'
        width: 1200,
        height: 630,
        alt: 'DigitAI Studios Cover',
      },
    ],
  },
};

export default async function LocaleLayout({
  children,
  params
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;

  if (!routing.locales.includes(locale as Locale)) {
    notFound();
  }

  const messages = await getMessages();

  return (
    <html lang={locale} className={inter.variable} suppressHydrationWarning>
      <body className="antialiased bg-background text-foreground overflow-x-hidden transition-colors duration-300">
        <NextIntlClientProvider messages={messages}>
          <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
          >
            <Suspense fallback={null}>
              <AnalyticsTracker />
            </Suspense>

            {/* ğŸ”” SONNER GLOBAL */}
            <Toaster richColors closeButton />

            {children}
          </ThemeProvider>
        </NextIntlClientProvider>
      </body>
    </html>
  );
}

// =================== FILE: src/components/admin/AminMobileMenu.tsx ===================

'use client';

import { Link, usePathname } from '@/routing';
import { LayoutDashboard, BarChart3, Users, Home , BookOpenCheck, FlaskConical} from 'lucide-react';
import { cn } from '@/lib/utils';

export function AdminBottomNav() {
  const pathname = usePathname();

  const navLinks = [
    {
      href: '/admin',
      label: 'Inici',
      icon: LayoutDashboard
    },
    {
      href: '/admin/analytics',
      label: 'MÃ¨triques',
      icon: BarChart3
    },
    {
      href: '/admin/users',
      label: 'Usuaris',
      icon: Users
    },
    {
      href: '/admin/blog',
      label: 'Blog',
      icon: BookOpenCheck
    },
    {
      href: '/admin/tests',
      label: 'Tests',
      icon: FlaskConical // Icona de laboratori
    },
  ];

  return (
    <div className="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-slate-950 border-t border-slate-800 pb-safe">
      <nav className="flex items-center justify-around h-16">
        {navLinks.map((link) => {
          const Icon = link.icon;
          // Comprovem si la ruta coincideix exactament o si Ã©s una subruta
          const isActive = pathname === link.href;

          return (
            <Link
              key={link.href}
              href={link.href}
              className={cn(
                "flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors duration-200",
                isActive
                  ? "text-blue-400"
                  : "text-slate-500 hover:text-slate-300"
              )}
            >
              <Icon className={cn("w-6 h-6", isActive && "fill-current/20")} />
              <span className="text-[10px] font-medium">{link.label}</span>
            </Link>
          );
        })}

        {/* BotÃ³ separat per tornar a la web pÃºblica */}
        <Link
          href="/"
          className="flex flex-col items-center justify-center w-full h-full space-y-1 text-slate-600 hover:text-slate-400"
        >
          <Home className="w-6 h-6" />
          <span className="text-[10px] font-medium">Web</span>
        </Link>
      </nav>
    </div>
  );
}

// =================== FILE: src/components/charts/ScoreRing.tsx ===================

'use client';
import { RadialBarChart, RadialBar, PolarAngleAxis, ResponsiveContainer } from 'recharts';

export function ScoreRing({ score, label }: { score: number; label: string }) {
  // Color dinÃ mic
  const color = score >= 90 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
  
  const data = [{ name: 'Score', value: score, fill: color }];

  return (
    <div className="flex flex-col items-center justify-center w-full h-full">
        <div className="relative w-[120px] h-[120px]">
            <ResponsiveContainer width="100%" height="100%">
                <RadialBarChart 
                    innerRadius="80%" 
                    outerRadius="100%" 
                    barSize={10} 
                    data={data} 
                    startAngle={90} 
                    endAngle={-270}
                >
                    <PolarAngleAxis type="number" domain={[0, 100]} angleAxisId={0} tick={false} />
                    <RadialBar background dataKey="value" cornerRadius={10} />
                </RadialBarChart>
            </ResponsiveContainer>
            {/* Text al centre */}
            <div className="absolute inset-0 flex items-center justify-center">
                <span className="text-3xl font-bold" style={{ color }}>{score}</span>
            </div>
        </div>
        <p className="mt-2 text-sm font-medium text-slate-500 uppercase tracking-wider">{label}</p>
    </div>
  );
}

// =================== FILE: src/components/dashboard/AuditCard.tsx ===================

'use client';

import { Link } from '@/routing';
import { Card, CardContent } from '@/components/ui/card';
import { ArrowRight, Globe } from 'lucide-react';

type AuditProps = {
  id: string;
  url: string;
  status: 'processing' | 'completed' | 'failed';
  seoScore: number | null;
  createdAt: string | Date;
};

export function AuditCard({ audit }: { audit: AuditProps }) {
  return (
    <Link href={`/dashboard/audits/${audit.id}`} className="block group h-full">
      {/* Estil Fosc + Light Adaptable (bg-card en light, fons fosc en dark) */}
      <Card className="bg-card dark:bg-[#0f111a]/50 border border-border dark:border-white/5 hover:border-primary/50 transition-all h-full shadow-sm hover:shadow-md group-hover:-translate-y-1 backdrop-blur-sm">
        <CardContent className="p-6 flex flex-col h-full">
          
          {/* Header Card */}
          <div className="flex justify-between items-start mb-4">
            <div className="p-2.5 bg-muted dark:bg-white/5 rounded-lg text-muted-foreground group-hover:text-primary group-hover:bg-primary/10 transition-colors">
              <Globe className="w-5 h-5" />
            </div>
            <StatusBadge status={audit.status} />
          </div>

          {/* Body Card */}
          <div className="flex-grow">
            <h3 className="text-lg font-bold text-foreground dark:text-white truncate mb-1" title={audit.url}>
              {audit.url.replace(/^https?:\/\//, '').replace(/\/$/, '')}
            </h3>
            <p className="text-xs text-muted-foreground dark:text-slate-500 mb-6">
              {new Date(audit.createdAt).toLocaleDateString()}
            </p>
          </div>

          {/* Footer Card */}
          <div className="mt-auto flex items-center justify-between pt-4 border-t border-border dark:border-white/5">
            <div className="flex flex-col">
              <span className="text-[10px] uppercase tracking-wider text-muted-foreground font-bold">SEO SCORE</span>
              <span className={`text-xl font-bold ${getScoreColor(audit.seoScore ?? 0)}`}>
                {audit.seoScore ?? '-'}
              </span>
            </div>
            <div className="w-8 h-8 rounded-full bg-muted dark:bg-white/5 flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-all text-muted-foreground">
              <ArrowRight className="w-4 h-4" />
            </div>
          </div>
        </CardContent>
      </Card>
    </Link>
  );
}

// Helpers locals
function StatusBadge({ status }: { status: string }) {
  const styles = {
    completed: 'text-green-600 bg-green-100 border-green-200 dark:text-green-400 dark:bg-green-500/10 dark:border-green-500/20',
    processing: 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-400 dark:bg-blue-500/10 dark:border-blue-500/20 animate-pulse',
    failed: 'text-red-600 bg-red-100 border-red-200 dark:text-red-400 dark:bg-red-500/10 dark:border-red-500/20'
  };
  const label = status === 'completed' ? 'Completada' : status === 'processing' ? 'Analitzant' : 'Error';

  return (
    <span className={`px-2.5 py-1 rounded-full text-[10px] uppercase font-bold tracking-wider border ${styles[status as keyof typeof styles] || 'text-muted-foreground bg-muted border-border'}`}>
      {label}
    </span>
  );
}

function getScoreColor(score: number) {
  if (score >= 90) return 'text-green-600 dark:text-green-400';
  if (score >= 50) return 'text-yellow-600 dark:text-yellow-400';
  return 'text-red-600 dark:text-red-400';
}

// =================== FILE: src/components/dashboard/DashboardHeader.tsx ===================

'use client';

import { Bell, Search } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { ThemeToggle } from '@/components/ui/theme-toggle';
import { useTranslations } from 'next-intl';
import { LanguageSwitcher } from '../layout/LanguageSwitcher';
export function DashboardHeader({ userEmail }: { userEmail?: string }) {
   const t = useTranslations('DashboardHeader');

   return (
      <header className="h-16 border-b border-border bg-background/80 backdrop-blur-xl sticky top-0 z-30 px-4 md:px-6 flex items-center justify-between transition-colors duration-300">

         <div className="flex items-center w-full max-w-xs md:max-w-md mr-4">
            <div className="relative w-full">
               <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
               <Input
                  placeholder={t('search_placeholder')}
                  className="pl-10 bg-muted/50 border-transparent focus:bg-background focus:border-primary transition-all h-9 rounded-full"
               />
            </div>
         </div>

         <div className="flex items-center gap-2 md:gap-4 shrink-0">
            <LanguageSwitcher />
            <ThemeToggle />

            <Button variant="ghost" size="icon" className="relative rounded-full text-muted-foreground hover:text-foreground">
               <Bell className="w-5 h-5" />
               <span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-background"></span>
            </Button>

            <div className="h-6 w-px bg-border mx-1 hidden sm:block"></div>

            <div className="flex items-center gap-3">
               <div className="text-right hidden md:block">
                  <p className="text-sm font-medium text-foreground leading-none">{t('account')}</p>
                  <p className="text-xs text-muted-foreground truncate max-w-[120px]">{userEmail}</p>
               </div>
               <div className="w-9 h-9 rounded-full bg-linear-to-br from-primary to-blue-500 flex items-center justify-center text-white font-bold shadow-lg ring-2 ring-background">
                  {userEmail ? userEmail.charAt(0).toUpperCase() : 'U'}
               </div>
            </div>
         </div>
      </header>
   );
}

// =================== FILE: src/components/dashboard/Sidebar.tsx ===================

'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
// ğŸ‘‡ CANVI: SubstituÃ¯m 'FlaskConical' per 'Beaker' (o 'TestTube2')
import { LayoutDashboard, FileText, FolderKanban, Settings, LogOut, Sparkles, ShieldAlert } from 'lucide-react';
import { cn } from '@/lib/utils';
import { createClient } from '@/lib/supabase/client';
import { useRouter } from '@/routing';
import { useTranslations } from 'next-intl';

interface SidebarProps {
  userRole: 'admin' | 'client' | 'lead';
}

export function Sidebar({ userRole }: SidebarProps) {
  // ... (resta del codi igual: hooks, handleSignOut, handleClick...)
  const t = useTranslations('Sidebar');
  const pathname = usePathname();
  const router = useRouter();
  const supabase = createClient();

  const handleSignOut = async () => {
    await supabase.auth.signOut();
    router.refresh();
    router.push('/auth/login');
  };

  const handleClick = (e: React.MouseEvent, href: string, label: string) => {
    if (href.startsWith('#')) {
      e.preventDefault();
      alert(`${label} estarÃ  disponible properament! ğŸš€`);
    }
  };

  const cleanPath = pathname.replace(/^\/[a-z]{2}/, '') || '/';

  const MENU_ITEMS = [
    { icon: LayoutDashboard, label: t('summary'), href: '/dashboard' },
    // ğŸ‘‡ Canviem 'Projectes' perquÃ¨ apunti al llistat
    { icon: FolderKanban, label: t('projects'), href: '/dashboard/projects' },
    { icon: FileText, label: t('audits'), href: '/dashboard/audits' },
    // ğŸ‘‡ Canviem la icona aquÃ­ tambÃ©
   
    { icon: Settings, label: t('settings'), href: '#config' },
  ];

  if (userRole === 'admin') {
    MENU_ITEMS.unshift({ 
      icon: ShieldAlert,
      label: 'Admin Panel',
      href: '/admin'
    });
  }

  return (
    <aside className="w-64 h-screen bg-card border-r border-border flex flex-col sticky top-0 transition-colors duration-300">
      {/* ... (resta del renderitzat igual) ... */}
      
      {/* LOGO AREA */}
      <div className="p-6 border-b border-border">
        <Link href="/" className="flex items-center gap-2 text-xl font-bold text-foreground">
          DigitAI <span className="text-primary">Hub</span>
        </Link>
      </div>

      {/* NAVIGATION */}
      <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
        <div className="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-4 px-2">
          {t('platform')}
        </div>

        {MENU_ITEMS.map((item) => {
          let isActive = false;
          
          if (!item.href.startsWith('#')) {
            // LÃ²gica simple: si estem a /dashboard/projects (o fills), marquem actiu Projectes O QA
            // AixÃ² Ã©s un petit truc visual
            if (item.href === '/dashboard') {
               isActive = cleanPath === '/dashboard';
            } else {
               isActive = cleanPath.startsWith(item.href);
            }
          }
          
          const isAdminItem = item.href === '/admin';
          
          return (
            <Link
              key={item.label}
              href={item.href}
              onClick={(e) => item.href.startsWith('#') && handleClick(e, item.href, item.label)}
              className={cn(
                "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200",
                isActive
                  ? "bg-primary/10 text-primary border border-primary/20 shadow-sm"
                  : "text-muted-foreground hover:text-foreground hover:bg-muted",
                (isAdminItem && !isActive) && "text-red-500 hover:text-red-600 hover:bg-red-500/10"
              )}
            >
              <item.icon className={cn("w-5 h-5", isActive ? "text-primary" : "text-current")} />
              {item.label}
            </Link>
          );
        })}

        {userRole !== 'admin' && (
          <div className="mt-8 p-4 rounded-xl bg-linear-to-br from-primary/10 to-blue-500/10 border border-primary/20 relative overflow-hidden">
            <div className="absolute top-0 right-0 w-20 h-20 bg-primary/20 blur-2xl rounded-full pointer-events-none"></div>
            <div className="flex items-center gap-2 text-foreground font-bold text-sm mb-2">
              <Sparkles className="w-4 h-4 text-primary" />
              {t('pro_badge')}
            </div>
            <p className="text-xs text-muted-foreground mb-3">{t('pro_text')}</p>
            <button className="w-full py-1.5 text-xs font-bold bg-primary text-primary-foreground rounded-lg hover:opacity-90 transition-opacity">
              {t('pro_button')}
            </button>
          </div>
        )}
      </nav>

      {/* FOOTER */}
      <div className="p-4 border-t border-border">
        <button onClick={handleSignOut} className="flex items-center gap-3 w-full px-3 py-2.5 rounded-lg text-sm font-medium text-muted-foreground hover:text-red-500 hover:bg-red-500/10 transition-colors">
          <LogOut className="w-5 h-5" />
          {t('logout')}
        </button>
      </div>
    </aside>
  );
}

// =================== FILE: src/components/landing/AuditSection.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { AuditForm } from '@/features/audit/ui/AuditForm';
import { useTranslations } from 'next-intl';

export function AuditSection() {
  const t = useTranslations('AuditSection');

  return (
    <section id="audit" className="py-14 relative overflow-hidden bg-background transition-colors duration-300">
      
      {/* FONS DECORATIU */}
      <div className="absolute inset-0 bg-linear-to-b from-transparent via-primary/5 to-transparent pointer-events-none" />
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-blue-500/10 dark:bg-primary/10 blur-[120px] rounded-full pointer-events-none opacity-50" />

      <div className="container mx-auto px-4 relative z-10">
        
        <div className="max-w-3xl mx-auto text-center mb-12">
          <motion.div 
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
          >
            <h2 className="text-3xl lg:text-5xl font-bold mb-6 text-foreground leading-tight">
              {t('title_prefix')} <span className="text-red-500/80 line-through decoration-2">{t('title_cost')}</span> {t('title_connector')} <span className="gradient-text">{t('title_investment')}</span>?
            </h2>
            
            <p className="text-lg text-muted-foreground leading-relaxed">
              {t('description_stat')}
              <br className="hidden md:block" />
              {t('description_cta')}
            </p>
          </motion.div>
        </div>

        {/* FORMULARI */}
        <motion.div 
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true }}
          transition={{ delay: 0.2 }}
          className="max-w-xl mx-auto transform hover:scale-[1.01] transition-transform duration-500"
        >
          <AuditForm />
        </motion.div>

      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/BenefitsSection.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { 
  Clock, 
  TrendingUp, 
  Zap, 
  Target, 
  Share2, 
  BrainCircuit 
} from 'lucide-react';

const BENEFITS = [
  {
    icon: Clock,
    title: 'Estalvi de temps',
    description: 'Automatitza tasques repetitives i allibera fins a 40 hores setmanals per centrar-te en el que realment importa.'
  },
  {
    icon: TrendingUp,
    title: 'Productivitat x3',
    description: "Incrementa l'eficiÃ¨ncia del teu equip amb processos intelÂ·ligents i fluxos de treball sense errors."
  },
  {
    icon: Zap,
    title: 'Respostes 24/7',
    description: 'Chatbots intelÂ·ligents que atenen els teus clients a qualsevol hora, sense descans i amb precisiÃ³.'
  },
  {
    icon: Target,
    title: 'AdaptaciÃ³ a mida',
    description: "No et donem una plantilla. La nostra IA s'entrena amb les dades especÃ­fiques del teu negoci."
  },
  {
    icon: Share2,
    title: 'MÃ rqueting Autopilot',
    description: 'GeneraciÃ³ i publicaciÃ³ de contingut a xarxes socials de forma autÃ²noma i estratÃ¨gica.'
  },
  {
    icon: BrainCircuit,
    title: 'Decisions amb Dades',
    description: 'AnalÃ­tica predictiva per anticipar-te a les tendÃ¨ncies del mercat i prendre millors decisions.'
  }
];

export function BenefitsSection() {
  return (
    <section id="beneficis" className="py-24 relative overflow-hidden">
      {/* Element decoratiu de fons */}
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-primary/5 rounded-full blur-3xl -z-10" />

      <div className="container mx-auto px-4">
        {/* CapÃ§alera de secciÃ³ */}
        <motion.div 
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true, margin: "-100px" }}
          className="text-center mb-16 max-w-3xl mx-auto"
        >
          <h2 className="text-4xl lg:text-5xl font-bold mb-6">
            Beneficis de la <span className="gradient-text">Nova Era</span>
          </h2>
          <p className="text-xl text-muted-foreground">
            La tecnologia no ha de ser complicada. Descobreix com simplifiquem el teu dia a dia.
          </p>
        </motion.div>
        
        {/* Graella de beneficis */}
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {BENEFITS.map((benefit, index) => (
            <motion.div
              key={index}
              initial={{ opacity: 0, y: 30 }}
              whileInView={{ opacity: 1, y: 0 }}
              viewport={{ once: true }}
              transition={{ delay: index * 0.1 }}
              whileHover={{ y: -5 }}
              className="solution-card-futuristic p-8 rounded-3xl flex flex-col items-center text-center group"
            >
              <div className="benefit-icon group-hover:scale-110 transition-transform duration-300">
                <benefit.icon className="h-8 w-8 text-white" />
              </div>
              <h3 className="text-xl font-bold mb-3">{benefit.title}</h3>
              <p className="text-muted-foreground leading-relaxed">
                {benefit.description}
              </p>
            </motion.div>
          ))}
        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/ContactSection.tsx ===================

'use client';

import { useActionState, useState } from 'react';
import { submitContactForm } from '@/actions/contact';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Checkbox } from '@/components/ui/checkbox';
import { Link } from '@/routing';
import { Loader2, Send, Bot, Code2, Rocket, Shield, Users } from 'lucide-react';
import { motion } from 'framer-motion';
import { useTranslations } from 'next-intl';

export function ContactSection() {
  const t = useTranslations('ContactSection');
  const [state, action, isPending] = useActionState(submitContactForm, { success: false });
  const [serviceType, setServiceType] = useState('ia'); // 'ia' o 'web'
  
  // Estat del checkbox
  const [termsAccepted, setTermsAccepted] = useState(false);

  return (
    <section id="contacte" className="py-24 bg-background relative overflow-hidden transition-colors duration-300">
      
      {/* Fons decoratiu */}
      <div className="absolute top-0 left-0 w-full h-full bg-linear-to-b from-transparent via-primary/5 to-transparent pointer-events-none" />

      <div className="container mx-auto px-4 grid lg:grid-cols-2 gap-16 items-start relative z-10">
        
        {/* COLUMNA ESQUERRA: Text i Punts */}
        <motion.div 
          initial={{ opacity: 0, x: -20 }} 
          whileInView={{ opacity: 1, x: 0 }} 
          viewport={{ once: true }}
          className="space-y-10"
        >
           <div>
             <h2 className="text-4xl lg:text-5xl font-bold mb-6 text-foreground leading-tight">
               {t('title_prefix')} <span className="gradient-text">{t('title_highlight')}</span>
             </h2>
             <p className="text-muted-foreground text-lg leading-relaxed max-w-lg">
               {t('description')}
             </p>
           </div>

           <div className="space-y-8">
              {[
                { icon: Rocket, title: t('features.agile.title'), desc: t('features.agile.desc') },
                { icon: Shield, title: t('features.tech.title'), desc: t('features.tech.desc') },
                { icon: Users, title: t('features.partners.title'), desc: t('features.partners.desc') }
              ].map((item, i) => (
                <div key={i} className="flex gap-5 items-start group">
                  <div className="mt-1 w-12 h-12 rounded-2xl bg-primary/10 border border-primary/20 flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform">
                    <item.icon className="w-6 h-6 text-primary" />
                  </div>
                  <div>
                    <h3 className="font-bold text-foreground text-xl mb-1">{item.title}</h3>
                    <p className="text-muted-foreground leading-relaxed">{item.desc}</p>
                  </div>
                </div>
              ))}
           </div>
        </motion.div>

        {/* COLUMNA DRETA: Formulari Adaptable */}
        <motion.div 
           initial={{ opacity: 0, x: 20 }} 
           whileInView={{ opacity: 1, x: 0 }} 
           viewport={{ once: true }}
           className="bg-card border border-border rounded-3xl p-8 lg:p-10 shadow-2xl relative overflow-hidden"
        >
          {/* Glow interior */}
          <div className="absolute top-0 right-0 w-64 h-64 bg-primary/10 blur-[80px] rounded-full pointer-events-none"></div>

          <form action={action} className="space-y-6 relative z-10">
            
            {/* SELECTOR TIPUS (TOGGLE) */}
            <div className="grid grid-cols-2 gap-4 mb-8">
               <button
                  type="button"
                  onClick={() => setServiceType('ia')}
                  className={`p-4 rounded-xl border transition-all flex flex-col items-center gap-3 ${
                    serviceType === 'ia' 
                      ? 'border-primary bg-primary/10 text-primary ring-1 ring-primary shadow-inner' 
                      : 'border-border bg-muted/30 text-muted-foreground hover:bg-muted/50 hover:border-primary/30'
                  }`}
               >
                  <Bot className="w-7 h-7" />
                  <span className="font-bold text-sm">{t('options.ia')}</span>
               </button>
               <button
                  type="button"
                  onClick={() => setServiceType('web')}
                  className={`p-4 rounded-xl border transition-all flex flex-col items-center gap-3 ${
                    serviceType === 'web' 
                      ? 'border-primary bg-primary/10 text-primary ring-1 ring-primary shadow-inner' 
                      : 'border-border bg-muted/30 text-muted-foreground hover:bg-muted/50 hover:border-primary/30'
                  }`}
               >
                  <Code2 className="w-7 h-7" />
                  <span className="font-bold text-sm">{t('options.web')}</span>
               </button>
               <input type="hidden" name="service" value={serviceType === 'ia' ? 'AutomatitzaciÃ³ i IA' : 'CreaciÃ³ Web'} />
            </div>

            {/* INPUTS */}
            <div className="space-y-5">
              <div className="space-y-2">
                <label className="text-sm font-bold text-foreground ml-1">{t('form.name_label')}</label>
                <Input 
                  name="fullName" 
                  placeholder={t('form.name_placeholder')} 
                  required 
                  className="bg-background border-input focus:border-primary h-12 text-foreground placeholder:text-muted-foreground/50" 
                />
              </div>
              
              <div className="space-y-2">
                 <label className="text-sm font-bold text-foreground ml-1">{t('form.email_label')}</label>
                 <Input 
                   name="email" 
                   type="email" 
                   placeholder={t('form.email_placeholder')} 
                   required 
                   className="bg-background border-input focus:border-primary h-12 text-foreground placeholder:text-muted-foreground/50" 
                 />
              </div>

              <div className="space-y-2">
                 <label className="text-sm font-bold text-foreground ml-1">{t('form.message_label')}</label>
                 <textarea 
                   name="message" 
                   rows={4} 
                   placeholder={t('form.message_placeholder')}
                   className="w-full rounded-lg border border-input bg-background px-4 py-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none placeholder:text-muted-foreground/50"
                 />
              </div>
            </div>

            {/* CHECKBOX LEGAL CONTROLAT */}
            <div className="flex items-start space-x-3 pt-2">
              <Checkbox 
                id="privacy-contact" 
                name="privacy" 
                value="on" 
                checked={termsAccepted}
                onCheckedChange={(checked) => setTermsAccepted(checked as boolean)}
                required 
                className="mt-1 border-muted-foreground/30 data-[state=checked]:bg-primary data-[state=checked]:border-primary" 
              />
              <label htmlFor="privacy-contact" className="text-sm text-muted-foreground leading-snug cursor-pointer select-none">
                {t.rich('privacy_text', {
                  link: (chunks) => <Link href="/legal/privacitat" target="_blank" className="underline hover:text-primary transition-colors">{chunks}</Link>
                })}
              </label>
            </div>

            {/* BOTÃ“ AMB ESTAT DISABLED I TOOLTIP */}
            <div className="relative group">
                <Button 
                  type="submit" 
                  // Desactivem si estÃ  enviant (isPending) O si NO ha acceptat termes
                  disabled={isPending || !termsAccepted} 
                  className={`w-full h-14 text-lg font-bold rounded-xl transition-all shadow-lg shadow-primary/25 flex items-center justify-center ${
                     termsAccepted 
                     ? 'gradient-bg text-white hover:opacity-90' 
                     : 'bg-muted text-muted-foreground cursor-not-allowed opacity-60'
                  }`}
                >
                  {isPending ? <Loader2 className="animate-spin mr-2" /> : <Send className="mr-2 w-5 h-5" />}
                  {t('form.submit_button')}
                </Button>
                
                {/* Tooltip flotant si intenten passar per sobre sense acceptar */}
                {!termsAccepted && (
                    <div className="absolute -top-10 left-1/2 -translate-x-1/2 bg-foreground text-background text-xs px-3 py-1.5 rounded-md shadow-xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap font-medium z-20">
                        {t('tooltip_privacy')}
                        <div className="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-foreground rotate-45"></div>
                    </div>
                )}
            </div>

            {state?.message && (
                <motion.div 
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    className={`text-center text-sm font-medium mt-4 p-3 rounded-lg border ${
                        state.success 
                        ? 'bg-green-500/10 border-green-500/20 text-green-600 dark:text-green-400' 
                        : 'bg-red-500/10 border-red-500/20 text-red-600 dark:text-red-400'
                    }`}
                >
                    {state.message}
                </motion.div>
            )}

          </form>
        </motion.div>

      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/HeroSection.tsx ===================

'use client';

import { useState, useRef, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { PlayCircle, Volume2, VolumeX, Pause, Play } from 'lucide-react';
import Image from 'next/image';
import Link from 'next/link';
// ğŸ‘‡ 1. IMPORTAR HOOK DE TRADUCCIÃ“
import { useTranslations } from 'next-intl';

export function HeroSection() {
  // ğŸ‘‡ 2. INICIALITZAR HOOK (Namespace 'Hero' del json)
  const t = useTranslations('Hero');
  const [showVideo, setShowVideo] = useState(true);
  const [isMuted, setIsMuted] = useState(true);
  const [isPlaying, setIsPlaying] = useState(true);
  const videoRef = useRef<HTMLVideoElement>(null);

  // Control de reproducciÃ³ en canviar de pestanya
  useEffect(() => {
    const videoElement = videoRef.current;
    if (!videoElement) return;

    const handleVisibilityChange = () => {
      if (document.hidden && !videoElement.paused) {
        videoElement.pause();
      } else if (!document.hidden && isPlaying) {
        videoElement.play();
      }
    };
    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
  }, [isPlaying]);

  const togglePlay = () => {
    if (!videoRef.current) return;
    if (videoRef.current.paused) {
      videoRef.current.play();
      setIsPlaying(true);
    } else {
      videoRef.current.pause();
      setIsPlaying(false);
    }
  }

  return (
    <section id="inici" className="pt-32 pb-20 min-h-screen flex items-center hero-pattern overflow-hidden relative">

      {/* Element de fons (opcional) */}
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-primary/5 rounded-full blur-[120px] -z-10" />

      <div className="container mx-auto px-4 grid lg:grid-cols-2 gap-16 items-center">

        {/* COLUMNA ESQUERRA: Text */}
        <motion.div
          initial={{ opacity: 0, x: -50 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.8 }}
        >


          {/* ğŸ‘‡ 3. SUBSTITUIR TEXT PLA PER CLAUS t('...') */}
          <h1 className="text-5xl lg:text-7xl font-bold mb-6 leading-tight">
            {t('title_start')} <span className="gradient-text">{t('title_highlight_1')}</span>.<br />
            {t('title_middle')} <span className="text-foreground">{t('title_highlight_2')}</span>.
          </h1>

          <p className="text-xl text-muted-foreground mb-8 leading-relaxed max-w-lg">
            {t('subtitle')}
          </p>
          <div className="flex flex-col sm:flex-row gap-4">
            <Link href="#contacte">
              <Button size="lg" className="...">
                {t('cta_primary')}
              </Button>
            </Link>
            <Link href="#audit">
              <Button variant="outline" size="lg" className="...">
                {t('cta_secondary')}
              </Button>
            </Link>
          </div>
        </motion.div>

        {/* COLUMNA DRETA: Marc del VÃ­deo */}
        <motion.div
          initial={{ opacity: 0, x: 50 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.8, delay: 0.2 }}
          className="relative"
        >
          {/* ğŸ› ï¸ FIX: Ãšs de variables semÃ ntiques (bg-card, border-border)
              AixÃ² farÃ  que agafi el color lila fosc del teu globals.css en Dark Mode
              i el color blanc en Light Mode automÃ ticament.
          */}
          <div className={`relative w-full aspect-video bg-card rounded-xl border border-border shadow-2xl overflow-hidden group transition-colors duration-300 ${!showVideo ? 'animate-floating' : ''}`}>

            {/* Barra superior estil navegador (Ara s'adapta al tema) */}
            <div className="h-8 border-b border-border bg-muted/50 flex items-center px-4 gap-2 z-20 relative transition-colors">
              <div className="w-2.5 h-2.5 rounded-full bg-red-500/50"></div>
              <div className="w-2.5 h-2.5 rounded-full bg-yellow-500/50"></div>
              <div className="w-2.5 h-2.5 rounded-full bg-green-500/50"></div>
              {/* URL Bar */}
              <div className="ml-4 px-3 py-0.5 rounded bg-background/50 text-[10px] text-muted-foreground font-mono border border-border hidden sm:block">
                digitai-studios.app
              </div>
            </div>

            {/* Contingut del VÃ­deo */}
            <div className="relative w-full h-[calc(100%-2rem)] bg-black"> {/* El fons del vÃ­deo sempre negre */}
              {showVideo ? (
                <div className="relative w-full h-full">
                  <video
                    ref={videoRef}
                    className="w-full h-full object-cover"
                    autoPlay
                    muted={isMuted}
                    loop
                    playsInline
                    // ğŸ‘‡ AixÃ² ens ajudarÃ  a saber si falla
                    onError={(e) => console.error("Error carregant vÃ­deo:", e)}
                  >
                    <source src="/videos/hero-video.mp4" type="video/mp4" />
                    {/* Fallback si el format falla */}
                    El teu navegador no suporta vÃ­deos.
                  </video>

                  {/* Controls Overlay */}
                  <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4 backdrop-blur-[2px]">
                    <button onClick={togglePlay} className="text-white hover:scale-110 transition-transform p-4 bg-white/10 rounded-full border border-white/20">
                      {isPlaying ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="currentColor" />}
                    </button>
                    <button onClick={() => setIsMuted(!isMuted)} className="absolute bottom-4 right-4 text-white p-2 bg-black/50 rounded-full hover:bg-black/70 transition-colors">
                      {isMuted ? <VolumeX size={20} /> : <Volume2 size={20} />}
                    </button>
                  </div>
                </div>
              ) : (
                <div className="relative w-full h-full cursor-pointer group-hover:opacity-90 transition-opacity" onClick={() => setShowVideo(true)}>
                  <Image
                    src="/images/hero.webp"
                    alt="Equip divers colÂ·laborant"
                    fill
                    className="object-cover"
                    priority
                  />
                  <div className="absolute inset-0 flex items-center justify-center bg-black/30">
                    <PlayCircle className="w-20 h-20 text-white/80 drop-shadow-lg" />
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Floating Cards (Decoratives) - Adaptades al tema */}
          <div className="absolute -bottom-6 -left-6 bg-card/90 backdrop-blur-md border border-border p-4 rounded-xl flex items-center gap-3 animate-pulse-glow shadow-xl z-30 transition-colors">
            <div className="relative">
              <div className="w-3 h-3 bg-green-500 rounded-full animate-ping absolute opacity-75"></div>
              <div className="w-3 h-3 bg-green-500 rounded-full relative"></div>
            </div>
            <div>
              <div className="text-[10px] text-muted-foreground uppercase font-bold tracking-wider">ESTAT</div>
              <span className="font-medium text-sm text-foreground">Sistemes Operatius</span>
            </div>
          </div>

        </motion.div>

      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/ProblemSolutionsSection.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { Calendar, BarChart3, Smartphone, X, Store, CheckCircle2 } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function ProblemSolutionSection() {
  const t = useTranslations('ProblemSolution');

  return (
    <section className="py-10 container mx-auto px-4 relative overflow-hidden transition-colors duration-300">
      
      <div className="grid lg:grid-cols-2 gap-16 items-center">
        
        {/* 1. TEXT NARRATIU */}
        <motion.div 
          initial={{ opacity: 0, x: -20 }}
          whileInView={{ opacity: 1, x: 0 }}
          viewport={{ once: true }}
        >
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold mb-6 uppercase tracking-wider">
             {t('badge')}
          </div>

          <h2 className="text-4xl lg:text-5xl font-bold mb-6 text-foreground leading-tight">
            {t('title_prefix')} <span className="gradient-text">{t('title_highlight')}</span>, <br />
            {t('title_suffix')}
          </h2>
          
          <p className="text-muted-foreground text-lg mb-8 leading-relaxed">
            {t('description_problem')}
            <br /><br />
            {t.rich('description_solution', {
              strong: (chunks) => <strong className="text-foreground font-semibold">{chunks}</strong>
            })}
          </p>

          <ul className="space-y-4 mb-8">
            {[
              t('benefits.appointments'),
              t('benefits.ecommerce'),
              t('benefits.pwa')
            ].map((item, i) => (
              <li key={i} className="flex items-center gap-3 text-slate-600 dark:text-slate-300 font-medium">
                <CheckCircle2 className="w-5 h-5 text-primary" /> {item}
              </li>
            ))}
          </ul>
        </motion.div>
        
        {/* 2. COMPARATIVA VISUAL */}
        <div className="relative h-[450px] lg:h-[500px] flex items-center justify-center perspective-1000">
          
          {/* --- CARD 1: EL PROBLEMA ("Web Aparador") --- */}
          <motion.div 
            // AnimaciÃ³ suau d'entrada
            initial={{ opacity: 0, rotate: -6, x: -20 }}
            whileInView={{ opacity: 1, rotate: -6, x: -35 }}
            viewport={{ once: true }}
            transition={{ duration: 0.8 }}
            // MIDES: 
            // - MÃ²bil: w-[260px] (lleugerament mÃ©s petit)
            // - Escriptori (md+): w-[280px] (Mida ORIGINAL)
            className="absolute left-4 md:left-0 w-[260px] md:w-[280px] p-6 rounded-2xl border border-slate-200 dark:border-white/5 bg-slate-100/80 dark:bg-[#0f111a]/80 backdrop-blur-sm z-0 grayscale opacity-70"
          >
             <div className="flex items-center gap-2 mb-4 text-slate-500">
                <Store className="w-5 h-5" />
                <span className="font-bold text-sm">{t('visual.problem_card.title')}</span>
             </div>
             <div className="space-y-3">
                <div className="flex items-center justify-between p-3 rounded bg-white dark:bg-white/5 border border-slate-200 dark:border-white/5 shadow-sm dark:shadow-none">
                   <span className="text-xs text-slate-500">{t('visual.problem_card.item1')}</span>
                   <X className="w-4 h-4 text-red-500" />
                </div>
                <div className="flex items-center justify-between p-3 rounded bg-white dark:bg-white/5 border border-slate-200 dark:border-white/5 shadow-sm dark:shadow-none">
                   <span className="text-xs text-slate-500">{t('visual.problem_card.item2')}</span>
                   <X className="w-4 h-4 text-red-500" />
                </div>
                <div className="flex items-center justify-between p-3 rounded bg-white dark:bg-white/5 border border-slate-200 dark:border-white/5 shadow-sm dark:shadow-none">
                   <span className="text-xs text-slate-500">{t('visual.problem_card.item3')}</span>
                   <X className="w-4 h-4 text-red-500" />
                </div>
             </div>
          </motion.div>

          {/* --- CARD 2: LA SOLUCIÃ“ (Ecosistema DigitAI) --- */}
          <motion.div
            // ANIMACIÃ“: Surt de darrere de l'altra targeta
            initial={{ opacity: 0, scale: 0.9, x: -40, rotate: -3 }}
            whileInView={{ opacity: 1, scale: 1, x: 20, rotate: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.8, delay: 0.2, type: "spring", bounce: 0.4 }}
            
            // MIDES:
            // - MÃ²bil: w-[300px] (Ajustat per pantalles petites)
            // - Escriptori (md+): w-[340px] (Mida ORIGINAL)
            className="relative z-20 w-[300px] md:w-[340px] bg-[#1a1d2d] border border-white/10 rounded-2xl shadow-2xl overflow-hidden"
          >
            <div className="h-2 w-full bg-linear-to-r from-[#06b6d4] via-[#3b82f6] to-[#a855f7]"></div>

            <div className="p-6">
              <h3 className="text-lg font-bold text-white mb-1">{t('visual.solution_card.title')}</h3>
              <p className="text-xs text-slate-400 mb-6">{t('visual.solution_card.subtitle')}</p>

              <div className="space-y-4">

                <div className="flex items-center gap-4 p-3 rounded-xl bg-primary/10 border border-primary/20">
                  <div className="p-2 bg-primary/20 rounded-lg text-primary">
                    <Calendar className="w-5 h-5" />
                  </div>
                  <div>
                    <div className="text-sm font-bold text-white">{t('visual.solution_card.widget1_title')}</div>
                    <div className="text-xs text-slate-400">{t('visual.solution_card.widget1_desc')}</div>
                  </div>
                </div>

                <div className="flex items-center gap-4 p-3 rounded-xl bg-blue-500/10 border border-blue-500/20">
                  <div className="p-2 bg-blue-500/20 rounded-lg text-blue-400">
                    <BarChart3 className="w-5 h-5" />
                  </div>
                  <div>
                    <div className="text-sm font-bold text-white">{t('visual.solution_card.widget2_title')}</div>
                    <div className="text-xs text-slate-400">{t('visual.solution_card.widget2_desc')}</div>
                  </div>
                </div>

                <div className="flex items-center gap-4 p-3 rounded-xl bg-cyan-500/10 border border-cyan-500/20">
                  <div className="p-2 bg-cyan-500/20 rounded-lg text-cyan-400">
                    <Smartphone className="w-5 h-5" />
                  </div>
                  <div>
                    <div className="text-sm font-bold text-white">{t('visual.solution_card.widget3_title')}</div>
                    <div className="text-xs text-slate-400">{t('visual.solution_card.widget3_desc')}</div>
                  </div>
                </div>

              </div>
            </div>

            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-linear-to-b from-primary/5 to-transparent pointer-events-none" />
          </motion.div>
        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/ProductTeaser.tsx ===================

'use client';

import { ArrowRight, ExternalLink } from 'lucide-react';
import Link from 'next/link';
import Image from 'next/image';
import { motion } from 'framer-motion';
import { useTranslations } from 'next-intl';

// âœ… IMPORTACIÃ“ ESTÃ€TICA
import ribotFlowImg from '@/assets/images/ribotflow.png';
import salutFlowImg from '@/assets/images/salutflow.png';

export function ProductTeaser() {
    const t = useTranslations('ProductTeaser');

    return (
        <section className="py-24 container mx-auto px-4">

            <div className="rounded-3xl bg-linear-to-br from-slate-50 via-white to-blue-50 dark:from-primary/10 dark:via-background dark:to-background border border-slate-200 dark:border-primary/20 p-8 md:p-12 overflow-hidden relative transition-colors duration-300 shadow-2xl shadow-slate-200/50 dark:shadow-none">

                <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-400/20 dark:bg-primary/20 blur-[100px] rounded-full opacity-40 pointer-events-none"></div>

                <div className="grid lg:grid-cols-2 gap-16 items-center relative z-10">

                    {/* TEXT CONTENT */}
                    <div>
                        <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-100 dark:bg-primary/10 border border-blue-200 dark:border-primary/20 text-blue-700 dark:text-primary text-xs font-bold mb-6">
                            ğŸš€ {t('badge')}
                        </div>

                        <h2 className="text-3xl md:text-5xl font-bold text-foreground mb-6 leading-tight">
                            {t('title_prefix')} <br />
                            <span className="gradient-text">{t('title_highlight')}</span>
                        </h2>

                        <p className="text-slate-600 dark:text-slate-400 text-lg mb-8 leading-relaxed">
                            {t.rich('description', {
                                // 1. GESTIÃ“ DE NEGRETA
                                strong: (chunks) => <strong>{chunks}</strong>,
                                // 2. GESTIÃ“ DEL SALT DE LÃNIA (Assumint que el JSON usa <br />)
                                br: (chunks) => <br />
                            })}
                        </p>

                        <Link href="/projectes" className="inline-flex items-center font-bold text-foreground hover:text-primary transition-colors group">
                            {t('cta')}
                            <ArrowRight className="ml-2 w-4 h-4 group-hover:translate-x-1 transition-transform" />
                        </Link>
                    </div>

                    {/* MOCKUP VISUAL - (Sense canvis) */}
                    <div className="relative h-[400px] w-full flex items-center justify-center perspective-1000">

                        {/* CARD 1: RIBOTFLOW */}
                        <motion.div
                            initial={{ opacity: 0, x: -20, rotate: -5 }}
                            whileInView={{ opacity: 1, x: 0, rotate: -6 }}
                            viewport={{ once: true }}
                            className="absolute left-4 top-10 w-3/4 h-64 bg-white dark:bg-[#0f111a] rounded-xl border border-slate-200 dark:border-white/10 shadow-xl z-10 overflow-hidden"
                        >
                            <div className="h-12 border-b border-slate-100 dark:border-white/5 flex items-center justify-between px-4 bg-slate-50/50 dark:bg-white/5">
                                <div className="relative h-12 w-34">
                                    <Image
                                        src={ribotFlowImg}
                                        alt="RibotFlow Logo"
                                        fill
                                        className="object-contain object-left"
                                        placeholder="blur"
                                    />
                                </div>
                                <div className="flex gap-1.5">
                                    <div className="w-2 h-2 rounded-full bg-slate-300 dark:bg-white/20"></div>
                                    <div className="w-2 h-2 rounded-full bg-slate-300 dark:bg-white/20"></div>
                                </div>
                            </div>
                            <div className="p-4 space-y-3 opacity-50 grayscale hover:grayscale-0 transition-all duration-500">
                                <div className="flex gap-4">
                                    <div className="w-1/3 h-20 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10"></div>
                                    <div className="w-2/3 h-20 rounded-lg bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10"></div>
                                </div>
                                <div className="h-16 w-full rounded-lg bg-slate-50 dark:bg-white/5"></div>
                            </div>
                        </motion.div>

                        {/* CARD 2: SALUTFLOW */}
                        <motion.div
                            initial={{ opacity: 0, x: 20, rotate: 5, y: 20 }}
                            whileInView={{ opacity: 1, x: 20, rotate: 3, y: 40 }}
                            viewport={{ once: true }}
                            transition={{ delay: 0.2 }}
                            className="absolute right-4 top-24 w-3/4 h-64 bg-white dark:bg-[#0f111a] rounded-xl border border-slate-200 dark:border-white/10 shadow-2xl z-20 overflow-hidden backdrop-blur-sm"
                        >
                            <div className="h-12 border-b border-slate-100 dark:border-white/5 flex items-center justify-between px-4 bg-slate-50/50 dark:bg-white/5">
                                <div className="relative h-22 w-48">
                                    <Image
                                        src={salutFlowImg}
                                        alt="SalutFlow Logo"
                                        fill
                                        className="object-contain object-left"
                                        placeholder="blur"
                                    />
                                </div>
                                <ExternalLink className="w-4 h-4 text-slate-400" />
                            </div>
                            <div className="p-4 space-y-3">
                                <div className="flex justify-between items-center mb-2">
                                    <div className="h-4 w-1/3 bg-blue-100 dark:bg-primary/20 rounded"></div>
                                    <div className="h-8 w-8 rounded-full bg-slate-100 dark:bg-white/10"></div>
                                </div>
                                <div className="space-y-2">
                                    <div className="h-10 w-full rounded border-l-4 border-blue-500 bg-slate-50 dark:bg-white/5 flex items-center px-3">
                                        <div className="h-2 w-1/2 bg-slate-200 dark:bg-white/20 rounded"></div>
                                    </div>
                                    <div className="h-10 w-full rounded border-l-4 border-green-500 bg-slate-50 dark:bg-white/5 flex items-center px-3">
                                        <div className="h-2 w-2/3 bg-slate-200 dark:bg-white/20 rounded"></div>
                                    </div>
                                    <div className="h-10 w-full rounded border-l-4 border-purple-500 bg-slate-50 dark:bg-white/5 flex items-center px-3">
                                        <div className="h-2 w-1/3 bg-slate-200 dark:bg-white/20 rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </motion.div>
                    </div>
                </div>
            </div>
        </section>
    );
}

// =================== FILE: src/components/landing/ServicesGrid.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { Smartphone, Globe, BrainCircuit, Users, ArrowUpRight,  MessageSquare, Zap, Database } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function ServicesGrid() {
  const t = useTranslations('Services');

  return (
    <section id="serveis" className="bg-background relative overflow-hidden transition-colors duration-300">
      
      <div className="container mx-auto px-4">
        
        {/* CAPÃ‡ALERA */}
        <div className="text-center mb-12 max-w-3xl mx-auto">
           <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold mb-4">
              {t('badge')}
           </div>
           <h2 className="text-3xl lg:text-5xl font-bold mb-4 text-foreground leading-tight">
             {t('title_prefix')} <span className="gradient-text">{t('title_highlight')}</span>
           </h2>
           <p className="text-lg text-muted-foreground">
             {t('subtitle')}
           </p>
        </div>

        {/* BENTO GRID */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 auto-rows-[minmax(240px,auto)]">
           
           {/* CARD 1: APPWEBS */}
           <motion.div 
              initial={{ opacity: 0, y: 10 }}
              whileInView={{ opacity: 1, y: 0 }}
              viewport={{ once: true }}
              className="md:col-span-2 group relative overflow-hidden rounded-2xl border border-border bg-card hover:border-primary/30 transition-all duration-500 flex flex-col md:flex-row"
           >
              <div className="p-6 flex-1 z-10">
                 <div className="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-500/10 flex items-center justify-center mb-4 border border-blue-200 dark:border-blue-500/20">
                    <Globe className="w-5 h-5 text-blue-600 dark:text-blue-400" />
                 </div>
                 <h3 className="text-xl font-bold text-foreground mb-2">{t('cards.appwebs.title')}</h3>
                 <p className="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                    {t('cards.appwebs.description')}
                 </p>
              </div>

              {/* UI REALISTA WEB */}
              <div className="relative w-full md:w-1/2 h-48 md:h-auto mt-4 md:mt-0 md:mr-6 self-end overflow-hidden">
                  <div className="w-full h-full bg-slate-50 dark:bg-[#0f111a] rounded-t-lg md:rounded-t-xl border-t border-l border-r border-slate-200 dark:border-white/10 shadow-xl translate-y-2 group-hover:translate-y-0 transition-transform duration-500 flex text-[30px]">
                    <div className="w-16 border-r border-slate-200 dark:border-white/5 p-3 flex flex-col gap-3 items-center bg-white dark:bg-black/20">
                       <div className="w-6 h-6 rounded bg-primary/20 mb-2"></div>
                       <div className="w-4 h-4 rounded-sm bg-slate-200 dark:bg-white/10"></div>
                       <div className="w-4 h-4 rounded-sm bg-slate-200 dark:bg-white/10"></div>
                       <div className="w-4 h-4 rounded-sm bg-slate-200 dark:bg-white/10"></div>
                    </div>
                    <div className="flex-1 p-3">
                       <div className="flex justify-between items-center mb-3">
                          <span className="font-bold text-foreground text-xs md:text-sm">Dashboard</span>
                          <div className="w-16 h-4 rounded bg-slate-200 dark:bg-white/10"></div>
                       </div>
                       <div className="h-16 w-full bg-white dark:bg-white/5 rounded border border-slate-100 dark:border-white/5 mb-2 relative overflow-hidden">
                          <svg viewBox="0 0 100 40" className="w-full h-full absolute bottom-0" preserveAspectRatio="none">
                             <path d="M0 30 Q 20 10, 40 25 T 100 10" fill="none" stroke="#a855f7" strokeWidth="2" />
                             <path d="M0 30 Q 20 10, 40 25 T 100 10 V 40 H 0 Z" fill="url(#gradientGraph)" opacity="0.3" />
                             <defs>
                                <linearGradient id="gradientGraph" x1="0" y1="0" x2="0" y2="1">
                                   <stop offset="0%" stopColor="#a855f7" />
                                   <stop offset="100%" stopColor="transparent" />
                                </linearGradient>
                             </defs>
                          </svg>
                       </div>
                       <div className="space-y-1">
                          <div className="h-2 w-full bg-slate-200 dark:bg-white/10 rounded"></div>
                          <div className="h-2 w-3/4 bg-slate-200 dark:bg-white/10 rounded"></div>
                       </div>
                    </div>
                 </div>
              </div>
           </motion.div>

           {/* CARD 2: APPS */}
           <motion.div 
              initial={{ opacity: 0, y: 10 }}
              whileInView={{ opacity: 1, y: 0 }}
              viewport={{ once: true }}
              transition={{ delay: 0.1 }}
              className="md:col-span-1 group relative overflow-hidden rounded-2xl border border-border bg-card hover:border-cyan-500/30 transition-all duration-500"
           >
              <div className="p-6 h-full flex flex-col">
                 <div className="w-10 h-10 rounded-lg bg-cyan-100 dark:bg-cyan-500/10 flex items-center justify-center mb-4 border border-cyan-200 dark:border-cyan-500/20">
                    <Smartphone className="w-5 h-5 text-cyan-600 dark:text-cyan-400" />
                 </div>
                 <h3 className="text-lg font-bold text-foreground mb-1">{t('cards.apps.title')}</h3>
                 <p className="text-sm text-slate-600 dark:text-slate-400 mb-6">
                    {t('cards.apps.description')}
                 </p>
                 
                 {/* UI MÃ²bil */}
                 <div className="grow relative flex justify-center">
                    <div className="w-32 bg-white dark:bg-black border-x-4 border-t-4 border-slate-300 dark:border-slate-800 rounded-t-2xl relative top-2 group-hover:top-0 transition-all duration-500 overflow-hidden shadow-lg">
                       <div className="h-8 bg-cyan-500/10 border-b border-slate-100 dark:border-white/5 flex items-center justify-between px-2">
                          <div className="w-3 h-3 rounded-full bg-slate-200 dark:bg-white/20"></div>
                          <div className="w-8 h-1 rounded-full bg-slate-200 dark:bg-white/20"></div>
                       </div>
                       <div className="p-2 space-y-2">
                          <div className="flex gap-2 items-center">
                             <div className="w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-500/20 shrink-0"></div>
                             <div className="h-2 w-16 bg-slate-100 dark:bg-white/10 rounded"></div>
                          </div>
                          <div className="flex gap-2 items-center flex-row-reverse">
                             <div className="w-6 h-6 rounded-full bg-green-100 dark:bg-green-500/20 shrink-0"></div>
                             <div className="h-6 w-14 bg-green-50 dark:bg-green-500/10 rounded-lg border border-green-100 dark:border-green-500/20"></div>
                          </div>
                          <div className="flex gap-2 items-center">
                             <div className="w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-500/20 shrink-0"></div>
                             <div className="h-8 w-full bg-slate-50 dark:bg-white/5 rounded border border-slate-100 dark:border-white/5"></div>
                          </div>
                       </div>
                    </div>
                 </div>
              </div>
           </motion.div>

           {/* CARD 3: AUTOMATITZACIÃ“ (RENOVAT AMB FLUX) */}
           <motion.div 
              initial={{ opacity: 0, y: 10 }}
              whileInView={{ opacity: 1, y: 0 }}
              viewport={{ once: true }}
              transition={{ delay: 0.2 }}
              className="md:col-span-1 group relative overflow-hidden rounded-2xl border border-border bg-card hover:border-purple-500/30 transition-all duration-500"
           >
              <div className="p-6 h-full flex flex-col relative z-20">
                 <div className="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-500/10 flex items-center justify-center mb-4 border border-purple-200 dark:border-purple-500/20">
                    <BrainCircuit className="w-5 h-5 text-purple-600 dark:text-purple-400" />
                 </div>
                 <h3 className="text-lg font-bold text-foreground mb-1">{t('cards.automation.title')}</h3>
                 <p className="text-sm text-slate-600 dark:text-slate-400 mb-2">
                    {t('cards.automation.description')}
                 </p>
                 
                 {/* --- ANIMACIÃ“ FLUX --- */}
                 <div className="grow mt-4 relative bg-slate-50/50 dark:bg-black/20 rounded-xl border border-slate-200 dark:border-white/5 overflow-hidden">
                    
                    {/* Fons Grid TÃ¨cnic */}
                    <div className="absolute inset-0 bg-[radial-gradient(#a855f7_1px,transparent_1px)] bg-size-[16px_16px] opacity-[0.15]"></div>

                    <div className="relative w-full h-full flex items-center justify-around px-2">
                        {/* Node 1: Input */}
                        <div className="relative z-10 flex flex-col items-center gap-2">
                            <div className="w-8 h-8 rounded-full bg-white dark:bg-[#1a1d2d] border border-slate-200 dark:border-white/10 shadow-sm flex items-center justify-center">
                                <MessageSquare className="w-3.5 h-3.5 text-blue-500" />
                            </div>
                        </div>

                        {/* Node 2: Brain (Center) */}
                        <div className="relative z-10 flex flex-col items-center gap-2">
                            <motion.div 
                                animate={{ scale: [1, 1.1, 1], boxShadow: ["0 0 0px rgba(168,85,247,0)", "0 0 20px rgba(168,85,247,0.5)", "0 0 0px rgba(168,85,247,0)"] }}
                                transition={{ duration: 2, repeat: Infinity }}
                                className="w-10 h-10 rounded-xl bg-purple-500 text-white shadow-lg flex items-center justify-center relative"
                            >
                                <Zap className="w-5 h-5 fill-current" />
                            </motion.div>
                        </div>

                        {/* Node 3: Output */}
                        <div className="relative z-10 flex flex-col items-center gap-2">
                            <div className="w-8 h-8 rounded-full bg-white dark:bg-[#1a1d2d] border border-slate-200 dark:border-white/10 shadow-sm flex items-center justify-center">
                                <Database className="w-3.5 h-3.5 text-green-500" />
                            </div>
                        </div>

                        {/* Connection Lines (SVG) */}
                        <svg className="absolute inset-0 w-full h-full pointer-events-none overflow-visible">
                            {/* Line 1: Input -> Brain */}
                            <path d="M 20% 50% Q 35% 50% 50% 50%" stroke="currentColor" className="text-slate-300 dark:text-white/10" strokeWidth="2" fill="none" />
                            <motion.circle 
                                r="3" fill="#3b82f6"
                                animate={{ offsetDistance: "100%" }}
                                style={{ offsetPath: "path('M 20% 50% Q 35% 50% 50% 50%')" }}
                                transition={{ duration: 1.5, repeat: Infinity, ease: "linear" }}
                            />

                            {/* Line 2: Brain -> Output */}
                            <path d="M 50% 50% Q 65% 50% 80% 50%" stroke="currentColor" className="text-slate-300 dark:text-white/10" strokeWidth="2" fill="none" />
                            <motion.circle 
                                r="3" fill="#22c55e"
                                animate={{ offsetDistance: "100%" }}
                                style={{ offsetPath: "path('M 50% 50% Q 65% 50% 80% 50%')" }}
                                transition={{ duration: 1.5, repeat: Infinity, ease: "linear", delay: 0.75 }}
                            />
                        </svg>
                    </div>
                 </div>
              </div>
           </motion.div>

           {/* CARD 4: FORMACIÃ“ (TERMINAL FIX) */}
           <motion.div 
              initial={{ opacity: 0, y: 10 }}
              whileInView={{ opacity: 1, y: 0 }}
              viewport={{ once: true }}
              transition={{ delay: 0.3 }}
              className="md:col-span-2 group relative overflow-hidden rounded-2xl border border-border bg-card hover:border-green-500/30 transition-all duration-500 flex flex-col md:flex-row"
           >
              <div className="p-6 flex-1 z-10">
                 <div className="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-500/10 flex items-center justify-center mb-4 border border-green-200 dark:border-green-500/20">
                    <Users className="w-5 h-5 text-green-600 dark:text-green-400" />
                 </div>
                 <h3 className="text-xl font-bold text-foreground mb-2">{t('cards.training.title')}</h3>
                 <p className="text-sm text-slate-600 dark:text-slate-400 mb-4 leading-relaxed">
                    {t('cards.training.description')}
                 </p>
                 <button className="text-xs font-bold text-green-600 dark:text-green-400 flex items-center gap-1 hover:gap-2 transition-all">
                    {t('cards.training.cta')} <ArrowUpRight className="w-3 h-3" />
                 </button>
              </div>

              {/* UI Terminal FIXED */}
              <div className="relative w-full md:w-1/2 h-auto p-4 md:p-6 self-center">
                 <div className="w-full bg-slate-100 dark:bg-[#1e1e1e] rounded-lg border border-slate-200 dark:border-slate-800 p-3 md:p-4 font-mono shadow-xl text-slate-600 dark:text-slate-300 leading-relaxed opacity-90 group-hover:opacity-100 transition-opacity">
                    
                    <div className="flex gap-1.5 mb-3 opacity-50">
                       <div className="w-2 h-2 rounded-full bg-red-500"></div>
                       <div className="w-2 h-2 rounded-full bg-yellow-500"></div>
                       <div className="w-2 h-2 rounded-full bg-green-500"></div>
                    </div>
                    
                    {/* TEXT RESPONSIVE: text-[10px] en mÃ²bil, text-xs en tablet/escriptori */}
                    <div className="text-[10px] sm:text-xs">
                       <p className="whitespace-nowrap overflow-hidden text-ellipsis">
                          <span className="text-purple-600 dark:text-purple-400">import</span> {'{ AI }'} <span className="text-purple-600 dark:text-purple-400">from</span> <span className="text-green-600 dark:text-green-400">'digitai'</span>;
                       </p>
                       <p className="mt-1 whitespace-nowrap overflow-hidden text-ellipsis">
                          <span className="text-blue-600 dark:text-blue-400">const</span> team = <span className="text-yellow-600 dark:text-yellow-400">await</span> AI.train();
                       </p>
                       <p className="mt-1">
                          <span className="text-slate-400 dark:text-slate-500">Resultat: </span>
                          <span className="text-green-600 dark:text-green-400 font-bold">+Productivitat</span>
                       </p>
                       
                       <motion.div 
                          animate={{ opacity: [0, 1, 0] }}
                          transition={{ duration: 0.8, repeat: Infinity }}
                          className="h-3 w-1.5 bg-green-500 mt-1 inline-block align-middle"
                       />
                    </div>
                 </div>
              </div>
           </motion.div>

        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/SocialSection.tsx ===================

'use client';

import { Facebook, Linkedin, Instagram } from 'lucide-react';
import { motion } from 'framer-motion';

const SOCIALS = [
  {
    name: 'LinkedIn',
    icon: Linkedin,
    href: 'https://www.linkedin.com/in/digitai-studios-105a0136a/',
    color: 'hover:text-[#0077b5]', // Color oficial LinkedIn
  },
  {
    name: 'Instagram',
    icon: Instagram,
    href: 'https://www.instagram.com/digitaistudios/',
    color: 'hover:text-[#E1306C]', // Color oficial Instagram
  },
  {
    name: 'Facebook',
    icon: Facebook,
    href: 'https://www.facebook.com/profile.php?id=61576974390567',
    color: 'hover:text-[#1877F2]', // Color oficial Facebook
  },
];

export function SocialSection() {
  return (
    <section className="py-12 bg-muted/30 border-y border-border/40">
      <div className="container mx-auto px-4 text-center">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true }}
        >
          <p className="text-sm font-semibold uppercase tracking-widest text-muted-foreground mb-6">
            Segueix la revoluciÃ³
          </p>
          
          <div className="flex justify-center items-center gap-8 md:gap-12">
            {SOCIALS.map((social) => (
              <a
                key={social.name}
                href={social.href}
                target="_blank"
                rel="noopener noreferrer"
                aria-label={`Segueix-nos a ${social.name}`}
                className={`transform transition-all duration-300 hover:scale-110 text-muted-foreground ${social.color}`}
              >
                <social.icon className="w-8 h-8 md:w-10 md:h-10" />
              </a>
            ))}
          </div>
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/TechStackSection.tsx ===================

'use client';

import { motion, useAnimationControls } from 'framer-motion';
import { useState, useEffect } from 'react';
import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils';

const TECHNOLOGIES = [
  {
    name: "Next.js",
    color: "#000000", // En mode fosc es veurÃ  blanc pel svg, perÃ² el text el volem visible
    darkModeColor: "#ffffff",
    icon: (
      <svg viewBox="0 0 180 180" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <mask id="mask0" mask-type="alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="180" height="180">
          <circle cx="90" cy="90" r="90" className="fill-black dark:fill-white" />
        </mask>
        <g mask="url(#mask0)">
          <circle cx="90" cy="90" r="87" className="stroke-black dark:stroke-white" strokeWidth="6" />
          <path d="M149.508 157.52L69.142 54H54V125.97H66.1136V69.3836L139.999 164.845C143.333 162.614 146.509 160.165 149.508 157.52Z" className="fill-black dark:fill-white" />
          <rect x="115" y="54" width="12" height="72" className="fill-black dark:fill-white" />
        </g>
      </svg>
    )
  },
  {
    name: "Supabase",
    color: "#3ECF8E",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M11.5286 0.179546C11.8331 -0.0812412 12.2919 -0.0533377 12.5643 0.24243L23.6622 12.2932C23.9326 12.5868 23.8877 13.048 23.5614 13.2813L13.3359 20.5925L15.9762 23.1152C16.2584 23.3849 16.0599 23.8673 15.6692 23.8673H11.5286C11.2241 24.1281 10.7653 24.1002 10.4929 23.8044L-0.605008 11.7537C-0.875401 11.46 -0.830532 10.9989 -0.504224 10.7655L9.72131 3.45435L7.08095 0.931661C6.79877 0.661952 6.99727 0.179546 7.38795 0.179546H11.5286Z" fill="#3ECF8E" />
      </svg>
    )
  },
  {
    name: "n8n",
    color: "#EA4B71",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M12.9 8.25h2.2v2.2h-2.2v-2.2zm-2.2 0h-2.2v2.2h2.2v-2.2zm-4.4 0H4.1v2.2h2.2v-2.2zm0 4.4H4.1v2.2h2.2v-2.2zm4.4 0h-2.2v2.2h2.2v-2.2zm2.2 0h2.2v2.2h-2.2v-2.2z" fill="#EA4B71" />
        <path fillRule="evenodd" clipRule="evenodd" d="M14 0H2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2zM2 2h12v12H2V2z" fill="#EA4B71" transform="translate(4 4)" />
      </svg>
    )
  },
  {
    name: "Airtable",
    color: "#F82B60",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M3 10v8l7 -3v-2.6z" fill="#F8D800" />
        <path d="M3 6l9 3l9 -3l-9 -3z" fill="#2D7FF9" />
        <path d="M14 12.3v8.7l7 -3v-8z" fill="#F82B60" />
      </svg>
    )
  },
  {
    name: "React Native",
    color: "#61DAFB",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M12 22.5C17.799 22.5 22.5 17.799 22.5 12C22.5 6.20101 17.799 1.5 12 1.5C6.20101 1.5 1.5 6.20101 1.5 12C1.5 17.799 6.20101 22.5 12 22.5Z" fill="none" />
        <circle cx="12" cy="12" r="2" fill="#61DAFB" />
        <g stroke="#61DAFB" strokeWidth="1.5" fill="none">
           <ellipse cx="12" cy="12" rx="10" ry="4" />
           <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(60 12 12)" />
           <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(120 12 12)" />
        </g>
      </svg>
    )
  },
  {
    name: "OpenAI",
    color: "#10A37F",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1 .6765 8.1643l-.142-.0805-4.7784-2.7581a.7616.7616 0 0 0-.3927-.6765v-6.7369l.0048-.0048z" className="fill-black dark:fill-white" />
      </svg>
    )
  },
  {
    name: "Gemini",
    color: "#4E75F6",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <defs>
          <linearGradient id="gemini-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#4E75F6" />
            <stop offset="100%" stopColor="#E96C7C" />
          </linearGradient>
        </defs>
        <path d="M12 22C12 16.4772 16.4772 12 22 12C16.4772 12 12 7.52285 12 2C12 7.52285 7.52285 12 2 12C7.52285 12 12 16.4772 12 22Z" fill="url(#gemini-gradient)" />
      </svg>
    )
  },
  {
    name: "TypeScript",
    color: "#3178C6",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M2 0h20c1.1 0 2 0.9 2 2v20c0 1.1-0.9 2-2 2H2c-1.1 0-2-0.9-2-2V2c0-1.1 0.9-2 2-2zm13.5 17.9c1.3 0 2.2-0.7 2.6-1.7h-1.7c-0.2 0.4-0.5 0.6-0.9 0.6-0.7 0-1-0.6-1-1.7v-3.3h2.9v-1.4h-2.9v-2.1h-1.7v2.1h-1.4v1.4h1.4v3.6c0 1.6 0.9 2.5 2.7 2.5zm-6.7 0c1.5 0 2.6-0.8 2.8-2h-1.7c-0.2 0.5-0.6 0.8-1.1 0.8-0.8 0-1.2-0.6-1.2-1.6v-3.2h2.8v-1.4h-2.8v-2.1h-1.7v2.1h-1.6v1.4h1.6v3.5c0 1.7 1.1 2.5 2.9 2.5z" fill="#3178C6"/>
      </svg>
    )
  },
  {
    name: "GitHub",
    color: "#000000",
    darkModeColor: "#ffffff",
    icon: (
      <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.65.72.26.98.19 1.12.08.14-.55.28-.94.55-1.15-2.2-.23-4.51-1.1-4.51-4.9 0-1.08.38-1.97 1.01-2.66-.1-.25-.44-1.26.1-2.62 0 0 .84-.27 2.75 1.02.8-.22 1.65-.33 2.5-.33.85 0 1.7.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.36.2 2.37.1 2.62.63.69 1.01 1.58 1.01 2.66 0 3.8-2.32 4.67-4.53 4.89.29.25.55.74.55 1.49 0 1.08-.01 1.95-.01 2.21 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" className="fill-black dark:fill-white"/>
      </svg>
    )
  },
  {
    name: "Vercel",
    color: "#000000",
    darkModeColor: "#ffffff",
    icon: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <path d="M12 1L24 22H0L12 1Z" className="fill-black dark:fill-white"/>
      </svg>
    )
  },
];

export function TechStackSection() {
  const t = useTranslations('TechStack');
  const controls = useAnimationControls();
  const [activeTech, setActiveTech] = useState<string | null>(null);

  // Dupliquem la llista per l'efecte infinit
  const infiniteTechnologies = [...TECHNOLOGIES, ...TECHNOLOGIES];

  useEffect(() => {
    controls.start({
      x: "-50%",
      transition: {
        duration: 30, 
        ease: "linear",
        repeat: Infinity,
      }
    });
  }, [controls]);

  const handleInteractionStart = (name: string) => {
    setActiveTech(name);
    controls.stop(); 
  };

  const handleInteractionEnd = () => {
    setActiveTech(null);
    controls.start({
      x: "-50%",
      transition: {
        duration: 20,
        ease: "linear",
        repeat: Infinity,
      }
    });
  };

  return (
    <section className="py-6 border-y border-slate-200 dark:border-white/5 bg-slate-50 dark:bg-white/1 overflow-hidden relative">
      
      {/* 3. MÃ€SCARES DE DEGRADAT (FADE EDGES) */}
      <div className="absolute inset-y-0 left-0 w-24 bg-linear-to-r from-slate-50 dark:from-[#0a0a0a] to-transparent z-10 pointer-events-none" />
      <div className="absolute inset-y-0 right-0 w-24 bg-linear-to-l from-slate-50 dark:from-[#0a0a0a] to-transparent z-10 pointer-events-none" />

      <div className="container mx-auto px-4 mb-4">
        <p className="text-center text-xs font-bold text-slate-500 uppercase tracking-[0.2em]">
          {t('subtitle')}
        </p>
      </div>
      
      {/* CORRECCIÃ“ CLAU: AFEGIT 'py-10' PER DONAR ESPAI VERTICAL AL TEXT ABSOLUT */}
      <div className="flex w-full overflow-hidden py-10">
        <motion.div 
          className="flex items-center gap-12 md:gap-24 px-12"
          animate={controls}
          initial={{ x: 0 }}
        >
          {infiniteTechnologies.map((tech, i) => (
            <div
              key={`${tech.name}-${i}`} 
              // 'items-center' i 'relative' sÃ³n clau aquÃ­
              className="relative group flex flex-col items-center justify-center min-w-20"
              onMouseEnter={() => handleInteractionStart(tech.name)}
              onMouseLeave={handleInteractionEnd}
              onTouchStart={() => handleInteractionStart(tech.name)}
              onTouchEnd={handleInteractionEnd}
              onClick={() => handleInteractionStart(tech.name)}
            >
              <motion.div 
                className={cn(
                  "w-16 h-16 md:w-20 md:h-20 transition-all duration-300 z-40",
                  activeTech && activeTech !== tech.name ? "opacity-30 grayscale scale-90" : "opacity-70 grayscale",
                  activeTech === tech.name && "opacity-100 grayscale-0 scale-110 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]"
                )}
              >
                {tech.icon}
              </motion.div>
              
              {/* Text: el 'top-full mt-4' el posa a sota, i com que el pare tÃ© 'py-10', no es talla */}
              <motion.span 
                initial={{ opacity: 0, y: -10 }}
                animate={{ 
                  opacity: activeTech === tech.name ? 1 : 0, 
                  y: activeTech === tech.name ? 0 : -10 
                }}
                className="absolute top-full mt-4 text-xs font-bold whitespace-nowrap px-3 py-1 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-lg z-20 pointer-events-none"
                // Utilitzem un color de fallback si no hi Ã©s
                style={{ color: activeTech === tech.name ? tech.color : 'inherit' }}
              >
                {tech.name}
              </motion.span>
            </div>
          ))}
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/landing/TestimonialsSection.tsx ===================

'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Star, Quote, ChevronLeft, ChevronRight, Globe, Smartphone, Zap, Users, Code, ExternalLink } from 'lucide-react';
import Image, { StaticImageData } from 'next/image';
import Link from 'next/link';
import type { Testimonial } from '@/lib/data';

type Props = {
  testimonials: Testimonial[];
};

export function TestimonialsSection({ testimonials }: Props) {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [itemsToShow, setItemsToShow] = useState(3); // Per defecte 3 (escriptori)

  // Detectem la mida de la pantalla per ajustar itemsToShow
  useEffect(() => {
    const handleResize = () => {
      if (window.innerWidth < 768) {
        setItemsToShow(1); // MÃ²bil: 1 Ã­tem
      } else {
        setItemsToShow(3); // Escriptori: 3 Ã­tems
      }
    };

    // Executem al principi
    handleResize();

    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  const nextSlide = () => {
    setCurrentIndex((prev) => (prev + 1) % testimonials.length);
  };

  const prevSlide = () => {
    setCurrentIndex((prev) => (prev - 1 + testimonials.length) % testimonials.length);
  };

  const getVisibleItems = () => {
    const items = [];
    for (let i = 0; i < itemsToShow; i++) {
      items.push(testimonials[(currentIndex + i) % testimonials.length]);
    }
    return items;
  };

  return (
    <section id="testimonis" className="py-16 bg-muted/30 relative overflow-hidden">
      <div className="container mx-auto px-4 relative z-10">
        
        {/* CAPÃ‡ALERA */}
        <div className="flex flex-col md:flex-row justify-between items-end  md:mb-16 gap-6">
           <div className="max-w-2xl">
              <h2 className="text-3xl lg:text-5xl font-bold text-foreground leading-tight">
                No ens creguis a nosaltres. <br/>
                Mira el que hem <span className="gradient-text">ConstruÃ¯t</span>.
              </h2>
           </div>

           {/* CONTROLS */}
           <div className="flex gap-3">
              <button onClick={prevSlide} className="p-3 rounded-full border border-border bg-card hover:bg-primary hover:text-white transition-all shadow-sm">
                 <ChevronLeft className="w-6 h-6" />
              </button>
              <button onClick={nextSlide} className="p-3 rounded-full border border-border bg-card hover:bg-primary hover:text-white transition-all shadow-sm">
                 <ChevronRight className="w-6 h-6" />
              </button>
           </div>
        </div>

        {/* GRID */}
        {/* Canviem grid-cols per adaptar-se al itemsToShow dinÃ micament */}
        <div className={`grid gap-8 py-6 ${itemsToShow === 1 ? 'grid-cols-1' : 'grid-cols-3'}`}>
          <AnimatePresence mode='popLayout'>
            {getVisibleItems().map((item, i) => (
              <motion.div
                key={`${item.id}-${currentIndex + i}`} // Clau Ãºnica composta per forÃ§ar re-render correcte
                initial={{ opacity: 0, x: 50 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -50 }}
                transition={{ duration: 0.4, ease: "easeInOut" }}
                className="h-[450px] perspective-1000"
              >
                 <TestimonialCard item={item} />
              </motion.div>
            ))}
          </AnimatePresence>
        </div>

      </div>
    </section>
  );
}

// --- TARGETA INDIVIDUAL (EFECTE CARPETA/FITXER) ---

function TestimonialCard({ item }: { item: Testimonial }) {
   return (
      <div className="relative w-full h-full group">
         
         {/* CAPA 1: EL PROJECTE (FITXER) */}
         <div className="absolute inset-x-4 top-4 bottom-20 transition-all duration-500 cubic-bezier(0.25, 0.8, 0.25, 1) group-hover:-translate-y-20 ">
            <div className="w-full h-full rounded-t-xl overflow-hidden border border-primary/20 bg-slate-900 dark:bg-black shadow-2xl group-hover:shadow-primary/20">
               {item.projectType === 'web' && <MockupWeb url={item.projectUrl} image={item.image} title={item.company} />}
               {item.projectType === 'app' && <MockupApp image={item.image} title={item.company} />}
               {item.projectType === 'automation' && <MockupAutomation />}
            </div>
         </div>

         {/* CAPA 2: EL TESTIMONI (CARPETA) */}
         <div className="absolute bottom-0 left-0 right-0 h-[280px] bg-card border border-border rounded-2xl p-8 shadow-xl z-10 transition-transform duration-500 group-hover:translate-y-6 flex flex-col">
            
            <Quote className="absolute top-6 right-6 text-primary/10 w-12 h-12 rotate-180" />

            <div className="flex items-center gap-3 mb-4">
               <div className="w-12 h-12 rounded-full bg-linear-to-br from-primary/20 to-blue-500/20 border border-primary/30 flex items-center justify-center text-lg font-bold text-primary shrink-0">
                  {item.name.charAt(0)}
               </div>
               <div>
                  <div className="font-bold text-foreground text-sm md:text-base">{item.name}</div>
                  <div className="text-xs text-muted-foreground">{item.company}</div>
               </div>
            </div>

            <div className="flex gap-1 mb-4">
               {[...Array(5)].map((_, i) => (
                  <Star key={i} className={`w-4 h-4 ${i < item.rating ? 'fill-yellow-400 text-yellow-400' : 'text-slate-300 dark:text-slate-700'}`} />
               ))}
            </div>

            <p className="text-sm md:text-base text-muted-foreground leading-relaxed overflow-hidden text-ellipsis line-clamp-4">
               "{item.text}"
            </p>
            
            <div className="mt-auto pt-4 border-t border-border flex justify-between items-center opacity-50">
               <span className="text-[10px] uppercase tracking-widest font-bold">Projecte Realitzat</span>
               <div className="w-16 h-1 bg-foreground/10 rounded-full"></div>
            </div>
         </div>
      </div>
   )
}

// --- MOCKUPS VISUALS ---

function MockupWeb({ url, image, title }: { url?: string, image?: string | StaticImageData, title: string }) {
   const Wrapper = url ? Link : 'div';
   return (
      <Wrapper href={url || '#'} target={url ? "_blank" : undefined} className="block w-full h-full cursor-pointer group/mockup">
         <div className="w-full h-full bg-slate-50 dark:bg-[#0f111a] flex flex-col relative">
            
            {url && (
               <div className="absolute inset-0 z-30 bg-black/60 backdrop-blur-[2px] flex items-center justify-center opacity-0 group-hover/mockup:opacity-100 transition-opacity duration-300">
                  <span className="bg-white text-black px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-lg transform scale-90 group-hover/mockup:scale-100 transition-transform">
                     Visitar Web <ExternalLink className="w-3 h-3" />
                  </span>
               </div>
            )}

            <div className="h-6 bg-slate-200 dark:bg-white/10 flex items-center px-3 gap-1.5 z-10">
               <div className="w-2 h-2 rounded-full bg-red-400/80"></div>
               <div className="w-2 h-2 rounded-full bg-yellow-400/80"></div>
               <div className="w-2 h-2 rounded-full bg-green-400/80"></div>
            </div>
            
            <div className="flex-1 relative w-full">
                {image ? (
                   <Image src={image} alt={title} fill className="object-cover object-top" />
                ) : (
                   <div className="flex flex-col items-center justify-center h-full gap-2 bg-white dark:bg-black/50">
                      <Globe className="w-8 h-8 text-blue-500/20" />
                      <span className="text-xs text-muted-foreground font-bold">{title} Web</span>
                   </div>
                )}
            </div>
         </div>
      </Wrapper>
   )
}

function MockupApp({ image, title }: { image?: string | StaticImageData, title: string }) {
   return (
      <div className="w-full h-full bg-slate-800 dark:bg-black flex items-end justify-center p-4 pb-0 group/mockup relative">
         
         <div className="absolute inset-0 z-30 bg-black/60 backdrop-blur-[2px] flex items-center justify-center opacity-0 group-hover/mockup:opacity-100 transition-opacity duration-300 rounded-t-xl">
             <span className="bg-white text-black px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-lg">
                Veure App <ExternalLink className="w-3 h-3" />
             </span>
         </div>

         <div className="w-32 h-full bg-black border-2 border-slate-700 rounded-t-xl overflow-hidden relative">
            {image ? (
                <Image src={image} alt={title} fill className="object-cover" />
            ) : (
               <div className="w-full h-full bg-slate-900 flex flex-col items-center justify-center">
                   <Smartphone className="w-6 h-6 text-primary" />
                   <span className="text-[10px] text-slate-400 mt-2">{title} App</span>
                </div>
            )}
         </div>
      </div>
   )
}

function MockupAutomation() {
   return (
      <div className="w-full h-full bg-[#1a1d2d] relative overflow-hidden group/mockup">
         <div className="absolute inset-0 z-30 bg-black/60 backdrop-blur-[2px] flex items-center justify-center opacity-0 group-hover/mockup:opacity-100 transition-opacity duration-300">
             <span className="bg-white text-black px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-lg">
                Veure Flux <Zap className="w-3 h-3" />
             </span>
         </div>

         <div className="absolute inset-0 bg-[radial-gradient(#ffffff10_1px,transparent_1px)] bg-size-[12px_12px]"></div>
         
         <svg className="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 100 100" preserveAspectRatio="none">
            <defs>
               <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#a855f7" stopOpacity="0.5" />
                  <stop offset="100%" stopColor="#22c55e" stopOpacity="0.5" />
               </linearGradient>
            </defs>
            <path 
               d="M 20 30 C 50 30, 50 70, 80 70" 
               stroke="url(#lineGradient)" 
               strokeWidth="1.5" 
               fill="none" 
               vectorEffect="non-scaling-stroke" 
            />
            <motion.circle 
               r="3" 
               fill="#a855f7"
               animate={{ offsetDistance: ["0%", "100%"] }}
               transition={{ duration: 2, repeat: Infinity, ease: "linear" }}
               style={{ offsetPath: "path('M 20 30 C 50 30, 50 70, 80 70')" }}
            />
         </svg>

         <div className="absolute left-[20%] top-[30%] -translate-x-1/2 -translate-y-1/2 w-10 h-10 rounded-lg bg-purple-500/20 border border-purple-500 flex items-center justify-center z-10 shadow-[0_0_15px_rgba(168,85,247,0.4)] backdrop-blur-sm">
            <Users className="w-5 h-5 text-purple-400" />
         </div>
         
         <div className="absolute left-[80%] top-[50%] -translate-x-1/2 -translate-y-1/2 w-10 h-10 rounded-lg bg-green-500/20 border border-green-500 flex items-center justify-center z-10 shadow-[0_0_15px_rgba(34,197,94,0.4)] backdrop-blur-sm">
            <Code className="w-5 h-5 text-green-400" />
         </div>
      </div>
   )
}

// =================== FILE: src/components/layout/Footer.tsx ===================

'use client';

import Link from 'next/link';
import { Facebook, Instagram, Linkedin, Mail, MapPin} from 'lucide-react';
import { useTranslations } from 'next-intl';

const SOCIALS = [
  { icon: Linkedin, href: "https://www.linkedin.com/in/digitai-studios-105a0136a/" , label: 'LinkedIn' },
  { icon: Instagram, href: "https://www.instagram.com/digitaistudios/", label: 'Instagram' },
  { icon: Facebook, href: "https://www.facebook.com/profile.php?id=61576974390567" , label: 'Facebook' },
];

export function Footer() {
  const t = useTranslations('Footer'); // Namespace 'Footer'
  const tNav = useTranslations('Navbar'); // Reutilitzem traduccions de Navbar
  const currentYear = new Date().getFullYear();

  // Definim links DINS del component
  const FOOTER_LINKS = [
    {
      title: t('services_title'),
      links: [
        { label: 'AppWebs & SaaS', href: '#serveis' },
        { label: 'Apps MÃ²bils', href: '#serveis' },
        { label: 'AutomatitzaciÃ³ IA', href: '#serveis' },
        { label: 'FormaciÃ³ In-Company', href: '#serveis' },
      ],
    },
    {
      title: t('company_title'),
      links: [
        { label: t('about'), href: '#hero' },
        { label: tNav('projects'), href: '/projectes' },
        { label: tNav('blog'), href: '/blog' },
        { label: t('contact'), href: '#contacte' },
      ],
    },
    {
      title: t('legal_title'),
      links: [
        { label: t('legal_notice'), href: '/legal/avis-legal' },
        { label: t('privacy'), href: '/legal/privacitat' },
        { label: t('cookies'), href: '/legal/cookies' },
      ],
    },
  ];

  return (
    <footer className="bg-background border-t border-border pt-16 pb-8 transition-colors duration-300">
      <div className="container mx-auto px-4">
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-12 mb-16">
          
          {/* COLUMNA 1: MARCA & INFO */}
          <div className="lg:col-span-2 space-y-6">
            <Link href="/" className="inline-block">
              <span className="text-2xl font-bold tracking-tight text-foreground">
                DigitAI <span className="gradient-text">Studios</span>
              </span>
            </Link>
            <p className="text-muted-foreground leading-relaxed max-w-sm">
              {t('description')}
            </p>
            
            <div className="flex gap-4">
              {SOCIALS.map((social, i) => (
                <a 
                  key={i}
                  href={social.href}
                  target="_blank"
                  rel="noopener noreferrer"
                  aria-label={social.label}
                  className="w-10 h-10 rounded-full bg-muted/50 flex items-center justify-center text-muted-foreground hover:bg-primary/10 hover:text-primary transition-all border border-transparent hover:border-primary/20"
                >
                  <social.icon className="w-5 h-5" />
                </a>
              ))}
            </div>

            <div className="space-y-2 pt-4">
                <div className="flex items-center gap-3 text-sm text-muted-foreground">
                    <Mail className="w-4 h-4 text-primary" />
                    <a href="mailto:info@digitaistudios.com" className="hover:text-foreground transition-colors">
                        info@digitaistudios.com
                    </a>
                </div>
                <div className="flex items-center gap-3 text-sm text-muted-foreground">
                    <MapPin className="w-4 h-4 text-primary" />
                    <span>Girona, Catalunya</span>
                </div>
            </div>
          </div>

          {/* COLUMNS DINÃ€MIQUES DE LINKS */}
          {FOOTER_LINKS.map((section) => (
            <div key={section.title} className="space-y-6">
              <h4 className="font-bold text-foreground">{section.title}</h4>
              <ul className="space-y-3">
                {section.links.map((link) => (
                  <li key={link.label}>
                    <Link 
                      href={link.href} 
                      className="text-sm text-muted-foreground hover:text-primary transition-colors flex items-center gap-2 group"
                    >
                      <span className="w-1.5 h-1.5 rounded-full bg-primary/0 group-hover:bg-primary transition-all duration-300"></span>
                      {link.label}
                    </Link>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>

        {/* COPYRIGHT */}
        <div className="border-t border-border pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-muted-foreground">
          <p>Â© {currentYear} DigitAI Studios. {t('rights_reserved')}</p>
          <div className="flex items-center gap-6">
             <span>{t('made_with_love')}</span>
          </div>
        </div>

      </div>
    </footer>
  );
}

// =================== FILE: src/components/layout/LanguageSwitcher.tsx ===================

'use client';

import { useLocale, useTranslations } from 'next-intl';
import { usePathname, useRouter } from '@/routing'; // ğŸ‘ˆ IMPORTANT: Importar del teu routing tipat
import { Button } from '@/components/ui/button';
import { 
  DropdownMenu, 
  DropdownMenuContent, 
  DropdownMenuItem, 
  DropdownMenuTrigger 
} from '@/components/ui/dropdown-menu'; // Assumint que tens shadcn/ui, sinÃ³ un <select> natiu
import { Globe } from 'lucide-react';
import { startTransition } from 'react';

export function LanguageSwitcher() {
  const t = useTranslations('Common.languages');
  const locale = useLocale();
  const router = useRouter();
  const pathname = usePathname();

  const handleLanguageChange = (nextLocale: 'ca' | 'es' | 'en') => {
    startTransition(() => {
      // AixÃ² substitueix el segment d'idioma de la URL actual
      router.replace(pathname, { locale: nextLocale });
    });
  };

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="icon" className="rounded-full hover:bg-muted">
          <Globe className="w-5 h-5 text-muted-foreground" />
          <span className="sr-only">Canviar idioma</span>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuItem 
          onClick={() => handleLanguageChange('ca')}
          className={locale === 'ca' ? 'bg-primary/10 font-bold' : ''}
        >
          ğŸ‡¦ğŸ‡© {t('ca')}
        </DropdownMenuItem>
        <DropdownMenuItem 
          onClick={() => handleLanguageChange('es')}
          className={locale === 'es' ? 'bg-primary/10 font-bold' : ''}
        >
          ğŸ‡ªğŸ‡¸ {t('es')}
        </DropdownMenuItem>
        <DropdownMenuItem 
          onClick={() => handleLanguageChange('en')}
          className={locale === 'en' ? 'bg-primary/10 font-bold' : ''}
        >
          ğŸ‡ºğŸ‡¸ {t('en')}
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

// =================== FILE: src/components/layout/LegalLayout.tsx ===================

'use client';

import { Navbar } from "@/components/layout/Navbar";
import { Footer } from "@/components/layout/Footer";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { cn } from "@/lib/utils";
import { Scale, Shield, Cookie, FileText } from "lucide-react";
import { createClient } from '@/lib/supabase/client';
import { useEffect, useState } from "react";
import type { User } from '@supabase/supabase-js';
import { useTranslations } from 'next-intl'; // Importem el hook

export default function LegalLayout({ children }: { children: React.ReactNode }) {
  const t = useTranslations('LegalLayout'); // Namespace LegalLayout
  const pathname = usePathname();
  const [user, setUser] = useState<User | null>(null);
  
  useEffect(() => {
    const supabase = createClient();
    supabase.auth.getUser().then(({ data }) => setUser(data.user));
  }, []);

  // Definim els links a dins per traduir-los
  const LEGAL_NAV = [
    { name: t('links.notice'), href: '/legal/avis-legal', icon: Scale },
    { name: t('links.privacy'), href: '/legal/privacitat', icon: Shield },
    { name: t('links.cookies'), href: '/legal/cookies', icon: Cookie },
  ];

  const cleanPath = pathname.replace(/^\/[a-z]{2}\//, '/').replace(/^\/[a-z]{2}$/, '');

  return (
    <div className="min-h-screen flex flex-col bg-background text-foreground">
      <Navbar user={user} />
      
      <main className="flex-1 container mx-auto px-4 py-32">
        <div className="grid lg:grid-cols-4 gap-10">
          
          {/* SIDEBAR NAVEGACIÃ“ */}
          <aside className="lg:col-span-1 hidden lg:block">
             <div className="sticky top-32 space-y-4">
                <div className="px-4">
                    <h3 className="font-bold text-lg flex items-center gap-2 text-foreground">
                        <FileText className="w-5 h-5 text-primary" /> 
                        {t('sidebar_title')}
                    </h3>
                    <p className="text-xs text-muted-foreground mt-1">
                        {t('sidebar_desc')}
                    </p>
                </div>

                <nav className="flex flex-col space-y-1">
                   {LEGAL_NAV.map((item) => {
                      const isActive = cleanPath === item.href || pathname.endsWith(item.href);

                      return (
                        <Link 
                           key={item.href} 
                           href={item.href}
                           className={cn(
                             "flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200",
                             isActive 
                               ? "bg-primary/10 text-primary border border-primary/20 shadow-sm font-bold" 
                               : "text-muted-foreground hover:bg-muted hover:text-foreground border border-transparent"
                           )}
                        >
                           <item.icon className={cn("w-4 h-4", isActive && "text-primary")} />
                           {item.name}
                        </Link>
                      )
                   })}
                </nav>
             </div>
          </aside>

          {/* MENU MÃ’BIL */}
          <div className="lg:hidden col-span-1 mb-6 overflow-x-auto pb-2 scrollbar-hide">
             <div className="flex gap-2 w-max">
                {LEGAL_NAV.map((item) => {
                    const isActive = cleanPath === item.href || pathname.endsWith(item.href);
                    return (
                        <Link 
                           key={item.href} 
                           href={item.href}
                           className={cn(
                             "flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium border transition-colors whitespace-nowrap",
                             isActive 
                               ? "bg-primary text-primary-foreground border-primary" 
                               : "bg-background border-border text-muted-foreground"
                           )}
                        >
                           <item.icon className="w-4 h-4" />
                           {item.name}
                        </Link>
                    )
                })}
             </div>
          </div>

          {/* CONTINGUT PRINCIPAL */}
          <div className="lg:col-span-3">
             <div className="bg-card border border-border rounded-3xl p-8 md:p-12 shadow-sm animate-in fade-in slide-in-from-bottom-4 duration-500">
                <article className="prose prose-slate dark:prose-invert max-w-none prose-headings:font-bold prose-a:text-primary hover:prose-a:underline prose-img:rounded-xl">
                   {children}
                </article>
             </div>
          </div>

        </div>
      </main>
      <Footer />
    </div>
  );
}

// =================== FILE: src/components/layout/Navbar.tsx ===================

'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { Button } from '@/components/ui/button';
import {
  LogOut,
  LayoutDashboard,
  Home,
  Zap,
  FolderGit2,
  BookOpen,
  User,
  ShieldAlert
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { createClient } from '@/lib/supabase/client';
import { useRouter } from 'next/navigation';
import { ThemeToggle } from "@/components/ui/theme-toggle";
import type { User as SupabaseUser } from '@supabase/supabase-js';
import { LanguageSwitcher } from './LanguageSwitcher';
import { useTranslations } from 'next-intl';

type Props = {
  user: SupabaseUser | null;
};

export function Navbar({ user }: Props) {
  const t = useTranslations('Navbar'); // Hook de traducciÃ³
  const [isScrolled, setIsScrolled] = useState(false);
  const router = useRouter();
  const pathname = usePathname();
  const supabase = createClient();

  useEffect(() => {
    const handleScroll = () => setIsScrolled(window.scrollY > 20);
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  const handleSignOut = async () => {
    await supabase.auth.signOut();
    router.refresh();
  };

  // Definim els enllaÃ§os DINS del component per poder usar 't'
  const NAV_LINKS = [
    { name: t('home'), href: '/', icon: Home },
    { name: t('solutions'), href: '/#serveis', icon: Zap },
    { name: t('projects'), href: '/projectes', icon: FolderGit2 },
    { name: t('blog'), href: '/blog', icon: BookOpen },
  ];
  // 2. DEFINIM SI Ã‰S ADMIN (Pots usar una variable d'entorn pÃºblica o hardcodejar el teu email aquÃ­ per UI)
  // Nota: La seguretat real estÃ  a /admin/layout.tsx, aixÃ² Ã©s nomÃ©s visual.
  const isAdmin = user?.email === 'digitaistudios.developer@gmail.com';
  return (
    <>
      {/* 1. TOP NAVBAR */}
      <header
        className={cn(
          "fixed top-0 w-full z-50 transition-all duration-300 border-b border-transparent",
          isScrolled
            ? "bg-background/80 backdrop-blur-md shadow-sm border-border py-3"
            : "bg-transparent py-4 md:py-6"
        )}
      >
        <div className="container mx-auto px-4 flex items-center justify-between">

          {/* LOGO */}
          <Link href="/" className="text-xl md:text-2xl font-bold tracking-tight z-50 flex items-center gap-2">
            <span className="bg-primary/10 p-1.5 rounded-lg md:hidden">
              <Zap className="w-5 h-5 text-primary" />
            </span>
            <span>DigitAI <span className="gradient-text">Studios</span></span>
          </Link>

          {/* DESKTOP NAV */}
          <nav className="hidden md:flex items-center gap-8">
            {NAV_LINKS.map((link) => (
              <Link
                key={link.name}
                href={link.href}
                className={cn(
                  "text-sm font-medium transition-colors hover:text-primary",
                  pathname === link.href ? "text-primary" : "text-muted-foreground"
                )}
              >
                {link.name}
              </Link>
            ))}

            <div className="h-6 w-px bg-border mx-2"></div>
            <ThemeToggle />
            <LanguageSwitcher />
            {/* 3. BOTÃ“ ADMIN (EXCLUSIU PER A TU) */}
            {isAdmin && (
              <Link
                href="/admin"
                className={cn(
                  "flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform",
                  pathname.startsWith('/admin') ? "text-red-500" : "text-muted-foreground hover:text-red-500"
                )}
              >
                <ShieldAlert className="w-6 h-6" strokeWidth={2} />
                <span className="text-[10px] font-bold">Admin</span>
              </Link>
            )}
            {/* AUTH BUTTONS */}
            {user ? (
              <div className="flex items-center gap-4">
                <Link href="/dashboard">
                  <Button className="gradient-bg text-white border-0 shadow-lg shadow-primary/20">
                    <LayoutDashboard className="w-4 h-4 mr-2" /> {t('dashboard')}
                  </Button>
                </Link>
                <Button variant="ghost" size="icon" onClick={handleSignOut} title={t('logout')}>
                  <LogOut className="w-5 h-5 text-muted-foreground hover:text-red-500 transition-colors" />
                </Button>
              </div>
            ) : (
              <div className="flex items-center gap-4">
                <Link href="/auth/login" className="text-sm font-medium hover:text-primary transition-colors">
                  {t('login')}
                </Link>
                <Link href="/auth/register">
                  <Button className="gradient-bg text-white border-0 shadow-lg shadow-primary/20">
                    {t('register')}
                  </Button>
                </Link>
              </div>
            )}
          </nav>

          {/* MOBILE TOGGLES */}
          <div className="flex items-center gap-2 md:hidden">
            <LanguageSwitcher />
            <ThemeToggle />
            {user && (
              <Link href="/dashboard">
                <Button size="icon" variant="ghost" className="rounded-full">
                  <img
                    src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`}
                    alt="Avatar"
                    className="w-8 h-8 rounded-full border border-border"
                  />
                </Button>
              </Link>
            )}
          </div>
        </div>
      </header>

      {/* 2. BOTTOM TAB BAR (MÃ²bil) */}
      <div className="md:hidden fixed bottom-0 left-0 w-full z-50 bg-background/90 backdrop-blur-xl border-t border-border pb-safe">
        <div className="flex justify-around items-center h-16 px-2">

          {NAV_LINKS.slice(0, 4).map((link) => {
            const Icon = link.icon;
            const isActive = pathname === link.href;

            return (
              <Link
                key={link.name}
                href={link.href}
                className={cn(
                  "flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform",
                  isActive ? "text-primary" : "text-muted-foreground hover:text-foreground"
                )}
              >
                <Icon className={cn("w-6 h-6", isActive && "fill-current/20")} strokeWidth={isActive ? 2.5 : 2} />
                <span className="text-[10px] font-medium">{link.name}</span>
              </Link>
            )
          })}

          {user ? (
            <Link
              href="/dashboard"
              className={cn(
                "flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform",
                pathname.startsWith('/dashboard') ? "text-primary" : "text-muted-foreground"
              )}
            >
              <LayoutDashboard className="w-6 h-6" strokeWidth={2} />
              <span className="text-[10px] font-medium">Dash</span>
            </Link>
          ) : (
            <Link
              href="/auth/login"
              className="flex flex-col items-center justify-center w-full h-full gap-1 active:scale-95 transition-transform text-muted-foreground hover:text-foreground"
            >
              <User className="w-6 h-6" strokeWidth={2} />
              <span className="text-[10px] font-medium">Login</span>
            </Link>
          )}

        </div>
      </div>
    </>
  );
}

// =================== FILE: src/components/theme-provider.tsx ===================

"use client"

import * as React from "react"
import { ThemeProvider as NextThemesProvider } from "next-themes"

export function ThemeProvider({
  children,
  ...props
}: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}

// =================== FILE: src/components/ui/avatar.tsx ===================

"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }


// =================== FILE: src/components/ui/button.tsx ===================

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

// DefiniciÃ³ de les variants de disseny
const buttonVariants = cva(
  "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline: "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, ...props }, ref) => {
    return (
      <button
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }

// =================== FILE: src/components/ui/card.tsx ===================

import * as React from "react"
import { cn } from "@/lib/utils"

const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("rounded-lg border bg-card text-card-foreground shadow-sm", className)} {...props} />
  )
)
Card.displayName = "Card"

const CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("flex flex-col space-y-1.5 p-6", className)} {...props} />
  )
)
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(
  ({ className, ...props }, ref) => (
    <h3 ref={ref} className={cn("text-2xl font-semibold leading-none tracking-tight", className)} {...props} />
  )
)
CardTitle.displayName = "CardTitle"

const CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
  )
)
CardContent.displayName = "CardContent"

export { Card, CardHeader, CardTitle, CardContent }

// =================== FILE: src/components/ui/checkbox.tsx ===================

"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="grid place-content-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }


// =================== FILE: src/components/ui/dropdown-menu.tsx ===================

'use client';

import * as React from 'react';
import { cn } from '@/lib/utils';

// Context per gestionar l'estat obert/tancat
const DropdownContext = React.createContext<{
  open: boolean;
  setOpen: (open: boolean) => void;
} | null>(null);

export const DropdownMenu = ({ children }: { children: React.ReactNode }) => {
  const [open, setOpen] = React.useState(false);
  const containerRef = React.useRef<HTMLDivElement>(null);

  // Tancar si es clica a fora
  React.useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  return (
    <DropdownContext.Provider value={{ open, setOpen }}>
      <div ref={containerRef} className="relative inline-block text-left">
        {children}
      </div>
    </DropdownContext.Provider>
  );
};

export const DropdownMenuTrigger = React.forwardRef<
  HTMLButtonElement,
  React.ButtonHTMLAttributes<HTMLButtonElement> & { asChild?: boolean }
>(({ className, children, asChild, ...props }, ref) => {
  const context = React.useContext(DropdownContext);
  if (!context) throw new Error("DropdownMenuTrigger must be used within DropdownMenu");

  
  // Si Ã©s asChild, hem de clonar l'element fill per passar-li el onClick
  if (asChild && React.isValidElement(children)) {
    const childElement = children as React.ReactElement<React.ButtonHTMLAttributes<HTMLButtonElement>>;
    return React.cloneElement(childElement, {
      onClick: (e: React.MouseEvent<HTMLButtonElement>) => {
        childElement.props.onClick?.(e);
        context.setOpen(!context.open);
      },
      'aria-expanded': context.open,
    } as typeof childElement.props);
  }

  return (
    <button
      ref={ref}
      onClick={() => context.setOpen(!context.open)}
      className={className}
      {...props}
    >
      {children}
    </button>
  );
});
DropdownMenuTrigger.displayName = "DropdownMenuTrigger";

export const DropdownMenuContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & { align?: 'start' | 'end' | 'center' }
>(({ className, align = 'center', children, ...props }, ref) => {
  const context = React.useContext(DropdownContext);
  if (!context) throw new Error("DropdownMenuContent must be used within DropdownMenu");

  if (!context.open) return null;

  const alignmentClasses = {
    start: 'left-0',
    end: 'right-0',
    center: 'left-1/2 -translate-x-1/2',
  };

  return (
    <div
      ref={ref}
      className={cn(
        "absolute z-50 mt-2 min-w-32 overflow-hidden rounded-md border border-border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95",
        alignmentClasses[align],
        className
      )}
      {...props}
    >
      {children}
    </div>
  );
});
DropdownMenuContent.displayName = "DropdownMenuContent";

export const DropdownMenuItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & { inset?: boolean }
>(({ className, inset, onClick, ...props }, ref) => {
  const context = React.useContext(DropdownContext);
  
  const handleClick = (e: React.MouseEvent<HTMLDivElement>) => {
    onClick?.(e);
    context?.setOpen(false); // Tanquem el menÃº al clicar una opciÃ³
  };

  return (
    <div
      ref={ref}
      onClick={handleClick}
      className={cn(
        "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors hover:bg-accent hover:text-accent-foreground data-disabled:pointer-events-none data-disabled:opacity-50",
        inset && "pl-8",
        className
      )}
      {...props}
    />
  );
});
DropdownMenuItem.displayName = "DropdownMenuItem";

// =================== FILE: src/components/ui/input.tsx ===================

import * as React from "react"
import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.InputHTMLAttributes<HTMLInputElement>>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }

// =================== FILE: src/components/ui/tabs.tsx ===================

"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  )
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",
        className
      )}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }


// =================== FILE: src/components/ui/textarea.tsx ===================

import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }


// =================== FILE: src/components/ui/theme-toggle.tsx ===================

"use client"

import * as React from "react"
import { Moon, Sun } from "lucide-react"
import { useTheme } from "next-themes"
import { Button } from "@/components/ui/button"

export function ThemeToggle() {
  const { setTheme, theme } = useTheme()

  return (
    <Button
      variant="ghost"
      size="icon"
      onClick={() => setTheme(theme === "light" ? "dark" : "light")}
      className="relative rounded-full hover:bg-muted transition-colors"
      aria-label="Canviar tema"
    >
      <Sun className="h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0 text-orange-500" />
      <Moon className="absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100 text-blue-400" />
    </Button>
  )
}

// =================== FILE: src/features/analytics/actions.ts ===================

'use server';

import { headers } from 'next/headers';
// ğŸ‘‡ AQUEST Ã‰S EL CANVI CLAU: Importem el repositori instanciat
import { analyticsRepository } from '@/services/container'; 
import { AnalyticsEventDTO } from '@/types/models';

type AnalyticsPayload = {
  event_name: string;
  path: string;
  session_id: string;
  referrer?: string;
  duration?: number;
  meta?: Record<string, unknown>;
};

export async function trackEventAction(data: AnalyticsPayload) {
  try {
    const headersList = await headers();
    const userAgent = headersList.get('user-agent') || 'unknown';
    
    // ConstruÃ¯m el DTO (Data Transfer Object) net
    const eventDTO: AnalyticsEventDTO = {
        event_name: data.event_name,
        path: data.path,
        session_id: data.session_id,
        referrer: data.referrer,
        duration: data.duration,
        meta: {
            ...data.meta,
            userAgent: userAgent
        },
        // Geo i Device es podrien extreure aquÃ­ si tinguÃ©ssim una llibreria de IP/UserAgent,
        // perÃ² per ara ho deixem que ho gestioni el repositori o es quedi en blanc.
        device: {
            type: 'unknown', // O extreure del userAgent
            browser: 'unknown',
            os: 'unknown'
        }
    };

    // ğŸ‘‡ Deleguem la feina bruta al Repositori
    await analyticsRepository.trackEvent(eventDTO);

    return { success: true };
  } catch (err) {
    console.error("ğŸ’¥ Error en analytics action:", err);
    // No retornem l'error real al client per seguretat
    return { success: false };
  }
}

// =================== FILE: src/features/analytics/ui/AnalyticsTracker.tsx ===================

'use client';

import { useEffect, useRef } from 'react';
import { usePathname, useSearchParams } from 'next/navigation';
// JA NO IMPORTEM SUPABASE CLIENT
import { trackEventAction } from '../actions'; 

export function AnalyticsTracker() {
  const pathname = usePathname();
  const searchParams = useSearchParams();
  // Utilitzem un ref per evitar dobles enviaments en React 18 Strict Mode
  const lastTrackedPath = useRef<string | null>(null);

  useEffect(() => {
    // 1. GestiÃ³ de l'ID de sessiÃ³ (persistent al navegador)
    let sessionId = localStorage.getItem('digitai_session_id');
    if (!sessionId) {
        sessionId = `sess_${Math.random().toString(36).slice(2)}_${Date.now()}`;
        localStorage.setItem('digitai_session_id', sessionId);
    }

    // 2. Neteja de la ruta
    const rawPath = pathname || '/';
    // Evitem trackejar dues vegades la mateixa ruta consecutiva (fix React Strict Mode)
    if (lastTrackedPath.current === rawPath) return;
    lastTrackedPath.current = rawPath;

    // 3. ExecuciÃ³ via Server Action (Segura)
    const track = async () => {
      await trackEventAction({
        event_name: 'page_view',
        path: rawPath,
        session_id: sessionId as string,
        referrer: document.referrer,
        meta: {
           screen_width: window.innerWidth,
           language: navigator.language
        }
      });
    };

    // Petit retard per no bloquejar el renderitzat inicial
    const timeout = setTimeout(track, 1000);
    return () => clearTimeout(timeout);

  }, [pathname, searchParams]); // S'executa quan canvia la ruta

  return null;
}

// =================== FILE: src/features/analytics/ui/BarListChart.tsx ===================

'use client';

import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  title: string;
  data: { name: string; value: number; color?: string }[];
};

export function BarListChart({ title, data }: Props) {
  return (
    <Card className="bg-slate-900 border-slate-800 text-slate-200 h-full flex flex-col min-h-0">      
    <CardHeader className="pb-2 pt-4 px-4 shrink-0">
      <CardTitle className="text-sm font-medium text-slate-400">{title}</CardTitle>
    </CardHeader>
      <CardContent className="flex-1 min-h-0 pb-2 px-2">
        <ResponsiveContainer width="100%" height="100%">
          {/* layout="vertical" fa les barres horitzontals */}
          <BarChart layout="vertical" data={data} margin={{ left: 0, right: 30, bottom: 0, top: 0 }} barCategoryGap={4}>
            <XAxis type="number" hide />
            <YAxis
              dataKey="name"
              type="category"
              width={100}
              tick={{ fill: '#94a3b8', fontSize: 14 }}
              interval={0}
              tickLine={false}
              axisLine={false}
              // Trunquem textos llargs
              tickFormatter={(val) => val.length > 12 ? `${val.substring(0, 12)}...` : val}
            />
            <Tooltip cursor={{ fill: '#334155', opacity: 0.2 }} contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', fontSize: '12px', color: '#fff' }} />
            <Bar dataKey="value" radius={[0, 4, 4, 0]} barSize={16}>
              {data.map((entry, index) => (
                <Cell key={`cell-${index}`} fill={entry.color || '#6366f1'} />
              ))}
            </Bar>
          </BarChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/analytics/ui/DeviceChart.tsx ===================

'use client';

import { PieChart, Pie, Cell, Tooltip, ResponsiveContainer, Legend } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  data: { name: string; value: number; fill: string }[];
};

export function DeviceChart({ data }: Props) {
  return (
    <Card className="bg-slate-900 border-slate-800 text-slate-200 h-full flex flex-col min-h-0">
      <CardHeader>
        <CardTitle>Dispositiusss</CardTitle>
      </CardHeader>
      <CardContent className="flex-1 min-h-0">
        <div className="h-full flex flex-col min-h-0">
          <ResponsiveContainer width="100%" height="100%">
            <PieChart>
              <Pie
                data={data}
                cx="50%"
                cy="50%"
                innerRadius={60}
                outerRadius={80}
                paddingAngle={5}
                dataKey="value"
              >
                {data.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.fill} stroke="rgba(0,0,0,0.2)" />
                ))}
              </Pie>
              <Tooltip 
                 contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', borderRadius: '8px' }}
                 itemStyle={{ color: '#fff' }}
              />
              <Legend verticalAlign="bottom" height={36}/>
            </PieChart>
          </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/analytics/ui/TopPagesCard.tsx ===================

'use client';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  data: { path: string; views: number }[];
};

export function TopPagesCard({ data }: Props) {
  // 1. Ordenem per vistes (de mÃ©s a menys) per seguretat
  const sortedData = [...data].sort((a, b) => b.views - a.views);
  
  // 2. Calculem el mÃ xim per fer les barres relatives (regla de 3)
  const maxViews = sortedData[0]?.views || 0;

  return (
    <Card className="bg-slate-900 border-slate-800 text-slate-200 h-full flex flex-col min-h-0">
      <CardHeader className="pb-2 pt-4 px-4 shrink-0">
        <div className="flex justify-between items-center">
             <CardTitle className="text-sm font-medium text-slate-400">Top PÃ gines</CardTitle>
             <span className="text-xs text-slate-500 font-mono">Vistes</span>
        </div>
      </CardHeader>
      
      <CardContent className="flex-1 min-h-0 pb-2 px-2">
        {/* CONTENIDOR SCROLLABLE:
            - h-full: Ocupa tot l'espai disponible
            - overflow-y-auto: Activa l'scroll vertical si no hi cap
            - pr-2: Un petit marge a la dreta perquÃ¨ l'scroll no tapi text
        */}
        <div className="h-full w-full overflow-y-auto pr-2 custom-scrollbar">
          
          {sortedData.length === 0 ? (
            <div className="flex items-center justify-center h-full text-slate-500 text-xs">
              Sense dades suficients
            </div>
          ) : (
            <div className="flex flex-col gap-3">
              {sortedData.map((page, index) => {
                // Calculem el % d'amplada de la barra
                const percentage = maxViews > 0 ? (page.views / maxViews) * 100 : 0;

                return (
                  <div key={index} className="group">
                    {/* Fila superior: URL i NÃºmero */}
                    <div className="flex justify-between text-xs mb-1">
                      <span className="truncate pr-4 text-slate-300 font-medium" title={page.path}>
                        {page.path}
                      </span>
                      <span className="text-slate-400 font-mono tabular-nums">
                        {page.views}
                      </span>
                    </div>
                    
                    {/* Barra de progrÃ©s visual */}
                    <div className="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                      <div 
                        className="h-full bg-indigo-500 rounded-full transition-all duration-500 ease-out group-hover:bg-indigo-400"
                        style={{ width: `${percentage}%` }}
                      />
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/analytics/ui/TrafficChart.tsx ===================

'use client';

import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  data: { date: string; visitors: number; views: number }[];
};

export function TrafficChart({ data }: Props) {
  return (
    <Card className="bg-slate-900 border-slate-800 text-slate-200 col-span-2 h-full flex flex-col min-h-0">      <CardHeader>
      <CardTitle>TrÃ nsit (Ãšltims 7 dies)</CardTitle>
    </CardHeader>
      <CardContent className="flex-1 min-h-0 pb-2 px-2">
        <div className="h-full flex flex-col min-h-0">
          <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={data}>
              <defs>
                <linearGradient id="colorViews" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#8884d8" stopOpacity={0.3} />
                  <stop offset="95%" stopColor="#8884d8" stopOpacity={0} />
                </linearGradient>
                <linearGradient id="colorVisitors" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#82ca9d" stopOpacity={0.3} />
                  <stop offset="95%" stopColor="#82ca9d" stopOpacity={0} />
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
              <XAxis dataKey="date" stroke="#94a3b8" />
              <YAxis stroke="#94a3b8" />
              <Tooltip
                contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', color: '#f1f5f9' }}
              />
              <Area type="monotone" dataKey="views" stroke="#8884d8" fillOpacity={1} fill="url(#colorViews)" name="Vistes de PÃ gina" />
              <Area type="monotone" dataKey="visitors" stroke="#82ca9d" fillOpacity={1} fill="url(#colorVisitors)" name="Usuaris Ãšnics" />
            </AreaChart>
          </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/analytics/ui/UnifiedStatBar.tsx ===================

import { Card } from '@/components/ui/card';
import { Users, Eye, MousePointerClick, Clock, TrendingUp } from 'lucide-react';

interface UnifiedStatBarProps {
  views: number;
  visitors: number;
  events: number;
  avgTime: string;
}

interface StatItemProps {
  label: string;
  value: number | string;
  icon: React.ReactNode;
}

export function UnifiedStatBar({ views, visitors, events, avgTime }: UnifiedStatBarProps) {
  return (
    <Card className="bg-slate-900 border-slate-800 text-slate-200 p-4 shadow-lg">
        <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
        
            {/* TÃ­tol: Al mÃ²bil a dalt, a l'escriptori a l'esquerra amb vora */}
            <div className="flex items-center gap-3 lg:pr-8 lg:border-r lg:border-slate-800 pb-4 lg:pb-0 border-b border-slate-800 lg:border-b-0">
                <div className="p-2 bg-primary/10 rounded-lg">
                    <TrendingUp className="text-primary h-6 w-6" />
                </div>
                <div>
                    <h1 className="text-lg font-bold text-white leading-tight">Dashboard</h1>
                    <p className="text-xs text-slate-500">Temps real</p>
                </div>
            </div>

            {/* MÃ¨triques: Grid 2x2 al mÃ²bil, Flex row a l'escriptori */}
            <div className="flex-1 grid grid-cols-2 gap-y-6 lg:flex lg:justify-around lg:items-center">
                <StatItem label="Vistes (7d)" value={views} icon={<Eye className="h-4 w-4 text-blue-400" />} />
                
                {/* Separador nomÃ©s en escriptori */}
                <div className="hidden lg:block h-8 w-px bg-slate-800" />
                
                <StatItem label="Usuaris" value={visitors} icon={<Users className="h-4 w-4 text-green-400" />} />
                
                <div className="hidden lg:block h-8 w-px bg-slate-800" />
                
                <StatItem label="Events" value={events} icon={<MousePointerClick className="h-4 w-4 text-purple-400" />} />
                
                <div className="hidden lg:block h-8 w-px bg-slate-800" />
                
                <StatItem label="Temps MitjÃ " value={avgTime} icon={<Clock className="h-4 w-4 text-orange-400" />} />
            </div>
        </div>
    </Card>
  );
}

// StatItem es queda igual
function StatItem({ label, value, icon }: StatItemProps) {
    return (
        <div className="flex flex-col items-center gap-1 min-w-[100px]">
            <span className="text-[10px] uppercase tracking-wider text-slate-500 font-bold flex items-center gap-2">
                {icon} {label}
            </span>
            <span className="text-2xl font-bold text-white leading-none">
                {value}
            </span>
        </div>
    )
}

// =================== FILE: src/features/analytics/ui/VerticalBarChart.tsx ===================

'use client';

import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

type Props = {
  title: string;
  data: { name: string; value: number; color?: string }[];
};

export function VerticalBarChart({ title, data }: Props) {
  return (
    <Card className="bg-slate-900 border-slate-800 text-slate-200 h-full flex flex-col">
      <CardHeader className="pb-2">
        <CardTitle className="text-base font-medium text-slate-300">{title}</CardTitle>
      </CardHeader>
      <CardContent className="flex-1 min-h-[200px]">
        <ResponsiveContainer width="100%" height="100%">
          <BarChart data={data} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
            <XAxis 
              dataKey="name" 
              stroke="#64748b" 
              fontSize={14} 
              tickLine={false}
              axisLine={false}
              interval={0} // Mostra totes les etiquetes
              // Si els noms sÃ³n llargs, els trunquem
              tickFormatter={(value) => value.length > 6 ? `${value.substring(0, 6)}..` : value}
            />
            <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
            <Tooltip 
              cursor={{ fill: '#334155', opacity: 0.2 }}
              contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', color: '#f1f5f9', borderRadius: '8px', fontSize: '12px' }}
            />
            <Bar dataKey="value" radius={[4, 4, 0, 0]}>
              {data.map((entry, index) => (
                <Cell key={`cell-${index}`} fill={entry.color || '#10b981'} />
              ))}
            </Bar>
          </BarChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/audit/actions.ts ===================

'use server';

import { auditService } from '@/services/container';
import { z } from 'zod';
import { redirect } from 'next/navigation';
import { getLocale } from 'next-intl/server';
import { createClient } from '@/lib/supabase/server';

// --- 1. SCHEMAS DE VALIDACIÃ“ ---

const PublicAuditSchema = z.object({
  url: z.string().url({ message: "La URL ha de ser vÃ lida (https://...)" }),
  email: z.string().email({ message: "L'email no Ã©s correcte" }),
});

const PrivateAuditSchema = z.string().url();

// --- 2. TIPUS PER A ELS FORMULARIS ---

export type FormState = {
  success?: boolean;
  message?: string;
  errors?: {
    url?: string[];
    email?: string[];
  };
};

// --- 3. ACTION PÃšBLICA (Landing Page) ---
// Aquesta Ã©s la que crida l'AuditForm de la home
export async function processWebAudit(prevState: FormState, formData: FormData): Promise<FormState> {
  const locale = await getLocale();

  const rawData = {
    url: formData.get('url'),
    email: formData.get('email'),
  };

  // 1. Validem URL i Email
  const validation = PublicAuditSchema.safeParse(rawData);

  if (!validation.success) {
    return {
      success: false,
      errors: validation.error.flatten().fieldErrors,
      message: "Revisa les dades del formulari.",
    };
  }

  try {
    // 2. Cridem al servei per fer l'auditoria PÃšBLICA
    // (Aquest mÃ¨tode s'encarregarÃ  de crear l'usuari o lligar-ho per email)
    await auditService.performPublicAudit(validation.data.url, validation.data.email, locale);
    
  } catch (err) {
    console.error(err);
    return { success: false, message: "Error durant l'anÃ lisi. Prova mÃ©s tard." };
  }

  // 3. RedirecciÃ³ a Registre (perquÃ¨ vegi el resultat allÃ )
  redirect(`/${locale}/auth/register?email=${encodeURIComponent(validation.data.email)}`);
}


// --- 4. ACTION PRIVADA (Dashboard) ---
// Aquesta Ã©s la que crida el CreateAuditForm del panell
export async function createAuditAction(url: string) {
  const locale = await getLocale();
  let auditId = null;

  // 1. Validem nomÃ©s URL
  const validation = PrivateAuditSchema.safeParse(url);
  if (!validation.success) {
    return { success: false, message: 'URL invÃ lida.' };
  }

  // 2. Comprovem sessiÃ³
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user || !user.email) {
    return { success: false, message: 'No estÃ s autenticat.' };
  }

  try {
    // 3. Cridem al servei per fer l'auditoria PRIVADA (ja tenim user.id)
    auditId = await auditService.performUserAudit(url, user.id, user.email, locale);

  } catch (e) {
    console.error(e);
    return { success: false, message: 'Error al processar l\'auditoria.' };
  }

  // 4. RedirecciÃ³ al detall de l'informe
  if (auditId) {
    redirect(`/${locale}/dashboard/audits/${auditId}`);
  }
  
  return { success: false, message: 'Error desconegut al crear.' };
}

// =================== FILE: src/features/audit/ui/AuditForm.tsx ===================

'use client';

import { useActionState } from 'react';
import { processWebAudit } from '../actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Search, Loader2, AlertCircle } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function AuditForm() {
  const [state, action, isPending] = useActionState(processWebAudit, { message: '', errors: {} });
  const t = useTranslations('AuditForm');

  return (
    <div className="w-full">
      <div className="border border-border rounded-2xl p-8 bg-white/50 dark:bg-white/2 backdrop-blur-xl shadow-xl dark:shadow-2xl transition-all duration-300">
        
        <h3 className="text-xl font-bold text-center text-foreground mb-6 flex items-center justify-center gap-2">
          <Search className="w-5 h-5 text-primary" />
          {t('title')}
        </h3>
        
        <form action={action} className="space-y-4">
          <div className="space-y-1">
            <Input 
              name="url" 
              placeholder={t('placeholder_url')} 
              className="bg-white dark:bg-white/5 border-slate-200 dark:border-white/10 text-foreground h-12 focus:border-primary/50 placeholder:text-muted-foreground transition-all"
            />
            {state.errors?.url && (
              <p className="text-red-500 text-xs flex items-center gap-1 mt-1 ml-1">
                <AlertCircle className="w-3 h-3" /> {state.errors.url[0]}
              </p>
            )}
          </div>

          <div className="space-y-1">
            <Input 
              name="email" 
              placeholder={t('placeholder_email')} 
              className="bg-white dark:bg-white/5 border-slate-200 dark:border-white/10 text-foreground h-12 focus:border-primary/50 placeholder:text-muted-foreground transition-all"
            />
            {state.errors?.email && (
              <p className="text-red-500 text-xs flex items-center gap-1 mt-1 ml-1">
                <AlertCircle className="w-3 h-3" /> {state.errors.email[0]}
              </p>
            )}
          </div>

          <Button 
            type="submit" 
            disabled={isPending} 
            className="w-full h-12 mt-2 text-base font-semibold rounded-lg gradient-bg text-white border-0 hover:opacity-90 shadow-lg shadow-primary/20 transition-all"
          >
            {isPending ? (
              <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> {t('cta_loading')}</>
            ) : (
              t('cta_button')
            )}
          </Button>
          
          {state.message && (
            <p className="text-center text-muted-foreground text-sm mt-4 bg-muted/50 p-2 rounded-lg border border-border/50">
              {state.message}
            </p>
          )}
        </form>
      </div>
      
      <p className="text-center text-xs text-muted-foreground mt-4 opacity-60">
        {t('privacy_note')}
      </p>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/AuditHeader.tsx ===================

import { Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Share2 } from 'lucide-react';
// ğŸ‘‡ Importem el botÃ³ real
import { DownloadAuditButton } from './DownloadAuditButton';
// ğŸ‘‡ 1. Importem el tipus correcte per als issues
import { AuditIssue } from '@/adapters/IWebScanner';

type Props = { 
  url: string; 
  date: Date;
  pdfData: {
    url: string;
    date: string;
    scores: { seo: number; perf: number; a11y: number; best: number };
    screenshot?: string;
    // ğŸ‘‡ 2. Corregim 'any[]' per 'AuditIssue[]'
    issues: AuditIssue[];
    
  }
};

export function AuditHeader({ url, date, pdfData }: Props) {
  return (
    <div className="flex flex-col md:flex-row md:items-center justify-between gap-6 border-b border-white/5 pb-6">
      <div>
        <Link href="/dashboard" className="text-xs font-medium text-slate-400 hover:text-primary flex items-center gap-1 mb-3 transition-colors uppercase tracking-wider">
          <ArrowLeft className="w-3 h-3" /> Tornar al Dashboard
        </Link>
        <h1 className="text-3xl md:text-4xl font-bold text-white tracking-tight truncate max-w-2xl">
          Informe: <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-primary">{url}</span>
        </h1>
        <p className="text-sm text-slate-500 mt-2 font-mono">
          ID: {date.getTime().toString(36).toUpperCase()} â€¢ Generat el {date.toLocaleDateString()}
        </p>
      </div>
      
      <div className="flex gap-3">
        <Button variant="outline" className="border-slate-700 text-slate-300 hover:bg-slate-800 hover:text-white">
            <Share2 className="w-4 h-4 mr-2" /> Compartir
        </Button>
        
        {/* BotÃ³ de descarrega */}
        <DownloadAuditButton data={pdfData} />
      </div>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/CoreVitalsGrid.tsx ===================

import { Zap, LayoutTemplate, MoveHorizontal, Clock, Gauge } from 'lucide-react';

// Tipus locals per la UI (no cal importar el Zod schema aquÃ­, per mantenir desacoblament)
export type AuditMetric = {
  score?: number | null;
  value?: string;
  description?: string;
};

type LighthouseAuditUI = {
  id: string;
  title?: string;
  description?: string;
  score?: number | null;
  displayValue?: string;
};

type CoreVitalsGridProps = {
  metrics?: {
    fcp?: AuditMetric;
    lcp?: AuditMetric;
    cls?: AuditMetric;
    tbt?: AuditMetric;
    si?: AuditMetric;
  };
  googleAudits?: Record<string, LighthouseAuditUI>;
};

export function CoreVitalsGrid({ metrics, googleAudits }: CoreVitalsGridProps) {
  
  const getMetric = (key: string, googleKey: string): AuditMetric => {
    // 1. Prioritat: Dades netes processades
    if (metrics && metrics[key as keyof typeof metrics]) {
      return metrics[key as keyof typeof metrics]!;
    }
    
    // 2. Fallback: Dades crues
    if (googleAudits && googleAudits[googleKey]) {
      const audit = googleAudits[googleKey];
      return {
        score: audit.score,
        value: audit.displayValue,
        description: audit.title
      };
    }

    return { score: null, value: 'N/A', description: 'No disponible' };
  };

  const fcp = getMetric('fcp', 'first-contentful-paint');
  const lcp = getMetric('lcp', 'largest-contentful-paint');
  const cls = getMetric('cls', 'cumulative-layout-shift');
  const tbt = getMetric('tbt', 'total-blocking-time');
  const si = getMetric('si', 'speed-index');

  // Si no hi ha dades, no pintem res
  if (fcp.value === 'N/A' && lcp.value === 'N/A') return null;

  return (
    <div className="mb-8">
      <h2 className="text-xl font-bold text-foreground mb-4 flex items-center gap-2">
        <span className="w-1.5 h-6 bg-primary rounded-full"></span>
        MÃ¨triques de Rendiment (Core Web Vitals)
      </h2>
      
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
        <MetricCard title="FCP" subtitle="First Contentful Paint" value={fcp.value || "N/A"} score={fcp.score} icon={Zap} tooltip="Temps fins primer contingut." />
        <MetricCard title="LCP" subtitle="Largest Contentful Paint" value={lcp.value || "N/A"} score={lcp.score} icon={LayoutTemplate} tooltip="Temps element mÃ©s gran." />
        <MetricCard title="CLS" subtitle="Cumulative Layout Shift" value={cls.value || "N/A"} score={cls.score} icon={MoveHorizontal} tooltip="Estabilitat visual." />
        <MetricCard title="TBT" subtitle="Total Blocking Time" value={tbt.value || "N/A"} score={tbt.score} icon={Clock} tooltip="Temps de bloqueig." />
        <MetricCard title="SI" subtitle="Speed Index" value={si.value || "N/A"} score={si.score} icon={Gauge} tooltip="Ãndex de velocitat." />
      </div>
    </div>
  );
}

// ... (El component MetricCard es queda igual que al teu codi original)
type MetricCardProps = {
    title: string;
    subtitle: string;
    value: string;
    score?: number | null;
    icon: React.ElementType;
    tooltip?: string;
};
  
function MetricCard({ title, subtitle, value, score, icon: Icon, tooltip }: MetricCardProps) {
    let colorClass = 'text-slate-500 dark:text-slate-400';
    let bgClass = 'bg-slate-100 border-slate-200 dark:bg-slate-800/50 dark:border-slate-700';
    let iconColor = 'text-slate-400';

    if (typeof score === 'number') {
        if (score >= 0.9) {
            colorClass = 'text-green-600 dark:text-green-400';
            bgClass = 'bg-green-50 border-green-200 dark:bg-green-500/10 dark:border-green-500/20';
            iconColor = 'text-green-500';
        } else if (score >= 0.5) {
            colorClass = 'text-yellow-600 dark:text-yellow-400';
            bgClass = 'bg-yellow-50 border-yellow-200 dark:bg-yellow-500/10 dark:border-yellow-500/20';
            iconColor = 'text-yellow-500';
        } else {
            colorClass = 'text-red-600 dark:text-red-400';
            bgClass = 'bg-red-50 border-red-200 dark:bg-red-500/10 dark:border-red-500/20';
            iconColor = 'text-red-500';
        }
    }

    return (
        <div className={`p-4 rounded-xl border ${bgClass} flex flex-col items-center text-center transition-all hover:scale-[1.02] h-full justify-between`} title={tooltip}>
            <div className="flex flex-col items-center">
                <div className={`mb-3 p-2.5 rounded-full bg-background/50 ${iconColor}`}>
                    <Icon className="w-5 h-5" />
                </div>
                <span className="text-sm font-bold text-foreground mb-1">{title}</span>
                <span className="text-[10px] text-muted-foreground uppercase tracking-wide mb-2 px-2 line-clamp-1">{subtitle}</span>
            </div>
            <span className={`text-2xl font-extrabold ${colorClass}`}>{value}</span>
        </div>
    )
}

// =================== FILE: src/features/audit/ui/components/CreateAuditForm.tsx ===================

'use client';

import { useState } from 'react';
// Ja no necessitem useRouter ni router.push!
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Loader2, Search, Globe } from 'lucide-react';
import { createAuditAction } from '../../actions';

export function CreateAuditForm() {
  const [url, setUrl] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError('');

    // Cridem a l'acciÃ³.
    // Si tÃ© Ã¨xit, l'acciÃ³ farÃ  redirect i aquesta funciÃ³ s'aturarÃ  aquÃ­.
    // Si falla, ens retornarÃ  l'objecte amb l'error.
    const result = await createAuditAction(url);
    
    // Si arribem a aquesta lÃ­nia, vol dir que NO ha redirigit (per tant, hi ha hagut error)
    if (result && !result.success) {
        setError(result.message || 'Error desconegut');
        setIsLoading(false); // NomÃ©s parem loading si hi ha error
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="space-y-2">
         <label className="text-sm font-medium text-slate-300 ml-1">URL del Lloc Web</label>
         <div className="relative">
            <Globe className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500" />
            <Input 
               type="url" 
               placeholder="https://exemple.com" 
               value={url}
               onChange={(e) => setUrl(e.target.value)}
               required
               disabled={isLoading} // Desactivem mentre carrega
               className="pl-10 bg-white/5 border-white/10 text-white h-12 focus:border-primary focus:ring-primary placeholder:text-slate-600"
            />
         </div>
      </div>

      {error && (
         <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm">
            {error}
         </div>
      )}

      <Button 
         type="submit" 
         disabled={isLoading || !url} 
         className="w-full h-12 gradient-bg text-white font-bold rounded-xl hover:opacity-90 transition-all shadow-lg shadow-primary/20"
      >
         {isLoading ? (
            <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Analitzant Web...</>
         ) : (
            <><Search className="w-4 h-4 mr-2" /> ComenÃ§ar AnÃ lisi</>
         )}
      </Button>
      
      <p className="text-xs text-center text-slate-500">
         L'anÃ lisi pot trigar entre 10 i 30 segons. Si us plau, no tanquis la pÃ gina.
      </p>
    </form>
  );
}

// =================== FILE: src/features/audit/ui/components/DownloadAuditButton.tsx ===================

'use client';

import React from 'react';
import dynamic from 'next/dynamic';
import { Button } from '@/components/ui/button';
import { Download, Loader2 } from 'lucide-react';
// Assegura't que el nom del fitxer coincideix exactament (MajÃºscules/minÃºscules)
import { AuditPDFDocument } from '@/features/audit/ui/pdf/AuditPdfDocument'; 
import { AuditIssue } from '@/adapters/IWebScanner';

const PDFDownloadLink = dynamic(
  () => import('@react-pdf/renderer').then((mod) => mod.PDFDownloadLink),
  { 
    ssr: false,
    loading: () => (
      <Button variant="outline" disabled className="bg-background text-muted-foreground border-border">
         <Loader2 className="w-4 h-4 mr-2 animate-spin" /> Preparant PDF...
      </Button>
    )
  }
);

type Props = {
  data: {
    url: string;
    date: string;
    scores: { seo: number; perf: number; a11y: number; best: number };
    screenshot?: string;
    issues: AuditIssue[]; 
  }
};

export function DownloadAuditButton({ data }: Props) {
  return (
    <PDFDownloadLink
      document={
        <AuditPDFDocument 
            url={data.url}
            date={data.date}
            scores={data.scores}
            screenshot={data.screenshot}
            issues={data.issues}
        />
      }
      fileName={`audit-${data.url.replace(/[^a-z0-9]/gi, '_')}.pdf`}
    >
      {({ loading }) => (
        <Button 
            // Canviem l'estil perquÃ¨ sigui consistent amb el tema
            className="bg-primary text-primary-foreground hover:bg-primary/90 shadow-sm"
            disabled={loading}
        >
          {loading ? (
            <>
               <Loader2 className="w-4 h-4 mr-2 animate-spin" /> Generant...
            </>
          ) : (
            <>
               <Download className="w-4 h-4 mr-2" /> Descarregar PDF
            </>
          )}
        </Button>
      )}
    </PDFDownloadLink>
  );
}

// =================== FILE: src/features/audit/ui/components/IssuesList.tsx ===================

'use client'; // Important: useTranslations funciona en Client Components o Server Components, perÃ² aquÃ­ ja Ã©s client.

import { Card, CardContent } from '@/components/ui/card';
import { AlertTriangle, CheckCircle } from 'lucide-react';
import { AuditIssue } from '@/adapters/IWebScanner';
import { useTranslations } from 'next-intl';

type Props = { issues: AuditIssue[] };

export function IssuesList({ issues }: Props) {
  const t = useTranslations('AuditIssues'); // namespace 'AuditIssues'

  return (
    <div className="mt-12">
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-bold text-foreground flex items-center gap-2">
           <AlertTriangle className="text-yellow-500" />
           {/* Pots traduir tambÃ© aquest tÃ­tol si vols */}
           Accions Recomanades
        </h2>
        <span className="bg-red-500/10 text-red-600 dark:text-red-400 text-xs font-bold px-3 py-1 rounded-full border border-red-500/20">
           {issues?.length || 0} Errors CrÃ­tics
        </span>
      </div>
      
      <div className="grid gap-4">
        {issues?.map((issue, index) => {
           // LÃ’GICA DE TRADUCCIÃ“ INTELÂ·LIGENT
           // 1. Mirem si tenim traducciÃ³ per aquest ID especÃ­fic (ex: 'server-response-time.title')
           // 2. Si no, fem servir el text original que ve de Google (fallback)
           
           const hasTranslation = t.has(`${issue.id}.title`);
           const title = hasTranslation ? t(`${issue.id}.title`) : issue.title;
           const description = hasTranslation ? t(`${issue.id}.description`) : issue.description;

           return (
             <Card key={index} className="bg-card border border-border hover:border-primary/50 transition-colors group shadow-sm">
                <CardContent className="p-5 flex gap-4">
                   <div className="shrink-0 mt-1">
                      <div className="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
                   </div>
                   <div className="flex-1">
                      <h3 className="font-bold text-foreground group-hover:text-primary transition-colors text-lg mb-1">
                          {title}
                      </h3>
                      <p className="text-sm text-muted-foreground leading-relaxed mb-3">
                          {description}
                      </p>
                      {issue.displayValue && (
                          <div className="inline-flex items-center gap-2 px-3 py-1 rounded bg-red-500/5 border border-red-500/10 text-xs font-mono text-red-600 dark:text-red-400">
                              <span>Dada:</span>
                              <span className="font-bold">{issue.displayValue}</span>
                          </div>
                      )}
                   </div>
                </CardContent>
             </Card>
           );
        })}
        
        {(!issues || issues.length === 0) && (
            <div className="text-center py-12 bg-muted/30 rounded-xl border border-dashed border-border">
                <CheckCircle className="w-12 h-12 text-green-500 mx-auto mb-4 opacity-50" />
                <p className="text-muted-foreground">IncreÃ¯ble! No hem trobat errors crÃ­tics.</p>
            </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/MobilePreviw.tsx ===================

import Image from 'next/image';

export function MobilePreview({ screenshot }: { screenshot: string }) {
  if (!screenshot) return null;
  
  return (
    <div className="mt-8 flex flex-col items-center">
      <h2 className="text-xl font-bold text-white mb-6">Vista PrÃ¨via MÃ²bil</h2>
      {/* Mockup Minimalista Fosc */}
      <div className="relative border-slate-800 bg-slate-900 border-[10px] rounded-[2.5rem] h-[600px] w-[300px] shadow-2xl shadow-black">
         <div className="h-[32px] w-[3px] bg-slate-800 absolute -start-[13px] top-[72px] rounded-s-lg"></div>
         <div className="h-[46px] w-[3px] bg-slate-800 absolute -start-[13px] top-[124px] rounded-s-lg"></div>
         <div className="h-[46px] w-[3px] bg-slate-800 absolute -start-[13px] top-[178px] rounded-s-lg"></div>
         <div className="h-[64px] w-[3px] bg-slate-800 absolute -end-[13px] top-[142px] rounded-e-lg"></div>
         <div className="rounded-[2rem] overflow-hidden w-[280px] h-[580px] bg-black">
            <Image
                src={screenshot}
                alt="Mobile Screenshot"
                width={280}
                height={580}
                className="w-full h-full object-cover opacity-90 hover:opacity-100 transition-opacity"
                unoptimized
            />
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/features/audit/ui/components/ScoreGrid.tsx ===================

import { Card, CardContent } from '@/components/ui/card';
import { ScoreRing } from '@/components/charts/ScoreRing';

type Props = { seo: number; perf: number };

export function ScoreGrid({ seo, perf }: Props) {
  return (
    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
      <ScoreCard score={seo} label="SEO" />
      <ScoreCard score={perf} label="Rendiment" />
      <ScoreCard score={85} label="Accessibilitat" />
      <ScoreCard score={92} label="Best Practices" />
    </div>
  );
}

function ScoreCard({ score, label }: { score: number; label: string }) {
  return (
    // Canviem bg-[#0f111a]/50 per bg-background/40 o bg-card
    <Card className="bg-background/40 border border-border hover:border-primary/20 transition-colors backdrop-blur-md shadow-sm">
      <CardContent className="pt-6 pb-6 flex justify-center">
        <ScoreRing score={score} label={label} />
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/audit/ui/pdf/AuditPdfDocument.tsx ===================

import React from 'react';
import { Page, Text, View, Document, StyleSheet, Image } from '@react-pdf/renderer';

// Definim els tipus de dades que necessitem
type Issue = {
  title: string;
  description: string;
};

type Props = {
  url: string;
  date: string;
  scores: { seo: number; perf: number; a11y: number; best: number };
  screenshot?: string;
  issues: Issue[];
};

// ESTILS DEL PDF (Semblant a CSS perÃ² en objecte JS)
const styles = StyleSheet.create({
  page: {
    flexDirection: 'column',
    backgroundColor: '#0f111a', // Fons fosc
    color: '#ffffff',
    padding: 30,
    fontFamily: 'Helvetica',
  },
  header: {
    marginBottom: 20,
    borderBottomWidth: 1,
    borderBottomColor: '#334155',
    paddingBottom: 10,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  title: { fontSize: 24, fontWeight: 'bold', color: '#ffffff' },
  subtitle: { fontSize: 10, color: '#94a3b8', marginTop: 4 },
  brand: { fontSize: 10, color: '#7c3aed', textTransform: 'uppercase' }, // Lila de marca
  
  // Grid de Puntuacions
  scoresContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 30,
    backgroundColor: '#1e293b',
    padding: 15,
    borderRadius: 8,
  },
  scoreItem: { alignItems: 'center', width: '25%' },
  scoreValue: { fontSize: 28, fontWeight: 'bold' },
  scoreLabel: { fontSize: 10, color: '#94a3b8', marginTop: 4, textTransform: 'uppercase' },

  // SecciÃ³ MÃ²bil
  sectionTitle: { fontSize: 16, marginBottom: 10, color: '#ffffff', marginTop: 10 },
  imageContainer: {
    alignItems: 'center',
    marginBottom: 20,
    padding: 10,
    backgroundColor: '#1e293b',
    borderRadius: 8,
  },
  screenshot: { width: 200, height: 400, borderRadius: 4, objectFit: 'contain' },

  // Llista d'Errors
  issueCard: {
    marginBottom: 8,
    padding: 10,
    backgroundColor: '#ffffff', // Targetes blanques per contrast de lectura
    borderRadius: 4,
    borderLeftWidth: 4,
    borderLeftColor: '#ef4444', // Vermell error
  },
  issueTitle: { fontSize: 12, color: '#0f111a', fontWeight: 'bold' },
  issueDesc: { fontSize: 10, color: '#475569', marginTop: 2 },
  
  footer: {
    position: 'absolute',
    bottom: 30,
    left: 30,
    right: 30,
    textAlign: 'center',
    fontSize: 8,
    color: '#64748b',
    borderTopWidth: 1,
    borderTopColor: '#334155',
    paddingTop: 10,
  }
});

// Helper per colors
const getScoreColor = (score: number) => {
  if (score >= 90) return '#4ade80'; // Verd
  if (score >= 50) return '#facc15'; // Groc
  return '#f87171'; // Vermell
};

export const AuditPDFDocument = ({ url, date, scores, screenshot, issues }: Props) => (
  <Document>
    <Page size="A4" style={styles.page}>
      
      {/* 1. HEADER */}
      <View style={styles.header}>
        <View>
            <Text style={styles.brand}>DigitAI Studios Audit</Text>
            <Text style={styles.title}>Informe d'Auditoria</Text>
            <Text style={styles.subtitle}>{url}</Text>
        </View>
        <View>
            <Text style={styles.subtitle}>{date}</Text>
        </View>
      </View>

      {/* 2. PUNTUACIONS */}
      <View style={styles.scoresContainer}>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.seo) }]}>{scores.seo}</Text>
            <Text style={styles.scoreLabel}>SEO</Text>
        </View>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.perf) }]}>{scores.perf}</Text>
            <Text style={styles.scoreLabel}>Rendiment</Text>
        </View>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.a11y) }]}>{scores.a11y}</Text>
            <Text style={styles.scoreLabel}>Accessibilitat</Text>
        </View>
        <View style={styles.scoreItem}>
            <Text style={[styles.scoreValue, { color: getScoreColor(scores.best) }]}>{scores.best}</Text>
            <Text style={styles.scoreLabel}>Best Practices</Text>
        </View>
      </View>

      {/* 3. CAPTURA DE PANTALLA (Si n'hi ha) */}
      {screenshot && (
        <View style={styles.imageContainer}>
            <Text style={[styles.subtitle, { marginBottom: 10 }]}>Vista PrÃ¨via Dispositiu MÃ²bil</Text>
            <Image src={screenshot} style={styles.screenshot} />
        </View>
      )}

      {/* 4. LLISTA D'ERRORS */}
      <Text style={styles.sectionTitle}>Accions Recomanades ({issues.length})</Text>
      {issues.slice(0, 8).map((issue, index) => ( // Limitem a 8 per no fer 50 pÃ gines de cop
        <View key={index} style={styles.issueCard}>
            <Text style={styles.issueTitle}>{issue.title}</Text>
            <Text style={styles.issueDesc}>{issue.description}</Text>
        </View>
      ))}

      {/* 5. FOOTER */}
      <Text style={styles.footer}>
        Generat automÃ ticament per DigitAI Studios. Aquest informe Ã©s privat i confidencial.
        Visita'ns a https://digitaistudios.com per a mÃ©s serveis.
      </Text>

    </Page>
  </Document>
);

// =================== FILE: src/features/auth/actions/reset-password.ts ===================

// =================== FILE: src/features/auth/actions/reset-password.ts ===================

'use server'

import { z } from 'zod';
import { createClient } from '@/lib/supabase/server';
import { getLocale } from 'next-intl/server';
import { redirect } from '@/routing'; // Usem el teu routing tipat

// Esquema per solÂ·licitar el reset
const ForgotPasswordSchema = z.object({
  email: z.string().email({ message: "L'email no Ã©s vÃ lid." }),
});

// Esquema per actualitzar la contrasenya
const ResetPasswordSchema = z.object({
  password: z.string().min(6, { message: "La contrasenya ha de tenir mÃ­nim 6 carÃ cters." }),
  confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
  message: "Les contrasenyes no coincideixen",
  path: ["confirmPassword"],
});

export type AuthState = {
  message?: string;
  success?: boolean;
  errors?: Record<string, string[]>;
};

/**
 * 1. L'usuari demana restablir la contrasenya via email
 */
export async function requestPasswordReset(prevState: AuthState, formData: FormData): Promise<AuthState> {
  const email = formData.get('email') as string;
  const locale = await getLocale();

  const validated = ForgotPasswordSchema.safeParse({ email });

  if (!validated.success) {
    return { errors: validated.error.flatten().fieldErrors };
  }

  const supabase = await createClient();
  
  // Aquest URL Ã©s on anirÃ  l'usuari desprÃ©s de fer clic al correu.
  // IMPORTANT: Redirigim al callback, que intercanviarÃ  el codi per sessiÃ³,
  // i desprÃ©s el callback redirigirÃ  a /auth/reset-password
  const redirectUrl = `${process.env.NEXT_PUBLIC_BASE_URL}/${locale}/auth/callback?next=/auth/reset-password`;

  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: redirectUrl,
  });

  if (error) {
    // Per seguretat, a vegades Ã©s millor no dir si l'email existeix o no, 
    // perÃ² per UX aquÃ­ mostrem l'error si Ã©s genÃ¨ric.
    return { message: error.message, success: false };
  }

  return { 
    success: true, 
    message: "Si l'email existeix, rebrÃ s un enllaÃ§ per restablir la contrasenya." 
  };
}

/**
 * 2. L'usuari (ja autenticat via link mÃ gic) posa la nova contrasenya
 */
export async function updatePassword(prevState: AuthState, formData: FormData): Promise<AuthState> {
  const password = formData.get('password') as string;
  const confirmPassword = formData.get('confirmPassword') as string;

  const validated = ResetPasswordSchema.safeParse({ password, confirmPassword });

  if (!validated.success) {
    return { errors: validated.error.flatten().fieldErrors };
  }

  const supabase = await createClient();

  const { error } = await supabase.auth.updateUser({
    password: validated.data.password
  });

  if (error) {
    return { message: "Error actualitzant la contrasenya.", success: false };
  }

  // Si tot va bÃ©, redirigim al dashboard
  const locale = await getLocale();
  redirect({ href: '/dashboard', locale });
  return { success: true }; // Codi mort per la redirecciÃ³, perÃ² necessari per TS
}

// =================== FILE: src/features/auth/ui/ForgotPasswordForm.tsx ===================

// =================== FILE: src/features/auth/ui/ForgotPasswordForm.tsx ===================

'use client'

import { useActionState } from 'react';
import { useTranslations } from 'next-intl';
import { requestPasswordReset } from '../actions/reset-password';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent } from '@/components/ui/card';
import { Loader2, CheckCircle2 } from 'lucide-react';

export function ForgotPasswordForm() {
  const t = useTranslations('Auth'); // Assegura't de tenir les traduccions
  
  const [state, action, isPending] = useActionState(requestPasswordReset, {
    message: '',
    errors: {}
  });

  if (state.success) {
    return (
      <Card className="border-green-200 bg-green-50">
        <CardContent className="pt-6 text-center space-y-4">
          <CheckCircle2 className="w-12 h-12 text-green-600 mx-auto" />
          <p className="text-green-800 font-medium">{state.message}</p>
          <p className="text-sm text-green-700">Revisa la teva safata d'entrada.</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardContent className="pt-6">
        <form action={action} className="space-y-4">
          <div className="space-y-2">
            <label htmlFor="email" className="text-sm font-medium">Email</label>
            <Input 
              id="email" 
              name="email" 
              type="email" 
              placeholder="tu@exemple.com"
              className={state.errors?.email ? "border-red-500" : ""}
            />
            {state.errors?.email && (
              <p className="text-sm text-red-500">{state.errors.email[0]}</p>
            )}
          </div>

          {state.message && !state.success && (
            <p className="text-sm text-red-500 text-center bg-red-50 p-2 rounded">{state.message}</p>
          )}

          <Button type="submit" className="w-full" disabled={isPending}>
            {isPending ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : "Enviar enllaÃ§ de recuperaciÃ³"}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/auth/ui/LoginForm.tsx ===================

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { createClient } from '@/lib/supabase/client';
import { Loader2, LogIn, Github } from 'lucide-react';
import { useRouter } from '@/routing'; 
import Link from 'next/link';
import { useTranslations } from 'next-intl';

export function LoginForm() {
  const t = useTranslations('Auth'); // Namespace Auth
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  // Nota: L'error de Supabase es mostra directament al component, no el traduÃ¯m.
  const [error, setError] = useState<string | null>(null); 
  const router = useRouter();
  const supabase = createClient();

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError(null);

    const { error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      setError(error.message);
      setIsLoading(false);
    } else {
      router.refresh();
      router.push('/dashboard');
    }
  };

  const handleOAuth = async (provider: 'github' | 'google') => {
    // Simplement mostrem el missatge traduÃ¯t
    setError(t('social_maintenance_error'));
    return;
  };

  return (
    <div className="w-full max-w-md mx-auto space-y-6">
      <div className="text-center space-y-2">
        <h1 className="text-3xl font-bold text-foreground">{t('login_title')}</h1>
        <p className="text-muted-foreground">{t('login_subtitle')}</p>
      </div>

      {/* Social Login */}
      <div className="grid grid-cols-1 gap-4">
        <Button 
          variant="outline" 
          onClick={() => handleOAuth('github')} 
          className="w-full h-12 border-border bg-card hover:bg-muted text-foreground gap-2"
        >
          <Github className="w-5 h-5" /> {t('social_github')}
        </Button>
      </div>

      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <span className="w-full border-t border-border" />
        </div>
        <div className="relative flex justify-center text-xs uppercase">
          <span className="bg-background px-2 text-muted-foreground">{t('or_email')}</span>
        </div>
      </div>

      <form onSubmit={handleLogin} className="space-y-4">
        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">{t('label_email')}</label>
          <Input
            type="email"
            placeholder="nom@empresa.com"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="bg-card border-border text-foreground h-12 focus:border-primary"
            required
          />
        </div>
        <div className="space-y-2">
          <div className="flex justify-between">
            <label className="text-sm font-medium text-foreground ml-1">{t('label_password')}</label>
            <Link href="/auth/forgot-password" className="text-sm text-primary hover:underline">
              {t('forgot_password')}
            </Link>
          </div>
          <Input
            type="password"
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="bg-card border-border text-foreground h-12 focus:border-primary"
            required
          />
        </div>

        {error && (
          <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-500 text-sm text-center">
            {error}
          </div>
        )}

        <Button type="submit" disabled={isLoading} className="w-full h-12 gradient-bg text-white font-bold rounded-lg hover:opacity-90 transition-all shadow-lg shadow-primary/20">
          {isLoading 
            ? <Loader2 className="animate-spin" /> 
            : <><LogIn className="w-4 h-4 mr-2" /> {t('cta_login')}</>
          }
        </Button>
      </form>

      <p className="text-center text-sm text-muted-foreground">
        {t('no_account_prefix')}{' '}
        <Link href="/auth/register" className="text-primary hover:underline font-medium">
          {t('register_link')}
        </Link>
      </p>
    </div>
  );
}

// =================== FILE: src/features/auth/ui/RegisterForm.tsx ===================

'use client';

import { useState } from 'react';
import { useTranslations } from 'next-intl';
import { useRouter, Link } from '@/routing';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Checkbox } from '@/components/ui/checkbox';
import { createClient } from '@/lib/supabase/client';
import { Loader2, UserPlus, Github, Info } from 'lucide-react';

export function RegisterForm({ prefilledEmail }: { prefilledEmail: string }) {
  const t = useTranslations('Auth');
  const router = useRouter();

  const [isLoading, setIsLoading] = useState(false);
  const [email, setEmail] = useState(prefilledEmail);
  const [password, setPassword] = useState('');
  const [fullName, setFullName] = useState('');

  // Estat del Checkbox
  const [termsAccepted, setTermsAccepted] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    // ValidaciÃ³ Checkbox
    if (!termsAccepted) {
      setError("Has d'acceptar la polÃ­tica de privacitat per crear el compte.");
      return;
    }

    setIsLoading(true);
    setError(null);

    const supabase = createClient();

    // 1. Registre a Supabase Auth
    const { error: authError } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          full_name: fullName,
        }
      }
    });

    if (authError) {
      setError(authError.message);
      setIsLoading(false);
      return;
    }

    // RedirecciÃ³ si tot va bÃ©
    router.refresh();
    router.push('/dashboard');
  };

  const handleOAuth = async (provider: 'github') => {
    // OpciÃ³ A: Si vols que sigui un error vermell
    setError("ğŸš§ El registre amb GitHub estÃ  en construcciÃ³. Si us plau, utilitza l'email.");

    // OpciÃ³ B (Millor): Si tens 'useToast', pots fer un toast informatiu
    // toast({ title: "En construcciÃ³", description: "Aviat podrÃ s entrar amb GitHub!" });

    // No fem res mÃ©s (no cridem a Supabase)
    return;
  };

  return (
    <div className="w-full max-w-md mx-auto space-y-6">
      <div className="text-center space-y-2">
        <h1 className="text-3xl font-bold text-foreground">{t('register_title', { defaultMessage: "Crea el teu compte" })}</h1>
        <p className="text-muted-foreground">{t('register_subtitle', { defaultMessage: "ComenÃ§a a automatitzar el teu negoci avui." })}</p>
      </div>

      {/* Social Register */}
      <div className="grid grid-cols-1 gap-4">
        <Button
          variant="outline"
          onClick={() => handleOAuth('github')}
          className="w-full h-12 border-border bg-card hover:bg-muted text-foreground gap-2"
        >
          <Github className="w-5 h-5" /> Registre amb GitHub
        </Button>
      </div>

      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <span className="w-full border-t border-border" />
        </div>
        <div className="relative flex justify-center text-xs uppercase">
          <span className="bg-background px-2 text-muted-foreground">O amb email</span>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">Nom Complet</label>
          <Input
            id="fullName"
            type="text"
            placeholder="Joan Garcia"
            value={fullName}
            onChange={(e) => setFullName(e.target.value)}
            className="bg-card border-border text-foreground h-12 focus:border-primary"
            required
          />
        </div>

        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">Email</label>
          <Input
            id="email"
            type="email"
            placeholder="nom@empresa.com"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="bg-card border-border text-foreground h-12 focus:border-primary"
            required
          />
        </div>

        <div className="space-y-2">
          <label className="text-sm font-medium text-foreground ml-1">Contrasenya</label>
          <Input
            id="password"
            type="password"
            placeholder="Crear contrasenya"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="bg-card border-border text-foreground h-12 focus:border-primary"
            required
            minLength={6}
          />
        </div>

        {/* Checkbox Legal */}
        <div className="flex items-start space-x-3 pt-2">
          <Checkbox
            id="privacy"
            checked={termsAccepted}
            onCheckedChange={(checked) => {
              setTermsAccepted(checked as boolean);
              if (checked) setError(null); // Netegem l'error visual si l'usuari marca la casella
            }}
            className="mt-1 border-muted-foreground/30 data-[state=checked]:bg-primary data-[state=checked]:border-primary"
          />
          <div className="grid gap-1.5 leading-none">
            <label
              htmlFor="privacy"
              className="text-sm text-muted-foreground leading-snug cursor-pointer select-none"
            >
              He llegit i accepto la <Link href="/legal/privacitat" target="_blank" className="underline hover:text-primary transition-colors">polÃ­tica de privacitat</Link> i les <Link href="/legal/avis-legal" target="_blank" className="underline hover:text-primary transition-colors">condicions d'Ãºs</Link>.
            </label>
          </div>
        </div>

        {error && (
          <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-500 text-sm flex items-center gap-2 animate-in fade-in slide-in-from-top-2">
            <Info className="w-4 h-4 shrink-0" />
            <span>{error}</span>
          </div>
        )}

        <Button
          type="submit"
          disabled={isLoading}
          className={`w-full h-12 font-bold rounded-lg transition-all shadow-lg shadow-primary/20 flex items-center justify-center gap-2 ${termsAccepted
              ? 'gradient-bg text-white hover:opacity-90'
              : 'bg-muted text-muted-foreground cursor-not-allowed opacity-70'
            }`}
        >
          {isLoading ? <Loader2 className="animate-spin" /> : <><UserPlus className="w-4 h-4" /> Crear Compte</>}
        </Button>
      </form>

      <p className="text-center text-sm text-muted-foreground">
        {t('already_have_account', { defaultMessage: "Ja tens compte?" })}{' '}
        <Link href="/auth/login" className="text-primary hover:underline font-medium">
          {t('login_link', { defaultMessage: "Inicia sessiÃ³" })}
        </Link>
      </p>
    </div>
  );
}

// =================== FILE: src/features/auth/ui/ResetPasswordForm.tsx ===================

// =================== FILE: src/features/auth/ui/ResetPasswordForm.tsx ===================

'use client'

import { useActionState } from 'react';
import { updatePassword } from '../actions/reset-password';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent } from '@/components/ui/card';
import { Loader2 } from 'lucide-react';

export function ResetPasswordForm() {
  const [state, action, isPending] = useActionState(updatePassword, {
    message: '',
    errors: {}
  });

  return (
    <Card>
      <CardContent className="pt-6">
        <form action={action} className="space-y-4">
          <div className="space-y-2">
            <label htmlFor="password" className="text-sm font-medium">Nova Contrasenya</label>
            <Input 
              id="password" 
              name="password" 
              type="password" 
              className={state.errors?.password ? "border-red-500" : ""}
            />
            {state.errors?.password && (
              <p className="text-sm text-red-500">{state.errors.password[0]}</p>
            )}
          </div>

          <div className="space-y-2">
            <label htmlFor="confirmPassword" className="text-sm font-medium">Confirmar Contrasenya</label>
            <Input 
              id="confirmPassword" 
              name="confirmPassword" 
              type="password" 
              className={state.errors?.confirmPassword ? "border-red-500" : ""}
            />
            {state.errors?.confirmPassword && (
              <p className="text-sm text-red-500">{state.errors.confirmPassword[0]}</p>
            )}
          </div>

          {state.message && (
            <p className="text-sm text-red-500 text-center">{state.message}</p>
          )}

          <Button type="submit" className="w-full" disabled={isPending}>
            {isPending ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : "Guardar nova contrasenya"}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/features/blog/actions/admin-actions.ts ===================

'use server';

import { postService } from '@/services/container';
import { requireAdmin } from '@/lib/auth/admin-guard';
import { revalidatePath } from 'next/cache';
import { redirect } from '@/routing';
import { getLocale } from 'next-intl/server';

// ğŸ‘‡ 1. Definim el tipus de retorn
export type ActionState = {
  success: boolean;
  message: string;
};

export async function togglePostStatusAction(slug: string, currentStatus: boolean): Promise<ActionState> {
  await requireAdmin(); // ğŸ›¡ï¸ Seguretat
  
  try {
    await postService.updatePost(slug, {
      published: !currentStatus
    });
    revalidatePath('/admin/blog');
    return { success: true, message: 'Estat actualitzat correctament.' };
  } catch (e) {
    return { success: false, message: 'Error actualitzant l\'estat.' };
  }
}

export async function deletePostAction(slug: string): Promise<ActionState> {
  await requireAdmin();
  
  try {
    await postService.deletePost(slug);
    revalidatePath('/admin/blog');
    return { success: true, message: 'Post eliminat.' };
  } catch (e) {
    console.error(e);
    return { success: false, message: 'Error eliminant el post.' };
  }
}

// ğŸ‘‡ 2. Tipem el prevState correctament en lloc de 'any'
export async function updatePostDetailsAction(prevState: ActionState, formData: FormData): Promise<ActionState> {
  await requireAdmin();
  const locale = await getLocale();

  const slug = formData.get('slug') as string;
  const title = formData.get('title') as string;
  const description = formData.get('description') as string;
  const date = formData.get('date') as string;
  
  try {
    await postService.updatePost(slug, {
      title,
      description,
      date: date ? new Date(date).toISOString() : undefined,
    });
    
    revalidatePath('/admin/blog');
    redirect({ href: '/admin/blog', locale });
    // El redirect llenÃ§a un error intern de Next.js, aixÃ­ que aquesta lÃ­nia tÃ¨cnicament no s'executa si redirigeix,
    // perÃ² TS la necessita pel tipatge.
    return { success: true, message: 'Post guardat.' };
  } catch (e) {
    // Si l'error Ã©s un redirect, l'hem de deixar passar
    if ((e as Error).message === 'NEXT_REDIRECT') {
        throw e;
    }
    console.error(e);
    return { success: false, message: 'Error guardant els canvis.' };
  }
}

// =================== FILE: src/features/blog/actions.ts ===================

'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';

export async function togglePostStatus(id: string, currentStatus: boolean) {
  const supabase = await createClient();
  
  // 1. Verificar sessiÃ³ (per seguretat)
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("No autoritzat");

  // 2. Actualitzar estat
  // Si estava true -> false. Si estava false -> true.
  // TambÃ© actualitzem 'status' (l'enum) per coherÃ¨ncia.
  const newStatus = !currentStatus;
  const newStatusEnum = newStatus ? 'published' : 'published';

  const { error } = await supabase
    .from('posts')
    .update({ 
        published: newStatus,
        status: newStatusEnum,
        published_at: newStatus ? new Date().toISOString() : null // Guardem data si publiquem
    })
    .eq('id', id);

  if (error) {
    console.error("Error toggling post:", error);
    return { success: false, message: error.message };
  }

  // 3. Refrescar la pÃ gina perquÃ¨ el botÃ³ canviÃ¯ de color sol
  revalidatePath('/admin/blog');
  revalidatePath(`/admin/blog/[slug]`, 'page'); // Refresca totes les subrutes dinÃ miques si cal
  
  return { success: true };
}

// =================== FILE: src/features/blog/types.ts ===================

export type BlogPost = {
  slug: string;
  title: string;
  date: string;
  description: string;
  content: string; // El cos en Markdown
  tags: string[];
};

// =================== FILE: src/features/blog/ui/AdminPostList.tsx ===================

'use client';

import { BlogPostDTO } from '@/types/models';
// âŒ Eliminat import { Badge }...
import { Button } from '@/components/ui/button';
import { Edit, Trash2, Eye, EyeOff, Calendar } from 'lucide-react';
import { togglePostStatusAction, deletePostAction } from '../actions/admin-actions';
import { useTransition } from 'react';
import { Link } from '@/routing';

export function AdminPostList({ posts }: { posts: BlogPostDTO[] }) {
  const [isPending, startTransition] = useTransition();

  const handleToggle = (slug: string, currentStatus: boolean) => {
    if (confirm(`Vols canviar l'estat a ${!currentStatus ? 'PUBLICAT' : 'ESBORRANY'}?`)) {
      // ğŸ‘‡ CORRECCIÃ“ CLAU: Afegim 'async' i claus '{}' per no retornar el valor
      // startTransition espera void, no un objecte {success, message}
      startTransition(async () => {
         const result = await togglePostStatusAction(slug, currentStatus);
         if (!result.success) alert(result.message); // Opcional: mostrar error
      });
    }
  };

  const handleDelete = (slug: string) => {
    if (confirm('EstÃ s segur? Aquesta acciÃ³ Ã©s irreversible.')) {
      // ğŸ‘‡ CORRECCIÃ“ CLAU
      startTransition(async () => {
         const result = await deletePostAction(slug);
         if (!result.success) alert(result.message);
      });
    }
  };

  return (
    <table className="w-full text-sm text-left">
      <thead className="bg-slate-50 dark:bg-slate-800 text-slate-500 font-medium border-b border-slate-200 dark:border-slate-700">
        <tr>
          <th className="px-6 py-4">TÃ­tol</th>
          <th className="px-6 py-4">Estat</th>
          <th className="px-6 py-4">Data PublicaciÃ³</th>
          <th className="px-6 py-4 text-right">Accions</th>
        </tr>
      </thead>
      <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
        {posts.map((post) => (
          <tr key={post.slug} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
            <td className="px-6 py-4">
              <div className="font-bold text-slate-900 dark:text-white line-clamp-1">{post.title}</div>
              <div className="text-xs text-slate-500 font-mono">{post.slug}</div>
            </td>
            <td className="px-6 py-4">
              <span 
                className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold capitalize
                  ${post.published 
                    ? 'bg-green-100 text-green-700 dark:bg-green-500/20 dark:text-green-400' 
                    : 'bg-yellow-100 text-yellow-700 dark:bg-yellow-500/20 dark:text-yellow-400'
                  }`}
              >
                {post.published ? 'Publicat' : 'Esborrany'}
              </span>
            </td>
            <td className="px-6 py-4 text-slate-500">
              <div className="flex items-center gap-2">
                <Calendar className="w-3 h-3" />
                {post.date ? new Date(post.date).toLocaleDateString() : '-'}
              </div>
            </td>
            <td className="px-6 py-4 text-right">
              <div className="flex items-center justify-end gap-2">
                
                {/* Toggle Status */}
                <Button 
                  size="icon" 
                  variant="ghost" 
                  onClick={() => handleToggle(post.slug, post.published)}
                  disabled={isPending}
                  title={post.published ? "Passar a esborrany" : "Publicar"}
                >
                  {post.published 
                    ? <Eye className="w-4 h-4 text-green-600" /> 
                    : <EyeOff className="w-4 h-4 text-slate-400" />
                  }
                </Button>

                {/* Edit Link */}
                <Link href={`/admin/blog/${post.slug}`}>
                    <Button size="icon" variant="ghost" title="Editar detalls">
                    <Edit className="w-4 h-4 text-blue-500" />
                    </Button>
                </Link>

                {/* Delete */}
                <Button 
                  size="icon" 
                  variant="ghost" 
                  onClick={() => handleDelete(post.slug)}
                  disabled={isPending}
                  className="hover:bg-red-50 hover:text-red-600"
                  title="Eliminar permanentment"
                >
                  <Trash2 className="w-4 h-4" />
                </Button>
              </div>
            </td>
          </tr>
        ))}
        {posts.length === 0 && (
            <tr>
                <td colSpan={4} className="text-center py-8 text-slate-500">No hi ha posts.</td>
            </tr>
        )}
      </tbody>
    </table>
  );
}

// =================== FILE: src/features/blog/ui/EditPostForm.tsx ===================

'use client';

import { useActionState, useState } from 'react';
import { BlogPostDTO } from '@/types/models';
import { updatePostDetailsAction, ActionState } from '@/features/blog/actions/admin-actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Save, Eye, PenTool } from 'lucide-react';
import { Link } from '@/routing';
// Importem components de pestanyes (si els tens a UI, sinÃ³ fem un switch simple)
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'; // Assumint que tens shadcn/ui
// Importem el renderitzador MDX (El mateix que usa la web pÃºblica)
import { MDXContent } from '@/features/blog/ui/MDXContent';

const initialState: ActionState = {
    success: false,
    message: '',
};

export function EditPostForm({ post }: { post: BlogPostDTO }) {
    const [state, formAction, isPending] = useActionState(updatePostDetailsAction, initialState);
    const [activeTab, setActiveTab] = useState<'edit' | 'preview'>('edit');
    // Estats locals per a la vista prÃ¨via en temps real
    const [content, setContent] = useState(post.content || '');
    const [title, setTitle] = useState(post.title);

    return (
        <form action={formAction} className="space-y-6">
            <input type="hidden" name="slug" value={post.slug} />

            <Tabs defaultValue="edit" className="w-full">
                <div className="flex justify-between items-center mb-4">
                    {/* Selector de Tabs manual */}
                    <div className="flex border-b border-border mb-6">
                        <button
                            type="button"
                            onClick={() => setActiveTab('edit')}
                            className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${activeTab === 'edit' ? 'border-primary text-primary' : 'border-transparent text-muted-foreground'}`}
                        >
                            âœï¸ EdiciÃ³
                        </button>
                        <button
                            type="button"
                            onClick={() => setActiveTab('preview')}
                            className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${activeTab === 'preview' ? 'border-primary text-primary' : 'border-transparent text-muted-foreground'}`}
                        >
                            ğŸ‘ï¸ Vista PrÃ¨via
                        </button>
                    </div>

                    {/* BotÃ³ per veure la versiÃ³ pÃºblica real (si estÃ  publicada) */}
                    {post.published && (
                        <Link href={`/blog/${post.slug}`} target="_blank">
                            <Button variant="ghost" size="sm" type="button">
                                Veure Web PÃºblica â†—
                            </Button>
                        </Link>
                    )}
                </div>

                {/* --- PESTANYA EDICIÃ“ --- */}
                <TabsContent value="edit" className="space-y-6">
                    <div className="grid md:grid-cols-2 gap-6">
                        <div className="space-y-2">
                            <label className="text-sm font-medium">TÃ­tol</label>
                            <Input
                                name="title"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                required
                                className="dark:bg-slate-800"
                            />
                        </div>
                        <div className="space-y-2">
                            <label className="text-sm font-medium">Data</label>
                            <Input
                                type="datetime-local"
                                name="date"
                                defaultValue={post.date ? new Date(post.date).toISOString().slice(0, 16) : ''}
                                className="dark:bg-slate-800"
                            />
                        </div>
                    </div>

                    <div className="space-y-2">
                        <label className="text-sm font-medium">DescripciÃ³ (SEO)</label>
                        <textarea
                            name="description"
                            defaultValue={post.description || ''}
                            rows={2}
                            className="w-full p-3 rounded-md border border-input bg-background text-sm dark:bg-slate-800"
                        />
                    </div>

                    <div className="space-y-2">
                        <label className="text-sm font-medium">Contingut (Markdown / MDX)</label>
                        <textarea
                            name="content"
                            value={content}
                            onChange={(e) => setContent(e.target.value)}
                            rows={15}
                            className="w-full p-4 rounded-md border border-input bg-background font-mono text-sm leading-relaxed dark:bg-slate-900"
                            placeholder="# Escriu aquÃ­ el teu article..."
                        />
                        <p className="text-xs text-muted-foreground">Pots utilitzar Markdown i components React.</p>
                    </div>
                </TabsContent>

                {/* --- PESTANYA VISTA PRÃˆVIA --- */}
                <TabsContent value="preview">
                    <div className="border rounded-xl p-8 bg-white dark:bg-slate-950 shadow-sm min-h-[500px]">
                        {/* Simulem la capÃ§alera del blog */}
                        <div className="mb-8 text-center">
                            <h1 className="text-4xl font-extrabold mb-4">{title}</h1>
                            <div className="text-sm text-muted-foreground">Vista prÃ¨via d'administrador</div>
                        </div>

                        {/* Renderitzem el contingut */}
                        <div className="prose prose-lg dark:prose-invert max-w-none">
                            {/* Nota: MDXRemote necessita executar-se al servidor normalment. 
                        Per a una preview client-side rÃ pida, pots usar 'react-markdown' 
                        o simplement mostrar el text si no vols complicar-ho. 
                        
                        Si MDXContent Ã©s un Server Component (que ho Ã©s al teu projecte), 
                        no el pots renderitzar aquÃ­ directament amb l'estat 'content' dinÃ mic 
                        sense fer un roundtrip al servidor.
                        
                        SOLUCIÃ“ RÃ€PIDA: Un iframe o un text simple. 
                        SOLUCIÃ“ PRO: Un Server Action que renderitzi la preview.
                    */}
                            <div className="p-4 bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-200 rounded mb-4 text-sm">
                                âš ï¸ Nota: La previsualitzaciÃ³ exacta de components MDX requereix guardar. AquÃ­ veus el text cru o podries usar una llibreria com `react-markdown`.
                            </div>
                            <pre className="whitespace-pre-wrap font-sans text-base">{content}</pre>
                        </div>
                    </div>
                </TabsContent>
            </Tabs>

            {/* Footer Accions */}
            <div className="pt-6 border-t flex justify-between items-center bg-background sticky bottom-0 z-10 p-4">
                {!state.success && state.message && (
                    <div className="text-red-500 text-sm font-medium">{state.message}</div>
                )}
                <div className="flex gap-3 ml-auto">
                    <Link href="/admin/blog">
                        <Button variant="outline" type="button">CancelÂ·lar</Button>
                    </Link>
                    <Button type="submit" className="gap-2" disabled={isPending}>
                        <Save className="w-4 h-4" />
                        {isPending ? 'Guardant...' : 'Guardar Canvis'}
                    </Button>
                </div>
            </div>
        </form>
    );
}

// =================== FILE: src/features/blog/ui/MDXContent.tsx ===================

import { MDXRemote } from 'next-mdx-remote/rsc';
import { Button } from '@/components/ui/button';
import React, { ComponentPropsWithoutRef } from 'react';
import { CheckCircle2 } from 'lucide-react';
import remarkGfm from 'remark-gfm'; // ğŸ‘ˆ 1. IMPORTA EL PLUGIN
// Tipus per als components HTML estÃ ndard
type HeadingProps = ComponentPropsWithoutRef<'h1'>;
type ParagraphProps = ComponentPropsWithoutRef<'p'>;
type ListProps = ComponentPropsWithoutRef<'ul'>;
type CalloutProps = { children: React.ReactNode };
// Tipus per a taules
type TableProps = ComponentPropsWithoutRef<'table'>;
type ThProps = ComponentPropsWithoutRef<'th'>;
type TdProps = ComponentPropsWithoutRef<'td'>;

// Component de VÃ­deo (YouTube)
const Video = ({ id }: { id: string }) => (
  <div className="my-12 rounded-xl overflow-hidden shadow-2xl ring-1 ring-slate-900/10 aspect-video bg-slate-900 mx-auto w-full">
    <iframe
      className="w-full h-full"
      src={`https://www.youtube.com/embed/${id}`}
      title="YouTube video player"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowFullScreen
    />
  </div>
);

const components = {
  // ENCAPÃ‡ALAMENTS: Usem 'text-foreground' per adaptar-se perfectament (Negre/Blanc)
  h1: (props: HeadingProps) => (
    <h1 {...props} className="text-3xl md:text-5xl font-extrabold mt-12 mb-6 text-foreground tracking-tight leading-tight" />
  ),
  h2: (props: HeadingProps) => (
    <h2 {...props} className="text-2xl md:text-3xl font-bold mt-12 mb-6 text-foreground border-b border-border/50 pb-2" />
  ),
  h3: (props: HeadingProps) => (
    <h3 {...props} className="text-xl md:text-2xl font-bold mt-8 mb-4 text-foreground" />
  ),

  // PARÃ€GRAFS: CORRECCIÃ“ DE CONTRAST
  // Light: text-slate-900 (Negre intens per llegibilitat)
  // Dark: text-slate-200 (Blanc suau per no cremar els ulls)
  p: (props: ParagraphProps) => (
    <p {...props} className="text-xl leading-8 text-slate-900 dark:text-slate-400 mb-8 font-sans" />
  ),

  // ELEMENTS INLINE
  strong: (props: ComponentPropsWithoutRef<'strong'>) => <strong {...props} className="font-bold text-foreground" />,
  a: (props: ComponentPropsWithoutRef<'a'>) => <a {...props} className="text-primary underline underline-offset-4 hover:text-primary/80 font-medium transition-colors" />,

  // LLISTES
  ul: (props: ListProps) => (
    <ul {...props} className="list-disc list-outside ml-6 space-y-3 mb-8 text-xl text-slate-900 dark:text-slate-500" />
  ),
  li: (props: ComponentPropsWithoutRef<'li'>) => <li {...props} className="pl-2" />,

  // CITES (Blockquote)
  blockquote: (props: ComponentPropsWithoutRef<'blockquote'>) => (
    <blockquote {...props} className="border-l-4 border-primary pl-6 py-4 my-10 italic text-2xl text-slate-800 dark:text-slate-100 bg-muted/30 rounded-r-lg" />


  ),
  // âœ¨ ESTILS DE TAULA (NOU)
  table: (props: TableProps) => (
    <div className="my-12 w-full overflow-x-auto rounded-xl border border-border shadow-sm">
      <table {...props} className="w-full text-left text-sm" />
    </div>
  ),
  thead: (props: ComponentPropsWithoutRef<'thead'>) => (
    <thead {...props} className="bg-muted/50 text-foreground border-b border-border" />
  ),
  tbody: (props: ComponentPropsWithoutRef<'tbody'>) => (
    <tbody {...props} className="divide-y divide-border bg-card" />
  ),
  tr: (props: ComponentPropsWithoutRef<'tr'>) => (
    <tr {...props} className="transition-colors hover:bg-muted/20" />
  ),
  th: (props: ThProps) => (
    <th {...props} className="px-6 py-4 font-bold text-foreground uppercase tracking-wider text-xs align-middle" />
  ),
  td: (props: TdProps) => (
    <td {...props} className="px-6 py-4 text-slate-600 dark:text-slate-300 align-middle leading-relaxed" />
  ),

  // COMPONENTS PERSONALITZATS (Botons i Callouts)
  Button: (props: React.ComponentProps<typeof Button>) => (
    <div className="my-12 flex justify-center">
      <Button size="lg" className="px-8 py-6 text-lg shadow-lg hover:scale-105 transition-transform" {...props} />
    </div>
  ),

  Callout: ({ children }: CalloutProps) => (
    <div className="flex gap-4 bg-primary/5 border border-primary/20 text-foreground p-6 my-10 rounded-xl shadow-sm">
      <div className="shrink-0 mt-1">
        <CheckCircle2 className="h-6 w-6 text-primary" />
      </div>
      <div className="text-lg leading-relaxed text-slate-900 dark:text-slate-100">
        {children}
      </div>
    </div>
  ),

  Video,
};

export function MDXContent({ source }: { source: string }) {
  if (!source) return null;

  return (
    <article className="max-w-none w-full">
      <MDXRemote 
        source={source} 
        components={components} 
        // ğŸ‘‡ 2. AFEGEIX AQUESTA CONFIGURACIÃ“
        options={{
          mdxOptions: {
            remarkPlugins: [remarkGfm],
          },
        }}
      />
    </article>
  );
}

// =================== FILE: src/features/blog/ui/PostStatusToggle.tsx ===================

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Loader2, Globe, EyeOff } from 'lucide-react';
import { togglePostStatus } from '../actions';
import { useRouter } from 'next/navigation';

type Props = {
  postId: string;
  isPublished: boolean;
};

export function PostStatusToggle({ postId, isPublished }: Props) {
  const [isLoading, setIsLoading] = useState(false);
  const router = useRouter();

  const handleToggle = async () => {
    setIsLoading(true);
    try {
      await togglePostStatus(postId, isPublished);
      // Opcional: forÃ§ar refresh del router client
      router.refresh();
    } catch (error) {
      console.error(error);
      alert("Error canviant l'estat");
    } finally {
      setIsLoading(false);
    }
  };

  if (isPublished) {
    return (
      <Button 
        variant="outline" 
        size="sm" 
        onClick={handleToggle} 
        disabled={isLoading}
        className="border-yellow-600/50 text-yellow-500 hover:bg-yellow-900/20 hover:text-yellow-400"
      >
        {isLoading ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <EyeOff className="w-4 h-4 mr-2" />}
        Passar a Esborrany
      </Button>
    );
  }

  return (
    <Button 
      size="sm" 
      onClick={handleToggle} 
      disabled={isLoading}
      className="bg-green-600 hover:bg-green-700 text-white border-0"
    >
      {isLoading ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Globe className="w-4 h-4 mr-2" />}
      Publicar Ara
    </Button>
  );
}

// =================== FILE: src/features/email/templates/AuditReadyEmail.tsx ===================

import * as React from 'react';
import {
  Body,
  Container,
  Head,
  Heading,
  Html,
  Preview,
  Section,
  Text,
  Button,
  Hr,
  Row,
  Column,
} from '@react-email/components';

interface AuditReadyEmailProps {
  url: string;
  seoScore: number;
  perfScore: number;
  auditId: string;
}

// Estils base (Els correus necessiten estils en lÃ­nia antics)
const main = {
  backgroundColor: '#f6f9fc',
  fontFamily: '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Ubuntu,sans-serif',
};

const container = {
  backgroundColor: '#ffffff',
  margin: '0 auto',
  padding: '20px 0 48px',
  marginBottom: '64px',
  borderRadius: '8px',
  boxShadow: '0 4px 12px rgba(0,0,0,0.05)',
};

const box = {
  padding: '0 48px',
};

const hr = {
  borderColor: '#e6ebf1',
  margin: '20px 0',
};

const scoreBox = {
  textAlign: 'center' as const,
  padding: '20px',
  borderRadius: '8px',
  backgroundColor: '#f0fdf4', // Verd molt suau
  border: '1px solid #bbf7d0',
};

const scoreNumber = {
  fontSize: '32px',
  fontWeight: 'bold',
  color: '#15803d', // Verd fort
  margin: '0',
};

const scoreLabel = {
  color: '#64748b',
  fontSize: '12px',
  textTransform: 'uppercase' as const,
  letterSpacing: '1px',
  marginTop: '8px',
};

const button = {
  backgroundColor: '#7c3aed', // El teu lila de marca (primary)
  borderRadius: '5px',
  color: '#fff',
  fontSize: '16px',
  fontWeight: 'bold',
  textDecoration: 'none',
  textAlign: 'center' as const,
  display: 'block',
  width: '100%',
  padding: '12px',
  marginTop: '20px',
};

export const AuditReadyEmail = ({
  url,
  seoScore,
  perfScore,
  auditId,
}: AuditReadyEmailProps) => (
  <Html>
    <Head />
    <Preview>L'informe de {url} ja estÃ  llest - DigitAI Studios</Preview>
    <Body style={main}>
      <Container style={container}>
        <Section style={box}>
          <Heading as="h2" style={{ color: '#1e293b', textAlign: 'center' }}>
            DigitAI Studios
          </Heading>
          <Hr style={hr} />
          
          <Text style={{ fontSize: '16px', lineHeight: '24px', color: '#334155' }}>
            Hola! ğŸ‘‹
          </Text>
          <Text style={{ fontSize: '16px', lineHeight: '24px', color: '#334155' }}>
            La nostra IntelÂ·ligÃ¨ncia Artificial ha acabat d'analitzar la teva web <strong>{url}</strong>. AquÃ­ tens un resum rÃ pid dels resultats:
          </Text>

          {/* GRID DE PUNTUACIONS */}
          <Section style={{ marginTop: '24px', marginBottom: '24px' }}>
            <Row>
              <Column>
                <div style={scoreBox}>
                    <p style={scoreNumber}>{seoScore}/100</p>
                    <p style={scoreLabel}>SEO</p>
                </div>
              </Column>
              <Column style={{ width: '20px' }} />
              <Column>
                <div style={{ ...scoreBox, backgroundColor: '#eff6ff', borderColor: '#bfdbfe' }}>
                    <p style={{ ...scoreNumber, color: '#1d4ed8' }}>{perfScore}/100</p>
                    <p style={scoreLabel}>Rendiment</p>
                </div>
              </Column>
            </Row>
          </Section>

          <Text style={{ fontSize: '16px', lineHeight: '24px', color: '#334155' }}>
            Hem detectat algunes Ã rees de millora crÃ­tiques que podrien estar afectant les teves vendes.
          </Text>

          <Button 
            style={button} 
            href={`https://la-teva-web.com/dashboard/audits/${auditId}`}
          >
            Veure Informe Complet
          </Button>
          
          <Hr style={hr} />
          <Text style={{ fontSize: '12px', color: '#94a3b8', textAlign: 'center' }}>
            Â© 2024 DigitAI Studios. AutomatitzaciÃ³ i IA per a empreses.
          </Text>
        </Section>
      </Container>
    </Body>
  </Html>
);

export default AuditReadyEmail;

// =================== FILE: src/features/projects/actions.ts ===================

'use server';

import { FactoryService } from '@/services/FactoryService';
import { AIService } from '@/services/AIService';
import { MasterConfig } from '@/types/config';
import { createClient, createAdminClient } from '@/lib/supabase/server';
import { ActionResult } from '@/types/actions';
import { Json } from '@/types/database.types';

const factory = new FactoryService();
const ai = new AIService();

const wait = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

// FunciÃ³ robusta per esperar que el repo existeixi
async function waitForRepoReady(slug: string, attempts = 20): Promise<boolean> {
    for (let i = 0; i < attempts; i++) {
        try {
            // Intentem llegir el package.json per veure si ja s'ha copiat el template
            await factory.getFileSha(slug, 'package.json');
            return true;
        } catch (e) {
            console.log(`â³ [Factory] Esperant inicialitzaciÃ³... (${i + 1}/${attempts})`);
            await wait(3000); // 3 segons entre intents
        }
    }
    return false;
}

export async function createProjectAction(prevState: unknown, formData: FormData): Promise<ActionResult> {
    try {
        const businessName = formData.get('businessName') as string;
        const slug = formData.get('slug') as string;
        const description = formData.get('description') as string;
        const primaryColor = formData.get('primaryColor') as string;
        const logoFile = formData.get('logo') as File;

        if (!businessName || !slug) {
            return {
                error: "Falten dades.",
                fields: { 
                    businessName, 
                    slug, 
                    description, 
                    primaryColor 
                }
            };
        }

        // 1. IA
        console.log(`ğŸ¤– [IA] Generant textos per: ${businessName}`);
        const aiContent = await ai.generateSiteContent(businessName, description);

        // 2. GITHUB: Crear Repo
        const repoData = await factory.createRepository(slug, `Web de ${businessName}`);

        // ESPERA ACTIVA: No seguim fins que el repo estigui llest
        console.log("â³ [Factory] Verificant estat del repositori...");
        const isReady = await waitForRepoReady(slug);
        
        if (!isReady) {
            throw new Error("Timeout: GitHub ha trigat massa a crear els fitxers.");
        }

        // 3. GITHUB: Pujar Logo
        await factory.uploadLogo(slug, logoFile);

        // 4. PREPARAR CONFIG
        const config: MasterConfig = {
            identity: {
                name: businessName,
                description: aiContent.hero.subtitle || description,
                logoUrl: "/branding/logo.png",
                faviconUrl: "/favicon.ico",
                contactEmail: "info@client.com"
            },
            branding: {
                colors: {
                    primary: primaryColor,
                    secondary: "#10b981",
                    background: "#ffffff",
                    foreground: "#0f172a"
                },
                radius: 0.5
            },
            modules: {
                landing: { active: true, sections: ['hero', 'services', 'contact'] },
                auth: true,
                dashboard: true,
                booking: formData.get('module_booking') === 'on',
                blog: formData.get('module_blog') === 'on',
                inventory: formData.get('module_inventory') === 'on',
                ecommerce: false,
                accessControl: false
            },
            i18n: { locales: ['ca', 'es'], defaultLocale: 'ca' }
        };

        // 5. GITHUB: Injectar Config
        await factory.injectConfiguration(slug, config);

        // 6. DB LOCAL: Guardar (Admin Client)
        const supabaseAdmin = createAdminClient();
        const supabaseUser = await createClient();
        const { data: { user } } = await supabaseUser.auth.getUser();

        // 6.1 Crear OrganitzaciÃ³
        const { data: newOrg, error: orgError } = await supabaseAdmin
            .from('organizations')
            .insert({
                name: businessName,
                slug: slug,
                domain: `${slug}.vercel.app`,
                plan: 'basic',
                branding_config: config.branding as unknown as Json
            })
            .select()
            .single();

        if (orgError) throw new Error(`Error DB Org: ${orgError.message}`);

        // 6.2 Crear Projecte
        const { error: projectError } = await supabaseAdmin
            .from('projects')
            .insert({
                name: businessName,
                domain: slug,
                repository_url: repoData.html_url,
                status: 'pending',
                client_id: user?.id || newOrg.id,
                organization_id: newOrg.id
            });

        if (projectError) console.error("âŒ Error DB Projecte:", projectError);

        return { success: true, repoUrl: repoData.html_url };

    } catch (error: unknown) {
        // GestiÃ³ d'errors segura (Type-Safe)
        let errorMessage = "Error desconegut al procÃ©s de fÃ brica.";
        if (error instanceof Error) {
            errorMessage = error.message;
        } else if (typeof error === 'object' && error !== null && 'message' in error) {
            errorMessage = String((error as Record<string, unknown>).message);
        }

        console.error("âŒ FACTORY ERROR:", errorMessage);
        
        return { 
            error: errorMessage,
            fields: {
                businessName: formData.get('businessName') as string,
                slug: formData.get('slug') as string,
                description: formData.get('description') as string,
                primaryColor: formData.get('primaryColor') as string
            }
        };
    }
}


// 1. Definim el tipus aquÃ­ (o a /types) per assegurar coherÃ¨ncia
export type InviteState = {
    success: boolean;
    error: string | null;
    message: string | null;
};




export async function inviteClientAction(
    prevState: InviteState,
    formData: FormData
): Promise<InviteState> {

    const supabaseAdmin = createAdminClient();
    const email = formData.get('email') as string;
    const projectId = formData.get('projectId') as string;
    const orgId = formData.get('orgId') as string;

    console.log("ğŸ” [INVITE] Iniciant per:", email);

    if (!email || !orgId) {
        return { success: false, error: "Falten dades obligatÃ²ries.", message: null };
    }

    try {
        let userIdToLink = '';

        // 1. Busquem a la taula PROFILES
        // Usem maybeSingle() per evitar errors si no en troba cap
        const { data: existingProfile } = await supabaseAdmin
            .from('profiles')
            .select('id')
            .eq('email', email)
            .maybeSingle();

        if (existingProfile) {
            console.log("âœ… [INVITE] Usuari trobat a Profiles. ID:", existingProfile.id);
            userIdToLink = existingProfile.id;

            // Assegurem que tingui accÃ©s a aquesta organitzaciÃ³
            // Usem UPSERT aquÃ­ tambÃ© per si de cas
            await supabaseAdmin
                .from('profiles')
                .upsert({ 
                    id: userIdToLink,
                    email: email,
                    organization_id: orgId, 
                    role: 'client' 
                });

        } else {
            console.log("âš ï¸ [INVITE] No trobat a profiles. Provant invitaciÃ³ Auth...");
            
            const { data: inviteData, error: inviteError } = await supabaseAdmin.auth.admin.inviteUserByEmail(email, {
                data: { org_id: orgId, role: 'client', full_name: 'Client' },
                redirectTo: `${process.env.NEXT_PUBLIC_BASE_URL}/auth/update-password`
            });

            if (inviteError) {
                // CAS: L'email existeix a Auth (perÃ² ha fallat el pas 1 per algun motiu)
                if (inviteError.code === 'email_exists' || inviteError.message.includes('already been registered')) {
                    console.log("ğŸ§Ÿ [INVITE] Usuari existent a Auth. Recuperant ID...");
                    
                    const { data: authUsers } = await supabaseAdmin.auth.admin.listUsers();
                    const zombieUser = authUsers.users.find(u => u.email === email);

                    if (zombieUser) {
                        userIdToLink = zombieUser.id;
                        console.log("âœ… [INVITE] ID recuperat:", userIdToLink);

                        // ğŸ”¥ CORRECCIÃ“ CLAU: Usem UPSERT en lloc d'INSERT
                        // AixÃ² arregla tant si falta el perfil com si ja existeix
                        const { error: upsertError } = await supabaseAdmin
                            .from('profiles')
                            .upsert({
                                id: userIdToLink,
                                email: email,
                                organization_id: orgId,
                                role: 'client',
                                full_name: zombieUser.user_metadata?.full_name || 'Client Recuperat'
                            }, { onConflict: 'id, organization_id' }); // Especifiquem la clau de conflicte

                        if (upsertError) {
                            console.error("âŒ [INVITE] Error al Upsert:", upsertError);
                            return { success: false, error: "Error de base de dades: " + upsertError.message, message: null };
                        }
                        console.log("âœ… [INVITE] Perfil sincronitzat correctament.");

                    } else {
                        return { success: false, error: "Error crÃ­tic: L'email consta com a registrat perÃ² no es troba.", message: null };
                    }
                } else {
                    return { success: false, error: "Error invitaciÃ³: " + inviteError.message, message: null };
                }
            } else {
                console.log("âœ¨ [INVITE] Nova invitaciÃ³ enviada.");
                userIdToLink = inviteData.user.id;
            }
        }

        // 2. VINCULACIÃ“ FINAL DEL PROJECTE
        console.log(`ğŸ”— [INVITE] Vinculant projecte a ${userIdToLink}...`);
        
        const { error: updateError } = await supabaseAdmin
            .from('projects')
            .update({ 
                status: 'active',
                client_id: userIdToLink 
            })
            .eq('id', projectId);

        if (updateError) {
            console.error("âŒ [INVITE] Error update project:", updateError);
            return { success: false, error: "Error vinculant el projecte.", message: null };
        }

        return { 
            success: true, 
            message: "Client vinculat i activat correctament!", 
            error: null 
        };

    } catch (error: unknown) {
        console.error("ğŸ’¥ [INVITE] ExcepciÃ³:", error);
        return { success: false, error: "Error inesperat al servidor", message: null };
    }
}

// =================== FILE: src/features/projects/data/projects-data.ts ===================

import { StaticImageData } from 'next/image';
// Importa les teves imatges reals aquÃ­
import ribotFlowImg from '@/assets/images/pantalla-ribotflow.jpg'; 
import salutFlowImg from '@/assets/images/pantalla-salutflow.jpg';

export interface Project {
  id: string;
  title: string;
  tagline: string;
  description: string;
  stats: string[];
  tags: string[];
  color: string;
  image: StaticImageData | null;
  link: string;
  imageAlt: string; // ğŸ‘ˆ NOU CAMP AFEGIT
}

export const PROJECTS: Project[] = [
  {
    id: 'ribotflow',
    title: 'RibotFlow',
    tagline: 'El Sistema Operatiu Integral',
    description: '...',
    stats: ['CRM + FacturaciÃ³', 'AutomatitzaciÃ³ IA', 'Control Financer'],
    tags: ['ERP', 'Business', 'IA', 'Supabase'],
    color: 'from-purple-500 to-pink-500',
    image: ribotFlowImg,
    // ğŸ‘‡ DESCRIU LA IMATGE REALMENT
    imageAlt: "Panell de control fosc de RibotFlow mostrant grÃ fiques de rendiment i llistat de clients", 
    link: 'https://ribotflow.com'
  },
  {
    id: 'salutflow',
    title: 'SalutFlow',
    tagline: 'El teu Centre Esportiu, Digitalitzat',
    description: '...',
    stats: ['App PWA', 'Pagaments Stripe', 'Llistes d\'Espera'],
    tags: ['SaaS', 'Sport', 'PWA', 'Stripe'],
    color: 'from-cyan-400 to-blue-600',
    image: salutFlowImg,
    // ğŸ‘‡ DESCRIU LA IMATGE REALMENT
    imageAlt: "Captura de l'aplicaciÃ³ mÃ²bil SalutFlow amb el calendari de reserves de classes",
    link: 'https://getsalutflow.com'
  }
];

// =================== FILE: src/features/projects/index.ts ===================

// Exportem nomÃ©s el que volem que la resta de l'app pugui utilitzar
export * from './ui/ProjectsHero';
export * from './ui/ProjectList';
export * from './ui/ProjectsCTA';
export * from './data/projects-data'; // Opcional, si necessites els tipus a fora

// =================== FILE: src/features/projects/ui/InviteClientForm.tsx ===================

'use client';

import { useActionState } from 'react';
// Importem l'acciÃ³ i EL TIPUS que acabem de crear
import { inviteClientAction, InviteState } from '@/features/projects/actions';
import { Mail, Send, Loader2 } from 'lucide-react';

// âœ… L'estat inicial ha de coincidir EXACTAMENT amb InviteState
const initialState: InviteState = { 
  success: false, 
  error: null, 
  message: null 
};

export function InviteClientForm({ projectId, orgId }: { projectId: string, orgId: string }) {
  const [state, action, isPending] = useActionState(inviteClientAction, initialState);

  if (state.success) {
      return (
          <div className="p-4 bg-green-50 border border-green-200 rounded-lg text-green-800 text-center animate-in zoom-in">
              âœ… <strong>{state.message}</strong><br/>
              El client rebrÃ  un correu per activar el seu compte.
          </div>
      );
  }

  return (
    <form action={action} className="flex flex-col gap-3">
        <input type="hidden" name="projectId" value={projectId} />
        <input type="hidden" name="orgId" value={orgId} />
        
        <div className="flex gap-2">
            <div className="relative flex-1">
                <Mail className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                <input 
                    name="email" 
                    type="email" 
                    required 
                    placeholder="email@client.com" 
                    className="w-full pl-9 p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                />
            </div>
            <button 
                type="submit" 
                disabled={isPending}
                className="bg-black text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-800 disabled:opacity-50 flex items-center gap-2"
            >
                {isPending ? <Loader2 className="animate-spin w-4 h-4" /> : <><Send className="w-4 h-4" /> Convidar</>}
            </button>
        </div>
        
        {state.error && (
            <p className="text-xs text-red-500 font-medium ml-1">âŒ {state.error}</p>
        )}
    </form>
  );
}

// =================== FILE: src/features/projects/ui/NewProjectForm.tsx ===================

'use client';

import { useActionState, useRef } from 'react';
import { createProjectAction } from '@/features/projects/actions';
import { Loader2, Wand2, Github, LayoutTemplate } from 'lucide-react';
import { ActionResult } from '@/types/actions';

const initialState: ActionResult = {
  success: false,
  error: '',
  fields: {} 
};

export function NewProjectForm() {
  const [state, formAction, isPending] = useActionState(createProjectAction, initialState);
  
  // âœ… SOLUCIÃ“: Usem refs en lloc de state per evitar re-renders innecessaris i conflictes
  const slugInputRef = useRef<HTMLInputElement>(null);

  const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const name = e.target.value;
    
    // LÃ²gica automÃ tica: Si l'usuari escriu el nom, actualitzem l'slug
    // nomÃ©s si l'slug estÃ  buit o comenÃ§a per 'client-' (per no matxacar canvis manuals)
    if (slugInputRef.current) {
        const currentSlug = slugInputRef.current.value;
        if (!currentSlug || currentSlug.startsWith('client-')) {
            const generated = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            slugInputRef.current.value = generated ? `client-${generated}` : '';
        }
    }
  };

  return (
    <div className="max-w-3xl mx-auto">
      <div className="bg-white dark:bg-slate-900 p-8 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800">
        
        {/* Header */}
        <div className="flex items-center gap-3 mb-8 border-b border-slate-100 dark:border-slate-800 pb-6">
          <div className="p-3 bg-blue-600 rounded-lg text-white shadow-lg shadow-blue-500/30">
            <LayoutTemplate className="w-6 h-6" />
          </div>
          <div>
            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Generador de PWA</h2>
            <p className="text-slate-500 text-sm">Crea una nova web a partir del Master Template</p>
          </div>
        </div>
      
      <form action={formAction} className="space-y-8">
        
        {/* SECCIÃ“ 1: IDENTITAT */}
        <section className="space-y-4">
            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">1. Identitat del Negoci</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label className="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Nom del Negoci</label>
                    <input 
                        name="businessName" 
                        required 
                        // PersistÃ¨ncia via defaultValue
                        defaultValue={state.fields?.businessName} 
                        onChange={handleNameChange}
                        // ğŸ¨ Estils per evitar text transparent
                        className="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all text-slate-900 dark:text-white placeholder:text-gray-400" 
                        placeholder="Ex: Restaurant Can Roca" 
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Identificador (Repo Slug)</label>
                    <div className="relative">
                        <Github className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                        <input 
                            name="slug" 
                            required 
                            ref={slugInputRef}
                            // âœ… TRUC MESTRE: 'key' forÃ§a el component a refrescar-se si el servidor torna un valor nou
                            key={state.fields?.slug || 'slug-input'} 
                            defaultValue={state.fields?.slug}
                            className="w-full pl-10 p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none text-slate-900 dark:text-white placeholder:text-gray-400" 
                            placeholder="client-nom-negoci" 
                        />
                    </div>
                </div>
            </div>

            <div>
                <label className="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Logotip (Imatge)</label>
                <input 
                    type="file" 
                    name="logo" 
                    // NomÃ©s obligatori si no hi ha errors previs (per no haver de tornar a pujar)
                    required={!state.fields}
                    accept="image/png, image/jpeg, image/webp"
                    className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-all cursor-pointer" 
                />
            </div>
        </section>

        <hr className="border-slate-100 dark:border-slate-800" />

        {/* SECCIÃ“ 2: IA */}
        <section className="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-6 rounded-xl border border-blue-100 dark:border-blue-800">
            <div className="flex items-center gap-2 mb-3">
                <Wand2 className="w-5 h-5 text-blue-600 dark:text-blue-400" />
                <span className="font-bold text-blue-800 dark:text-blue-200">GeneraciÃ³ de Contingut (IA)</span>
            </div>
            <label className="block text-sm text-blue-700 dark:text-blue-300 mb-2">
                Descriu el negoci. Gemini escriurÃ  el Hero, el "Sobre Nosaltres" i els Serveis automÃ ticament.
            </label>
            <textarea 
                name="description" 
                rows={4} 
                defaultValue={state.fields?.description}
                className="w-full p-3 border border-blue-200 dark:border-blue-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-400" 
                placeholder="Ex: Som un gimnÃ s de barri especialitzat en CrossFit i Yoga..." 
                required
            />
        </section>

        <hr className="border-slate-100 dark:border-slate-800" />

        {/* SECCIÃ“ 3: CONFIGURACIÃ“ */}
        <section className="space-y-4">
            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">3. ConfiguraciÃ³</h3>
            
            <div>
                <label className="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">Color Corporatiu</label>
                <div className="flex items-center gap-3">
                    <input 
                        type="color" 
                        name="primaryColor" 
                        defaultValue={state.fields?.primaryColor || "#7c3aed"} 
                        className="h-12 w-20 rounded cursor-pointer border border-gray-200 p-1 bg-white" 
                    />
                </div>
            </div>

            <div>
                <label className="block text-sm font-medium mb-3 text-slate-700 dark:text-slate-300">MÃ²duls</label>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    {['booking', 'blog', 'inventory'].map((mod) => (
                        <label key={mod} className="flex items-center gap-3 p-4 border border-slate-200 dark:border-slate-700 rounded-xl cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all group">
                            <input type="checkbox" name={`module_${mod}`} className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500" />
                            <span className="font-medium text-slate-700 dark:text-slate-300 capitalize">{mod}</span>
                        </label>
                    ))}
                </div>
            </div>
        </section>

        <button 
            type="submit" 
            disabled={isPending}
            className="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-4 rounded-xl font-bold text-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center gap-3 shadow-xl transition-all"
        >
            {isPending ? (
                <>
                    <Loader2 className="animate-spin w-6 h-6" /> Creant Projecte...
                </>
            ) : (
                'ğŸš€ INICIAR CONSTRUCCIÃ“'
            )}
        </button>

        {/* FEEDBACK */}
        {state?.error && (
            <div className="p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800 rounded-lg text-center animate-in fade-in slide-in-from-top-2">
                âŒ <strong>Error:</strong> {state.error}
            </div>
        )}
        
        {state?.success && state.repoUrl && (
            <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-300 p-6 rounded-xl text-center animate-in zoom-in duration-300">
                <h3 className="text-xl font-bold mb-2">ğŸ‰ Projecte Generat!</h3>
                <p className="mb-6">El repositori s'ha creat correctament.</p>
                <a 
                    href={state.repoUrl} 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-full font-bold hover:bg-green-700 transition-colors shadow-lg"
                >
                    <Github className="w-5 h-5" /> Veure Codi a GitHub
                </a>
            </div>
        )}
      </form>
      </div>
    </div>
  );
}

// =================== FILE: src/features/projects/ui/ProjectCard.tsx ===================

'use client';

import Image from 'next/image';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { ExternalLink, Layers } from 'lucide-react';
import type { Project } from '../data/projects-data';
import { useTranslations } from 'next-intl';

interface Props {
    project: Project;
    index: number;
}

export function ProjectCard({ project, index }: Props) {
    const isReversed = index % 2 !== 0;
    const t = useTranslations('ProjectCard'); // Namespace base

    return (
        <div className={`flex flex-col lg:flex-row gap-8 md:gap-16 items-center ${isReversed ? 'lg:flex-row-reverse' : ''}`}>

            {/* --- COLUMNA VISUAL (Mockup) --- */}
            <motion.div
                initial={{ opacity: 0, y: 30 }}
                whileInView={{ opacity: 1, y: 0 }}
                viewport={{ once: true }}
                transition={{ duration: 0.8 }}
                className="w-full lg:flex-1 relative group"
            >
                {/* Glow */}
                <div className={`absolute inset-0 bg-linear-to-r ${project.color} opacity-20 blur-[60px] group-hover:opacity-30 transition-opacity duration-500 pointer-events-none`}></div>

                {/* Marc Navegador */}
                <div className="relative rounded-xl border border-border bg-card shadow-2xl overflow-hidden transform transition-transform duration-500 group-hover:scale-[1.02] md:group-hover:-translate-y-2">
                    <div className="h-6 md:h-8 border-b border-border bg-muted/30 flex items-center px-3 gap-1.5 md:gap-2">
                        <div className="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full bg-red-500/50"></div>
                        <div className="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full bg-yellow-500/50"></div>
                        <div className="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full bg-green-500/50"></div>
                        <div className="ml-2 md:ml-4 px-2 py-0.5 rounded bg-background/50 text-[8px] md:text-[10px] text-muted-foreground font-mono border border-border w-full max-w-[150px] md:max-w-[200px] opacity-50 truncate">
                            https://{project.id}.com
                        </div>
                    </div>

                    {/* Imatge */}
                    <div className="aspect-4/3 md:aspect-video relative bg-muted/20 overflow-hidden group-hover:shadow-inner transition-all">
                        {project.image ? (
                            <Image
                                src={project.image}
                                alt={project.imageAlt}
                                fill
                                className="object-cover object-top transition-transform duration-700 group-hover:scale-105"
                                sizes="(max-width: 768px) 100vw, 50vw"
                                placeholder="blur"
                            />
                        ) : (
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-muted-foreground/30">
                                <Layers className="w-12 h-12 md:w-16 md:h-16 mb-4" />
                                <span className="text-xs md:text-sm font-bold uppercase tracking-widest">Captura de {project.title}</span>
                            </div>
                        )}
                    </div>
                </div>
            </motion.div>

            {/* --- COLUMNA TEXT --- */}
            <motion.div
                initial={{ opacity: 0, y: 30 }}
                whileInView={{ opacity: 1, y: 0 }}
                viewport={{ once: true }}
                transition={{ duration: 0.8, delay: 0.2 }}
                className="w-full lg:flex-1 space-y-6 md:space-y-8"
            >
                <div>
                    <div className={`inline-block px-3 py-1 rounded-lg bg-linear-to-r ${project.color} bg-opacity-10 text-[10px] md:text-xs font-bold text-white mb-4 shadow-sm`}>
                        {project.tags[0]}
                    </div>
                    <h2 className="text-3xl md:text-4xl font-bold text-foreground mb-2">{project.title}</h2>
                    <p className={`text-lg md:text-xl font-medium bg-linear-to-r ${project.color} bg-clip-text text-transparent`}>
                        {/* TRADUCCIÃ“ TAGLINE: 'ProjectCard.ribotflow.tagline' */}
                        {t(`${project.id}.tagline`)}
                    </p>
                </div>

                <p className="text-base md:text-lg text-muted-foreground leading-relaxed">
                    {/* TRADUCCIÃ“ DESCRIPCIÃ“: 'ProjectCard.ribotflow.description' */}
                    {t(`${project.id}.description`)}
                </p>

                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4">
                    {/* Per les stats, com que sÃ³n una llista, les traduÃ¯m per Ã­ndex */}
                    {[0, 1, 2].map((i) => (
                        <div key={i} className="flex items-center gap-3 text-sm text-foreground font-medium">
                            <div className={`w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-linear-to-r ${project.color}`}></div>
                            {/* TRADUCCIÃ“ STAT: 'ProjectCard.ribotflow.stats.0' */}
                            {t(`${project.id}.stats.${i}`)}
                        </div>
                    ))}
                </div>

                <div className="flex flex-wrap gap-2 pt-2">
                    {project.tags.map((tag) => (
                        <span key={tag} className="px-2.5 py-0.5 md:px-3 md:py-1 rounded-full border border-border bg-muted/20 text-[10px] md:text-xs font-medium text-muted-foreground">
                            {tag}
                        </span>
                    ))}
                </div>

                <div className="flex gap-4 pt-4">
                    <a href={project.link} target="_blank" rel="noreferrer" className="w-full sm:w-auto">
                        <Button className="w-full sm:w-auto gradient-bg text-white border-0 shadow-lg hover:opacity-90 transition-transform hover:-translate-y-1">
                            {t('view_web')} <ExternalLink className="ml-2 w-4 h-4" />
                        </Button>
                    </a>
                </div>
            </motion.div>

        </div>
    );
}

// =================== FILE: src/features/projects/ui/ProjectList.tsx ===================

import { PROJECTS } from '../data/projects-data';
import { ProjectCard } from './ProjectCard';

export function ProjectsList() {
  return (
    <section className="py-10 pb-20 md:pb-32">
      <div className="container mx-auto px-4 space-y-20 md:space-y-32">
         {PROJECTS.map((project, index) => (
            <ProjectCard key={project.id} project={project} index={index} />
         ))}
      </div>
    </section>
  );
}

// =================== FILE: src/features/projects/ui/ProjectsCTA.tsx ===================

'use client';

import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { ArrowRight } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function ProjectsCTA() {
  const t = useTranslations('ProjectsCTA');

  return (
    <section className="py-16 md:py-24 border-t border-border bg-muted/10">
       <div className="container mx-auto px-4 text-center">
          <h2 className="text-2xl md:text-3xl font-bold text-foreground mb-4 md:mb-6">
             {t('title_prefix')} <span className="gradient-text">{t('title_highlight')}</span>{t('title_suffix')}
          </h2>
          <p className="text-sm md:text-base text-muted-foreground mb-8 md:mb-10 max-w-xl mx-auto px-4">
             {t('description')}
          </p>
          <Link href="/#contacte">
             <Button size="lg" className="h-12 md:h-14 px-6 md:px-8 text-base md:text-lg rounded-full gradient-bg text-white hover:opacity-90 shadow-xl w-full sm:w-auto transition-transform hover:scale-105">
                {t('button')} <ArrowRight className="ml-2 w-5 h-5" />
             </Button>
          </Link>
       </div>
    </section>
  );
}

// =================== FILE: src/features/projects/ui/ProjectsHero.tsx ===================

'use client';

import { motion } from 'framer-motion';
import { Sparkles } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function ProjectsHero() {
  const t = useTranslations('ProjectsHero');

  return (
    <section className="pt-32 pb-16 md:pt-48 md:pb-24 relative overflow-hidden">
      {/* Fons decoratiu */}
      <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] md:w-[1000px] h-[300px] md:h-[500px] bg-primary/10 blur-[80px] md:blur-[120px] rounded-full pointer-events-none opacity-50" />
      
      <div className="container mx-auto px-4 text-center relative z-10">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8 }}
        >
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-[10px] md:text-xs font-bold mb-6 uppercase tracking-widest">
            <Sparkles className="w-3 h-3" />
            {t('badge')}
          </div>
          <h1 className="text-4xl md:text-6xl lg:text-7xl font-bold mb-6 text-foreground leading-tight">
            {t('title_prefix')} <br className="hidden md:block" />
            <span className="gradient-text">{t('title_highlight')}</span>
          </h1>
          <p className="text-base md:text-xl text-muted-foreground max-w-2xl mx-auto leading-relaxed px-4">
            {t('description')}
          </p>
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/features/tests/actions/admin-actions.ts ===================

'use server';

import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { requireAdmin } from '@/lib/auth/admin-guard'; // La teva funciÃ³ de seguretat
import { revalidatePath } from 'next/cache';

import { redirect } from 'next/navigation';
const repo = new SupabaseTestRepository();
// 1. Definim el tipus d'estat (State)
export type ActionState = {
  success: boolean;
  message: string;
};
export async function addTesterAction(campaignId: string, userId: string) {
  await requireAdmin(); // ğŸ›¡ï¸ Seguretat crÃ­tica
  
  const { error } = await repo.assignTester(campaignId, userId);
  
  if (error) {
      // Codi d'error de Postgres per duplicats (si ja estava assignat)
      if (error.code === '23505') return { success: false, message: 'Aquest usuari ja estÃ  assignat.' };
      return { success: false, message: error.message };
  }

  revalidatePath('/admin/tests/[id]', 'page');
  return { success: true, message: 'Tester assignat correctament.' };
}

export async function removeTesterAction(campaignId: string, userId: string) {
  await requireAdmin();
  
  const { error } = await repo.removeTester(campaignId, userId);
  if (error) return { success: false, message: error.message };

  revalidatePath('/admin/tests/[id]', 'page');
  return { success: true, message: 'Tester eliminat.' };
}


// 2. Apliquem el tipus a 'prevState' i al retorn
export async function createCampaignAction(
  prevState: ActionState, 
  formData: FormData
): Promise<ActionState> {
  
  await requireAdmin();

  const projectId = formData.get('projectId') as string;
  const title = formData.get('title') as string;
  const description = formData.get('description') as string;
  const instructions = formData.get('instructions') as string;

  if (!projectId || !title) {
    return { success: false, message: 'Falten camps obligatoris' };
  }

  try {
    const { data, error } = await repo.createCampaign({
      projectId, title, description, instructions
    });

    if (error) {
        return { success: false, message: error.message };
    }

    // Si tot va bÃ©, redirigim (aixÃ² interromp l'execuciÃ³, Ã©s normal)
    redirect(`/admin/tests/${data.id}`);
    
  } catch (error) {
    // Si l'error Ã©s la redirecciÃ³ de Next.js, la deixem passar
    if ((error as Error).message === 'NEXT_REDIRECT') {
        throw error;
    }
    return { success: false, message: 'Error creant la campanya' };
  }
}

// =================== FILE: src/features/tests/actions.ts ===================

'use server';

import { SupabaseTestRepository } from '@/repositories/supabase/SupabaseTestRepository';
import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';

const repo = new SupabaseTestRepository();

export async function submitTestFeedback(taskId: string, status: 'pass' | 'fail' | 'blocked', comment: string) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) return { success: false, message: 'No autenticat' };

  const { error } = await repo.saveResult(user.id, taskId, status, comment);

  if (error) return { success: false, message: error.message };
  
  // Refresquem el dashboard per veure el canvi d'estat
  revalidatePath('/dashboard/projects/[id]', 'page'); 
  return { success: true };
}

// =================== FILE: src/features/tests/ui/CreateCampaignForm.tsx ===================

'use client';

import { useActionState } from 'react';
import { createCampaignAction, ActionState } from '@/features/tests/actions/admin-actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Save, Loader2, AlertCircle } from 'lucide-react';

// Estat inicial
const initialState: ActionState = {
  success: false,
  message: '',
};

type ProjectSummary = {
    id: string;
    name: string;
};

export function CreateCampaignForm({ projects }: { projects: ProjectSummary[] }) {
  // Hook per connectar el Server Action amb el formulari
  const [state, action, isPending] = useActionState(createCampaignAction, initialState);

  return (
    <form action={action} className="space-y-6">
        
        {/* Projecte */}
        <div className="space-y-2">
            <label className="text-sm font-medium text-slate-300">Projecte</label>
            <select 
                name="projectId" 
                required 
                className="w-full p-3 rounded-lg bg-slate-900 border border-slate-700 text-white focus:ring-2 focus:ring-purple-500 outline-none"
            >
                <option value="">Selecciona un projecte...</option>
                {projects.map(p => (
                    <option key={p.id} value={p.id}>{p.name}</option>
                ))}
            </select>
        </div>

        {/* TÃ­tol */}
        <div className="space-y-2">
            <label className="text-sm font-medium text-slate-300">TÃ­tol de la Campanya</label>
            <Input name="title" placeholder="Ex: Beta v2.0 - Android" required className="bg-slate-900 border-slate-700 text-white" />
        </div>

        {/* DescripciÃ³ */}
        <div className="space-y-2">
            <label className="text-sm font-medium text-slate-300">DescripciÃ³ Curta</label>
            <Input name="description" placeholder="Objectiu principal del test..." className="bg-slate-900 border-slate-700 text-white" />
        </div>

        {/* Instruccions */}
        <div className="space-y-2">
            <label className="text-sm font-medium text-slate-300">Instruccions Detallades (Markdown)</label>
            <textarea 
                name="instructions" 
                rows={6}
                placeholder="Instruccions per als testers (com instalÂ·lar, credencials, etc.)"
                className="w-full p-3 rounded-lg bg-slate-900 border border-slate-700 text-white focus:ring-2 focus:ring-purple-500 outline-none font-mono text-sm"
            />
        </div>

        {/* Missatge d'Error */}
        {!state.success && state.message && (
            <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 flex items-center gap-2 text-sm">
                <AlertCircle className="w-4 h-4" /> {state.message}
            </div>
        )}

        {/* BotÃ³ Submit */}
        <Button type="submit" disabled={isPending} className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold h-12">
            {isPending ? (
                <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Creant...</>
            ) : (
                <><Save className="w-4 h-4 mr-2" /> Crear i Afegir Tasques</>
            )}
        </Button>
    </form>
  );
}

// =================== FILE: src/features/tests/ui/TaskRunner.tsx ===================

'use client';

import { useState } from 'react';
import { TestTaskDTO, TestResultDTO } from '@/types/models';
import { CheckCircle, XCircle, AlertTriangle, ChevronDown, ChevronUp } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { submitTestFeedback } from '../actions';

// Simple toast casolÃ  o usa 'sonner'/'react-hot-toast' si en tens
const notify = (msg: string) => alert(msg); 

export function TaskRunner({ task, existingResult }: { task: TestTaskDTO, existingResult?: TestResultDTO }) {
  const [isOpen, setIsOpen] = useState(!existingResult); 
  const [status, setStatus] = useState<string | null>(existingResult?.status || null);
  const [comment, setComment] = useState(existingResult?.comment || '');
  const [isSaving, setIsSaving] = useState(false);

  const handleSubmit = async (newStatus: 'pass' | 'fail' | 'blocked') => {
    setIsSaving(true);
    setStatus(newStatus); 
    
    const res = await submitTestFeedback(task.id, newStatus, comment);
    
    if (res.success) {
      setIsOpen(false); 
    } else {
      notify('Error guardant.');
    }
    setIsSaving(false);
  };

  return (
    <div className={`border rounded-xl mb-4 transition-all bg-white dark:bg-slate-900 ${
        status === 'pass' ? 'border-green-500/30 bg-green-50/10' : 
        status === 'fail' ? 'border-red-500/30 bg-red-50/10' : 
        'border-border'
    }`}>
      
      {/* Header */}
      <div 
        className="p-4 flex items-center justify-between cursor-pointer select-none"
        onClick={() => setIsOpen(!isOpen)}
      >
        <div className="flex items-center gap-3">
          {status === 'pass' && <CheckCircle className="text-green-500 w-5 h-5" />}
          {status === 'fail' && <XCircle className="text-red-500 w-5 h-5" />}
          {status === 'blocked' && <AlertTriangle className="text-orange-500 w-5 h-5" />}
          {!status && <div className="w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600" />}
          
          <span className={`font-medium ${status ? 'text-slate-500' : 'text-foreground'}`}>
            {task.title}
          </span>
        </div>
        {isOpen ? <ChevronUp className="w-4 h-4 text-slate-400" /> : <ChevronDown className="w-4 h-4 text-slate-400" />}
      </div>

      {/* Cos */}
      {isOpen && (
        <div className="px-4 pb-4 pt-0 border-t border-border mt-2">
          <p className="text-sm text-muted-foreground my-4 leading-relaxed bg-muted/30 p-3 rounded-lg border border-border">
            ğŸ“ <strong>InstrucciÃ³:</strong> {task.description}
          </p>

          <textarea 
            placeholder="Afegeix comentaris..." 
            value={comment || ''}
            onChange={(e) => setComment(e.target.value)}
            className="w-full p-2 mb-4 text-sm bg-background border border-input rounded-md min-h-[80px]"
          />

          <div className="flex gap-2 justify-end">
            <Button 
                size="sm" variant="outline" 
                className="border-red-200 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"
                onClick={() => handleSubmit('fail')} disabled={isSaving}
            >
              <XCircle className="w-4 h-4 mr-2" /> Falla
            </Button>
            <Button 
                size="sm" 
                className="bg-green-600 hover:bg-green-700 text-white"
                onClick={() => handleSubmit('pass')} disabled={isSaving}
            >
              <CheckCircle className="w-4 h-4 mr-2" /> Funciona
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/features/tests/ui/TesterManager.tsx ===================

'use client';

import { useState, useMemo } from 'react'; // ğŸ‘ˆ Importa useMemo
import { TesterProfile } from '@/types/models';
import { addTesterAction, removeTesterAction } from '@/features/tests/actions/admin-actions'; // ğŸ‘ˆ Assegura el path
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Trash2, UserPlus, Search, Check } from 'lucide-react';
import { toast } from 'sonner'; 

interface Props {
  campaignId: string;
  assignedTesters: TesterProfile[];
  availableTesters: TesterProfile[];
}

export function TesterManager({ campaignId, assignedTesters, availableTesters }: Props) {
  const [searchTerm, setSearchTerm] = useState('');
  const [isPending, setIsPending] = useState(false);

  // ğŸ›¡ï¸ CORRECCIÃ“: Usem useMemo per calcular la llista de candidats de forma segura
  const filteredCandidates = useMemo(() => {
    // 1. Creem un Set amb els IDs ja assignats per cerca rÃ pida O(1)
    const assignedIds = new Set(assignedTesters.map(t => t.id));

    // 2. Filtrem:
    // - Que no estigui ja assignat
    // - Que coincideixi amb el terme de cerca (si n'hi ha)
    // - ğŸ›¡ï¸ EXTRA: Ens assegurem que no hi hagi duplicats a la llista 'available' d'origen
    const uniqueCandidates = new Map(); // Use Map to dedup by ID

    availableTesters.forEach(u => {
        if (assignedIds.has(u.id)) return; // Ja assignat
        
        if (searchTerm && !u.email.toLowerCase().includes(searchTerm.toLowerCase())) return; // No coincideix cerca

        if (!uniqueCandidates.has(u.id)) {
            uniqueCandidates.set(u.id, u);
        }
    });

    return Array.from(uniqueCandidates.values());
  }, [assignedTesters, availableTesters, searchTerm]);

  const handleAdd = async (userId: string) => {
    setIsPending(true);
    const res = await addTesterAction(campaignId, userId);
    if (res.success) toast.success(res.message);
    else toast.error(res.message);
    setIsPending(false);
  };

  const handleRemove = async (userId: string) => {
    if(!confirm("Segur que vols treure l'accÃ©s a aquest usuari?")) return;
    
    setIsPending(true);
    const res = await removeTesterAction(campaignId, userId);
    if (res.success) toast.success(res.message);
    else toast.error(res.message);
    setIsPending(false);
  };

  return (
    <div className="grid lg:grid-cols-2 gap-8">
        
        {/* LLISTA ACTUAL (ASSIGNATS) */}
        <div className="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-6 shadow-sm">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                <Check className="w-5 h-5 text-green-500" /> Testers Actius ({assignedTesters.length})
            </h3>
            
            <div className="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                {assignedTesters.length === 0 && (
                    <p className="text-sm text-slate-500 italic">No hi ha ningÃº assignat encara.</p>
                )}
                
                {assignedTesters.map(tester => (
                    // ğŸ›¡ï¸ Assegura't que tester.id Ã©s Ãºnic aquÃ­ tambÃ©
                    <div key={`assigned-${tester.id}`} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-700">
                        <div className="flex items-center gap-3">
                            <Avatar className="h-8 w-8">
                                <AvatarImage src={tester.avatar_url || ''} />
                                <AvatarFallback>{tester.email?.[0]?.toUpperCase() || 'U'}</AvatarFallback>
                            </Avatar>
                            <div className="overflow-hidden">
                                <p className="text-sm font-medium truncate">{tester.full_name || 'Sense nom'}</p>
                                <p className="text-xs text-slate-500 truncate">{tester.email}</p>
                            </div>
                        </div>
                        <Button 
                            size="icon" 
                            variant="ghost" 
                            onClick={() => handleRemove(tester.id)}
                            disabled={isPending}
                            className="text-slate-400 hover:text-red-500 hover:bg-red-50"
                        >
                            <Trash2 className="w-4 h-4" />
                        </Button>
                    </div>
                ))}
            </div>
        </div>

        {/* LLISTA CANDIDATS (DISPONIBLES) */}
        <div className="bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-800 p-6">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-700 dark:text-slate-300">
                <UserPlus className="w-5 h-5" /> Afegir Testers
            </h3>

            {/* Cercador */}
            <div className="relative mb-4">
                <Search className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                <input 
                    type="text" 
                    placeholder="Buscar per email..." 
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full pl-9 p-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                />
            </div>

            <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                {filteredCandidates.length === 0 ? (
                    <p className="text-sm text-slate-400 text-center py-4">
                        {searchTerm ? 'Cap resultat trobat.' : 'No hi ha candidats disponibles.'}
                    </p>
                ) : (
                    filteredCandidates.map(user => (
                        <div key={`candidate-${user.id}`} className="flex items-center justify-between p-2 hover:bg-white dark:hover:bg-slate-800 rounded-lg transition-colors group cursor-pointer border border-transparent hover:border-slate-200 dark:hover:border-slate-700" onClick={() => handleAdd(user.id)}>
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 flex items-center justify-center text-xs font-bold">
                                    {user.email?.[0]?.toUpperCase() || 'U'}
                                </div>
                                <div>
                                    <p className="text-sm text-slate-700 dark:text-slate-300 font-medium">{user.email}</p>
                                </div>
                            </div>
                            <Button size="sm" variant="ghost" className="opacity-0 group-hover:opacity-100 text-blue-600 font-bold" disabled={isPending}>
                                Assignar
                            </Button>
                        </div>
                    ))
                )}
            </div>
        </div>
    </div>
  );
}

// =================== FILE: src/i18n/request.ts ===================

import { getRequestConfig } from 'next-intl/server';
import { notFound } from 'next/navigation';
import { routing, type Locale } from '@/routing'; // ğŸ‘ˆ IMPORTEM DE LA FONT ÃšNICA

export default getRequestConfig(async ({ requestLocale }) => {
  const locale = await requestLocale;

  // Ara validem contra la configuraciÃ³ centralitzada
  // AixÃ­ no hem de mantenir dues llistes d'idiomes
  if (!locale || !routing.locales.includes(locale as Locale)) {
    notFound();
  }

  return {
    locale,
    messages: (await import(`../../messages/${locale}.json`)).default
  };
});

// =================== FILE: src/lib/audit-dictionary.ts ===================

// src/lib/audit-dictionary.ts

export const AUDIT_TRANSLATIONS: Record<
  string, // id de l'auditoria
  Record<
    string, // locale, p.ex. 'ca', 'es', 'en'
    { title: string; description: string }
  >
> = {
  // AQUESTA Ã‰S L'ESTRUCTURA CORRECTA AMB KEY DE LOCALE:
  'is-on-https': {
    ca: {
      title: 'El lloc web no utilitza HTTPS segur',
      description: 'La teva web no Ã©s segura. AixÃ² espanta els clients i Google et penalitza greument.'
    },
    es: {
      title: 'El sitio web no usa HTTPS seguro',
      description: 'Tu web no es segura. Esto asusta a los clientes y Google te penaliza.'
    },
    en: {
      title: 'Website is not using secure HTTPS',
      description: 'Your website is not secure. This scares users and Google may penalize you.'
    }
  },
  // âš ï¸ CORRECCIÃ“: ESTRUCTURA DE FALLBACK SIMPLE REQUEREIX CLAU 'ca' EXPLÃCITA
  'meta-description': {
    ca: { 
        title: 'Manca la Meta DescripciÃ³',
        description: 'Google no sap de quÃ¨ tracta la teva web. Necessites un resum atractiu per aparÃ¨ixer als resultats de cerca.'
    }
  },
  'document-title': {
    ca: {
        title: 'La pÃ gina no tÃ© tÃ­tol',
        description: 'El tÃ­tol Ã©s l\'element mÃ©s important per al SEO. Sense ell, Ã©s invisible.'
    }
  },
  'image-alt': {
    ca: {
        title: 'Imatges sense text alternatiu',
        description: 'Les imatges necessiten una descripciÃ³ perquÃ¨ Google les pugui "veure" i indexar.'
    }
  },
  'viewport': {
    ca: {
        title: 'No estÃ  adaptada a mÃ²bils',
        description: 'La web no tÃ© l\'etiqueta viewport correcta, fent que es vegi malament en dispositius mÃ²bils.'
    }
  },
  'server-response-time': {
    ca: {
        title: 'El servidor Ã©s massa lent',
        description: 'El temps de resposta inicial Ã©s alt. Considera canviar de hosting o optimitzar el backend.'
    }
  },
  'render-blocking-resources': {
    ca: {
        title: 'Recursos que bloquegen la visualitzaciÃ³',
        description: 'Hi ha CSS o JS que impedeixen que la web es mostri rÃ pidament. S\'han de diferir.'
    }
  },
  'unminified-css': {
    ca: {
        title: 'CSS no optimitzat',
        description: 'Els fitxers d\'estil sÃ³n massa grans. Minificar-los milloraria la velocitat.'
    }
  },
  'unminified-javascript': {
    ca: {
        title: 'JavaScript no optimitzat',
        description: 'El codi script Ã©s massa pesat. Cal comprimir-lo per accelerar la cÃ rrega.'
    }
  },
  'uses-optimized-images': {
    ca: {
        title: 'Imatges massa pesades',
        description: 'Les imatges no estan optimitzades. Utilitza formats moderns com WebP per estalviar dades.'
    }
  },
  'largest-contentful-paint': {
    ca: {
        title: 'CÃ rrega del contingut principal (LCP) lenta',
        description: 'L\'element mÃ©s gran de la web triga massa a aparÃ¨ixer. AixÃ² frustra els usuaris.'
    }
  },
  'cumulative-layout-shift': {
    ca: {
        title: 'La web es "mou" mentre carrega (CLS)',
        description: 'Els elements canvien de lloc sobtadament, causant una mala experiÃ¨ncia d\'usuari.'
    }
  }
};

export function translateIssue(
  id: string,
  defaultTitle: string,
  defaultDesc: string,
  locale: string = 'ca'
) {
  const translationForId = AUDIT_TRANSLATIONS[id];
  if (translationForId) {
    const translationForLocale = translationForId[locale];
    if (translationForLocale) return translationForLocale;
  }

  // Si no troba la traducciÃ³, torna al text per defecte (en anglÃ¨s de Google)
  return {
    title: defaultTitle,
    description: (defaultDesc || '').split('[')[0].replace(/\.$/, '')
  };
}

// =================== FILE: src/lib/auth/admin-guard.ts ===================

import { createClient } from '@/lib/supabase/server';
import { notFound, redirect } from 'next/navigation';

/**
 * Aquesta funciÃ³ actua com un tallafocs.
 * Si l'usuari no Ã©s l'Admin, atura l'execuciÃ³ i llanÃ§a un 404.
 */
export async function requireAdmin() {
  const supabase = await createClient();
  
  // 1. Obtenim l'usuari
  const { data: { user }, error } = await supabase.auth.getUser();

  // 2. Si no estÃ  loguejat -> Al login
  if (error || !user) {
    redirect('/auth/login');
  }

  // 3. VERIFICACIÃ“ MESTRA
  // Comparem l'email de l'usuari amb la variable d'entorn
  const adminEmail = process.env.ADMIN_EMAIL;

  if (!adminEmail) {
    console.error("âŒ ERROR CRÃTIC: No s'ha configurat ADMIN_EMAIL al .env");
    // Per seguretat, si no hi ha config, bloquegem tothom
    notFound(); 
  }

  if (user.email !== adminEmail) {
    console.warn(`âš ï¸ ALERTA DE SEGURETAT: L'usuari ${user.email} ha intentat accedir a l'admin.`);
    // 4. Si no Ã©s l'admin, mostrem un 404 (Not Found).
    // AixÃ­ ni tan sols saben que la pÃ gina existeix.
    notFound();
  }

  // Si arriba aquÃ­, ets tu. Benvingut, cap.
  return user;
}

// =================== FILE: src/lib/data.ts ===================

// src/lib/data.ts
import { StaticImageData } from 'next/image'; // ğŸ‘ˆ Necessari pel tipatge

import bioshopImg from '@/assets/images/testimoni-garatgeestacio.jpg';
import salutFlow from '@/assets/images/salutflow.png';

export type Testimonial = {
  id: number | string;
  name: string;
  company: string;
  text: string;
  rating: number;
  projectType: 'web' | 'app' | 'automation';
  projectUrl?: string;
  image?: string | StaticImageData;
};

export const TESTIMONIALS: Testimonial[] = [
  {
    id: 1,
    name: "Marc Vila",
    company: "Gestoria Vila",
    text: "Hem estalviat 20h setmanals grÃ cies al bot de WhatsApp.",
    rating: 5,
    projectType: 'automation'
  },
  {
    id: 2,
    name: "Anna Soler",
    company: "Garatge EstaciÃ³", // He vist el nom al fitxer jpg
    text: "La web carrega instantÃ niament. Les vendes han pujat un 40%.",
    rating: 5,
    projectType: 'web',
    projectUrl: 'https://garatgeestacio.com',
    // âœ… 3. USEM LA VARIABLE IMPORTADA
    image: bioshopImg
  },
  {
    id: 3,
    name: "Jordi P.",
    company: "Tech Solutions",
    text: "Han entÃ¨s la nostra idea d'App a la primera.",
    rating: 5,
    projectType: 'app',
    image: salutFlow
  },

  // Nous exemples per al carrousel
  {
    id: 4,
    name: "Laura M.",
    company: "ClÃ­nica Dental",
    text: "El sistema de cites prÃ¨vies ha eliminat les trucades perdudes.",
    rating: 5,
    projectType: 'web'
  },
  {
    id: 5,
    name: "Pere Roig",
    company: "LogÃ­stica RÃ pida",
    text: "L'App per als repartidors funciona fins i tot sense cobertura.",
    rating: 5,
    projectType: 'app'
  }
];

// =================== FILE: src/lib/factory/config-generator.ts ===================

import { MasterConfig } from '@/types/config';

export function generateConfigFileContent(config: MasterConfig): string {
  // Convertim l'objecte a JSON bonic amb indentaciÃ³ de 2 espais
  const jsonString = JSON.stringify(config, null, 2);

  // Retornem el contingut exacte del fitxer .ts
  return `
import { MasterConfig } from "@/types/config";

export const CONFIG: MasterConfig = ${jsonString};
`;
}

// =================== FILE: src/lib/mock-audit.ts ===================

// Dades falses per poder dissenyar la UI de l'informe
export const MOCK_REPORT = {
  scores: {
    seo: 85,
    performance: 62,
    accessibility: 90,
    best_practices: 75
  },
  issues: [
    { type: 'error', message: 'Falta l\'etiqueta H1 a la pÃ gina principal', impact: 'high' },
    { type: 'warning', message: 'Imatges sense atribut ALT detectades', impact: 'medium' },
    { type: 'success', message: 'Certificat SSL vÃ lid i actiu', impact: 'none' }
  ],
  technologies: ['Next.js', 'Tailwind CSS', 'Vercel']
};

// =================== FILE: src/lib/supabase/client.ts ===================

import { createBrowserClient } from '@supabase/ssr'
// ğŸ‘‡ Importa els tipus
import { Database } from '@/types/database.types' 

export function createClient() {
  // ğŸ‘‡ Afegeix el genÃ¨ric <Database> aquÃ­
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}

// =================== FILE: src/lib/supabase/middleware.ts ===================

import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'
import { Database } from '@/types/database.types'

// ğŸ‘‡ Afegeix el genÃ¨ric <Database> aquÃ­
export async function updateSession(
  request: NextRequest, 
  response: NextResponse // âœ… Rebem la resposta del i18n
) {
  const supabase = createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => {
            request.cookies.set(name, value)
            response.cookies.set(name, value, options)
          })
        },
      },
    }
  )

  // AixÃ² refresca el token si Ã©s necessari
  const { data: { user } } = await supabase.auth.getUser()

  // ğŸ›¡ï¸ PROTECCIÃ“ DE RUTES
  // Si intenta accedir a /dashboard sense usuari -> Login
  if (request.nextUrl.pathname.includes('/dashboard') && !user) {
    // Detectem el locale actual de la URL per redirigir al login correcte
    const locale = request.nextUrl.pathname.split('/')[1] || 'ca';
    const loginUrl = request.nextUrl.clone()
    loginUrl.pathname = `/${locale}/auth/login`
    return NextResponse.redirect(loginUrl)
  }

  return response
}

// =================== FILE: src/lib/supabase/server.ts ===================

import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
// ğŸ‘‡ Importem el client bÃ sic tambÃ©
import { createClient as createSupabaseClient } from '@supabase/supabase-js'
import { Database } from '@/types/database.types'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch { }
        },
      },
    }
  )
}

// ğŸ‘‡ NOVA FUNCIÃ“: Client Admin (Bypass RLS)
// Aquest client NO fa servir cookies, fa servir la clau secreta
export function createAdminClient() {
  return createSupabaseClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!, // <--- Aquesta clau Ã©s CRÃTICA
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    }
  )
}

// =================== FILE: src/lib/utils.ts ===================

import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}


// =================== FILE: src/proxy.ts ===================

// =================== FILE: src/proxy.ts ===================

import createMiddleware from 'next-intl/middleware';
import { routing } from '@/routing';
import { updateSession } from '@/lib/supabase/middleware';
import { NextRequest } from 'next/server';

const intlMiddleware = createMiddleware(routing);

export async function proxy(request: NextRequest) {
  const response = intlMiddleware(request);
  return await updateSession(request, response);
}

export const config = {
  matcher: [
    // ğŸ‘‡ HE AFEGIT 'webmanifest' i 'mp4' A L'EXCEPCIÃ“ DEL REGEX
    // AixÃ² diu: "Executa el middleware a tot ARREU EXCEPTE api, next, imatges, manifest i videos"
    '/((?!api|_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp|webmanifest|mp4)$).*)',
  ],
};

// =================== FILE: src/repositories/interfaces/IAnalyticsRepository.ts ===================

import { AnalyticsEventDTO } from '@/types/models';
export type StatItem = { name: string; value: number; color?: string }; // Tipus genÃ¨ric per grÃ fics
export type DailyStats = {
  date: string;
  visitors: number;
  views: number;
};

// ğŸ‘‡ NOUS TIPUS
export type PageStat = { path: string; views: number };
export type DeviceStat = { name: string; value: number; fill: string }; // 'fill' Ã©s pel color del grÃ fic
export type CountryStat = { country: string; visitors: number };

export interface IAnalyticsRepository {
  trackEvent(event: AnalyticsEventDTO): Promise<void>;
  getLast7DaysStats(): Promise<DailyStats[]>;
  // ğŸ‘‡ NOU MÃˆTODE AGREGAT
  getAdvancedStats(): Promise<{
    topPages: PageStat[];
    devices: DeviceStat[];
    countries: StatItem[]; // Ara usem StatItem (mÃ©s flexible)
    referrers: StatItem[]; // Nou
    browsers: StatItem[];  // Nou
    os: StatItem[];        // Nou
  }>;
}

// =================== FILE: src/repositories/interfaces/IAuditRepository.ts ===================

import { AuditDTO } from '@/types/models';

export interface IAuditRepository {
  getAuditsByUserEmail(email: string): Promise<AuditDTO[]>;
  getAuditById(id: string): Promise<AuditDTO | null>;
  createAudit(url: string, email: string): Promise<AuditDTO>;
  updateStatus(id: string, status: AuditDTO['status'], data?: Record<string, unknown>): Promise<void>;
  // Canvia la signatura de updateStatus per ser mÃ©s flexible o especÃ­fica
  updateStatus(
    id: string,
    status: AuditDTO['status'],
    results?: { seoScore?: number; performanceScore?: number; reportData?: unknown }
  ): Promise<void>;
  getAuditsByUserEmail(email: string): Promise<AuditDTO[]>; // Aquest ja el tenies, assegura't d'usar-lo!
  getAuditsByUserId(userId: string): Promise<AuditDTO[]>; // ğŸ‘ˆ MÃ¨tode nou

  createAuditForUser(url: string, userId: string, email: string): Promise<AuditDTO>; // ğŸ‘ˆ MÃ¨tode nou
  createPublicAudit(url: string, email: string): Promise<AuditDTO>; // ğŸ‘ˆ MÃ¨tode nou
}

// =================== FILE: src/repositories/interfaces/IPostRepository.ts ===================

import { BlogPostDTO } from '@/types/models';

export interface IPostRepository {
  getPostBySlug(slug: string): Promise<BlogPostDTO | null>;
  getAllPublishedPosts(): Promise<BlogPostDTO[]>;
  
  // ğŸ‘‡ NOUS MÃˆTODES D'ADMINISTRACIÃ“
  getAllPosts(): Promise<BlogPostDTO[]>; // Inclou esborranys i arxivats
  updatePost(slug: string, data: Partial<BlogPostDTO>): Promise<void>;
  deletePost(slug: string): Promise<void>;
  getAdminPostBySlug(slug: string): Promise<BlogPostDTO | null>;
}

// =================== FILE: src/repositories/supabase/SupabaseAnalyticsRepository.ts ===================

import { createClient, createAdminClient } from '@/lib/supabase/server'; // ğŸ‘ˆ Afegim createAdminClient
import { AnalyticsEventDTO } from '@/types/models';
import { Database } from '@/types/database.types';
import {
  IAnalyticsRepository,
  DailyStats,
  PageStat,
  DeviceStat,

  StatItem // ğŸ‘ˆ Assegura't d'importar aquest tipus nou que vam crear
} from '../interfaces/IAnalyticsRepository';

type AnalyticsInsert = Database['public']['Tables']['analytics_events']['Insert'];

export class SupabaseAnalyticsRepository implements IAnalyticsRepository {

  // 1. MÃˆTODE D'ESCRIPTURA (TRACKING)
  // Aquest ha de ser "blindat" perquÃ¨ l'executa tothom (fins i tot usuaris sense login).
  async trackEvent(event: AnalyticsEventDTO): Promise<void> {
    // âš ï¸ CANVI IMPORTANT: Usem el client ADMIN per escriure,
    // ja que hem tancat la porta pÃºblica RLS al Pas 1.
    const supabaseAdmin = createAdminClient();

    const { error } = await supabaseAdmin.from('analytics_events').insert({
      event_name: event.event_name,
      path: event.path,
      session_id: event.session_id,
      // Assegurem que el tipus encaixa
      meta: event.meta as AnalyticsInsert['meta'],
      country: event.geo?.country,
      city: event.geo?.city,
      browser: event.device?.browser,
      os: event.device?.os,
      device_type: event.device?.type,
      referrer: event.referrer,
      duration_seconds: event.duration || 0
    });

    if (error) {
      console.error("Error al Repositori (trackEvent):", error.message);
      // Opcional: llanÃ§ar error si vols que la Action ho sÃ piga
      // throw new Error(error.message);
    }
  }

  async getLast7DaysStats(): Promise<DailyStats[]> {
    const supabase = await createClient();

    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    const { data, error } = await supabase
      .from('analytics_events')
      .select('created_at, session_id')
      .gte('created_at', sevenDaysAgo.toISOString())
      .order('created_at', { ascending: true });

    if (error || !data) return [];

    const statsMap = new Map<string, { views: number; sessions: Set<string> }>();

    for (let i = 6; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const key = d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
      statsMap.set(key, { views: 0, sessions: new Set() });
    }

    data.forEach((row) => {
      if (row.created_at) {
        const date = new Date(row.created_at);
        const key = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });

        if (statsMap.has(key)) {
          const entry = statsMap.get(key)!;
          entry.views++;
          if (row.session_id) entry.sessions.add(row.session_id);
        }
      }
    });

    return Array.from(statsMap.entries()).map(([date, val]) => ({
      date,
      views: val.views,
      visitors: val.sessions.size
    }));
  }

  // ğŸ› ï¸ MÃˆTODE CORREGIT AMB TOTS ELS TIPUS DE RETORN
  async getAdvancedStats(): Promise<{
    topPages: PageStat[];
    devices: DeviceStat[];
    countries: StatItem[];
    referrers: StatItem[];
    browsers: StatItem[];
    os: StatItem[];
  }> {
    const supabase = await createClient();

    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    // 1. Seleccionem TOTS els camps necessaris
    // IMPORTANT: Assegura't que aquests camps existeixen a la DB i als tipus generats
    // Si 'referrer' no existeix, regenera els tipus (npx supabase gen types...)
    const { data, error } = await supabase
      .from('analytics_events')
      .select('path, device_type, country, session_id, referrer, browser, os')
      .gte('created_at', thirtyDaysAgo.toISOString());

    if (error || !data) {
      return { topPages: [], devices: [], countries: [], referrers: [], browsers: [], os: [] };
    }

    // 2. Inicialitzem els Maps
    const pagesMap = new Map<string, number>();
    const devicesMap = new Map<string, number>();
    const countryMap = new Map<string, Set<string>>(); // Set per usuaris Ãºnics
    const referrerMap = new Map<string, number>();
    const browserMap = new Map<string, number>();
    const osMap = new Map<string, number>();

    // 3. Processem les dades
    data.forEach(row => {
      // Pages
      const cleanPath = row.path || '/';
      pagesMap.set(cleanPath, (pagesMap.get(cleanPath) || 0) + 1);

      // Devices
      const dev = row.device_type === 'mobile' ? 'MÃ²bil' : row.device_type === 'tablet' ? 'Tauleta' : 'PC';
      devicesMap.set(dev, (devicesMap.get(dev) || 0) + 1);

      // Countries (Set)
      const country = row.country === 'Unknown' ? 'Desconegut' : row.country;
      if (country) {
        if (!countryMap.has(country)) countryMap.set(country, new Set());
        if (row.session_id) countryMap.get(country)!.add(row.session_id);
      }

      // Referrers
      let ref = row.referrer || 'Directe';
      try {
        if (ref.startsWith('http')) ref = new URL(ref).hostname.replace('www.', '');
      } catch { }
      referrerMap.set(ref, (referrerMap.get(ref) || 0) + 1);

      // Browsers
      const browser = row.browser || 'Altres';
      browserMap.set(browser, (browserMap.get(browser) || 0) + 1);

      // OS
      const os = row.os || 'Altres';
      osMap.set(os, (osMap.get(os) || 0) + 1);
    });

    // 4. Funcions auxiliars per formatar a StatItem[]
    const toStatArray = (map: Map<string, number>, colors: string[]): StatItem[] =>
      Array.from(map.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([name, value], i) => ({ name, value, color: colors[i % colors.length] }));

    // 5. Generem els arrays finals
    const referrers = toStatArray(referrerMap, ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe']);
    const browsers = toStatArray(browserMap, ['#f59e0b', '#fbbf24', '#fcd34d', '#fde68a', '#fef3c7']);
    const os = toStatArray(osMap, ['#ec4899', '#f472b6', '#fbcfe8', '#fce7f3', '#fdf2f8']);

    const countries: StatItem[] = Array.from(countryMap.entries())
      .map(([name, set]) => ({
        name: name === 'Unknown' ? 'ğŸŒ Desconegut' : name,
        value: set.size,
        color: '#10b981'
      }))
      .sort((a, b) => b.value - a.value)
      .slice(0, 5);

    const topPages: PageStat[] = Array.from(pagesMap.entries())
      .map(([path, views]) => ({ path, views }))
      .sort((a, b) => b.views - a.views)
      .slice(0, 15);

    const deviceColors = ['#8884d8', '#00C49F', '#FFBB28'];
    const devices: DeviceStat[] = Array.from(devicesMap.entries())
      .map(([name, value], index) => ({
        name,
        value,
        fill: deviceColors[index % deviceColors.length]
      }));

    // âœ… CORRECCIÃ“ FINAL: Retornem TOTS els camps que la interfÃ­cie espera
    return {
      topPages,
      devices,
      countries,
      referrers,
      browsers,
      os
    };
  }
}

// =================== FILE: src/repositories/supabase/SupabaseAuditRepository.ts ===================

import { createClient, createAdminClient } from '@/lib/supabase/server';
import { IAuditRepository } from '../interfaces/IAuditRepository';
import { AuditDTO } from '@/types/models';
import { Database } from '@/types/database.types';

// Tipus directe de la fila de la DB
type AuditRow = Database['public']['Tables']['web_audits']['Row'];

export class SupabaseAuditRepository implements IAuditRepository {

  private mapToDTO(row: AuditRow): AuditDTO {
    return {
      id: row.id,
      url: row.url,
      status: row.status as AuditDTO['status'],
      seoScore: row.seo_score,
      performanceScore: row.performance_score,
      createdAt: row.created_at ? new Date(row.created_at) : new Date(),
      // Fem un cast segur cap a un objecte genÃ¨ric o unknown
      reportData: row.report_data as Record<string, unknown>,
    };
  }

  async getAuditsByUserEmail(email: string): Promise<AuditDTO[]> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('web_audits')
      .select('*')
      .eq('email', email)
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);
    return data.map(this.mapToDTO);
  }

  async getAuditById(id: string): Promise<AuditDTO | null> {
    const supabase = await createClient();
    const { data } = await supabase.from('web_audits').select('*').eq('id', id).single();
    return data ? this.mapToDTO(data) : null;
  }

  async createAudit(url: string, email: string): Promise<AuditDTO> {
    console.log(`[Repo] Creant auditoria per: ${email} - URL: ${url}`);

    const supabaseAdmin = createAdminClient();

    const { data, error } = await supabaseAdmin
      .from('web_audits')
      .insert({
        url,
        email,
        status: 'processing'
      })
      .select()
      .single();

    if (error) {
      console.error('[Repo] Error Supabase:', error);
      throw new Error(`Error creating audit: ${error.message}`);
    }

    console.log('[Repo] Auditoria creada OK:', data.id);
    return this.mapToDTO(data);
  }

  async updateStatus(
    id: string,
    status: AuditDTO['status'],
    results?: { 
      seoScore?: number; 
      performanceScore?: number; 
      reportData?: Record<string, unknown> 
    }
  ): Promise<void> {
    const supabaseAdmin = createAdminClient();

    // Utilitzem Partial<AuditRow> per assegurar que els camps coincideixen amb la DB
    // Omitim 'id' i 'created_at' perquÃ¨ no els tocarem
    const updatePayload: Partial<AuditRow> = { status };

    if (results) {
      if (results.seoScore !== undefined) updatePayload.seo_score = results.seoScore;
      if (results.performanceScore !== undefined) updatePayload.performance_score = results.performanceScore;
      
      if (results.reportData !== undefined) {
        // âœ… CORRECCIÃ“ CLAU:
        // En lloc de 'as any', fem un cast al tipus especÃ­fic que Supabase espera per aquesta columna.
        // AixÃ² satisfÃ  l'Eslint i mantÃ© la seguretat de tipus relativa a la DB.
        updatePayload.report_data = results.reportData as AuditRow['report_data'];
      }
    }

    const { error } = await supabaseAdmin
      .from('web_audits')
      .update(updatePayload)
      .eq('id', id);

    if (error) throw new Error(error.message);
  }
  async getAuditsByUserId(userId: string): Promise<AuditDTO[]> {
      const supabase = await createClient();
      const { data, error } = await supabase
        .from('web_audits')
        .select('*')
        .eq('user_id', userId) // ğŸ‘ˆ Filtrem per ID, molt mÃ©s robust
        .order('created_at', { ascending: false });
      
      if (error) throw new Error(error.message);
      return data.map(this.mapToDTO);
  }

  // CAS 1: Des del Dashboard (Tenim ID segur)
  async createAuditForUser(url: string, userId: string, email: string): Promise<AuditDTO> {
    const supabaseAdmin = createAdminClient();
    const { data, error } = await supabaseAdmin
      .from('web_audits')
      .insert({
        url,
        user_id: userId, // âœ… Clau
        email: email,
        status: 'processing'
      })
      .select()
      .single();

    if (error) throw new Error(error.message);
    return this.mapToDTO(data);
  }

  // CAS 2: Des de la Landing (NomÃ©s tenim Email)
  async createPublicAudit(url: string, email: string): Promise<AuditDTO> {
    const supabaseAdmin = createAdminClient();
    
    // Opcional: Buscar si ja existeix un usuari amb aquest email per lligar-ho?
    // Per ara, ho guardem sense user_id (o amb un user_id temporal si la taula ho requereix)
    // NOTA: Si la taula 'web_audits' tÃ© 'user_id' com NOT NULL, necessitem una estratÃ¨gia aquÃ­.
    // L'estratÃ¨gia habitual Ã©s crear un usuari "fantasma" o deixar el camp nullable.
    // Assumint que user_id pot ser null o gestionem el registre desprÃ©s.
    
    const { data, error } = await supabaseAdmin
      .from('web_audits')
      .insert({
        url,
        email: email,
        status: 'processing'
        // user_id: null (si la DB ho permet)
      })
      .select()
      .single();

    if (error) throw new Error(error.message);
    return this.mapToDTO(data);
  }
}

// =================== FILE: src/repositories/supabase/SupabasePostRepository.ts ===================

import { createClient } from '@/lib/supabase/client';
import { IPostRepository } from '@/repositories/interfaces/IPostRepository';
import { BlogPostDTO } from '@/types/models';
import { Database } from '@/types/database.types';

// Tipus directe de la fila SQL
type PostRow = Database['public']['Tables']['posts']['Row'];

export class SupabasePostRepository implements IPostRepository {

  // ğŸ”„ Mapper: La peÃ§a clau per traduir DB -> App
  private mapToDTO(row: PostRow): BlogPostDTO {
    return {
      id: row.id,
      slug: row.slug,
      title: row.title,
      date: row.published_at ?? row.created_at,
      description: row.description,
      content: row.content_mdx,
      tags: row.tags ? (row.tags as string[]) : [],
      coverImage: row.cover_image,
      published: row.published ?? false, // Assegurem boolean
    };
  }
  async getPostBySlug(slug: string): Promise<BlogPostDTO | null> {
    const supabase = createClient();

    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .eq('slug', slug)
      .eq('status', 'published')
      .eq('published', true) // ğŸ‘ˆ Seguretat extra: si endevinen l'URL d'un esborrany, no es veurÃ 
      .single();

    if (error || !data) return null;

    // Fem servir el mapper
    return this.mapToDTO(data);
  }

  async getAllPublishedPosts(): Promise<BlogPostDTO[]> {
    const supabase = createClient();
    const { data } = await supabase
      .from('posts')
      .select('*') // Seleccionem tot per simplificar el tipatge, o especifica columnes
      .eq('status', 'published')
      .eq('published', true) // ğŸ‘ˆ Seguretat extra: si endevinen l'URL d'un esborrany, no es veurÃ 
      .order('published_at', { ascending: false });

    if (!data) return [];

    // Mapegem cada fila
    return data.map(this.mapToDTO);
  }


  // MÃ¨todes existents (getPostBySlug, getAllPublishedPosts)...

  // ğŸ‘‡ IMPLEMENTACIÃ“ NOUS MÃˆTODES
  async getAllPosts(): Promise<BlogPostDTO[]> {
    // Usem createAdminClient per saltar-nos restriccions si cal, 
    // tot i que un admin loguejat ja hauria de poder veure-ho per RLS.
    // Per seguretat i simplicitat en admin panels, el client normal amb RLS d'admin Ã©s millor.
    const supabase = await createClient();

    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);
    return data.map(row => this.mapToDTO(row));
  }

  async updatePost(slug: string, data: Partial<BlogPostDTO>): Promise<void> {
    const supabase = await createClient();

    // Mapegem DTO -> DB Columns
    const updateData: Partial<PostRow> = {};
    if (data.title !== undefined) updateData.title = data.title;
    if (data.description !== undefined) updateData.description = data.description;
    if (data.content !== undefined) updateData.content_mdx = data.content;
    if (data.tags !== undefined) updateData.tags = data.tags;

    // Sincronitzem 'published' (bool) amb 'status' (enum)
    if (data.published !== undefined) {
      updateData.published = data.published;
      updateData.status = data.published ? 'published' : 'draft';
      // Si es publica ara i no tenia data, posem-la
      if (data.published) {
        updateData.published_at = new Date().toISOString();
      }
    }

    if (data.date !== undefined && data.date) {
      updateData.published_at = data.date; // Si l'admin canvia la data manualment
    }

    const { error } = await supabase
      .from('posts')
      .update(updateData)
      .eq('slug', slug);

    if (error) throw new Error(error.message);
  }

  async deletePost(slug: string): Promise<void> {
    const supabase = await createClient();
    const { error } = await supabase
      .from('posts')
      .delete()
      .eq('slug', slug);

    if (error) throw new Error(error.message);
  }
  // ğŸ‘‡ 1. MÃ¨tode per veure un post especÃ­fic (encara que sigui draft)
  async getAdminPostBySlug(slug: string): Promise<BlogPostDTO | null> {
    const supabase = createClient();
    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .eq('slug', slug)
      .single();

    if (error || !data) return null;
    return this.mapToDTO(data);
  }



}

// =================== FILE: src/repositories/supabase/SupabaseTestRepository.ts ===================

import { createClient } from '@/lib/supabase/server';
import { Database } from '@/types/database.types';
import { CampaignContext, TestCampaignDTO, TestTaskDTO, TestResultDTO, TesterProfile } from '@/types/models';
// Tipus base de les taules
type TestCampaignRow = Database['public']['Tables']['test_campaigns']['Row'];

// 1. Definim l'estructura EXACTA que retorna la query de Supabase
type CampaignQueryResponse = TestCampaignRow & {
  projects: { name: string; domain: string | null } | null;
  test_tasks: {
    id: string;
    test_results: { count: number }[];
  }[];
};
export class SupabaseTestRepository {

  async getCampaignWithContext(campaignId: string, userId: string): Promise<CampaignContext> {
    const supabase = await createClient();

    // 1. Campanya
    const { data: campaignData } = await supabase
      .from('test_campaigns')
      .select('*')
      .eq('id', campaignId)
      .single();

    if (!campaignData) return { campaign: null, tasks: [], results: [] };

    // 2. Tasques
    const { data: tasksData } = await supabase
      .from('test_tasks')
      .select('*')
      .eq('campaign_id', campaignId)
      .order('order_index', { ascending: true });

    // 3. Resultats
    const taskIds = tasksData?.map(t => t.id) || [];
    const { data: resultsData } = await supabase
      .from('test_results')
      .select('*')
      .in('task_id', taskIds)
      .eq('user_id', userId);

    // Mapeig manual per assegurar tipus (evitar errors de nulls)
    const campaign: TestCampaignDTO = {
      id: campaignData.id,
      projectId: campaignData.project_id,
      title: campaignData.title,
      description: campaignData.description,
      instructions: campaignData.instructions,
      status: campaignData.status || 'active',
      createdAt: new Date(campaignData.created_at || Date.now())
    };

    const tasks: TestTaskDTO[] = (tasksData || []).map(t => ({
      id: t.id,
      campaignId: t.campaign_id,
      title: t.title,
      description: t.description,
      orderIndex: t.order_index ?? 0
    }));

    const results: TestResultDTO[] = (resultsData || []).map(r => ({
      id: r.id,
      taskId: r.task_id,
      userId: r.user_id,
      status: (r.status as 'pass' | 'fail' | 'blocked') || 'blocked',
      comment: r.comment,
      updatedAt: new Date(r.updated_at || Date.now())
    }));

    return { campaign, tasks, results };
  }

  async saveResult(userId: string, taskId: string, status: string, comment: string) {
    const supabase = await createClient();
    return supabase.from('test_results').upsert({
      user_id: userId,
      task_id: taskId,
      status,
      comment,
      updated_at: new Date().toISOString()
    }, { onConflict: 'task_id, user_id' });
  }
  // A. Llistar tots els usuaris disponibles per ser testers (excepte admins)
  async getAvailableTesters(): Promise<TesterProfile[]> {
    const supabase = await createClient();
    // Filtrem per rol 'client' o 'staff', o tots els que no siguin admin pur
    const { data } = await supabase
      .from('profiles')
      .select('id, email, full_name, avatar_url')
      .neq('role', 'admin')
      .order('email');

    return data || [];
  }

  // B. Llistar testers ja assignats a una campanya
  async getAssignedTesters(campaignId: string): Promise<TesterProfile[]> {
    const supabase = await createClient();
    const { data } = await supabase
      .from('test_assignments')
      .select(`
        user_id,
        profiles:user_id (
          id, email, full_name, avatar_url
        )
      `)
      .eq('campaign_id', campaignId);

    // 1. Definim el que esperem rebre d'aquesta query especÃ­fica
    type AssignmentRow = {
      user_id: string;
      profiles: TesterProfile | null; // Pot ser null si la relaciÃ³ falla (encara que no hauria)
    };

    // 2. Fem el cast segur utilitzant 'unknown' primer per "netejar" el tipus inferit
    const rows = data as unknown as AssignmentRow[] | null;

    // 3. Mapegem i filtrem els nulls amb un "Type Predicate" (p is TesterProfile)
    return rows
      ?.map((item) => item.profiles)
      .filter((p): p is TesterProfile => p !== null) || [];
  }

  // C. Assignar Usuari
  async assignTester(campaignId: string, userId: string) {
    const supabase = await createClient();
    return supabase.from('test_assignments').insert({
      campaign_id: campaignId,
      user_id: userId
    });
  }

  // D. Eliminar Usuari
  async removeTester(campaignId: string, userId: string) {
    const supabase = await createClient();
    return supabase.from('test_assignments').delete()
      .eq('campaign_id', campaignId)
      .eq('user_id', userId);
  }

  // A. Obtenir totes les campanyes (amb estadÃ­stiques calculades)
  // A. Obtenir totes les campanyes (amb estadÃ­stiques calculades)
  async getAllCampaignsForAdmin() {
    const supabase = await createClient();

    const { data, error } = await supabase
      .from('test_campaigns')
      .select(`
        *,
        projects(name, domain),
        test_tasks (
          id,
          test_results (count)
        )
      `)
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);

    // 2. Fem el cast segur a la nostra interfÃ­cie
    // AixÃ² elimina la necessitat d'usar 'any' mÃ©s endavant
    const typedData = data as unknown as CampaignQueryResponse[];

    // 3. Processem les dades amb tipatge fort
    return typedData.map((camp) => {
      // Ara TypeScript sap que 'camp.test_tasks' existeix i Ã©s un array
      const totalResults = camp.test_tasks?.reduce((acc, task) => {
        // I sap que 'task.test_results' Ã©s un array d'objectes amb 'count'
        const count = task.test_results?.[0]?.count || 0;
        return acc + count;
      }, 0) || 0;

      return {
        ...camp,
        stats: {
          total_tasks: camp.test_tasks?.length || 0,
          total_results: totalResults
        }
      };
    });
  }

  // B. Crear nova campanya
  async createCampaign(data: { projectId: string; title: string; description: string; instructions: string }) {
    const supabase = await createClient();
    return supabase.from('test_campaigns').insert({
      project_id: data.projectId,
      title: data.title,
      description: data.description,
      instructions: data.instructions,
      status: 'active'
    }).select().single();
  }
}

// =================== FILE: src/routing.ts ===================

import { defineRouting } from 'next-intl/routing';
import { createNavigation } from 'next-intl/navigation';

export const routing = defineRouting({
  locales: ['ca', 'es', 'en'],
  defaultLocale: 'ca',
  localePrefix: 'as-needed' // Opcional: per si vols /ca o no
});

// Exportem tipus per a reutilitzar
export type Locale = (typeof routing.locales)[number];

export const { Link, redirect, usePathname, useRouter, getPathname } =
  createNavigation(routing);

// =================== FILE: src/services/AIService.ts ===================

import { GoogleGenerativeAI } from "@google/generative-ai";

export class AIService {
  private genAI: GoogleGenerativeAI;

  constructor() {
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) throw new Error("âŒ Manca GEMINI_API_KEY a .env.local");
    this.genAI = new GoogleGenerativeAI(apiKey);
  }

  async generateSiteContent(businessName: string, description: string, language: string = 'ca') {
    const model = this.genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

    const prompt = `
      Ets un expert en copywriting web. Genera contingut per a una Landing Page.
      Negoci: "${businessName}". DescripciÃ³: "${description}". Idioma: "${language}".

      Retorna EXCLUSIVAMENT un objecte JSON (sense markdown) amb aquesta estructura:
      {
        "hero": {
          "title": "TÃ­tol curt i impactant",
          "subtitle": "SubtÃ­tol persuasiu",
          "cta": "Text del botÃ³"
        },
        "about": {
          "title": "Sobre Nosaltres",
          "description": "DescripciÃ³ professional breu"
        },
        "services_intro": {
          "title": "Serveis",
          "subtitle": "Frase ganxo"
        }
      }
    `;

    try {
      const result = await model.generateContent(prompt);
      const text = result.response.text();
      // Neteja per si la IA torna markdown ```json ... ```
      const cleanJson = text.replace(/```json|```/g, '').trim();
      return JSON.parse(cleanJson);
    } catch (error) {
      console.error("AI Error:", error);
      // Fallback per si falla
      return {
        hero: { title: businessName, subtitle: description, cta: "Contactar" },
        about: { title: "Sobre Nosaltres", description: "" },
        services_intro: { title: "Serveis", subtitle: "" }
      };
    }
  }
}

// =================== FILE: src/services/AuditService.ts ===================

import { IAuditRepository } from '@/repositories/interfaces/IAuditRepository';
import { IWebScanner } from '@/adapters/IWebScanner';
import { ResendEmailService } from '@/services/email/ResendEmailService';

export class AuditService {
  constructor(
    private auditRepo: IAuditRepository,
    private scanner: IWebScanner,
    private emailService: ResendEmailService
  ) { }

  // 1. MÃ¨tode Landing (PÃºblic) - Afegim locale
  async performPublicAudit(url: string, email: string, locale: string) {
    return this.performFullAudit(url, { email }, locale);
  }

  // 2. MÃ¨tode Dashboard (Privat) - Afegim locale
  async performUserAudit(url: string, userId: string, userEmail: string, locale: string) {
    return this.performFullAudit(url, { userId, email: userEmail }, locale);
  }

  // LÃ²gica Central - Afegim locale
  private async performFullAudit(url: string, user: { userId?: string, email: string }, locale: string) {
    console.log(`ğŸš€ [AuditService] Iniciant auditoria per: ${url}`);

    let newAudit;
    if (user.userId) {
      newAudit = await this.auditRepo.createAuditForUser(url, user.userId, user.email);
    } else {
      newAudit = await this.auditRepo.createPublicAudit(url, user.email);
    }

    try {
      const scanResult = await this.scanner.scanUrl(url);

      await this.auditRepo.updateStatus(newAudit.id, 'completed', {
        seoScore: scanResult.seoScore,
        performanceScore: scanResult.performanceScore,
        reportData: {
          screenshot: scanResult.screenshot,
          issues: scanResult.issues,
          metrics: scanResult.metrics,
          raw: scanResult.reportData
        }
      });

      // ENVIAR EMAIL AMB LOCALE
      try {
        await this.emailService.sendAuditResult(user.email, {
          url: url,
          seo: scanResult.seoScore,
          perf: scanResult.performanceScore,
          id: newAudit.id
        }, locale); // ğŸ‘ˆ Passem l'idioma aquÃ­
      } catch (emailErr) {
        console.error("Error enviant email:", emailErr);
      }

      return newAudit.id;

    } catch (error) {
      console.error("Error audit service (LOG PRIVAT):", error);

      await this.auditRepo.updateStatus(newAudit.id, 'failed');

      // âš ï¸ MAI re-llencis l'error original al client si no estÃ s segur de quÃ¨ contÃ©.
      // LlanÃ§a un error genÃ¨ric.
      throw new Error("No s'ha pogut completar l'auditoria. Verifica la URL o prova mÃ©s tard.");
    }
  }
}

// =================== FILE: src/services/container.ts ===================

// 1. Importem les Classes (els plÃ nols)
import { SupabaseAuditRepository } from '@/repositories/supabase/SupabaseAuditRepository';
import { SupabasePostRepository } from '@/repositories/supabase/SupabasePostRepository';
import { SupabaseAnalyticsRepository } from '@/repositories/supabase/SupabaseAnalyticsRepository';

import { ResendEmailService } from '@/services/email/ResendEmailService';
import { AuditService } from '@/services/AuditService';
import { PostService } from '@/services/PostService';

import { GooglePageSpeedAdapter } from '@/adapters/GooglePageSpeedAdapter'; // ğŸ‘ˆ El nou adaptador
// ---------------------------------------------------------------------------
// 2. Instanciem els Repositoris (Capa de Dades)
// ---------------------------------------------------------------------------
export const auditRepository = new SupabaseAuditRepository();
export const postRepository = new SupabasePostRepository(); // ğŸ‘ˆ AquÃ­ neix la instÃ ncia
// ğŸ‘‡ Instanciem Analytics
export const analyticsRepository = new SupabaseAnalyticsRepository();
// ---------------------------------------------------------------------------
// 3. Instanciem els Adaptadors (Capa Externa)
// ---------------------------------------------------------------------------
const googleKey = process.env.GOOGLE_PAGESPEED_API_KEY || '';
const webScanner = new GooglePageSpeedAdapter(googleKey);

// ğŸ‘‡ 2. INSTANCIEM EL SERVEI D'EMAIL
export const emailService = new ResendEmailService();
// ---------------------------------------------------------------------------
// 4. Instanciem els Serveis (Capa de Negoci)
//    AquÃ­ fem la InjecciÃ³ de DependÃ¨ncies
// ---------------------------------------------------------------------------
// ğŸ‘‡ 3. ARA LI PASSEM ELS 3 ARGUMENTS QUE DEMANA
export const auditService = new AuditService(
  auditRepository,
  webScanner,
  emailService // <--- AQUEST ERA EL QUE FALTAVA
);
// El PostService necessita el postRepository per funcionar
export const postService = new PostService(postRepository);


// =================== FILE: src/services/email/ResendEmailService.ts ===================

import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export class ResendEmailService {
  // Afegim 'locale' als arguments
  async sendAuditResult(to: string, data: { url: string, seo: number, perf: number, id: string }, locale: string) {
    try {
      // Assegurem-nos que locale tÃ© valor (per defecte 'ca')
      const lang = locale || 'ca';
      
      await resend.emails.send({
        from: 'DigitAI Studios <info@digitaistudios.com>',
        to: [to],
        subject: `Resultats de l'Auditoria: ${data.url}`,
        html: `
          <div style="font-family: sans-serif; color: #333; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #6366f1;">L'informe de ${data.url} estÃ  llest</h1>
            <p>Hem analitzat la teva web i aquests sÃ³n els resultats preliminars:</p>
            <ul style="background: #f3f4f6; padding: 20px; border-radius: 10px;">
              <li style="margin-bottom: 10px;"><strong>SEO:</strong> ${data.seo}/100</li>
              <li><strong>Rendiment:</strong> ${data.perf}/100</li>
            </ul>
            <p style="margin-top: 30px;">
              <a href="https://digitaistudios.com/${lang}/dashboard/audits/${data.id}" style="background: #6366f1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block;">
                Veure Informe Complet
              </a>
            </p>
            <p style="font-size: 12px; color: #666; margin-top: 40px;">
              Â© DigitAI Studios. Si no has demanat aixÃ², ignora aquest correu.
            </p>
          </div>
        `
      });
    } catch (error) {
      console.error("Resend Error:", error);
    }
  }
}

// =================== FILE: src/services/FactoryService.ts ===================

import { Octokit } from 'octokit';
import { generateConfigFileContent } from '@/lib/factory/config-generator';
import { MasterConfig } from '@/types/config';

type OctokitError = {
  status: number;
  message: string;
  response?: { data: unknown };
};

export class FactoryService {
  private octokit: Octokit;
  private templateOwner: string;
  private templateRepo: string;
  private targetOrg: string;

  constructor() {
    const token = process.env.GITHUB_ACCESS_TOKEN;
    if (!token) throw new Error("âŒ Error CrÃ­tic: Manca GITHUB_ACCESS_TOKEN.");
    
    this.octokit = new Octokit({ auth: token });
    this.templateOwner = process.env.GITHUB_TEMPLATE_OWNER!;
    this.templateRepo = process.env.GITHUB_TEMPLATE_REPO!;
    this.targetOrg = process.env.GITHUB_TARGET_ORG || this.templateOwner;

    if (!this.templateOwner || !this.templateRepo) {
        throw new Error("âŒ Error CrÃ­tic: Falten les variables d'entorn del Template.");
    }
  }

  // 1. Crear Repositori
  async createRepository(repoName: string, description: string) {
    console.log(`ğŸ­ [Factory] Creant repo a ${this.targetOrg}/${repoName}...`);
    try {
      const { data } = await this.octokit.rest.repos.createUsingTemplate({
        template_owner: this.templateOwner,
        template_repo: this.templateRepo,
        name: repoName,
        description: description,
        owner: this.targetOrg,
        private: true,
        include_all_branches: false
      });
      console.log(`âœ… [Factory] Repo creat: ${data.html_url}`);
      return data;
    } catch (error: unknown) {
      const err = error as OctokitError;
      console.error("âŒ [Factory] Error creant repo:", err.response?.data || err.message);
      if (err.status === 422) throw new Error(`El repositori '${repoName}' ja existeix.`);
      throw new Error(`Error API GitHub: ${err.message}`);
    }
  }

  // 2. Helper per obtenir el SHA
  async getFileSha(repoName: string, path: string): Promise<string | undefined> {
    try {
        const { data } = await this.octokit.rest.repos.getContent({
            owner: this.targetOrg,
            repo: repoName,
            path: path,
        });
        
        if (!Array.isArray(data) && 'sha' in data) {
            return data.sha;
        }
    } catch (error: unknown) {
        const err = error as OctokitError;
        if (err.status !== 404) throw err;
    }
    return undefined;
  }

  // 3. Injectar ConfiguraciÃ³ (AMB RETRY ROBUST)
  async injectConfiguration(repoName: string, configData: MasterConfig) {
    console.log(`ğŸ’‰ [Factory] Injectant config a ${this.targetOrg}/${repoName}...`);

    const fileContent = generateConfigFileContent(configData);
    const contentEncoded = Buffer.from(fileContent).toString('base64');
    const path = 'src/config/digitai.config.ts';

    try {
      // ğŸ”„ LÃ’GICA DE REINTENT PER OBTENIR EL SHA
      // Sabem que el fitxer existeix (ve del template). Si l'API diu 404, Ã©s lag.
      // Insistim fins a 5 vegades (5 segons) per aconseguir el SHA.
      let sha: string | undefined;
      
      for (let i = 0; i < 5; i++) {
          sha = await this.getFileSha(repoName, path);
          
          if (sha) {
              console.log(`ğŸ”¹ SHA trobat a l'intent ${i + 1}: ${sha.substring(0, 7)}`);
              break; 
          }
          
          console.log(`â³ Esperant indexaciÃ³ de GitHub per al config... (${i + 1}/5)`);
          await new Promise(resolve => setTimeout(resolve, 1500)); // Esperem 1.5s
      }

      if (!sha) {
          throw new Error("Impossible obtenir el SHA del fitxer de configuraciÃ³ original. GitHub va massa lent.");
      }

      // Ara que tenim el SHA segur, fem l'update
      await this.octokit.rest.repos.createOrUpdateFileContents({
        owner: this.targetOrg,
        repo: repoName,
        path: path,
        message: 'chore(setup): inject client configuration',
        content: contentEncoded,
        sha: sha, // AQUI SEMPRE HI HAURÃ€ VALOR
        committer: { name: 'DigitAI Bot', email: 'bot@digitaistudios.com' }
      });

      console.log("âœ… [Factory] ConfiguraciÃ³ injectada.");
    } catch (error: unknown) {
        const err = error as Error;
        console.error("âŒ [Factory] Error injectant config:", err.message);
        throw new Error(`Error injectant config: ${err.message}`);
    }
  }

  // 4. Pujar Logo (TambÃ© podem aplicar un petit retry si calguÃ©s, perÃ² normalment falla menys)
  async uploadLogo(repoName: string, logoFile: File) {
    console.log(`ğŸ–¼ï¸ [Factory] Pujant logo a ${this.targetOrg}/${repoName}...`);
    try {
        const arrayBuffer = await logoFile.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);
        const contentEncoded = buffer.toString('base64');
        const path = 'public/branding/logo.png'; 

        const sha = await this.getFileSha(repoName, path);

        await this.octokit.rest.repos.createOrUpdateFileContents({
            owner: this.targetOrg,
            repo: repoName,
            path,
            message: 'chore(branding): upload brand logo',
            content: contentEncoded,
            sha,
            committer: { name: 'DigitAI Bot', email: 'bot@digitaistudios.com' }
        });
        
        console.log("âœ… [Factory] Logo pujat.");
        return "/branding/logo.png"; 
    } catch (error: unknown) {
        const err = error as Error;
        console.error("âŒ [Factory] Error pujant logo:", err.message);
        return "/logo.png"; 
    }
  }
}

// =================== FILE: src/services/PostService.ts ===================

import { IPostRepository } from '@/repositories/interfaces/IPostRepository';
import { BlogPostDTO } from '@/types/models';
import { cache } from 'react'; // ğŸ‘ˆ IMPORT IMPORTANT

export class PostService {
  constructor(private postRepo: IPostRepository) {
    // Envoltem el mÃ¨tode original amb la cache de React
    this.getPost = cache(this.getPost.bind(this)); 
  }

  async getPost(slug: string): Promise<BlogPostDTO | null> {
    return this.postRepo.getPostBySlug(slug);
  }

  async getLatestPosts(): Promise<BlogPostDTO[]> {
    return this.postRepo.getAllPublishedPosts();
  }

  // ğŸ‘‡ MÃ¨todes Admin
  async getAllPostsForAdmin(): Promise<BlogPostDTO[]> {
    return this.postRepo.getAllPosts();
  }

  async updatePost(slug: string, data: Partial<BlogPostDTO>): Promise<void> {
    return this.postRepo.updatePost(slug, data);
  }

  async deletePost(slug: string): Promise<void> {
    return this.postRepo.deletePost(slug);
  }

  async getAdminPost(slug: string): Promise<BlogPostDTO | null> {
    // Sense cache, volem dades fresques a l'admin
    return this.postRepo.getAdminPostBySlug(slug);
  }
}

// =================== FILE: src/types/actions.ts ===================

export type ActionResult = {
  success?: boolean;
  error?: string;
  repoUrl?: string;
  // ğŸ‘‡ Afegim aixÃ² per retornar les dades si falla
  fields?: {
    businessName?: string;
    slug?: string;
    description?: string;
    primaryColor?: string;
  };
};

// =================== FILE: src/types/config.ts ===================

// Tipus bÃ sics
export type ModuleStatus = boolean;

export interface SiteIdentity {
  name: string;
  description: string;
  logoUrl: string;
  faviconUrl: string;
  contactEmail: string;
}

export interface SiteBranding {
  colors: {
    primary: string;
    secondary: string;
    background: string;
    foreground: string;
  };
  radius: number;
}

export interface SiteModules {
  landing: {
    active: boolean;
    sections: ('hero' | 'features' | 'services' | 'contact' | 'testimonials')[];
  };
  auth: ModuleStatus;
  dashboard: ModuleStatus;
  booking: ModuleStatus;
  ecommerce: ModuleStatus;
  blog: ModuleStatus;
  inventory: ModuleStatus;
  accessControl: ModuleStatus;
}

export interface I18nConfig {
  locales: string[];
  defaultLocale: string;
}

// ğŸ§  CONFIGURACIÃ“ MESTRA
export interface MasterConfig {
  identity: SiteIdentity;
  branding: SiteBranding;
  modules: SiteModules;
  i18n: I18nConfig;
}

// =================== FILE: src/types/database.types.ts ===================

export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "13.0.5"
  }
  graphql_public: {
    Tables: {
      [_ in never]: never
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      graphql: {
        Args: {
          extensions?: Json
          operationName?: string
          query?: string
          variables?: Json
        }
        Returns: Json
      }
    }
    Enums: {
      [_ in never]: never
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
  public: {
    Tables: {
      analytics_events: {
        Row: {
          browser: string | null
          city: string | null
          country: string | null
          created_at: string | null
          device_type: string | null
          duration_seconds: number | null
          event_name: string
          id: number
          meta: Json | null
          os: string | null
          path: string | null
          referrer: string | null
          session_id: string
        }
        Insert: {
          browser?: string | null
          city?: string | null
          country?: string | null
          created_at?: string | null
          device_type?: string | null
          duration_seconds?: number | null
          event_name: string
          id?: never
          meta?: Json | null
          os?: string | null
          path?: string | null
          referrer?: string | null
          session_id: string
        }
        Update: {
          browser?: string | null
          city?: string | null
          country?: string | null
          created_at?: string | null
          device_type?: string | null
          duration_seconds?: number | null
          event_name?: string
          id?: never
          meta?: Json | null
          os?: string | null
          path?: string | null
          referrer?: string | null
          session_id?: string
        }
        Relationships: []
      }
      analytics_visitors: {
        Row: {
          country: string | null
          device_type: string | null
          first_seen_at: string | null
          last_seen_at: string | null
          referrer: string | null
          visitor_id: string
        }
        Insert: {
          country?: string | null
          device_type?: string | null
          first_seen_at?: string | null
          last_seen_at?: string | null
          referrer?: string | null
          visitor_id: string
        }
        Update: {
          country?: string | null
          device_type?: string | null
          first_seen_at?: string | null
          last_seen_at?: string | null
          referrer?: string | null
          visitor_id?: string
        }
        Relationships: []
      }
      blocked_dates: {
        Row: {
          created_at: string | null
          date: string
          id: string
          organization_id: string
          reason: string | null
        }
        Insert: {
          created_at?: string | null
          date: string
          id?: string
          organization_id: string
          reason?: string | null
        }
        Update: {
          created_at?: string | null
          date?: string
          id?: string
          organization_id?: string
          reason?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "blocked_dates_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      bookings: {
        Row: {
          created_at: string | null
          customer_email: string
          customer_name: string
          end_time: string
          form_data: Json | null
          id: string
          organization_id: string
          service_id: string
          start_time: string
          status: string | null
          user_id: string | null
        }
        Insert: {
          created_at?: string | null
          customer_email: string
          customer_name: string
          end_time: string
          form_data?: Json | null
          id?: string
          organization_id: string
          service_id: string
          start_time: string
          status?: string | null
          user_id?: string | null
        }
        Update: {
          created_at?: string | null
          customer_email?: string
          customer_name?: string
          end_time?: string
          form_data?: Json | null
          id?: string
          organization_id?: string
          service_id?: string
          start_time?: string
          status?: string | null
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "bookings_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "bookings_service_id_fkey"
            columns: ["service_id"]
            isOneToOne: false
            referencedRelation: "services"
            referencedColumns: ["id"]
          },
        ]
      }
      contact_leads: {
        Row: {
          created_at: string
          email: string
          full_name: string
          id: string
          message: string
          service: string
          source: string | null
        }
        Insert: {
          created_at?: string
          email: string
          full_name: string
          id?: string
          message: string
          service: string
          source?: string | null
        }
        Update: {
          created_at?: string
          email?: string
          full_name?: string
          id?: string
          message?: string
          service?: string
          source?: string | null
        }
        Relationships: []
      }
      content_queue: {
        Row: {
          created_at: string | null
          generated_mdx: string | null
          id: string
          image_prompt: string | null
          organization_id: string
          prompt_context: string | null
          status: Database["public"]["Enums"]["content_status"] | null
          target_keywords: string[] | null
          topic: string
        }
        Insert: {
          created_at?: string | null
          generated_mdx?: string | null
          id?: string
          image_prompt?: string | null
          organization_id: string
          prompt_context?: string | null
          status?: Database["public"]["Enums"]["content_status"] | null
          target_keywords?: string[] | null
          topic: string
        }
        Update: {
          created_at?: string | null
          generated_mdx?: string | null
          id?: string
          image_prompt?: string | null
          organization_id?: string
          prompt_context?: string | null
          status?: Database["public"]["Enums"]["content_status"] | null
          target_keywords?: string[] | null
          topic?: string
        }
        Relationships: [
          {
            foreignKeyName: "content_queue_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      order_items: {
        Row: {
          id: string
          order_id: string
          product_id: string | null
          product_name: string
          quantity: number
          unit_price: number
        }
        Insert: {
          id?: string
          order_id: string
          product_id?: string | null
          product_name: string
          quantity: number
          unit_price: number
        }
        Update: {
          id?: string
          order_id?: string
          product_id?: string | null
          product_name?: string
          quantity?: number
          unit_price?: number
        }
        Relationships: [
          {
            foreignKeyName: "order_items_order_id_fkey"
            columns: ["order_id"]
            isOneToOne: false
            referencedRelation: "orders"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "order_items_product_id_fkey"
            columns: ["product_id"]
            isOneToOne: false
            referencedRelation: "products"
            referencedColumns: ["id"]
          },
        ]
      }
      orders: {
        Row: {
          created_at: string | null
          customer_details: Json | null
          customer_email: string
          id: string
          organization_id: string
          payment_id: string | null
          payment_method: string | null
          status: string | null
          total_amount: number
          user_id: string | null
        }
        Insert: {
          created_at?: string | null
          customer_details?: Json | null
          customer_email: string
          id?: string
          organization_id: string
          payment_id?: string | null
          payment_method?: string | null
          status?: string | null
          total_amount: number
          user_id?: string | null
        }
        Update: {
          created_at?: string | null
          customer_details?: Json | null
          customer_email?: string
          id?: string
          organization_id?: string
          payment_id?: string | null
          payment_method?: string | null
          status?: string | null
          total_amount?: number
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "orders_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      organizations: {
        Row: {
          branding_config: Json | null
          created_at: string | null
          domain: string | null
          id: string
          name: string
          plan: string | null
          slug: string
        }
        Insert: {
          branding_config?: Json | null
          created_at?: string | null
          domain?: string | null
          id?: string
          name: string
          plan?: string | null
          slug: string
        }
        Update: {
          branding_config?: Json | null
          created_at?: string | null
          domain?: string | null
          id?: string
          name?: string
          plan?: string | null
          slug?: string
        }
        Relationships: []
      }
      posts: {
        Row: {
          content_mdx: string | null
          cover_image: string | null
          created_at: string | null
          description: string | null
          id: string
          organization_id: string
          published: boolean | null
          published_at: string | null
          slug: string
          status: Database["public"]["Enums"]["post_status"] | null
          tags: string[] | null
          title: string
          updated_at: string | null
        }
        Insert: {
          content_mdx?: string | null
          cover_image?: string | null
          created_at?: string | null
          description?: string | null
          id?: string
          organization_id: string
          published?: boolean | null
          published_at?: string | null
          slug: string
          status?: Database["public"]["Enums"]["post_status"] | null
          tags?: string[] | null
          title: string
          updated_at?: string | null
        }
        Update: {
          content_mdx?: string | null
          cover_image?: string | null
          created_at?: string | null
          description?: string | null
          id?: string
          organization_id?: string
          published?: boolean | null
          published_at?: string | null
          slug?: string
          status?: Database["public"]["Enums"]["post_status"] | null
          tags?: string[] | null
          title?: string
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "posts_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      products: {
        Row: {
          active: boolean | null
          created_at: string | null
          currency: string | null
          description: string | null
          id: string
          images: string[] | null
          metadata: Json | null
          name: string
          organization_id: string
          price: number
          slug: string
          stock: number | null
        }
        Insert: {
          active?: boolean | null
          created_at?: string | null
          currency?: string | null
          description?: string | null
          id?: string
          images?: string[] | null
          metadata?: Json | null
          name: string
          organization_id: string
          price?: number
          slug: string
          stock?: number | null
        }
        Update: {
          active?: boolean | null
          created_at?: string | null
          currency?: string | null
          description?: string | null
          id?: string
          images?: string[] | null
          metadata?: Json | null
          name?: string
          organization_id?: string
          price?: number
          slug?: string
          stock?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "products_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      profiles: {
        Row: {
          avatar_url: string | null
          created_at: string | null
          email: string
          full_name: string | null
          id: string
          organization_id: string
          role: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id: string | null
          updated_at: string | null
        }
        Insert: {
          avatar_url?: string | null
          created_at?: string | null
          email: string
          full_name?: string | null
          id: string
          organization_id: string
          role?: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id?: string | null
          updated_at?: string | null
        }
        Update: {
          avatar_url?: string | null
          created_at?: string | null
          email?: string
          full_name?: string | null
          id?: string
          organization_id?: string
          role?: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id?: string | null
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "profiles_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      projects: {
        Row: {
          branding_config: Json | null
          client_id: string
          created_at: string | null
          domain: string | null
          features_config: Json | null
          features_enabled: Json | null
          github_repo_url: string | null
          hosting_url: string | null
          id: string
          name: string
          organization_id: string | null
          repository_url: string | null
          status: Database["public"]["Enums"]["project_status"] | null
        }
        Insert: {
          branding_config?: Json | null
          client_id: string
          created_at?: string | null
          domain?: string | null
          features_config?: Json | null
          features_enabled?: Json | null
          github_repo_url?: string | null
          hosting_url?: string | null
          id?: string
          name: string
          organization_id?: string | null
          repository_url?: string | null
          status?: Database["public"]["Enums"]["project_status"] | null
        }
        Update: {
          branding_config?: Json | null
          client_id?: string
          created_at?: string | null
          domain?: string | null
          features_config?: Json | null
          features_enabled?: Json | null
          github_repo_url?: string | null
          hosting_url?: string | null
          id?: string
          name?: string
          organization_id?: string | null
          repository_url?: string | null
          status?: Database["public"]["Enums"]["project_status"] | null
        }
        Relationships: [
          {
            foreignKeyName: "projects_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      schedules: {
        Row: {
          created_at: string | null
          day_of_week: number
          end_time: string
          id: string
          is_active: boolean | null
          organization_id: string
          start_time: string
        }
        Insert: {
          created_at?: string | null
          day_of_week: number
          end_time: string
          id?: string
          is_active?: boolean | null
          organization_id: string
          start_time: string
        }
        Update: {
          created_at?: string | null
          day_of_week?: number
          end_time?: string
          id?: string
          is_active?: boolean | null
          organization_id?: string
          start_time?: string
        }
        Relationships: [
          {
            foreignKeyName: "schedules_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      services: {
        Row: {
          active: boolean | null
          created_at: string | null
          description: string | null
          duration_minutes: number | null
          form_schema: Json | null
          id: string
          organization_id: string
          price: number | null
          title: string
        }
        Insert: {
          active?: boolean | null
          created_at?: string | null
          description?: string | null
          duration_minutes?: number | null
          form_schema?: Json | null
          id?: string
          organization_id: string
          price?: number | null
          title: string
        }
        Update: {
          active?: boolean | null
          created_at?: string | null
          description?: string | null
          duration_minutes?: number | null
          form_schema?: Json | null
          id?: string
          organization_id?: string
          price?: number | null
          title?: string
        }
        Relationships: [
          {
            foreignKeyName: "services_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      test_assignments: {
        Row: {
          assigned_at: string | null
          campaign_id: string
          id: string
          user_id: string
        }
        Insert: {
          assigned_at?: string | null
          campaign_id: string
          id?: string
          user_id: string
        }
        Update: {
          assigned_at?: string | null
          campaign_id?: string
          id?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_assignments_campaign_id_fkey"
            columns: ["campaign_id"]
            isOneToOne: false
            referencedRelation: "test_campaigns"
            referencedColumns: ["id"]
          },
        ]
      }
      test_campaigns: {
        Row: {
          created_at: string | null
          description: string | null
          id: string
          instructions: string | null
          project_id: string
          status: string | null
          title: string
        }
        Insert: {
          created_at?: string | null
          description?: string | null
          id?: string
          instructions?: string | null
          project_id: string
          status?: string | null
          title: string
        }
        Update: {
          created_at?: string | null
          description?: string | null
          id?: string
          instructions?: string | null
          project_id?: string
          status?: string | null
          title?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_campaigns_project_id_fkey"
            columns: ["project_id"]
            isOneToOne: false
            referencedRelation: "projects"
            referencedColumns: ["id"]
          },
        ]
      }
      test_results: {
        Row: {
          comment: string | null
          created_at: string | null
          device_info: string | null
          id: string
          status: string
          task_id: string
          updated_at: string | null
          user_id: string
        }
        Insert: {
          comment?: string | null
          created_at?: string | null
          device_info?: string | null
          id?: string
          status: string
          task_id: string
          updated_at?: string | null
          user_id: string
        }
        Update: {
          comment?: string | null
          created_at?: string | null
          device_info?: string | null
          id?: string
          status?: string
          task_id?: string
          updated_at?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_results_task_id_fkey"
            columns: ["task_id"]
            isOneToOne: false
            referencedRelation: "test_tasks"
            referencedColumns: ["id"]
          },
        ]
      }
      test_tasks: {
        Row: {
          campaign_id: string
          description: string | null
          expected_result: string | null
          id: string
          order_index: number | null
          title: string
        }
        Insert: {
          campaign_id: string
          description?: string | null
          expected_result?: string | null
          id?: string
          order_index?: number | null
          title: string
        }
        Update: {
          campaign_id?: string
          description?: string | null
          expected_result?: string | null
          id?: string
          order_index?: number | null
          title?: string
        }
        Relationships: [
          {
            foreignKeyName: "test_tasks_campaign_id_fkey"
            columns: ["campaign_id"]
            isOneToOne: false
            referencedRelation: "test_campaigns"
            referencedColumns: ["id"]
          },
        ]
      }
      web_audits: {
        Row: {
          created_at: string | null
          email: string | null
          id: string
          organization_id: string | null
          performance_score: number | null
          report_data: Json | null
          seo_score: number | null
          status: Database["public"]["Enums"]["audit_status"] | null
          url: string
          user_id: string | null
          visitor_id: string | null
        }
        Insert: {
          created_at?: string | null
          email?: string | null
          id?: string
          organization_id?: string | null
          performance_score?: number | null
          report_data?: Json | null
          seo_score?: number | null
          status?: Database["public"]["Enums"]["audit_status"] | null
          url: string
          user_id?: string | null
          visitor_id?: string | null
        }
        Update: {
          created_at?: string | null
          email?: string | null
          id?: string
          organization_id?: string | null
          performance_score?: number | null
          report_data?: Json | null
          seo_score?: number | null
          status?: Database["public"]["Enums"]["audit_status"] | null
          url?: string
          user_id?: string | null
          visitor_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "web_audits_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      decrement_stock: {
        Args: { p_product_id: string; p_quantity: number }
        Returns: undefined
      }
      get_my_org_id: { Args: never; Returns: string }
      get_my_org_ids: { Args: never; Returns: string[] }
      is_admin: { Args: never; Returns: boolean }
    }
    Enums: {
      audit_status: "processing" | "completed" | "failed"
      content_status: "queued" | "generating" | "review" | "published"
      post_status: "draft" | "published" | "archived"
      project_status: "pending" | "active" | "maintenance" | "archived"
      user_role: "admin" | "client" | "lead" | "staff"
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  graphql_public: {
    Enums: {},
  },
  public: {
    Enums: {
      audit_status: ["processing", "completed", "failed"],
      content_status: ["queued", "generating", "review", "published"],
      post_status: ["draft", "published", "archived"],
      project_status: ["pending", "active", "maintenance", "archived"],
      user_role: ["admin", "client", "lead", "staff"],
    },
  },
} as const


// =================== FILE: src/types/index.ts ===================

import { Database } from './database.types';

// Exportem el tipus base per als clients de Supabase
export type { Database };

// Helpers per tenir tipus nets als components
// En lloc d'escriure la ruta llarga, farÃ s servir 'Audit' o 'Profile'
export type Audit = Database['public']['Tables']['web_audits']['Row'];
export type NewAudit = Database['public']['Tables']['web_audits']['Insert']; // Per formularis
export type Profile = Database['public']['Tables']['profiles']['Row'];
export type Project = Database['public']['Tables']['projects']['Row'];

// Tipus per als Enums (molt Ãºtil per dropdowns)
export type UserRole = Database['public']['Enums']['user_role'];
export type AuditStatus = Database['public']['Enums']['audit_status'];
export type ContactLead = Database['public']['Tables']['contact_leads']['Row'];
export type BlogPost = Database['public']['Tables']['posts']['Row'];

// =================== FILE: src/types/joins.ts ===================

// src/types/models.ts (AmpliaciÃ³)

import { Database } from './database.types';

// Tipus base de les taules
type TestCampaign = Database['public']['Tables']['test_campaigns']['Row'];
type TestTask = Database['public']['Tables']['test_tasks']['Row'];
type TestResult = Database['public']['Tables']['test_results']['Row'];

// 1. Tipus per a la Campanya amb les Tasques (Nested)
export type CampaignWithTasks = TestCampaign & {
  test_tasks: TestTask[]; // La relaciÃ³ es diu com la taula normalment
};

// 2. Tipus per al Repositori (Campaign + Context)
export type CampaignContext = {
  campaign: TestCampaign | null;
  tasks: TestTask[];
  results: TestResult[];
};

// =================== FILE: src/types/models.ts ===================

// 1. DTO - AixÃ­ Ã©s com la nostra UI vol veure una auditoria (Tipatge net)
export type AuditDTO = {
  id: string;
  url: string;
  status: 'processing' | 'completed' | 'failed';
  seoScore: number | null; // CamelCase per JS
  performanceScore: number | null;
  createdAt: Date; // Objecte Date real, no string
  reportData: Record<string, unknown> | null;
};


export interface IAuditRepository {
  getAuditsByUserEmail(email: string): Promise<AuditDTO[]>;
  getAuditById(id: string): Promise<AuditDTO | null>;
  createAudit(url: string, email: string): Promise<AuditDTO>;
  
  updateStatus(
    id: string, 
    status: AuditDTO['status'], 
    results?: { 
      seoScore?: number; 
      performanceScore?: number; 
      // âœ… CoherÃ¨ncia de tipus
      reportData?: Record<string, unknown> 
    }
  ): Promise<void>;
}


// 1. DTO (Data Transfer Object): Com la teva UI vol veure les dades (camelCase, net)
export type BlogPostDTO = {
  id: string; // ğŸ‘ˆ AFEGEIX AQUESTA LÃNIA
  slug: string;
  title: string;
  date: string | null;     // Mapejat des de published_at
  description: string | null;
  content: string | null;  // Mapejat des de content_mdx
  tags: string[];
  coverImage: string | null; // Mapejat des de cover_image
  published: boolean;
};

export type AnalyticsEventDTO = {
  event_name: string;
  path: string;
  session_id: string;
  // Dades que venen del client
  duration?: number; 
  referrer?: string;
  // Dades tÃ¨cniques (meta)
  meta?: Record<string, unknown>;
  // Dades que omplirem al servidor (Geo, Device)
  geo?: { country: string; city: string };
  device?: { type: string; browser: string; os: string };
};



// PROJECTE: digitAIStudios
// FITXER: src/types/config.ts

export type ModuleStatus = boolean;

export interface SiteIdentity {
  name: string;
  description: string;
  logoUrl: string;
  faviconUrl: string;
  contactEmail: string;
}

export interface SiteBranding {
  colors: {
    primary: string;
    secondary: string;
    background: string;
    foreground: string;
  };
  radius: number;
}

export interface SiteModules {
  landing: {
    active: boolean;
    sections: ('hero' | 'features' | 'services' | 'contact' | 'testimonials')[];
  };
  auth: ModuleStatus;
  dashboard: ModuleStatus;
  booking: ModuleStatus;
  ecommerce: ModuleStatus;
  blog: ModuleStatus;
  inventory: ModuleStatus;
  accessControl: ModuleStatus;
}

export interface I18nConfig {
  locales: string[];
  defaultLocale: string;
}

export interface MasterConfig {
  identity: SiteIdentity;
  branding: SiteBranding;
  modules: SiteModules;
  i18n: I18nConfig;
}

export type TestCampaignDTO = {
  id: string;
  projectId: string;
  title: string;
  description: string | null;
  instructions: string | null;
  status: string;
  createdAt: Date;
};

export type TestTaskDTO = {
  id: string;
  campaignId: string;
  title: string;
  description: string | null;
  orderIndex: number;
};

export type TestResultDTO = {
  id: string;
  taskId: string;
  userId: string;
  status: 'pass' | 'fail' | 'blocked';
  comment: string | null;
  updatedAt: Date;
};

// Tipus per al retorn combinat del repositori
export type CampaignContext = {
  campaign: TestCampaignDTO | null;
  tasks: TestTaskDTO[];
  results: TestResultDTO[];
};

export type TesterProfile = {
  id: string;
  email: string;
  full_name: string | null;
  avatar_url: string | null;
};
